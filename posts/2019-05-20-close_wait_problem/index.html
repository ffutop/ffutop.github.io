<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="ffutop"><meta property="og:url" content="https://www.ffutop.com/posts/2019-05-20-close_wait_problem/"><link rel=canonical href=https://www.ffutop.com/posts/2019-05-20-close_wait_problem/><link rel=apple-touch-icon href=favicon.ico><link rel=icon href=favicon.ico><link rel=shortcut href=favicon.ico><link rel=alternate type=application/atom+xml href=https://www.ffutop.com/index.xml title="Utop's Blog"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.ffutop.com\/"},"articleSection":"posts","name":"pipe 导致的 CLOSE_WAIT","headline":"pipe 导致的 CLOSE_WAIT","description":"历时一周总算把导致服务大量 CLOSE_WAIT 的原因给找到了。打印任务调用栈果然的必备手段啊！\n问题描述 Python 服务 A，用于接收心跳包确认其他服务是否存活。其他服务每 5 分钟向 A 发送一次心跳包；总计 \u0026lt; 100 个其他服务。\n05-11 19:30 ，首次出现 Python 服务大量 CLOSE_WAIT，至 13 日发现，总计 10k 左右 CLOSE_WAIT 的 TCP 连接。05-13 15:30 通过运维平台重新部署\u0026hellip; 05-14 16:30 ，再次出现。19:30 手动重启。 其间给 Python 服务 A 添加了打印调用栈的模块 pdbx，通过运维平台重新部署 05-17 19:00 ，再次出现。等待打印调用栈，不小心杀掉了服务\u0026hellip; 05-19 14:30 ，重现。 05-20 08:30 ，查找原因，解决问题。 由于不是本人负责的服务，于 16 日凭兴趣开始有限介入，协助排查。现将排查流程一一记述，给自己和大家未来排查问题提供一个借鉴。\n","inLanguage":"en-US","author":"ffutop","creator":"ffutop","publisher":"ffutop","accountablePerson":"ffutop","copyrightHolder":"ffutop","copyrightYear":"2019","datePublished":"2019-05-20 00:00:00 \u002b0000 UTC","dateModified":"2019-05-20 00:00:00 \u002b0000 UTC","url":"https:\/\/www.ffutop.com\/posts\/2019-05-20-close_wait_problem\/","keywords":["pipe","CLOSE_WAIT"]}</script><title>pipe 导致的 CLOSE_WAIT</title><meta property="og:title" content="pipe 导致的 CLOSE_WAIT"><meta property="og:type" content="article"><meta property="og:description" content="历时一周总算把导致服务大量 CLOSE_WAIT 的原因给找到了。打印任务调用栈果然的必备手段啊！
问题描述 Python 服务 A，用于接收心跳包确认其他服务是否存活。其他服务每 5 分钟向 A 发送一次心跳包；总计 &amp;lt; 100 个其他服务。
05-11 19:30 ，首次出现 Python 服务大量 CLOSE_WAIT，至 13 日发现，总计 10k 左右 CLOSE_WAIT 的 TCP 连接。05-13 15:30 通过运维平台重新部署&amp;hellip; 05-14 16:30 ，再次出现。19:30 手动重启。 其间给 Python 服务 A 添加了打印调用栈的模块 pdbx，通过运维平台重新部署 05-17 19:00 ，再次出现。等待打印调用栈，不小心杀掉了服务&amp;hellip; 05-19 14:30 ，重现。 05-20 08:30 ，查找原因，解决问题。 由于不是本人负责的服务，于 16 日凭兴趣开始有限介入，协助排查。现将排查流程一一记述，给自己和大家未来排查问题提供一个借鉴。
"><meta name=description content="历时一周总算把导致服务大量 CLOSE_WAIT 的原因给找到了。打印任务调用栈果然的必备手段啊！
问题描述 Python 服务 A，用于接收心跳包确认其他服务是否存活。其他服务每 5 分钟向 A 发送一次心跳包；总计 &amp;lt; 100 个其他服务。
05-11 19:30 ，首次出现 Python 服务大量 CLOSE_WAIT，至 13 日发现，总计 10k 左右 CLOSE_WAIT 的 TCP 连接。05-13 15:30 通过运维平台重新部署&amp;hellip; 05-14 16:30 ，再次出现。19:30 手动重启。 其间给 Python 服务 A 添加了打印调用栈的模块 pdbx，通过运维平台重新部署 05-17 19:00 ，再次出现。等待打印调用栈，不小心杀掉了服务&amp;hellip; 05-19 14:30 ，重现。 05-20 08:30 ，查找原因，解决问题。 由于不是本人负责的服务，于 16 日凭兴趣开始有限介入，协助排查。现将排查流程一一记述，给自己和大家未来排查问题提供一个借鉴。
"><meta property="og:locale" content="zh-cmn-Hans-CN"><meta property="og:image" content="favicon.ico"><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,noto sans,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji;font-weight:400;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#333;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{color-scheme:light;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;margin:0;color:#1f2328;background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,segoe ui,noto sans,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:' ';display:inline-block;background-color:currentColor;-webkit-mask-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");mask-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>")}.markdown-body details,.markdown-body figcaption,.markdown-body figure{display:block}.markdown-body summary{display:list-item}.markdown-body [hidden]{display:none!important}.markdown-body a{background-color:transparent;color:#0969da;text-decoration:none}.markdown-body abbr[title]{border-bottom:none;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}.markdown-body b,.markdown-body strong{font-weight:600}.markdown-body dfn{font-style:italic}.markdown-body h1{margin:.67em 0;font-weight:600;padding-bottom:.3em;font-size:2em;border-bottom:1px solid #d1d9e0b3}.markdown-body mark{background-color:#fff8c5;color:#1f2328}.markdown-body small{font-size:90%}.markdown-body sub,.markdown-body sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}.markdown-body sub{bottom:-.25em}.markdown-body sup{top:-.5em}.markdown-body img{border-style:none;max-width:100%;box-sizing:content-box}.markdown-body code,.markdown-body kbd,.markdown-body pre,.markdown-body samp{font-family:monospace;font-size:1em}.markdown-body figure{margin:1em 2.5rem}.markdown-body hr{box-sizing:content-box;overflow:hidden;background:0 0;border-bottom:1px solid #d1d9e0b3;height:.25em;padding:0;margin:1.5rem 0;background-color:#d1d9e0;border:0}.markdown-body input{font:inherit;margin:0;overflow:visible;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=button],.markdown-body [type=reset],.markdown-body [type=submit]{-webkit-appearance:button;appearance:button}.markdown-body [type=checkbox],.markdown-body [type=radio]{box-sizing:border-box;padding:0}.markdown-body [type=number]::-webkit-inner-spin-button,.markdown-body [type=number]::-webkit-outer-spin-button{height:auto}.markdown-body [type=search]::-webkit-search-cancel-button,.markdown-body [type=search]::-webkit-search-decoration{-webkit-appearance:none;appearance:none}.markdown-body ::-webkit-input-placeholder{color:inherit;opacity:.54}.markdown-body ::-webkit-file-upload-button{-webkit-appearance:button;appearance:button;font:inherit}.markdown-body a:hover{text-decoration:underline}.markdown-body ::placeholder{color:#59636e;opacity:1}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body table{border-spacing:0;border-collapse:collapse;display:block;width:max-content;max-width:100%;overflow:auto;font-variant:tabular-nums}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body a:focus,.markdown-body [role=button]:focus,.markdown-body input[type=radio]:focus,.markdown-body input[type=checkbox]:focus{outline:2px solid #0969da;outline-offset:-2px;box-shadow:none}.markdown-body a:focus:not(:focus-visible),.markdown-body [role=button]:focus:not(:focus-visible),.markdown-body input[type=radio]:focus:not(:focus-visible),.markdown-body input[type=checkbox]:focus:not(:focus-visible){outline:solid 1px transparent}.markdown-body a:focus-visible,.markdown-body [role=button]:focus-visible,.markdown-body input[type=radio]:focus-visible,.markdown-body input[type=checkbox]:focus-visible{outline:2px solid #0969da;outline-offset:-2px;box-shadow:none}.markdown-body a:not([class]):focus,.markdown-body a:not([class]):focus-visible,.markdown-body input[type=radio]:focus,.markdown-body input[type=radio]:focus-visible,.markdown-body input[type=checkbox]:focus,.markdown-body input[type=checkbox]:focus-visible{outline-offset:0}.markdown-body kbd{display:inline-block;padding:.25rem;font:11px ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;line-height:10px;color:#1f2328;vertical-align:middle;background-color:#f6f8fa;border:solid 1px #d1d9e0b3;border-bottom-color:#d1d9e0b3;border-radius:6px;box-shadow:inset 0 -1px #d1d9e0b3}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:1.5rem;margin-bottom:1rem;font-weight:600;line-height:1.25}.markdown-body h2{font-weight:600;padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #d1d9e0b3}.markdown-body h3{font-weight:600;font-size:1.25em}.markdown-body h4{font-weight:600;font-size:1em}.markdown-body h5{font-weight:600;font-size:.875em}.markdown-body h6{font-weight:600;font-size:.85em;color:#59636e}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0;padding:0 1em;color:#59636e;border-left:.25em solid #d1d9e0}.markdown-body ul,.markdown-body ol{margin-top:0;margin-bottom:0;padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ul ul ol,.markdown-body ul ol ol,.markdown-body ol ul ol,.markdown-body ol ol ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body tt,.markdown-body code,.markdown-body samp{font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0;font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:12px;word-wrap:normal}.markdown-body .octicon{display:inline-block;overflow:visible!important;vertical-align:text-bottom;fill:currentColor}.markdown-body input::-webkit-outer-spin-button,.markdown-body input::-webkit-inner-spin-button{margin:0;appearance:none}.markdown-body .mr-2{margin-right:.5rem!important}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>*:first-child{margin-top:0!important}.markdown-body>*:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#d1242f}.markdown-body .anchor{float:left;padding-right:.25rem;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body p,.markdown-body blockquote,.markdown-body ul,.markdown-body ol,.markdown-body dl,.markdown-body table,.markdown-body pre,.markdown-body details{margin-top:0;margin-bottom:1rem}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1f2328;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 tt,.markdown-body h1 code,.markdown-body h2 tt,.markdown-body h2 code,.markdown-body h3 tt,.markdown-body h3 code,.markdown-body h4 tt,.markdown-body h4 code,.markdown-body h5 tt,.markdown-body h5 code,.markdown-body h6 tt,.markdown-body h6 code{padding:0 .2em;font-size:inherit}.markdown-body summary h1,.markdown-body summary h2,.markdown-body summary h3,.markdown-body summary h4,.markdown-body summary h5,.markdown-body summary h6{display:inline-block}.markdown-body summary h1 .anchor,.markdown-body summary h2 .anchor,.markdown-body summary h3 .anchor,.markdown-body summary h4 .anchor,.markdown-body summary h5 .anchor,.markdown-body summary h6 .anchor{margin-left:-40px}.markdown-body summary h1,.markdown-body summary h2{padding-bottom:0;border-bottom:0}.markdown-body ul.no-list,.markdown-body ol.no-list{padding:0;list-style-type:none}.markdown-body ol[type="a s"]{list-style-type:lower-alpha}.markdown-body ol[type="A s"]{list-style-type:upper-alpha}.markdown-body ol[type="i s"]{list-style-type:lower-roman}.markdown-body ol[type="I s"]{list-style-type:upper-roman}.markdown-body ol[type="1"]{list-style-type:decimal}.markdown-body div>ol:not([type]){list-style-type:decimal}.markdown-body ul ul,.markdown-body ul ol,.markdown-body ol ol,.markdown-body ol ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:1rem}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:1rem;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 1rem;margin-bottom:1rem}.markdown-body table th{font-weight:600}.markdown-body table th,.markdown-body table td{padding:6px 13px;border:1px solid #d1d9e0}.markdown-body table td>:last-child{margin-bottom:0}.markdown-body table tr{background-color:#fff;border-top:1px solid #d1d9e0b3}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body table img{background-color:transparent}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #d1d9e0}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#1f2328}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:.2em .4em;margin:0;font-size:85%;white-space:break-spaces;background-color:#818b981f;border-radius:6px}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body samp{font-size:85%}.markdown-body pre code{font-size:100%}.markdown-body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:1rem}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:1rem;overflow:auto;font-size:85%;line-height:1.45;color:#1f2328;background-color:#f6f8fa;border-radius:6px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-num{padding:10px .5rem 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:600;background:#f6f8fa;border-top:0}.markdown-body [data-footnote-ref]::before{content:"["}.markdown-body [data-footnote-ref]::after{content:"]"}.markdown-body .footnotes{font-size:12px;color:#59636e;border-top:1px solid #d1d9e0}.markdown-body .footnotes ol{padding-left:1rem}.markdown-body .footnotes ol ul{display:inline-block;padding-left:1rem;margin-top:1rem}.markdown-body .footnotes li{position:relative}.markdown-body .footnotes li:target::before{position:absolute;top:calc(.5rem*-1);right:calc(.5rem*-1);bottom:calc(.5rem*-1);left:calc(1.5rem*-1);pointer-events:none;content:"";border:2px solid #0969da;border-radius:6px}.markdown-body .footnotes li:target{color:#1f2328}.markdown-body .footnotes .data-footnote-backref g-emoji{font-family:monospace}.markdown-body body:has(:modal){padding-right:var(--dialog-scrollgutter)!important}.markdown-body .pl-c{color:#59636e}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#0550ae}.markdown-body .pl-e,.markdown-body .pl-en{color:#6639ba}.markdown-body .pl-smi,.markdown-body .pl-s .pl-s1{color:#1f2328}.markdown-body .pl-ent{color:#0550ae}.markdown-body .pl-k{color:#cf222e}.markdown-body .pl-s,.markdown-body .pl-pds,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sre,.markdown-body .pl-sr .pl-sra{color:#0a3069}.markdown-body .pl-v,.markdown-body .pl-smw{color:#953800}.markdown-body .pl-bu{color:#82071e}.markdown-body .pl-ii{color:#f6f8fa;background-color:#82071e}.markdown-body .pl-c2{color:#f6f8fa;background-color:#cf222e}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#116329}.markdown-body .pl-ml{color:#3b2300}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#0550ae}.markdown-body .pl-mi{font-style:italic;color:#1f2328}.markdown-body .pl-mb{font-weight:700;color:#1f2328}.markdown-body .pl-md{color:#82071e;background-color:#ffebe9}.markdown-body .pl-mi1{color:#116329;background-color:#dafbe1}.markdown-body .pl-mc{color:#953800;background-color:#ffd8b5}.markdown-body .pl-mi2{color:#d1d9e0;background-color:#0550ae}.markdown-body .pl-mdr{font-weight:700;color:#8250df}.markdown-body .pl-ba{color:#59636e}.markdown-body .pl-sg{color:#818b98}.markdown-body .pl-corl{text-decoration:underline;color:#0a3069}.markdown-body [role=button]:focus:not(:focus-visible),.markdown-body [role=tabpanel][tabindex="0"]:focus:not(:focus-visible),.markdown-body button:focus:not(:focus-visible),.markdown-body summary:focus:not(:focus-visible),.markdown-body a:focus:not(:focus-visible){outline:none;box-shadow:none}.markdown-body [tabindex="0"]:focus:not(:focus-visible),.markdown-body details-dialog:focus:not(:focus-visible){outline:none}.markdown-body g-emoji{display:inline-block;min-width:1ch;font-family:apple color emoji,segoe ui emoji,segoe ui symbol;font-size:1em;font-style:normal!important;font-weight:400;line-height:1;vertical-align:-.075em}.markdown-body g-emoji img{width:1em;height:1em}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item label{font-weight:400}.markdown-body .task-list-item.enabled label{cursor:pointer}.markdown-body .task-list-item+.task-list-item{margin-top:.25rem}.markdown-body .task-list-item .handle{display:none}.markdown-body .task-list-item-checkbox{margin:0 .2em .25em -1.4em;vertical-align:middle}.markdown-body ul:dir(rtl) .task-list-item-checkbox{margin:0 -1.6em .25em .2em}.markdown-body ol:dir(rtl) .task-list-item-checkbox{margin:0 -1.6em .25em .2em}.markdown-body .contains-task-list:hover .task-list-item-convert-container,.markdown-body .contains-task-list:focus-within .task-list-item-convert-container{display:block;width:auto;height:24px;overflow:visible;clip:auto}.markdown-body ::-webkit-calendar-picker-indicator{filter:invert(50%)}.markdown-body .markdown-alert{padding:.5rem 1rem;margin-bottom:1rem;color:inherit;border-left:.25em solid #d1d9e0}.markdown-body .markdown-alert>:first-child{margin-top:0}.markdown-body .markdown-alert>:last-child{margin-bottom:0}.markdown-body .markdown-alert .markdown-alert-title{display:flex;font-weight:500;align-items:center;line-height:1}.markdown-body .markdown-alert.markdown-alert-note{border-left-color:#0969da}.markdown-body .markdown-alert.markdown-alert-note .markdown-alert-title{color:#0969da}.markdown-body .markdown-alert.markdown-alert-important{border-left-color:#8250df}.markdown-body .markdown-alert.markdown-alert-important .markdown-alert-title{color:#8250df}.markdown-body .markdown-alert.markdown-alert-warning{border-left-color:#9a6700}.markdown-body .markdown-alert.markdown-alert-warning .markdown-alert-title{color:#9a6700}.markdown-body .markdown-alert.markdown-alert-tip{border-left-color:#1a7f37}.markdown-body .markdown-alert.markdown-alert-tip .markdown-alert-title{color:#1a7f37}.markdown-body .markdown-alert.markdown-alert-caution{border-left-color:#cf222e}.markdown-body .markdown-alert.markdown-alert-caution .markdown-alert-title{color:#d1242f}.markdown-body>*:first-child>.heading-element:first-child{margin-top:0!important}.markdown-body .highlight pre:has(+.zeroclipboard-container){min-height:52px}.Chinese .markdown-body{line-height:150%}.site-date-catalog{font-size:1.8rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1rem;margin:8px 0;font-weight:500}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600;margin-bottom:.5em}.post-tags{display:inline;font-weight:400;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:400;font-style:italic}.post-author{float:right;font-weight:400}.page-content{min-height:60%}.post-content{margin-bottom:50px;margin-left:auto;margin-right:auto;padding-left:15px;padding-right:15px}.post-content p{hyphens:auto;font-size:1rem;line-height:1.7;margin-top:0;margin-bottom:1.2em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.post-content h1{font-size:1.8rem;font-weight:600;margin-top:1.5em;margin-bottom:.8em;line-height:1.3;padding-bottom:.3em;border-bottom:1px solid #eaecef}.post-content h2{font-size:1.5rem;font-weight:600;margin-top:1.8em;margin-bottom:.8em;line-height:1.3;padding-bottom:.3em;border-bottom:1px solid #eaecef}.post-content h3{font-size:1.25rem;font-weight:600;margin-top:1.6em;margin-bottom:.6em;line-height:1.4}.post-content h4{font-size:1.1rem;font-weight:500;margin-top:1.4em;margin-bottom:.5em;line-height:1.4}.post-content table{width:100%;border-collapse:collapse;margin:1.5em 0;font-size:.95em;box-shadow:0 1px 3px rgba(0,0,0,.1)}.post-content th,.post-content td{border:1px solid #ddd;padding:10px 12px;text-align:left}.post-content th{background-color:#f2f2f2;font-weight:700}.post-content tr:nth-child(even){background-color:#f9f9f9}.post-content tr:hover{background-color:#f1f1f1}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{}.posts-line{font-size:16px}.markdown-body{font-size:.95rem;line-height:1.65}.post-title{font-size:1.7rem}.post-content p{letter-spacing:normal;line-height:1.65}.post-content .post-gallery img{width:100%}.post-content h1{font-size:1.7rem}.post-content h2{font-size:1.4rem}.post-content h3{font-size:1.2rem}.post-content h4{font-size:1.05rem}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=/index.xml rel=alternate type=application/rss+xml title="Utop's Blog"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500;600;700&family=Source+Code+Pro:wght@600&display=swap" rel=stylesheet><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-3RHY4L44ZL"></script> <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3RHY4L44ZL")</script></head><body><article class="post Chinese" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>FFUTOP</a></div><div class=header-subtitle></div></header><div class="row end-md header-items"><div class=header-item><a href=/posts/ target=_blank>Posts</a></div><div class=header-item><a href=/index.xml target=_blank>RSS</a></div><div class=header-item><a href=https://github.com/ffutop target=_blank>Github</a></div><div class=header-item><a href=https://ffkit.ffutop.com/author target=_blank>About</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>pipe 导致的 CLOSE_WAIT</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2019-05-20 00:00:00 UTC">20 May 2019</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://www.ffutop.com/>@ffutop</a></div></div></div></header><div class="post-content markdown-body"><p>历时一周总算把导致服务大量 <code>CLOSE_WAIT</code> 的原因给找到了。打印任务调用栈果然的必备手段啊！</p><h2 id=问题描述>问题描述</h2><p>Python 服务 A，用于接收心跳包确认其他服务是否存活。其他服务每 5 分钟向 A 发送一次心跳包；总计 &lt; 100 个其他服务。</p><ul><li>05-11 19:30 ，首次出现 Python 服务大量 <code>CLOSE_WAIT</code>，至 13 日发现，总计 10k 左右 <code>CLOSE_WAIT</code> 的 TCP 连接。05-13 15:30 通过运维平台重新部署&mldr;</li><li>05-14 16:30 ，再次出现。19:30 手动重启。</li><li>其间给 Python 服务 A 添加了打印调用栈的模块 <a href=https://pypi.org/project/pdbx/>pdbx</a>，通过运维平台重新部署</li><li>05-17 19:00 ，再次出现。等待打印调用栈，不小心杀掉了服务&mldr;</li><li>05-19 14:30 ，重现。</li><li>05-20 08:30 ，查找原因，解决问题。</li></ul><p>由于不是本人负责的服务，于 16 日凭兴趣开始有限介入，协助排查。现将排查流程一一记述，给自己和大家未来排查问题提供一个借鉴。</p><h2 id=问题探究>问题探究</h2><h3 id=close_wait-现象梳理>CLOSE_WAIT 现象梳理</h3><p>16 日拿到的信息只有前两次问题记录。</p><p><img src=https://img.ffutop.com/82B074FB-68FF-4A21-B664-A557FECBB2DF.png alt></p><p>大量 <code>CLOSE_WAIT</code> 状态的 TCP 连接，<code>Recv-Q</code> 数据大小平均在 300 Bytes 左右。对比实际的 HTTP 包大小，恰好是一次 HTTP Request 请求大小。同时参考 Nginx 打印的日志，确定是一次 HTTP 请求的数据包大小，同时都以 Timeout 为结束。</p><p>OK，简单地建立起了第一个印象，TCP 断开连接的 FIN 包由 Nginx 请求超时后发起(<code>proxy_read_timeout 300s</code>) 。A 服务所在的 Linux 机器接收到 FIN 包，并由内核线程直接将套接字状态置位为 <code>CLOSE_WAIT</code> 。</p><p>A 服务没意识到 FIN 包？当然，接收了 FIN 包之后，再回应 ACK 包，这“四次挥手”的第二个数据包并不会被 A 服务所认知，而是由内核的 <code>[ksoftirqd]</code> 内核线程直接处理。看下内核处理 FIN 包的代码 (from <code>net/ipv4/tcp_input.c</code>)。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic> * 处理 FIN 包
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic> *
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic> * 如果当前套接字是 ESTABLISHED 状态，则接收 FIN 包，进入 CLOSE-WAIT
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic> * 状态 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic> * ...
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#902000>void</span> <span style=color:#06287e>tcp_fin</span>(<span style=color:#007020;font-weight:700>struct</span> sock <span style=color:#666>*</span>sk)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>struct</span> tcp_sock <span style=color:#666>*</span>tp <span style=color:#666>=</span> <span style=color:#06287e>tcp_sk</span>(sk);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#06287e>inet_csk_schedule_ack</span>(sk);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	sk<span style=color:#666>-&gt;</span>sk_shutdown <span style=color:#666>|=</span> RCV_SHUTDOWN;
</span></span><span style=display:flex><span>	<span style=color:#06287e>sock_set_flag</span>(sk, SOCK_DONE);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>switch</span> (sk<span style=color:#666>-&gt;</span>sk_state) {
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>TCP_SYN_RECV</span>:
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>TCP_ESTABLISHED</span>:
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>/* 当前为 ESTABLISHED 状态，进入 CLOSE_WAIT */</span>
</span></span><span style=display:flex><span>		<span style=color:#06287e>tcp_set_state</span>(sk, TCP_CLOSE_WAIT);
</span></span><span style=display:flex><span>		<span style=color:#06287e>inet_csk</span>(sk)<span style=color:#666>-&gt;</span>icsk_ack.pingpong <span style=color:#666>=</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// ... more omitted 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// ... more omitted 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>}
</span></span></code></pre></div><p>更多关于网络相关的内核实现请参考 <a href=https://www.ffutop.com/2019-01-15-understand-Kernel-8/>理解 Linux Kernel (8) - 网络</a></p><p>再结合 <code>Recv-Q</code> 恰好等于一次完整 HTTP 请求的条件，可以认识到 Python 线程根本没有 <code>recv</code> 请求数据。更别提意识到远端发出来 FIN 包。</p><p>到此为止，由前两次的问题得到的线索，只能认为 Python 服务 A 的所有工作线程都在哪段代码阻塞了。而我所能认知的唯一条件就是事务死锁（当然，我犯了比较大的错误）。事实上看代码根本就没有任何死锁代码。暂时无果。</p><h3 id=打印线程调用栈-一次失败的尝试>打印线程调用栈 (一次失败的尝试)</h3><p>集成了调用栈打印工具 <code>pdbx</code> （强烈安利，我们老大写的，很好用的工具）之后，按理说 18 日解决问题是非常容易的。</p><p>结果按照文档的描述，使用 <code>kill -30 &lt;PID></code> ，Python 服务进程莫名挂掉。功亏一篑啊。后来查看源码发现 <code>pdbx</code> 重定义了 <code>USR1</code> 信号的处理函数。T_T Linux x86 平台下，对应的信号值为 10.</p><hr><p>额外地穿插一点信号相关的内容。<code>signal</code> 是一种异步处理机制，一般由执行流在退出内核态回到用户态之前 Check 当前任务的信号队列（为什么会主动 check 呢？当然是内核代码提前写好的流程），并主动针对获得的信号调用对应的信号处理函数。</p><p>可怕的是，之前竟然一直没有意识到信号值在不同的 CPU 架构下是不同的。USR1 在 x86 平台下是 10，在 平台下是 30 。而 BSD 又与 Linux 的编号方案不同。</p><p>Linux supports the standard signals listed below. Several signal numbers are architecture-dependent, as indicated in the &ldquo;Value&rdquo; column. (Where three values are given, the first one is usually valid for alpha and sparc, the middle one for x86, arm, and most other architectures, and the last one for mips. (Values for parisc are not shown; see the Linux kernel source for signal numbering on that architecture.) A dash (-) denotes that a signal is absent on the corresponding architecture.</p><p>Linux 支持的标准信号如下。一些信号值是平台相关的（Value 列，第一个值用于 alpha 和 sparc 平台，中间的值用于 x86、arm 和大量其他架构，最后一个值用于 mips 平台）</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Signal     Value     Action   Comment
</span></span><span style=display:flex><span>----------------------------------------------------------------------
</span></span><span style=display:flex><span>SIGHUP        <span style=color:#40a070>1</span>       Term    Hangup detected on controlling terminal or death of controlling process
</span></span><span style=display:flex><span>SIGINT        <span style=color:#40a070>2</span>       Term    Interrupt from keyboard
</span></span><span style=display:flex><span>SIGQUIT       <span style=color:#40a070>3</span>       Core    Quit from keyboard
</span></span><span style=display:flex><span>SIGKILL       <span style=color:#40a070>9</span>       Term    Kill signal
</span></span><span style=display:flex><span>SIGUSR1   30,10,16    Term    User-defined signal <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>SIGUSR2   31,12,17    Term    User-defined signal <span style=color:#40a070>2</span>
</span></span></code></pre></div><p>总结下，最靠谱的写法就是直接用信号的字符描述啦。<code>kill -s USR1 &lt;PID></code></p><hr><h3 id=打印线程调用栈>打印线程调用栈</h3><p>19 日下午再次重现，等到 20 日周一上班，总是成功地拿到了线程的调用栈。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#4070a0>&#34;CP Server Thread-10&#34;</span> <span style=color:#bb60d5>tid</span><span style=color:#666>=</span><span style=color:#40a070>139694658537216</span>
</span></span><span style=display:flex><span>    at self.__bootstrap_inner<span style=color:#666>()(</span>threading.py:785<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.run<span style=color:#666>()(</span>threading.py:812<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at conn.communicate<span style=color:#666>()(</span>wsgiserver2.py:1532<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    ... more omitted
</span></span><span style=display:flex><span>    at <span style=color:#bb60d5>instances</span> <span style=color:#666>=</span> list<span style=color:#666>(</span>db.select<span style=color:#666>(</span><span style=color:#4070a0>&#39;instance&#39;</span>, vars, <span style=color:#bb60d5>where</span><span style=color:#666>=</span><span style=color:#4070a0>&#39;app_name=$app_name and host=$host and port=$port&#39;</span><span style=color:#666>))(</span>xxx.py:233<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>return</span> self.query<span style=color:#666>(</span>qout, <span style=color:#bb60d5>processed</span><span style=color:#666>=</span>True<span style=color:#666>)(</span>db.py:720<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self._db_execute<span style=color:#666>(</span>db_cursor, sql_query<span style=color:#666>)(</span>db.py:680<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at print<span style=color:#666>(</span><span style=color:#4070a0>&#39;%s (%s): %s&#39;</span> % <span style=color:#666>(</span>round<span style=color:#666>(</span>b-a, 2<span style=color:#666>)</span>, self.ctx.dbq_count, str<span style=color:#666>(</span>sql_query<span style=color:#666>))</span>, <span style=color:#bb60d5>file</span><span style=color:#666>=</span>debug<span style=color:#666>)(</span>db.py:623<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at out.write<span style=color:#666>(</span>x<span style=color:#666>)(</span>webapi.py:512<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#4070a0>&#34;CP Server Thread-9&#34;</span> <span style=color:#bb60d5>tid</span><span style=color:#666>=</span><span style=color:#40a070>139694666929920</span>
</span></span><span style=display:flex><span>    at self.__bootstrap_inner<span style=color:#666>()(</span>threading.py:785<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.run<span style=color:#666>()(</span>threading.py:812<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at conn.communicate<span style=color:#666>()(</span>wsgiserver2.py:1532<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    ... more omitted 
</span></span><span style=display:flex><span>    at <span style=color:#bb60d5>apps</span> <span style=color:#666>=</span> list<span style=color:#666>(</span>db.select<span style=color:#666>(</span><span style=color:#4070a0>&#39;application&#39;</span>, vars, <span style=color:#bb60d5>where</span><span style=color:#666>=</span><span style=color:#4070a0>&#39;name=$name&#39;</span><span style=color:#666>))(</span>xxx.py:149<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>return</span> self.query<span style=color:#666>(</span>qout, <span style=color:#bb60d5>processed</span><span style=color:#666>=</span>True<span style=color:#666>)(</span>db.py:720<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self._db_execute<span style=color:#666>(</span>db_cursor, sql_query<span style=color:#666>)(</span>db.py:680<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at print<span style=color:#666>(</span><span style=color:#4070a0>&#39;%s (%s): %s&#39;</span> % <span style=color:#666>(</span>round<span style=color:#666>(</span>b-a, 2<span style=color:#666>)</span>, self.ctx.dbq_count, str<span style=color:#666>(</span>sql_query<span style=color:#666>))</span>, <span style=color:#bb60d5>file</span><span style=color:#666>=</span>debug<span style=color:#666>)(</span>db.py:623<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at out.write<span style=color:#666>(</span>x<span style=color:#666>)(</span>webapi.py:512<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#4070a0>&#34;MainThread&#34;</span> <span style=color:#bb60d5>tid</span><span style=color:#666>=</span><span style=color:#40a070>139695478638400</span>
</span></span><span style=display:flex><span>    at app.run<span style=color:#666>()(</span>xxx.py:326<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>return</span> wsgi.runwsgi<span style=color:#666>(</span>self.wsgifunc<span style=color:#666>(</span>*middleware<span style=color:#666>))(</span>application.py:341<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>return</span> httpserver.runsimple<span style=color:#666>(</span>func, server_addr<span style=color:#666>)(</span>wsgi.py:59<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at server.start<span style=color:#666>()(</span>httpserver.py:177<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.tick<span style=color:#666>()(</span>wsgiserver2.py:1956<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at s, <span style=color:#bb60d5>addr</span> <span style=color:#666>=</span> self.socket.accept<span style=color:#666>()(</span>wsgiserver2.py:2008<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at sock, <span style=color:#bb60d5>addr</span> <span style=color:#666>=</span> self._sock.accept<span style=color:#666>()(</span>socket.py:202<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at pystack<span style=color:#666>()(</span>pdbx.py:181<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>for</span> filename, lineno, _, line in traceback.extract_stack<span style=color:#666>(</span>stack<span style=color:#666>)</span>:<span style=color:#666>(</span>pdbx.py:169<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>... omit CP Server Thread-1 / Thread-2 / Thread-6 / Thread-7 / Thread-8
</span></span><span style=display:flex><span>... same as other thread
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#4070a0>&#34;CP Server Thread-4&#34;</span> <span style=color:#bb60d5>tid</span><span style=color:#666>=</span><span style=color:#40a070>139695180908288</span>
</span></span><span style=display:flex><span>    at self.__bootstrap_inner<span style=color:#666>()(</span>threading.py:785<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.run<span style=color:#666>()(</span>threading.py:812<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at conn.communicate<span style=color:#666>()(</span>wsgiserver2.py:1532<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    ... more omitted 
</span></span><span style=display:flex><span>    at <span style=color:#bb60d5>instances</span> <span style=color:#666>=</span> list<span style=color:#666>(</span>db.select<span style=color:#666>(</span><span style=color:#4070a0>&#39;instance&#39;</span>, vars, <span style=color:#bb60d5>where</span><span style=color:#666>=</span><span style=color:#4070a0>&#39;app_name=$app_name and host=$host and port=$port&#39;</span><span style=color:#666>))(</span>xxx.py:233<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>return</span> self.query<span style=color:#666>(</span>qout, <span style=color:#bb60d5>processed</span><span style=color:#666>=</span>True<span style=color:#666>)(</span>db.py:720<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self._db_execute<span style=color:#666>(</span>db_cursor, sql_query<span style=color:#666>)(</span>db.py:680<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at print<span style=color:#666>(</span><span style=color:#4070a0>&#39;%s (%s): %s&#39;</span> % <span style=color:#666>(</span>round<span style=color:#666>(</span>b-a, 2<span style=color:#666>)</span>, self.ctx.dbq_count, str<span style=color:#666>(</span>sql_query<span style=color:#666>))</span>, <span style=color:#bb60d5>file</span><span style=color:#666>=</span>debug<span style=color:#666>)(</span>db.py:623<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at out.write<span style=color:#666>(</span>x<span style=color:#666>)(</span>webapi.py:512<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#4070a0>&#34;APScheduler&#34;</span> <span style=color:#bb60d5>tid</span><span style=color:#666>=</span><span style=color:#40a070>139695219828480</span>
</span></span><span style=display:flex><span>    at self.__bootstrap_inner<span style=color:#666>()(</span>threading.py:785<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.run<span style=color:#666>()(</span>threading.py:812<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.__target<span style=color:#666>(</span>*self.__args, **self.__kwargs<span style=color:#666>)(</span>threading.py:765<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self._event.wait<span style=color:#666>(</span>wait_seconds<span style=color:#666>)(</span>blocking.py:28<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.__cond.wait<span style=color:#666>(</span>timeout, balancing<span style=color:#666>)(</span>threading.py:622<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at waiter.acquire<span style=color:#666>()(</span>threading.py:339<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#4070a0>&#34;CP Server Thread-3&#34;</span> <span style=color:#bb60d5>tid</span><span style=color:#666>=</span><span style=color:#40a070>139695189300992</span>
</span></span><span style=display:flex><span>    at self.__bootstrap_inner<span style=color:#666>()(</span>threading.py:785<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.run<span style=color:#666>()(</span>threading.py:812<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at conn.communicate<span style=color:#666>()(</span>wsgiserver2.py:1532<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    ... more omitted 
</span></span><span style=display:flex><span>    at <span style=color:#bb60d5>instances</span> <span style=color:#666>=</span> list<span style=color:#666>(</span>db.select<span style=color:#666>(</span><span style=color:#4070a0>&#39;instance&#39;</span>, vars, <span style=color:#bb60d5>where</span><span style=color:#666>=</span><span style=color:#4070a0>&#39;app_name=$app_name and host=$host and port=$port&#39;</span><span style=color:#666>))(</span>xxx.py:233<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>return</span> self.query<span style=color:#666>(</span>qout, <span style=color:#bb60d5>processed</span><span style=color:#666>=</span>True<span style=color:#666>)(</span>db.py:720<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self._db_execute<span style=color:#666>(</span>db_cursor, sql_query<span style=color:#666>)(</span>db.py:680<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at print<span style=color:#666>(</span><span style=color:#4070a0>&#39;%s (%s): %s&#39;</span> % <span style=color:#666>(</span>round<span style=color:#666>(</span>b-a, 2<span style=color:#666>)</span>, self.ctx.dbq_count, str<span style=color:#666>(</span>sql_query<span style=color:#666>))</span>, <span style=color:#bb60d5>file</span><span style=color:#666>=</span>debug<span style=color:#666>)(</span>db.py:623<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at out.write<span style=color:#666>(</span>x<span style=color:#666>)(</span>webapi.py:512<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#4070a0>&#34;CP Server Thread-5&#34;</span> <span style=color:#bb60d5>tid</span><span style=color:#666>=</span><span style=color:#40a070>139695172515584</span>
</span></span><span style=display:flex><span>    at self.__bootstrap_inner<span style=color:#666>()(</span>threading.py:785<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self.run<span style=color:#666>()(</span>threading.py:812<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at conn.communicate<span style=color:#666>()(</span>wsgiserver2.py:1532<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    ... more omitted 
</span></span><span style=display:flex><span>    at <span style=color:#bb60d5>instances</span> <span style=color:#666>=</span> list<span style=color:#666>(</span>db.select<span style=color:#666>(</span><span style=color:#4070a0>&#39;instance&#39;</span>, vars, <span style=color:#bb60d5>where</span><span style=color:#666>=</span><span style=color:#4070a0>&#39;app_name=$app_name and host=$host and port=$port&#39;</span><span style=color:#666>))(</span>xxx.py:233<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at <span style=color:#007020;font-weight:700>return</span> self.query<span style=color:#666>(</span>qout, <span style=color:#bb60d5>processed</span><span style=color:#666>=</span>True<span style=color:#666>)(</span>db.py:720<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at self._db_execute<span style=color:#666>(</span>db_cursor, sql_query<span style=color:#666>)(</span>db.py:680<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at print<span style=color:#666>(</span><span style=color:#4070a0>&#39;%s (%s): %s&#39;</span> % <span style=color:#666>(</span>round<span style=color:#666>(</span>b-a, 2<span style=color:#666>)</span>, self.ctx.dbq_count, str<span style=color:#666>(</span>sql_query<span style=color:#666>))</span>, <span style=color:#bb60d5>file</span><span style=color:#666>=</span>debug<span style=color:#666>)(</span>db.py:623<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    at out.write<span style=color:#666>(</span>x<span style=color:#666>)(</span>webapi.py:512<span style=color:#666>)</span>
</span></span></code></pre></div><p>OK，总计 10 个工作线程，全都阻塞在 <code>out.write(x)</code> ，多次打印调用栈结果相同。基本可以断定是 <code>write</code> 方法出了问题了。不过直到这个时候，都还是深陷在死锁原因中无法自拔（还是接触得太少了）。</p><p>虚度半个多钟&mldr; 后看代码了解到，其准备将 SQL 执行结果打印到标准错误。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>_debugwrite</span>(x):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        out <span style=color:#666>=</span> ctx<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;wsgi.errors&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>except</span>:
</span></span><span style=display:flex><span>        out <span style=color:#666>=</span> sys<span style=color:#666>.</span>stderr
</span></span><span style=display:flex><span>    out<span style=color:#666>.</span>write(x)
</span></span><span style=display:flex><span>debug<span style=color:#666>.</span>write <span style=color:#666>=</span> _debugwrite
</span></span></code></pre></div><p>果断去查看 Python 服务的文件描述符 <code>lsof -p &lt;PID></code> / <code>ls -al /proc/&lt;PID>/fd</code> 。总算见着可信的证据了。</p><pre tabindex=0><code>&gt; lsof -p &lt;PID&gt;
python  139756 sysop    0r  FIFO     0,9       0t0 5210639 pipe
python  139756 sysop    1w   REG   253,1      5187 1188500 /home/www/wwwroot/logs/eswitch-console.9999.log
python  139756 sysop    2w  FIFO     0,9       0t0 5210641 pipe
python  139756 sysop    3u  IPv4 5210787       0t0     TCP 10.1.5.60:65442-&gt;10.1.6.104:mysql (ESTABLISHED)
python  139756 sysop    4r  FIFO     0,9       0t0 5210774 pipe
python  139756 sysop    5w  FIFO     0,9       0t0 5210774 pipe
python  139756 sysop    6r  FIFO     0,9       0t0 5210778 pipe
python  139756 sysop    7w  FIFO     0,9       0t0 5210778 pipe
python  139756 sysop    8u  IPv4 5210788       0t0     TCP *:distinct (LISTEN)
python  139756 sysop    9u  IPv4 5226722       0t0     TCP localhost:distinct-&gt;localhost:26032 (CLOSE_WAIT)
python  139756 sysop   10u  IPv4 5226858       0t0     TCP localhost:distinct-&gt;localhost:26052 (CLOSE_WAIT)
... more omitted
</code></pre><pre tabindex=0><code>&gt; ls -al /proc/&lt;PID&gt;/fd
lr-x------ 1 sysop sysop 64 May 20 13:47 0 -&gt; pipe:[5210639]
l-wx------ 1 sysop sysop 64 May 20 13:47 1 -&gt; /home/path/to/logs/xxx.log
l-wx------ 1 sysop sysop 64 May 20 13:47 2 -&gt; pipe:[5210641]
lrwx------ 1 sysop sysop 64 May 20 13:47 3 -&gt; socket:[5210787]
lr-x------ 1 sysop sysop 64 May 20 13:47 4 -&gt; pipe:[5210774]
l-wx------ 1 sysop sysop 64 May 20 13:47 5 -&gt; pipe:[5210774]
lr-x------ 1 sysop sysop 64 May 20 13:47 6 -&gt; pipe:[5210778]
l-wx------ 1 sysop sysop 64 May 20 13:47 7 -&gt; pipe:[5210778]
... more omitted
</code></pre><p>标准错误(fd = 2)指向了一个匿名管道（inode = 5210641）。但是找遍整个系统都没有这个匿名管道的读取方，只有写入方</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>&gt; sudo lsof | grep <span style=color:#40a070>5210641</span>
</span></span><span style=display:flex><span>bash      <span style=color:#40a070>139747</span>          sysop    2w     FIFO                0,9       0t0    <span style=color:#40a070>5210641</span> pipe
</span></span><span style=display:flex><span>python    <span style=color:#40a070>139756</span>          sysop    2w     FIFO                0,9       0t0    <span style=color:#40a070>5210641</span> pipe
</span></span><span style=display:flex><span>python    <span style=color:#40a070>139756</span> <span style=color:#40a070>139764</span>   sysop    2w     FIFO                0,9       0t0    <span style=color:#40a070>5210641</span> pipe
</span></span></code></pre></div><p>OK，合理的解释出现了。管道的缓冲区大小有限(经过测试是 64KB)，Python 服务在不断地向标准错误打印日志，从而导致匿名管道(inode = 5210641)的缓冲区数据不断积累，最终达到满的状态。这个过程大概需要一天多的心跳包才能积累得到。而系统调用 <code>write</code> 发现标准错误对应的文件已满，为等待 IO 就绪而陷入睡眠状态。同时，Main 线程在不断地 Accept 新的套接字的建立，而没有更多工作线程来处理新的请求，Nginx 因为连接超时直接发出来 FIN 包。最后，积累了几千/上万请求的 Python 服务也没法主动 close 已有的套接字（即 FIN,ACK 包因为没法发送而在本机不断积累 <code>CLOSE_WAIT</code> 状态的连接）</p><h3 id=重定向标准错误的原因>重定向标准错误的原因</h3><p>至于为何会将标准错误重定向到一个匿名管道呢？百思不得其解，不过最后还是从应用负责人那儿得到了提示。新的发布方式采用了全新的启动命令:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh -fn xx.xx.x.60 <span style=color:#4070a0>&#39;cd /home/path/to/xxx ; python -u xxx.py 8080 &gt;&gt; /home/path/to/logs/xxx.log&#39;</span>
</span></span></code></pre></div><p>一看就能和前面的原因衔接，使用 ssh 直接调用命名，不会建立一个终端，由 ssh 远程命令启动的任务，其标准输入/输出/错误默认将会通过管道重定向的 ssh server 端，并通过网络传回发起的 ssh client 端。</p><p><em>以发起 <code>ssh -fn ...</code> 的机器为 xx.192，目标机器为 xx.60</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>
</span></span><span style=display:flex><span>  xx.192                       |           xx.60
</span></span><span style=display:flex><span>  -----------------------------+-------------------------------
</span></span><span style=display:flex><span>                               | 
</span></span><span style=display:flex><span>    ssh client                 |          ssh serve           python serve
</span></span><span style=display:flex><span>  +------------+               |        +------------+       +-------------+
</span></span><span style=display:flex><span>  | 0 | stdin  |               |        | y | pipe[a]| &lt;---&gt; | 0 | pipe[a] |
</span></span><span style=display:flex><span>  | 1 | stdout |               |        | z | pipe[b]| &lt;-+   | 1 | xxx.log |
</span></span><span style=display:flex><span>  | 2 | stderr |               |        |   |        |   +-&gt; | 2 | pipe[b] |
</span></span><span style=display:flex><span>  | ...        |               |        | ...        |       | ...         |
</span></span><span style=display:flex><span>  | x | sock   | &lt;--------------------&gt; | w | sock   |       | ...         |
</span></span><span style=display:flex><span>  +------------+               |        +------------+       +-------------+
</span></span></code></pre></div><p>Python 服务通过管道与 ssh serve 进行进程间交互，最终会将标准错误打印到 192 机器的标准输出/错误上（一般是终端，也就是我们将在终端上看到 Python 服务的错误日志）。而问题在于 ssh serve 任务被杀掉了，从而 <code>pipe[b]</code> 只能不断地向匿名管道写入数据，而没有任务读取数据，一天多时间也就将缓冲区写满了。</p><h2 id=总结>总结</h2><p>到此为止，问题总算得到了圆满的解释，历时 5 天。最重要的就是通过调用栈定位代码阻塞的原因，否则就真是瞎找。对于匿名管道问题的发现、write 系统调用导致的线程睡眠，都是建立在调用栈信息之上的定向探究的过程。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>  __                    __                  
</span></span><span style=display:flex><span> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
</span></span><span style=display:flex><span>| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
</span></span><span style=display:flex><span>|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
</span></span><span style=display:flex><span>|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
</span></span><span style=display:flex><span>                 |___/                |___/ 
</span></span></code></pre></div></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/pipe/>pipe</a></div><div class=post-tags><a href=/tags/close_wait/>CLOSE_WAIT</a></div></div></div><div class=row><div class=col-xs-12><script type=module> import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs"; mermaid.initialize({ startOnLoad: true }); </script></div></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var e=document,t=e.createElement("script");t.src="https://ffutop.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()})</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer></div></div></div></article><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread"),t=new MutationObserver(function(n){n.forEach(function(){const s=e.getElementsByTagName("iframe");if(s.length>1){const n=s[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(n),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script></body></html>