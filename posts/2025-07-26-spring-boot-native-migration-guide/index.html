<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="ffutop"><meta property="og:url" content="https://www.ffutop.com/posts/2025-07-26-spring-boot-native-migration-guide/"><link rel=canonical href=https://www.ffutop.com/posts/2025-07-26-spring-boot-native-migration-guide/><link rel=apple-touch-icon href=favicon.ico><link rel=icon href=favicon.ico><link rel=shortcut href=favicon.ico><link rel=alternate type=application/atom+xml href=https://www.ffutop.com/index.xml title="Utop's Blog"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.ffutop.com\/"},"articleSection":"posts","name":"告别 Spring Boot 慢启动：GraalVM 原生镜像迁移实践","headline":"告别 Spring Boot 慢启动：GraalVM 原生镜像迁移实践","description":"随着云原生和 Serverless 架构的兴起，应用的启动速度、内存占用和打包体积变得至关重要。Spring Boot 3.x 结合 GraalVM Native Image 技术，为 Java 应用提供了“原生编译”这一颠覆","inLanguage":"en-US","author":"ffutop","creator":"ffutop","publisher":"ffutop","accountablePerson":"ffutop","copyrightHolder":"ffutop","copyrightYear":"2025","datePublished":"2025-07-26 00:00:00 \u002b0000 UTC","dateModified":"2025-07-26 00:00:00 \u002b0000 UTC","url":"https:\/\/www.ffutop.com\/posts\/2025-07-26-spring-boot-native-migration-guide\/","keywords":["Spring Boot","Spring","GraalVM","Native Image","Java","Cloud Native","Migration"]}</script><title>告别 Spring Boot 慢启动：GraalVM 原生镜像迁移实践</title><meta property="og:title" content="告别 Spring Boot 慢启动：GraalVM 原生镜像迁移实践"><meta property="og:type" content="article"><meta property="og:description" content="随着云原生和 Serverless 架构的兴起，应用的启动速度、内存占用和打包体积变得至关重要。Spring Boot 3.x 结合 GraalVM Native Image 技术，为 Java 应用提供了“原生编译”这一颠覆"><meta name=description content="随着云原生和 Serverless 架构的兴起，应用的启动速度、内存占用和打包体积变得至关重要。Spring Boot 3.x 结合 GraalVM Native Image 技术，为 Java 应用提供了“原生编译”这一颠覆"><meta property="og:locale" content="zh-cmn-Hans-CN"><meta property="og:image" content="favicon.ico"><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,noto sans,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji;font-weight:400;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#333;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{color-scheme:light;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;margin:0;color:#1f2328;background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,segoe ui,noto sans,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:' ';display:inline-block;background-color:currentColor;-webkit-mask-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");mask-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>")}.markdown-body details,.markdown-body figcaption,.markdown-body figure{display:block}.markdown-body summary{display:list-item}.markdown-body [hidden]{display:none!important}.markdown-body a{background-color:transparent;color:#0969da;text-decoration:none}.markdown-body abbr[title]{border-bottom:none;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}.markdown-body b,.markdown-body strong{font-weight:600}.markdown-body dfn{font-style:italic}.markdown-body h1{margin:.67em 0;font-weight:600;padding-bottom:.3em;font-size:2em;border-bottom:1px solid #d1d9e0b3}.markdown-body mark{background-color:#fff8c5;color:#1f2328}.markdown-body small{font-size:90%}.markdown-body sub,.markdown-body sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}.markdown-body sub{bottom:-.25em}.markdown-body sup{top:-.5em}.markdown-body img{border-style:none;max-width:100%;box-sizing:content-box}.markdown-body code,.markdown-body kbd,.markdown-body pre,.markdown-body samp{font-family:monospace;font-size:1em}.markdown-body figure{margin:1em 2.5rem}.markdown-body hr{box-sizing:content-box;overflow:hidden;background:0 0;border-bottom:1px solid #d1d9e0b3;height:.25em;padding:0;margin:1.5rem 0;background-color:#d1d9e0;border:0}.markdown-body input{font:inherit;margin:0;overflow:visible;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=button],.markdown-body [type=reset],.markdown-body [type=submit]{-webkit-appearance:button;appearance:button}.markdown-body [type=checkbox],.markdown-body [type=radio]{box-sizing:border-box;padding:0}.markdown-body [type=number]::-webkit-inner-spin-button,.markdown-body [type=number]::-webkit-outer-spin-button{height:auto}.markdown-body [type=search]::-webkit-search-cancel-button,.markdown-body [type=search]::-webkit-search-decoration{-webkit-appearance:none;appearance:none}.markdown-body ::-webkit-input-placeholder{color:inherit;opacity:.54}.markdown-body ::-webkit-file-upload-button{-webkit-appearance:button;appearance:button;font:inherit}.markdown-body a:hover{text-decoration:underline}.markdown-body ::placeholder{color:#59636e;opacity:1}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body table{border-spacing:0;border-collapse:collapse;display:block;width:max-content;max-width:100%;overflow:auto;font-variant:tabular-nums}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body a:focus,.markdown-body [role=button]:focus,.markdown-body input[type=radio]:focus,.markdown-body input[type=checkbox]:focus{outline:2px solid #0969da;outline-offset:-2px;box-shadow:none}.markdown-body a:focus:not(:focus-visible),.markdown-body [role=button]:focus:not(:focus-visible),.markdown-body input[type=radio]:focus:not(:focus-visible),.markdown-body input[type=checkbox]:focus:not(:focus-visible){outline:solid 1px transparent}.markdown-body a:focus-visible,.markdown-body [role=button]:focus-visible,.markdown-body input[type=radio]:focus-visible,.markdown-body input[type=checkbox]:focus-visible{outline:2px solid #0969da;outline-offset:-2px;box-shadow:none}.markdown-body a:not([class]):focus,.markdown-body a:not([class]):focus-visible,.markdown-body input[type=radio]:focus,.markdown-body input[type=radio]:focus-visible,.markdown-body input[type=checkbox]:focus,.markdown-body input[type=checkbox]:focus-visible{outline-offset:0}.markdown-body kbd{display:inline-block;padding:.25rem;font:11px ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;line-height:10px;color:#1f2328;vertical-align:middle;background-color:#f6f8fa;border:solid 1px #d1d9e0b3;border-bottom-color:#d1d9e0b3;border-radius:6px;box-shadow:inset 0 -1px #d1d9e0b3}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:1.5rem;margin-bottom:1rem;font-weight:600;line-height:1.25}.markdown-body h2{font-weight:600;padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #d1d9e0b3}.markdown-body h3{font-weight:600;font-size:1.25em}.markdown-body h4{font-weight:600;font-size:1em}.markdown-body h5{font-weight:600;font-size:.875em}.markdown-body h6{font-weight:600;font-size:.85em;color:#59636e}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0;padding:0 1em;color:#59636e;border-left:.25em solid #d1d9e0}.markdown-body ul,.markdown-body ol{margin-top:0;margin-bottom:0;padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ul ul ol,.markdown-body ul ol ol,.markdown-body ol ul ol,.markdown-body ol ol ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body tt,.markdown-body code,.markdown-body samp{font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0;font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:12px;word-wrap:normal}.markdown-body .octicon{display:inline-block;overflow:visible!important;vertical-align:text-bottom;fill:currentColor}.markdown-body input::-webkit-outer-spin-button,.markdown-body input::-webkit-inner-spin-button{margin:0;appearance:none}.markdown-body .mr-2{margin-right:.5rem!important}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>*:first-child{margin-top:0!important}.markdown-body>*:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#d1242f}.markdown-body .anchor{float:left;padding-right:.25rem;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body p,.markdown-body blockquote,.markdown-body ul,.markdown-body ol,.markdown-body dl,.markdown-body table,.markdown-body pre,.markdown-body details{margin-top:0;margin-bottom:1rem}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1f2328;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 tt,.markdown-body h1 code,.markdown-body h2 tt,.markdown-body h2 code,.markdown-body h3 tt,.markdown-body h3 code,.markdown-body h4 tt,.markdown-body h4 code,.markdown-body h5 tt,.markdown-body h5 code,.markdown-body h6 tt,.markdown-body h6 code{padding:0 .2em;font-size:inherit}.markdown-body summary h1,.markdown-body summary h2,.markdown-body summary h3,.markdown-body summary h4,.markdown-body summary h5,.markdown-body summary h6{display:inline-block}.markdown-body summary h1 .anchor,.markdown-body summary h2 .anchor,.markdown-body summary h3 .anchor,.markdown-body summary h4 .anchor,.markdown-body summary h5 .anchor,.markdown-body summary h6 .anchor{margin-left:-40px}.markdown-body summary h1,.markdown-body summary h2{padding-bottom:0;border-bottom:0}.markdown-body ul.no-list,.markdown-body ol.no-list{padding:0;list-style-type:none}.markdown-body ol[type="a s"]{list-style-type:lower-alpha}.markdown-body ol[type="A s"]{list-style-type:upper-alpha}.markdown-body ol[type="i s"]{list-style-type:lower-roman}.markdown-body ol[type="I s"]{list-style-type:upper-roman}.markdown-body ol[type="1"]{list-style-type:decimal}.markdown-body div>ol:not([type]){list-style-type:decimal}.markdown-body ul ul,.markdown-body ul ol,.markdown-body ol ol,.markdown-body ol ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:1rem}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:1rem;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 1rem;margin-bottom:1rem}.markdown-body table th{font-weight:600}.markdown-body table th,.markdown-body table td{padding:6px 13px;border:1px solid #d1d9e0}.markdown-body table td>:last-child{margin-bottom:0}.markdown-body table tr{background-color:#fff;border-top:1px solid #d1d9e0b3}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body table img{background-color:transparent}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #d1d9e0}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#1f2328}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:.2em .4em;margin:0;font-size:85%;white-space:break-spaces;background-color:#818b981f;border-radius:6px}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body samp{font-size:85%}.markdown-body pre code{font-size:100%}.markdown-body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:1rem}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:1rem;overflow:auto;font-size:85%;line-height:1.45;color:#1f2328;background-color:#f6f8fa;border-radius:6px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-num{padding:10px .5rem 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:600;background:#f6f8fa;border-top:0}.markdown-body [data-footnote-ref]::before{content:"["}.markdown-body [data-footnote-ref]::after{content:"]"}.markdown-body .footnotes{font-size:12px;color:#59636e;border-top:1px solid #d1d9e0}.markdown-body .footnotes ol{padding-left:1rem}.markdown-body .footnotes ol ul{display:inline-block;padding-left:1rem;margin-top:1rem}.markdown-body .footnotes li{position:relative}.markdown-body .footnotes li:target::before{position:absolute;top:calc(.5rem*-1);right:calc(.5rem*-1);bottom:calc(.5rem*-1);left:calc(1.5rem*-1);pointer-events:none;content:"";border:2px solid #0969da;border-radius:6px}.markdown-body .footnotes li:target{color:#1f2328}.markdown-body .footnotes .data-footnote-backref g-emoji{font-family:monospace}.markdown-body body:has(:modal){padding-right:var(--dialog-scrollgutter)!important}.markdown-body .pl-c{color:#59636e}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#0550ae}.markdown-body .pl-e,.markdown-body .pl-en{color:#6639ba}.markdown-body .pl-smi,.markdown-body .pl-s .pl-s1{color:#1f2328}.markdown-body .pl-ent{color:#0550ae}.markdown-body .pl-k{color:#cf222e}.markdown-body .pl-s,.markdown-body .pl-pds,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sre,.markdown-body .pl-sr .pl-sra{color:#0a3069}.markdown-body .pl-v,.markdown-body .pl-smw{color:#953800}.markdown-body .pl-bu{color:#82071e}.markdown-body .pl-ii{color:#f6f8fa;background-color:#82071e}.markdown-body .pl-c2{color:#f6f8fa;background-color:#cf222e}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#116329}.markdown-body .pl-ml{color:#3b2300}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#0550ae}.markdown-body .pl-mi{font-style:italic;color:#1f2328}.markdown-body .pl-mb{font-weight:700;color:#1f2328}.markdown-body .pl-md{color:#82071e;background-color:#ffebe9}.markdown-body .pl-mi1{color:#116329;background-color:#dafbe1}.markdown-body .pl-mc{color:#953800;background-color:#ffd8b5}.markdown-body .pl-mi2{color:#d1d9e0;background-color:#0550ae}.markdown-body .pl-mdr{font-weight:700;color:#8250df}.markdown-body .pl-ba{color:#59636e}.markdown-body .pl-sg{color:#818b98}.markdown-body .pl-corl{text-decoration:underline;color:#0a3069}.markdown-body [role=button]:focus:not(:focus-visible),.markdown-body [role=tabpanel][tabindex="0"]:focus:not(:focus-visible),.markdown-body button:focus:not(:focus-visible),.markdown-body summary:focus:not(:focus-visible),.markdown-body a:focus:not(:focus-visible){outline:none;box-shadow:none}.markdown-body [tabindex="0"]:focus:not(:focus-visible),.markdown-body details-dialog:focus:not(:focus-visible){outline:none}.markdown-body g-emoji{display:inline-block;min-width:1ch;font-family:apple color emoji,segoe ui emoji,segoe ui symbol;font-size:1em;font-style:normal!important;font-weight:400;line-height:1;vertical-align:-.075em}.markdown-body g-emoji img{width:1em;height:1em}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item label{font-weight:400}.markdown-body .task-list-item.enabled label{cursor:pointer}.markdown-body .task-list-item+.task-list-item{margin-top:.25rem}.markdown-body .task-list-item .handle{display:none}.markdown-body .task-list-item-checkbox{margin:0 .2em .25em -1.4em;vertical-align:middle}.markdown-body ul:dir(rtl) .task-list-item-checkbox{margin:0 -1.6em .25em .2em}.markdown-body ol:dir(rtl) .task-list-item-checkbox{margin:0 -1.6em .25em .2em}.markdown-body .contains-task-list:hover .task-list-item-convert-container,.markdown-body .contains-task-list:focus-within .task-list-item-convert-container{display:block;width:auto;height:24px;overflow:visible;clip:auto}.markdown-body ::-webkit-calendar-picker-indicator{filter:invert(50%)}.markdown-body .markdown-alert{padding:.5rem 1rem;margin-bottom:1rem;color:inherit;border-left:.25em solid #d1d9e0}.markdown-body .markdown-alert>:first-child{margin-top:0}.markdown-body .markdown-alert>:last-child{margin-bottom:0}.markdown-body .markdown-alert .markdown-alert-title{display:flex;font-weight:500;align-items:center;line-height:1}.markdown-body .markdown-alert.markdown-alert-note{border-left-color:#0969da}.markdown-body .markdown-alert.markdown-alert-note .markdown-alert-title{color:#0969da}.markdown-body .markdown-alert.markdown-alert-important{border-left-color:#8250df}.markdown-body .markdown-alert.markdown-alert-important .markdown-alert-title{color:#8250df}.markdown-body .markdown-alert.markdown-alert-warning{border-left-color:#9a6700}.markdown-body .markdown-alert.markdown-alert-warning .markdown-alert-title{color:#9a6700}.markdown-body .markdown-alert.markdown-alert-tip{border-left-color:#1a7f37}.markdown-body .markdown-alert.markdown-alert-tip .markdown-alert-title{color:#1a7f37}.markdown-body .markdown-alert.markdown-alert-caution{border-left-color:#cf222e}.markdown-body .markdown-alert.markdown-alert-caution .markdown-alert-title{color:#d1242f}.markdown-body>*:first-child>.heading-element:first-child{margin-top:0!important}.markdown-body .highlight pre:has(+.zeroclipboard-container){min-height:52px}.Chinese .markdown-body{line-height:150%}.site-date-catalog{font-size:1.8rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1rem;margin:8px 0;font-weight:500}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600;margin-bottom:.5em}.post-tags{display:inline;font-weight:400;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:400;font-style:italic}.post-author{float:right;font-weight:400}.page-content{min-height:60%}.post-content{margin-bottom:50px;margin-left:auto;margin-right:auto;padding-left:15px;padding-right:15px}.post-content p{hyphens:auto;font-size:1rem;line-height:1.7;margin-top:0;margin-bottom:1.2em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.post-content h1{font-size:1.8rem;font-weight:600;margin-top:1.5em;margin-bottom:.8em;line-height:1.3;padding-bottom:.3em;border-bottom:1px solid #eaecef}.post-content h2{font-size:1.5rem;font-weight:600;margin-top:1.8em;margin-bottom:.8em;line-height:1.3;padding-bottom:.3em;border-bottom:1px solid #eaecef}.post-content h3{font-size:1.25rem;font-weight:600;margin-top:1.6em;margin-bottom:.6em;line-height:1.4}.post-content h4{font-size:1.1rem;font-weight:500;margin-top:1.4em;margin-bottom:.5em;line-height:1.4}.post-content table{width:100%;border-collapse:collapse;margin:1.5em 0;font-size:.95em;box-shadow:0 1px 3px rgba(0,0,0,.1)}.post-content th,.post-content td{border:1px solid #ddd;padding:10px 12px;text-align:left}.post-content th{background-color:#f2f2f2;font-weight:700}.post-content tr:nth-child(even){background-color:#f9f9f9}.post-content tr:hover{background-color:#f1f1f1}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{}.posts-line{font-size:16px}.markdown-body{font-size:.95rem;line-height:1.65}.post-title{font-size:1.7rem}.post-content p{letter-spacing:normal;line-height:1.65}.post-content .post-gallery img{width:100%}.post-content h1{font-size:1.7rem}.post-content h2{font-size:1.4rem}.post-content h3{font-size:1.2rem}.post-content h4{font-size:1.05rem}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=/index.xml rel=alternate type=application/rss+xml title="Utop's Blog"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500;600;700&family=Source+Code+Pro:wght@600&display=swap" rel=stylesheet><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-3RHY4L44ZL"></script> <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3RHY4L44ZL")</script></head><body><article class="post Chinese" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>FFUTOP</a></div><div class=header-subtitle></div></header><div class="row end-md header-items"><div class=header-item><a href=/posts/ target=_blank>Posts</a></div><div class=header-item><a href=/index.xml target=_blank>RSS</a></div><div class=header-item><a href=https://github.com/ffutop target=_blank>Github</a></div><div class=header-item><a href=https://ffkit.ffutop.com/author target=_blank>About</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>告别 Spring Boot 慢启动：GraalVM 原生镜像迁移实践</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2025-07-26 00:00:00 UTC">26 Jul 2025</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://www.ffutop.com/>@ffutop</a></div></div></div></header><div class="post-content markdown-body"><p>随着云原生和 Serverless 架构的兴起，应用的启动速度、内存占用和打包体积变得至关重要。Spring Boot 3.x 结合 GraalVM Native Image 技术，为 Java 应用提供了“原生编译”这一颠覆性选项，能够创造出启动如闪电、资源消耗极低的轻量级可执行文件。</p><p>本文将作为一份详细的案例分析与经验总结，系统性地阐述一个典型的 Spring Boot 2.7.2 应用，如何一步步迁移到 Spring Boot 3.x，并最终打包为高性能的 GraalVM 原生可执行文件。我们将深入探讨迁移过程中的关键变更、常见陷阱、解决方案以及最终的性能收益。</p><p>前置阅读：为更好地理解本文内容，建议您先阅读 <a href=/posts/2025-07-26-graalvm-native-image/>《剖析 GraalVM Native Image 技术》</a>，该文详细介绍了 GraalVM 的核心原理。</p><p><em>声明：为聚焦核心迁移流程，本文提供的源码与脚本经过简化，旨在便于理解，可能未完全遵循生产环境的最佳工程实践。</em></p><h2 id=迁移实践>迁移实践</h2><h3 id=java-版本升级>Java 版本升级</h3><p>本次迁移的首要任务，是将项目的基础环境从长期使用的 JDK 8 升级至支持原生镜像的现代化版本。</p><p>这里选择 JDK 21，使用 <a href=https://sdkman.io/jdks/graalce>GraalVM Community</a> 分发版本。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 安装 SDKMAN</span>
</span></span><span style=display:flex><span>curl -s <span style=color:#4070a0>&#34;https://get.sdkman.io&#34;</span> | bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 安装 GraalVM Community 21.0.2</span>
</span></span><span style=display:flex><span>sdk install java 21.0.2-graalce
</span></span></code></pre></div><h3 id=spring-boot-版本升级>Spring Boot 版本升级</h3><p>简单起见，直接将依赖的父 POM 升级到 Spring Boot 3.5.3</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>&lt;project&gt;
</span></span><span style=display:flex><span>	&lt;parent&gt;
</span></span><span style=display:flex><span>		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style=display:flex><span>		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
</span></span><span style=display:flex><span><span style=color:#00a000>+		&lt;version&gt;3.5.3&lt;/version&gt;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:#a00000>-		&lt;version&gt;2.7.2&lt;/version&gt;
</span></span></span><span style=display:flex><span><span style=color:#a00000></span>		&lt;relativePath/&gt;
</span></span><span style=display:flex><span>	&lt;/parent&gt;
</span></span><span style=display:flex><span>&lt;/project&gt;
</span></span></code></pre></div><p>同时为了编译 Native Image，需要在 POM 中添加 GraalVM Native Image 插件。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;project&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#062873;font-weight:700>&lt;build&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#60a0b0;font-style:italic>&lt;!-- Spring Boot Maven 插件 --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#60a0b0;font-style:italic>&lt;!-- 当声明 mvn -Pnative 时，会引入由 父 POM 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>        spring-boot-starter-parent 管理的 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>        pluginManagement 声明 --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#062873;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#062873;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#062873;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;version&gt;</span>3.5.3<span style=color:#062873;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#062873;font-weight:700>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#60a0b0;font-style:italic>&lt;!-- GraalVM Native Maven 插件--&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#60a0b0;font-style:italic>&lt;!-- 当声明 mvn -Pnative 时，会引入由 父 POM 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>        spring-boot-starter-parent 管理的 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>        pluginManagement 声明 --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#60a0b0;font-style:italic>&lt;!-- 但仍需主动声明在 package 阶段挂载上 compile-no-fork 目标 --&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#062873;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;groupId&gt;</span>org.graalvm.buildtools<span style=color:#062873;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;artifactId&gt;</span>native-maven-plugin<span style=color:#062873;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;version&gt;</span>0.10.6<span style=color:#062873;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#062873;font-weight:700>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;id&gt;</span>build-native<span style=color:#062873;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#062873;font-weight:700>&lt;goal&gt;</span>compile-no-fork<span style=color:#062873;font-weight:700>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;phase&gt;</span>package<span style=color:#062873;font-weight:700>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#062873;font-weight:700>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#062873;font-weight:700>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#062873;font-weight:700>&lt;/build&gt;</span>
</span></span><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;/project&gt;</span>
</span></span></code></pre></div><p>由于 Java 版本和 Spring Boot 大版本升级，需要同步进行一些不兼容的变更。包括：</p><ol><li><p>依赖的 Spring Framework 需要全面升级到 6.x 版本（如有在原 <code>pom.xml</code> 主动声明了低版本号的，下同）</p></li><li><p>依赖的 Spring Security 升级到 6.x 版本，移除了 <code>antMatcher</code> 改用 <code>securityMatcher</code>。</p></li><li><p>因 Java 版本升级，Java EE 也需升级到 Jakarta EE 版本。相关的 <code>javax.*</code> 代码都需要调整为 <code>jakarta.*</code>。</p></li><li><p>依赖的三方库，也需升级到与 Spring Boot 3.x 适配的版本以上。可参考 Spring Boot 托管依赖项 <a href=https://docs.spring.io/spring-boot/appendix/dependency-versions/coordinates.html>最新版本的托管依赖项（请注意时效性）</a> 或 <a href=https://docs.spring.io/spring-boot/docs/3.0.x/reference/html/dependency-versions.html#appendix.dependency-versions>Spring Boot 3.0.x 的托管依赖性</a></p></li></ol><p>另有更多的变更，请移步 <a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide>Spring Boot 3.0 Migration Guide</a></p><h3 id=spring-security-变更>Spring Security 变更</h3><p>Spring Security 6.x 版本的变更可参考 <a href=https://docs.spring.io/spring-security/reference/6.0/migration/index.html>Migrating to 6.0</a>。</p><p>因此前已经紧跟版本，我们直接受到的影响，只是移除 <code>antMatcher</code> 改用 <code>securityMatcher</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:purple;font-weight:700>@Bean
</span></span></span><span style=display:flex><span><span style=color:purple;font-weight:700></span>public SecurityFilterChain actuatorSecurityFilterChain(HttpSecurity httpSecurity) throws Exception {
</span></span><span style=display:flex><span>    httpSecurity
</span></span><span style=display:flex><span><span style=color:#a00000>-            .antMatcher(&#34;/actuator/**&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+            .securityMatcher(&#34;/actuator/**&#34;)
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>            .authenticationProvider(new AnonymousAuthenticationProvider(&#34;ANONYMOUS&#34;))
</span></span><span style=display:flex><span>            .authorizeHttpRequests((requests) -&gt; requests.anyRequest().permitAll());
</span></span><span style=display:flex><span>    return httpSecurity.build();
</span></span></code></pre></div><h3 id=jdbc-driver--hikaricp-变更>JDBC Driver & HikariCP 变更</h3><p>由于原生镜像需要静态编译，原 <code>PostgreSQL JDBC Driver</code> 需要由 <code>runtime</code> 改为默认的 <code>compile</code> 依赖。否则因编译期不存在 Drvier，最终原生镜像将不会引入相关代码。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>&lt;dependency&gt;
</span></span><span style=display:flex><span>  &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
</span></span><span style=display:flex><span>  &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
</span></span><span style=display:flex><span><span style=color:#a00000>- &lt;scope&gt;runtime&lt;/scope&gt;
</span></span></span><span style=display:flex><span><span style=color:#a00000></span>&lt;/dependency&gt;
</span></span></code></pre></div><p>同时，虽然公共的元数据仓库提供了关于 HikariCP 的元数据信息，但对于某些动态配置场景，Spring AOT 的静态分析可能无法自动推断出所有必要的反射配置。例如，当使用 DataSourceBuilder 创建数据源时：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#555;font-weight:700>@Bean</span><span style=color:#666>(</span><span style=color:#4070a0>&#34;demoDataSource&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@ConfigurationProperties</span><span style=color:#666>(</span>prefix <span style=color:#666>=</span> <span style=color:#4070a0>&#34;demo.datasource&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span> DataSource <span style=color:#06287e>demoDataSource</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> DataSourceBuilder<span style=color:#666>.</span><span style=color:#4070a0>create</span><span style=color:#666>().</span><span style=color:#4070a0>build</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>在这种情况下，我们需要通过 <code>RuntimeHints</code> 手动注册 <code>HikariConfig</code> 类以进行反射。本示例借助 Spring AOT 的 <code>RuntimeHintsRegistrar</code> 机制，以编程方式精准地添加了所需的元数据：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#555;font-weight:700>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@MapperScan</span><span style=color:#666>(</span>value <span style=color:#666>=</span> <span style=color:#666>{</span><span style=color:#4070a0>&#34;com.ffutop.demo.mapper&#34;</span><span style=color:#666>},</span> sqlSessionFactoryRef <span style=color:#666>=</span> <span style=color:#4070a0>&#34;demoSqlSessionFactory&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@ImportRuntimeHints</span><span style=color:#666>(</span>DataSourceConfiguration<span style=color:#666>.</span><span style=color:#4070a0>DataSourceConfigurationRuntimeHints</span><span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>DataSourceConfiguration</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>DataSourceConfigurationRuntimeHints</span> <span style=color:#007020;font-weight:700>implements</span> RuntimeHintsRegistrar <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>public</span> <span style=color:#902000>void</span> <span style=color:#06287e>registerHints</span><span style=color:#666>(</span>RuntimeHints hints<span style=color:#666>,</span> ClassLoader classLoader<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      hints<span style=color:#666>.</span><span style=color:#4070a0>reflection</span><span style=color:#666>().</span><span style=color:#4070a0>registerType</span><span style=color:#666>(</span>com<span style=color:#666>.</span><span style=color:#4070a0>zaxxer</span><span style=color:#666>.</span><span style=color:#4070a0>hikari</span><span style=color:#666>.</span><span style=color:#4070a0>HikariConfig</span><span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span> MemberCategory<span style=color:#666>.</span><span style=color:#4070a0>values</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h3 id=mybatis-spring-boot-starter-升级>MyBatis Spring Boot Starter 升级</h3><p>MyBatis Spring Boot Starter 需要从 2.x 升级到 3.x，来适应 Spring Boot 的升级。</p><p>但为适应 GraalVM 原生镜像的编译，还需要额外添加 AOT 功能。</p><p><a href=https://github.com/mybatis/spring-native>MyBatis Spring Native</a> 项目旨在提供开箱即用的 AOT 支持，但截至本文撰写时，该项目更新频率较低，尚未发布正式版本。</p><p>幸运的是，MyBatis Spring Boot Starter 官方提供了一份 <a href=https://github.com/mybatis/spring-boot-starter/wiki/Quick-Start-for-building-native-image>Wiki</a>，指导开发者如何手动创建 <code>MyBatisNativeConfiguration</code> 来支持原生编译。不过，官方提供的这份配置代码存在一些已知缺陷，需要进行修正和增强才能确保正常工作。</p><p>如果您的原生应用在启动时遇到以下 <code>LogException</code> 或 <code>NullPointerException</code>，通常意味着 MyBatis 的日志工厂或 Mapper 代理未能正确初始化。请参考文末附录中提供的修正版 <a href=#MyBatisNativeConfiguration.java>MyBatisNativeConfiguration.java</a> 代码来解决此问题。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>Application run failed
</span></span><span style=display:flex><span>java.lang.ExceptionInInitializerError
</span></span><span style=display:flex><span>        at org.mybatis.spring.mapper.MapperScannerConfigurer.postProcessBeanDefinitionRegistry(MapperScannerConfigurer.java:387)
</span></span><span style=display:flex><span>        at org.springframework.context.support.PostProcessorRegistrationDelegate.invokeBeanDefinitionRegistryPostProcessors(PostProcessorRegistrationDelegate.java:349)
</span></span><span style=display:flex><span>        at org.springframework.context.support.PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(PostProcessorRegistrationDelegate.java:148)
</span></span><span style=display:flex><span>        at org.springframework.context.support.AbstractApplicationContext.invokeBeanFactoryPostProcessors(AbstractApplicationContext.java:791)
</span></span><span style=display:flex><span>        at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:609)
</span></span><span style=display:flex><span>        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:146)
</span></span><span style=display:flex><span>        at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:752)
</span></span><span style=display:flex><span>        at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:439)
</span></span><span style=display:flex><span>        at org.springframework.boot.SpringApplication.run(SpringApplication.java:318)
</span></span><span style=display:flex><span>        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1361)
</span></span><span style=display:flex><span>        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1350)
</span></span><span style=display:flex><span>        at com.ffutop.demo.DemoServiceApplication.main(DemoServiceApplication.java:10)
</span></span><span style=display:flex><span>        at java.base@21.0.2/java.lang.invoke.LambdaForm$DMH/sa346b79c.invokeStaticInit(LambdaForm$DMH)
</span></span><span style=display:flex><span>Caused by: org.apache.ibatis.logging.LogException: Error creating logger for logger org.mybatis.spring.mapper.ClassPathMapperScanner.  Cause: java.lang.NullPointerException
</span></span><span style=display:flex><span>        at org.apache.ibatis.logging.LogFactory.getLog(LogFactory.java:56)
</span></span><span style=display:flex><span>        at org.apache.ibatis.logging.LogFactory.getLog(LogFactory.java:49)
</span></span><span style=display:flex><span>        at org.mybatis.logging.LoggerFactory.getLogger(LoggerFactory.java:32)
</span></span><span style=display:flex><span>        at org.mybatis.spring.mapper.ClassPathMapperScanner.&lt;clinit&gt;(ClassPathMapperScanner.java:65)
</span></span><span style=display:flex><span>        ... 13 more
</span></span><span style=display:flex><span>Caused by: java.lang.NullPointerException
</span></span><span style=display:flex><span>        at org.apache.ibatis.logging.LogFactory.getLog(LogFactory.java:54)
</span></span><span style=display:flex><span>        ... 16 more
</span></span></code></pre></div><h3 id=flyway-跨版本升级>Flyway 跨版本升级</h3><table><thead><tr><th>Spring Boot</th><th>Flyway</th></tr></thead><tbody><tr><td>2.7.2</td><td>8.5.13</td></tr><tr><td>3.5.3</td><td>11.7.2</td></tr></tbody></table><p>为与 Spring Boot 3.x 适配，需要将 Flyway 版本升级到 11.7.2 。</p><p>在跨大版本升级过程中，<a href=https://documentation.red-gate.com/fd/release-notes-for-flyway-engine-179732572.html#ReleaseNotesforFlywayEngine-Flyway10.0.0(2023-10-31)>Flyway 10</a> 引入了一个重大不兼容变更——将数据库支持模块化，移出了 Flyway 核心库。</p><blockquote><p>Modularized database support in Flyway to allow greater flexibility. This includes; DB2, Derby, HSQLDB, Informix, PostgreSQL, CockroachDB, Redshift, SAP HANA, Snowflake and Sybase ASE. See Database Support page for your database for module dependency. If you are including Flyway in your project, either as a dependency or via the maven and gradle plugins please include the respective database module in your project configuration.</p></blockquote><p>因此需要额外增加一个依赖（我们使用的 postgresql，其他数据库类似）</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#062873;font-weight:700>&lt;groupId&gt;</span>org.flywaydb<span style=color:#062873;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#062873;font-weight:700>&lt;artifactId&gt;</span>flyway-database-postgresql<span style=color:#062873;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>如果未声明该依赖，你将收获如下错误：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>Caused by: org.flywaydb.core.api.FlywayException: Unsupported Database: PostgreSQL 15.7
</span></span><span style=display:flex><span>  at org.flywaydb.core.internal.database.DatabaseTypeRegister.lambda$getDatabaseTypeForConnection$7(DatabaseTypeRegister.java:134)
</span></span><span style=display:flex><span>  at java.base/java.util.Optional.orElseThrow(Optional.java:403)
</span></span><span style=display:flex><span>  // ... something omitted ...
</span></span></code></pre></div><h2 id=构建测试与运行>构建、测试与运行</h2><h3 id=原生编译>原生编译</h3><p>在迁移过程中，我们已经将 <code>spring-boot:process-aot</code>, <code>native:add-reachability-metadata</code>, <code>native:compile-no-fork</code> 等插件添加到了项目中。直接在命令行执行 <code>mvn -Pnative package</code> 或借助 IDE 在启用 <code>native</code> Profile 的情况下执行 package 阶段即可完成编译。</p><p>这里推荐借助 <code>native</code> Profile 来区别是否进行原生编译，在禁用 <code>native</code> Profile 的情况下执行 package 阶段，可以很方便地得到传统的 JAR 包。</p><p>编译过程的八个阶段可以参考 <a href=https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/>Native Image Build Output</a>。由于是原生编译，整个过程相较于传统 JAR 构建，会花费非常长的额外的时间，一般以分钟记。对于较大的工程，甚至可能需要十几分钟的编译过程。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>GraalVM Native Image: Generating &#39;demo-service&#39; (executable)...
</span></span><span style=display:flex><span>========================================================================================================================
</span></span><span style=display:flex><span>[1/8] Initializing...                                                                                    (8.6s @ 0.23GB)
</span></span><span style=display:flex><span> Java version: 21.0.2+13, vendor version: GraalVM CE 21.0.2+13.1
</span></span><span style=display:flex><span> Graal compiler: optimization level: 2, target machine: x86-64-v3
</span></span><span style=display:flex><span> C compiler: cc (apple, x86_64, 17.0.0)
</span></span><span style=display:flex><span> Garbage collector: Serial GC (max heap size: 80% of RAM)
</span></span><span style=display:flex><span> 2 user-specific feature(s):
</span></span><span style=display:flex><span> - com.oracle.svm.thirdparty.gson.GsonFeature
</span></span><span style=display:flex><span> - org.springframework.aot.nativex.feature.PreComputeFieldFeature
</span></span><span style=display:flex><span>------------------------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Build resources:
</span></span><span style=display:flex><span> - 12.09GB of memory (75.6% of 16.00GB system memory, determined at start)
</span></span><span style=display:flex><span> - 16 thread(s) (100.0% of 16 available processor(s), determined at start)
</span></span><span style=display:flex><span>SLF4J(W): No SLF4J providers were found.
</span></span><span style=display:flex><span>SLF4J(W): Defaulting to no-operation (NOP) logger implementation
</span></span><span style=display:flex><span>SLF4J(W): See https://www.slf4j.org/codes.html#noProviders for further details.
</span></span><span style=display:flex><span>[2/8] Performing analysis...  [******]                                                                  (47.9s @ 3.05GB)
</span></span><span style=display:flex><span>   22,523 reachable types   (89.5% of   25,178 total)
</span></span><span style=display:flex><span>   33,912 reachable fields  (63.2% of   53,645 total)
</span></span><span style=display:flex><span>  106,067 reachable methods (61.9% of  171,328 total)
</span></span><span style=display:flex><span>    7,129 types, 1,403 fields, and 10,435 methods registered for reflection
</span></span><span style=display:flex><span>       67 types,    67 fields, and    58 methods registered for JNI access
</span></span><span style=display:flex><span>        5 native libraries: -framework CoreServices, -framework Foundation, dl, pthread, z
</span></span><span style=display:flex><span>[3/8] Building universe...                                                                               (7.5s @ 2.25GB)
</span></span><span style=display:flex><span>[4/8] Parsing methods...      [**]                                                                       (4.4s @ 3.13GB)
</span></span><span style=display:flex><span>[5/8] Inlining methods...     [***]                                                                      (2.6s @ 2.70GB)
</span></span><span style=display:flex><span>[6/8] Compiling methods...    [******]                                                                  (40.3s @ 3.66GB)
</span></span><span style=display:flex><span>[7/8] Layouting methods...    [***]                                                                      (8.7s @ 2.36GB)
</span></span><span style=display:flex><span>[8/8] Creating image...       [***]                                                                      (9.7s @ 3.66GB)
</span></span><span style=display:flex><span>  51.55MB (51.34%) for code area:    69,320 compilation units
</span></span><span style=display:flex><span>  48.47MB (48.28%) for image heap:  489,517 objects and 395 resources
</span></span><span style=display:flex><span> 391.84kB ( 0.38%) for other data
</span></span><span style=display:flex><span> 100.40MB in total
</span></span><span style=display:flex><span>------------------------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>                      13.5s (10.2% of total time) in 123 GCs | Peak RSS: 6.38GB | CPU load: 10.22
</span></span></code></pre></div><h3 id=原生测试>原生测试</h3><p>由于原生镜像是基于“封闭世界”假设进行静态编译的，这与动态的 JVM 环境有本质区别。因此，仅在 JVM 上通过所有测试，并不足以完全保证应用在原生环境中的行为正确性。</p><p>原生测试 (Native Test) 是将测试代码与应用代码共同编译成一个临时的原生可执行文件并运行它。这是验证应用原生兼容性、确保迁移质量的关键步骤。</p><p><strong>使用追踪代理生成元数据</strong></p><p>在正式进行原生测试编译前，强烈建议先在 JVM 环境下，利用 GraalVM 提供的追踪代理 (Tracing Agent) 来运行您所有的单元测试和集成测试。</p><p>这个代理能自动捕获测试过程中发生的所有反射、JNI、资源加载等动态调用，并生成相应的可达性元数据（JSON 配置文件）。这是发现并补充缺失的 <code>RuntimeHints</code> 的最高效方法，特别是对于那些仅在测试代码中被覆盖的逻辑路径。</p><p>操作命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># -Dagent 会激活追踪代理，并自动捕获动态调用</span>
</span></span><span style=display:flex><span>mvn -Pnative <span style=color:#007020>test</span> -Dagent
</span></span></code></pre></div><p>代理会将生成的元数据文件输出到 <code>target/native/agent-output/</code> 目录。您应仔细审查这些文件，并将其合并到 <code>src/main/resources/META-INF/native-image/</code> 目录下，以便在最终的原生编译中生效。</p><p><strong>执行原生测试</strong></p><p>当元数据准备就绪后，就可以执行真正的原生测试了。<code>native-maven-plugin</code> 插件已将原生测试的执行默认绑定到了 Maven 的 <code>test</code> 生命周期中。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 激活 nativeTest profile 并执行 test 生命周期</span>
</span></span><span style=display:flex><span>mvn -PnativeTest <span style=color:#007020>test</span>
</span></span></code></pre></div><p>此命令会触发一个完整的原生编译流程，但其目标不是生成应用可执行文件，而是生成并运行一个测试可执行文件。如果所有测试都通过，意味着应用的核心功能在原生环境中行为符合预期。如果失败，则需要根据错误信息（通常是 <code>MissingReflectionException</code> 等）回头补充 <code>RuntimeHints</code> 或检查代码兼容性。</p><h3 id=原生运行>原生运行</h3><p>原生编译成功后，会在 <code>target</code> 目录下找到一个与项目名和操作系统相匹配的可执行文件（例如，在 Linux/macOS 上名为 <code>demo-service</code>）。</p><p><strong>直接运行</strong></p><p>与传统的 <code>java -jar</code> 命令不同，可以直接在命令行中执行这个文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./target/demo-service
</span></span></code></pre></div><p>可以观察到最直观的变化就是启动速度。应用几乎在瞬间就完成了启动并准备好接收请求，这与 JVM 应用需要数秒甚至更长时间的预热过程形成了鲜明对比。</p><p><strong>容器化部署</strong></p><p>原生可执行文件的另一大优势是其极小的体积和自包含的特性，这使其成为容器化部署的理想选择。由于不再需要外部的 JRE/JDK，我们可以使用极度精简的基础镜像。</p><p><em>注意：由于原生编译，跨平台、跨 CPU 架构将不被接受，请确保编译平台与运行平台的一致性</em></p><p>以下是一个简单的 <code>Dockerfile</code> 示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 使用一个极度精简的基础镜像</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#007020;font-weight:700>FROM</span><span style=color:#4070a0> alpine:latest</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#60a0b0;font-style:italic># 将原生可执行文件复制到镜像中</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#007020;font-weight:700>COPY</span> target/demo-service /demo-service<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#60a0b0;font-style:italic># 定义容器启动命令</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#007020;font-weight:700>ENTRYPOINT</span> [<span style=color:#4070a0>&#34;/demo-service&#34;</span>]<span>
</span></span></span></code></pre></div><p>使用此 <code>Dockerfile</code> 构建的容器镜像，其体积通常只有几十到一百多兆字节，远小于包含完整 JRE 的传统镜像（通常为数百兆字节）。这不仅节省了存储资源，还显著加快了镜像的推送、拉取和部署速度，完美契合了云原生对敏捷和高效的要求。</p><h2 id=常见陷阱与经验总结>常见陷阱与经验总结</h2><h3 id=第三方库兼容性>第三方库兼容性</h3><p>GraalVM 原生编译的核心是“封闭世界”假设，即在编译时必须知晓所有可执行的代码。然而，许多 Java 库广泛使用反射、动态代理、资源加载等动态特性，这与静态分析的原则直接冲突。因此，确保第三方库的兼容性是迁移过程中最关键也最具挑战性的一环。</p><p>解决此问题的策略可分为三个层次，应按以下优先级顺序尝试：</p><ol><li><p>优先选用原生就绪的框架与库</p><p>现代框架如 Spring Boot 3+、Quarkus 和 Micronaut 已经将原生编译作为核心特性。它们不仅自身完全兼容，还为生态内的大量常用库（如 Jackson, Netty, Tomcat）提供了预置的 AOT (Ahead-of-Time) 配置和 <code>RuntimeHints</code>。选择这类框架是通往原生编译最平坦的道路，因为框架已经替开发者解决了绝大部分兼容性问题。</p></li><li><p>利用 GraalVM 可达性元数据仓库</p><p>对于许多尚未完全原生就绪但广受欢迎的库，GraalVM 社区维护了一个可达性元数据仓库。<code>native-maven-plugin</code> 构建插件可以被配置为自动从该仓库拉取所需依赖的元数据。</p><p>这意味着，即使一个库（例如，某个版本的 <code>google-gson</code>）的作者没有提供官方原生支持，只要社区为其贡献了元数据，它也能在你的项目中“开箱即用”。在 <code>pom.xml</code> 中启用此功能是强烈推荐的最佳实践：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;groupId&gt;</span>org.graalvm.buildtools<span style=color:#062873;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;artifactId&gt;</span>native-maven-plugin<span style=color:#062873;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;id&gt;</span>add-reachability-metadata<span style=color:#062873;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#062873;font-weight:700>&lt;goal&gt;</span>add-reachability-metadata<span style=color:#062873;font-weight:700>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;/plugin&gt;</span>
</span></span></code></pre></div></li><li><p>手动提供元数据</p><p>当一个库既非原生就绪，也无社区提供的元数据时，就需要我们手动介入。</p><ul><li><p>使用追踪代理 (Tracing Agent)：这是首选的半自动方法。通过在 JVM 模式下运行应用的测试（<code>mvn -Pnative test -Dagent</code>），GraalVM 的追踪代理能自动捕获大部分动态调用，并生成所需的元数据 JSON 文件。这是发现和补充缺失配置最高效的方式。当然，这也要求应用的测试用例覆盖度高，以确保追踪到的调用都是必要的。</p></li><li><p>编写 <code>RuntimeHints</code>：对于追踪代理无法覆盖的复杂场景，或为了更精细的控制，可以利用 Spring 的 <code>RuntimeHintsRegistrar</code> API 以编程方式注册元数据。这在本文的 HikariCP 和 MyBatis 适配部分已有体现。</p></li><li><p>直接编写 JSON 配置文件：作为最终手段，可以直接在 <code>src/main/resources/META-INF/native-image/</code> 目录下手动编写 <code>reflect-config.json</code> 等文件。这种方式最为灵活，但也最繁琐且易错。</p></li></ul></li></ol><p>总结而言，处理第三方库兼容性的正确路径是：框架适配 > 社区元数据 > 手动配置。盲目地为每个库手动编写 <code>RuntimeHints</code> 是低效的。应首先充分利用框架和社区生态的力量，仅在必要时才进行手动干预。</p><h3 id=原生镜像的调试>原生镜像的调试</h3><p>转向原生镜像意味着告别了整个基于 JVMTI 和 JMX 的传统诊断工具生态（如 JProfiler, VisualVM, jstack）。这并非技术缺陷，而是架构选择的必然结果。开发者必须从依赖 JVM 提供的“全能管家”模式，转向拥抱原生工具链和自包含的可观测性体系。</p><p><strong>可观测性</strong></p><p>对于生产环境中的问题，依赖可观测性的“三大支柱”是非常推荐的方法。</p><ul><li>日志 (Logging)：这是最基础的诊断手段。确保 Logback、Log4j2 等日志框架及其配置文件（如 <code>logback-spring.xml</code>）被正确地包含在可达性元数据中，是保证日志在原生环境中正常工作的前提。</li><li>指标 (Metrics)：通过集成 Micrometer，原生应用可以像任何云原生服务一样，向 Prometheus 等监控系统暴露关键性能指标。Actuator 端点在原生环境中同样有效。</li><li>分布式追踪 (Distributed Tracing)：在微服务架构下，使用 OpenTelemetry 等标准，可以追踪一个请求在多个原生服务间的完整调用链路。</li></ul><p><strong>交互式调试 (GDB/LLDB)</strong></p><p>对于开发阶段的逻辑错误，可以使用 GDB (Linux) 或 LLDB (macOS) 等原生调试器进行交互式调试。</p><p>首先，需要让 <code>native-image</code> 在编译时包含调试信息。在 <code>pom.xml</code> 的 <code>native-maven-plugin</code> 配置中加入 <code>-g</code> 参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;groupId&gt;</span>org.graalvm.buildtools<span style=color:#062873;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;artifactId&gt;</span>native-maven-plugin<span style=color:#062873;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;buildArgs&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#062873;font-weight:700>&lt;buildArg&gt;</span>-g<span style=color:#062873;font-weight:700>&lt;/buildArg&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#062873;font-weight:700>&lt;/buildArgs&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#062873;font-weight:700>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#062873;font-weight:700>&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>然后重新编译原生可执行文件。</p><p><strong>启动调试会话</strong></p><p>使用 GDB 启动调试：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gdb ./target/demo-service
</span></span></code></pre></div><p>进入 GDB 后，可以使用标准命令：</p><ul><li><code>b com.ffutop.demo.service.MyService.myMethod</code>: 在指定方法设置断点。</li><li><code>r</code>: 运行程序。</li><li><code>p myVariable</code>: 打印变量值。</li><li><code>bt</code>: 查看当前线程的堆栈回溯 (Backtrace)。</li><li><code>c</code>: 继续执行直到下一个断点。</li></ul><p>虽然不如 IDE 中的 Java 调试器直观，但这为定位原生代码中的复杂逻辑问题提供了最直接的手段。</p><h3 id=构建时间显著增加>构建时间显著增加</h3><p>从传统的 <code>mvn package</code> 到 <code>mvn -Pnative package</code>，最直观的感受之一就是构建时间的急剧增加。传统打包通常在数十秒内完成，而原生编译则可能需要数分钟甚至更长时间。这并非缺陷，而是将大量运行时工作（如类加载、JIT 编译、初始化）前置到构建时所付出的必要代价。理解其原因并制定合理的 CI/CD 策略至关重要。</p><p><strong>原生编译耗时增加的根本原因</strong></p><p>AOT 编译的耗时主要源于其深度和广度远超传统构建的三个核心阶段：</p><ol><li>全程序静态分析：<code>native-image</code> 工具必须遍历整个应用及其所有依赖的每一条可能执行路径，以确定哪些代码是“可达”的。这是一个计算密集型的大规模图遍历过程。</li><li>重量级优化与编译：所有可达的 Java 字节码都需要被编译成高度优化的本地机器码，这个过程远比简单的字节码生成复杂。</li><li>镜像堆生成：执行所有标记为“构建时初始化”的类的静态代码块，并将其内存状态快照固化到可执行文件中，也是一个耗时步骤。</li></ol><p><strong>CI/CD 应对策略</strong></p><p>在持续集成和部署（CI/CD）流水线中，必须采取有效策略来管理这部分额外的构建开销，以避免拖慢开发迭代的节奏。</p><ol><li><p>策略一：分阶段构建，实现快速反馈与深度验证的平衡</p><p>将构建流程拆分为不同阶段，为开发者保留快速反馈环路，同时确保原生兼容性得到验证。</p><ul><li><p>开发与提交阶段 (JVM 模式快速验证)：在每次代码提交或合并请求时，CI 流水线应仅运行标准的 JVM 测试 (<code>mvn test</code>)。此阶段的目标是快速发现业务逻辑、单元测试或基础集成中的错误，通常能在几分钟内为开发者提供反馈，保障开发效率。</p></li><li><p>集成与发布阶段 (原生模式深度验证)：将资源密集型的原生编译 (<code>mvn -Pnative package</code>) 和原生测试 (<code>mvn -PnativeTest test</code>) 推迟到更晚的阶段。例如，在代码成功合并到主开发分支 (<code>main</code>/<code>develop</code>) 或创建发布候选 (<code>release</code>) 时才触发。这一阶段负责验证应用在原生环境下的行为正确性，是确保最终产物质量的关键步骤。</p></li></ul></li><li><p>策略二：增强构建环境并支持多架构编译</p><p>原生编译对计算资源有较高要求，且其产物具有平台特异性，CI/CD 环境需相应适配。</p><ul><li><p>提升构建节点性能：为原生编译任务分配更强大的执行器 (Runner/Agent)。推荐使用至少 <strong>8 核 CPU 和 16GB 以上内存</strong>的构建环境。增加资源可以显著缩短编译时间，是应对构建耗时增加最直接有效的方法。</p></li><li><p>配置多架构构建：原生可执行文件与编译时所在的操作系统及 CPU 架构（如 <code>amd64</code>, <code>arm64</code>）紧密绑定，不支持跨平台运行。因此，如需在多种架构的环境中部署（例如，同时部署在 x86 服务器和 ARM 架构的云实例上），CI/CD 流水线必须为每种目标架构配置独立的构建任务。这意味着您需要在不同架构的构建节点上分别执行 <code>mvn -Pnative package</code>。</p></li></ul></li></ol><h2 id=成果量化对比>成果量化对比</h2><p>为了直观地展示迁移带来的收益与损耗，我们对同一个基础的 CRUD Web 应用在迁移前后的关键指标进行了对比。</p><center><table><thead><tr><th style=text-align:left>指标</th><th style=text-align:left>Spring Boot 2.7.2 on JVM (Java 8)</th><th style=text-align:left>Spring Boot 3.x Native (GraalVM 21)</th><th style=text-align:left>提升幅度</th></tr></thead><tbody><tr><td style=text-align:left>应用启动时间 (ms)</td><td style=text-align:left>2,474</td><td style=text-align:left>268</td><td style=text-align:left>~89%</td></tr><tr><td style=text-align:left>应用空闲内存占用 (MB)</td><td style=text-align:left>~204</td><td style=text-align:left>~105</td><td style=text-align:left>~48%</td></tr><tr><td style=text-align:left>容器镜像大小 (MB)</td><td style=text-align:left>~300 (alpine with JRE)</td><td style=text-align:left>~100 (from alpine)</td><td style=text-align:left>~67%</td></tr><tr><td style=text-align:left>构建时间 (min)</td><td style=text-align:left>0.09</td><td style=text-align:left>2.5</td><td style=text-align:left>~28x</td></tr></tbody></table></center><p><em>（注：以上数据为示例应用迁移前后的对比结果，仅供参考）</em></p><h2 id=结论与展望>结论与展望</h2><p>从 Spring Boot 2.7 迁移到 3.x 并拥抱原生编译，无疑是一项成本高昂、收益显著的技术投资，尤其对于追求极致启动性能和资源效率的云原生应用而言。本次迁移实践清晰地展示了原生镜像在启动时间、内存占用和部署体积上的巨大优势。然而，这一过程也要求开发者进行一次深刻的思维范式转变：从依赖 JVM 灵活的“运行时动态”，转向拥抱“编译期静态”的确定性世界。</p><p><strong>权衡与适用场景</strong></p><p>原生镜像并非解决所有问题的银弹。它最适合微服务、Serverless 函数、CLI 工具等对快速启动和低资源占用有严苛要求的场景。在这些领域，原生化带来的优势是决定性的。</p><p>然而，对于那些深度依赖运行时动态类加载、代码生成或复杂反射的大型单体应用，迁移成本和复杂性可能会急剧增加，需要谨慎评估投入产出比。此外，性能权衡也值得注意：虽然原生镜像提供了无与伦比的启动性能，但对于需要长时间运行且对峰值吞吐量要求极高的计算密集型应用，一个经过充分预热和动态剖析优化的 JIT 编译器可能在长时间运行后达到更高的峰值性能。</p><p><strong>展望与审慎评估</strong></p><p>尽管前景广阔，但我们必须清醒地认识到，Java 原生编译技术生态仍在快速演进中，尚未完全成熟。迁移过程中遇到的第三方库兼容性挑战、显著增加的构建时间、以及与传统 JVM 截然不同的调试与诊断范式，都表明这片领域仍在开拓阶段。</p><p>对于许多团队和项目而言，虽然原生化是未来的方向，但在当前阶段，是否立即在核心生产环境中大规模采用，可能需要更为审慎的评估。这不仅是对技术收益的考量，也是对团队驾驭新兴技术、解决未知问题能力的考验。持续关注 Spring、GraalVM 及社区的进展，逐步在非核心或新项目中进行试点，或许是更为稳妥的策略。</p><h2 id=附录>附录</h2><h3 id=mybatisnativeconfigurationjava>MyBatisNativeConfiguration.java</h3><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.commons.logging.LogFactory</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.annotations.DeleteProvider</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.annotations.InsertProvider</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.annotations.SelectProvider</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.annotations.UpdateProvider</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.cache.decorators.FifoCache</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.cache.decorators.LruCache</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.cache.decorators.SoftCache</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.cache.decorators.WeakCache</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.cache.impl.PerpetualCache</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.javassist.util.proxy.ProxyFactory</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.javassist.util.proxy.RuntimeSupport</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.logging.Log</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.logging.commons.JakartaCommonsLoggingImpl</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.logging.log4j2.Log4j2Impl</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.logging.nologging.NoLoggingImpl</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.logging.slf4j.Slf4jImpl</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.logging.stdout.StdOutImpl</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.reflection.TypeParameterResolver</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.scripting.defaults.RawLanguageDriver</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.scripting.xmltags.XMLLanguageDriver</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.apache.ibatis.session.SqlSessionFactory</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.mybatis.spring.SqlSessionFactoryBean</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.mybatis.spring.mapper.MapperFactoryBean</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.mybatis.spring.mapper.MapperScannerConfigurer</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.aot.hint.MemberCategory</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.aot.hint.RuntimeHints</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.aot.hint.RuntimeHintsRegistrar</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.PropertyValue</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.BeanFactory</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.BeanFactoryAware</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.aot.BeanFactoryInitializationAotContribution</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.aot.BeanFactoryInitializationAotProcessor</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.aot.BeanRegistrationExcludeFilter</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.config.BeanDefinition</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.config.ConfigurableBeanFactory</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.config.ConfigurableListableBeanFactory</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.config.ConstructorArgumentValues</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.support.MergedBeanDefinitionPostProcessor</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.support.RegisteredBean</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.beans.factory.support.RootBeanDefinition</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.context.annotation.Bean</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.context.annotation.Configuration</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.context.annotation.ImportRuntimeHints</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.core.ResolvableType</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.util.ClassUtils</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>org.springframework.util.ReflectionUtils</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.lang.annotation.Annotation</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.lang.reflect.Method</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.lang.reflect.ParameterizedType</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.lang.reflect.Type</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.util.*</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.util.function.Function</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.util.stream.Collectors</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>java.util.stream.Stream</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@Configuration</span><span style=color:#666>(</span>proxyBeanMethods <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>false</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@ImportRuntimeHints</span><span style=color:#666>(</span>MyBatisNativeConfiguration<span style=color:#666>.</span><span style=color:#4070a0>MyBaitsRuntimeHintsRegistrar</span><span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>MyBatisNativeConfiguration</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#555;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    MyBatisBeanFactoryInitializationAotProcessor <span style=color:#06287e>myBatisBeanFactoryInitializationAotProcessor</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>new</span> MyBatisBeanFactoryInitializationAotProcessor<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> MyBatisMapperFactoryBeanPostProcessor <span style=color:#06287e>myBatisMapperFactoryBeanPostProcessor</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>new</span> MyBatisMapperFactoryBeanPostProcessor<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>MyBaitsRuntimeHintsRegistrar</span> <span style=color:#007020;font-weight:700>implements</span> RuntimeHintsRegistrar <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#555;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>public</span> <span style=color:#902000>void</span> <span style=color:#06287e>registerHints</span><span style=color:#666>(</span>RuntimeHints hints<span style=color:#666>,</span> ClassLoader classLoader<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            Stream<span style=color:#666>.</span><span style=color:#4070a0>of</span><span style=color:#666>(</span>RawLanguageDriver<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    XMLLanguageDriver<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    RuntimeSupport<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    ProxyFactory<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    Slf4jImpl<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    Log<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    JakartaCommonsLoggingImpl<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    Log4j2Impl<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    Jdk14LoggingImpl<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    StdOutImpl<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    NoLoggingImpl<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    SqlSessionFactory<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    PerpetualCache<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    FifoCache<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    LruCache<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    SoftCache<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    WeakCache<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    SqlSessionFactoryBean<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    ArrayList<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    HashMap<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    TreeSet<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    HashSet<span style=color:#666>.</span><span style=color:#4070a0>class</span>
</span></span><span style=display:flex><span>            <span style=color:#666>).</span><span style=color:#4070a0>forEach</span><span style=color:#666>(</span>x <span style=color:#666>-&gt;</span> hints<span style=color:#666>.</span><span style=color:#4070a0>reflection</span><span style=color:#666>().</span><span style=color:#4070a0>registerType</span><span style=color:#666>(</span>x<span style=color:#666>,</span> MemberCategory<span style=color:#666>.</span><span style=color:#4070a0>values</span><span style=color:#666>()));</span>
</span></span><span style=display:flex><span>            Stream<span style=color:#666>.</span><span style=color:#4070a0>of</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#4070a0>&#34;org/apache/ibatis/builder/xml/*.dtd&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#4070a0>&#34;org/apache/ibatis/builder/xml/*.xsd&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>).</span><span style=color:#4070a0>forEach</span><span style=color:#666>(</span>hints<span style=color:#666>.</span><span style=color:#4070a0>resources</span><span style=color:#666>()::</span>registerPattern<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>MyBatisBeanFactoryInitializationAotProcessor</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>implements</span> BeanFactoryInitializationAotProcessor<span style=color:#666>,</span> BeanRegistrationExcludeFilter <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#007020;font-weight:700>final</span> Set<span style=color:#666>&lt;</span>Class<span style=color:#666>&lt;?&gt;&gt;</span> excludeClasses <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> HashSet<span style=color:#666>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        MyBatisBeanFactoryInitializationAotProcessor<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            excludeClasses<span style=color:#666>.</span><span style=color:#4070a0>add</span><span style=color:#666>(</span>MapperScannerConfigurer<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#555;font-weight:700>@Override</span> <span style=color:#007020;font-weight:700>public</span> <span style=color:#902000>boolean</span> <span style=color:#06287e>isExcludedFromAotProcessing</span><span style=color:#666>(</span>RegisteredBean registeredBean<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> excludeClasses<span style=color:#666>.</span><span style=color:#4070a0>contains</span><span style=color:#666>(</span>registeredBean<span style=color:#666>.</span><span style=color:#4070a0>getBeanClass</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#555;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>public</span> BeanFactoryInitializationAotContribution <span style=color:#06287e>processAheadOfTime</span><span style=color:#666>(</span>ConfigurableListableBeanFactory beanFactory<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            String<span style=color:#666>[]</span> beanNames <span style=color:#666>=</span> beanFactory<span style=color:#666>.</span><span style=color:#4070a0>getBeanNamesForType</span><span style=color:#666>(</span>MapperFactoryBean<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>beanNames<span style=color:#666>.</span><span style=color:#4070a0>length</span> <span style=color:#666>==</span> <span style=color:#40a070>0</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> <span style=color:#666>(</span>context<span style=color:#666>,</span> code<span style=color:#666>)</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                RuntimeHints hints <span style=color:#666>=</span> context<span style=color:#666>.</span><span style=color:#4070a0>getRuntimeHints</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>for</span> <span style=color:#666>(</span>String beanName <span style=color:#666>:</span> beanNames<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    BeanDefinition beanDefinition <span style=color:#666>=</span> beanFactory<span style=color:#666>.</span><span style=color:#4070a0>getBeanDefinition</span><span style=color:#666>(</span>beanName<span style=color:#666>.</span><span style=color:#4070a0>substring</span><span style=color:#666>(</span><span style=color:#40a070>1</span><span style=color:#666>));</span>
</span></span><span style=display:flex><span>                    PropertyValue mapperInterface <span style=color:#666>=</span> beanDefinition<span style=color:#666>.</span><span style=color:#4070a0>getPropertyValues</span><span style=color:#666>().</span><span style=color:#4070a0>getPropertyValue</span><span style=color:#666>(</span><span style=color:#4070a0>&#34;mapperInterface&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>mapperInterface <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> mapperInterface<span style=color:#666>.</span><span style=color:#4070a0>getValue</span><span style=color:#666>()</span> <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                        Class<span style=color:#666>&lt;?&gt;</span> mapperInterfaceType <span style=color:#666>=</span> <span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;)</span> mapperInterface<span style=color:#666>.</span><span style=color:#4070a0>getValue</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>mapperInterfaceType <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                            registerReflectionTypeIfNecessary<span style=color:#666>(</span>mapperInterfaceType<span style=color:#666>,</span> hints<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            hints<span style=color:#666>.</span><span style=color:#4070a0>proxies</span><span style=color:#666>().</span><span style=color:#4070a0>registerJdkProxy</span><span style=color:#666>(</span>mapperInterfaceType<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            hints<span style=color:#666>.</span><span style=color:#4070a0>resources</span><span style=color:#666>()</span>
</span></span><span style=display:flex><span>                                    <span style=color:#666>.</span><span style=color:#4070a0>registerPattern</span><span style=color:#666>(</span>mapperInterfaceType<span style=color:#666>.</span><span style=color:#4070a0>getName</span><span style=color:#666>().</span><span style=color:#4070a0>replace</span><span style=color:#666>(</span><span style=color:#4070a0>&#39;.&#39;</span><span style=color:#666>,</span> <span style=color:#4070a0>&#39;/&#39;</span><span style=color:#666>).</span><span style=color:#4070a0>concat</span><span style=color:#666>(</span><span style=color:#4070a0>&#34;.xml&#34;</span><span style=color:#666>));</span>
</span></span><span style=display:flex><span>                            registerMapperRelationships<span style=color:#666>(</span>mapperInterfaceType<span style=color:#666>,</span> hints<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>};</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#902000>void</span> <span style=color:#06287e>registerMapperRelationships</span><span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;</span> mapperInterfaceType<span style=color:#666>,</span> RuntimeHints hints<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            Method<span style=color:#666>[]</span> methods <span style=color:#666>=</span> ReflectionUtils<span style=color:#666>.</span><span style=color:#4070a0>getAllDeclaredMethods</span><span style=color:#666>(</span>mapperInterfaceType<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>for</span> <span style=color:#666>(</span>Method method <span style=color:#666>:</span> methods<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>method<span style=color:#666>.</span><span style=color:#4070a0>getDeclaringClass</span><span style=color:#666>()</span> <span style=color:#666>!=</span> Object<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    ReflectionUtils<span style=color:#666>.</span><span style=color:#4070a0>makeAccessible</span><span style=color:#666>(</span>method<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    registerSqlProviderTypes<span style=color:#666>(</span>method<span style=color:#666>,</span> hints<span style=color:#666>,</span> SelectProvider<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span> SelectProvider<span style=color:#666>::</span>value<span style=color:#666>,</span> SelectProvider<span style=color:#666>::</span>type<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    registerSqlProviderTypes<span style=color:#666>(</span>method<span style=color:#666>,</span> hints<span style=color:#666>,</span> InsertProvider<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span> InsertProvider<span style=color:#666>::</span>value<span style=color:#666>,</span> InsertProvider<span style=color:#666>::</span>type<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    registerSqlProviderTypes<span style=color:#666>(</span>method<span style=color:#666>,</span> hints<span style=color:#666>,</span> UpdateProvider<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span> UpdateProvider<span style=color:#666>::</span>value<span style=color:#666>,</span> UpdateProvider<span style=color:#666>::</span>type<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    registerSqlProviderTypes<span style=color:#666>(</span>method<span style=color:#666>,</span> hints<span style=color:#666>,</span> DeleteProvider<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>,</span> DeleteProvider<span style=color:#666>::</span>value<span style=color:#666>,</span> DeleteProvider<span style=color:#666>::</span>type<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    Class<span style=color:#666>&lt;?&gt;</span> returnType <span style=color:#666>=</span> MyBatisMapperTypeUtils<span style=color:#666>.</span><span style=color:#4070a0>resolveReturnClass</span><span style=color:#666>(</span>mapperInterfaceType<span style=color:#666>,</span> method<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    registerReflectionTypeIfNecessary<span style=color:#666>(</span>returnType<span style=color:#666>,</span> hints<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    MyBatisMapperTypeUtils<span style=color:#666>.</span><span style=color:#4070a0>resolveParameterClasses</span><span style=color:#666>(</span>mapperInterfaceType<span style=color:#666>,</span> method<span style=color:#666>)</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>.</span><span style=color:#4070a0>forEach</span><span style=color:#666>(</span>x <span style=color:#666>-&gt;</span> registerReflectionTypeIfNecessary<span style=color:#666>(</span>x<span style=color:#666>,</span> hints<span style=color:#666>));</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#555;font-weight:700>@SafeVarargs</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#666>&lt;</span>T <span style=color:#007020;font-weight:700>extends</span> Annotation<span style=color:#666>&gt;</span> <span style=color:#902000>void</span> <span style=color:#06287e>registerSqlProviderTypes</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>                Method method<span style=color:#666>,</span> RuntimeHints hints<span style=color:#666>,</span> Class<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span> annotationType<span style=color:#666>,</span> Function<span style=color:#666>&lt;</span>T<span style=color:#666>,</span> Class<span style=color:#666>&lt;?&gt;&gt;...</span> providerTypeResolvers<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>for</span> <span style=color:#666>(</span>T annotation <span style=color:#666>:</span> method<span style=color:#666>.</span><span style=color:#4070a0>getAnnotationsByType</span><span style=color:#666>(</span>annotationType<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>for</span> <span style=color:#666>(</span>Function<span style=color:#666>&lt;</span>T<span style=color:#666>,</span> Class<span style=color:#666>&lt;?&gt;&gt;</span> providerTypeResolver <span style=color:#666>:</span> providerTypeResolvers<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    registerReflectionTypeIfNecessary<span style=color:#666>(</span>providerTypeResolver<span style=color:#666>.</span><span style=color:#4070a0>apply</span><span style=color:#666>(</span>annotation<span style=color:#666>),</span> hints<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#902000>void</span> <span style=color:#06287e>registerReflectionTypeIfNecessary</span><span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;</span> type<span style=color:#666>,</span> RuntimeHints hints<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(!</span>type<span style=color:#666>.</span><span style=color:#4070a0>isPrimitive</span><span style=color:#666>()</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#666>!</span>type<span style=color:#666>.</span><span style=color:#4070a0>getName</span><span style=color:#666>().</span><span style=color:#4070a0>startsWith</span><span style=color:#666>(</span><span style=color:#4070a0>&#34;java&#34;</span><span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                hints<span style=color:#666>.</span><span style=color:#4070a0>reflection</span><span style=color:#666>().</span><span style=color:#4070a0>registerType</span><span style=color:#666>(</span>type<span style=color:#666>,</span> MemberCategory<span style=color:#666>.</span><span style=color:#4070a0>values</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>MyBatisMapperTypeUtils</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#06287e>MyBatisMapperTypeUtils</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#60a0b0;font-style:italic>// NOP
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>static</span> Class<span style=color:#666>&lt;?&gt;</span> resolveReturnClass<span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;</span> mapperInterface<span style=color:#666>,</span> Method method<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            Type resolvedReturnType <span style=color:#666>=</span> TypeParameterResolver<span style=color:#666>.</span><span style=color:#4070a0>resolveReturnType</span><span style=color:#666>(</span>method<span style=color:#666>,</span> mapperInterface<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> typeToClass<span style=color:#666>(</span>resolvedReturnType<span style=color:#666>,</span> method<span style=color:#666>.</span><span style=color:#4070a0>getReturnType</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>static</span> Set<span style=color:#666>&lt;</span>Class<span style=color:#666>&lt;?&gt;&gt;</span> resolveParameterClasses<span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;</span> mapperInterface<span style=color:#666>,</span> Method method<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> Stream<span style=color:#666>.</span><span style=color:#4070a0>of</span><span style=color:#666>(</span>TypeParameterResolver<span style=color:#666>.</span><span style=color:#4070a0>resolveParamTypes</span><span style=color:#666>(</span>method<span style=color:#666>,</span> mapperInterface<span style=color:#666>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>.</span><span style=color:#4070a0>map</span><span style=color:#666>(</span>x <span style=color:#666>-&gt;</span> typeToClass<span style=color:#666>(</span>x<span style=color:#666>,</span> x <span style=color:#007020;font-weight:700>instanceof</span> Class <span style=color:#666>?</span> <span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;)</span> x <span style=color:#666>:</span> Object<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>)).</span><span style=color:#4070a0>collect</span><span style=color:#666>(</span>Collectors<span style=color:#666>.</span><span style=color:#4070a0>toSet</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#007020;font-weight:700>static</span> Class<span style=color:#666>&lt;?&gt;</span> typeToClass<span style=color:#666>(</span>Type src<span style=color:#666>,</span> Class<span style=color:#666>&lt;?&gt;</span> fallback<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            Class<span style=color:#666>&lt;?&gt;</span> result <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>src <span style=color:#007020;font-weight:700>instanceof</span> Class<span style=color:#666>&lt;?&gt;)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(((</span>Class<span style=color:#666>&lt;?&gt;)</span> src<span style=color:#666>).</span><span style=color:#4070a0>isArray</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    result <span style=color:#666>=</span> <span style=color:#666>((</span>Class<span style=color:#666>&lt;?&gt;)</span> src<span style=color:#666>).</span><span style=color:#4070a0>getComponentType</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#007020;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    result <span style=color:#666>=</span> <span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;)</span> src<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span> <span style=color:#007020;font-weight:700>else</span> <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>src <span style=color:#007020;font-weight:700>instanceof</span> ParameterizedType<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                ParameterizedType parameterizedType <span style=color:#666>=</span> <span style=color:#666>(</span>ParameterizedType<span style=color:#666>)</span> src<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#902000>int</span> index <span style=color:#666>=</span> <span style=color:#666>(</span>parameterizedType<span style=color:#666>.</span><span style=color:#4070a0>getRawType</span><span style=color:#666>()</span> <span style=color:#007020;font-weight:700>instanceof</span> Class
</span></span><span style=display:flex><span>                        <span style=color:#666>&amp;&amp;</span> Map<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>.</span><span style=color:#4070a0>isAssignableFrom</span><span style=color:#666>((</span>Class<span style=color:#666>&lt;?&gt;)</span> parameterizedType<span style=color:#666>.</span><span style=color:#4070a0>getRawType</span><span style=color:#666>())</span>
</span></span><span style=display:flex><span>                        <span style=color:#666>&amp;&amp;</span> parameterizedType<span style=color:#666>.</span><span style=color:#4070a0>getActualTypeArguments</span><span style=color:#666>().</span><span style=color:#4070a0>length</span> <span style=color:#666>&gt;</span> <span style=color:#40a070>1</span><span style=color:#666>)</span> <span style=color:#666>?</span> <span style=color:#40a070>1</span> <span style=color:#666>:</span> <span style=color:#40a070>0</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                Type actualType <span style=color:#666>=</span> parameterizedType<span style=color:#666>.</span><span style=color:#4070a0>getActualTypeArguments</span><span style=color:#666>()[</span>index<span style=color:#666>];</span>
</span></span><span style=display:flex><span>                result <span style=color:#666>=</span> typeToClass<span style=color:#666>(</span>actualType<span style=color:#666>,</span> fallback<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>result <span style=color:#666>==</span> <span style=color:#007020;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                result <span style=color:#666>=</span> fallback<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> result<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>MyBatisMapperFactoryBeanPostProcessor</span> <span style=color:#007020;font-weight:700>implements</span> MergedBeanDefinitionPostProcessor<span style=color:#666>,</span> BeanFactoryAware <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>final</span> org<span style=color:#666>.</span><span style=color:#4070a0>apache</span><span style=color:#666>.</span><span style=color:#4070a0>commons</span><span style=color:#666>.</span><span style=color:#4070a0>logging</span><span style=color:#666>.</span><span style=color:#4070a0>Log</span> LOG <span style=color:#666>=</span> LogFactory<span style=color:#666>.</span><span style=color:#4070a0>getLog</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>                MyBatisMapperFactoryBeanPostProcessor<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>final</span> String MAPPER_FACTORY_BEAN <span style=color:#666>=</span> <span style=color:#4070a0>&#34;org.mybatis.spring.mapper.MapperFactoryBean&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> ConfigurableBeanFactory beanFactory<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#555;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>public</span> <span style=color:#902000>void</span> <span style=color:#06287e>setBeanFactory</span><span style=color:#666>(</span>BeanFactory beanFactory<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#4070a0>beanFactory</span> <span style=color:#666>=</span> <span style=color:#666>(</span>ConfigurableBeanFactory<span style=color:#666>)</span> beanFactory<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#555;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>public</span> <span style=color:#902000>void</span> <span style=color:#06287e>postProcessMergedBeanDefinition</span><span style=color:#666>(</span>RootBeanDefinition beanDefinition<span style=color:#666>,</span> Class<span style=color:#666>&lt;?&gt;</span> beanType<span style=color:#666>,</span> String beanName<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>ClassUtils<span style=color:#666>.</span><span style=color:#4070a0>isPresent</span><span style=color:#666>(</span>MAPPER_FACTORY_BEAN<span style=color:#666>,</span> <span style=color:#007020;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#4070a0>beanFactory</span><span style=color:#666>.</span><span style=color:#4070a0>getBeanClassLoader</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                resolveMapperFactoryBeanTypeIfNecessary<span style=color:#666>(</span>beanDefinition<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> <span style=color:#902000>void</span> <span style=color:#06287e>resolveMapperFactoryBeanTypeIfNecessary</span><span style=color:#666>(</span>RootBeanDefinition beanDefinition<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(!</span>beanDefinition<span style=color:#666>.</span><span style=color:#4070a0>hasBeanClass</span><span style=color:#666>()</span> <span style=color:#666>||</span> <span style=color:#666>!</span>MapperFactoryBean<span style=color:#666>.</span><span style=color:#4070a0>class</span><span style=color:#666>.</span><span style=color:#4070a0>isAssignableFrom</span><span style=color:#666>(</span>beanDefinition<span style=color:#666>.</span><span style=color:#4070a0>getBeanClass</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>beanDefinition<span style=color:#666>.</span><span style=color:#4070a0>getResolvableType</span><span style=color:#666>().</span><span style=color:#4070a0>hasUnresolvableGenerics</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                Class<span style=color:#666>&lt;?&gt;</span> mapperInterface <span style=color:#666>=</span> getMapperInterface<span style=color:#666>(</span>beanDefinition<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>(</span>mapperInterface <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#60a0b0;font-style:italic>// unofficial, see https://github.com/baomidou/mybatis-plus/issues/5826
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>                    ConstructorArgumentValues constructorArgumentValues <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> ConstructorArgumentValues<span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    constructorArgumentValues<span style=color:#666>.</span><span style=color:#4070a0>addGenericArgumentValue</span><span style=color:#666>(</span>mapperInterface<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    beanDefinition<span style=color:#666>.</span><span style=color:#4070a0>setConstructorArgumentValues</span><span style=color:#666>(</span>constructorArgumentValues<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#60a0b0;font-style:italic>// Exposes a generic type information to context for prevent early initializing
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>                    beanDefinition
</span></span><span style=display:flex><span>                            <span style=color:#666>.</span><span style=color:#4070a0>setTargetType</span><span style=color:#666>(</span>ResolvableType<span style=color:#666>.</span><span style=color:#4070a0>forClassWithGenerics</span><span style=color:#666>(</span>beanDefinition<span style=color:#666>.</span><span style=color:#4070a0>getBeanClass</span><span style=color:#666>(),</span> mapperInterface<span style=color:#666>));</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>private</span> Class<span style=color:#666>&lt;?&gt;</span> getMapperInterface<span style=color:#666>(</span>RootBeanDefinition beanDefinition<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>return</span> <span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;)</span> beanDefinition<span style=color:#666>.</span><span style=color:#4070a0>getPropertyValues</span><span style=color:#666>().</span><span style=color:#4070a0>get</span><span style=color:#666>(</span><span style=color:#4070a0>&#34;mapperInterface&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>catch</span> <span style=color:#666>(</span>Exception e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                LOG<span style=color:#666>.</span><span style=color:#4070a0>debug</span><span style=color:#666>(</span><span style=color:#4070a0>&#34;Fail getting mapper interface type.&#34;</span><span style=color:#666>,</span> e<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/spring-boot/>Spring Boot</a></div><div class=post-tags><a href=/tags/spring/>Spring</a></div><div class=post-tags><a href=/tags/graalvm/>GraalVM</a></div><div class=post-tags><a href=/tags/native-image/>Native Image</a></div><div class=post-tags><a href=/tags/java/>Java</a></div><div class=post-tags><a href=/tags/cloud-native/>Cloud Native</a></div><div class=post-tags><a href=/tags/migration/>Migration</a></div></div></div><div class=row><div class=col-xs-12><script type=module> import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs"; mermaid.initialize({ startOnLoad: true }); </script></div></div><div class=related-content><h3>Related Posts</h3><ul><li><a href=/posts/2025-07-26-graalvm-native-image/>剖析 GraalVM Native Image 技术</a></li><li><a href=/posts/2024-08-06-faketime/>容器内进程的 faketime 热更新</a></li><li><a href=/posts/2023-08-24-jsr-385/>[译] JSR 385 - 计量单位 API 2.0</a></li></ul></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var e=document,t=e.createElement("script");t.src="https://ffutop.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()})</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer></div></div></div></article><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread"),t=new MutationObserver(function(n){n.forEach(function(){const s=e.getElementsByTagName("iframe");if(s.length>1){const n=s[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(n),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script></body></html>