<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2018-12-28-%E7%90%86%E8%A7%A3-linux-kernel-7-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2018-12-28-%E7%90%86%E8%A7%A3-linux-kernel-7-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/www.ffutop.com\/"
      },
      "articleSection" : "posts",
      "name" : "ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡",
      "headline" : "ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡",
      "description" : "\x3cp\x3eç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚\x3c\/p\x3e\n\x3cp\x3eå›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚\x3c\/p\x3e\n\x3cp\x3eé‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚\x3c\/p\x3e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "28280",
      "datePublished": "2018-12-28 00:00:00 \x2b0000 UTC",
      "dateModified" : "2018-12-28 00:00:00 \x2b0000 UTC",
      "url" : "https:\/\/www.ffutop.com\/posts\/2018-12-28-%E7%90%86%E8%A7%A3-linux-kernel-7-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87\/",
      "keywords" : [ "Linux","Kernel","Char Dev", ]
  }
</script>
<title>ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡ - Utop&#39;s Blog</title>
  <meta property="og:title" content="ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡ - Utop&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚
å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚
é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚" />
  <meta name="description" content="ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚
å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚
é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/github-markdown.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-92258941-1"></script>
</head>


<body>
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2018-12-28 00:00:00 UTC">
                28 Dec 2018
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <p>ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚</p>
<p>å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚</p>
<h2 id="å®è§‚æ¦‚è§ˆ">å®è§‚æ¦‚è§ˆ</h2>
<p>é€šå¸¸åœ¨æˆ‘ä»¬çš„è®¤è¯†ä¸­ï¼Œå‘½ä»¤è¡Œç»ˆç«¯å°±è¢«è®¤ä¸ºæ˜¯ä¸ä¸€å¥—å­—ç¬¦è®¾å¤‡ç›¸é…åˆæ¥ä½¿ç”¨çš„ã€‚å¾ˆæ­£å¸¸å˜›ã€‚æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª Shell ï¼Œé€šè¿‡é”®ç›˜è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œé…åˆæ˜¾ç¤ºå™¨æŠŠè¿™äº›ç»è¿‡åŠ å·¥çš„å­—ç¬¦å±•ç¤ºå‡ºæ¥ã€‚</p>
<p>é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ Shell ä½œä¸ºä¸€ä¸ªä»»åŠ¡(è¿›ç¨‹)ï¼Œä»¥é”®ç›˜è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œä»¥æ˜¾ç¤ºè®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å‡º?</p>
<p>çœ‹çœ‹ä¸€ä¸ª 1 å·ä»»åŠ¡ <code>/bin/bash</code> çš„æ–‡ä»¶æè¿°ç¬¦è¯´æ˜å§ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ls -al
total <span style="color:#ae81ff">0</span>
dr-x------ <span style="color:#ae81ff">2</span> root root  <span style="color:#ae81ff">0</span> Dec <span style="color:#ae81ff">13</span> 23:20 .
dr-xr-xr-x <span style="color:#ae81ff">9</span> root root  <span style="color:#ae81ff">0</span> Dec <span style="color:#ae81ff">13</span> 23:20 ..
lrwx------ <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">64</span> Dec <span style="color:#ae81ff">13</span> 23:20 <span style="color:#ae81ff">0</span> -&gt; /dev/pts/0
lrwx------ <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">64</span> Dec <span style="color:#ae81ff">13</span> 23:20 <span style="color:#ae81ff">1</span> -&gt; /dev/pts/0
lrwx------ <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">64</span> Dec <span style="color:#ae81ff">13</span> 23:20 <span style="color:#ae81ff">2</span> -&gt; /dev/pts/0
lrwx------ <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">64</span> Dec <span style="color:#ae81ff">25</span> 01:09 <span style="color:#ae81ff">255</span> -&gt; /dev/pts/0
</code></pre></div><p>è¿™é‡Œæ–‡ä»¶æè¿°ç¬¦ 0, 1, 2 åˆ†åˆ«è¡¨ç¤ºä»»åŠ¡çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚è¿™äº›å†…å®¹åœ¨è¡¨ç°å½¢å¼ä¸Šåšäº†ä¸€ä¸ªé“¾æ¥ã€‚</p>
<p>é‚£ä¹ˆï¼Œ<code>/dev/pts/0</code> æ˜¯ä»€ä¹ˆ?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">crw--w---- <span style="color:#ae81ff">1</span> root tty 136, <span style="color:#ae81ff">0</span> Dec <span style="color:#ae81ff">13</span> 23:20 /dev/pts/0
</code></pre></div><p>ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹å’Œæœ€åˆé¢„æƒ³çš„æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚è‡³å°‘åœ¨å‡è±¡ä¸­ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªè¾“å…¥(é”®ç›˜)ï¼Œä¸€ä¸ªè¾“å‡º(æ˜¾ç¤ºå™¨)ã€‚æ€ä¹ˆå°±æ··æˆäº†ä¸€ä¸ªå‘¢ï¼Ÿ</p>
<p>æœ¬æ¥æ˜¯æ€ä¹ˆéƒ½æƒ³ä¸é€šçš„ï¼Œä½†åæ¥é…åˆ&quot;Unixä¸€åˆ‡çš†æ–‡ä»¶&quot;çš„ä¿¡æ¡ï¼Œæ€»ç®—æ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚</p>
<p>ç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™è¿™æ ·çš„ç»å†ï¼ŒæŸä¸ªç¨‹åºæ˜¯ä»¥é”®ç›˜è¾“å…¥ä½œä¸ºæ ‡å‡†è¾“å…¥çš„ã€‚å…¶å®å°±å’Œä¸Šé¢ğŸ‘†å±•ç¤ºçš„ä¸€æ · <code>0 -&gt; /dev/pts/0</code> ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡è¿™æ•´å¥—æµç¨‹æ˜¯æ€ä¹ˆåä½œçš„å‘¢ï¼Ÿ</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyjvtjiu0zj31980oqmxe.jpg" alt=""></p>
<p>å¯¹äºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ™®é€šçš„è°ƒç”¨ <code>read</code>, <code>write</code> ç­‰ç»è¿‡å°è£…çš„å‡½æ•°ï¼Œæ¥è¯»å–ä¸€ä¸ªæ‰€è°“çš„æ–‡ä»¶ã€‚</p>
<p>ä½†å¯¹äºæ–‡ä»¶æ˜¯å­—ç¬¦è®¾å¤‡æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ <code>tty_read</code>, <code>tty_write</code> äº†ã€‚é€šä¿—çš„è®²ï¼Œå¤§æ¦‚ç‡çš„å°±æ˜¯é”®ç›˜ä½œä¸ºè¾“å…¥ï¼Œæ˜¾ç¤ºå™¨ä½œä¸ºè¾“å‡ºäº†ã€‚</p>
<h2 id="æºç å‰–æ">æºç å‰–æ</h2>
<h3 id="æ–‡ä»¶è¯»å†™">æ–‡ä»¶è¯»å†™</h3>
<p>è¿™éƒ¨åˆ†ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p>
<p>ç®€å•å›é¡¾ä¸‹ <code>sys_read</code> å‡½æ•°</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sys_read</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> fd,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> buf,<span style="color:#66d9ef">int</span> count)
{
	<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span> file;
	<span style="color:#66d9ef">struct</span> m_inode <span style="color:#f92672">*</span> inode;

	<span style="color:#66d9ef">if</span> (fd<span style="color:#f92672">&gt;=</span>NR_OPEN <span style="color:#f92672">||</span> count<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>(file<span style="color:#f92672">=</span>current<span style="color:#f92672">-&gt;</span>filp[fd]))
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>count)
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
	verify_area(buf,count);
	inode <span style="color:#f92672">=</span> file<span style="color:#f92672">-&gt;</span>f_inode;
	<span style="color:#66d9ef">if</span> (inode<span style="color:#f92672">-&gt;</span>i_pipe)
		<span style="color:#66d9ef">return</span> (file<span style="color:#f92672">-&gt;</span>f_mode<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">?</span>read_pipe(inode,buf,count)<span style="color:#f92672">:-</span>EIO;
    <span style="color:#75715e">/* ç¡®è®¤åˆ°ièŠ‚ç‚¹æè¿°çš„æ˜¯å­—ç¬¦è®¾å¤‡ */</span>
	<span style="color:#66d9ef">if</span> (S_ISCHR(inode<span style="color:#f92672">-&gt;</span>i_mode)) 
		<span style="color:#66d9ef">return</span> rw_char(READ,inode<span style="color:#f92672">-&gt;</span>i_zone[<span style="color:#ae81ff">0</span>],buf,count,<span style="color:#f92672">&amp;</span>file<span style="color:#f92672">-&gt;</span>f_pos);
	<span style="color:#66d9ef">if</span> (S_ISBLK(inode<span style="color:#f92672">-&gt;</span>i_mode))
		<span style="color:#66d9ef">return</span> block_read(inode<span style="color:#f92672">-&gt;</span>i_zone[<span style="color:#ae81ff">0</span>],<span style="color:#f92672">&amp;</span>file<span style="color:#f92672">-&gt;</span>f_pos,buf,count);
	<span style="color:#66d9ef">if</span> (S_ISDIR(inode<span style="color:#f92672">-&gt;</span>i_mode) <span style="color:#f92672">||</span> S_ISREG(inode<span style="color:#f92672">-&gt;</span>i_mode)) {
		<span style="color:#66d9ef">if</span> (count<span style="color:#f92672">+</span>file<span style="color:#f92672">-&gt;</span>f_pos <span style="color:#f92672">&gt;</span> inode<span style="color:#f92672">-&gt;</span>i_size)
			count <span style="color:#f92672">=</span> inode<span style="color:#f92672">-&gt;</span>i_size <span style="color:#f92672">-</span> file<span style="color:#f92672">-&gt;</span>f_pos;
		<span style="color:#66d9ef">if</span> (count<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">0</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
		<span style="color:#66d9ef">return</span> file_read(inode,file,buf,count);
	}
	printk(<span style="color:#e6db74">&#34;(Read)inode-&gt;i_mode=%06o</span><span style="color:#ae81ff">\n\r</span><span style="color:#e6db74">&#34;</span>,inode<span style="color:#f92672">-&gt;</span>i_mode);
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;
}
</code></pre></div><p>å¯ä»¥çœ‹åˆ° <code>S_ISCHR()</code> å°±æ˜¯åœ¨å¯¹ièŠ‚ç‚¹çš„ç±»å‹è¿›è¡Œåˆ¤åˆ«ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„åˆ†å‘ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> crw_ptr crw_table[]<span style="color:#f92672">=</span>{
	NULL,		<span style="color:#75715e">/* nodev */</span>
	rw_memory,	<span style="color:#75715e">/* /dev/mem etc */</span>
	NULL,		<span style="color:#75715e">/* /dev/fd */</span>
	NULL,		<span style="color:#75715e">/* /dev/hd */</span>
	rw_ttyx,	<span style="color:#75715e">/* /dev/ttyx */</span>
	rw_tty,		<span style="color:#75715e">/* /dev/tty */</span>
	NULL,		<span style="color:#75715e">/* /dev/lp */</span>
	NULL};		<span style="color:#75715e">/* unnamed pipes */</span>
<span style="color:#75715e">/**
</span><span style="color:#75715e"> * è¿™æ®µè¿˜æ˜¯æ¶‰åŠåˆ°åˆ†å‘ï¼Œç”±ä¸åŒçš„è®¾å¤‡å·(dev) æ¥ç¡®å®šæ‰§è¡Œå‡½æ•° (ttyx, ä¸²å£ç»ˆç«¯; tty, æ§åˆ¶å°ç»ˆç«¯; mem, /dev/mem ç­‰)
</span><span style="color:#75715e"> * crw_ptr æ˜¯ C è¯­è¨€ä¸­å¸¸è§çš„å‡½æ•°æŒ‡é’ˆã€‚ç”±devå·æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rw_char</span>(<span style="color:#66d9ef">int</span> rw,<span style="color:#66d9ef">int</span> dev, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> buf, <span style="color:#66d9ef">int</span> count, off_t <span style="color:#f92672">*</span> pos)
{
	crw_ptr call_addr;

	<span style="color:#66d9ef">if</span> (MAJOR(dev)<span style="color:#f92672">&gt;=</span>NRDEVS)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENODEV;
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(call_addr<span style="color:#f92672">=</span>crw_table[MAJOR(dev)]))
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENODEV;
	<span style="color:#66d9ef">return</span> call_addr(rw,MINOR(dev),buf,count,pos);
}
</code></pre></div><p>æ‰§è¡Œåˆ° <code>rw_tty</code>, <code>rw_ttyx</code> ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å°†å¯¹è¯»/å†™è¿›è¡ŒåŒºåˆ†ï¼Œå¹¶ç”±ç‰¹å®šçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rw_ttyx</span>(<span style="color:#66d9ef">int</span> rw,<span style="color:#66d9ef">unsigned</span> minor,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> buf,<span style="color:#66d9ef">int</span> count,off_t <span style="color:#f92672">*</span> pos)
{
	<span style="color:#66d9ef">return</span> ((rw<span style="color:#f92672">==</span>READ)<span style="color:#f92672">?</span>tty_read(minor,buf,count)<span style="color:#f92672">:</span>
		tty_write(minor,buf,count));
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rw_tty</span>(<span style="color:#66d9ef">int</span> rw,<span style="color:#66d9ef">unsigned</span> minor,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> buf,<span style="color:#66d9ef">int</span> count, off_t <span style="color:#f92672">*</span> pos)
{
	<span style="color:#66d9ef">if</span> (current<span style="color:#f92672">-&gt;</span>tty<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EPERM;
	<span style="color:#66d9ef">return</span> rw_ttyx(rw,current<span style="color:#f92672">-&gt;</span>tty,buf,count,pos);
}
</code></pre></div><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥èƒ½å¤ŸåŸºæœ¬äº†è§£äº†å­—ç¬¦è®¾å¤‡ï¼Œä½œä¸º Linux çš„æ–‡ä»¶ï¼Œæ‰€åº”è¯¥æœ‰çš„è¯»å†™çš„ç›¸å…³æ”¯æŒã€‚</p>
<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿè¯»ã€å†™çš„å†…å®¹åœ¨å“ªå‘¢ï¼Ÿæ¯”å¦‚æ­£è§„æ–‡ä»¶ï¼Œéƒ½å¾ˆå®¹æ˜“åœ°å¯ä»¥ç†è§£åˆ°ï¼Œå°±æ˜¯ä»ç£ç›˜ä¸­å–å‡ºæŸä¸ª/æŸå‡ ä¸ªç›˜å—çš„å†…å®¹å³å¯ã€‚å­—ç¬¦è®¾å¤‡çš„IOè¦ä»å“ªé‡Œå–(å¾€å“ªé‡Œé€)æ•°æ®å‘¢?</p>
<h3 id="å­—ç¬¦è®¾å¤‡é©±åŠ¨">å­—ç¬¦è®¾å¤‡é©±åŠ¨</h3>
<p>å¯¹äºè®¾å¤‡é©±åŠ¨è¿™ä¸ªæ¦‚å¿µï¼Œè‡³ä»Šæ²¡æœ‰ææ¸…æ¥šã€‚ä¸è¿‡ï¼Œè¿™ä¸å¦¨ç¢å¯¹ä»£ç çš„ç†è§£ã€‚åæ­£å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€äº›è½¯ä»¶å±‚é¢çš„ä»£ç ï¼Œä¸æ™®é€šä»£ç çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¯¹å¤–è®¾ç¡¬ä»¶åšäº†ç›¸åº”çš„äº¤äº’æ”¯æŒã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fykyc6lo9pj31i40u0ac8.jpg" alt=""></p>
<p>æ‰¿æ¥æ“ä½œç³»ç»Ÿçš„å­—ç¬¦è®¾å¤‡æ¥å£ï¼Œ<code>tty_read</code>ã€<code>tty_write</code> è´Ÿè´£è¯»å…¥å’Œå†™å‡ºã€‚</p>
<p>ä»å“ªé‡Œè¯»ï¼Ÿ<code>secondary</code> æ•°æ®é˜Ÿåˆ—ï¼›å¾€å“ªé‡Œå†™ï¼Ÿ<code>write_q</code> æ•°æ®é˜Ÿåˆ—ã€‚</p>
<p>åŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿™äº›é˜Ÿåˆ—ç›´æ¥ç›¸å…³çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨äº†ã€‚æ˜¯ä¸æ˜¯æœ‰äº†ç‚¹è±ç„¶å¼€æœ—çš„æ„Ÿè§‰ã€‚</p>
<p>å¥½ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™é‡Œæè¿°çš„ä¸‰ä¸ªé˜Ÿåˆ—ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œå°±ä¸å¾—ä¸å…ˆçœ‹çœ‹å†…å­˜ä¸­æŠ½è±¡å‡ºæ¥çš„æè¿°ç»ˆç«¯çš„æ•°æ®ç»“æ„ <code>tty_struct</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * copied from include/linux/tty.h
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">struct</span> tty_struct {
	<span style="color:#66d9ef">struct</span> termios termios;     <span style="color:#75715e">/* terminal IO conf */</span>
	<span style="color:#66d9ef">int</span> pgrp;                   <span style="color:#75715e">/* æ‰€å±è¿›ç¨‹ç»„ */</span>
	<span style="color:#66d9ef">int</span> stopped;                <span style="color:#75715e">/* åœæ­¢æ ‡å¿— */</span>
	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>write)(<span style="color:#66d9ef">struct</span> tty_struct <span style="color:#f92672">*</span> tty); <span style="color:#75715e">/* ç»ˆç«¯å†™å‡½æ•°æŒ‡é’ˆ */</span>
	<span style="color:#66d9ef">struct</span> tty_queue read_q;    <span style="color:#75715e">/* ç»ˆç«¯è¯»é˜Ÿåˆ— */</span>
	<span style="color:#66d9ef">struct</span> tty_queue write_q;   <span style="color:#75715e">/* ç»ˆç«¯å†™é˜Ÿåˆ— */</span>
	<span style="color:#66d9ef">struct</span> tty_queue secondary; <span style="color:#75715e">/* ç»ˆç«¯è¾…åŠ©é˜Ÿåˆ— */</span>
};

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * copied from include/termios.h
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">struct</span> termios {                <span style="color:#75715e">/* terminal IO å±æ€§ */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> c_iflag;		<span style="color:#75715e">/* input mode flags */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> c_oflag;		<span style="color:#75715e">/* output mode flags */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> c_cflag;		<span style="color:#75715e">/* control mode flags */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> c_lflag;		<span style="color:#75715e">/* local mode flags */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> c_line;		<span style="color:#75715e">/* line discipline */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> c_cc[NCCS];	<span style="color:#75715e">/* control characters */</span>
};

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * copied from include/linux/tty.h
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">struct</span> tty_queue {
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> data;         <span style="color:#75715e">/* å­—ç¬¦è¡Œæ•°é‡ | ä¸²å£ç»ˆç«¯åˆ™å­˜å‚¨ç«¯å£å· */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> head;         <span style="color:#75715e">/* å¤´æŒ‡é’ˆ */</span>
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> tail;         <span style="color:#75715e">/* å°¾æŒ‡é’ˆ */</span>
	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span> proc_list; <span style="color:#75715e">/* ç­‰å¾…è¯¥ç»ˆç«¯çš„ä»»åŠ¡é˜Ÿåˆ— */</span>
	<span style="color:#66d9ef">char</span> buf[TTY_BUF_SIZE];     <span style="color:#75715e">/* é˜Ÿåˆ—çš„ç¼“å†²åŒº */</span>
};
</code></pre></div><p>å¯¹äºä»»ä½•ä»»åŠ¡éœ€è¦è¯»å†™å­—ç¬¦è®¾å¤‡(è¿™é‡ŒæŒ‡ç»ˆç«¯è®¾å¤‡)ï¼Œæœ€ç»ˆç›´æ¥è¯»å–/å†™å…¥åˆ°çš„å°±æ˜¯ <code>secondary</code> å’Œ <code>write_q</code>ã€‚</p>
<hr>
<p>è¿™é‡Œå¯èƒ½æœ‰ä¸ªå°å°çš„ç–‘é—®? ä¸ºä»€ä¹ˆè¯»ç»ˆç«¯è®¾å¤‡ä¸æ˜¯è¯» <code>read_q</code> å‘¢ï¼Ÿ</p>
<p>å…¶å®ä¹Ÿæ¯”è¾ƒå¥½è§£é‡Šï¼Œç›¸ä¿¡æ—¥å¸¸åœ¨æ“ä½œå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ•²å‡»çš„é”®ä½ä¸æ˜¾ç¤ºå™¨ä¸Šå®é™…å±•ç¤ºçš„å†…å®¹æ˜¯ä¸ç›¸åŒ¹é…çš„ã€‚æœ€æ™®é€šçš„ï¼Œæˆ‘ä»¬é”®å…¥äº† <strong>delete(åˆ é™¤é”®)</strong>ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸€ä¸ª <strong>delete</strong> å¯¹åº”çš„ ascii (å½“ç„¶ï¼Œè¿™é‡Œè¯·å…ˆå¿½è§†éæ‰“å°å­—ç¬¦çš„é—®é¢˜)ï¼Œè€Œæ˜¯åˆ é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿå®Œå…¨å¯ä»¥æƒ³è±¡ï¼Œåæ­£ä»»ä½•é”®ä½ä¸é©±åŠ¨äº¤äº’çš„æ—¶å€™éƒ½æ˜¯ä¼ å…¥ä¸€ä¸²äºŒè¿›åˆ¶ç å˜›ã€‚</p>
<p>è¿™é‡Œçš„ <code>secondary</code> å®Œæˆçš„å°±æ˜¯æ€ä¹ˆä¸€ä¸ªå·¥ä½œï¼Œ<code>read_q</code> å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å¤–è®¾(è¿™é‡Œæ˜¯é”®ç›˜)çš„è¾“å…¥ï¼Œå¹¶åŸæ ·å­˜å‚¨ã€‚è€Œåˆ°äº† <code>secondary</code> å°±æ˜¯ç»è¿‡ç›¸åº”çš„åŠ å·¥ï¼Œè¯¸å¦‚æ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„éƒ½å±•ç°äº†å„è‡ªçš„æ„ä¹‰ï¼Œå¹¶å®Œæˆä¸€äº›åŠ å·¥å·¥ä½œï¼Œè€Œä¸å†ä»…ä»…åªæ˜¯æ™®é€šåœ°å±•ç¤ºäº†ã€‚</p>
<hr>
<p>å¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†åœ¨å‘½ä»¤è¡Œäº¤äº’æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½å°†ç›´æ¥åœ¨æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå¥½åƒæˆ‘ä»¬åœ¨ç›´æ¥å¾€æ˜¾ç¤ºå™¨ä¸Šå†™å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‰é¢æˆ‘ä»¬æè¿°çš„å†…å®¹éƒ½æ˜¯ï¼Œé”®ç›˜è®¾å¤‡ä½œä¸ºè¾“å…¥ï¼Œæ˜¯è¦å†™åˆ° <code>read_q</code> ä¹ƒè‡³ <code>secondary</code> å¹¶æœ€ç»ˆä½œä¸ºè¿›ç¨‹çš„è¾“å…¥çš„ã€‚åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºå¹¶ä¸æ˜¯å®ƒæœ¬æ¥åº”è¯¥å¹²çš„äº‹æƒ… (æ¯”è¾ƒæ˜¾ç¤ºå™¨ä¸Šå±•ç¤ºçš„åº”è¯¥æ˜¯ <code>write_q</code> çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º)</p>
<p>äº‹å®ä¸Šï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªå›æ˜¾ï¼Œå°† <code>secondary</code> é˜Ÿåˆ—çš„å†…å®¹å¤åˆ¶äº†ä¸€ä»½åˆ°å†™é˜Ÿåˆ—ï¼Œä¹Ÿå°±å‘ˆç°å‡ºè®©æ˜¾ç¤ºå™¨æ‰“å°ç›¸åº”é”®ç›˜è¾“å…¥çš„æ•ˆæœäº†ã€‚</p>
<p>åŒæ—¶ï¼Œè¿™ä¹Ÿå°±èƒ½å¤Ÿç›´æ¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>passwd</code>, <code>su</code>, <code>sudo</code> ç­‰å‘½ä»¤æ—¶ï¼Œè¦æ±‚è¾“å…¥å¯†ç éƒ½æ˜¯ä¸åœ¨æ˜¾ç¤ºå™¨ä¸Šå›æ˜¾çš„ã€‚å®ç°ä¹Ÿç›¸å½“ç®€å•äº†å˜›ã€‚æŠŠ tty_struct.termios çš„ç›¸åº”æ§åˆ¶å±æ€§ (ECHO) é‡ç½®ï¼Œå°±å¯ä»¥å®ç°ä¸å›æ˜¾çš„æ•ˆæœäº†ã€‚</p>
<h3 id="ç»ˆç«¯è®¾å¤‡äº¤äº’">ç»ˆç«¯è®¾å¤‡äº¤äº’</h3>
<p>æœ€åä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€å…³å¿ƒçš„äº†ã€‚å¤–è®¾å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿå®Œæˆäº¤äº’ã€‚å…¶å®ä¹Ÿèƒ½å¤Ÿæƒ³å¾—åˆ°äº†â€”â€”ä¸­æ–­ã€‚</p>
<p>åœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå°±æŠŠä¸­æ–­æè¿°ç¬¦è¡¨çš„ä¸­æ–­è¡¨é¡¹é…ç½®å¾—å½“ã€‚ä¹‹åçš„äº‹æƒ…å°±æ˜¯ç­‰å¾…é”®ç›˜ç­‰å¤–è®¾è¾“å…¥çš„ä¸­æ–­ä¿¡å·äº†ã€‚</p>
<p>åˆçœ‹å›åˆ°äº† <code>init/main.c</code> ç¨‹åº</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
    ...
	trap_init();
	blk_dev_init();
	chr_dev_init(); <span style="color:#75715e">/* å—è®¾å¤‡ç›¸å…³åˆå§‹åŒ–, æ–¹æ³•ä½“æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®ç° */</span>
	tty_init();     <span style="color:#75715e">/* tty ç»ˆç«¯è®¾å¤‡åˆå§‹åŒ– */</span>
	time_init();
	sched_init();
	buffer_init(buffer_memory_end);
    ...
}
</code></pre></div><pre><code>/**
 * Copied from kernel/chr_drv/tty_io.c
 * ç»ˆç«¯è®¾å¤‡åˆè¯†åŒ–
 */
void tty_init(void)
{
    /** ä¸²å£è®¾å¤‡åˆå§‹åŒ– */
	rs_init();
    /** æ§åˆ¶å°è®¾å¤‡åˆå§‹åŒ– */
	con_init();
}
</code></pre><p>è‡³äºä¸ºä»€ä¹ˆæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ã€‚è¿™æ¥æºäºç»ˆç«¯åˆåŒºåˆ†ä¸ºæ§åˆ¶å°ç»ˆç«¯ä¸ä¸²å£ç»ˆç«¯ï¼ŒåŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç›´æ¥å»ºç«‹åœ¨ä¸»æœºä¸Šï¼Œä¸²å£ç»ˆç«¯æ˜¯é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥åˆ°ä¸»æœºçš„ã€‚å½“ç„¶ï¼Œè¿™éƒ½æ˜¯å¤è€çš„æ–¹å¼äº†ï¼Œç»†èŠ‚å°±ä¸å¤ªæ¸…æ¥šäº†ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹çœ‹ <code>con_init()</code> åšäº†å“ªäº›å·¥ä½œ(<code>rs_init()</code> çš„å†…å®¹è¯·è‡ªè¡Œäº†è§£)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">con_init</span>(<span style="color:#66d9ef">void</span>)
{
	<span style="color:#66d9ef">register</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> a;
	<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>display_desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;????&#34;</span>;
	<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>display_ptr;

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * è¯»å– setup.s ç¨‹åºé¢„å¤„ç†çš„å†…å®¹
</span><span style="color:#75715e">     * åŒ…æ‹¬æ˜¾ç¤ºå™¨çš„å„ç§é…ç½®å‚æ•°
</span><span style="color:#75715e">     */</span>
	video_num_columns <span style="color:#f92672">=</span> ORIG_VIDEO_COLS;
	video_size_row <span style="color:#f92672">=</span> video_num_columns <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>;
	video_num_lines <span style="color:#f92672">=</span> ORIG_VIDEO_LINES;
	video_page <span style="color:#f92672">=</span> ORIG_VIDEO_PAGE;
	video_erase_char <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0720</span>;

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * è¯»å–æ˜¾ç¤ºå™¨çš„é…ç½®å¹¶è¿›è¡Œç›¸å…³è®¾ç½® (çœç•¥ä»£ç )
</span><span style="color:#75715e">     */</span>
    ...

	origin	<span style="color:#f92672">=</span> video_mem_start;
	scr_end	<span style="color:#f92672">=</span> video_mem_start <span style="color:#f92672">+</span> video_num_lines <span style="color:#f92672">*</span> video_size_row;
	top	<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
	bottom	<span style="color:#f92672">=</span> video_num_lines;

	gotoxy(ORIG_X,ORIG_Y);
    <span style="color:#75715e">/** è®¾ç½®é™·é˜±é—¨ */</span>
	set_trap_gate(<span style="color:#ae81ff">0x21</span>,<span style="color:#f92672">&amp;</span>keyboard_interrupt);
	outb_p(inb_p(<span style="color:#ae81ff">0x21</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xfd</span>,<span style="color:#ae81ff">0x21</span>);
	a<span style="color:#f92672">=</span>inb_p(<span style="color:#ae81ff">0x61</span>);
	outb_p(a<span style="color:#f92672">|</span><span style="color:#ae81ff">0x80</span>,<span style="color:#ae81ff">0x61</span>);
	outb(a,<span style="color:#ae81ff">0x61</span>);
}
</code></pre></div><p>åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æœ€é‡è¦çš„å†…å®¹å°±æ˜¯<strong>è®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨</strong>äº†ã€‚</p>
<p>ä¹‹ååªæœ‰é™é™åœ°ç­‰å¾…é”®ä½æ•²å‡»ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº§ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œä»è€Œè®© <code>read_q</code> è·å¾—åˆ°ç›¸åº”çš„å­—ç¬¦è¾“å…¥ã€‚</p>
<p>è‡³äºé”®ç›˜ä¸­æ–­çš„ç›¸åº”å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚ç®€è¿°ä¸€äº›æ­¥éª¤:</p>
<ol>
<li>
<p>äº§ç”Ÿç¡¬ä¸­æ–­ <code>keyboard_interrupt</code>ï¼Œç”±ç¨‹åº <code>Keyboard.s</code> çš„æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†</p>
</li>
<li>
<p>æ ¹æ®ä¸åŒçš„é”®ç›˜(US é”®ç›˜ã€å¾·å¼é”®ç›˜ç­‰ç­‰)å°†è·å¾—çš„é”®ä½ä¿¡å·è¿›è¡Œç›¸åº”çš„å­—ç¬¦è½¬æ¢(æŸ¥è½¬æ¢è¡¨)</p>
</li>
<li>
<p>è°ƒç”¨ <code>do_tty_interrupt</code> å¤„ç†å‡½æ•° (ç¡®è®¤æ˜¯ç»™å“ªä¸ªç»ˆç«¯çš„ä¿¡å·)</p>
</li>
<li>
<p>è°ƒç”¨ <code>copy_to_cooked(tty)</code> ï¼Œå³å®Œæˆ <code>read_q</code> åˆ° <code>secondary</code> çš„ç›¸å…³åŠ å·¥ã€‚</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

<div class="releated-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2018-11-11-%E7%90%86%E8%A7%A3-linux-kernel-6-read-write/">ç†è§£ Linux Kernel (6) - read &amp; write</a></li>
    
    <li><a href="/posts/2018-10-14-%E7%90%86%E8%A7%A3-linux-kernel-5-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%8F%E8%A7%82%E6%8F%8F%E8%BF%B0/">ç†è§£ Linux Kernel (5) - æ–‡ä»¶ç³»ç»Ÿ(å®è§‚æè¿°)</a></li>
    
    <li><a href="/posts/2018-10-12-%E7%90%86%E8%A7%A3-linux-kernel-4-%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/">ç†è§£ Linux Kernel (4) - ä»»åŠ¡è°ƒåº¦</a></li>
    
  </ul>
</div>

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

</body>

</html>
