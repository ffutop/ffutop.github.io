<!DOCTYPE html>
<html lang="zh-cmn-Hans-CN" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    
    <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2018-07-10-cglib-enhancer/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2018-07-10-cglib-enhancer/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.ffutop.com/"
      },
      "articleSection" : "posts",
      "name" : "CGlib Enhancer ä¸»æµç¨‹æºç è§£æ",
      "headline" : "CGlib Enhancer ä¸»æµç¨‹æºç è§£æ",
      "description" : "\u003ch2 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h2\u003e\n\u003cp\u003eæ­¤åšæ–‡å†™ä½œçš„ç›®çš„:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚\u003c/li\u003e\n\u003cli\u003eåŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚\u003c/li\u003e\n\u003c/ul\u003e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2018",
      "datePublished": "2018-07-10T00:00:00Z",
      "dateModified" : "2018-07-10T00:00:00Z",
      "url" : "https://www.ffutop.com/posts/2018-07-10-cglib-enhancer/",
      "keywords" : [ "CGlib","ASM", ]
  }
</script>
<title>CGlib Enhancer ä¸»æµç¨‹æºç è§£æ - Utop&#39;s Blog</title>
  <meta property="og:title" content="CGlib Enhancer ä¸»æµç¨‹æºç è§£æ - Utop&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="å‰è¨€
æ­¤åšæ–‡å†™ä½œçš„ç›®çš„:

(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚
åŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚
" />
  <meta name="description" content="å‰è¨€
æ­¤åšæ–‡å†™ä½œçš„ç›®çš„:

(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚
åŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚
" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/github-markdown.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-92258941-1"></script>
</head>

     
  </head>
  <body>
    
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">CGlib Enhancer ä¸»æµç¨‹æºç è§£æ</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2018-07-10 00:00:00 UTC">
                10 Jul 2018
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="å‰è¨€">å‰è¨€</h2>
<p>æ­¤åšæ–‡å†™ä½œçš„ç›®çš„:</p>
<ul>
<li>(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚</li>
<li>åŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚</li>
</ul>
<h2 id="enhancer">Enhancer</h2>
<p>ä»è¿™ç¯‡ä¸æ˜¯å®˜æ–¹ä½†æ›´èƒœäºå®˜æ–¹æ–‡æ¡£çš„ <a href="https://mydailyjava.blogspot.com/2013/11/cglib-missing-manual.html">CGlib Guide</a> æ¥çœ‹ï¼Œå®ƒé¦–å…ˆæåˆ°çš„ç¬¬ä¸€ä¸ªç±»å°±æ˜¯ Enhancerã€‚
å…¶è¢«ç”¨äºåˆ›å»º Java ä»£ç†ç±»ï¼Œç›¸è¾ƒäº Java æ ‡å‡†åº“çš„ Proxy ç±»ï¼Œå®ƒ<strong>ç‰¹åˆ«åœ°</strong>ï¼Œèƒ½å¤Ÿæ”¯æŒé‚£äº›æ²¡æœ‰å®ç°æ¥å£çš„ç±»çš„ä»£ç†å·¥ä½œã€‚</p>
<h3 id="enhancer-ç®€å•ç¤ºä¾‹å±•ç¤º">Enhancer ç®€å•ç¤ºä¾‹å±•ç¤º</h3>
<p>é’ˆå¯¹ç°æœ‰çš„ SampleClass ç±»</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SampleClass</span> <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:bold">public</span> String <span style="color:#06287e">test</span><span style="color:#666">(</span>String input<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;Hello World!&#34;</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>ä½¿ç”¨ CGlib çš„ Enhancer å¯¹ SampleClass è¿›è¡Œå¢å¼ºï¼Œä¸‹åˆ—æ“ä½œçš„ç›®çš„åœ¨äºå°† test(String) æ–¹æ³•çš„è¿”å›å€¼æ”¹å†™æˆ &ldquo;Hello cglib!&rdquo;</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Test</span>
<span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">testFixedValue</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// new ä¸€ä¸ª Enhancer å®ä¾‹
</span><span style="color:#60a0b0;font-style:italic"></span>    Enhancer enhancer <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Enhancer<span style="color:#666">();</span>
    <span style="color:#60a0b0;font-style:italic">// å£°æ˜ä½¿ç”¨çš„çˆ¶ç±»æ˜¯ SampleClass
</span><span style="color:#60a0b0;font-style:italic"></span>    enhancer<span style="color:#666">.</span><span style="color:#4070a0">setSuperclass</span><span style="color:#666">(</span>SampleClass<span style="color:#666">.</span><span style="color:#4070a0">class</span><span style="color:#666">);</span>
    <span style="color:#60a0b0;font-style:italic">// è®¾ç½®å›è°ƒæ–¹æ³• - å›è°ƒæ–¹æ³•å®ç°ä¸º FixedValue (å›ºå®šå€¼) .
</span><span style="color:#60a0b0;font-style:italic"></span>    enhancer<span style="color:#666">.</span><span style="color:#4070a0">setCallback</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> FixedValue<span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">loadObject</span><span style="color:#666">()</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;Hello cglib!&#34;</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">});</span>
    <span style="color:#60a0b0;font-style:italic">// åˆ›å»º SampleClass çš„ä»£ç†å­ç±»å®ä¾‹
</span><span style="color:#60a0b0;font-style:italic"></span>    SampleClass proxy <span style="color:#666">=</span> <span style="color:#666">(</span>SampleClass<span style="color:#666">)</span> enhancer<span style="color:#666">.</span><span style="color:#4070a0">create</span><span style="color:#666">();</span>
    Assert<span style="color:#666">.</span><span style="color:#4070a0">assertEquals</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;Hello cglib!&#34;</span><span style="color:#666">,</span> proxy<span style="color:#666">.</span><span style="color:#4070a0">test</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">null</span><span style="color:#666">));</span>
<span style="color:#666">}</span>
</code></pre></div><p>ç®€å•æµ‹è¯•ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥äº†è§£åˆ°ç¡®å®ï¼Œä»£ç†ç±»çš„ test(String) æ–¹æ³•çš„è¿”å›å€¼è¢«æ”¹å†™äº†ã€‚
é‚£ä¹ˆï¼Œç©¶ç«Ÿè¿™ç§æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿä¸‹é¢ğŸ‘‡å°†è¿›è¡Œå…·ä½“çš„æ¢ç©¶ã€‚</p>
<h2 id="è°ƒç”¨é“¾è·Ÿè¸ª">è°ƒç”¨é“¾è·Ÿè¸ª</h2>
<h3 id="é«˜åº¦æŠ½è±¡çš„æ—¶åºå›¾">é«˜åº¦æŠ½è±¡çš„æ—¶åºå›¾</h3>
<p><img src="https://img.ffutop.com/11657CC2-D2A9-4ADD-89B8-6359C39C6181.jpg" alt="Enhancer è°ƒç”¨é“¾ æ—¶åºå›¾"></p>
<p><em>ä¸‹åˆ—å†…å®¹å°†æ ¹æ®æ—¶åºå›¾è¿›è¡Œç»„ç»‡ï¼Œæ ¹æ®è°ƒç”¨ç¼–å·(1,2,3&hellip;)è¿›è¡Œå±•å¼€</em></p>
<h3 id="seq-1">Seq 1.</h3>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">create</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    classOnly <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">false</span><span style="color:#666">;</span>
    argumentTypes <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">return</span> createHelper<span style="color:#666">();</span>
<span style="color:#666">}</span>

<span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">create</span><span style="color:#666">(</span>Class<span style="color:#666">[]</span> argumentTypes<span style="color:#666">,</span> Object<span style="color:#666">[]</span> arguments<span style="color:#666">)</span> <span style="color:#666">{</span>
    classOnly <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">false</span><span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>argumentTypes <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span> <span style="color:#666">||</span> arguments <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span> <span style="color:#666">||</span> argumentTypes<span style="color:#666">.</span><span style="color:#4070a0">length</span> <span style="color:#666">!=</span> arguments<span style="color:#666">.</span><span style="color:#4070a0">length</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span><span style="color:#4070a0">&#34;Arguments must be non-null and of equal length&#34;</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
    <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">argumentTypes</span> <span style="color:#666">=</span> argumentTypes<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">arguments</span> <span style="color:#666">=</span> arguments<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">return</span> createHelper<span style="color:#666">();</span>
<span style="color:#666">}</span>
</code></pre></div><p>ä¸Šè¿°ä¸¤ä¸ª <code>create(...)</code> æ–¹æ³•ã€‚ç»“åˆä¸Šä¸€èŠ‚çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ° <code>create()</code> å¯¹åº”çš„<strong>æ— å‚æ„é€ </strong>ã€‚
å­˜åœ¨æ— å‚æ„é€ ï¼Œé‚£ä¹ˆ<strong>æœ‰å‚çš„æ„é€ æ–¹æ³•</strong>æ˜¾ç„¶ä¹Ÿæ˜¯åº”è¯¥è¢«æ”¯æŒidã€‚<code>create(Class[], Object[])</code> æ­£æ˜¯ä¸ºäº†è¿™ä¸ªç›®æ ‡è€Œå­˜åœ¨ã€‚é€šè¿‡æä¾›å‚æ•°ç±»å‹æ•°ç»„å’Œå‚æ•°å®ä¾‹æ•°ç»„ï¼Œå¯ä»¥å”¯ä¸€åœ°å®šä½åŠè°ƒç”¨ä»£ç†ç±»çš„ç‰¹å®šæ„é€ æ–¹æ³•ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯å°† Enhancer ä½œä¸ºä¸€ä¸ªæ•°æ®å†…å®¹çš„æŒæœ‰è€…ï¼Œé‡ç½®äº†æ–°ä»£ç†ç±»å°†ä½¿ç”¨çš„æ„é€ å‡½æ•°å‚æ•°å†…å®¹ï¼Œä¹‹åå°±ç›´æ¥è°ƒç”¨äº† <code>createHelper()</code> ã€‚</p>
<h3 id="seq-2">Seq 2.</h3>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">private</span> Object <span style="color:#06287e">createHelper</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// å¯¹é¢„å£°æ˜çš„å›è°ƒæ–¹æ³•è¿›è¡ŒéªŒè¯ï¼Œè¦æ±‚ [å¤šä¸ªå›è°ƒå°±å¿…é¡»å­˜åœ¨ CallbackFilter ä½œä¸ºè°ƒåº¦å™¨]
</span><span style="color:#60a0b0;font-style:italic"></span>    preValidate<span style="color:#666">();</span>
    <span style="color:#60a0b0;font-style:italic">// æ„å»ºä¸€ä¸ªå¯¹è¿™ç±»å¢å¼ºæ“ä½œå”¯ä¸€å®šä½çš„ key
</span><span style="color:#60a0b0;font-style:italic"></span>    Object key <span style="color:#666">=</span> KEY_FACTORY<span style="color:#666">.</span><span style="color:#4070a0">newInstance</span><span style="color:#666">((</span>superclass <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">?</span> superclass<span style="color:#666">.</span><span style="color:#4070a0">getName</span><span style="color:#666">()</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">,</span>
            ReflectUtils<span style="color:#666">.</span><span style="color:#4070a0">getNames</span><span style="color:#666">(</span>interfaces<span style="color:#666">),</span>
            filter <span style="color:#666">==</span> ALL_ZERO <span style="color:#666">?</span> <span style="color:#007020;font-weight:bold">null</span> <span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">new</span> WeakCacheKey<span style="color:#666">&lt;</span>CallbackFilter<span style="color:#666">&gt;(</span>filter<span style="color:#666">),</span>
            callbackTypes<span style="color:#666">,</span>
            useFactory<span style="color:#666">,</span>
            interceptDuringConstruction<span style="color:#666">,</span>
            serialVersionUID<span style="color:#666">);</span>
    <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">currentKey</span> <span style="color:#666">=</span> key<span style="color:#666">;</span>
    <span style="color:#60a0b0;font-style:italic">// è°ƒç”¨çˆ¶ç±»é€šè¿‡çš„ create(...) æ–¹æ³•
</span><span style="color:#60a0b0;font-style:italic"></span>    Object result <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#4070a0">create</span><span style="color:#666">(</span>key<span style="color:#666">);</span>
    <span style="color:#007020;font-weight:bold">return</span> result<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><h3 id="seq-3">Seq 3.</h3>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">protected</span> Object <span style="color:#06287e">create</span><span style="color:#666">(</span>Object key<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
        <span style="color:#60a0b0;font-style:italic">// è·å–ç”¨äº åŠ è½½ ç”Ÿæˆç±» çš„ ClassLoader
</span><span style="color:#60a0b0;font-style:italic"></span>        ClassLoader loader <span style="color:#666">=</span> getClassLoader<span style="color:#666">();</span>
        <span style="color:#60a0b0;font-style:italic">// ä»ç¼“å­˜ä¸­åŠ è½½ è¿™ä¸ª ClassLoader è¿‡å»åŠ è½½çš„ç›¸å…³æ•°æ®
</span><span style="color:#60a0b0;font-style:italic"></span>        Map<span style="color:#666">&lt;</span>ClassLoader<span style="color:#666">,</span> ClassLoaderData<span style="color:#666">&gt;</span> cache <span style="color:#666">=</span> CACHE<span style="color:#666">;</span>
        ClassLoaderData data <span style="color:#666">=</span> cache<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">(</span>loader<span style="color:#666">);</span>
        <span style="color:#60a0b0;font-style:italic">// å¦‚æœåœ¨ ç¼“å­˜ ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™åˆå§‹åŒ–æ„é€ å…³äºè¿™ä¸ª ClassLoader çš„æ•°æ®å®ä¾‹
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>data <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#60a0b0;font-style:italic">// åŒæ­¥
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#007020;font-weight:bold">synchronized</span> <span style="color:#666">(</span>AbstractClassGenerator<span style="color:#666">.</span><span style="color:#4070a0">class</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#60a0b0;font-style:italic">// è¿›å…¥åŒæ­¥å—åçš„ å†æ¬¡ç¡®è®¤ï¼Œé¿å…é‡å¤åˆå§‹åŒ–æ„å»º
</span><span style="color:#60a0b0;font-style:italic"></span>                cache <span style="color:#666">=</span> CACHE<span style="color:#666">;</span>
                data <span style="color:#666">=</span> cache<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">(</span>loader<span style="color:#666">);</span>
                <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>data <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                    <span style="color:#60a0b0;font-style:italic">// æ„å»ºæ–°çš„ ç¼“å­˜ï¼Œæ‹·è´åŸæœ‰çš„ç¼“å­˜é›†çš„å†…å®¹
</span><span style="color:#60a0b0;font-style:italic"></span>                    Map<span style="color:#666">&lt;</span>ClassLoader<span style="color:#666">,</span> ClassLoaderData<span style="color:#666">&gt;</span> newCache <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> WeakHashMap<span style="color:#666">&lt;</span>ClassLoader<span style="color:#666">,</span> ClassLoaderData<span style="color:#666">&gt;(</span>cache<span style="color:#666">);</span>
                    <span style="color:#60a0b0;font-style:italic">// åˆå§‹åŒ– ClassLoaderData ï¼ŒçœŸæ­£çš„æ„é€ æ“ä½œ
</span><span style="color:#60a0b0;font-style:italic"></span>                    data <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ClassLoaderData<span style="color:#666">(</span>loader<span style="color:#666">);</span>
                    <span style="color:#60a0b0;font-style:italic">// æ·»åŠ åˆ°ç¼“å­˜ä¸­
</span><span style="color:#60a0b0;font-style:italic"></span>                    newCache<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span>loader<span style="color:#666">,</span> data<span style="color:#666">);</span>
                    CACHE <span style="color:#666">=</span> newCache<span style="color:#666">;</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
        <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">key</span> <span style="color:#666">=</span> key<span style="color:#666">;</span>
        Object obj <span style="color:#666">=</span> data<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">,</span> getUseCache<span style="color:#666">());</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>obj <span style="color:#007020;font-weight:bold">instanceof</span> Class<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#60a0b0;font-style:italic">// åˆæ¬¡å®ä¾‹åŒ–æ“ä½œï¼Œå°±æ˜¯ Class åˆ©ç”¨åå°„æ¥è¿›è¡Œå®ä¾‹åŒ–
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#007020;font-weight:bold">return</span> firstInstance<span style="color:#666">((</span>Class<span style="color:#666">)</span> obj<span style="color:#666">);</span>
        <span style="color:#666">}</span>
        <span style="color:#60a0b0;font-style:italic">// éåˆæ¬¡å®ä¾‹åŒ–ï¼Œåˆ™æ˜¯ä» ClassLoaderData ä¸­å¾—åˆ°çš„ä¹‹å‰ç»´æŠ¤çš„å†…å®¹
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#007020;font-weight:bold">return</span> nextInstance<span style="color:#666">(</span>obj<span style="color:#666">);</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>RuntimeException e<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> e<span style="color:#666">;</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>Error e<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> e<span style="color:#666">;</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>Exception e<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> CodeGenerationException<span style="color:#666">(</span>e<span style="color:#666">);</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>è¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸”æ˜¯è°ƒç”¨é“¾æ¯”è¾ƒé‡è¦çš„ä¸€ç¯ã€‚<strong>Seq 4.</strong> å’Œ <strong>Seq 5.</strong> å°†ä½œä¸ºå…¶å­å†…å®¹è¿›è¡Œè°ƒç”¨ï¼Œä½†ä¸ºäº†æœ¬åšæ–‡çš„ç»“æ„å®Œæ•´ï¼Œ <em>Seq 4. &amp; Seq5.</em> çš„æ ‡é¢˜ä¸ <em>Seq 3.</em> æ ‡é¢˜åŒçº§</p>
<h3 id="seq-4">Seq 4.</h3>
<p>é¦–å…ˆåº”è¯¥è®¤è¯†åˆ°ï¼Œæ¯ä¸ªè¢«åŠ è½½çš„ Class ï¼Œåœ¨ <code>equal</code> çš„åˆ¤æ–­è¿‡ç¨‹ä¸­ï¼Œä¾æ®çš„æ˜¯åŒä¸€ä¸ª ClassLoader åŠ è½½çš„åŒä¸€ Class æ‰è¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„ï¼Œå¦åˆ™å³ä½¿ Class æ˜¯åŒä¸€ä¸ªï¼Œä½†ä»ä¼šè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„(ç”±ä¸åŒçš„ ClassLoader åŠ è½½)ã€‚</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> ClassLoader <span style="color:#06287e">getClassLoader</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    ClassLoader t <span style="color:#666">=</span> classLoader<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>t <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        t <span style="color:#666">=</span> getDefaultClassLoader<span style="color:#666">();</span>
    <span style="color:#666">}</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>t <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        t <span style="color:#666">=</span> getClass<span style="color:#666">().</span><span style="color:#4070a0">getClassLoader</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>t <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        t <span style="color:#666">=</span> Thread<span style="color:#666">.</span><span style="color:#4070a0">currentThread</span><span style="color:#666">().</span><span style="color:#4070a0">getContextClassLoader</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>t <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> IllegalStateException<span style="color:#666">(</span><span style="color:#4070a0">&#34;Cannot determine classloader&#34;</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
    <span style="color:#007020;font-weight:bold">return</span> t<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><p>å› æ­¤ï¼Œåœ¨è¿™éƒ¨åˆ†ä¸­ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ç”±å“ªä¸ª ClassLoader è¿›è¡ŒåŠ è½½çš„å·¥ä½œã€‚<code>getClassLoader()</code> çš„ç¡®å®šé¡ºåºæ˜¯:</p>
<ol>
<li>å…·ä½“å®ç°ç±»å£°æ˜çš„ <strong>é»˜è®¤ ClassLoader</strong> ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§</li>
<li>åŠ è½½å½“å‰ç±»(è¿™é‡Œæ˜¯ Enhancer) çš„ ClassLoader ä¸ºç¬¬äºŒä¼˜å…ˆçº§</li>
<li><strong>å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ ClassLoader</strong> ä¸ºç¬¬ä¸‰ä¼˜å…ˆçº§</li>
<li>æŠ›å‡ºå¼‚å¸¸</li>
</ol>
<p>å›åˆ° <strong>Seq 3.</strong> çš„å†…å®¹ï¼Œ
ä¸‹ä¸€æ­¥æ˜¯å¯¹å½“å‰è¿™ä¸ª<strong>AbstractClassGenerator</strong> ç»´æŠ¤çš„ CACHE è¿›è¡Œå¤„ç†ï¼Œå¦‚æœåœ¨ CACHE ä¸­èƒ½å¤Ÿå¾—åˆ°ä»¥ç¡®å®šçš„ ClassLoader ä¸º Key çš„é”®å€¼å¯¹ï¼Œåˆ™ç›´æ¥è·å– ClassLoader å¯¹åº”çš„å€¼ï¼Œå¦åˆ™å°†è¿›è¡Œåˆå§‹åŒ–æ„å»ºä¸€ä¸ªæ–°çš„ ClassLoaderData ä½œä¸ºè¿™ä¸ª ClassLoader çš„å€¼ã€‚</p>
<h3 id="seq-5">Seq 5.</h3>
<p>åœ¨æ„å»º ClassLoaderData çš„è¿‡ç¨‹ä¸­ï¼Œæœ€é‡è¦çš„ä¸€æ­¥:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#06287e">ClassLoaderData</span><span style="color:#666">(</span>ClassLoader classLoader<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// ClassLoader ä¸å¯ä¸ºç©º
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>classLoader <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span><span style="color:#4070a0">&#34;classLoader == null is not yet supported&#34;</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
    <span style="color:#60a0b0;font-style:italic">// æ„å»º ClassLoader çš„å¼±å¼•ç”¨
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">classLoader</span> <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> WeakReference<span style="color:#666">&lt;</span>ClassLoader<span style="color:#666">&gt;(</span>classLoader<span style="color:#666">);</span>
    <span style="color:#60a0b0;font-style:italic">// å†™äº†ä¸ªåç½®è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‡’åŠ è½½ï¼Œåªæœ‰è°ƒç”¨äº† load.apply(...) æ‰ä¼šæ„å»º ç”Ÿæˆç±»
</span><span style="color:#60a0b0;font-style:italic"></span>    Function<span style="color:#666">&lt;</span>AbstractClassGenerator<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> load <span style="color:#666">=</span>
            <span style="color:#007020;font-weight:bold">new</span> Function<span style="color:#666">&lt;</span>AbstractClassGenerator<span style="color:#666">,</span> Object<span style="color:#666">&gt;()</span> <span style="color:#666">{</span>
                <span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">apply</span><span style="color:#666">(</span>AbstractClassGenerator gen<span style="color:#666">)</span> <span style="color:#666">{</span>
                    Class klass <span style="color:#666">=</span> gen<span style="color:#666">.</span><span style="color:#4070a0">generate</span><span style="color:#666">(</span>ClassLoaderData<span style="color:#666">.</span><span style="color:#4070a0">this</span><span style="color:#666">);</span>
                    <span style="color:#007020;font-weight:bold">return</span> gen<span style="color:#666">.</span><span style="color:#4070a0">wrapCachedClass</span><span style="color:#666">(</span>klass<span style="color:#666">);</span>
                <span style="color:#666">}</span>
            <span style="color:#666">};</span>
    generatedClasses <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> LoadingCache<span style="color:#666">&lt;</span>AbstractClassGenerator<span style="color:#666">,</span> Object<span style="color:#666">,</span> Object<span style="color:#666">&gt;(</span>GET_KEY<span style="color:#666">,</span> load<span style="color:#666">);</span>
<span style="color:#666">}</span>
</code></pre></div><p>æ„å»ºäº†ä¸€ä¸ª Function å®ä¾‹ï¼Œè¿™ä¸ª Function ä½œä¸ºå‡½æ•°å¼æ¥å£ï¼Œé¢„å®šä¹‰æ‰§è¡Œçš„å…·ä½“æµç¨‹ï¼Œä½†ç”±ä¸Šä¸‹æ–‡ç¡®å®šå…·ä½“çš„è°ƒç”¨æ—¶åˆ»ã€‚</p>
<h3 id="seq-6">Seq 6.</h3>
<p>åœ¨æ­£ç¡®å¾—åˆ°äº† ClassLoader å¯¹åº”çš„ ClassLoaderData ä¹‹åï¼ŒClassLoaderData çš„ <code>get(...)</code> æ–¹æ³•å°†åœ¨ç‰¹å®šçš„ ClassLoader ä¹‹ä¸‹ï¼Œè¿›è¡Œæ›´å…·ä½“çš„åŠ è½½æ–°ç”Ÿæˆç±»çš„å·¥ä½œã€‚
å½“ç„¶ï¼Œè¿™é‡Œçš„å‰ææ˜¯æ–°çš„ç”Ÿæˆç±»çš„å­—èŠ‚ç å·²ç»è¢«æ„å»º:)</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">get</span><span style="color:#666">(</span>AbstractClassGenerator gen<span style="color:#666">,</span> <span style="color:#902000">boolean</span> useCache<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// æ ‡è®°ä¸ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥æ„å»º æ–°çš„ç”Ÿæˆç±»
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(!</span>useCache<span style="color:#666">)</span> <span style="color:#666">{</span>
      <span style="color:#007020;font-weight:bold">return</span> gen<span style="color:#666">.</span><span style="color:#4070a0">generate</span><span style="color:#666">(</span>ClassLoaderData<span style="color:#666">.</span><span style="color:#4070a0">this</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
    <span style="color:#60a0b0;font-style:italic">// ä½¿ç”¨ç¼“å†²çš„æƒ…å†µ
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">else</span> <span style="color:#666">{</span>
      Object cachedValue <span style="color:#666">=</span> generatedClasses<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">(</span>gen<span style="color:#666">);</span>
      <span style="color:#007020;font-weight:bold">return</span> gen<span style="color:#666">.</span><span style="color:#4070a0">unwrapCachedValue</span><span style="color:#666">(</span>cachedValue<span style="color:#666">);</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ° <code>gen.generate(ClassLoaderData.this)</code> è¿™æ®µä»£ç åœ¨ <code>get(...)</code> æ–¹æ³•å’Œä¸Šä¸€å°èŠ‚ <code>ClassLoaderData(...)</code> æ„é€ æ–¹æ³•çš„ Function å‡½æ•°å¼å®ä¾‹éƒ½å‡ºç°äº†ã€‚</p>
<p>å®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯è§¦å‘ ClassLoader æ¥åŠ è½½åŠ¨æ€ç”Ÿæˆçš„æ–° Class çš„å”¯ä¸€å…¥å£ã€‚</p>
<p><em>åˆ¤æ–­é€»è¾‘</em> çš„ <code>else</code> å†…å®¹çš„å”¯ä¸€åŒºåˆ«å°±åœ¨äºå…¶æ„å»ºçš„æ˜¯ä¸€ä¸ªåŠ è½½ç¼“å­˜ï¼Œå°†çœŸæ­£è§¦å‘ gen.generate(ClassLoaderData.this) çš„é€»è¾‘å»¶è¿Ÿã€‚(ä¸è¿‡ï¼Œæœ€ç»ˆä¹Ÿè¿˜æ˜¯ä¼šè¿›è¡Œè°ƒç”¨çš„ï¼Œ:) è¿™æ˜¯æ¯‹åº¸ç½®ç–‘çš„)ã€‚</p>
<h3 id="seq-7">Seq 7.</h3>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">protected</span> Class <span style="color:#06287e">generate</span><span style="color:#666">(</span>ClassLoaderData data<span style="color:#666">)</span> <span style="color:#666">{</span>
    Class gen<span style="color:#666">;</span>
    Object save <span style="color:#666">=</span> CURRENT<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">();</span>
    CURRENT<span style="color:#666">.</span><span style="color:#4070a0">set</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
    <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
        <span style="color:#60a0b0;font-style:italic">// æ‹¿åˆ°ç”¨äºåŠ è½½ç”Ÿæˆç±»çš„ ClassLoader
</span><span style="color:#60a0b0;font-style:italic"></span>        ClassLoader classLoader <span style="color:#666">=</span> data<span style="color:#666">.</span><span style="color:#4070a0">getClassLoader</span><span style="color:#666">();</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>classLoader <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> IllegalStateException<span style="color:#666">(</span><span style="color:#4070a0">&#34;ClassLoader is null while trying to define class &#34;</span> <span style="color:#666">+</span>
                    getClassName<span style="color:#666">()</span> <span style="color:#666">+</span> <span style="color:#4070a0">&#34;. It seems that the loader has been expired from a weak reference somehow. &#34;</span> <span style="color:#666">+</span>
                    <span style="color:#4070a0">&#34;Please file an issue at cglib&#39;s issue tracker.&#34;</span><span style="color:#666">);</span>
        <span style="color:#666">}</span>
        <span style="color:#60a0b0;font-style:italic">// æ„å»ºä¸€ä¸ªåˆæ³•çš„ ç”Ÿæˆç±» çš„ç±»å(éé‡å¤)
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#007020;font-weight:bold">synchronized</span> <span style="color:#666">(</span>classLoader<span style="color:#666">)</span> <span style="color:#666">{</span>
          String name <span style="color:#666">=</span> generateClassName<span style="color:#666">(</span>data<span style="color:#666">.</span><span style="color:#4070a0">getUniqueNamePredicate</span><span style="color:#666">());</span>
          data<span style="color:#666">.</span><span style="color:#4070a0">reserveName</span><span style="color:#666">(</span>name<span style="color:#666">);</span>
          <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">setClassName</span><span style="color:#666">(</span>name<span style="color:#666">);</span>
        <span style="color:#666">}</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>attemptLoad<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
                <span style="color:#60a0b0;font-style:italic">// å°è¯•ç›´æ¥é€šè¿‡ ClassLoader è¿›è¡ŒåŠ è½½
</span><span style="color:#60a0b0;font-style:italic"></span>                gen <span style="color:#666">=</span> classLoader<span style="color:#666">.</span><span style="color:#4070a0">loadClass</span><span style="color:#666">(</span>getClassName<span style="color:#666">());</span>
                <span style="color:#007020;font-weight:bold">return</span> gen<span style="color:#666">;</span>
            <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>ClassNotFoundException e<span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#60a0b0;font-style:italic">// ignore
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
        <span style="color:#60a0b0;font-style:italic">// ç­–ç•¥ä¸‹çš„ç”Ÿæˆç±»æ„å»ºæ–¹æ³•
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#902000">byte</span><span style="color:#666">[]</span> b <span style="color:#666">=</span> strategy<span style="color:#666">.</span><span style="color:#4070a0">generate</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
        <span style="color:#60a0b0;font-style:italic">// é€šè¿‡è§£æå­—èŠ‚ç çš„å½¢å¼è·å– ç”Ÿæˆç±»çš„ className
</span><span style="color:#60a0b0;font-style:italic"></span>        String className <span style="color:#666">=</span> ClassNameReader<span style="color:#666">.</span><span style="color:#4070a0">getClassName</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> ClassReader<span style="color:#666">(</span>b<span style="color:#666">));</span>
        ProtectionDomain protectionDomain <span style="color:#666">=</span> getProtectionDomain<span style="color:#666">();</span>
        <span style="color:#007020;font-weight:bold">synchronized</span> <span style="color:#666">(</span>classLoader<span style="color:#666">)</span> <span style="color:#666">{</span> <span style="color:#60a0b0;font-style:italic">// just in case
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#60a0b0;font-style:italic">// åå°„çš„å½¢å¼åŠ è½½ Class ç±»
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>protectionDomain <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                gen <span style="color:#666">=</span> ReflectUtils<span style="color:#666">.</span><span style="color:#4070a0">defineClass</span><span style="color:#666">(</span>className<span style="color:#666">,</span> b<span style="color:#666">,</span> classLoader<span style="color:#666">);</span>
            <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#666">{</span>
                gen <span style="color:#666">=</span> ReflectUtils<span style="color:#666">.</span><span style="color:#4070a0">defineClass</span><span style="color:#666">(</span>className<span style="color:#666">,</span> b<span style="color:#666">,</span> classLoader<span style="color:#666">,</span> protectionDomain<span style="color:#666">);</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
        <span style="color:#007020;font-weight:bold">return</span> gen<span style="color:#666">;</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>RuntimeException e<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> e<span style="color:#666">;</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>Error e<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> e<span style="color:#666">;</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>Exception e<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> CodeGenerationException<span style="color:#666">(</span>e<span style="color:#666">);</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">finally</span> <span style="color:#666">{</span>
        CURRENT<span style="color:#666">.</span><span style="color:#4070a0">set</span><span style="color:#666">(</span>save<span style="color:#666">);</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯æ“ä½œå­—èŠ‚ç ï¼ŒåŠ è½½ Class çš„æ ¸å¿ƒè°ƒåº¦æ–¹æ³•ã€‚</p>
<p>å¯ä»¥çœ‹åˆ° <code>generateClassName(...)</code> æ–¹æ³•å°†æ„å»ºä¸€ä¸ªå½“å‰ ClassLoader ä¸‹å”¯ä¸€, ä¸é‡å¤çš„æ–°çš„ç±»åã€‚</p>
<p><code>strategy.generate(this)</code> å°†é€šè¿‡ç‰¹å®šç­–ç•¥å®ç°çš„å½¢å¼ç”Ÿæˆæ–°çš„å­—èŠ‚ç </p>
<p><code>ReflectUtils.defineClass(className, b, classLoader)</code> å°†ä½¿ç”¨åå°„ä½¿å¾— ClassLoader æ¥åŠ è½½è¿™ä¸ªæ–°çš„ç”Ÿæˆç±»ã€‚</p>
<h3 id="seq-8">Seq 8.</h3>
<p>ç”Ÿæˆæ–°çš„ä¸é‡å¤ç±»åè¿™éƒ¨åˆ†ä¸åšè¿‡å¤šé™ˆè¿°ï¼Œå¯ä»¥ç®€å•è¿›è¡Œäº†è§£ï¼Œå¹¶ç†Ÿæ‚‰ CGlib é»˜è®¤çš„æ–°ç±»åçš„å‘½åè§„åˆ™</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">// DefaultNamePolicy
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">public</span> String <span style="color:#06287e">getClassName</span><span style="color:#666">(</span>String prefix<span style="color:#666">,</span> String source<span style="color:#666">,</span> Object key<span style="color:#666">,</span> Predicate names<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>prefix <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        prefix <span style="color:#666">=</span> <span style="color:#4070a0">&#34;net.sf.cglib.empty.Object&#34;</span><span style="color:#666">;</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>prefix<span style="color:#666">.</span><span style="color:#4070a0">startsWith</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;java&#34;</span><span style="color:#666">))</span> <span style="color:#666">{</span>
        prefix <span style="color:#666">=</span> <span style="color:#4070a0">&#34;$&#34;</span> <span style="color:#666">+</span> prefix<span style="color:#666">;</span>
    <span style="color:#666">}</span>
    String base <span style="color:#666">=</span>
        prefix <span style="color:#666">+</span> <span style="color:#4070a0">&#34;$$&#34;</span> <span style="color:#666">+</span>
        source<span style="color:#666">.</span><span style="color:#4070a0">substring</span><span style="color:#666">(</span>source<span style="color:#666">.</span><span style="color:#4070a0">lastIndexOf</span><span style="color:#666">(</span><span style="color:#4070a0">&#39;.&#39;</span><span style="color:#666">)</span> <span style="color:#666">+</span> 1<span style="color:#666">)</span> <span style="color:#666">+</span>
        getTag<span style="color:#666">()</span> <span style="color:#666">+</span> <span style="color:#4070a0">&#34;$$&#34;</span> <span style="color:#666">+</span>
        Integer<span style="color:#666">.</span><span style="color:#4070a0">toHexString</span><span style="color:#666">(</span>STRESS_HASH_CODE <span style="color:#666">?</span> 0 <span style="color:#666">:</span> key<span style="color:#666">.</span><span style="color:#4070a0">hashCode</span><span style="color:#666">());</span>
    String attempt <span style="color:#666">=</span> base<span style="color:#666">;</span>
    <span style="color:#902000">int</span> index <span style="color:#666">=</span> 2<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">while</span> <span style="color:#666">(</span>names<span style="color:#666">.</span><span style="color:#4070a0">evaluate</span><span style="color:#666">(</span>attempt<span style="color:#666">))</span>
        attempt <span style="color:#666">=</span> base <span style="color:#666">+</span> <span style="color:#4070a0">&#34;_&#34;</span> <span style="color:#666">+</span> index<span style="color:#666">++;</span>
    <span style="color:#007020;font-weight:bold">return</span> attempt<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><h3 id="seq-9">Seq 9.</h3>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">// ä¸‹åˆ—æ˜¯ DefaultGeneratorStrategy çš„å®ç°
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">byte</span><span style="color:#666">[]</span> <span style="color:#06287e">generate</span><span style="color:#666">(</span>ClassGenerator cg<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
    DebuggingClassWriter cw <span style="color:#666">=</span> getClassVisitor<span style="color:#666">();</span>
    transform<span style="color:#666">(</span>cg<span style="color:#666">).</span><span style="color:#4070a0">generateClass</span><span style="color:#666">(</span>cw<span style="color:#666">);</span>
    <span style="color:#007020;font-weight:bold">return</span> transform<span style="color:#666">(</span>cw<span style="color:#666">.</span><span style="color:#4070a0">toByteArray</span><span style="color:#666">());</span>
<span style="color:#666">}</span>
</code></pre></div><h3 id="seq-10">Seq 10.</h3>
<p>è°ƒç”¨ <code>generateClass(ClassVisitor)</code> å°†è·å¾—åˆ°æ–°ç±»çš„å­—èŠ‚ç ã€‚</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">generateClass</span><span style="color:#666">(</span>ClassVisitor v<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// ç¡®å®šç”Ÿæˆç±»çš„ çˆ¶ç±»
</span><span style="color:#60a0b0;font-style:italic"></span>    Class sc <span style="color:#666">=</span> <span style="color:#666">(</span>superclass <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">?</span> Object<span style="color:#666">.</span><span style="color:#4070a0">class</span> <span style="color:#666">:</span> superclass<span style="color:#666">;</span>

    <span style="color:#60a0b0;font-style:italic">// çˆ¶ç±»æ ‡è¯†ç¬¦ä¸å¯ä»¥ä¸º final
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>TypeUtils<span style="color:#666">.</span><span style="color:#4070a0">isFinal</span><span style="color:#666">(</span>sc<span style="color:#666">.</span><span style="color:#4070a0">getModifiers</span><span style="color:#666">()))</span>
        <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span><span style="color:#4070a0">&#34;Cannot subclass final class &#34;</span> <span style="color:#666">+</span> sc<span style="color:#666">.</span><span style="color:#4070a0">getName</span><span style="color:#666">());</span>
    <span style="color:#60a0b0;font-style:italic">// è·å–çˆ¶ç±»ç›´æ¥å£°æ˜çš„æ„é€ æ–¹æ³•
</span><span style="color:#60a0b0;font-style:italic"></span>    List constructors <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ArrayList<span style="color:#666">(</span>Arrays<span style="color:#666">.</span><span style="color:#4070a0">asList</span><span style="color:#666">(</span>sc<span style="color:#666">.</span><span style="color:#4070a0">getDeclaredConstructors</span><span style="color:#666">()));</span>
    filterConstructors<span style="color:#666">(</span>sc<span style="color:#666">,</span> constructors<span style="color:#666">);</span>

    <span style="color:#60a0b0;font-style:italic">// Order is very important: must add superclass, then
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#60a0b0;font-style:italic">// its superclass chain, then each interface and
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#60a0b0;font-style:italic">// its superinterfaces.
</span><span style="color:#60a0b0;font-style:italic"></span>    List actualMethods <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ArrayList<span style="color:#666">();</span>
    List interfaceMethods <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ArrayList<span style="color:#666">();</span>
    <span style="color:#007020;font-weight:bold">final</span> Set forcePublic <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> HashSet<span style="color:#666">();</span>
    <span style="color:#60a0b0;font-style:italic">// ä»çˆ¶ç±»ä¸­æå–å„ç§ä¿¡æ¯
</span><span style="color:#60a0b0;font-style:italic"></span>    getMethods<span style="color:#666">(</span>sc<span style="color:#666">,</span> interfaces<span style="color:#666">,</span> actualMethods<span style="color:#666">,</span> interfaceMethods<span style="color:#666">,</span> forcePublic<span style="color:#666">);</span>

    List methods <span style="color:#666">=</span> CollectionUtils<span style="color:#666">.</span><span style="color:#4070a0">transform</span><span style="color:#666">(</span>actualMethods<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">new</span> Transformer<span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">transform</span><span style="color:#666">(</span>Object value<span style="color:#666">)</span> <span style="color:#666">{</span>
            Method method <span style="color:#666">=</span> <span style="color:#666">(</span>Method<span style="color:#666">)</span>value<span style="color:#666">;</span>
            <span style="color:#902000">int</span> modifiers <span style="color:#666">=</span> Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_FINAL</span>
                <span style="color:#666">|</span> <span style="color:#666">(</span>method<span style="color:#666">.</span><span style="color:#4070a0">getModifiers</span><span style="color:#666">()</span>
                   <span style="color:#666">&amp;</span> <span style="color:#666">~</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_ABSTRACT</span>
                   <span style="color:#666">&amp;</span> <span style="color:#666">~</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_NATIVE</span>
                   <span style="color:#666">&amp;</span> <span style="color:#666">~</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_SYNCHRONIZED</span><span style="color:#666">);</span>
            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>forcePublic<span style="color:#666">.</span><span style="color:#4070a0">contains</span><span style="color:#666">(</span>MethodWrapper<span style="color:#666">.</span><span style="color:#4070a0">create</span><span style="color:#666">(</span>method<span style="color:#666">)))</span> <span style="color:#666">{</span>
                modifiers <span style="color:#666">=</span> <span style="color:#666">(</span>modifiers <span style="color:#666">&amp;</span> <span style="color:#666">~</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PROTECTED</span><span style="color:#666">)</span> <span style="color:#666">|</span> Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PUBLIC</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
            <span style="color:#007020;font-weight:bold">return</span> ReflectUtils<span style="color:#666">.</span><span style="color:#4070a0">getMethodInfo</span><span style="color:#666">(</span>method<span style="color:#666">,</span> modifiers<span style="color:#666">);</span>
        <span style="color:#666">}</span>
    <span style="color:#666">});</span>

    ClassEmitter e <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ClassEmitter<span style="color:#666">(</span>v<span style="color:#666">);</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>currentData <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
    e<span style="color:#666">.</span><span style="color:#4070a0">begin_class</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">V1_2</span><span style="color:#666">,</span>
                  Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PUBLIC</span><span style="color:#666">,</span>
                  getClassName<span style="color:#666">(),</span>
                  Type<span style="color:#666">.</span><span style="color:#4070a0">getType</span><span style="color:#666">(</span>sc<span style="color:#666">),</span>
                  <span style="color:#666">(</span>useFactory <span style="color:#666">?</span>
                   TypeUtils<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">(</span>TypeUtils<span style="color:#666">.</span><span style="color:#4070a0">getTypes</span><span style="color:#666">(</span>interfaces<span style="color:#666">),</span> FACTORY<span style="color:#666">)</span> <span style="color:#666">:</span>
                   TypeUtils<span style="color:#666">.</span><span style="color:#4070a0">getTypes</span><span style="color:#666">(</span>interfaces<span style="color:#666">)),</span>
                  Constants<span style="color:#666">.</span><span style="color:#4070a0">SOURCE_FILE</span><span style="color:#666">);</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#666">{</span>
        e<span style="color:#666">.</span><span style="color:#4070a0">begin_class</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">V1_2</span><span style="color:#666">,</span>
                Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PUBLIC</span><span style="color:#666">,</span>
                getClassName<span style="color:#666">(),</span>
                <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">,</span>
                <span style="color:#007020;font-weight:bold">new</span> Type<span style="color:#666">[]{</span>FACTORY<span style="color:#666">},</span>
                Constants<span style="color:#666">.</span><span style="color:#4070a0">SOURCE_FILE</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
    List constructorInfo <span style="color:#666">=</span> CollectionUtils<span style="color:#666">.</span><span style="color:#4070a0">transform</span><span style="color:#666">(</span>constructors<span style="color:#666">,</span> MethodInfoTransformer<span style="color:#666">.</span><span style="color:#4070a0">getInstance</span><span style="color:#666">());</span>

    e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PRIVATE</span><span style="color:#666">,</span> BOUND_FIELD<span style="color:#666">,</span> Type<span style="color:#666">.</span><span style="color:#4070a0">BOOLEAN_TYPE</span><span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
    e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PUBLIC</span> <span style="color:#666">|</span> Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_STATIC</span><span style="color:#666">,</span> FACTORY_DATA_FIELD<span style="color:#666">,</span> OBJECT_TYPE<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(!</span>interceptDuringConstruction<span style="color:#666">)</span> <span style="color:#666">{</span>
        e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PRIVATE</span><span style="color:#666">,</span> CONSTRUCTED_FIELD<span style="color:#666">,</span> Type<span style="color:#666">.</span><span style="color:#4070a0">BOOLEAN_TYPE</span><span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
    e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">PRIVATE_FINAL_STATIC</span><span style="color:#666">,</span> THREAD_CALLBACKS_FIELD<span style="color:#666">,</span> THREAD_LOCAL<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
    e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">PRIVATE_FINAL_STATIC</span><span style="color:#666">,</span> STATIC_CALLBACKS_FIELD<span style="color:#666">,</span> CALLBACK_ARRAY<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>serialVersionUID <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">PRIVATE_FINAL_STATIC</span><span style="color:#666">,</span> Constants<span style="color:#666">.</span><span style="color:#4070a0">SUID_FIELD_NAME</span><span style="color:#666">,</span> Type<span style="color:#666">.</span><span style="color:#4070a0">LONG_TYPE</span><span style="color:#666">,</span> serialVersionUID<span style="color:#666">);</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#902000">int</span> i <span style="color:#666">=</span> 0<span style="color:#666">;</span> i <span style="color:#666">&lt;</span> callbackTypes<span style="color:#666">.</span><span style="color:#4070a0">length</span><span style="color:#666">;</span> i<span style="color:#666">++)</span> <span style="color:#666">{</span>
        e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PRIVATE</span><span style="color:#666">,</span> getCallbackField<span style="color:#666">(</span>i<span style="color:#666">),</span> callbackTypes<span style="color:#666">[</span>i<span style="color:#666">],</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
    <span style="color:#60a0b0;font-style:italic">// This is declared private to avoid &#34;public field&#34; pollution
</span><span style="color:#60a0b0;font-style:italic"></span>    e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PRIVATE</span> <span style="color:#666">|</span> Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_STATIC</span><span style="color:#666">,</span> CALLBACK_FILTER_FIELD<span style="color:#666">,</span> OBJECT_TYPE<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>

    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>currentData <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        emitMethods<span style="color:#666">(</span>e<span style="color:#666">,</span> methods<span style="color:#666">,</span> actualMethods<span style="color:#666">);</span>
        emitConstructors<span style="color:#666">(</span>e<span style="color:#666">,</span> constructorInfo<span style="color:#666">);</span>
    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#666">{</span>
        emitDefaultConstructor<span style="color:#666">(</span>e<span style="color:#666">);</span>
    <span style="color:#666">}</span>
    emitSetThreadCallbacks<span style="color:#666">(</span>e<span style="color:#666">);</span>
    emitSetStaticCallbacks<span style="color:#666">(</span>e<span style="color:#666">);</span>
    emitBindCallbacks<span style="color:#666">(</span>e<span style="color:#666">);</span>

    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>useFactory <span style="color:#666">||</span> currentData <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#902000">int</span><span style="color:#666">[]</span> keys <span style="color:#666">=</span> getCallbackKeys<span style="color:#666">();</span>
        emitNewInstanceCallbacks<span style="color:#666">(</span>e<span style="color:#666">);</span>
        emitNewInstanceCallback<span style="color:#666">(</span>e<span style="color:#666">);</span>
        emitNewInstanceMultiarg<span style="color:#666">(</span>e<span style="color:#666">,</span> constructorInfo<span style="color:#666">);</span>
        emitGetCallback<span style="color:#666">(</span>e<span style="color:#666">,</span> keys<span style="color:#666">);</span>
        emitSetCallback<span style="color:#666">(</span>e<span style="color:#666">,</span> keys<span style="color:#666">);</span>
        emitGetCallbacks<span style="color:#666">(</span>e<span style="color:#666">);</span>
        emitSetCallbacks<span style="color:#666">(</span>e<span style="color:#666">);</span>
    <span style="color:#666">}</span>

    e<span style="color:#666">.</span><span style="color:#4070a0">end_class</span><span style="color:#666">();</span>
<span style="color:#666">}</span>
</code></pre></div><p><code>generateClass(...)</code> æ‰§è¡Œçš„æ“ä½œå’Œ ASM åº“çš„ ClassVisitor è®¿é—® Class æ–‡ä»¶ç»“æ„çš„æµç¨‹åŸºæœ¬ç±»ä¼¼ã€‚</p>
<p>ä»ä¸Šè¿°æˆªå–åˆ°çš„éƒ¨åˆ†ä»£ç ï¼Œä¾‹å¦‚:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e<span style="color:#666">.</span><span style="color:#4070a0">begin_class</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">V1_2</span><span style="color:#666">,</span> Constants<span style="color:#666">.</span><span style="color:#4070a0">ACC_PUBLIC</span><span style="color:#666">,</span> getClassName<span style="color:#666">(),</span> Type<span style="color:#666">.</span><span style="color:#4070a0">getType</span><span style="color:#666">(</span>sc<span style="color:#666">),</span> 
        <span style="color:#666">(</span>useFactory <span style="color:#666">?</span> TypeUtils<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">(</span>TypeUtils<span style="color:#666">.</span><span style="color:#4070a0">getTypes</span><span style="color:#666">(</span>interfaces<span style="color:#666">),</span> FACTORY<span style="color:#666">)</span> <span style="color:#666">:</span> TypeUtils<span style="color:#666">.</span><span style="color:#4070a0">getTypes</span><span style="color:#666">(</span>interfaces<span style="color:#666">)),</span>
        Constants<span style="color:#666">.</span><span style="color:#4070a0">SOURCE_FILE</span><span style="color:#666">);</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e<span style="color:#666">.</span><span style="color:#4070a0">declare_field</span><span style="color:#666">(</span>Constants<span style="color:#666">.</span><span style="color:#4070a0">PRIVATE_FINAL_STATIC</span><span style="color:#666">,</span> THREAD_CALLBACKS_FIELD<span style="color:#666">,</span> THREAD_LOCAL<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
</code></pre></div><p>éƒ½ä¸ <code>classVisitor.visit(...)</code> ä»¥åŠ <code>classVisitor.visitField(...)</code> ç›¸å½“ç±»ä¼¼ã€‚è€Œäº‹å®ä¸Šï¼Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ä¹Ÿç¡®å®è°ƒç”¨äº† cv.visitXxx(&hellip;) ã€‚
æ¯•ç«Ÿï¼Œä½œä¸º CGlib å”¯ä¸€ä¾èµ–çš„åº“ï¼ŒASM è¿˜æ˜¯å¯ä»¥è¯´æ˜¯éš¾ä»¥æ›¿ä»£çš„(æ—¢ç„¶å·²ç»æœ‰äº†å¯ç”¨çš„è½®å­ï¼Œåˆä½•å¿…é‡å¤é€ å‘¢?)</p>
<h2 id="æ„é€ çš„å®ä¾‹">æ„é€ çš„å®ä¾‹</h2>
<p>ä¸‹é¢å°†å±•ç¤ºé€šè¿‡ CGlib ç”Ÿæˆçš„æ–°çš„ç±»(ç”±äºç”Ÿæˆçš„æ˜¯å­—èŠ‚ç ï¼Œæ‡’å¾—å†è‡ªè¡Œè§£æ ClassFile çš„å†…å®¹ï¼Œæ‰€æœ‰ç›´æ¥ç”¨ <code>IDEA</code> åšäº†å­—èŠ‚ç çš„è§£æ)</p>
<p><strong>é¦–å…ˆå±•ç¤ºçš„éœ€è¦è¿›è¡Œå¢å¼ºçš„ SampleClass çš„å…·ä½“å†…å®¹</strong></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SampleClass</span> <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:bold">public</span> String <span style="color:#06287e">test</span><span style="color:#666">(</span>String input<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;Hello World!&#34;</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p><strong>ç”¨äºå¢å¼ºçš„ç®€å•ä»£ç </strong></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">// çœç•¥éƒ¨åˆ†ä»£ç 
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">main</span><span style="color:#666">(</span>String<span style="color:#666">...</span> args<span style="color:#666">)</span> <span style="color:#666">{</span>
    Enhancer enhancer <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Enhancer<span style="color:#666">();</span>
    enhancer<span style="color:#666">.</span><span style="color:#4070a0">setSuperclass</span><span style="color:#666">(</span>SampleClass<span style="color:#666">.</span><span style="color:#4070a0">class</span><span style="color:#666">);</span>
    enhancer<span style="color:#666">.</span><span style="color:#4070a0">setCallback</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> FixedValue<span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">loadObject</span><span style="color:#666">()</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;Hello cglib!&#34;</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">});</span>
    SampleClass proxy <span style="color:#666">=</span> <span style="color:#666">(</span>SampleClass<span style="color:#666">)</span> enhancer<span style="color:#666">.</span><span style="color:#4070a0">create</span><span style="color:#666">();</span>
<span style="color:#666">}</span>
</code></pre></div><p><strong>åŠ¨æ€ç”Ÿæˆçš„æ–°çš„ç±»</strong></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">//
</span><span style="color:#60a0b0;font-style:italic">// Source code recreated from a .class file by IntelliJ IDEA
</span><span style="color:#60a0b0;font-style:italic">// (powered by Fernflower decompiler)
</span><span style="color:#60a0b0;font-style:italic">//
</span><span style="color:#60a0b0;font-style:italic"></span>
<span style="color:#60a0b0;font-style:italic">// ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œåªæ˜¯ CGlib ä¿è¯ç”Ÿæˆç±»ä¸åŸæœ‰çš„ç±»ä¸€å®šå±äºåŒä¸€åŒ…ä¸‹ï¼Œå·æ‡’ç›´æ¥æŠŠ SampleClass å†™åœ¨ CGlib é¡¹ç›®é‡Œäº†
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">package</span> <span style="color:#0e84b5;font-weight:bold">net.sf.cglib.samples</span><span style="color:#666">;</span>

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">net.sf.cglib.proxy.Callback</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">net.sf.cglib.proxy.Factory</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">net.sf.cglib.proxy.FixedValue</span><span style="color:#666">;</span>

<span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic"> * æ–°çš„ç±»åï¼Œé€šè¿‡ $$EnhancerByCGLIB ä»¥åŠ $$7cd64b81(è¿™ä¸ªæ˜¯å“ˆå¸Œå€¼) å¯¹ç±»åè¿›è¡Œå”¯ä¸€åŒºåˆ† 
</span><span style="color:#60a0b0;font-style:italic"> * å¦‚æœè¿˜æ˜¯é‡å¤äº†ï¼Œåœ¨åŠ¨æ€ç”Ÿæˆå‰ä¼šè¿›è¡Œç±»åçš„æ£€æµ‹ï¼Œå¹¶é€šè¿‡å¢åŠ åºå· &#34;_&lt;index&gt;&#34; çš„å½¢å¼è¿›è¡Œè¿›ä¸€æ­¥åŒºåˆ†
</span><span style="color:#60a0b0;font-style:italic"> *
</span><span style="color:#60a0b0;font-style:italic"> * å¯ä»¥çœ‹åˆ°æ–°ç”Ÿæˆçš„ç±»ç»§æ‰¿äº† SampleClass 
</span><span style="color:#60a0b0;font-style:italic"> */</span>
<span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SampleClass$$EnhancerByCGLIB$$7cd64b81</span> <span style="color:#007020;font-weight:bold">extends</span> SampleClass <span style="color:#007020;font-weight:bold">implements</span> Factory <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">boolean</span> CGLIB$BOUND<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> Object CGLIB$FACTORY_DATA<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">final</span> ThreadLocal CGLIB$THREAD_CALLBACKS<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">final</span> Callback<span style="color:#666">[]</span> CGLIB$STATIC_CALLBACKS<span style="color:#666">;</span>

    <span style="color:#60a0b0;font-style:italic">// ç»‘å®šä¸€ä¸ªåœ¨å¢å¼ºä¸­å£°æ˜çš„ Callback å®ä¾‹
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">private</span> FixedValue CGLIB$CALLBACK_0<span style="color:#666">;</span>
    <span style="color:#60a0b0;font-style:italic">// ç»‘å®šä¸€ä¸ªé™æ€çš„å›è°ƒè°ƒåº¦å®ä¾‹
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> Object CGLIB$CALLBACK_FILTER<span style="color:#666">;</span>

    <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">CGLIB$STATICHOOK1</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        CGLIB$THREAD_CALLBACKS <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ThreadLocal<span style="color:#666">();</span>
    <span style="color:#666">}</span>

    <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">      * å¯¹ test(String) çš„æ–¹æ³•çš„å¢å¼º
</span><span style="color:#60a0b0;font-style:italic">      */</span> 
    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">final</span> String <span style="color:#06287e">test</span><span style="color:#666">(</span>String var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#60a0b0;font-style:italic">// åœ¨æ–¹æ³•å—ä¸­æ‹¿åˆ° Callback å®ä¾‹
</span><span style="color:#60a0b0;font-style:italic"></span>        FixedValue var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#60a0b0;font-style:italic">// ä¸ºç©ºåˆ™å°è¯•è·å–
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
            var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#60a0b0;font-style:italic">// è§¦å‘å›è°ƒå®ä¾‹çš„æ–¹æ³•è·å¾—è¿”å›å€¼
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#666">(</span>String<span style="color:#666">)</span>var10000<span style="color:#666">.</span><span style="color:#4070a0">loadObject</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>

    <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">      * ç”±äºæ­¤æ¬¡å¢å¼ºåªå£°æ˜äº†ä¸€ä¸ª Callback
</span><span style="color:#60a0b0;font-style:italic">      * å› æ­¤æ‰€æœ‰æ–¹æ³•çš„å¢å¼ºéƒ½ç›¸åŒ, éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå›è°ƒæ–¹æ³•è·å–
</span><span style="color:#60a0b0;font-style:italic">      */</span>
    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">final</span> <span style="color:#902000">boolean</span> <span style="color:#06287e">equals</span><span style="color:#666">(</span>Object var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        FixedValue var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
            var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        Object var2 <span style="color:#666">=</span> var10000<span style="color:#666">.</span><span style="color:#4070a0">loadObject</span><span style="color:#666">();</span>
        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * ä½†æ˜¯ï¼Œæ­¤å¤„ä¼šå°è¯•å¼ºåˆ¶è½¬å‹
</span><span style="color:#60a0b0;font-style:italic">         * åŒæ—¶åœ¨æœ€ç»ˆæ‰§è¡Œå¤±è´¥çš„æ—¶å€™ç›´æ¥æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸
</span><span style="color:#60a0b0;font-style:italic">         * æ¯•ç«Ÿä¸Šé¢å¢å¼ºçš„æ—¶å€™è¿”å›å›ºå®šå€¼ &#34;Hello, cglib!&#34;
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#007020;font-weight:bold">return</span> var2 <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span> <span style="color:#666">?</span> <span style="color:#007020;font-weight:bold">false</span> <span style="color:#666">:</span> <span style="color:#666">(</span>Boolean<span style="color:#666">)</span>var2<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">final</span> String <span style="color:#06287e">toString</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        FixedValue var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
            var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#666">(</span>String<span style="color:#666">)</span>var10000<span style="color:#666">.</span><span style="color:#4070a0">loadObject</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">final</span> <span style="color:#902000">int</span> <span style="color:#06287e">hashCode</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        FixedValue var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
            var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        Object var1 <span style="color:#666">=</span> var10000<span style="color:#666">.</span><span style="color:#4070a0">loadObject</span><span style="color:#666">();</span>
        <span style="color:#007020;font-weight:bold">return</span> var1 <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span> <span style="color:#666">?</span> 0 <span style="color:#666">:</span> <span style="color:#666">((</span>Number<span style="color:#666">)</span>var1<span style="color:#666">).</span><span style="color:#4070a0">intValue</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">protected</span> <span style="color:#007020;font-weight:bold">final</span> Object <span style="color:#06287e">clone</span><span style="color:#666">()</span> <span style="color:#007020;font-weight:bold">throws</span> CloneNotSupportedException <span style="color:#666">{</span>
        FixedValue var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
            var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:bold">return</span> var10000<span style="color:#666">.</span><span style="color:#4070a0">loadObject</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#06287e">SampleClass$$EnhancerByCGLIB$$7cd64b81</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">CGLIB$SET_THREAD_CALLBACKS</span><span style="color:#666">(</span>Callback<span style="color:#666">[]</span> var0<span style="color:#666">)</span> <span style="color:#666">{</span>
        CGLIB$THREAD_CALLBACKS<span style="color:#666">.</span><span style="color:#4070a0">set</span><span style="color:#666">(</span>var0<span style="color:#666">);</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">CGLIB$SET_STATIC_CALLBACKS</span><span style="color:#666">(</span>Callback<span style="color:#666">[]</span> var0<span style="color:#666">)</span> <span style="color:#666">{</span>
        CGLIB$STATIC_CALLBACKS <span style="color:#666">=</span> var0<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">final</span> <span style="color:#902000">void</span> <span style="color:#06287e">CGLIB$BIND_CALLBACKS</span><span style="color:#666">(</span>Object var0<span style="color:#666">)</span> <span style="color:#666">{</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var1 <span style="color:#666">=</span> <span style="color:#666">(</span>SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#666">)</span>var0<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(!</span>var1<span style="color:#666">.</span><span style="color:#4070a0">CGLIB$BOUND</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            var1<span style="color:#666">.</span><span style="color:#4070a0">CGLIB$BOUND</span> <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">true</span><span style="color:#666">;</span>
            Object var10000 <span style="color:#666">=</span> CGLIB$THREAD_CALLBACKS<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">();</span>
            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>var10000 <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                var10000 <span style="color:#666">=</span> CGLIB$STATIC_CALLBACKS<span style="color:#666">;</span>
                <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>CGLIB$STATIC_CALLBACKS <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                    <span style="color:#007020;font-weight:bold">return</span><span style="color:#666">;</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>

            var1<span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">=</span> <span style="color:#666">(</span>FixedValue<span style="color:#666">)((</span>Callback<span style="color:#666">[])</span>var10000<span style="color:#666">)[</span>0<span style="color:#666">];</span>
        <span style="color:#666">}</span>

    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">newInstance</span><span style="color:#666">(</span>Callback<span style="color:#666">[]</span> var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#666">(</span>var1<span style="color:#666">);</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#666">();</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#666">((</span>Callback<span style="color:#666">[])</span><span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
        <span style="color:#007020;font-weight:bold">return</span> var10000<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">newInstance</span><span style="color:#666">(</span>Callback var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> Callback<span style="color:#666">[]{</span>var1<span style="color:#666">});</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#666">();</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#666">((</span>Callback<span style="color:#666">[])</span><span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
        <span style="color:#007020;font-weight:bold">return</span> var10000<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> Object <span style="color:#06287e">newInstance</span><span style="color:#666">(</span>Class<span style="color:#666">[]</span> var1<span style="color:#666">,</span> Object<span style="color:#666">[]</span> var2<span style="color:#666">,</span> Callback<span style="color:#666">[]</span> var3<span style="color:#666">)</span> <span style="color:#666">{</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#666">(</span>var3<span style="color:#666">);</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">switch</span><span style="color:#666">(</span>var1<span style="color:#666">.</span><span style="color:#4070a0">length</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">case</span> 0<span style="color:#666">:</span>
            var10000<span style="color:#666">.&lt;</span>init<span style="color:#666">&gt;();</span>
            CGLIB$SET_THREAD_CALLBACKS<span style="color:#666">((</span>Callback<span style="color:#666">[])</span><span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
            <span style="color:#007020;font-weight:bold">return</span> var10000<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span>
            <span style="color:#007020;font-weight:bold">throw</span> <span style="color:#007020;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span><span style="color:#4070a0">&#34;Constructor not found&#34;</span><span style="color:#666">);</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> Callback <span style="color:#06287e">getCallback</span><span style="color:#666">(</span><span style="color:#902000">int</span> var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
        FixedValue var10000<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">switch</span><span style="color:#666">(</span>var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">case</span> 0<span style="color:#666">:</span>
            var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">;</span>
            <span style="color:#007020;font-weight:bold">break</span><span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span>
            var10000 <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:bold">return</span> var10000<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">setCallback</span><span style="color:#666">(</span><span style="color:#902000">int</span> var1<span style="color:#666">,</span> Callback var2<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">switch</span><span style="color:#666">(</span>var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">case</span> 0<span style="color:#666">:</span>
            <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">=</span> <span style="color:#666">(</span>FixedValue<span style="color:#666">)</span>var2<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> Callback<span style="color:#666">[]</span> <span style="color:#06287e">getCallbacks</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        CGLIB$BIND_CALLBACKS<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">);</span>
        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">new</span> Callback<span style="color:#666">[]{</span><span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span><span style="color:#666">};</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">setCallbacks</span><span style="color:#666">(</span>Callback<span style="color:#666">[]</span> var1<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">CGLIB$CALLBACK_0</span> <span style="color:#666">=</span> <span style="color:#666">(</span>FixedValue<span style="color:#666">)</span>var1<span style="color:#666">[</span>0<span style="color:#666">];</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">static</span> <span style="color:#666">{</span>
        CGLIB$STATICHOOK1<span style="color:#666">();</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>ä»ä¸Šé¢çš„ç”Ÿæˆç±»å¯ä»¥çœ‹å‡ºæ¥ï¼ŒCGlib æ‰€è¿›è¡Œçš„å¢å¼ºï¼Œæ˜¯åœ¨ä¸ç›´æ¥å¯¹åŸæœ‰çš„æ–¹æ³•ä½“å†…å®¹è¿›è¡Œæ”¹é€ çš„åŸºç¡€ä¸Š(ä¾‹å¦‚ä¸Šé¢çš„ test(String) æ–¹æ³•ï¼Œæ²¡æœ‰ç›´æ¥æ”¹å†™æˆ <code>return &quot;Hello, cglib!</code> çš„å½¢å¼)ï¼Œå¯¹æ–¹æ³•æ‰§è¡Œä¹‹å‰å…¥å‚æˆ–è€…æ–¹æ³•æ‰§è¡Œä¹‹åçš„è¿”å›å€¼è¿›è¡Œä¸€å®šçš„å¤„ç†ã€‚</p>
<p>ä¸»è¦ä½¿ç”¨çš„å½¢å¼å°±æ˜¯å°†å›è°ƒå®ä¾‹ä¸åŸæœ‰æ–¹æ³•è¿›è¡Œç»‘å®šï¼Œå¹¶é€šè¿‡è°ƒç”¨å›è°ƒæ–¹æ³•æ¥å®ç°æ–¹æ³•çš„å¢å¼ºã€‚</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-category">
              <a href="/categories/%e6%8a%80%e6%9c%af/">
                æŠ€æœ¯
              </a>
            </div>
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

<div class="releated-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2018-06-25-asm-core/">ASM æ ¸å¿ƒåŒ…åŸºæœ¬å†…å®¹æ¼«è°ˆ</a></li>
    
  </ul>
</div>

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/posts/" target="_blank">Posts</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

 
  </body>
</html>
