---
title: gRPC 在跨云架构中的 mTLS 配置
author: fangfeng
date: 2021-10-28
tags:
  - grpc
  - mtls
  - zeroTrust
categories:
  - 技术
---

传统的网络安全是基于边界的安全。通过将网络划分为外网和内网，并在边界上部署防火墙，建立了一个基本假设——内网比外网安全。位于网络边界的前置代理服务器 (Nginx) 接收外部到达的加密 TLS 流量，将其解密为 HTTP 明文，然后再将流量转发到内网某个服务。在实践中，绝大多数内部服务都是以 HTTP 明文的方式通信。

随着云计算的兴起，跨云部署等场景正在逐步模糊网络安全边界。服务与服务通信不得不跨越互联网鸿沟，明文流量显而易见不再安全。

为了支持跨云部署场景下的 gRPC 服务调用，配置 mTLS 成了必然的选择。笔者将在下文中详细描述整个配置方案。

*下列工程使用 [gRPC](https://grpc.io/) 及 [grpc-spring-boot-starter](https://github.com/yidongnan/grpc-spring-boot-starter)*

## gRPC 端到端直连 mTLS 配置

![point-to-point mTLS](https://img.ffutop.com/330C25C5-98AC-4DB0-94E8-6D226EB58F63.png)

首先为 gRPC 客户端与服务端做直连配置。


```properties
##### 服务端配置 #####
# 开启 TLS
grpc.server.security.enabled=true 
# TLS 服务端使用的证书(链)
grpc.server.security.certificateChain=file:/tmp/tls/server.crt
# TLS 服务端使用的私钥
grpc.server.security.privateKey=file:/tmp/tls/server.key
# 启用客户端身份认证，设置为 必须 （另有选项 NONE，OPTIONAL）
grpc.server.security.clientAuth=REQUIRE
# 配置用于认证客户端身份的可信证书集
grpc.server.security.trustCertCollection=file:/tmp/tls/ca.crt


##### 客户端配置 #####
# 配置服务端地址
grpc.client.__SERVER_NAME__.address=static://localhost:9090
# 配置通信类型（TLS or PLAINTEXT)
grpc.client.__SERVER_NAME__.negotiationType=TLS
# 配置用于认证服务端身份的可信证书集
grpc.client.__SERVER_NAME__.security.trustCertCollection=file:/tmp/tls/ca.crt
# 启用客户端身份认证
grpc.client.__SERVER_NAME__.security.clientAuthEnabled=true
# TLS 客户端使用的证书(链)
grpc.client.__SERVER_NAME__.security.certificateChain=file:/tmp/tls/client.crt
# TLS 客户端使用的私钥
grpc.client.__SERVER_NAME__.security.privateKey=file:/tmp/tls/client.key
```

