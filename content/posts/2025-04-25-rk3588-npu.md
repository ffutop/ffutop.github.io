---
title: 瑞芯微 RK3588 NPU 体验
author: ffutop
date: 2025-04-25
categories:
    - 硬件
tags:
    - RK3588
    - NPU
    - Neural Network
---

## RK3588 规格

[RK3588](https://www.rock-chips.com/a/cn/product/RK35xilie/2022/0926/1656.html)

### 主要特性

- 8nm 先进制程，8 核 64 位架构，高性能，低功耗
- ARM Mali-G610 MC4 GPU, 专用 2D 图形加速模块
- 6TOPs NPU，赋能各类 AI 场景
- 8K 视频编解码 , 8K 显示输出
- 内置多种显示接口，支持多屏异显
- 超强影像处理能力， 48MP ISP, 支持多摄像头输入
- 丰富的高速接口(PCIe, TYPE-C，SATA, 千兆以太网)，易于扩展 Android 和 Linux OS

### 详细参数

| 特性 | 描述 |
| --- | --- |
| CPU      | • 八核64位大小核架构，4\*Cortex-A76 + 4\*Cortex-A55  |
| GPU      | • ARM Mali-G610 MC4 <br> • OpenGL ES 1.1/2.0/3.1/3.2 <br> • Vulkan 1.1，1.2 <br> • OpenCL 1.1,1.2,2.0 <br> • 内嵌高性能2D图像加速模块  |
| NPU      | • 6TOPS 算力，三核架构，支持int4/int8/int16/FP16/BF16/TF32  |
| 多媒体   | • 支持H.265/H.264/AV1/VP9/AVS2视频解码， 最高8K60FPS <br> • 支持 H.264/H.265视频编码， 最高8K30FPS   |
| 显示     | • 支持eDP/DP/ HDMI2.1/MIPI 多种显示接口 <br> • 支持多屏异显， 最高8K60FPS |
| 视频输入 | • 32MP ISP，支持HDR 和3DNR <br> • 支持多摄像头输入 (4\*4lanes or 4\*2lanes+2\*4Lanes) MIPI CSI-2 and DVP 接口 <br> • 支持HDMI2.0 输入， 最高4K60FPS |
| 高速接口 | • 支持PCIe3.0/PCIe2.0/SATA3.0/RGMII/TYPE-C/USB3.1/USB2.0 |

## RK3588 NPU 开发流程

**第一步：模型训练**

首先需要收集并准备训练数据，选择适合的深度学习框架（如 TensorFlow、PyTorch、Keras 等）进行模型训练或使用官方提供的模型。

**第二步：模型转换**

完成模型训练后，使用 [RKNN-Toolkit2](https://github.com/airockchip/rknn-toolkit2/) 将预训练模型转换为 RK3588 NPU 可使用的 RKNN 模型。这通常涉及到将模型中的计算图进行适当的修改和优化，以适应 NPU 的硬件架构和指令集。

**第三步：应用开发**

基于 RKNN API 开发应用程序。开发阶段需要根据具体需求，将转换后的模型集成到应用程序中。

```mermaid
graph TD
    A["第一步：模型训练 <br> 收集数据, 选择框架, 训练模型/使用官方模型"] --> B;
    B["第二步：模型转换 <br> 使用 RKNN-Toolkit2 将模型转换为 RKNN 格式 <br> 优化以适应 NPU"] --> C;
    C["第三步：应用开发 <br> 基于 RKNN API 开发 <br> 集成 RKNN 模型"]
```
<small>图1: RK3588 NPU 开发流程</small>

## RK3588 NPU 模型转换

RK3588 NPU 支持多种模型格式，包括 ONNX, TensorFlow, TensorFlow Lite, Caffe, PyTorch, darknet 等。

[示例代码](https://github.com/airockchip/rknn-toolkit2/blob/master/rknn-toolkit2/examples/onnx/yolov5/test.py)中提供了将 ONNX 模型转换为 RKNN 模型的核心代码。

```python
import numpy as np
import cv2
from rknn.api import RKNN

ONNX_MODEL_PATH = 'yolov5s_relu.onnx'
RKNN_MODEL_PATH = 'yolov5s_relu.rknn'

if __name__ == '__main__':

    # Create RKNN object
    rknn = RKNN(verbose=True)

    # pre-process config
    print('--> Config model')
    rknn.config(mean_values=[[0, 0, 0]], std_values=[[255, 255, 255]], target_platform='rk3588')
    print('done')

    # Load ONNX model
    print('--> Loading model')
    ret = rknn.load_onnx(model=ONNX_MODEL_PATH)
    if ret != 0:
        print('Load model failed!')
        exit(ret)
    print('done')

    # Build model
    print('--> Building model')
    ret = rknn.build(do_quantization=QUANTIZE_ON, dataset=DATASET)
    if ret != 0:
        print('Build model failed!')
        exit(ret)
    print('done')

    # Export RKNN model
    print('--> Export rknn model')
    ret = rknn.export_rknn(RKNN_MODEL_PATH)
    if ret != 0:
        print('Export rknn model failed!')
        exit(ret)
    print('done')
```

其中 RKNN 的 whl 安装包需要从 [rknn-toolkit2](https://github.com/airockchip/rknn-toolkit2/tree/master/rknn-toolkit2/packages/arm64) 仓库中获取。

## RK3588 NPU 开发案例

> 本节全部参考 [rknn-toolkit2 仓库提供的 yolo5 DEMO](https://github.com/airockchip/rknn-toolkit2/tree/master/rknpu2/examples/rknn_yolov5_demo)

### 编译 DEMO

排除交叉编译的场景，DEMO 工程仅需一条编译命令即可完成编译，无需额外的配置。

```bash
export GCC_COMPILER=/usr/bin/aarch64-linux-gnu; \
./build-linux.sh -t rk3588 -a aarch64 -b Release
```

> 注意：这里的 GCC_COMPILER 是编译工具链的路径，需要根据实际情况修改。
>
> 该环境变量会被 `build-linux.sh` 使用，用于 CC, CXX 等编译工具的设置。
> ```bash
> export CC=${GCC_COMPILER}-gcc
> export CXX=${GCC_COMPILER}-g++
> ```

编译完成后，会在 `install/rknn_yolov5_demo_Linux/` 目录下生成可执行文件 `rknn_yolov5_demo` 和 `rknn_yolov5_video_demo`。

```bash
[root@server ~]$ ls -l install/rknn_yolov5_demo_Linux/
total 61944
drwxr-xr-x 2 root root     4096 Apr 25 10:11 lib
drwxr-xr-x 3 root root     4096 Apr 25 10:11 model
-rwxr-xr-x 1 root root  7296264 Apr 25 10:11 rknn_yolov5_demo
-rwxr-xr-x 1 root root    60208 Apr 25 10:11 rknn_yolov5_video_demo
```

### 运行 DEMO

DEMO 提供了两种运行方式，一种是处理图片，另一种是处理视频。

#### 处理图片

```bash
[root@server ~]$ cd install/rknn_yolov5_demo_Linux/
[root@server ~]$ ./rknn_yolov5_demo model/RK3588/yolov5s-640-640.rknn model/bus.jpg
post process config: box_conf_threshold = 0.25, nms_threshold = 0.45
Loading mode...
sdk version: 2.3.2 (429f97ae6b@2025-04-09T09:09:27) driver version: 0.9.3
model input num: 1, output num: 3
  index=0, name=images, n_dims=4, dims=[1, 640, 640, 3], n_elems=1228800, size=1228800, w_stride = 640, size_with_stride=1228800, fmt=NHWC, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
  index=0, name=output0, n_dims=4, dims=[1, 255, 80, 80], n_elems=1632000, size=1632000, w_stride = 0, size_with_stride=1638400, fmt=NCHW, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
  index=1, name=286, n_dims=4, dims=[1, 255, 40, 40], n_elems=408000, size=408000, w_stride = 0, size_with_stride=491520, fmt=NCHW, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
  index=2, name=288, n_dims=4, dims=[1, 255, 20, 20], n_elems=102000, size=102000, w_stride = 0, size_with_stride=163840, fmt=NCHW, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
model is NHWC input fmt
model input height=640, width=640, channel=3
Read model/bus.jpg ...
img width = 640, img height = 640
once run use 32.134000 ms
loadLabelName ./model/coco_80_labels_list.txt
person @ (209 243 286 510) 0.879723
person @ (479 238 560 526) 0.870588
person @ (109 238 231 534) 0.839831
bus @ (91 129 555 464) 0.692042
person @ (79 353 121 517) 0.300961
save detect result to ./out.jpg
loop count = 10 , average run  25.052200 ms
```

#### 处理视频

```bash
[root@server ~]$ ./rknn_yolov5_video_demo model/RK3588/yolov5s-640-640.rknn rtsp://admin:asd135246@10.3.150.205:554/Streaming/Channels/101 265
Loading mode...
sdk version: 2.3.2 (429f97ae6b@2025-04-09T09:09:27) driver version: 0.9.3
model input num: 1, output num: 3
  index=0, name=images, n_dims=4, dims=[1, 640, 640, 3], n_elems=1228800, size=1228800, fmt=NHWC, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
  index=0, name=output0, n_dims=4, dims=[1, 255, 80, 80], n_elems=1632000, size=1632000, fmt=NCHW, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
  index=1, name=286, n_dims=4, dims=[1, 255, 40, 40], n_elems=408000, size=408000, fmt=NCHW, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
  index=2, name=288, n_dims=4, dims=[1, 255, 20, 20], n_elems=102000, size=102000, fmt=NCHW, type=INT8, qnt_type=AFFINE, zp=-128, scale=0.003922
model is NHWC input fmt
model input height=640, width=640, channel=3
mpi_dec_test start mpi_dec_test decoder test start mpp_type 16777220 app_ctx=0x7ff8a6ba70 decoder=0x55805cbfd0
2025-04-25 14:24:20.864 D rknn_yolov5_video_demo[341061-stamp thread] util.cpp:366 operator() | Stamp thread started
2025-04-25 14:24:20.866 I rknn_yolov5_video_demo[341061-rknn_yolov5_vid] EventPoller.cpp:466 EventPollerPool | EventPoller created size: 8
enter any key to exit
2025-04-25 14:24:20.867 D rknn_yolov5_video_demo[341061-event poller 0] RtspPlayer.cpp:93 play | rtsp://10.3.150.205:554/Streaming/Channels/101 admin asd135246 0
2025-04-25 14:24:20.910 W rknn_yolov5_video_demo[341061-event poller 0] RtspPlayer.cpp:689 onPlayResult_l | 0 rtsp play success
play success!on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=8161 2025-04-25 14:24:21.046 D rknn_yolov5_video_demo[341061-event poller 0] MediaSink.cpp:137 emitAllTrackReady | all track ready use 172ms
2025-04-25 14:24:21.046 I rknn_yolov5_video_demo[341061-event poller 0] main_video.cc:505 on_mk_play_event_func | got video track: H265
on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=28 on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=48 on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=11 on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=227584 on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=4977 on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=5990 on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=6004 decoder require buffer w:h [2560:1440] stride [2816:1440] buf_size 7299072 pts=0 dts=0 decode_get_frame get info changed found on_track_frame_out ctx=0x7ff8a6ba70
decoder=0x55805cbfd0
receive packet size=9248 decoder require buffer w:h [2560:1440] stride [2816:1440] buf_size 7299072 pts=0 dts=0 get one frame 1745562261112 data_vir=0x7f6e107000 fd=45 0x7f8004e5e0 encoder test start w 2560 h 1440 type 7
input image 2560x1440 stride 2816x1440 format=2560
resize with RGA!
rga_api version 1.10.1_[0]
once run use 51.243000 ms
post process config: box_conf_threshold = 0.25, nms_threshold = 0.45
loadLabelName ./model/coco_80_labels_list.txt
umbrella @ (0 1098 344 1440) 0.211165
refrigerator @ (1152 796 1964 1435) 0.128627
chn 0  size 549628  qp 13
time_gap=-142decoder require buffer w:h [2560:1440] stride [2816:1440] buf_size 7299072 pts=0 dts=0 get one frame 1745562261247 data_vir=0x7f6c634000 fd=51 input image 2560x1440 stride 2816x1440 format=2560
resize with RGA!
```
