<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Utop&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://utop.xin/"/>
  <updated>2018-06-12T12:49:33.655Z</updated>
  <id>http://utop.xin/</id>
  
  <author>
    <name>Utop</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring JDBC æºç å­¦ä¹ </title>
    <link href="http://utop.xin/2018-06-12-Spring-JDBC-Source-Code-Reading/"/>
    <id>http://utop.xin/2018-06-12-Spring-JDBC-Source-Code-Reading/</id>
    <published>2018-06-12T12:49:33.655Z</published>
    <updated>2018-06-12T12:49:33.655Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure><h1 id="Spring-JDBC-æºç å­¦ä¹ "><a href="#Spring-JDBC-æºç å­¦ä¹ " class="headerlink" title="Spring JDBC æºç å­¦ä¹ "></a>Spring JDBC æºç å­¦ä¹ </h1><p>[TOC]</p><h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p>åœ¨å­¦ä¹  Spring-JDBC ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä» Java åŸç”Ÿæä¾›çš„ JDBC å¼€å§‹ï¼Œå¯¹ JDBC æ“ä½œçš„ä¸€æ•´å¥—å®Œæ•´çš„æµç¨‹æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ¦‚å¿µã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * copied from https://www.tutorialspoint.com/jdbc/jdbc-sample-code.htm</span></span><br><span class="line"><span class="comment"> * updated by DorMOUSENone</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//STEP 1. å¼•å…¥å¿…é¡»çš„åŒ…</span></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line"><span class="comment">// JDBC é©±åŠ¨å ä¸ DB URL </span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String JDBC_DRIVER = <span class="string">"com.mysql.jdbc.Driver"</span>;  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String DB_URL = <span class="string">"jdbc:mysql://&lt;host&gt;:&lt;port&gt;/&lt;dbName&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ•°æ®åº“ç™»å½•éªŒè¯ (ç”¨æˆ·åã€å¯†ç ç­‰)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">"username"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PASS = <span class="string">"password"</span>;</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">Connection conn = <span class="keyword">null</span>;</span><br><span class="line">Statement stmt = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//STEP 2: æ³¨å†Œé©±åŠ¨(æ³¨å†Œåˆ°é©±åŠ¨ç®¡ç†å™¨ DriverManager ç±»ä¸­)</span></span><br><span class="line">Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//STEP 3: åˆ›å»ºä¸€ä¸ªè¿æ¥</span></span><br><span class="line">          System.out.println(<span class="string">"Connecting to database..."</span>);</span><br><span class="line">          conn = DriverManager.getConnection(DB_URL,USER,PASS);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//STEP 4: æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢</span></span><br><span class="line">          System.out.println(<span class="string">"Creating statement..."</span>);</span><br><span class="line">          stmt = conn.createStatement();</span><br><span class="line">          String sql;</span><br><span class="line">          sql = <span class="string">"SELECT id, first, last, age FROM Employees"</span>;</span><br><span class="line">          ResultSet rs = stmt.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//STEP 5: å°†ç»“æœä»ç»“æœé›†(ResultSet)ä¸­å–å‡º</span></span><br><span class="line">          <span class="keyword">while</span>(rs.next())&#123;</span><br><span class="line">             <span class="comment">//æ ¹æ®åˆ—åé€ä¸€å–å‡ºæ•°æ®</span></span><br><span class="line">             <span class="keyword">int</span> id  = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">             <span class="keyword">int</span> age = rs.getInt(<span class="string">"age"</span>);</span><br><span class="line">             String first = rs.getString(<span class="string">"first"</span>);</span><br><span class="line">             String last = rs.getString(<span class="string">"last"</span>);</span><br><span class="line"></span><br><span class="line">             <span class="comment">//å±•ç¤ºç»“æœ</span></span><br><span class="line">             System.out.print(<span class="string">"ID: "</span> + id);</span><br><span class="line">             System.out.print(<span class="string">", Age: "</span> + age);</span><br><span class="line">             System.out.print(<span class="string">", First: "</span> + first);</span><br><span class="line">             System.out.println(<span class="string">", Last: "</span> + last);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//STEP 6: æ¸…ç†ç¯å¢ƒ</span></span><br><span class="line">          rs.close();</span><br><span class="line">          stmt.close();</span><br><span class="line">          conn.close();</span><br><span class="line">       &#125;<span class="keyword">catch</span>(SQLException se)&#123;</span><br><span class="line">          <span class="comment">//å¤„ç† JDBC é”™è¯¯</span></span><br><span class="line">          se.printStackTrace();</span><br><span class="line">       &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">          <span class="comment">//å¤„ç† Class.forName() å¼•èµ·çš„é”™è¯¯</span></span><br><span class="line">          e.printStackTrace();</span><br><span class="line">       &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">          <span class="comment">// finally ä»£ç åº“æ¥å…³é—­èµ„æº</span></span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(stmt!=<span class="keyword">null</span>)</span><br><span class="line">                stmt.close();</span><br><span class="line">          &#125;<span class="keyword">catch</span>(SQLException se2)&#123;</span><br><span class="line">          &#125;<span class="comment">// ä¸åšä»»ä½•å¤„ç†</span></span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(conn!=<span class="keyword">null</span>)</span><br><span class="line">                conn.close();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(SQLException se)&#123;</span><br><span class="line">               se.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(<span class="string">"Goodbye!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„é€šç”¨ JDBC ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåˆ©ç”¨ Java åŸç”Ÿæä¾›çš„ java.sql.* åŒ…å¯ä»¥å®Œæˆæ³¨å†Œé©±åŠ¨ï¼Œåˆ›å»ºè¿æ¥ï¼Œæ‰§è¡ŒæŸ¥è¯¢ï¼Œå¤„ç†ç»“æœç­‰ä¸€ç³»åˆ—ä¸€æ•´å¥—æ“ä½œã€‚</p><p>è€Œ Spring-JDBC å¯¹äº Java åŸç”Ÿæä¾›çš„ JDBC ï¼Œå¯¹ä¸€ç³»åˆ—æ•°æ®åŠæ“ä½œè¿›è¡Œäº†æ•´åˆï¼š</p><ol><li>å®ç°äº† DataSource æ¥å£ï¼Œç”¨äºæ•´åˆæ•°æ®æºé…ç½®ï¼Œå°†å„ç§é›¶æ•£çš„å±æ€§å€¼ï¼ˆè¯¸å¦‚ URLã€ç”¨æˆ·åã€ å¯†ç ç­‰ï¼‰æ•´åˆæˆå®Œæ•´çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¾¿äºé‡ç”¨ï¼›ä¹Ÿå®ç°äº† getConnection(â€¦) æ¥å£ï¼Œä¾¿äºç›´æ¥é€šè¿‡ DataSource è·å–è¿æ¥ã€‚</li><li>å¯¹æ‰§è¡ŒæŸ¥è¯¢çš„æµç¨‹è¿›è¡Œäº†å°è£…ã€‚</li><li>å¯¹ç»“æœé›†çš„å¤„ç†æä¾›äº†å¤šç§æ¥å£ï¼Œé’ˆå¯¹ä¸åŒçš„åº”ç”¨åœºæ™¯å¯è‡ªç”±é€‰æ‹©æ‰€å¿…é¡»çš„å®ç°ç±»ã€‚ä¾‹å¦‚ç›´æ¥é€šè¿‡ JDBC è·å¾— Bean ï¼Œè€Œæ— éœ€å¦‚ä¸Šä¾‹ 39-42 è¡Œæ‰€ç¤ºï¼Œé€ä¸€ç¼–ç è¿›è¡Œæå–ã€‚</li></ol><p>æœ¬èŠ‚æä¾›å¯¹ã€ŠSpring-JDBC æºç å­¦ä¹ ã€‹å®Œæ•´å­¦ä¹ è¿‡ç¨‹çš„ä¸€ä¸ªæ¢³ç†ï¼š</p><ol><li><a href="http://blog.csdn.net/dormousenone/article/details/79035440" target="_blank" rel="noopener">JdbcTemplate</a> ä¸€èŠ‚ä½œä¸ºå­¦ä¹  Spring-jdbc çš„åˆ‡å…¥ç‚¹ï¼Œæ˜¯ org.springframework.jdbc.core åŒ…ä¸­çš„æ ¸å¿ƒç±»ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä¸åŒåœºæ™¯ä¸‹æ•°æ®åº“æ“ä½œçš„æ¨¡æ¿ç±»ã€‚ä¸»è¦æè¿°å…¶æŒæœ‰çš„å±æ€§ DataSource ç­‰ä»¥åŠå…¶å®ç°çš„æ–¹æ³•ã€‚</li><li><a href="http://blog.csdn.net/dormousenone/article/details/79037012" target="_blank" rel="noopener">DataSource</a> ä¸€èŠ‚æ‰¿æ¥ JdbcTemplate ä¸€èŠ‚ï¼Œæä¾› Spring-jdbc å¯¹æ•°æ®æºçš„ä¸€ä¸ªåŒ…è£…ä¸åº”ç”¨ã€‚åŒæ—¶æè¿°å…¶æ ¸å¿ƒæ–¹æ³• getConnection(â€¦) çš„å®ç°ã€‚</li><li><a href="http://blog.csdn.net/dormousenone/article/details/79042212" target="_blank" rel="noopener">DriverManager</a> æè¿°å…¶å¯¹ä¸åŒæ•°æ®åº“ä¾›åº”å•†æä¾›çš„é©±åŠ¨çš„ç®¡ç†ä¸ä½¿ç”¨æ–¹æ³•ã€‚åŒæ—¶ç®€å•æè¿°é€šè¿‡å…·ä½“é©±åŠ¨è·å¾—ä¸€ä¸ªè¿æ¥çš„å®ç°ã€‚</li><li><a href="http://blog.csdn.net/dormousenone/article/details/79046865" target="_blank" rel="noopener">PreparedStatement &amp; CallableStatement</a> ä¸€èŠ‚ä¸»è¦è¡¨è¿° Spring-jdbc å¦‚ä½•å¯¹æ‰§è¡ŒæŸ¥è¯¢çš„æµç¨‹è¿›è¡Œäº†å°è£…ã€‚ç‰¹åˆ«æ˜¯å¯¹äº PreparedStatement ä¸ CallableStatement è¿™ç±»é¢„ç½®å¯å˜ SQL è¯­å¥ï¼Œåœ¨æ‰§è¡Œå‰å¿…é¡»å¯¹å…¶ä¸­å¯å˜å‚æ•°è¿›è¡Œè¡¥å…¨çš„ Statement ã€‚</li><li><a href="http://blog.csdn.net/dormousenone/article/details/79062275" target="_blank" rel="noopener">ResultSet</a> æè¿° Spring-jdbc å¦‚ä½•å¯¹ç»“æœé›†è¿›è¡Œå¤„ç†ï¼Œæä¾›äº†å¤šç§ä¸åŒçš„æ¥å£å®ç°ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚è¿™ç§å°è£…åçš„æ“ä½œå¯ä»¥æå¤§åœ°ç®€åŒ–ç›´æ¥ä½¿ç”¨ Java åŸç”Ÿ JDBC æ‰€å¿…é¡»çš„ç¡¬ç¼–ç æå–æ•°æ®çš„é—®é¢˜ã€‚</li></ol><h2 id="JdbcTemplate"><a href="#JdbcTemplate" class="headerlink" title="JdbcTemplate"></a>JdbcTemplate</h2><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fn90ghu9ufj30ki0jm75t.jpg" alt=""></p><p>JdbcTemplate ç±»ä½œä¸º org.springframework.core åŒ…ä¸‹çš„æ ¸å¿ƒç±»ï¼Œå¯¹ Java å®ç°çš„ JDBC è¿›è¡Œäº†ä¸€å®šç¨‹åº¦çš„å°è£…ï¼Œå¯ä»¥ç®€åŒ– JDBC çš„ä½¿ç”¨ï¼ŒåŒæ—¶é¿å…è®¸å¤šå¸¸è§çš„é”™è¯¯ã€‚ç”±è¯¥ç±»æ¥æ‰§è¡Œ JDBC å·¥ä½œæµï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦æä¾› SQL è¯­å¥å°±å¯ä»¥è·å¾— DB æ‰§è¡Œç»“æœï¼ˆğŸ˜€ï¼Œå½“ç„¶å®é™…æ“ä½œä¸Šæ²¡æœ‰æè¿°çš„è¿™ä¹ˆç®€å•ï¼‰ã€‚</p><p><strong>ä½¿ç”¨ JdbcTemplate ç±»åªéœ€è¦å®ç°ä¸¤ä¸ªå›è°ƒæ¥å£ PreparedStatementCreator (åˆ›å»ºä¸€ä¸ª PreparedStatementï¼Œç»™å®šè¿æ¥ï¼Œæä¾› SQL è¯­å¥ä»¥åŠå¿…è¦çš„å‚æ•°), ResultSetExtractor (ç”¨äºèŠ±å¼è·å–ç»“æœé›†)ã€‚å½“ç„¶ï¼Œä¸å®ç°ä¸Šè¿°ä¸¤ä¸ªæ¥å£ä¹Ÿå¯ä»¥è¿›è¡Œç®€å•çš„æ•°æ®åº“æ“ä½œï¼Œæ¯”å¦‚åªé€šè¿‡ JdbcTemplate è·å–ä¸€ä¸ªè¿æ¥(Connection) æˆ–è€…æ‰§è¡Œä¸€ä¸ªé™æ€ SQL Updateã€‚</strong></p><p><em>çœ‹ä¸æ‡‚æ— æ‰€è°“ï¼Œå…ˆç»§ç»­å‘ä¸‹çœ‹ï¼Œä¼šåšæ›´è¯¦ç»†çš„è®²è§£ã€‚</em></p><h3 id="JdbcAccessor"><a href="#JdbcAccessor" class="headerlink" title="JdbcAccessor"></a>JdbcAccessor</h3><p>é¦–å…ˆäº†è§£ JdbcTemplate çš„å®ç°ï¼ŒJdbcTemplate ç»§æ‰¿äº† JdbcAccessor æŠ½è±¡ç±»ï¼Œè¯¥æŠ½è±¡ç±»æœ‰ä¸¤ä¸ªä¸»è¦å±æ€§â€”â€” <strong>DataSource dataSource</strong> &amp; <strong>SQLExceptionTranslator exceptionTranslator</strong> ï¼Œä»¥åŠä¸€ä¸ªæ‡’åŠ è½½æ ‡è¯†ç¬¦ <strong>lazyInit</strong> ã€‚</p><p>å…¶ä¸­ï¼Œ</p><ul><li>DataSource å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå­˜å‚¨æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„å±æ€§å®ä¾‹ï¼Œä¸»è¦æ–¹æ³•åŒ…æ‹¬ <code>Connection getConnection()</code> &amp; <code>Connection getConnection(String username, String password)</code> ã€‚</li><li>SQLExceptionTranslator åˆ©ç”¨ç­–ç•¥æ¨¡å¼å°† Java å®šä¹‰çš„ SQLException è½¬æ¢æˆ Spring å£°æ˜çš„ DataAccessExceptionã€‚</li></ul><p>JdbcAccessor å®ç°çš„ InitializingBean æ¥å£ï¼ŒInitializingBean æ¥å£ä¸º Bean æä¾›äº†ä¸€ä¸ªåˆå§‹åŒ–å®ä¾‹çš„æ–¹æ³• â€”â€” afterPropertiesSet() æ–¹æ³•ï¼Œå‡¡æ˜¯ç»§æ‰¿è¯¥æ¥å£çš„ç±»ï¼Œä¸€èˆ¬éƒ½åœ¨ç±»æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œè¯¥æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå£°æ˜åˆå§‹åŒ–å®ä¾‹è°ƒç”¨çš„æ–¹æ³•è¿˜å¯é‡‡ç”¨ <code>&lt;bean id=&quot;&quot; class=&quot;&quot; init-method=&quot;myInitMethod&quot;/&gt;</code> åœ¨åˆå§‹åŒ– bean æ—¶æ‰§è¡Œ myInitMethod() æ–¹æ³•ã€‚å…·ä½“æ‰§è¡Œé¡ºåºä¸º ï¼š</p><ol><li>bean çš„å±æ€§æ³¨å…¥</li><li>è°ƒç”¨ afterPropertiesSet() æ–¹æ³•</li><li>æ‰§è¡Œ myInitMethod() æ–¹æ³•</li></ol><p>æ­¤å¤„ç»§æ‰¿è¯¥æ¥å£æ˜¯ä¸ºäº†å®ç° DataSource éªŒè¯ä»¥åŠ SQLExceptionTranslator çš„æ‡’åŠ è½½ OR NOT çš„é€‰æ‹©ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getDataSource() == <span class="keyword">null</span>) &#123;<span class="comment">// åˆ¤æ–­æ˜¯å¦æ³¨å…¥äº† DataSource</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Property 'dataSource' is required"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!isLazyInit()) &#123;<span class="comment">// æ ¹æ®æ‡’åŠ è½½æ ‡è¯†ç¬¦é€‰æ‹©æ‰§è¡Œä¸å¦</span></span><br><span class="line">getExceptionTranslator();<span class="comment">// è·å–ä¸€ä¸ª SQLExceptionTranslator å®ä¾‹</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•åœ¨ BeanFactory å®Œæˆè¯¥ bean çš„ä¾èµ–æ³¨å…¥åæ‰§è¡Œï¼Œå°†é¦–å…ˆåˆ¤æ–­ DataSource æ˜¯å¦å·²ç»è¢«æ³¨å…¥ï¼Œå†æ ¹æ®æ‡’åŠ è½½æ ‡è¯†ç¬¦æ¥å†³å®šæ˜¯å¦å®ä¾‹åŒ–ä¸€ä¸ª SQLExceptionTranslator ã€‚</p><h3 id="JdbcOperations"><a href="#JdbcOperations" class="headerlink" title="JdbcOperations"></a>JdbcOperations</h3><p>åŒæ—¶ï¼ŒJdbcTemplate ç±»å®ç°äº† JdbcOperations æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†åŸºæœ¬çš„ JDBC æ“ä½œã€‚åŸºæœ¬æ–¹æ³•å¦‚ä¸‹ï¼š</p><ol><li><code>&lt;T&gt; T execute(ConnectionCallback&lt;T&gt; action);</code></li><li><code>&lt;T&gt; T execute(StatementCallback&lt;T&gt; action);</code></li><li><code>&lt;T&gt; T execute(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action);</code></li><li><code>&lt;T&gt; T execute(CallableStatementCreator csc, CallableStatementCallback&lt;T&gt; action);</code></li></ol><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fncp2ncqd6j31j00au0uv.jpg" alt=""></p><p>å…¶å®ƒçš„ execute(â€¦) , query(â€¦), update(â€¦) ç­‰æœ€ç»ˆéƒ½å°†è°ƒç”¨ä¸Šè¿° 4 ç§æ–¹æ³•å…¶ä¸€æ¥å®Œæˆç›®çš„ã€‚</p><p>è¯¦ç»†è§‚å¯Ÿä¸Šè¿°æ–¹æ³•çš„å…¥å‚ï¼Œ ConnectionCallback, StatementCallback, PreparedStatementCallback å’Œ CallableStatementCallback å››ä¸ª Callback æ¥å£ï¼Œåˆ†åˆ«éƒ½æ˜¯å‡½æ•°å¼æ¥å£ï¼Œå…¶ä¸­çš„å”¯ä¸€æ–¹æ³• doInXXX() å°†åœ¨ execute() ä¸­è¢«è°ƒç”¨ï¼Œä»¥æ­¤å®ç°è·å¾— ResultSet å¹¶è¿”å› Result ã€‚execute ä¸­è°ƒç”¨ doInXXX() çš„é€šç”¨ä»£ç å¦‚ä¸‹ ï¼ˆä»¥ Statement ä¸ºä¾‹ï¼‰ï¼š</p><p><em>å¯¹äºä¸ç†è§£<strong>å›è°ƒ</strong>çš„åŒå­¦ï¼Œè¯·è‡ªè¡Œäº†è§£æ¦‚å¿µ</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(StatementCallback&lt;T&gt; action)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line"><span class="comment">// é€šè¿‡å·¥å…·ç±» DataSourceUtils è·å–ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">  Connection con = DataSourceUtils.getConnection(obtainDataSource());</span><br><span class="line">  <span class="comment">// ä¸€ä¸ª Statement ç©ºå®ä¾‹ï¼ŒPreparedStatement, CallableStatement ç±»ä¼¼</span></span><br><span class="line">Statement stmt = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">stmt = con.createStatement();<span class="comment">// é€šè¿‡è¿æ¥(Connection)è·å–ä¸€ä¸ª Statement</span></span><br><span class="line">applyStatementSettings(stmt);<span class="comment">// é…ç½® Statement å‚æ•°</span></span><br><span class="line">      <span class="comment">// å›è°ƒæ‰§è¡Œ doInXXX() æ–¹æ³•, å¹¶è·å¾— result</span></span><br><span class="line">T result = action.doInStatement(stmt);</span><br><span class="line">handleWarnings(stmt);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line"><span class="comment">// Release Connection early, to avoid potential connection pool deadlock</span></span><br><span class="line"><span class="comment">// in the case when the exception translator hasn't been initialized yet.</span></span><br><span class="line">String sql = getSql(action);</span><br><span class="line">JdbcUtils.closeStatement(stmt);</span><br><span class="line">stmt = <span class="keyword">null</span>;</span><br><span class="line">DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">con = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">throw</span> translateException(<span class="string">"StatementCallback"</span>, sql, ex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">JdbcUtils.closeStatement(stmt);</span><br><span class="line">DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº Statement, PreparedStatement, CallableStatement çš„åŒºåˆ«ï¼Œé¦–å…ˆä¸‹å›¾è¡¨ç°äº†ä¸‰ä¸ªæ¥å£çš„ç»§æ‰¿å…³ç³»ã€‚</p><ul><li>Statement å¯ä»¥æ”¯æŒé™æ€ SQL è¯­å¥</li><li>PreparedStatement æ”¯æŒå¯å˜å‚æ•°çš„ SQL è¯­å¥</li><li>CallableStatement æ”¯æŒå¯å˜å‚æ•°çš„ SQL è¯­å¥ï¼Œå¹¶ä¸”æ”¯æŒå®šåˆ¶ DB çš„è¾“å‡ºç»“æœ</li></ul><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fncpaec17yj30ew0hcdh7.jpg" alt=""></p><h2 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a>DataSource</h2><p>ä¸Šä¸€èŠ‚åœ¨ç²—ç•¥åœ°äº†è§£äº† JdbcTemplate æä¾›çš„æ–¹æ³•ä¹‹åï¼Œä¸‹é¢å…ˆæ¥å¯¹ DataSource åšä¸€ç‚¹äº†è§£ã€‚</p><h3 id="Java-æä¾›çš„-DataSource-å®šä¹‰"><a href="#Java-æä¾›çš„-DataSource-å®šä¹‰" class="headerlink" title="Java æä¾›çš„ DataSource å®šä¹‰"></a>Java æä¾›çš„ DataSource å®šä¹‰</h3><p>DataSource æ˜¯ Java æ ¸å¿ƒåº“æä¾›çš„æ¥å£ã€‚ä½äº javax.sql package ä¸‹ã€‚</p><p>DataSource æ¥å£å¯ä»¥è¢«è§†ä½œæ˜¯ä¸€ä¸ªæä¾›ç‰©ç† DB å®ä¾‹è¿æ¥(Connection) çš„å·¥å‚ï¼Œé€šè¿‡ DataSource æŒæœ‰çš„å„ç§å±æ€§ï¼ˆåŒ…æ‹¬ DB Url, Username, Password ç­‰ï¼‰æ¥è·å–ä¸€ä¸ªè¿æ¥(Connection) ã€‚DataSource æ¥å£æœ‰ä¸‰ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆï¼š</p><ol><li>æœ€åŸºæœ¬çš„å®ç°â€”â€”ç”Ÿäº§ä¸€ä¸ªæ ‡å‡†è¿æ¥(Connection) å¯¹è±¡</li><li>è¿æ¥æ± æ–¹æ¡ˆâ€”â€”ç”Ÿäº§ä¼šè¢«è‡ªåŠ¨æ·»åŠ åˆ°è¿æ¥æ± çš„å¯¹è±¡</li><li>åˆ†å¸ƒå¼äº‹ç‰©å®ç°â€”â€”ç”Ÿäº§ä¸€ä¸ªå¯ä»¥æ”¯æŒåˆ†å¸ƒå¼äº‹ç‰©ï¼Œå¹¶é»˜è®¤è¢«æ·»åŠ åˆ°è¿æ¥æ± çš„è¿æ¥å¯¹è±¡</li></ol><p>åŒ…æ‹¬ä¸¤ä¸ªå¯¹å¤–æä¾›è¿æ¥(Connection) å¯¹è±¡çš„æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"><span class="function">Connection <span class="title">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException</span>;</span><br></pre></td></tr></table></figure><p>å…¶çˆ¶æ¥å£ CommonDataSource æä¾›è®¾ç½®/è·å– LogWriterï¼Œç™»å½• DB è¶…æ—¶æ—¶é—´å’Œè·å–çˆ¶ Logger çš„æ–¹æ³•ã€‚</p><h3 id="Spring-JDBC-æ‰©å±•çš„-DataSource-å®šä¹‰"><a href="#Spring-JDBC-æ‰©å±•çš„-DataSource-å®šä¹‰" class="headerlink" title="Spring-JDBC æ‰©å±•çš„ DataSource å®šä¹‰"></a>Spring-JDBC æ‰©å±•çš„ DataSource å®šä¹‰</h3><p>åœ¨ Spring-jdbc ä¸‹ï¼ŒDataSources æœ€é¡¶çº§çš„ç±»æ˜¯ AbstractDataSource ï¼Œå¯¹ DataSource çš„æ‰€æœ‰çˆ¶æ¥å£æ–¹æ³•åšäº†å®ç°ã€‚ä½†ä¿ç•™ getConnection() æ–¹æ³•ç”±å­ç±»å®ç°ã€‚</p><p>åœ¨ AbstractDriverBasedDataSource ä¸­ï¼Œå®šä¹‰äº†å¤§é‡çš„å‚æ•°ï¼Œè¯¸å¦‚ url, username ç­‰ï¼Œè¿™äº›éƒ½è¢«ç”¨æ¥å®šä½å¹¶å®šä¹‰ä¸æ•°æ®åº“å®ä¾‹çš„è¿æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDriverBasedDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">private</span> String catalog;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">private</span> String schema;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="comment">// å¯ä»¥çœ‹åˆ°æ­¤å¤„æœ‰ä¸€ä¸ª Properties ç±»</span></span><br><span class="line">   <span class="keyword">private</span> Properties connectionProperties;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// çœç•¥è‹¥å¹²æ–¹æ³•</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨å†…éƒ¨æ–¹æ³• getConnectionFromDriver()</span></span><br><span class="line"><span class="keyword">return</span> getConnectionFromDriver(getUsername(), getPassword());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨å†…éƒ¨æ–¹æ³• getConnectionFromDriver()</span></span><br><span class="line"><span class="keyword">return</span> getConnectionFromDriver(username, password);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å®šä¹‰äº†ä¸€ä¸ªè·å– Connection çš„æ–¹æ³•ï¼Œç”± getConnection() æ–¹æ³•è°ƒç”¨ï¼Œ</span></span><br><span class="line">   <span class="comment">// æ­¤æ–¹æ³•ä¸»è¦æ˜¯å°†å±æ€§åšäº†ä¸€ä¸ªæ•´åˆ</span></span><br><span class="line">   <span class="comment">// å…·ä½“è·å– Connection çš„é€»è¾‘ä»ç„¶ä¸‹æ”¾åˆ°å­ç±»å®ç° è§ 40 è¡Œ</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> Connection <span class="title">getConnectionFromDriver</span><span class="params">(@Nullable String username, @Nullable String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">Properties mergedProps = <span class="keyword">new</span> Properties();</span><br><span class="line">Properties connProps = getConnectionProperties();</span><br><span class="line"><span class="keyword">if</span> (connProps != <span class="keyword">null</span>) &#123;</span><br><span class="line">mergedProps.putAll(connProps);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (username != <span class="keyword">null</span>) &#123;</span><br><span class="line">mergedProps.setProperty(<span class="string">"user"</span>, username);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (password != <span class="keyword">null</span>) &#123;</span><br><span class="line">mergedProps.setProperty(<span class="string">"password"</span>, password);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// è·å– Connection é€»è¾‘ä¸‹æ”¾</span></span><br><span class="line">Connection con = getConnectionFromDriver(mergedProps);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.catalog != <span class="keyword">null</span>) &#123;</span><br><span class="line">con.setCatalog(<span class="keyword">this</span>.catalog);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.schema != <span class="keyword">null</span>) &#123;</span><br><span class="line">con.setSchema(<span class="keyword">this</span>.schema);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> con;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è¯¥ç±»ä¸­è·å– Connection çš„æ–¹æ³•æ˜¯æŠ½è±¡æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Connection <span class="title">getConnectionFromDriver</span><span class="params">(Properties props)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´åˆæ–¹æ¡ˆä¸ºå°†é™¤ url å¤–çš„æ‰€æœ‰å‚æ•°æ•´åˆåœ¨åŒä¸€ä¸ª Properties å¯¹è±¡ä¸­ (å…¶ä¸­ï¼ŒProperties å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Hash Map) ã€‚æœ€ç»ˆè°ƒç”¨ <code>Connection getConnectionFromDriver(Properties props)</code> è·å–è¿æ¥ã€‚</p><p>AbstractDriverBasedDataSource æŠ½è±¡ç±»çš„ä¸¤ä¸ªå­ç±» DriverManagerDataSource å’Œ SimpleDriverDataSource éƒ½ä»¥ä¸åŒæ–¹å¼è·å¾—äº†è¿æ¥(Connection)ï¼Œä½†æ€»ç»“è€Œè¨€ï¼Œè·å–è¿æ¥(Connection) çš„ä»»åŠ¡è¢«å§”æ‰˜ç»™äº† Driver æ¥å®ç°ï¼ˆå…¶ä¸­ï¼ŒDriver æœ‰ Java å®šä¹‰æ¥å£ï¼Œå¹¶ç”±å„æ•°æ®åº“æä¾›å•†æä¾›ï¼Œä¾‹å¦‚ MySQL æä¾›äº† mysql-connector-java-XXX.jar æ¥å®Œæˆé’ˆå¯¹ç›¸åº”æ•°æ®åº“çš„å…·ä½“å®ç°ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----------------------------</span></span><br><span class="line"><span class="comment">// SimpleDriverDataSource çš„å®ç°</span></span><br><span class="line"><span class="comment">// ----------------------------</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Connection <span class="title">getConnectionFromDriver</span><span class="params">(Properties props)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">Driver driver = getDriver();</span><br><span class="line">String url = getUrl();</span><br><span class="line">Assert.notNull(driver, <span class="string">"Driver must not be null"</span>);</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Creating new JDBC Driver Connection to ["</span> + url + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// å“ˆå“ˆï¼Œé‡ç‚¹åœ¨è¿™... driver åœ¨è¯¥ç±»ä¸­è¢«é¢„å…ˆæ³¨å…¥</span></span><br><span class="line"><span class="keyword">return</span> driver.connect(url, props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------------</span></span><br><span class="line"><span class="comment">// DriverManagerDataSource çš„å®ç°</span></span><br><span class="line"><span class="comment">// -----------------------------</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Connection <span class="title">getConnectionFromDriver</span><span class="params">(Properties props)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">String url = getUrl();</span><br><span class="line">Assert.state(url != <span class="keyword">null</span>, <span class="string">"'url' not set"</span>);</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Creating new JDBC DriverManager Connection to ["</span> + url + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// è°ƒäº†ä¸ªå†…éƒ¨å‡½æ•°</span></span><br><span class="line"><span class="keyword">return</span> getConnectionFromDriverManager(url, props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Connection <span class="title">getConnectionFromDriverManager</span><span class="params">(String url, Properties props)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">// å§”æ‰˜ç»™ DriverManager ç±»æ¥è·å–è¿æ¥</span></span><br><span class="line">    <span class="comment">// DriverManager çš„ä¸»è¦æ“ä½œæ˜¯éå†åœ¨è¯¥ç®¡ç†ç±»ä¸­æ³¨å†Œçš„ Driver</span></span><br><span class="line">    <span class="comment">// æ¯ä¸ª Driver å®ä¾‹éƒ½å»å°è¯•ä¸€ä¸‹ï¼Œèƒ½ä¸èƒ½è·å¾—ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡åœ¨æŸä¸ª Driver ä¸­æ‹¿åˆ°ä¸€ä¸ªè¿æ¥å³è¿”å›è¿æ¥ (Connection)</span></span><br><span class="line"><span class="keyword">return</span> DriverManager.getConnection(url, props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€è¦çš„ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fncrgqcjqoj31es15ajxj.jpg" alt=""></p><h2 id="DriverManager"><a href="#DriverManager" class="headerlink" title="DriverManager"></a>DriverManager</h2><p>ä¸Šé¢æåˆ° DataSource è·å–è¿æ¥(Connection) çš„æ“ä½œå®è´¨ä¸Šå°†å§”æ‰˜å…·ä½“çš„ Driver æ¥æä¾› Connection ã€‚æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼ŒåŒ…æ‹¬ç»ç”± DriverManager éå†æ‰€æœ‰å¤„äºç®¡ç†ä¸‹çš„ Driver å°è¯•è·å–è¿æ¥ï¼Œæˆ–è€…åœ¨ DataSource å®ä¾‹ä¸­ç›´æ¥å£°æ˜ä¸€ä¸ªç‰¹å®šçš„ Driver æ¥è·å–è¿æ¥ã€‚</p><p>å¯¹äºè·å–è¿æ¥çš„å…·ä½“æ“ä½œï¼ŒæŒ–å‘-å¾…å¡«ã€‚åªæè¿°ç®€å•çš„æ•°æ®åº“ä¾›åº”å•†æä¾›çš„ Driver å¦‚ä½•ä¸ java ç›¸è”ç³»ã€‚</p><p>###åœ¨ DriverManager ä¸­æ³¨å†Œ Driver å®ä¾‹</p><p>é€šå¸¸åœ¨ä¸æ•°æ®åº“äº¤äº’é€»è¾‘çš„ Java ä»£ç ä¸­ï¼Œéƒ½ä¼šæœ‰ <code>Class.forName(&quot;com.mysql.jdbc.Driver&quot;)</code> (æ­¤å¤„ä»¥ MySQL æä¾›çš„ mysql-connector-java-XXX.jar ä¸ºä¾‹ï¼Œä¸‹åŒï¼‰çš„ä»£ç å—ï¼ŒåŠ è½½æŒ‡å®šçš„ com.mysql.jdbc.Driver ä¸º java.lang.Class ç±»ã€‚</p><p><em>å½“ç„¶ï¼Œåœ¨ JDBC 4.0 æ ‡å‡†ä¸‹ï¼Œå¯ä»¥ä¸å¿…å†æ˜¾ç¤ºå£°æ˜ <code>Class.forName(&quot;&quot;)</code> è¯­å¥ï¼ŒDriver ä¹ŸåŒæ ·ä¼šåœ¨ DriverManager åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ³¨å†Œã€‚</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class ç±»ä¸­å¯¹äº forName(String className) çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">// ä½œç”¨ä¸ºè¿”å›ä¸€ä¸ª java.lang.Class å®ä¾‹ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className) <span class="keyword">throws</span> ClassNotFoundException &#123;...&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œ JVM åœ¨åŠ è½½ç±»çš„è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œç±»ä¸­çš„ static ä»£ç å—ã€‚ä¸‹è¿° row 10 ~ 16 çš„ä»£ç ç‰‡æ®µå°†è¢«æ‰§è¡Œã€‚å”¯ä¸€çš„é€»è¾‘å°±æ˜¯ new ä¸€ä¸ª com.mysql.jdbc.Driver å®ä¾‹ï¼Œå¹¶å°†å®ä¾‹æ³¨å†Œ(registerDriver) åˆ° <strong>java.sql.DriverManager</strong> ä¸­ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mysql.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> <span class="keyword">extends</span> <span class="title">NonRegisteringDriver</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">sql</span>.<span class="title">Driver</span> </span>&#123;</span><br><span class="line"><span class="comment">// ~ Static fields/initializers</span></span><br><span class="line"><span class="comment">// ---------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Register ourselves with the DriverManager</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">java.sql.DriverManager.registerDriver(<span class="keyword">new</span> Driver());</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException E) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't register driver!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ~ Constructors</span></span><br><span class="line"><span class="comment">// -----------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Construct a new driver and register it with DriverManager</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment"> *             if a database error occurs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Driver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">// Required for Class.forName().newInstance()</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹ DriverManager ä¸­çš„ registerDriver() æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DriverManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DriverManager ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Driver åˆ—è¡¨</span></span><br><span class="line">  <span class="comment">// æ­¤å¤„çš„ DriverInfo é‡Œé¢å³åŒ…è£…äº† Driver </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers = </span><br><span class="line">      <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨ DriverManager ä¸­æ³¨å†Œ Driver</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">registerDriver</span><span class="params">(java.sql.Driver driver)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        registerDriver(driver, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">registerDriver</span><span class="params">(java.sql.Driver driver,</span></span></span><br><span class="line"><span class="function"><span class="params">            DriverAction da)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* å¦‚æœå½“å‰ Driver ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œå³æ·»åŠ åˆ°åˆ—è¡¨ã€‚ */</span></span><br><span class="line">        <span class="keyword">if</span>(driver != <span class="keyword">null</span>) &#123;</span><br><span class="line">            registeredDrivers.addIfAbsent(<span class="keyword">new</span> DriverInfo(driver, da));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This is for compatibility with the original DriverManager</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        println(<span class="string">"registerDriver: "</span> + driver);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡-DriverManager-è·å–è¿æ¥-Connection"><a href="#é€šè¿‡-DriverManager-è·å–è¿æ¥-Connection" class="headerlink" title="é€šè¿‡ DriverManager è·å–è¿æ¥(Connection)"></a>é€šè¿‡ DriverManager è·å–è¿æ¥(Connection)</h3><p>ä¸Šä¸€èŠ‚æœ‰æåˆ°è¿‡å¯ä»¥é€šè¿‡ DriverManager æ¥éå†è·å–è¿æ¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å£°æ˜å…·ä½“ Driver å¹¶è·å–è¿æ¥ã€‚ä¸‹é¢ä»£ç å±•ç¤ºçš„æ˜¯é€šè¿‡ DriverManager è·å–è¿æ¥çš„æ“ä½œã€‚ <del>å“ˆå“ˆå“ˆï¼Œåæ­£æœ€åéƒ½æ˜¯ç”±å…·ä½“é©±åŠ¨å®ç°è·å–è¿æ¥ã€‚</del></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DriverManager</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–è¿æ¥çš„ public æ¥å£ (1)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">(String url,</span></span></span><br><span class="line"><span class="function"><span class="params">java.util.Properties info)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·å–è¿æ¥çš„ public æ¥å£ (2)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">(String url,</span></span></span><br><span class="line"><span class="function"><span class="params">        String user, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        java.util.Properties info = <span class="keyword">new</span> java.util.Properties();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">            info.put(<span class="string">"user"</span>, user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (password != <span class="keyword">null</span>) &#123;</span><br><span class="line">            info.put(<span class="string">"password"</span>, password);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// è·å–è¿æ¥çš„ public æ¥å£ (3)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">(String url)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        java.util.Properties info = <span class="keyword">new</span> java.util.Properties();</span><br><span class="line">        <span class="keyword">return</span> (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// è·å–è¿æ¥çš„å†…éƒ¨é€»è¾‘å®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        String url, java.util.Properties info, Class&lt;?&gt; caller)</span> </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * When callerCl is null, we should check the application's</span></span><br><span class="line"><span class="comment">         * (which is invoking this class indirectly)</span></span><br><span class="line"><span class="comment">         * classloader, so that the JDBC driver class outside rt.jar</span></span><br><span class="line"><span class="comment">         * can be loaded from here.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ClassLoader callerCL = caller != <span class="keyword">null</span> ? caller.getClassLoader() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span>(DriverManager.class) &#123;</span><br><span class="line">            <span class="comment">// synchronize loading of the correct classloader.</span></span><br><span class="line">            <span class="keyword">if</span> (callerCL == <span class="keyword">null</span>) &#123;</span><br><span class="line">                callerCL = Thread.currentThread().getContextClassLoader();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// url æ˜¯å®šä½ DBMS æœ€é‡è¦çš„å‚æ•°ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span>(url == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"The url cannot be null"</span>, <span class="string">"08001"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        println(<span class="string">"DriverManager.getConnection(\""</span> + url + <span class="string">"\")"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// éå†æ‰€æœ‰æ³¨å†Œçš„ Driver ï¼Œå¹¶éƒ½å°è¯•è·å–è¿æ¥(Connection)</span></span><br><span class="line">        SQLException reason = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(DriverInfo aDriver : registeredDrivers) &#123;</span><br><span class="line">          <span class="comment">// åˆ¤æ–­æ³¨å†Œçš„ Driver æ˜¯å¦ç”± ClassLoader callerCL åŠ è½½ï¼Œä¸æ˜¯åˆ™è·³è¿‡</span></span><br><span class="line">            <span class="keyword">if</span>(isDriverAllowed(aDriver.driver, callerCL)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    println(<span class="string">"    trying "</span> + aDriver.driver.getClass().getName());</span><br><span class="line">                    <span class="comment">// è·å–è¿æ¥ï¼Œ:) è¿˜æ˜¯ç”± driver å®ä¾‹è‡ªè¡Œæä¾›</span></span><br><span class="line">                  Connection con = aDriver.driver.connect(url, info);</span><br><span class="line">                    <span class="keyword">if</span> (con != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// Success!</span></span><br><span class="line">                        println(<span class="string">"getConnection returning "</span> + </span><br><span class="line">                                aDriver.driver.getClass().getName());</span><br><span class="line">                        <span class="keyword">return</span> (con);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (reason == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        reason = ex;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                println(<span class="string">"    skipping: "</span> + aDriver.getClass().getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœè¿è¡Œåˆ°ä¸‹åˆ—ä»£ç ï¼Œåˆ™è¡¨æ˜è·å–è¿æ¥å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (reason != <span class="keyword">null</span>)    &#123;</span><br><span class="line">            println(<span class="string">"getConnection failed: "</span> + reason);</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        println(<span class="string">"getConnection: no suitable driver found for "</span>+ url);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"No suitable driver found for "</span>+ url, <span class="string">"08001"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>ç®€å•çš„æä¸€å˜´ï¼ŒConnection ä»ç„¶åªæ˜¯ä¸€ä¸ªé’ˆå¯¹ Java -&gt; DB Server çš„ä¸Šå±‚æ¥å£ï¼Œå¦‚æœæƒ³è¦æ›´æ·±å±‚æ¬¡åœ°äº†è§£ Connection ä¸ DB Server çš„äº¤äº’ï¼Œå¯ä»¥å°è¯•å»çœ‹ä¸€ä¸‹ com.mysql.jdbc.MysqlIO ç±»ï¼ŒMySQL å®ç°çš„ JDBC4Connection ç±»ä¹Ÿæ˜¯åœ¨ä½¿ç”¨è¯¥ç±»æ¥å®ç°å¯¹ DB Server äº¤äº’ã€‚ï¼ˆå“ˆå“ˆï¼Œåªçœ‹è¿‡ MySQL æä¾›çš„ Driver åŒ…ï¼‰ã€‚</em></p><h2 id="PreparedStatement-amp-CallableStatement"><a href="#PreparedStatement-amp-CallableStatement" class="headerlink" title="PreparedStatement &amp; CallableStatement"></a>PreparedStatement &amp; CallableStatement</h2><p>åœ¨äº†è§£äº† DataSource è·å–è¿æ¥(Connection) çš„å®è´¨ä»¥åŠ JdbcTemplate çš„é€šç”¨æ¥å£ä¹‹åï¼Œä½¿ç”¨ Spring-jdbc è¿›è¡Œæ•°æ®åº“ç›¸å…³çš„æ“ä½œå¯ä»¥ç›´æˆªäº†å½“çš„åˆ©ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œå®ç°ï¼ˆæ­¤å¤„ä»…å±•ç¤ºé€šè¿‡ Java ç¡¬ç¼–ç çš„å½¢å¼è¿›è¡Œå®ç°ï¼ŒXML é…ç½®æ–¹æ³•ç±»ä¼¼ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å®šä¹‰æ•°æ®æº</span></span><br><span class="line">DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">  <span class="comment">// é…ç½®å‚æ•°</span></span><br><span class="line">dataSource.setUrl(<span class="string">"jdbc:mysql://&lt;host&gt;:&lt;port&gt;/&lt;dbName&gt;?&lt;props&gt;"</span>);</span><br><span class="line">   dataSource.setUsername(<span class="string">"&lt;username&gt;"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"&lt;passwd&gt;"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ª JDBC å·¥å…·ç±»</span></span><br><span class="line">  JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">  <span class="comment">// æ‰§è¡Œç›¸å…³ CRUD æ“ä½œ</span></span><br><span class="line">  jdbcTemplate.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›é¡¾ç¬¬ä¸€èŠ‚æ‰€è®²çš„ JdbcTemplate çš„ 4 ä¸ªåŸºç¡€æ–¹æ³•ï¼š</p><ol><li><code>&lt;T&gt; T execute(ConnectionCallback&lt;T&gt; action);</code></li><li><code>&lt;T&gt; T execute(StatementCallback&lt;T&gt; action);</code></li><li><code>&lt;T&gt; T execute(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action);</code></li><li><code>&lt;T&gt; T execute(CallableStatementCreator csc, CallableStatementCallback&lt;T&gt; action);</code></li></ol><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fndsm5tl7aj30zg0byq47.jpg" alt=""></p><p>å››ä¸ªåŸºç¡€æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„å›è°ƒå‡½æ•°å°†é€šè¿‡é¢„é…ç½®çš„ DataSource å¾—åˆ°çš„ Connection æˆ– æ›´è¿›ä¸€æ­¥çš„ Statement or PreparedStatement or CallableStatement ä½œä¸ºå…¥å‚æ¥æ‰§è¡Œå®šä¹‰çš„å”¯ä¸€æ–¹æ³•ã€‚</p><p>ä»¥ <code>&lt;T&gt; T execute(StatementCallback&lt;T&gt; action);</code> ä¸ºä¾‹æ¥äº†è§£ä¸€ä¸‹æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(StatementCallback&lt;T&gt; action)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line"><span class="comment">// é€šè¿‡å·¥å…·ç±» DataSourceUtils è·å–ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">  Connection con = DataSourceUtils.getConnection(obtainDataSource());</span><br><span class="line">  <span class="comment">// ä¸€ä¸ª Statement ç©ºå®ä¾‹ï¼ŒPreparedStatement, CallableStatement ç±»ä¼¼</span></span><br><span class="line">Statement stmt = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">stmt = con.createStatement();<span class="comment">// é€šè¿‡è¿æ¥(Connection)è·å–ä¸€ä¸ª Statement</span></span><br><span class="line">applyStatementSettings(stmt);<span class="comment">// é…ç½® Statement å‚æ•°</span></span><br><span class="line">      <span class="comment">// å›è°ƒæ‰§è¡Œ doInXXX() æ–¹æ³•, å¹¶è·å¾— result</span></span><br><span class="line">T result = action.doInStatement(stmt);</span><br><span class="line">handleWarnings(stmt);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span>() &#123;</span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œå¯¹äº PreparedStatement å’Œ CallableStatement è€Œè¨€ï¼Œè·å–ä¸€ä¸ª <em>XXX</em>Statement çš„æ–¹å¼å°±æœ‰æ‰€ä¸åŒäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– Statement å®ä¾‹</span></span><br><span class="line">Statement stmt = con.createStatement();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– PreparedStatement å®ä¾‹</span></span><br><span class="line"><span class="comment">// psc æ˜¯ä¸€ä¸ª PreparedStatementCreator æ¥å£å®ç°çš„å®ä¾‹</span></span><br><span class="line">PreparedStatement ps = psc.createPreparedStatement(con);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– CallableStatement å®ä¾‹</span></span><br><span class="line"><span class="comment">// csc æ˜¯ä¸€ä¸ª CallableStatementCreator æ¥å£å®ç°çš„å®ä¾‹</span></span><br><span class="line">CallableStatement cs = csc.createCallableStatement(con);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Statement ç›´æ¥é€šè¿‡ Connection è·å–å®ä¾‹ï¼Œä½†æ˜¯ PreparedStatement å’Œ CallableStatement å°±æœ‰æ‰€ä¸åŒï¼Œå…¶åŒºåˆ«å°±åœ¨äº PreparedStatement å’Œ CallableStatement ä¸¤ä¸ª Statement éƒ½æ˜¯å¯ä»¥å®šåˆ¶å…¥å‚çš„ï¼Œæ›´ç”šè€…ï¼Œ CallableStatement å¯ä»¥å®šåˆ¶ DB æ‰§è¡Œç»“æœçš„å‡ºå‚ã€‚å½“ç„¶ï¼Œæ ¸å¿ƒè¿˜æ˜¯ <code>con.prepareStatement() OR con.prepareCall()</code> æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯å°†è·å– XXXStatement çš„æ“ä½œä¸‹æ”¾ç»™ XXXStatementCreator å®ä¾‹ç±»å®ç°ï¼Œç»™äºˆä½¿ç”¨è€…é‡å¤çš„è‡ªä¸»æƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯é€»è¾‘è§£è€¦çš„ä¸€ç§æ“ä½œã€‚</p><p>ä¾‹å¦‚ï¼š</p><p>SimplePreparedStatementCreator è¿™ä¸ª PreparedStatementCreator æ¥å£çš„å®ç°ç±»ï¼Œåªæ˜¯ç®€å•çš„è°ƒç”¨äº† <code>con.prepareStatement(sql)</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePreparedStatementCreator</span> </span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">PreparedStatementCreator</span>, <span class="title">SqlProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String sql;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">createPreparedStatement</span><span class="params">(Connection con)</span> </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> con.prepareStatement(<span class="keyword">this</span>.sql);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå¯¹äº PreparedStatementCreatorImpl ï¼Œåœ¨ createPreparedStatement(Connection con) çš„å®ç°ä¸Šï¼Œåˆæ·»åŠ äº†æ›´å¤šçš„æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementCreatorImpl</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">PreparedStatementCreator</span>, <span class="title">PreparedStatementSetter</span>, <span class="title">SqlProvider</span>, <span class="title">ParameterDisposer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String actualSql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;?&gt; parameters;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">createPreparedStatement</span><span class="params">(Connection con)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">PreparedStatement ps;</span><br><span class="line"><span class="keyword">if</span> (generatedKeysColumnNames != <span class="keyword">null</span> || returnGeneratedKeys) &#123;</span><br><span class="line"><span class="keyword">if</span> (generatedKeysColumnNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// è·å–ä¸€ä¸ª PreparedStatement å®ä¾‹ï¼Œä¸‹åŒ</span></span><br><span class="line">ps = con.prepareStatement(<span class="keyword">this</span>.actualSql, </span><br><span class="line">                                          generatedKeysColumnNames);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">ps = con.prepareStatement(<span class="keyword">this</span>.actualSql, </span><br><span class="line">                                         PreparedStatement.RETURN_GENERATED_KEYS);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (resultSetType == ResultSet.TYPE_FORWARD_ONLY </span><br><span class="line">                 &amp;&amp; !updatableResults) &#123;</span><br><span class="line">ps = con.prepareStatement(<span class="keyword">this</span>.actualSql);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">ps = con.prepareStatement(<span class="keyword">this</span>.actualSql, resultSetType,</span><br><span class="line">updatableResults ? ResultSet.CONCUR_UPDATABLE : </span><br><span class="line">                                      ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">&#125;</span><br><span class="line">      <span class="comment">// å°†å¯å˜ SQL (ä¾‹å¦‚ SELECT * FROM msg WHERE id = ?) çš„ ? ç”¨å®é™…å‚æ•°æ›¿æ¢</span></span><br><span class="line">setValues(ps);</span><br><span class="line"><span class="keyword">return</span> ps;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°ä¸¤ç§ PreparedStatementCreator æ¥å£çš„ä¸åŒå®ç°ï¼Œä¹Ÿå¯ä»¥ä»å¦ä¸€ç§è§’åº¦ç†è§£åˆ°ï¼Œå‡½æ•°å¼æ¥å£å°†è·å–ç›®æ ‡å‡ºå‚çš„å…·ä½“é€»è¾‘äº¤ç»™ä½¿ç”¨è€…å®šä¹‰ï¼Œç»™äºˆäº†ä½¿ç”¨è€…å……åˆ†çš„è‡ªä¸»æƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç§ä¸šåŠ¡é€»è¾‘çš„è§£è€¦ã€‚</p><p>åœ¨ä¸Šé¢ä»£ç  PreparedStatementCreatorImpl ç±»çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç¬¬ 32 è¡Œä»£ç  <code>setValue(ps)</code> ã€‚æ­¤å¤„çš„æ–¹æ³•æ˜¯ç”±æ¥å£ PreparedStatementSetter å®šä¹‰çš„ã€‚ä¸»è¦ç›®çš„æ˜¯å°†å¯å˜ SQL ä¸­çš„ ? å‚æ•°ç”¨å®é™…å‚æ•°è¿›è¡Œä¸€ä¸ªæ›¿æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»¥ SQL (SELECT * FROM msg WHERE id = ? AND day = ?) ä¸ºä¾‹</span></span><br><span class="line"><span class="comment">/** çº¯ Java æ ¸å¿ƒåº“çš„å®ç° PreparedStatement å‚æ•°æ³¨å…¥ */</span></span><br><span class="line">ps.setInt(<span class="number">1</span>, <span class="number">1763</span>);</span><br><span class="line">ps.setString(<span class="number">2</span>, <span class="string">"2018-01-01"</span>);</span><br><span class="line">ps.executeQuery();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ä»¥ Spring-jdbc å®ç° PreparedStatement å‚æ•°æ³¨å…¥ */</span></span><br><span class="line"><span class="comment">// setValues() ç”±æ¥å£ PreparedStatementSetter å®šä¹‰ï¼Œå°è£…äº†æ³¨å…¥å‚æ•°çš„å…·ä½“å®ç°é€»è¾‘</span></span><br><span class="line"><span class="comment">// å¯ä»¥ç”±ä½¿ç”¨è€…è‡ªè¡Œå®šä¹‰</span></span><br><span class="line">setValues(ps);</span><br><span class="line">ps.executeQuery();</span><br></pre></td></tr></table></figure><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fndyybh4q1j31kw0u3afx.jpg" alt=""></p><p>ä¸Šé¢ç±»å›¾è¡¨ç¤ºäº† PreparedStatementSetter åŠå…¶å®ç°ç±»çš„ç›¸å…³ä¾èµ–ã€‚</p><p>Setter çš„ä¸»è¦ç›®æ ‡å³ä¸ºå¯¹ SQL ä¸­çš„ ? å‚æ•°è¿›è¡Œæ³¨å…¥ã€‚</p><p><del>ä¸ªäººç²¾åŠ›æœ‰é™ï¼Œå¯¹Spring-jdbcåœ¨Statementä¸Šå¯¹å‚æ•°æ³¨å…¥çš„å›è°ƒç†è§£æœ‰é™ã€‚</del></p><h2 id="ResultSet"><a href="#ResultSet" class="headerlink" title="ResultSet"></a>ResultSet</h2><p>åœ¨å‰å‡ èŠ‚å·²ç»æåˆ°è®²äº†æ•°æ®æºã€é©±åŠ¨ç®¡ç†å™¨ä»¥åŠ Statement ä¹‹åï¼Œåˆ©ç”¨ JDBC çš„æœ€é‡è¦çš„ç›®çš„å°±æ˜¯å¯¹ DB è¿›è¡Œæ“ä½œï¼Œå¹¶è·å¾—é¢„æœŸç»“æœã€‚å¯¹äºæŸ¥è¯¢è¯­å¥è€Œè¨€ï¼Œç»“æœåº”è¯¥æ˜¯è‹¥å¹²è®°å½•è¡Œï¼›å°±æ›´æ–°è¯­å¥è€Œè¨€ï¼Œç»“æœå¯èƒ½æ˜¯å½±å“çš„è¡Œæ•°ã€‚è€Œ Spring-jdbc å¯¹ ResultSet é¢å¤–è¿›è¡Œçš„å°è£…ï¼Œå³æ˜¯å°†åŸæœ¬æ•£ä¹±çš„ç»“æœè¿›è¡Œä¸€ä¸ªæ•´åˆï¼Œä¾‹å¦‚æ•´åˆæˆä¸€ä¸ª(ä¸€ç»„)å®Œæ•´çš„ Bean æ¥è¿›è¡Œå±•ç¤ºã€‚</p><p>åœ¨ JdbcTemplate ä¸­ï¼Œå››ä¸ªåŸºæœ¬æ–¹æ³•å…¥å‚éƒ½åŒ…æ‹¬ä¸€ä¸ªå›è°ƒæ¥å£ï¼Œè€Œåœ¨æ‰§è¡Œå›è°ƒè·å¾— ResultSet ä¹‹åï¼Œæ–¹æ³•å¹¶ä¸æ˜¯ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯è¿›è¡Œäº†ä¸€å®šçš„æ“ä½œã€‚</p><p>ä»¥ä¸€ä¸ª PreparedStatementCallback çš„å®ä¾‹ç±»ä¸ºä¾‹ï¼Œåœ¨ doInPreparedStatement() æ–¹æ³•ä¸­ï¼Œè·å¾—äº† ResultSet ï¼Œä½†æ˜¯ä»é€šè¿‡ rse.extractData(rs) è¯­å¥è¿›è¡Œäº†å¤„ç†åå†è¿”å›ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">doInPreparedStatement</span><span class="params">(PreparedStatement ps)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="comment">// å£°æ˜ä¸€ä¸ª ResultSet </span></span><br><span class="line">ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (pss != <span class="keyword">null</span>) &#123;<span class="comment">// setValues() æ–¹æ³•å¡«å…… PreparedStatement ä¸­çš„å¯å˜å‚æ•° ? </span></span><br><span class="line">pss.setValues(ps);</span><br><span class="line">&#125;</span><br><span class="line">rs = ps.executeQuery();<span class="comment">// æ‰§è¡ŒæŸ¥è¯¢ sql ï¼Œè·å–ç»“æœ</span></span><br><span class="line"><span class="keyword">return</span> rse.extractData(rs);<span class="comment">// é‡ç‚¹... è¯¥è¯­å¥ä¸€å®šæ˜¯å¯¹ç»“æœè¿›è¡Œäº†ä¸€äº›æ“ä½œ.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">JdbcUtils.closeResultSet(rs);</span><br><span class="line"><span class="keyword">if</span> (pss <span class="keyword">instanceof</span> ParameterDisposer) &#123;</span><br><span class="line">((ParameterDisposer) pss).cleanupParameters();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¥çœ‹ä¸€ä¸‹ç©¶ç«Ÿåœ¨è¿”å›ç»“æœå‰è¿›è¡Œäº†ä»€ä¹ˆæ“ä½œã€‚</p><p>ç”±äºæ˜¯ä¸€ä¸ªå›è°ƒæ¥å£çš„å®ç°ç±»ï¼Œrse åº”è¯¥åœ¨å¤–éƒ¨æ–¹æ³•ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">query</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">PreparedStatementCreator psc, @Nullable <span class="keyword">final</span> PreparedStatementSetter pss, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> ResultSetExtractor&lt;T&gt; rse)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> execute(psc, <span class="keyword">new</span> PreparedStatementCallback&lt;T&gt;() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">doInPreparedStatement</span><span class="params">(PreparedStatement ps)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">...</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° rse æ˜¯ä¸€ä¸ª ResultSetExtractor<t> çš„å®ä¾‹ã€‚ä»åç§°ä¸Šå¯ä»¥çœ‹å‡º Extractor å³ä¸ºæå–å™¨ï¼Œç»“æœé›†æå–å™¨ã€‚</t></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** å‡½æ•°å¼æ¥å£ï¼Œæä¾›çš„å”¯ä¸€æ–¹æ³•ä¸º extractData(...) */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResultSetExtractor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">T <span class="title">extractData</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> SQLException, DataAccessException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fndzz0pqnrj31a60i676v.jpg" alt=""></p><p>Spring-jdbc ä¸­ç°æœ‰çš„å®ç°æœ‰ä¸‰ä¸ªç±»ï¼Œå…¶ä¸­ RowCallbackHandlerResultSetExtractor å’Œ RowMapperResultSetExtractor ä¸¤ä¸ªç±»ä»ä¸Šé¢ç±»å›¾åŠå‘½åå³å¯çœ‹å‡ºï¼Œä¸¤ä¸ªæ˜¯ä½œä¸ºä¸€ä¸ªé€‚é…å™¨è€Œå­˜åœ¨çš„ï¼Œå°† extractData() è¿›è¡Œè½¬æ¢ï¼Œåˆ†åˆ«ç”± RowCallbackHandler å’Œ RowMapper å®ä¾‹è¿›è¡Œå…·ä½“æ“ä½œã€‚è€Œ AbstractLobStreamingResultSetExtractor ç±»ä»åç§°ä¸Šçœ‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç±»ä¼¼æµæ“ä½œçš„å®ç°ç±»(å…¶ä¸­çš„ Lob æŒ‡çš„æ˜¯ DB ä¸­çš„ BLOB ä¸ CLOB ç±»å‹ï¼Œåœ¨ Spring-jdbc ä¸­ä¹ŸåŠ å…¥äº†é¢å¤–çš„æ”¯æŒ) ã€‚</p><h3 id="RowCallbackHandler"><a href="#RowCallbackHandler" class="headerlink" title="RowCallbackHandler"></a>RowCallbackHandler</h3><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fnh2uw3a0aj30h20jeta4.jpg" alt=""></p><p>ä»åç§°ä¸Šçœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ ResultSet ç»“æœé›†è¡Œç›¸å…³çš„å›è°ƒæ¥å£ã€‚processRow(ResultSet rs) æ–¹æ³•å°†å¤„ç†è¡Œç›¸å…³çš„é€»è¾‘ã€‚</p><p>ä»å®ƒçš„ä¸€ä¸ªå®ç°ç±» RowCountCallbackHandler æ¥è¯´ï¼Œå…¶æœ€ä¸»è¦çš„ç§æœ‰å±æ€§ rowCount å³æ˜¯ç»Ÿè®¡ ResultSet çš„ç»“æœè¡Œæ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“ä½¿ç”¨çš„è¯¥ç±»çš„æ¡ˆä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">    DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">    dataSource.setUrl(<span class="string">"jdbc:mysql://&lt;host&gt;:&lt;port&gt;/&lt;dbName&gt;"</span>);</span><br><span class="line">    dataSource.setUsername(<span class="string">"&lt;username&gt;"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"&lt;password&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    RowCountCallbackHandler rcch = <span class="keyword">new</span> RowCountCallbackHandler();</span><br><span class="line"></span><br><span class="line">    jdbcTemplate.query(<span class="string">"SELECT * FROM info WHERE id='2018'"</span>, </span><br><span class="line">                       (RowCallbackHandler) rcch);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  System.out.println(rcch.getRowCount());<span class="comment">//è·å–ç»“æœé›†è¡Œæ•°</span></span><br><span class="line">    System.out.println(rcch.getColumnCount());<span class="comment">// è·å–ç»“æœé›†åˆ—æ•°</span></span><br><span class="line">    <span class="keyword">for</span> (String arg : rcch.getColumnNames()) &#123;<span class="comment">// æ‰“å°ç»“æœé›†æ¯ä¸€åˆ—åç§°</span></span><br><span class="line">        System.out.println(<span class="string">"ColumnNames : "</span> + arg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i : rcch.getColumnTypes()) &#123;<span class="comment">// æ‰“å°ç»“æœé›†æ¯ä¸€åˆ—ç±»å‹(Types ä¸ºæšä¸¾ç±»)</span></span><br><span class="line">        System.out.println(<span class="string">"ColumnTypes : "</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“æŸ¥çœ‹ RowCountCallbackHandler ç±»çš„ processRow() æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå…¶è·å–åˆ—ç›¸å…³ä¿¡æ¯éƒ½æ¥è‡ªäº ResultSetMetaData ã€‚è€Œç»“æœè¡Œæ•°æ¥æºäº Iterator è¿­ä»£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processRow</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.rowCount == <span class="number">0</span>) &#123;</span><br><span class="line">ResultSetMetaData rsmd = rs.getMetaData();</span><br><span class="line"><span class="keyword">this</span>.columnCount = rsmd.getColumnCount();</span><br><span class="line"><span class="keyword">this</span>.columnTypes = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="keyword">this</span>.columnCount];</span><br><span class="line"><span class="keyword">this</span>.columnNames = <span class="keyword">new</span> String[<span class="keyword">this</span>.columnCount];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.columnCount; i++) &#123;</span><br><span class="line"><span class="keyword">this</span>.columnTypes[i] = rsmd.getColumnType(i + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">this</span>.columnNames[i] = JdbcUtils.lookupColumnName(rsmd, i + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// could also get column names</span></span><br><span class="line">&#125;</span><br><span class="line">processRow(rs, <span class="keyword">this</span>.rowCount++);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RowMapper"><a href="#RowMapper" class="headerlink" title="RowMapper"></a>RowMapper</h3><p>ä¸Šé¢ RowCallbackHandler æ¥å£ä»é€»è¾‘ä¸Šåˆ’åˆ†æ˜¯ç”¨äºå¤„ç† ResultSet å…ƒæ•°æ®ä¿¡æ¯çš„ã€‚è€Œ RowMapper è¾ƒä¸Šä¸€ä¸ªæ¥å£è€Œè¨€ï¼Œæœ‰æ›´é«˜çš„å®ç”¨æ€§ã€‚</p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fnh3h739kaj30z60nago4.jpg" alt=""></p><p>ç‰¹åˆ«æ˜¯å…¶å®ç°ç±» BeanPropertyRowMapper<t> å¯ä»¥å°†æ•£ä¹±çš„ ResultSet çš„ç»“æœæ•°æ®æ•´ç†æˆä¸€ä¸ªä¸ª Object Bean ä½œä¸ºè¿”å›ç»“æœã€‚è€Œçœå»äº†å¯¹é€ä¸€è¯»å– ResultSet è¡Œè®°å½•å¹¶å¡«å…… Bean å±æ€§çš„éº»çƒ¦ã€‚</t></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line"></span><br><span class="line">BeanPropertyRowMapper&lt;Model&gt; rowMapper = <span class="keyword">new</span> BeanPropertyRowMapper&lt;&gt;(Model.class);</span><br><span class="line">List&lt;Model&gt; list = jdbcTemplate.query(</span><br><span class="line">  <span class="string">"SELECT * FROM info WHERE id = '2018'"</span>, rowMapper);</span><br><span class="line"><span class="comment">/** è·å¾—çš„ Model list çš„å¯¹åº”å±æ€§å°†é€šè¿‡ Java çš„åå°„æœºåˆ¶è¿›è¡Œå¡«å……</span></span><br><span class="line"><span class="comment"> *List&lt;Model&gt; list å³ç»“æœ</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œè¦æ±‚æ˜¯ Model ç±»ä¸­çš„å±æ€§ä¸ DB table ä¸­çš„åˆ—åä¿æŒä¸€è‡´ï¼ˆå¤§å°å†™æ— è¦æ±‚ï¼‰ã€‚</p><p>è€Œå…¶å®ƒä¸¤ä¸ªç±»çš„å®ç°ä¹Ÿæ˜¯åŸºäºåå°„æœºåˆ¶ï¼Œå®ç°å…¶ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
      <category term="Spring" scheme="http://utop.xin/tags/Spring/"/>
    
      <category term="JDBC" scheme="http://utop.xin/tags/JDBC/"/>
    
  </entry>
  
  <entry>
    <title>åŒºå—é“¾æŠ€æœ¯æ¦‚è¿°</title>
    <link href="http://utop.xin/2018-03-01-%E5%8C%BA%E5%9D%97%E9%93%BE%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/"/>
    <id>http://utop.xin/2018-03-01-åŒºå—é“¾ç®€å•ä»‹ç»/</id>
    <published>2018-06-12T12:38:18.604Z</published>
    <updated>2018-06-12T12:38:18.604Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __</span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _</span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fs8oc4ri7qj30mq055aap.jpg" alt="åŒºå—é“¾ç®€å•ç»“æ„"></p><center><small>å›¾1. åŒºå—é“¾ç®€å•ç»“æ„</small></center><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1foxcpmmpfhj31kw107n2e.jpg" alt="Merkle tree"></p><center><small>å›¾2. å•ä¸ªåŒºå—çš„æŠ½è±¡ç»“æ„</small></center><h2 id="åŸºæœ¬å·¥ä½œæµç¨‹"><a href="#åŸºæœ¬å·¥ä½œæµç¨‹" class="headerlink" title="åŸºæœ¬å·¥ä½œæµç¨‹"></a>åŸºæœ¬å·¥ä½œæµç¨‹</h2><p>###æ–°äº¤æ˜“å‘èµ·æµç¨‹</p><ol><li>ç”¨æˆ·é€šè¿‡å…¬/ç§é’¥ä¸åŒºå—é“¾ç½‘ç»œè¿›è¡Œäº¤äº’</li><li>å¤„ç†ç”¨æˆ·äº¤æ˜“çš„èŠ‚ç‚¹å‘ç½‘ç»œé‚»èŠ‚ç‚¹å¹¿æ’­ç”¨æˆ·äº¤æ˜“</li><li>é‚»èŠ‚ç‚¹éªŒè¯äº¤æ˜“çš„æœ‰æ•ˆæ€§ï¼›å¯ä¿¡ï¼Œç»§ç»­å‘å…¶å®ƒé‚»èŠ‚ç‚¹å¹¿æ’­ï¼›ä¸å¯ä¿¡ï¼Œä¸¢å¼ƒã€‚</li></ol><h3 id="æ–°åŒºå—äº§ç”Ÿæµç¨‹"><a href="#æ–°åŒºå—äº§ç”Ÿæµç¨‹" class="headerlink" title="æ–°åŒºå—äº§ç”Ÿæµç¨‹"></a>æ–°åŒºå—äº§ç”Ÿæµç¨‹</h3><ol><li>çŸ¿å·¥å°è¯•å°†ä¸€ä¸ªæ—¶é—´åŒºé—´å†…çš„äº¤æ˜“è¿›è¡Œæ‰“åŒ…å½¢æˆæ–°åŒºå—ï¼ˆæ€ä¹ˆæ‰“åŒ…ï¼Œçœ‹ä¸‹æ–‡ï¼‰</li><li>ç”Ÿäº§å‡ºæ–°åŒºå—çš„çŸ¿å·¥èŠ‚ç‚¹å‘ç½‘ç»œå¹¿æ’­æ–°åŒºå—</li><li>æ”¶åˆ°æ–°åŒºå—çš„ç½‘ç»œèŠ‚ç‚¹éªŒè¯è¯¥åŒºå—çš„æœ‰æ•ˆæ€§</li></ol><p><a href="https://blockchain.info/zh-cn" target="_blank" rel="noopener">æ¯”ç‰¹å¸åŒºå—æµè§ˆå™¨</a>      æ›´å¤š<a href="https://en.wikipedia.org/wiki/Metric_prefix" target="_blank" rel="noopener">å›½é™…å•ä½åˆ¶å‰ç¼€</a></p><h2 id="ç½‘ç»œå…±è¯†"><a href="#ç½‘ç»œå…±è¯†" class="headerlink" title="ç½‘ç»œå…±è¯†"></a>ç½‘ç»œå…±è¯†</h2><p>æ‰€æœ‰åŒºå—é“¾ç½‘ç»œèŠ‚ç‚¹éœ€è¦å¯¹äº¤æ˜“ä»¥åŠå…¶åœ¨æ–°åŒºå—é‡Œé¢çš„é¡ºåºè¾¾æˆä¸€è‡´ï¼ˆäº¤æ˜“çš„æœ‰æ•ˆæ€§ä»¥åŠäº¤æ˜“çš„æ‰“åŒ…é¡ºåºï¼‰ã€‚</p><p>å¯èƒ½å‡ºç°ï¼š</p><ul><li>å¥³å·«æ”»å‡»â€”â€”å•ä¸€å®ä½“ä»¥å¤šé‡èº«ä»½é‡å¤å¯¹æ–°åŒºå—ç»“æœè¿›è¡Œè¡¨å†³ï¼ˆå°‘æ•°äººæŠ“ä½äº†ç½‘ç»œçš„æŠ•ç¥¨æƒï¼‰</li><li><a href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">æ‹œå åº­å°†å†›é—®é¢˜</a>â€”â€”åˆ†å¸ƒå¼å¯¹ç­‰ç½‘ç»œçš„é€šä¿¡å®¹é”™é—®é¢˜<ul><li>ä¸åŒçš„è®¡ç®—æœºé€šè¿‡é€šè®¯äº¤æ¢ä¿¡æ¯è¾¾æˆå…±è¯†è€ŒæŒ‰ç…§åŒä¸€å¥—åä½œç­–ç•¥è¡ŒåŠ¨<ul><li>æˆå‘˜è®¡ç®—æœºå¯èƒ½å‡ºé”™è€Œå‘é€é”™è¯¯ä¿¡æ¯</li><li>ç½‘ç»œçš„ä¸å¯é æ€§</li><li>ä»è€Œå½±å“ç½‘ç»œå…±è¯†çš„è¾¾æˆï¼Œç ´åä¸€è‡´æ€§ã€‚</li></ul></li><li>ä¸è§£å†³çš„è¯å¯èƒ½å¯¼è‡´â€”â€”åŒºå—é“¾åˆ†å‰</li></ul></li></ul><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>å·¥ä½œé‡è¯æ˜ï¼ˆproof-of-work, PoWï¼‰ï¼Œæƒç›Šè¯æ˜(proof-of-stake, PoS)ï¼Œç™½åå•æœºåˆ¶ï¼ˆä»…é€‚ç”¨äºç§æœ‰ç½‘ç»œï¼‰ç­‰</li><li>å®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•</li></ul><h3 id="å±€é™"><a href="#å±€é™" class="headerlink" title="å±€é™"></a>å±€é™</h3><p>ç½‘ç»œå…±è¯†æœºåˆ¶çš„å®ç°å¯¼è‡´äº†ï¼š</p><ol><li>äº¤æ˜“ååé‡</li><li>æ›´é«˜çš„äº¤æ˜“æ—¶å»¶ã€‚äº¤æ˜“ç¡®è®¤æ—¶é—´ï¼ˆåªæœ‰æ‰“åŒ…çš„æ–°åŒºå—ä¸­æ‰äº¤æ˜“æ‰ä¼šè¢«æ‰¿è®¤ï¼‰ã€‚</li></ol><p>å…±è¯†æœºåˆ¶çš„ä¼¸ç¼©å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³ä¸Šè¿°é—®é¢˜</p><h2 id="èµ„äº§äº¤æ˜“"><a href="#èµ„äº§äº¤æ˜“" class="headerlink" title="èµ„äº§äº¤æ˜“"></a>èµ„äº§äº¤æ˜“</h2><p>ç®€å•äº¤æ˜“çŠ¶æ€æè¿°ï¼Œä»¥é›†ä¸­å¼æ•°æ®åº“ä¸ºä¾‹</p><p>å‡è®¾åˆå§‹çŠ¶æ€ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-------------------------</span><br><span class="line">| èµ„äº§ç±»å‹ | æ‰€æœ‰è€… | æ•°é‡ |</span><br><span class="line">-------------------------</span><br><span class="line">|   CNY   |  é˜²é£  |  10 |</span><br><span class="line">-------------------------</span><br><span class="line">|   CNY   |  çº¢è–¯  |  0  |</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure><p>é˜²é£ å‘ çº¢è–¯ è½¬è´¦ 2 CNY </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-------------------------</span><br><span class="line">| èµ„äº§ç±»å‹ | æ‰€æœ‰è€… | æ•°é‡ |</span><br><span class="line">-------------------------</span><br><span class="line">|   CNY   |  é˜²é£  |  8  |</span><br><span class="line">-------------------------</span><br><span class="line">|   CNY   |  çº¢è–¯  |  2  |</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure><p>æ•°æ®åº“ä¸­ç›¸åº”è®°å½•çš„æ›´æ”¹å®Œæˆäº†èµ„äº§çš„äº¤æ˜“è¿‡ç¨‹ã€‚</p><p>åœ¨åŒºå—é“¾ä¸­ï¼Œä»ç„¶å°†åˆ†å¸ƒå¼é“¾çœ‹ä½œæ˜¯ä¸€ä¸ªè¾¾æˆå…±è¯†çš„é›†ä¸­å¼æ•°æ®åº“</p><p>é‚£ä¹ˆç°åœ¨çš„åˆå§‹çŠ¶æ€å¯ä»¥è¡¨ç¤ºæˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------</span><br><span class="line">| èµ„äº§ç±»å‹ |     æ‰€æœ‰è€…     | æ•°é‡ |</span><br><span class="line">---------------------------------</span><br><span class="line">|   IOTA  |  é˜²é£ pub_key  | 10  |</span><br><span class="line">---------------------------------</span><br></pre></td></tr></table></figure><p>ç°åœ¨çš„æ‰€æœ‰è€…ç”±å…¬é’¥è¡¨ç¤ºï¼Œæƒ³è¦ä¿®æ”¹è®°å½•å¿…é¡»æä¾›å¯¹åº”çš„å¯†é’¥ã€‚</p><p>ä¾‹å¦‚ï¼Œé˜²é£ å‘ çº¢è–¯ è½¬è´¦ 2 IOTA ï¼Œéœ€è¦æä¾›é˜²é£çš„ç§é’¥å’Œçº¢è–¯çš„å…¬é’¥ã€‚äº¤æ˜“è®°å½•ä¿®æ”¹ç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------</span><br><span class="line">| èµ„äº§ç±»å‹ |     æ‰€æœ‰è€…     | æ•°é‡ |</span><br><span class="line">---------------------------------</span><br><span class="line">                                 è¢«åˆ é™¤äº†         |   IOTA  |  é˜²é£ pub_key  | 10  |</span><br><span class="line">---------------------------------</span><br><span class="line">|   IOTA  |  çº¢è–¯ pub_key  |  2  |</span><br><span class="line">---------------------------------</span><br><span class="line">|   IOTA  |  é˜²é£ pub_key  |  8  |</span><br></pre></td></tr></table></figure><p>äº¤æ˜“çš„æ¦‚å¿µæµç¨‹ï¼š</p><ol><li>å®šä½é˜²é£æ‰€æœ‰çš„èµ„äº§è®°å½•è¡Œ</li><li>åˆ é™¤è¯¥è¡Œå‰éªŒè¯å¯†é’¥</li><li>ç¡®è®¤è¯¥è®°å½•æ²¡æœ‰è¢«åˆ«çš„äº¤æ˜“ä½¿ç”¨ï¼ˆåŒèŠ±é—®é¢˜ï¼ŒåŒé‡äº¤æ˜“ï¼‰</li><li>å†™å…¥æ–°çš„æ­£ç¡®çš„è®°å½•ï¼ˆçº¢è–¯è·å¾—çš„èµ„äº§ &amp; é˜²é£å‰©ä½™çš„èµ„äº§ï¼‰ï¼Œç¡®ä¿äº¤æ˜“å‰ä¸äº¤æ˜“åèµ„äº§æ€»é¢ä¸å˜</li></ol><p>ä¸Šé¢çš„æ¨¡å‹ â€”â€” åŸºäºæ¯”ç‰¹å¸çš„äº¤æ˜“æ¨¡å‹(UTXO <em>model</em>)</p><p><strong>é€‚åˆäºæ•°å­—æ ‡è®°èµ„äº§çš„ä¼ è¾“ä¸è¿½è¸ª</strong></p><ul><li>æ¦‚å¿µï¼šUTXO (unspent transaction outputs) æœªèŠ±è´¹çš„äº¤æ˜“è¾“å‡ºï¼šæ•°æ®åº“ç°æœ‰çš„è®°å½•</li></ul><p>-â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“</p><p>å¦ä¸€ç§æ¨¡å‹å¸¸ç”¨äºæ™ºèƒ½åˆçº¦ â€”â€” åŸºäºè´¦å·çš„æ¨¡å‹(account-based <em>model</em>)</p><p><strong>æä¾›äº†å»ºç«‹å¤šæ­¥éª¤æ‰§è¡Œçš„åŸºæœ¬æœºåˆ¶</strong> </p><h3 id="èµ„äº§å¦‚ä½•äº§ç”Ÿ"><a href="#èµ„äº§å¦‚ä½•äº§ç”Ÿ" class="headerlink" title="èµ„äº§å¦‚ä½•äº§ç”Ÿ"></a>èµ„äº§å¦‚ä½•äº§ç”Ÿ</h3><ul><li>æ¯”ç‰¹å¸ï¼š<ul><li>çŸ¿å·¥èŠ‚ç‚¹å…è®¸åœ¨æŒ–å‡ºçš„æ–°èŠ‚ç‚¹ä¸­åŠ å…¥ä¸€ç§ coinbase ç±»å‹çš„äº¤æ˜“ï¼ˆä¸å­˜åœ¨äº¤æ˜“è¾“å…¥ï¼Œæ–°èµ„äº§æ•°é¢æœ‰æ¯”ç‰¹å¸é“¾æå‰å®šä¹‰ï¼‰</li></ul></li><li>åœ¨åˆ›å§‹æ–°ä»£å¸çš„æ—¶å€™å…¨é¢å‘è¡Œ</li><li>å…¶å®ƒæœºåˆ¶</li></ul><h2 id="åŒºå—é“¾ç‰¹æ€§"><a href="#åŒºå—é“¾ç‰¹æ€§" class="headerlink" title="åŒºå—é“¾ç‰¹æ€§"></a>åŒºå—é“¾ç‰¹æ€§</h2><ol><li>ä¸€ç§å¥å£®çš„ã€çœŸæ­£çš„åˆ†å¸ƒå¼å¯¹ç­‰ç³»ç»Ÿï¼Œå®ƒèƒ½å®¹å¿èŠ‚ç‚¹æ•…éšœã€‚</li><li>èƒ½å¤Ÿè¯†åˆ«å†²çªå’Œåˆ†å‰å¹¶è‡ªåŠ¨è§£å†³çš„ç½‘ç»œï¼Œä»¥ä¾¿æ”¶æ•›åˆ°å•ä¸€çš„ã€å…¬è®¤çš„å”¯ä¸€çŠ¶æ€ã€‚ï¼ˆåŒºå—é“¾æ°¸è¿œé€‰æ‹©æœ€é•¿çš„åˆ†æ”¯æ¥è¾¾æˆç½‘ç»œä¸Šçš„å…±è¯†ï¼‰</li><li>ç½‘ç»œæ´»åŠ¨çš„é€æ˜æ€§ã€å¯éªŒè¯æ€§ã€å¯å®¡è®¡æ€§ã€‚æˆ‘ä»¬èƒ½è·å–å¯éªŒè¯çš„è¿‡ç¨‹ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦äº¤æ¢å’Œè·Ÿè¸ªæ•°å­—èµ„äº§ï¼Œè¿˜æ˜¯æ•°æ®é©±åŠ¨çš„äº¤äº’ã€‚æ¯ä¸€ä¸ªè¡Œä¸ºï¼Œéƒ½å­˜æœ‰å…¬å¼€çš„ä¸ç½‘ç»œäº¤äº’çš„è®°å½•ï¼Œå¹¶ä»¥æ­¤æ¥æ¶ˆé™¤äººä¸ºçš„çŸ›ç›¾ã€‚</li><li>è¿™æ˜¯ä¸€ç§å¯ä»¥æ ‡è®°ä¸åŒä¿¡æ¯çš„è§¦å‘è€…çš„æ–¹æ³•ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨æ²¡æœ‰ä¸­å¤®æƒå¨çš„æƒ…å†µä¸‹å¼ºåˆ¶æ‰§è¡Œã€‚</li><li>è¿™æ˜¯ä¸€ä¸ªä½¿å¾—ä¸ä¿¡ä»»åŒæ–¹æ ¹æ®å¯é¢„æµ‹çš„ã€ç¡®å®šæ€§çš„æ–¹å¼äº¤äº’çš„ç³»ç»Ÿã€‚</li></ol><h2 id="æ™ºèƒ½åˆçº¦"><a href="#æ™ºèƒ½åˆçº¦" class="headerlink" title="æ™ºèƒ½åˆçº¦"></a>æ™ºèƒ½åˆçº¦</h2><p>è‡ªåŠ¨åŒ–åœ°æ‰§è¡Œä¸€ç³»åˆ—åˆçº¦æ¡æ¬¾çš„äº¤æ˜“åè®®</p><p>æ™ºèƒ½åˆçº¦æ˜¯å­˜å‚¨åœ¨åŒºå—é“¾ä¸­çš„è„šæœ¬ï¼ˆè®¤è¯†ä¸Šå¯ä»¥ä¸å…³ç³»å‹æ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹ç±»ä¼¼ï¼‰ã€‚</p><p>ä»¥åŸºäºè´¦å·çš„æ¨¡å‹ä¸ºä¾‹å¯¹åˆçº¦æ‰§è¡Œè¿›è¡Œæè¿°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å‡è®¾å®šä¹‰ä¸€ä¸ªåˆçº¦ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªæ–¹æ³•</span><br><span class="line"></span><br><span class="line">(1) â€œå­˜å‚¨â€â€”â€”åˆçº¦çš„â€œå­˜æ¬¾â€åŠŸèƒ½å…è®¸ é˜²é£ï¼ˆé€šè¿‡é˜²é£çš„å¯†é’¥éªŒè¯ï¼‰å°†è‹¥å¹²å•ä½çš„Xå­˜å…¥åˆçº¦ä¸­ï¼›</span><br><span class="line">(2) â€œäº¤æ˜“â€â€”â€”â€œäº¤æ˜“â€åŠŸèƒ½å…è®¸ä»»ä½•äººå‘åˆçº¦å‘é€5å•ä½Yï¼Œå¹¶ä»åˆçº¦æŒæœ‰çš„Xä¸­è¿”å›1å•ä½ç»™äº¤æ˜“æ–¹ï¼›</span><br><span class="line">(3) â€œæ’¤é”€â€â€”â€”â€œæ’¤é”€â€åŠŸèƒ½å…è®¸ é˜²é£ å–å‡ºåˆçº¦ä¸­å­˜æœ‰çš„æ‰€æœ‰èµ„äº§ã€‚</span><br><span class="line"></span><br><span class="line">è¯·æ³¨æ„ï¼Œä¸Šè¿°â€œå­˜æ¬¾â€å’Œâ€œæ’¤é”€â€åŠŸèƒ½è¢«é™åˆ¶ä¸ºåªå…è®¸è¢« é˜²é£ï¼ˆå®é™…ä¸Šæ˜¯é˜²é£çš„ç§é’¥ï¼‰è°ƒç”¨ã€‚å½“ç„¶ï¼Œè¿™åªæœ‰ç”±äºä¸Šè¿°åˆçº¦ç”±é˜²é£åˆ¶å®šã€‚è‹¥äººä¸ºçš„åˆ¶å®šä¸€ä¸ªæ‰€æœ‰äººéƒ½èƒ½è°ƒç”¨ä»»ä½•åŠŸèƒ½çš„åˆçº¦ä¹Ÿæ˜¯å…è®¸çš„ï¼ˆè™½ç„¶è¿™åœ¨äº‹å®ä¸Šæ²¡æœ‰æ„ä¹‰ï¼‰ã€‚</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨åŸºäºè´¦æˆ·çš„æ¨¡å‹ä¸‹ï¼Œå¯ä»¥è®¤ä¸º æ‹¥æœ‰â€œå­˜å‚¨â€ã€â€œäº¤æ˜“â€ã€â€œæ’¤é”€â€æ–¹æ³•çš„åˆçº¦æŒæœ‰ä¸€ä¸ªå•ç‹¬çš„è´¦æˆ·ï¼ˆä¸ç”¨æˆ·æ‰€æŒæœ‰çš„è´¦æˆ·ç­‰ä»·ï¼‰ã€‚</p><p>åœ¨ä¸Šè¿°åˆçº¦ä¸‹ï¼Œè¿™ä¸ªè´¦æˆ·å°†å¯èƒ½æŒæœ‰ä¸€å®šæ•°é‡çš„èµ„äº§ã€‚é™¤äº†åªèƒ½æŒ‰ç…§é¢„å®šçš„åˆçº¦æ­¥éª¤å¯¹èµ„äº§è¿›è¡Œå¤„ç½®ä¹‹å¤–ï¼Œå…¶å®ƒä¸ç”¨æˆ·æŒæœ‰çš„è´¦æˆ·åˆ«æ— äºŒè‡´ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>ASM - ClassReader ä¸ Java ClassFile æ–‡ä»¶æ ¼å¼</title>
    <link href="http://utop.xin/2018-06-11-ASM-ClassReader/"/>
    <id>http://utop.xin/2018-06-11-ASM-ClassReader/</id>
    <published>2018-06-10T16:00:00.000Z</published>
    <updated>2018-06-12T03:40:49.188Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure><p>[TOC]</p><h2 id="Java-ClassFile-æ–‡ä»¶æ ¼å¼"><a href="#Java-ClassFile-æ–‡ä»¶æ ¼å¼" class="headerlink" title="Java ClassFile æ–‡ä»¶æ ¼å¼"></a>Java ClassFile æ–‡ä»¶æ ¼å¼</h2><p>è¯»äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´ï¼Œå‹‰å¼ºç®—æ˜¯æŠŠ ClassFile çš„æ–‡ä»¶æ ¼å¼ç»™ç®€å•çš„æ¢³ç†äº†ä¸ªè„‰ç»œã€‚<br><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html" title="Java Virtual Machine Specification" target="_blank" rel="noopener">The class File Format(Java SE 8)</a></p><blockquote><p>u1, u2, u4 åˆ†åˆ«è¡¨ç¤ºæ— ç¬¦å·çš„ä¸€å­—èŠ‚ã€äºŒå­—èŠ‚ã€å››å­—èŠ‚æ•°æ®(ä»¥å¤§ç«¯å­˜å‚¨)<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;                                   <span class="comment">// é­”æ•°(magic) å›ºå®šä¸º 0xCAFEBABE</span></span><br><span class="line">    u2             minor_version;                           <span class="comment">// æ¬¡ç‰ˆæœ¬å·</span></span><br><span class="line">    u2             major_version;                           <span class="comment">// ä¸»ç‰ˆæœ¬å·</span></span><br><span class="line">    u2             constant_pool_count;                     <span class="comment">// å¸¸é‡æ±  constant_pool çš„æ•°é‡ + 1, æœ€å¤§ä¸º (2&lt;&lt;16 - 1) = 65535</span></span><br><span class="line">    cp_info        constant_pool[constant_pool_count<span class="number">-1</span>];    <span class="comment">// å¸¸é‡æ±  å–å€¼ä¸‹æ ‡ä¸º [1, constant_pool_count)</span></span><br><span class="line">    u2             access_flags;                            <span class="comment">// å¯¹ç±» or æ¥å£çš„è®¿é—®æƒé™å’Œå±æ€§çš„æ ‡å¿—çš„æ©ç </span></span><br><span class="line">    u2             this_class;                              <span class="comment">// å€¼ä¸º constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(ä¸” constant_pool[this_class] çš„ç±»å‹ä¸º CONSTANT_Class_info)</span></span><br><span class="line">    u2             super_class;                             <span class="comment">// å€¼ä¸º 0 æˆ–è€… constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(åŒä¸Š), å¦‚æœæ˜¯ interface, åˆ™è¯¥å€¼ä¸€å®šä¸ºæœ‰æ•ˆä¸‹æ ‡</span></span><br><span class="line">    u2             interfaces_count;                        <span class="comment">// ç›´æ¥çˆ¶æ¥å£çš„æ•°é‡</span></span><br><span class="line">    u2             interfaces[interfaces_count];            <span class="comment">// å€¼å¿…é¡»æ˜¯ constant_pool çš„æœ‰æ•ˆä¸‹æ ‡, ä¸” interfaces[i](0â‰¤i&lt;interfaces_count), æŒ‡å‘çš„ç±»å‹ä¸º CONSTANT_Class_info)</span></span><br><span class="line">    u2             fields_count;                            <span class="comment">// å­—æ®µæ•°é‡, ç»Ÿè®¡æ‰€æœ‰å­—æ®µ, åŒ…æ‹¬ class variables(é™æ€å˜é‡) å’Œ instance variables(å®ä¾‹å˜é‡)</span></span><br><span class="line">    field_info     fields[fields_count];                    <span class="comment">// å­—æ®µçš„è¯¦ç»†å£°æ˜, ä¸åŒ…å«ç»§æ‰¿æ¥çš„å­—æ®µ</span></span><br><span class="line">    u2             methods_count;                           <span class="comment">// æ–¹æ³•æ•°é‡</span></span><br><span class="line">    method_info    methods[methods_count];                  <span class="comment">// æ–¹æ³•çš„è¯¦ç»†å£°æ˜, ä¸åŒ…æ‹¬ç»§æ‰¿æ¥çš„æ–¹æ³•</span></span><br><span class="line">    u2             attributes_count;                        <span class="comment">// å±æ€§æ•°é‡</span></span><br><span class="line">    attribute_info attributes[attributes_count];            <span class="comment">// å±æ€§çš„è¯¦ç»†å£°æ˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><p>é€šè¿‡ <code>javac Xxx.java</code> å‘½ä»¤å¾—åˆ°çš„ <code>Xxx.class</code> æ–‡ä»¶ä¸¥æ ¼æŒ‰ç…§å®šä¹‰çš„ ClassFile æ–‡ä»¶æ ¼å¼ä»¥8æ¯”ç‰¹çš„å­—èŠ‚ä¸ºå•ä½è¿›è¡Œå­˜å‚¨ã€‚</p><p><strong>ä¸‹é¢çš„ä¾‹å­éƒ½å°†é€šè¿‡ Trie.java (å®é™…ä»£ç è§æœ¬æ–‡æœ€å) ä»¥åŠå…¶ç»ç¼–è¯‘åçš„æ–‡ä»¶ Trie.class åšåŸºæœ¬çš„ä»‹ç»ã€‚</strong></p><h3 id="magic-minor-verion-amp-major-version"><a href="#magic-minor-verion-amp-major-version" class="headerlink" title="magic, minor_verion &amp; major_version"></a>magic, minor_verion &amp; major_version</h3><p>é€šè¿‡å‘½ä»¤ <code>xxd Trie.class</code> æŸ¥çœ‹ Trie.class çš„åå…­è¿›åˆ¶ç¼–ç ï¼Œå‰16å­—èŠ‚çš„å†…å®¹å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000: cafe babe 0000 0034 008f 0a00 2400 4b09  .......4....$.K.</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°å‰4å­—èŠ‚çš„å†…å®¹ <code>0xcafebabe</code>ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä½†æ˜¯ä½œä¸ºå…¶æ˜¯èƒ½å¦è¢«JVM(Java Virtual Machine, Javaè™šæ‹Ÿæœº)æ¥æ”¶çš„Classæ–‡ä»¶çš„ä¸€ä¸ªæ ¡éªŒã€‚</p><p>ç´§æ¥ç€çš„4ä¸ªå­—èŠ‚åŒ…æ‹¬<code>æ¬¡ç‰ˆæœ¬å·</code> å’Œ <code>ä¸»ç‰ˆæœ¬å·</code>ï¼Œæš‚æ—¶ä¸åšæ·±å…¥ã€‚</p><h3 id="å¸¸é‡æ± -constant-pool"><a href="#å¸¸é‡æ± -constant-pool" class="headerlink" title="å¸¸é‡æ±  constant_pool"></a>å¸¸é‡æ±  constant_pool</h3><p>ä»ç¬¬10ä¸ªå­—èŠ‚å¼€å§‹(ä»ç¬¬0å­—èŠ‚å¼€å§‹è®¡æ•°)ï¼Œè¿ç»­çš„ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºå¸¸é‡æ± ä¸­å„ç§ CONSTANT çš„æ€»ä¸ªæ•°+1 (constant_pool_count)ã€‚constant_pool_count åªæœ‰2å­—èŠ‚ä¹Ÿå°±æ„å‘³ç€: å¸¸é‡æ± çš„æœ€å¤§å¸¸é‡æ•°é‡ä¸º (2&lt;&lt;16 - 1) = 65535 (å½“ç„¶ï¼Œè²Œä¼¼åœ¨è¿™ä¸ªé‡çº§ä¸Šï¼Œä¹Ÿä»æ²¡è§è¿‡æœ‰è°èƒ½å¤Ÿç»´æŠ¤è¿™æ ·ä¸€ä¸ªå¤§JAVAç±»æ–‡ä»¶äº†)ã€‚</p><p>å¯ä»¥çœ‹åˆ° constant_pool_count çš„å†…å®¹ä¸º <code>0x008f = 143</code> ï¼Œå³å¯¹äºå¸¸é‡æ± çš„å£°æ˜å¯ä»¥è®¤ä¸ºæ˜¯ <code>cp_info constant_pool[142]</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u1 info[]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ JDK è‡ªå¸¦çš„ <code>javap</code> æ¥æŸ¥çœ‹ <code>Trie.class</code> æ–‡ä»¶(<code>javap -v Trie.class</code>)ï¼Œå¯ä»¥å¯¹ cp_info çš„æ ¼å¼æœ‰ä¸€ä¸ªç²—æµ…ä½†å½¢è±¡åŒ–çš„è®¤è¯†(ç»“æœè§<strong>é™„å½•2</strong>)<br>å…¶ä¸­ç¬¬ä¸€åˆ—çš„å†…å®¹ <code>#? = ?</code> <code>#?</code>è¡¨ç¤ºidï¼Œ<code>= ?</code>è¡¨ç¤ºä¸€ä¸ª cp_info çš„å®é™…ç±»å‹ï¼Œæœ‰ <code>cp_info.tag</code> æŒ‡å®šï¼Œå…·ä½“æ˜ å°„è¡¨ä¸º</p><table><thead><tr><th>Constant Type</th><th>Value</th></tr></thead><tbody><tr><td><code>CONSTANT_Class</code></td><td>7</td></tr><tr><td><code>CONSTANT_Fieldref</code></td><td>9</td></tr><tr><td><code>CONSTANT_Methodref</code></td><td>10</td></tr><tr><td><code>CONSTANT_InterfaceMethodref</code></td><td>11</td></tr><tr><td><code>CONSTANT_String</code></td><td>8</td></tr><tr><td><code>CONSTANT_Integer</code></td><td>3</td></tr><tr><td><code>CONSTANT_Float</code></td><td>4</td></tr><tr><td><code>CONSTANT_Long</code></td><td>5</td></tr><tr><td><code>CONSTANT_Double</code></td><td>6</td></tr><tr><td><code>CONSTANT_NameAndType</code></td><td>12</td></tr><tr><td><code>CONSTANT_Utf8</code></td><td>1</td></tr><tr><td><code>CONSTANT_MethodHandle</code></td><td>15</td></tr><tr><td><code>CONSTANT_MethodType</code></td><td>16</td></tr><tr><td><code>CONSTANT_InvokeDynamic</code></td><td>18</td></tr><tr><td><code>CONSTANT_Module</code></td><td>19</td></tr><tr><td><code>CONSTANT_Package</code></td><td>20</td></tr></tbody></table><p>åœ¨ Java ClassFile çš„æ ¼å¼å®šä¹‰ä¸­ï¼ŒåŒæ—¶å®šä¹‰äº†æ¯ç§ <code>CONSTANT</code> çš„é•¿åº¦ä¸æ ¼å¼ã€‚<br>ä¾‹å¦‚:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Class_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 name_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Fieldref_info &#123;</span><br><span class="line">     u1 tag;</span><br><span class="line">     u2 class_index;</span><br><span class="line">     u2 name_and_type_index;</span><br><span class="line">&#125;</span><br><span class="line">CONSTANT_Methodref_info &#123;</span><br><span class="line">  u1 tag;</span><br><span class="line">  u2 class_index;</span><br><span class="line">  u2 name_and_type_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´å¤šçš„ <code>CONSTANT_XXX</code> çš„æ ¼å¼å®šä¹‰è§ <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4" target="_blank" rel="noopener">ClassFile CONSTANT_XXX ç»“æ„</a></p><p>ç®€å•è§£æä¸€ä¸‹ cp_info<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html" title="Java Virtual Machine Specification" target="_blank" rel="noopener">1</a>ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000000: cafe babe 0000 0034 008f 0a00 2400 4b09  .......4....$.K.</span><br><span class="line"></span><br><span class="line">#1 = Methodref          #36.#75       // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br></pre></td></tr></table></figure></p><p><code>cp_info[1].tag = 0x0a = 10</code>ï¼Œå³ cp_info<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html" title="Java Virtual Machine Specification" target="_blank" rel="noopener">1</a> çš„ç±»å‹ä¸º Methodref ã€‚<br>ä¹‹åå°±ç›´æ¥å¥—ç”¨ <code>CONSTANT_Methodref_info</code> çš„æ•°æ®ç»“æ„å®šä¹‰çš„æ ¼å¼<br><code>cp_info[1].class_index = 0x0024 = 36</code>ï¼Œå³ cp_info<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html" title="Java Virtual Machine Specification" target="_blank" rel="noopener">1</a>.class_index è¡¨ç¤ºçš„ç±»åæŒ‡å‘å¸¸é‡æ± ç¬¬ 36 ä¸ªå…ƒç´ è¡¨ç¤ºçš„ç±»<br><code>cp_info[1].name_and_type_index = 0x004b = 75</code>ã€‚è¡¨ç¤ºæŒ‡å‘çš„æ˜¯å¸¸é‡æ± ç¬¬ 75 ä¸ªå…ƒç´ è¡¨ç¤ºçš„ NameAndType ç»“æ„</p><p>å¯¹äºè¿™éƒ¨åˆ†å†…å®¹çš„ç†è§£ï¼Œå¦‚æœè§‰å¾—æœ‰èƒ½å¤Ÿé˜…è¯»è‹±æ–‡æ–‡æ¡£ï¼Œå¯ä»¥å‚è€ƒ <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html" title="Java Virtual Machine Specification" target="_blank" rel="noopener">The JavaÂ® Virtual Machine Specification Chap 4.</a><br>å¦åˆ™ï¼Œå¯ä»¥é€‰æ‹© <a href="http://icyfenix.iteye.com/blog/1256329" title="Javaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava SE 7 ä¸­æ–‡ç‰ˆï¼‰" target="_blank" rel="noopener">Java è™šæ‹Ÿæœºè§„èŒƒ(Java SE 7 ç‰ˆ) ç¬¬å››ç« </a><br>å¹¶å°è¯•æ ¹æ®ç»ç¼–è¯‘å.classæ–‡ä»¶çš„äºŒè¿›åˆ¶ç è¿›è¡Œäººå·¥è§£æï¼Œä»¥åŠ æ·±å¯¹æ­¤çš„ç†è§£ã€‚</p><h3 id="moreâ€¦"><a href="#moreâ€¦" class="headerlink" title="moreâ€¦"></a>moreâ€¦</h3><p>æ›´å¤šå†…å®¹äºæ­¤åŸºæœ¬ç±»ä¼¼ï¼Œå‡å±äºå·²ç»è¢«ä¸¥æ ¼é¢„å®šä¹‰çš„è§„èŒƒåŒ–æ ¼å¼ï¼Œå¯¹æ­¤è¿›è¡Œè§£æå³å¯å¾—åˆ°ç›¸åº”çš„å†…å®¹ã€‚</p><h2 id="ASM-æ¦‚è§ˆ"><a href="#ASM-æ¦‚è§ˆ" class="headerlink" title="ASM æ¦‚è§ˆ"></a>ASM æ¦‚è§ˆ</h2><h3 id="åŒ…ç»“æ„"><a href="#åŒ…ç»“æ„" class="headerlink" title="åŒ…ç»“æ„"></a>åŒ…ç»“æ„</h3><p>asm, asm-analysis, asm-commons, asm-tree, asm-util, asm-xml æ¨¡å—åŸºäº Maven çš„ç»„ç»‡å½¢å¼ï¼Œå¹¶åŒ…å«æœ‰å•å…ƒæµ‹è¯•çš„å†…å®¹ã€‚</p><p>asm-test å®ç°äº†å¯¹ä¸Šè¿°æ¨¡å—çš„å•å…ƒæµ‹è¯•çš„æ•´åˆã€‚</p><p>benchmarks å®šä¹‰äº†ä¸€äº›åŸºæœ¬çš„ JMH åŸºå‡†æµ‹è¯•æ¥è¡¡é‡ASMçš„è¡¨ç°</p><p>gradle åŒ…å«äº†ä¸€äº› Gradle åŒ…è£…å™¨ï¼Œæ¥è¾…åŠ© Linux or Windows è„šæœ¬çš„è°ƒç”¨è¯·æ±‚</p><p>tools åŒ…å«ä¸¤ä¸ª Gradle é¡¹ç›®æ¥å¸®åŠ© ASM ç”Ÿæˆ Artifacts ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1frywra01upj308g0akmxr.jpg" alt="ASM Structure"></p><h3 id="ä»£ç ç»„ç»‡å½¢å¼"><a href="#ä»£ç ç»„ç»‡å½¢å¼" class="headerlink" title="ä»£ç ç»„ç»‡å½¢å¼"></a>ä»£ç ç»„ç»‡å½¢å¼</h3><p><img src="http://asm.ow2.io/asm-package-dependencies.svg" alt="Code Organization"></p><ul><li>org.objectweb.asm ä½œä¸ºæ ¸å¿ƒåŒ…ï¼Œå®šä¹‰äº† ASM è®¿é—®è€… API ä»¥åŠä¸¤ä¸ªæ ¸å¿ƒç±» ClassReader &amp; ClassWriter æ¥è¯»å†™ç¼–è¯‘åçš„ Java ç±»ã€‚è¯¥åŒ…ä¸ä¾èµ–äºå…¶ä»–åŒ…ï¼Œä¸”å¯å•ç‹¬ä½¿ç”¨</li><li>org.objectweb.asm.signature æä¾›äº†è¯»å†™æ³›å‹ç­¾åçš„ API</li><li>org.objectweb.asm.tree æä¾›äº†ç±» DOM API ä¸ç±» SAX APIã€‚</li><li>org.objectweb.asm.tree.analysis åŸºäº .tree æä¾›äº†é™æ€å­—èŠ‚ç åˆ†ææ¡†æ¶</li><li>org.objectweb.asm.commons æä¾›äº†ä¸€äº›åŸºäº core å’Œ tree åŒ…çš„ç±»é€‚é…å™¨ã€‚</li><li>org.objectweb.asm.util æä¾›äº†ä¸€äº›ç”¨äº DEBUG çš„è®¿é—®è€…ç±»ä¸é€‚é…å™¨ç±»</li><li>org.objectweb.asm.xml ç›®å‰å·²ç»è¢« @Deprecated ã€‚æä¾›äº†ç±»æ–‡ä»¶ä¸ XML äº’ç›¸è½¬æ¢çš„èƒ½åŠ›</li></ul><p>ç»¼ä¸Šï¼Œasm æ ¸å¿ƒåŒ…æ˜¯æœ€ä¸ºå¤æ‚çš„ä¸€ä¸ªæ¨¡å—ï¼Œè€Œå…¶å®ƒè¯¸å¦‚ tree, util, xml ç­‰éƒ½åªæ˜¯æä¾›äº†å°† JAVA ç±»ä»ä¸€ç§é«˜çº§è¡¨ç¤ºå½¢æ€è½¬æ¢ä¸ºå¦ä¸€ç§çš„èƒ½åŠ›ã€‚signature ä¹Ÿç›¸å½“ç®€å•ï¼Œæä¾›äº†è§£æå’Œæ‰“å°ç®€å•è¯­æ³•çš„èƒ½åŠ›ã€‚</p><h3 id="ä¸»è¦æ•°æ®ç»“æ„"><a href="#ä¸»è¦æ•°æ®ç»“æ„" class="headerlink" title="ä¸»è¦æ•°æ®ç»“æ„"></a>ä¸»è¦æ•°æ®ç»“æ„</h3><p>æ ¸å¿ƒåŒ…ç”± 28 ä¸ªç±»(æ¥å£) ç»„æˆã€‚å¦‚æœä¸è€ƒè™‘ Opcodes æ¥å£, 5 ä¸ªæŠ½è±¡è®¿é—®è€…ç±»(AnnotationVistitor, ClassVisitor, FieldVisitor, MethodVisitor and ModuleVisitor), 6 ä¸ªå·¥å…·ç±»(ConstantDynamic, Contants, Handle, Type, TypePath and TypeReference), å‰©ä¸‹ 16 ä¸ªç±»çš„ç”±ä¸‹å›¾æä¾›ä¸€ä¸ªç²—ç•¥çš„å±•ç¤ºã€‚</p><p><img src="http://asm.ow2.io/asm-package-overview.svg" alt=""></p><p>ç¼–è¯‘ç±»åˆ°è®¿é—®äº‹ä»¶çš„è½¬æ¢åªç”±ä¸€ä¸ªç±» ClassReader ä»¥åŠè¾…åŠ©ç±» Context å®Œæˆã€‚å…¶é€†è¿‡ç¨‹ç”±ä»¥ ClassWriter ä¸ºæ ¸å¿ƒçš„å…¶å®ƒ 14 ä¸ªç±»å®Œæˆã€‚</p><h3 id="ClassReader"><a href="#ClassReader" class="headerlink" title="ClassReader"></a>ClassReader</h3><p>ClassReader ä½œä¸º ASM æ ¸å¿ƒåŒ…è§£æç°æœ‰ .class çš„å”¯ä¸€å·¥å…·ï¼Œç»„ç»‡å½¢å¼ç›¸å½“ç®€å•ã€‚</p><ul><li>åœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆå¯¹å¸¸é‡æ± å’Œå¼•å¯¼æ–¹æ³•çš„è§£æ<ul><li>å­˜å‚¨æ¯ä¸ªå¸¸é‡æ± é¡¹ç›®çš„èµ·å§‹åç§»é‡ cpInfoOffsets</li><li>å­˜å‚¨æ¯ä¸ªå¼•å¯¼æ–¹æ³•çš„èµ·å§‹åç§»é‡ bootstrapMethodOffsets</li><li>å­˜å‚¨æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡çš„å¤§å° maxStringLength</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">ClassReader(<span class="keyword">final</span> <span class="keyword">byte</span>[] classFileBuffer, <span class="keyword">final</span> <span class="keyword">int</span> classFileOffset, <span class="keyword">final</span> <span class="keyword">boolean</span> checkClassVersion) &#123;</span><br><span class="line">  <span class="keyword">this</span>.b = classFileBuffer;   <span class="comment">// .class æ–‡ä»¶ç¼“å­˜</span></span><br><span class="line">  <span class="comment">// æ£€æŸ¥ä¸»ç‰ˆæœ¬å·, ç¬¬6,7ä¸ªå­—èŠ‚(ä»0å­—èŠ‚å¼€å§‹è®¡æ•°)</span></span><br><span class="line">  <span class="keyword">if</span> (checkClassVersion &amp;&amp; readShort(classFileOffset + <span class="number">6</span>) &gt; Opcodes.V11) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">        <span class="string">"Unsupported class file major version "</span> + readShort(classFileOffset + <span class="number">6</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ›å»ºå¸¸é‡æ± æ•°ç»„ï¼Œå¸¸é‡æ± é•¿åº¦çš„å®šä¹‰ constant_pool_count åœ¨ç¬¬8,9å­—èŠ‚</span></span><br><span class="line">  <span class="keyword">int</span> constantPoolCount = readUnsignedShort(classFileOffset + <span class="number">8</span>);     <span class="comment">// è¯»å–æ— ç¬¦å·short, å³è¯»å–è¿ç»­ä¸¤å­—èŠ‚ä½œä¸ºä¸€ä¸ªshortå€¼</span></span><br><span class="line">  cpInfoOffsets = <span class="keyword">new</span> <span class="keyword">int</span>[constantPoolCount];                         <span class="comment">// æ¯ä¸ªå¸¸é‡çš„åç§»ä½ç½®</span></span><br><span class="line">  cpInfoValues = <span class="keyword">new</span> Object[constantPoolCount];                       <span class="comment">// æ¯ä¸ªå¸¸é‡çš„å®ä¾‹å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">int</span> currentCpInfoIndex = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> currentCpInfoOffset = classFileOffset + <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">int</span> currentMaxStringLength = <span class="number">0</span>;                                     <span class="comment">// æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡</span></span><br><span class="line">  <span class="keyword">while</span> (currentCpInfoIndex &lt; constantPoolCount) &#123;</span><br><span class="line">    cpInfoOffsets[currentCpInfoIndex++] = currentCpInfoOffset + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> cpInfoSize;</span><br><span class="line">    <span class="keyword">switch</span> (classFileBuffer[currentCpInfoOffset]) &#123;</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_FIELDREF_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_METHODREF_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_INTERFACE_METHODREF_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_INTEGER_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_FLOAT_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_NAME_AND_TYPE_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_INVOKE_DYNAMIC_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_DYNAMIC_TAG:</span><br><span class="line">        cpInfoSize = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_LONG_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_DOUBLE_TAG:</span><br><span class="line">        cpInfoSize = <span class="number">9</span>;</span><br><span class="line">        currentCpInfoIndex++;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_UTF8_TAG:</span><br><span class="line">        cpInfoSize = <span class="number">3</span> + readUnsignedShort(currentCpInfoOffset + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (cpInfoSize &gt; currentMaxStringLength) &#123;</span><br><span class="line">          <span class="comment">// The size in bytes of this CONSTANT_Utf8 structure provides a conservative estimate</span></span><br><span class="line">          <span class="comment">// of the length in characters of the corresponding string, and is much cheaper to</span></span><br><span class="line">          <span class="comment">// compute than this exact length.</span></span><br><span class="line">          currentMaxStringLength = cpInfoSize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_METHOD_HANDLE_TAG:</span><br><span class="line">        cpInfoSize = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_CLASS_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_STRING_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_METHOD_TYPE_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_PACKAGE_TAG:</span><br><span class="line">      <span class="keyword">case</span> Symbol.CONSTANT_MODULE_TAG:</span><br><span class="line">        cpInfoSize = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    &#125;</span><br><span class="line">    currentCpInfoOffset += cpInfoSize;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.maxStringLength = currentMaxStringLength;</span><br><span class="line">  <span class="comment">// The Classfile's access_flags field is just after the last constant pool entry.</span></span><br><span class="line">  <span class="keyword">this</span>.header = currentCpInfoOffset;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å– BootstrapMethods å±æ€§(å¦‚æœå­˜åœ¨)</span></span><br><span class="line">  <span class="keyword">int</span> currentAttributeOffset = getFirstAttributeOffset();</span><br><span class="line">  <span class="keyword">int</span>[] currentBootstrapMethodOffsets = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = readUnsignedShort(currentAttributeOffset - <span class="number">2</span>); i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">    <span class="comment">// è¯»å–æ¯ä¸ª attribute_info çš„å±æ€§åå’Œå±æ€§é•¿åº¦</span></span><br><span class="line">    String attributeName = readUTF8(currentAttributeOffset, <span class="keyword">new</span> <span class="keyword">char</span>[maxStringLength]);</span><br><span class="line">    <span class="keyword">int</span> attributeLength = readInt(currentAttributeOffset + <span class="number">2</span>);</span><br><span class="line">    currentAttributeOffset += <span class="number">6</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å±æ€§åä¸º BootstrapMethods ï¼Œåˆ™è¿›å…¥å¤„ç†é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (Constants.BOOTSTRAP_METHODS.equals(attributeName)) &#123;</span><br><span class="line">      <span class="comment">// Read the num_bootstrap_methods field and create an array of this size.</span></span><br><span class="line">      currentBootstrapMethodOffsets = <span class="keyword">new</span> <span class="keyword">int</span>[readUnsignedShort(currentAttributeOffset)];</span><br><span class="line">      <span class="comment">// Compute and store the offset of each 'bootstrap_methods' array field entry.</span></span><br><span class="line">      <span class="keyword">int</span> currentBootstrapMethodOffset = currentAttributeOffset + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; currentBootstrapMethodOffsets.length; ++j) &#123;</span><br><span class="line">        currentBootstrapMethodOffsets[j] = currentBootstrapMethodOffset;</span><br><span class="line">        <span class="comment">// Skip the bootstrap_method_ref and num_bootstrap_arguments fields (2 bytes each),</span></span><br><span class="line">        <span class="comment">// as well as the bootstrap_arguments array field (of size num_bootstrap_arguments * 2).</span></span><br><span class="line">        currentBootstrapMethodOffset +=</span><br><span class="line">            <span class="number">4</span> + readUnsignedShort(currentBootstrapMethodOffset + <span class="number">2</span>) * <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    currentAttributeOffset += attributeLength;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.bootstrapMethodOffsets = currentBootstrapMethodOffsets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒClassReader å·²ç»è§£æäº†åŒ…æ‹¬ magic, minor version, major version, constant pool ã€‚<br>ä½†æ˜¯ï¼Œè¯¸å¦‚ field_info, method_info, attribute_info ç­‰ä»ç„¶æ²¡æœ‰å¾—åˆ°å¤„ç†ã€‚</p><p>è¿™éƒ¨åˆ†çš„å†…å®¹åœ¨ accept(â€¦) å’Œ readXXX(â€¦) ä¸­å°†å¾—åˆ°è§£æã€‚</p><p>ä¸»è¦æµç¨‹ç±»ä¼¼:</p><ol><li>è¯»å–å½“å‰å†…å®¹çš„åç§»é‡(ç›¸è¾ƒäºæ•´ä¸ª byte[])</li><li>è§£æå½“å‰çš„å†…å®¹</li><li>è°ƒç”¨ visitXXX æ–¹æ³•</li><li>åœ¨ visitXXX æ–¹æ³•ä¸­è¿›è¡Œç›¸å…³çš„å¤„ç†</li><li>visitEnd</li></ol><h2 id="é™„å½•1-Trie-java"><a href="#é™„å½•1-Trie-java" class="headerlink" title="é™„å½•1 Trie.java"></a>é™„å½•1 Trie.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.fangfeng.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/5/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Trie</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_ITEM = <span class="number">700000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> AVG_LENGTH = <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_NODE = MAX_ITEM * AVG_LENGTH;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> CHAR_NUM = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[][] nxt = <span class="keyword">new</span> <span class="keyword">int</span>[MAX_NODE][CHAR_NUM];</span><br><span class="line">    <span class="keyword">boolean</span>[] flag = <span class="keyword">new</span> <span class="keyword">boolean</span>[MAX_NODE];</span><br><span class="line">    <span class="keyword">int</span> trieIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">long</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> tmpIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (;number != <span class="number">0</span>;number /= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nxt[tmpIndex][(<span class="keyword">int</span>) (number % <span class="number">10</span>)] == <span class="number">0</span>) &#123;</span><br><span class="line">                nxt[tmpIndex][(<span class="keyword">int</span>) (number % <span class="number">10</span>)] = ++trieIndex;</span><br><span class="line">            &#125;</span><br><span class="line">            tmpIndex = nxt[tmpIndex][(<span class="keyword">int</span>) (number % <span class="number">10</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">        flag[tmpIndex] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">query</span><span class="params">(<span class="keyword">long</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> tmpIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (;number != <span class="number">0</span>;number /= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nxt[tmpIndex][(<span class="keyword">int</span>) (number % <span class="number">10</span>)] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            tmpIndex = nxt[tmpIndex][(<span class="keyword">int</span>) (number % <span class="number">10</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flag[tmpIndex];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> <span class="keyword">throws</span> FileNotFoundException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        String ruleFilePath = args[<span class="number">0</span>];</span><br><span class="line">        String sendFilePath = args[<span class="number">1</span>];</span><br><span class="line">        String outFilePath = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        BufferedReader ruleReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(ruleFilePath)));</span><br><span class="line">        BufferedReader sendReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(sendFilePath)));</span><br><span class="line"></span><br><span class="line">        BufferedWriter outWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(outFilePath)));</span><br><span class="line"></span><br><span class="line">        Trie trie = <span class="keyword">new</span> Trie();</span><br><span class="line">        String mobile;</span><br><span class="line">        <span class="keyword">while</span>((mobile = ruleReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            trie.insert(Long.parseLong(mobile));</span><br><span class="line">        &#125;</span><br><span class="line">        ruleReader.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((mobile = sendReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(trie.query(Long.parseLong(mobile)) == <span class="keyword">false</span>) &#123;</span><br><span class="line">                outWriter.write(mobile);</span><br><span class="line">                outWriter.newLine();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sendReader.close();</span><br><span class="line"></span><br><span class="line">        outWriter.flush();</span><br><span class="line">        outWriter.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(String.format(<span class="string">"exec success! used %d ms"</span>, end - start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é™„å½•2-Constant-pool"><a href="#é™„å½•2-Constant-pool" class="headerlink" title="é™„å½•2 Constant pool"></a>é™„å½•2 Constant pool</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">    #1 = Methodref          #36.#75       // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">    #2 = Fieldref           #23.#76       // me/fangfeng/filter/Trie.MAX_NODE:I</span><br><span class="line">    #3 = Fieldref           #23.#77       // me/fangfeng/filter/Trie.CHAR_NUM:I</span><br><span class="line">    #4 = Class              #49           // &quot;[[I&quot;</span><br><span class="line">    #5 = Fieldref           #23.#78       // me/fangfeng/filter/Trie.nxt:[[I</span><br><span class="line">    #6 = Fieldref           #23.#79       // me/fangfeng/filter/Trie.flag:[Z</span><br><span class="line">    #7 = Fieldref           #23.#80       // me/fangfeng/filter/Trie.trieIndex:I</span><br><span class="line">    #8 = Long               10l</span><br><span class="line">   #10 = Methodref          #81.#82       // java/lang/System.currentTimeMillis:()J</span><br><span class="line">   #11 = Class              #83           // java/io/BufferedReader</span><br><span class="line">   #12 = Class              #84           // java/io/InputStreamReader</span><br><span class="line">   #13 = Class              #85           // java/io/FileInputStream</span><br><span class="line">   #14 = Methodref          #13.#86       // java/io/FileInputStream.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span><br><span class="line">   #15 = Methodref          #12.#87       // java/io/InputStreamReader.&quot;&lt;init&gt;&quot;:(Ljava/io/InputStream;)V</span><br><span class="line">   #16 = Methodref          #11.#88       // java/io/BufferedReader.&quot;&lt;init&gt;&quot;:(Ljava/io/Reader;)V</span><br><span class="line">   #17 = Class              #89           // java/io/BufferedWriter</span><br><span class="line">   #18 = Class              #90           // java/io/OutputStreamWriter</span><br><span class="line">   #19 = Class              #91           // java/io/FileOutputStream</span><br><span class="line">   #20 = Methodref          #19.#86       // java/io/FileOutputStream.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span><br><span class="line">   #21 = Methodref          #18.#92       // java/io/OutputStreamWriter.&quot;&lt;init&gt;&quot;:(Ljava/io/OutputStream;)V</span><br><span class="line">   #22 = Methodref          #17.#93       // java/io/BufferedWriter.&quot;&lt;init&gt;&quot;:(Ljava/io/Writer;)V</span><br><span class="line">   #23 = Class              #94           // me/fangfeng/filter/Trie</span><br><span class="line">   #24 = Methodref          #23.#75       // me/fangfeng/filter/Trie.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #25 = Methodref          #11.#95       // java/io/BufferedReader.readLine:()Ljava/lang/String;</span><br><span class="line">   #26 = Methodref          #96.#97       // java/lang/Long.parseLong:(Ljava/lang/String;)J</span><br><span class="line">   #27 = Methodref          #23.#98       // me/fangfeng/filter/Trie.insert:(J)V</span><br><span class="line">   #28 = Methodref          #11.#99       // java/io/BufferedReader.close:()V</span><br><span class="line">   #29 = Methodref          #23.#100      // me/fangfeng/filter/Trie.query:(J)Z</span><br><span class="line">   #30 = Methodref          #17.#101      // java/io/BufferedWriter.write:(Ljava/lang/String;)V</span><br><span class="line">   #31 = Methodref          #17.#102      // java/io/BufferedWriter.newLine:()V</span><br><span class="line">   #32 = Methodref          #17.#103      // java/io/BufferedWriter.flush:()V</span><br><span class="line">   #33 = Methodref          #17.#99       // java/io/BufferedWriter.close:()V</span><br><span class="line">   #34 = Fieldref           #81.#104      // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #35 = String             #105          // exec success! used %d ms</span><br><span class="line">   #36 = Class              #106          // java/lang/Object</span><br><span class="line">   #37 = Methodref          #96.#107      // java/lang/Long.valueOf:(J)Ljava/lang/Long;</span><br><span class="line">   #38 = Methodref          #108.#109     // java/lang/String.format:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">   #39 = Methodref          #110.#111     // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">   #40 = Integer            700000</span><br><span class="line">   #41 = Fieldref           #23.#112      // me/fangfeng/filter/Trie.MAX_ITEM:I</span><br><span class="line">   #42 = Fieldref           #23.#113      // me/fangfeng/filter/Trie.AVG_LENGTH:I</span><br><span class="line">   #43 = Utf8               MAX_ITEM</span><br><span class="line">   #44 = Utf8               I</span><br><span class="line">   #45 = Utf8               AVG_LENGTH</span><br><span class="line">   #46 = Utf8               MAX_NODE</span><br><span class="line">   #47 = Utf8               CHAR_NUM</span><br><span class="line">   #48 = Utf8               nxt</span><br><span class="line">   #49 = Utf8               [[I</span><br><span class="line">   #50 = Utf8               flag</span><br><span class="line">   #51 = Utf8               [Z</span><br><span class="line">   #52 = Utf8               trieIndex</span><br><span class="line">   #53 = Utf8               &lt;init&gt;</span><br><span class="line">   #54 = Utf8               ()V</span><br><span class="line">   #55 = Utf8               Code</span><br><span class="line">   #56 = Utf8               LineNumberTable</span><br><span class="line">   #57 = Utf8               insert</span><br><span class="line">   #58 = Utf8               (J)V</span><br><span class="line">   #59 = Utf8               StackMapTable</span><br><span class="line">   #60 = Utf8               query</span><br><span class="line">   #61 = Utf8               (J)Z</span><br><span class="line">   #62 = Utf8               main</span><br><span class="line">   #63 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">   #64 = Class              #114          // &quot;[Ljava/lang/String;&quot;</span><br><span class="line">   #65 = Class              #115          // java/lang/String</span><br><span class="line">   #66 = Class              #83           // java/io/BufferedReader</span><br><span class="line">   #67 = Class              #89           // java/io/BufferedWriter</span><br><span class="line">   #68 = Class              #94           // me/fangfeng/filter/Trie</span><br><span class="line">   #69 = Utf8               Exceptions</span><br><span class="line">   #70 = Class              #116          // java/io/FileNotFoundException</span><br><span class="line">   #71 = Class              #117          // java/io/IOException</span><br><span class="line">   #72 = Utf8               &lt;clinit&gt;</span><br><span class="line">   #73 = Utf8               SourceFile</span><br><span class="line">   #74 = Utf8               Trie.java</span><br><span class="line">   #75 = NameAndType        #53:#54       // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #76 = NameAndType        #46:#44       // MAX_NODE:I</span><br><span class="line">   #77 = NameAndType        #47:#44       // CHAR_NUM:I</span><br><span class="line">   #78 = NameAndType        #48:#49       // nxt:[[I</span><br><span class="line">   #79 = NameAndType        #50:#51       // flag:[Z</span><br><span class="line">   #80 = NameAndType        #52:#44       // trieIndex:I</span><br><span class="line">   #81 = Class              #118          // java/lang/System</span><br><span class="line">   #82 = NameAndType        #119:#120     // currentTimeMillis:()J</span><br><span class="line">   #83 = Utf8               java/io/BufferedReader</span><br><span class="line">   #84 = Utf8               java/io/InputStreamReader</span><br><span class="line">   #85 = Utf8               java/io/FileInputStream</span><br><span class="line">   #86 = NameAndType        #53:#121      // &quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span><br><span class="line">   #87 = NameAndType        #53:#122      // &quot;&lt;init&gt;&quot;:(Ljava/io/InputStream;)V</span><br><span class="line">   #88 = NameAndType        #53:#123      // &quot;&lt;init&gt;&quot;:(Ljava/io/Reader;)V</span><br><span class="line">   #89 = Utf8               java/io/BufferedWriter</span><br><span class="line">   #90 = Utf8               java/io/OutputStreamWriter</span><br><span class="line">   #91 = Utf8               java/io/FileOutputStream</span><br><span class="line">   #92 = NameAndType        #53:#124      // &quot;&lt;init&gt;&quot;:(Ljava/io/OutputStream;)V</span><br><span class="line">   #93 = NameAndType        #53:#125      // &quot;&lt;init&gt;&quot;:(Ljava/io/Writer;)V</span><br><span class="line">   #94 = Utf8               me/fangfeng/filter/Trie</span><br><span class="line">   #95 = NameAndType        #126:#127     // readLine:()Ljava/lang/String;</span><br><span class="line">   #96 = Class              #128          // java/lang/Long</span><br><span class="line">   #97 = NameAndType        #129:#130     // parseLong:(Ljava/lang/String;)J</span><br><span class="line">   #98 = NameAndType        #57:#58       // insert:(J)V</span><br><span class="line">   #99 = NameAndType        #131:#54      // close:()V</span><br><span class="line">  #100 = NameAndType        #60:#61       // query:(J)Z</span><br><span class="line">  #101 = NameAndType        #132:#121     // write:(Ljava/lang/String;)V</span><br><span class="line">  #102 = NameAndType        #133:#54      // newLine:()V</span><br><span class="line">  #103 = NameAndType        #134:#54      // flush:()V</span><br><span class="line">  #104 = NameAndType        #135:#136     // out:Ljava/io/PrintStream;</span><br><span class="line">  #105 = Utf8               exec success! used %d ms</span><br><span class="line">  #106 = Utf8               java/lang/Object</span><br><span class="line">  #107 = NameAndType        #137:#138     // valueOf:(J)Ljava/lang/Long;</span><br><span class="line">  #108 = Class              #115          // java/lang/String</span><br><span class="line">  #109 = NameAndType        #139:#140     // format:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">  #110 = Class              #141          // java/io/PrintStream</span><br><span class="line">  #111 = NameAndType        #142:#121     // println:(Ljava/lang/String;)V</span><br><span class="line">  #112 = NameAndType        #43:#44       // MAX_ITEM:I</span><br><span class="line">  #113 = NameAndType        #45:#44       // AVG_LENGTH:I</span><br><span class="line">  #114 = Utf8               [Ljava/lang/String;</span><br><span class="line">  #115 = Utf8               java/lang/String</span><br><span class="line">  #116 = Utf8               java/io/FileNotFoundException</span><br><span class="line">  #117 = Utf8               java/io/IOException</span><br><span class="line">  #118 = Utf8               java/lang/System</span><br><span class="line">  #119 = Utf8               currentTimeMillis</span><br><span class="line">  #120 = Utf8               ()J</span><br><span class="line">  #121 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">  #122 = Utf8               (Ljava/io/InputStream;)V</span><br><span class="line">  #123 = Utf8               (Ljava/io/Reader;)V</span><br><span class="line">  #124 = Utf8               (Ljava/io/OutputStream;)V</span><br><span class="line">  #125 = Utf8               (Ljava/io/Writer;)V</span><br><span class="line">  #126 = Utf8               readLine</span><br><span class="line">  #127 = Utf8               ()Ljava/lang/String;</span><br><span class="line">  #128 = Utf8               java/lang/Long</span><br><span class="line">  #129 = Utf8               parseLong</span><br><span class="line">  #130 = Utf8               (Ljava/lang/String;)J</span><br><span class="line">  #131 = Utf8               close</span><br><span class="line">  #132 = Utf8               write</span><br><span class="line">  #133 = Utf8               newLine</span><br><span class="line">  #134 = Utf8               flush</span><br><span class="line">  #135 = Utf8               out</span><br><span class="line">  #136 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #137 = Utf8               valueOf</span><br><span class="line">  #138 = Utf8               (J)Ljava/lang/Long;</span><br><span class="line">  #139 = Utf8               format</span><br><span class="line">  #140 = Utf8               (Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">  #141 = Utf8               java/io/PrintStream</span><br><span class="line">  #142 = Utf8               println</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
  </entry>
  
</feed>
