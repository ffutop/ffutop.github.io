<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Utop&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://DorMOUSE-None.github.io/"/>
  <updated>2019-02-27T00:55:38.875Z</updated>
  <id>https://DorMOUSE-None.github.io/</id>
  
  <author>
    <name>Utop</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€Javaã€‘API å‚æ•°è¯¯å®šä¹‰çš„åæœ</title>
    <link href="https://DorMOUSE-None.github.io/2019-02-27-Java-Fatal-API/"/>
    <id>https://DorMOUSE-None.github.io/2019-02-27-Java-Fatal-API/</id>
    <published>2019-02-26T16:00:00.000Z</published>
    <updated>2019-02-27T00:55:38.875Z</updated>
    
    <content type="html"><![CDATA[<p>å·¥ç¨‹é¡¹ç›®ä¸­ï¼Œå®šä¹‰ API æ€»æ˜¯ä¸€ä¸ªæ…ä¹‹åˆæ…çš„æ“ä½œã€‚ä¸èƒ½å°‘ï¼Œä¸æ»¡è¶³è°ƒç”¨æ–¹çš„éœ€æ±‚å°±æƒ¨äº†ï¼›ä¹Ÿä¸èƒ½å¤šï¼Œä¸ç„¶å°±ä¹±å¥—äº†ï¼Œè‡ªå·±ç»´æŠ¤å›°éš¾ï¼Œè°ƒç”¨æ–¹ä¹Ÿå¼€å§‹äº†è‡ªæˆ‘å‘æŒ¥ã€‚è™½ç„¶è¶³å¤Ÿæ…é‡ï¼Œä½†ç»å¤§å¤šæ•°éƒ½é€ƒä¸è¿‡æœ€ç»ˆä¸å¾—ä¸â€œæ”¹â€ API çš„æƒ…å†µã€‚ä»Šå¤©è¦è®¨è®ºçš„æ˜¯åœ¨åŒä¸€ä¸ªç±»å†…åŒæ–¹æ³•åä¸åŒå‚æ•°ï¼ˆå…¥å‚/å‡ºå‚ï¼‰çš„æƒ…å†µã€‚</p><p>æƒ³è¦åšåˆ°åŒæ–¹æ³•åä¸åŒå…¥å‚ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯â€œé‡è½½ï¼ˆOverloadï¼‰â€ï¼Œæ—¥å¸¸éƒ½åœ¨ä½¿ç”¨ã€‚ä¸å†èµ˜è¿°ï¼</p><p>æƒ³è¦åšåˆ°åŒæ–¹æ³•åä¸åŒå‡ºå‚ï¼Œç­”æ¡ˆå°±ä¸å†é‚£ä¹ˆè‚¯å®šäº†ã€‚å½“ç„¶ï¼Œå¦‚æœé—®æŠŠ<code>void add(int)</code> API æ”¹å†™æˆ <code>int add(int)</code>ï¼Œå¯èƒ½å¾—åˆ°çš„å¤§å¤šæ•°å›ç­”éƒ½æ˜¯å¯ä»¥ã€‚</p><a id="more"></a><h2 id="çœ‹å±±æ˜¯å±±"><a href="#çœ‹å±±æ˜¯å±±" class="headerlink" title="çœ‹å±±æ˜¯å±±"></a>çœ‹å±±æ˜¯å±±</h2><p>é¦–å…ˆä¸¾ä¸€ä¸ªå…·ä½“ç‚¹çš„ä¾‹å­æ¥æè¿°ï¼ˆä¸ºäº†æ–¹ä¾¿ï¼Œå°±ä¸å®šä¹‰<code>CountService</code>çš„æ¥å£ç±»äº†ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ffutop.signature;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸»ç±»</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019-02-26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CountService countService = <span class="keyword">new</span> CountService();</span><br><span class="line">        countService.add(<span class="number">1</span>);</span><br><span class="line">        System.out.println(String.format(<span class="string">"currentValue = %d"</span>, countService.getCurrentValue()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ffutop.signature;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019-02-26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentValue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æŠŠ add(int) ç†è§£æˆ API</span></span><br><span class="line"><span class="comment">     * è™½ç„¶å·²ç»åšäº†å®ç°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> addend)</span> </span>&#123;</span><br><span class="line">        currentValue += addend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCurrentValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å·²ç»æœ‰ <code>void add(int)</code> æ–¹æ³•ï¼Œå®Œæˆçš„å·¥ä½œæ˜¯ç´¯åŠ ã€‚ç°åœ¨è¦æŠŠ API æ”¹æˆ <code>int add(int)</code>ï¼Œæ˜¯å¦å¯ä»¥å‘¢ï¼Ÿçœ‹ä¼¼æœ¬æ¥æ²¡æœ‰è¿”å›å€¼ï¼Œç°åœ¨åªæ˜¯åŠ ä¸Šä¸€ä¸ªè¿”å›å€¼ï¼Œå¯¹äºåŸæ¥çš„ä»£ç æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè€Œæ–°ä»£ç åˆèƒ½æ‹¿åˆ°intç±»å‹çš„è¿”å›å€¼ï¼Œçš†å¤§æ¬¢å–œå•Šã€‚</p><h2 id="çœ‹å±±ä¸æ˜¯å±±"><a href="#çœ‹å±±ä¸æ˜¯å±±" class="headerlink" title="çœ‹å±±ä¸æ˜¯å±±"></a>çœ‹å±±ä¸æ˜¯å±±</h2><p>å…ˆç»™å¤§å®¶æ‰§è¡Œä¸‹ä»£ç å§ï¼ï¼ˆè¯·ä¸¥æ ¼æŒ‰ç…§é¡ºåºï¼Œä¸”é¿å…ä½¿ç”¨IDEï¼Œå¦åˆ™å°†å¾—ä¸åˆ°é¢„æƒ³çš„ç»“æœï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># å‡†å¤‡å¥½ä¸¤ä¸ªç±»çš„ä»£ç ï¼ˆCountServiceçš„APIæ˜¯ `void add(int)`ï¼‰</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># ç¼–è¯‘Mainç±»</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> javac com/ffutop/signature/Main.java</span></span><br><span class="line"><span class="meta">$</span><span class="bash">  </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># ä¿®æ”¹CountServiceçš„APIä¸º`int add(int)`</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># ç¼–è¯‘ CountService ç±»</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> javac com/ffutop/signature/CountService.java</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># æ‰§è¡Œä¸»ç¨‹åº</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java com.ffutop.signature.Main</span></span><br><span class="line">Exception in thread "main" java.lang.NoSuchMethodError: com.ffutop.signature.CountService.add(I)V</span><br><span class="line">at com.ffutop.signature.Main.main(Main.java:11)</span><br></pre></td></tr></table></figure><p>å¾ˆé—æ†¾ï¼Œæ‰§è¡Œå¤±è´¥äº†ï¼ŒæŠ¥äº†ä¸ªErrorï¼ˆæ²¡æœ‰è¿™æ ·çš„æ–¹æ³•ï¼‰ã€‚æ–¹æ³•å†™çš„æ˜¯ <code>com.ffutop.signature.CountService.add(I)V</code> ã€‚ç®€å•çš„ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯éœ€è¦<code>ç±»å+æ–¹æ³•å=x.y.CountService.add</code>ï¼Œä¸”å…¥å‚ä¸ºintï¼Œå‡ºå‚ä¸ºvoidçš„æ–¹æ³•ï¼ˆæƒ³äº†è§£æ›´å¤šè¯·ä¼˜å…ˆå­¦ä¹ <a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-4.html#jvms-4.4" target="_blank" rel="noopener">Java ClassFile Format</a>ï¼‰ã€‚</p><p>é‚£ä¹ˆï¼Œç°åœ¨å¾—åˆ°çš„ç»“è®ºæ˜¯ä¸è¡Œã€‚</p><h2 id="çœ‹å±±è¿˜æ˜¯å±±"><a href="#çœ‹å±±è¿˜æ˜¯å±±" class="headerlink" title="çœ‹å±±è¿˜æ˜¯å±±"></a>çœ‹å±±è¿˜æ˜¯å±±</h2><p>é‚£ä¹ˆï¼Œå°±ä¸€å®šä¸è¡Œå—ï¼Ÿéƒ½æ˜¯åŒåæ–¹æ³•ï¼Œä¸åŒå‚æ•°ã€‚å‡­ä»€ä¹ˆæ”¹ä¸ªå…¥å‚æ˜¯å¯ä»¥çš„ï¼Œæ”¹ä¸ªå‡ºå‚å°±ä¸è¡Œäº†ã€‚</p><p>ä» Java çš„è§’åº¦æ¥è¯´ï¼Œä¸€å®šä¸è¡Œã€‚â€œåŒä¸€ç±»ä¸­ä¸èƒ½å­˜åœ¨ä¸¤ä¸ªåå­—åŠæè¿°ç¬¦å®Œå…¨ç›¸åŒçš„æ–¹æ³•â€</p><p>ä½†æ˜¯ï¼Œå¦‚æœä» JVM çš„è§’åº¦æ¥è¯´ï¼Œå®Œå…¨æ˜¯å¯è¡Œçš„ã€‚â€œåœ¨classæ–‡ä»¶ä¸­ï¼Œä¸¤ä¸ªæ–¹æ³•å¯ä»¥æ‹¥æœ‰å®Œå…¨ç›¸åŒçš„ç‰¹å¾ç­¾åï¼Œå‰ææ˜¯è¿”å›å€¼ä¸èƒ½ç›¸åŒâ€</p><p>ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“å»ºç«‹åœ¨ JVM ä¹‹ä¸Šçš„è¯­è¨€ä¸åªæœ‰ Javaã€‚åƒ Groovyã€Kotlin ç­‰è¯­è¨€éƒ½å®ç°äº†å„è‡ªçš„åŒºåˆ«äº Java ç‹¬æœ‰çš„ç‰¹å¾ã€‚è¿™äº›ç‰¹å¾çš„å®ç°éƒ½æ˜¯ä¾èµ–äº JVMï¼Œä½†ä¸ºä»€ä¹ˆ Java æ²¡æœ‰å‘¢ï¼Ÿåªèƒ½è¯´ Java è¯­è¨€çš„è§„èŒƒæ˜¯ JVM çš„å­é›†ï¼ˆå¥½åƒè¿™è¯æœ‰ç‚¹ä¸ä¸¥è°¨å•Šï¼‰</p><p>é€šè¿‡ç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°åœ¨åŒä¸€ä¸ªç±»ä¸­å»ºç«‹ä¸¤ä¸ªåŒåã€ç›¸åŒå…¥å‚ï¼Œä½†è¿”å›å€¼ä¸åŒçš„æ–¹æ³•ã€‚<br>å…ˆé€šè¿‡<code>javap</code>å‘½ä»¤çœ‹çœ‹æœ€ç»ˆæä¾›çš„<code>CountService.class</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> javap com.ffutop.signature.CountService</span></span><br><span class="line">public class com.ffutop.signature.CountService &#123;</span><br><span class="line">  public int add(int);</span><br><span class="line">  public com.ffutop.signature.CountService();</span><br><span class="line">  public void add(int);</span><br><span class="line">  public int getCurrentValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ä¸ªåŒåçš„æ–¹æ³•<code>add(int)</code>ï¼Œè‡³äºæ‰§è¡Œï¼Œä¹Ÿä¼šç›¸å½“é¡ºåˆ©ã€‚</p><p>è¿˜æ˜¯å†™ä¸ªç¨‹åºæ¥è¯´æ˜ï¼Œåœ¨åŸæœ‰ <code>Main.java</code> çš„åŸºç¡€ä¸Šï¼Œå†åˆ›å»ºä¸€ä¸ªå…¨é™å®šåä¸º <code>com.ffutop.signature.other.Main2</code> çš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ffutop.signature.other;</span><br><span class="line"><span class="keyword">import</span> com.ffutop.signature.CountService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019-02-27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CountService countService = <span class="keyword">new</span> CountService();</span><br><span class="line">        System.out.println(String.format(<span class="string">"currentValue = %d"</span>, countService.add(<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ Main.java æ¯”è¾ƒï¼Œå¾ˆæ˜æ˜¾çš„å°±æ˜¯ä¸€ä¸ªè°ƒç”¨äº† <code>CountService</code> çš„ <code>int add(int)</code> æ–¹æ³•ï¼Œè€Œå¦ä¸€ä¸ªè°ƒç”¨ <code>void add(int)</code> æ–¹æ³•ã€‚</p><p>é‚£ä¹ˆæ˜¯å¦æœ‰æ•ˆå‘¢ï¼Ÿå…ˆæ¥éªŒè¯ä¸€ä¸‹ï¼ˆè¿™é‡Œè¦æ¨¡æ‹Ÿçš„ä¸€ä¸ªåœºæ™¯æ˜¯ï¼ŒCountService ç±»(åªæœ‰ <code>void add(int)</code> æ–¹æ³•)ä½œä¸ºäºŒæ–¹åº“C.jar version 1.0 çš„ä¸»è¦æœåŠ¡ç±»ã€‚CountService ç±»(åŒæ—¶æœ‰ <code>void add(int)</code> å’Œ <code>int add(int)</code> æ–¹æ³•)ä½œä¸ºäºŒæ–¹åº“C.jar version 2.0 çš„ä¸»è¦æœåŠ¡ç±»ã€‚Main ç±»æ ¹æ® C.jar version 1.0 åšçš„ç¼–è¯‘ï¼Œè€Œ Main2 ç±»æ ¹æ® C.jar version 2.0 åšçš„ç¼–è¯‘ã€‚åœ¨ Main å’Œ Main2 ç±»è¿è¡Œæ—¶åªæä¾› C.jar version 2.0ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># ç¼–è¯‘ Main ç±»å’Œ CountService ç±»</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> javac com/ffutop/signature/Main.java</span></span><br><span class="line"><span class="meta">$</span><span class="bash"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># æ“ä½œ CountService.class å­—èŠ‚ç ï¼Œå¢åŠ æ–¹æ³• `int add(int)` </span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># é€šè¿‡ ASM å®ç°ï¼Œè¯¦è§é™„å½•æºç  com/ffutop/signature/support/Generator.java</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># ç¼–è¯‘ Main2 ç±» (æä¾› classpathï¼Œå³æ ¹æ® CountService.class ç¼–è¯‘)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> javac com/ffutop/signature/other/Main2.java -classpath .</span></span><br><span class="line"><span class="meta">$</span><span class="bash"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># éªŒè¯</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java com.ffutop.signature.Main</span></span><br><span class="line">currentValue = 1</span><br><span class="line"><span class="meta">$</span><span class="bash"> java com.ffutop.signature.other.Main2</span></span><br><span class="line">currentValue = 1</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># OKï¼ŒéªŒè¯é€šè¿‡</span></span></span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸€æ—¦ API å®šä¹‰é”™è¯¯ï¼Œå¹¶å·²ç»ä½œä¸ºäºŒæ–¹åº“æä¾›ç»™è°ƒç”¨æ–¹ã€‚åæœå¿…ç„¶æ˜¯ç¾éš¾æ€§çš„ã€‚è‡³å°‘ï¼Œåªèƒ½é‡æ–°å®šä¹‰ API ã€‚å¦‚æœå¯¹äºå…¥å‚å®šä¹‰é”™è¯¯ï¼ŒJava è¯­è¨€çº§åˆ«ä¹Ÿèƒ½å¤Ÿæ”¯æŒã€‚ä½†å¦‚æœæ˜¯è¿”å›å€¼ï¼Œå¦‚æœéè¦ä¿æŒæ–¹æ³•åä¸€è‡´ï¼Œé‚£å°±ä¸å¾—ä¸ä¸‹æ²‰åˆ° JVM çº§åˆ«æ¥è¿›è¡Œå¤„ç†äº†ã€‚å½“ç„¶ï¼Œåœ¨å·¥ç¨‹é¡¹ç›®ä¸­æ˜¯å¦åº”è¯¥ç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Ÿè‡³å°‘ä¸ªäººè¿˜æ²¡ç›´æ¥æ¥è§¦è¿‡ã€‚</p><p>åšä¸ªè®°å½•ï¼Œæœªæ¥å¯ä»¥ç¿»ä¸€ç¿»ï¼Œè‡³å°‘æ˜¯ä¸€ç§å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://raw.githubusercontent.com/DorMOUSE-None/Repo/master/signature.zip" target="_blank" rel="noopener">æºç .zip</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å·¥ç¨‹é¡¹ç›®ä¸­ï¼Œå®šä¹‰ API æ€»æ˜¯ä¸€ä¸ªæ…ä¹‹åˆæ…çš„æ“ä½œã€‚ä¸èƒ½å°‘ï¼Œä¸æ»¡è¶³è°ƒç”¨æ–¹çš„éœ€æ±‚å°±æƒ¨äº†ï¼›ä¹Ÿä¸èƒ½å¤šï¼Œä¸ç„¶å°±ä¹±å¥—äº†ï¼Œè‡ªå·±ç»´æŠ¤å›°éš¾ï¼Œè°ƒç”¨æ–¹ä¹Ÿå¼€å§‹äº†è‡ªæˆ‘å‘æŒ¥ã€‚è™½ç„¶è¶³å¤Ÿæ…é‡ï¼Œä½†ç»å¤§å¤šæ•°éƒ½é€ƒä¸è¿‡æœ€ç»ˆä¸å¾—ä¸â€œæ”¹â€ API çš„æƒ…å†µã€‚ä»Šå¤©è¦è®¨è®ºçš„æ˜¯åœ¨åŒä¸€ä¸ªç±»å†…åŒæ–¹æ³•åä¸åŒå‚æ•°ï¼ˆå…¥å‚/å‡ºå‚ï¼‰çš„æƒ…å†µã€‚&lt;/p&gt;
&lt;p&gt;æƒ³è¦åšåˆ°åŒæ–¹æ³•åä¸åŒå…¥å‚ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯â€œé‡è½½ï¼ˆOverloadï¼‰â€ï¼Œæ—¥å¸¸éƒ½åœ¨ä½¿ç”¨ã€‚ä¸å†èµ˜è¿°ï¼&lt;/p&gt;
&lt;p&gt;æƒ³è¦åšåˆ°åŒæ–¹æ³•åä¸åŒå‡ºå‚ï¼Œç­”æ¡ˆå°±ä¸å†é‚£ä¹ˆè‚¯å®šäº†ã€‚å½“ç„¶ï¼Œå¦‚æœé—®æŠŠ&lt;code&gt;void add(int)&lt;/code&gt; API æ”¹å†™æˆ &lt;code&gt;int add(int)&lt;/code&gt;ï¼Œå¯èƒ½å¾—åˆ°çš„å¤§å¤šæ•°å›ç­”éƒ½æ˜¯å¯ä»¥ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="https://DorMOUSE-None.github.io/tags/Java/"/>
    
      <category term="API" scheme="https://DorMOUSE-None.github.io/tags/API/"/>
    
  </entry>
  
  <entry>
    <title>å­—ç¬¦é›†ä¸å­—ç¬¦ç¼–ç </title>
    <link href="https://DorMOUSE-None.github.io/2019-02-02-unicode/"/>
    <id>https://DorMOUSE-None.github.io/2019-02-02-unicode/</id>
    <published>2019-02-01T16:00:00.000Z</published>
    <updated>2019-02-02T06:32:39.666Z</updated>
    
    <content type="html"><![CDATA[<div class="row"><iframe src="https://drive.google.com/file/d/1MuBNtZPMWCt9kGlpqiAtG3i3Al2MaknY/preview" style="width:100%; height:550px"></iframe></div>]]></content>
    
    <summary type="html">
    
      
      
        

	&lt;div class=&quot;row&quot;&gt;
		&lt;iframe src=&quot;https://drive.google.com/file/d/1MuBNtZPMWCt9kGlpqiAtG3i3Al2MaknY/preview&quot; style=&quot;width:100%; height:550
      
    
    </summary>
    
    
      <category term="Unicode" scheme="https://DorMOUSE-None.github.io/tags/Unicode/"/>
    
      <category term="Character Encoding" scheme="https://DorMOUSE-None.github.io/tags/Character-Encoding/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (8) - ç½‘ç»œ</title>
    <link href="https://DorMOUSE-None.github.io/2019-01-15-understand-Kernel-8/"/>
    <id>https://DorMOUSE-None.github.io/2019-01-15-understand-Kernel-8/</id>
    <published>2019-01-14T16:00:00.000Z</published>
    <updated>2019-01-15T06:05:20.845Z</updated>
    
    <content type="html"><![CDATA[<div class="row"><iframe src="https://drive.google.com/file/d/1l5Vjrs8vKy6b9EvZFP7c7hOblv2kHgNx/preview" style="width:100%; height:550px"></iframe></div>]]></content>
    
    <summary type="html">
    
      
      
        

	&lt;div class=&quot;row&quot;&gt;
		&lt;iframe src=&quot;https://drive.google.com/file/d/1l5Vjrs8vKy6b9EvZFP7c7hOblv2kHgNx/preview&quot; style=&quot;width:100%; height:550
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="Network" scheme="https://DorMOUSE-None.github.io/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡</title>
    <link href="https://DorMOUSE-None.github.io/2018-12-28-understand-Kernel-7/"/>
    <id>https://DorMOUSE-None.github.io/2018-12-28-understand-Kernel-7/</id>
    <published>2018-12-27T16:00:00.000Z</published>
    <updated>2018-12-27T23:47:28.308Z</updated>
    
    <content type="html"><![CDATA[<p>ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚</p><p>å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚</p><p>é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚</p><a id="more"></a><h2 id="å®è§‚æ¦‚è§ˆ"><a href="#å®è§‚æ¦‚è§ˆ" class="headerlink" title="å®è§‚æ¦‚è§ˆ"></a>å®è§‚æ¦‚è§ˆ</h2><p>é€šå¸¸åœ¨æˆ‘ä»¬çš„è®¤è¯†ä¸­ï¼Œå‘½ä»¤è¡Œç»ˆç«¯å°±è¢«è®¤ä¸ºæ˜¯ä¸ä¸€å¥—å­—ç¬¦è®¾å¤‡ç›¸é…åˆæ¥ä½¿ç”¨çš„ã€‚å¾ˆæ­£å¸¸å˜›ã€‚æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª Shell ï¼Œé€šè¿‡é”®ç›˜è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œé…åˆæ˜¾ç¤ºå™¨æŠŠè¿™äº›ç»è¿‡åŠ å·¥çš„å­—ç¬¦å±•ç¤ºå‡ºæ¥ã€‚</p><p>é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ Shell ä½œä¸ºä¸€ä¸ªä»»åŠ¡(è¿›ç¨‹)ï¼Œä»¥é”®ç›˜è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œä»¥æ˜¾ç¤ºè®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å‡º?</p><p>çœ‹çœ‹ä¸€ä¸ª 1 å·ä»»åŠ¡ <code>/bin/bash</code> çš„æ–‡ä»¶æè¿°ç¬¦è¯´æ˜å§ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ls -al</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 root root  0 Dec 13 23:20 .</span><br><span class="line">dr-xr-xr-x 9 root root  0 Dec 13 23:20 ..</span><br><span class="line">lrwx------ 1 root root 64 Dec 13 23:20 0 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Dec 13 23:20 1 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Dec 13 23:20 2 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Dec 25 01:09 255 -&gt; /dev/pts/0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ–‡ä»¶æè¿°ç¬¦ 0, 1, 2 åˆ†åˆ«è¡¨ç¤ºä»»åŠ¡çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚è¿™äº›å†…å®¹åœ¨è¡¨ç°å½¢å¼ä¸Šåšäº†ä¸€ä¸ªé“¾æ¥ã€‚</p><p>é‚£ä¹ˆï¼Œ<code>/dev/pts/0</code> æ˜¯ä»€ä¹ˆ? </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crw--w---- 1 root tty 136, 0 Dec 13 23:20 /dev/pts/0</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹å’Œæœ€åˆé¢„æƒ³çš„æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚è‡³å°‘åœ¨å‡è±¡ä¸­ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªè¾“å…¥(é”®ç›˜)ï¼Œä¸€ä¸ªè¾“å‡º(æ˜¾ç¤ºå™¨)ã€‚æ€ä¹ˆå°±æ··æˆäº†ä¸€ä¸ªå‘¢ï¼Ÿ</p><p>æœ¬æ¥æ˜¯æ€ä¹ˆéƒ½æƒ³ä¸é€šçš„ï¼Œä½†åæ¥é…åˆâ€Unixä¸€åˆ‡çš†æ–‡ä»¶â€çš„ä¿¡æ¡ï¼Œæ€»ç®—æ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚</p><p>ç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™è¿™æ ·çš„ç»å†ï¼ŒæŸä¸ªç¨‹åºæ˜¯ä»¥é”®ç›˜è¾“å…¥ä½œä¸ºæ ‡å‡†è¾“å…¥çš„ã€‚å…¶å®å°±å’Œä¸Šé¢ğŸ‘†å±•ç¤ºçš„ä¸€æ · <code>0 -&gt; /dev/pts/0</code> ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡è¿™æ•´å¥—æµç¨‹æ˜¯æ€ä¹ˆåä½œçš„å‘¢ï¼Ÿ</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyjvtjiu0zj31980oqmxe.jpg" alt=""></p><p>å¯¹äºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ™®é€šçš„è°ƒç”¨ <code>read</code>, <code>write</code> ç­‰ç»è¿‡å°è£…çš„å‡½æ•°ï¼Œæ¥è¯»å–ä¸€ä¸ªæ‰€è°“çš„æ–‡ä»¶ã€‚</p><p>ä½†å¯¹äºæ–‡ä»¶æ˜¯å­—ç¬¦è®¾å¤‡æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ <code>tty_read</code>, <code>tty_write</code> äº†ã€‚é€šä¿—çš„è®²ï¼Œå¤§æ¦‚ç‡çš„å°±æ˜¯é”®ç›˜ä½œä¸ºè¾“å…¥ï¼Œæ˜¾ç¤ºå™¨ä½œä¸ºè¾“å‡ºäº†ã€‚</p><h2 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h2><h3 id="æ–‡ä»¶è¯»å†™"><a href="#æ–‡ä»¶è¯»å†™" class="headerlink" title="æ–‡ä»¶è¯»å†™"></a>æ–‡ä»¶è¯»å†™</h3><p>è¿™éƒ¨åˆ†ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p><p>ç®€å•å›é¡¾ä¸‹ <code>sys_read</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_read</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd,<span class="keyword">char</span> * buf,<span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">inode</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fd&gt;=NR_OPEN || count&lt;<span class="number">0</span> || !(file=current-&gt;filp[fd]))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (!count)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">verify_area(buf,count);</span><br><span class="line">inode = file-&gt;f_inode;</span><br><span class="line"><span class="keyword">if</span> (inode-&gt;i_pipe)</span><br><span class="line"><span class="keyword">return</span> (file-&gt;f_mode&amp;<span class="number">1</span>)?read_pipe(inode,buf,count):-EIO;</span><br><span class="line">    <span class="comment">/* ç¡®è®¤åˆ°ièŠ‚ç‚¹æè¿°çš„æ˜¯å­—ç¬¦è®¾å¤‡ */</span></span><br><span class="line"><span class="keyword">if</span> (S_ISCHR(inode-&gt;i_mode)) </span><br><span class="line"><span class="keyword">return</span> rw_char(READ,inode-&gt;i_zone[<span class="number">0</span>],buf,count,&amp;file-&gt;f_pos);</span><br><span class="line"><span class="keyword">if</span> (S_ISBLK(inode-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span> block_read(inode-&gt;i_zone[<span class="number">0</span>],&amp;file-&gt;f_pos,buf,count);</span><br><span class="line"><span class="keyword">if</span> (S_ISDIR(inode-&gt;i_mode) || S_ISREG(inode-&gt;i_mode)) &#123;</span><br><span class="line"><span class="keyword">if</span> (count+file-&gt;f_pos &gt; inode-&gt;i_size)</span><br><span class="line">count = inode-&gt;i_size - file-&gt;f_pos;</span><br><span class="line"><span class="keyword">if</span> (count&lt;=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> file_read(inode,file,buf,count);</span><br><span class="line">&#125;</span><br><span class="line">printk(<span class="string">"(Read)inode-&gt;i_mode=%06o\n\r"</span>,inode-&gt;i_mode);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>S_ISCHR()</code> å°±æ˜¯åœ¨å¯¹ièŠ‚ç‚¹çš„ç±»å‹è¿›è¡Œåˆ¤åˆ«ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„åˆ†å‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> crw_ptr crw_table[]=&#123;</span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">/* nodev */</span></span><br><span class="line">rw_memory,<span class="comment">/* /dev/mem etc */</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">/* /dev/fd */</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">/* /dev/hd */</span></span><br><span class="line">rw_ttyx,<span class="comment">/* /dev/ttyx */</span></span><br><span class="line">rw_tty,<span class="comment">/* /dev/tty */</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">/* /dev/lp */</span></span><br><span class="line"><span class="literal">NULL</span>&#125;;<span class="comment">/* unnamed pipes */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿™æ®µè¿˜æ˜¯æ¶‰åŠåˆ°åˆ†å‘ï¼Œç”±ä¸åŒçš„è®¾å¤‡å·(dev) æ¥ç¡®å®šæ‰§è¡Œå‡½æ•° (ttyx, ä¸²å£ç»ˆç«¯; tty, æ§åˆ¶å°ç»ˆç«¯; mem, /dev/mem ç­‰)</span></span><br><span class="line"><span class="comment"> * crw_ptr æ˜¯ C è¯­è¨€ä¸­å¸¸è§çš„å‡½æ•°æŒ‡é’ˆã€‚ç”±devå·æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rw_char</span><span class="params">(<span class="keyword">int</span> rw,<span class="keyword">int</span> dev, <span class="keyword">char</span> * buf, <span class="keyword">int</span> count, <span class="keyword">off_t</span> * pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">crw_ptr call_addr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (MAJOR(dev)&gt;=NRDEVS)</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"><span class="keyword">if</span> (!(call_addr=crw_table[MAJOR(dev)]))</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"><span class="keyword">return</span> call_addr(rw,MINOR(dev),buf,count,pos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåˆ° <code>rw_tty</code>, <code>rw_ttyx</code> ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å°†å¯¹è¯»/å†™è¿›è¡ŒåŒºåˆ†ï¼Œå¹¶ç”±ç‰¹å®šçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rw_ttyx</span><span class="params">(<span class="keyword">int</span> rw,<span class="keyword">unsigned</span> minor,<span class="keyword">char</span> * buf,<span class="keyword">int</span> count,<span class="keyword">off_t</span> * pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ((rw==READ)?tty_read(minor,buf,count):</span><br><span class="line">tty_write(minor,buf,count));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rw_tty</span><span class="params">(<span class="keyword">int</span> rw,<span class="keyword">unsigned</span> minor,<span class="keyword">char</span> * buf,<span class="keyword">int</span> count, <span class="keyword">off_t</span> * pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (current-&gt;tty&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line"><span class="keyword">return</span> rw_ttyx(rw,current-&gt;tty,buf,count,pos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥èƒ½å¤ŸåŸºæœ¬äº†è§£äº†å­—ç¬¦è®¾å¤‡ï¼Œä½œä¸º Linux çš„æ–‡ä»¶ï¼Œæ‰€åº”è¯¥æœ‰çš„è¯»å†™çš„ç›¸å…³æ”¯æŒã€‚</p><p>ä½†æ˜¯ï¼Œç©¶ç«Ÿè¯»ã€å†™çš„å†…å®¹åœ¨å“ªå‘¢ï¼Ÿæ¯”å¦‚æ­£è§„æ–‡ä»¶ï¼Œéƒ½å¾ˆå®¹æ˜“åœ°å¯ä»¥ç†è§£åˆ°ï¼Œå°±æ˜¯ä»ç£ç›˜ä¸­å–å‡ºæŸä¸ª/æŸå‡ ä¸ªç›˜å—çš„å†…å®¹å³å¯ã€‚å­—ç¬¦è®¾å¤‡çš„IOè¦ä»å“ªé‡Œå–(å¾€å“ªé‡Œé€)æ•°æ®å‘¢?</p><h3 id="å­—ç¬¦è®¾å¤‡é©±åŠ¨"><a href="#å­—ç¬¦è®¾å¤‡é©±åŠ¨" class="headerlink" title="å­—ç¬¦è®¾å¤‡é©±åŠ¨"></a>å­—ç¬¦è®¾å¤‡é©±åŠ¨</h3><p>å¯¹äºè®¾å¤‡é©±åŠ¨è¿™ä¸ªæ¦‚å¿µï¼Œè‡³ä»Šæ²¡æœ‰ææ¸…æ¥šã€‚ä¸è¿‡ï¼Œè¿™ä¸å¦¨ç¢å¯¹ä»£ç çš„ç†è§£ã€‚åæ­£å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€äº›è½¯ä»¶å±‚é¢çš„ä»£ç ï¼Œä¸æ™®é€šä»£ç çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¯¹å¤–è®¾ç¡¬ä»¶åšäº†ç›¸åº”çš„äº¤äº’æ”¯æŒã€‚</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fykyc6lo9pj31i40u0ac8.jpg" alt=""></p><p>æ‰¿æ¥æ“ä½œç³»ç»Ÿçš„å­—ç¬¦è®¾å¤‡æ¥å£ï¼Œ<code>tty_read</code>ã€<code>tty_write</code> è´Ÿè´£è¯»å…¥å’Œå†™å‡ºã€‚</p><p>ä»å“ªé‡Œè¯»ï¼Ÿ<code>secondary</code> æ•°æ®é˜Ÿåˆ—ï¼›å¾€å“ªé‡Œå†™ï¼Ÿ<code>write_q</code> æ•°æ®é˜Ÿåˆ—ã€‚</p><p>åŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿™äº›é˜Ÿåˆ—ç›´æ¥ç›¸å…³çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨äº†ã€‚æ˜¯ä¸æ˜¯æœ‰äº†ç‚¹è±ç„¶å¼€æœ—çš„æ„Ÿè§‰ã€‚</p><p>å¥½ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™é‡Œæè¿°çš„ä¸‰ä¸ªé˜Ÿåˆ—ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œå°±ä¸å¾—ä¸å…ˆçœ‹çœ‹å†…å­˜ä¸­æŠ½è±¡å‡ºæ¥çš„æè¿°ç»ˆç«¯çš„æ•°æ®ç»“æ„ <code>tty_struct</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * copied from include/linux/tty.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">termios</span>;</span>     <span class="comment">/* terminal IO conf */</span></span><br><span class="line"><span class="keyword">int</span> pgrp;                   <span class="comment">/* æ‰€å±è¿›ç¨‹ç»„ */</span></span><br><span class="line"><span class="keyword">int</span> stopped;                <span class="comment">/* åœæ­¢æ ‡å¿— */</span></span><br><span class="line"><span class="keyword">void</span> (*write)(struct tty_struct * tty); <span class="comment">/* ç»ˆç«¯å†™å‡½æ•°æŒ‡é’ˆ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span> <span class="title">read_q</span>;</span>    <span class="comment">/* ç»ˆç«¯è¯»é˜Ÿåˆ— */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span> <span class="title">write_q</span>;</span>   <span class="comment">/* ç»ˆç«¯å†™é˜Ÿåˆ— */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span> <span class="title">secondary</span>;</span> <span class="comment">/* ç»ˆç«¯è¾…åŠ©é˜Ÿåˆ— */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * copied from include/termios.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termios</span> &#123;</span>                <span class="comment">/* terminal IO å±æ€§ */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> c_iflag;<span class="comment">/* input mode flags */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> c_oflag;<span class="comment">/* output mode flags */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> c_cflag;<span class="comment">/* control mode flags */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> c_lflag;<span class="comment">/* local mode flags */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> c_line;<span class="comment">/* line discipline */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> c_cc[NCCS];<span class="comment">/* control characters */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * copied from include/linux/tty.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> data;         <span class="comment">/* å­—ç¬¦è¡Œæ•°é‡ | ä¸²å£ç»ˆç«¯åˆ™å­˜å‚¨ç«¯å£å· */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> head;         <span class="comment">/* å¤´æŒ‡é’ˆ */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> tail;         <span class="comment">/* å°¾æŒ‡é’ˆ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * <span class="title">proc_list</span>;</span> <span class="comment">/* ç­‰å¾…è¯¥ç»ˆç«¯çš„ä»»åŠ¡é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">char</span> buf[TTY_BUF_SIZE];     <span class="comment">/* é˜Ÿåˆ—çš„ç¼“å†²åŒº */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºä»»ä½•ä»»åŠ¡éœ€è¦è¯»å†™å­—ç¬¦è®¾å¤‡(è¿™é‡ŒæŒ‡ç»ˆç«¯è®¾å¤‡)ï¼Œæœ€ç»ˆç›´æ¥è¯»å–/å†™å…¥åˆ°çš„å°±æ˜¯ <code>secondary</code> å’Œ <code>write_q</code>ã€‚</p><hr><p>è¿™é‡Œå¯èƒ½æœ‰ä¸ªå°å°çš„ç–‘é—®? ä¸ºä»€ä¹ˆè¯»ç»ˆç«¯è®¾å¤‡ä¸æ˜¯è¯» <code>read_q</code> å‘¢ï¼Ÿ</p><p>å…¶å®ä¹Ÿæ¯”è¾ƒå¥½è§£é‡Šï¼Œç›¸ä¿¡æ—¥å¸¸åœ¨æ“ä½œå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ•²å‡»çš„é”®ä½ä¸æ˜¾ç¤ºå™¨ä¸Šå®é™…å±•ç¤ºçš„å†…å®¹æ˜¯ä¸ç›¸åŒ¹é…çš„ã€‚æœ€æ™®é€šçš„ï¼Œæˆ‘ä»¬é”®å…¥äº† <strong>delete(åˆ é™¤é”®)</strong>ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸€ä¸ª <strong>delete</strong> å¯¹åº”çš„ ascii (å½“ç„¶ï¼Œè¿™é‡Œè¯·å…ˆå¿½è§†éæ‰“å°å­—ç¬¦çš„é—®é¢˜)ï¼Œè€Œæ˜¯åˆ é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿå®Œå…¨å¯ä»¥æƒ³è±¡ï¼Œåæ­£ä»»ä½•é”®ä½ä¸é©±åŠ¨äº¤äº’çš„æ—¶å€™éƒ½æ˜¯ä¼ å…¥ä¸€ä¸²äºŒè¿›åˆ¶ç å˜›ã€‚</p><p>è¿™é‡Œçš„ <code>secondary</code> å®Œæˆçš„å°±æ˜¯æ€ä¹ˆä¸€ä¸ªå·¥ä½œï¼Œ<code>read_q</code> å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å¤–è®¾(è¿™é‡Œæ˜¯é”®ç›˜)çš„è¾“å…¥ï¼Œå¹¶åŸæ ·å­˜å‚¨ã€‚è€Œåˆ°äº† <code>secondary</code> å°±æ˜¯ç»è¿‡ç›¸åº”çš„åŠ å·¥ï¼Œè¯¸å¦‚æ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„éƒ½å±•ç°äº†å„è‡ªçš„æ„ä¹‰ï¼Œå¹¶å®Œæˆä¸€äº›åŠ å·¥å·¥ä½œï¼Œè€Œä¸å†ä»…ä»…åªæ˜¯æ™®é€šåœ°å±•ç¤ºäº†ã€‚</p><hr><p>å¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†åœ¨å‘½ä»¤è¡Œäº¤äº’æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½å°†ç›´æ¥åœ¨æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå¥½åƒæˆ‘ä»¬åœ¨ç›´æ¥å¾€æ˜¾ç¤ºå™¨ä¸Šå†™å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‰é¢æˆ‘ä»¬æè¿°çš„å†…å®¹éƒ½æ˜¯ï¼Œé”®ç›˜è®¾å¤‡ä½œä¸ºè¾“å…¥ï¼Œæ˜¯è¦å†™åˆ° <code>read_q</code> ä¹ƒè‡³ <code>secondary</code> å¹¶æœ€ç»ˆä½œä¸ºè¿›ç¨‹çš„è¾“å…¥çš„ã€‚åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºå¹¶ä¸æ˜¯å®ƒæœ¬æ¥åº”è¯¥å¹²çš„äº‹æƒ… (æ¯”è¾ƒæ˜¾ç¤ºå™¨ä¸Šå±•ç¤ºçš„åº”è¯¥æ˜¯ <code>write_q</code> çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º)</p><p>äº‹å®ä¸Šï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªå›æ˜¾ï¼Œå°† <code>secondary</code> é˜Ÿåˆ—çš„å†…å®¹å¤åˆ¶äº†ä¸€ä»½åˆ°å†™é˜Ÿåˆ—ï¼Œä¹Ÿå°±å‘ˆç°å‡ºè®©æ˜¾ç¤ºå™¨æ‰“å°ç›¸åº”é”®ç›˜è¾“å…¥çš„æ•ˆæœäº†ã€‚</p><p>åŒæ—¶ï¼Œè¿™ä¹Ÿå°±èƒ½å¤Ÿç›´æ¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>passwd</code>, <code>su</code>, <code>sudo</code> ç­‰å‘½ä»¤æ—¶ï¼Œè¦æ±‚è¾“å…¥å¯†ç éƒ½æ˜¯ä¸åœ¨æ˜¾ç¤ºå™¨ä¸Šå›æ˜¾çš„ã€‚å®ç°ä¹Ÿç›¸å½“ç®€å•äº†å˜›ã€‚æŠŠ tty_struct.termios çš„ç›¸åº”æ§åˆ¶å±æ€§ (ECHO) é‡ç½®ï¼Œå°±å¯ä»¥å®ç°ä¸å›æ˜¾çš„æ•ˆæœäº†ã€‚</p><h3 id="ç»ˆç«¯è®¾å¤‡äº¤äº’"><a href="#ç»ˆç«¯è®¾å¤‡äº¤äº’" class="headerlink" title="ç»ˆç«¯è®¾å¤‡äº¤äº’"></a>ç»ˆç«¯è®¾å¤‡äº¤äº’</h3><p>æœ€åä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€å…³å¿ƒçš„äº†ã€‚å¤–è®¾å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿå®Œæˆäº¤äº’ã€‚å…¶å®ä¹Ÿèƒ½å¤Ÿæƒ³å¾—åˆ°äº†â€”â€”ä¸­æ–­ã€‚</p><p>åœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå°±æŠŠä¸­æ–­æè¿°ç¬¦è¡¨çš„ä¸­æ–­è¡¨é¡¹é…ç½®å¾—å½“ã€‚ä¹‹åçš„äº‹æƒ…å°±æ˜¯ç­‰å¾…é”®ç›˜ç­‰å¤–è®¾è¾“å…¥çš„ä¸­æ–­ä¿¡å·äº†ã€‚</p><p>åˆçœ‹å›åˆ°äº† <code>init/main.c</code> ç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">trap_init();</span><br><span class="line">blk_dev_init();</span><br><span class="line">chr_dev_init(); <span class="comment">/* å—è®¾å¤‡ç›¸å…³åˆå§‹åŒ–, æ–¹æ³•ä½“æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®ç° */</span></span><br><span class="line">tty_init();     <span class="comment">/* tty ç»ˆç«¯è®¾å¤‡åˆå§‹åŒ– */</span></span><br><span class="line">time_init();</span><br><span class="line">sched_init();</span><br><span class="line">buffer_init(buffer_memory_end);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Copied from kernel/chr_drv/tty_io.c</span><br><span class="line"> * ç»ˆç«¯è®¾å¤‡åˆè¯†åŒ–</span><br><span class="line"> */</span><br><span class="line">void tty_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    /** ä¸²å£è®¾å¤‡åˆå§‹åŒ– */</span><br><span class="line">rs_init();</span><br><span class="line">    /** æ§åˆ¶å°è®¾å¤‡åˆå§‹åŒ– */</span><br><span class="line">con_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³äºä¸ºä»€ä¹ˆæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ã€‚è¿™æ¥æºäºç»ˆç«¯åˆåŒºåˆ†ä¸ºæ§åˆ¶å°ç»ˆç«¯ä¸ä¸²å£ç»ˆç«¯ï¼ŒåŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç›´æ¥å»ºç«‹åœ¨ä¸»æœºä¸Šï¼Œä¸²å£ç»ˆç«¯æ˜¯é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥åˆ°ä¸»æœºçš„ã€‚å½“ç„¶ï¼Œè¿™éƒ½æ˜¯å¤è€çš„æ–¹å¼äº†ï¼Œç»†èŠ‚å°±ä¸å¤ªæ¸…æ¥šäº†ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹ <code>con_init()</code> åšäº†å“ªäº›å·¥ä½œ(<code>rs_init()</code> çš„å†…å®¹è¯·è‡ªè¡Œäº†è§£)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">con_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">register</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> a;</span><br><span class="line"><span class="keyword">char</span> *display_desc = <span class="string">"????"</span>;</span><br><span class="line"><span class="keyword">char</span> *display_ptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å– setup.s ç¨‹åºé¢„å¤„ç†çš„å†…å®¹</span></span><br><span class="line"><span class="comment">     * åŒ…æ‹¬æ˜¾ç¤ºå™¨çš„å„ç§é…ç½®å‚æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">video_num_columns = ORIG_VIDEO_COLS;</span><br><span class="line">video_size_row = video_num_columns * <span class="number">2</span>;</span><br><span class="line">video_num_lines = ORIG_VIDEO_LINES;</span><br><span class="line">video_page = ORIG_VIDEO_PAGE;</span><br><span class="line">video_erase_char = <span class="number">0x0720</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–æ˜¾ç¤ºå™¨çš„é…ç½®å¹¶è¿›è¡Œç›¸å…³è®¾ç½® (çœç•¥ä»£ç )</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">origin= video_mem_start;</span><br><span class="line">scr_end= video_mem_start + video_num_lines * video_size_row;</span><br><span class="line">top= <span class="number">0</span>;</span><br><span class="line">bottom= video_num_lines;</span><br><span class="line"></span><br><span class="line">gotoxy(ORIG_X,ORIG_Y);</span><br><span class="line">    <span class="comment">/** è®¾ç½®é™·é˜±é—¨ */</span></span><br><span class="line">set_trap_gate(<span class="number">0x21</span>,&amp;keyboard_interrupt);</span><br><span class="line">outb_p(inb_p(<span class="number">0x21</span>)&amp;<span class="number">0xfd</span>,<span class="number">0x21</span>);</span><br><span class="line">a=inb_p(<span class="number">0x61</span>);</span><br><span class="line">outb_p(a|<span class="number">0x80</span>,<span class="number">0x61</span>);</span><br><span class="line">outb(a,<span class="number">0x61</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æœ€é‡è¦çš„å†…å®¹å°±æ˜¯<strong>è®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨</strong>äº†ã€‚</p><p>ä¹‹ååªæœ‰é™é™åœ°ç­‰å¾…é”®ä½æ•²å‡»ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº§ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œä»è€Œè®© <code>read_q</code> è·å¾—åˆ°ç›¸åº”çš„å­—ç¬¦è¾“å…¥ã€‚</p><p>è‡³äºé”®ç›˜ä¸­æ–­çš„ç›¸åº”å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚ç®€è¿°ä¸€äº›æ­¥éª¤:</p><ol><li><p>äº§ç”Ÿç¡¬ä¸­æ–­ <code>keyboard_interrupt</code>ï¼Œç”±ç¨‹åº <code>Keyboard.s</code> çš„æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†</p></li><li><p>æ ¹æ®ä¸åŒçš„é”®ç›˜(US é”®ç›˜ã€å¾·å¼é”®ç›˜ç­‰ç­‰)å°†è·å¾—çš„é”®ä½ä¿¡å·è¿›è¡Œç›¸åº”çš„å­—ç¬¦è½¬æ¢(æŸ¥è½¬æ¢è¡¨)</p></li><li><p>è°ƒç”¨ <code>do_tty_interrupt</code> å¤„ç†å‡½æ•° (ç¡®è®¤æ˜¯ç»™å“ªä¸ªç»ˆç«¯çš„ä¿¡å·)</p></li><li><p>è°ƒç”¨ <code>copy_to_cooked(tty)</code> ï¼Œå³å®Œæˆ <code>read_q</code> åˆ° <code>secondary</code> çš„ç›¸å…³åŠ å·¥ã€‚</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚&lt;/p&gt;
&lt;p&gt;å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="Char Dev" scheme="https://DorMOUSE-None.github.io/tags/Char-Dev/"/>
    
  </entry>
  
  <entry>
    <title>SQL æ³¨å…¥</title>
    <link href="https://DorMOUSE-None.github.io/2018-12-15-sql-injection/"/>
    <id>https://DorMOUSE-None.github.io/2018-12-15-sql-injection/</id>
    <published>2018-12-14T16:00:00.000Z</published>
    <updated>2018-12-15T03:00:14.679Z</updated>
    
    <content type="html"><![CDATA[<p>è¯´å®è¯æ­¤å‰å¯¹ SQL æ³¨å…¥çš„ç†è§£ä»…ä»…åªæ˜¯çš®æ¯›ã€‚å½“ç„¶ï¼Œç›®å‰ä¹Ÿæ˜¯ï¼Œåªæ˜¯æœ‰äº†ä¸€å®šç¨‹åº¦çš„ç†è§£ã€‚</p><p>æœ€è¿‘å¥½åƒå·¥å…·ç”¨å¾—æœ‰äº›è¿‡å¤´äº†ï¼Œéœ€è¦åœä¸‹æ¥æ•´ç†ä¸‹å·¥å…·çš„å®ç°åŸç†ã€‚</p><p>æ›´å¥½åœ°ç†è§£äº†å·¥å…·å®ç°ï¼Œæ‰èƒ½æ›´åŠ å¿ƒå®‰ç†å¾—åœ°ä½¿ç”¨å·¥å…·ã€‚æ¯•ç«Ÿç­‰åˆ«äººæ€¼çš„æ—¶å€™ï¼Œè¿˜èƒ½å¤Ÿæ¯”è¾ƒå®‰å¿ƒåœ°å›é“: â€œæˆ‘ç”¨ä¸ç”¨ç°æˆçš„å·¥å…·åªæ˜¯å–å†³äºæˆ‘æƒ³ä¸æƒ³è‡ªå·±å†å†™ä¸€å¥—â€</p><p>å½“ç„¶ï¼Œæ¯•ç«Ÿæˆç†Ÿçš„å·¥å…·æœ‰æ›´å¤šçš„ä¼˜åŒ–ï¼Œè¿™å°±ä¸æ˜¯çŸ­æ—¶é—´å†…æˆ‘æƒ³ä¸æƒ³è‡ªå·±å†™çš„é—®é¢˜äº†ï¼Œå“ˆå“ˆã€‚</p><a id="more"></a><h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><p>SQL æ³¨å…¥æ¼æ´ç©¶ç«Ÿä¼šäº§ç”Ÿæ€ä¹ˆæ ·çš„å±å®³æ€§ï¼Œä»…ä»…åªæ˜¯ç»•è¿‡æŸäº›ç™»å½•è´¦å·å¯†ç çš„éªŒè¯? åªæ˜¯ç»•è¿‡æŸäº›è®¿é—®é™åˆ¶å®ç°ç‰¹æƒå†…å®¹çš„è®¿é—®?</p><p>æ­¤å‰æˆ‘çš„è®¤è¯†ä¹Ÿä»…ä»…åªæ˜¯åœç•™åœ¨è¿™é‡Œã€‚å¯è°æ›¾æƒ³ï¼ŒSQL SELECT è¯­å¥çœŸçš„æ˜¯åŠŸèƒ½å¼ºå¤§å•Šã€‚é€šè¿‡å„ç§å„æ ·çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæœ€ç»ˆèƒ½è¾¾åˆ°çš„ç›®çš„ï¼Œå¯ä»¥è¯´æŠŠæ•´ä¸ªæ•°æ®åº“çš„å†…å®¹æ‹–ä¸‹æ¥ä¹Ÿä¸ä¸ºè¿‡ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿæ˜¯é™å®šåœ¨æ²¡æœ‰å®ç°åˆ†åº“åˆ†è¡¨ï¼Œæ•°æ®åº“æŸ¥è¯¢è´¦å·çš„æƒé™è¿‡å¤§çš„å‰æä¸‹ã€‚</p><p>ä¸è¿‡ï¼Œè¿™ä¹Ÿå°±å¤Ÿäº†ã€‚åªæœ‰çœŸæ­£è®¤è¯†åˆ°é—®é¢˜çš„ä¸¥é‡æ€§ï¼Œæœ€ç»ˆæ‰ä¼šæƒ³ç€å»åšå‡ºä¸€äº›æ”¹å–„ã€‚</p><h2 id="SQL-æ³¨å…¥æŠ€æœ¯"><a href="#SQL-æ³¨å…¥æŠ€æœ¯" class="headerlink" title="SQL æ³¨å…¥æŠ€æœ¯"></a>SQL æ³¨å…¥æŠ€æœ¯</h2><h3 id="åŸºäºå¸ƒå°”çš„æ³¨å…¥"><a href="#åŸºäºå¸ƒå°”çš„æ³¨å…¥" class="headerlink" title="åŸºäºå¸ƒå°”çš„æ³¨å…¥"></a>åŸºäºå¸ƒå°”çš„æ³¨å…¥</h3><p>æœ€æ—©æ¥è§¦åˆ° SQL æ³¨å…¥é—®é¢˜ï¼Œè¿˜æ˜¯ä¸¤ä¸ªæœˆå‰ã€‚æ“ä½œçš„å†…å®¹ä¹Ÿç›¸å½“ç®€å•ï¼ŒçŒœè§£æŸè´¦å·çš„å¯†ç ã€‚</p><p>æŸæ¥å£æä¾›äº†æŸ¥è¯¢è´¦å·çš„åŠŸèƒ½ï¼Œåå°çš„æ‹¼æ¥ SQL å¯ä»¥ç®€å•ç†è§£æˆ <code>SELECT * FROM users WHERE username = &#39;${}&#39;</code> ã€‚å…¶ä¸­ <code>${}</code> å°±æ˜¯ç›´æ¥ä½¿ç”¨çš„æ¥å£è¯·æ±‚å‚æ•°ã€‚</p><p>è€Œæ¥å£çš„è¯·æ±‚ç»“æœä¼šæ ¹æ® SQL æŸ¥è¯¢çš„ç»“æœï¼Œæœ‰æˆ–æ²¡æœ‰è®°å½•å‘ˆç°ä¸¤ä¸ªä¸åŒçš„é¡µé¢ã€‚</p><p>è¿™ç®—æ˜¯æœ€ç®€å•å®¹æ˜“çš„ SQL æ³¨å…¥äº†ï¼Œä¹Ÿæ˜¯å‡­å€Ÿä¸ªäººèƒ½åŠ›ç›´æ¥èƒ½å¤Ÿæƒ³åˆ°æ³¨å…¥ç‚¹çš„é—®é¢˜äº†ã€‚</p><p>æœ€å…ˆåšçš„å°±æ˜¯çŒœè§£å­˜å‚¨å¯†ç å­—æ®µçš„å­—æ®µåç©¶ç«Ÿæ˜¯ä»€ä¹ˆ? å¾ˆå¥½ï¼Œç¬¦åˆå¸¸ç†çš„è®¾è®¡ï¼Œç›´æ¥å°±æ˜¯ <code>passwd</code> ã€‚</p><p>ä¸‹é¢å°±æ˜¯è‹¦åŠ›å·¥ä½œï¼Œåˆ©ç”¨ SQL LIKE æ“ä½œç¬¦ï¼Œé€ä¸€å»çŒœæ¯ä¸€ä½ã€‚<code>${}</code> çš„æ³¨å…¥å†…å®¹å°±ç±»ä¼¼ <code>admin&#39; AND passwd LIKE &#39;?%</code> è¿™é‡Œçš„é—®å·å°±æ˜¯é€ä¸€çŒœè§£çš„å†…å®¹(1-9a-zA-Z + ç‰¹æ®Šç¬¦å·)</p><p>è‡³äºä¸ºä»€ä¹ˆåˆ©ç”¨ LIKE æ“ä½œç¬¦ï¼Œå¾ˆæ˜ç¡®ï¼Œå‡å°‘çŒœè§£çš„æ¬¡æ•°ã€‚å¦åˆ™ï¼Œåœ¨å¯†ç æœªçŸ¥çš„æƒ…å†µä¸‹ï¼Œå³ä½¿å…­ä½å¯†ç ä¹Ÿæœ‰çŒœè§£ç™¾ä¸‡æ¬¡ã€‚è€Œ LIKE æ“ä½œç¬¦èƒ½å°†çŒœè§£æ¬¡æ•°é™ä¸ºçº¿æ€§ï¼Œ<code>å¯†ç é•¿åº¦ * å­—ç¬¦é›†æ•°</code> æ¬¡</p><p>è¿™é‡Œä»…ä»…ç”¨äº† <code>AND</code>ï¼Œä½†ç†Ÿæ‚‰äº†ä¸€ä¸ªï¼Œå…¶å®ƒå°±åŸºæœ¬ç±»ä¼¼äº†ã€‚</p><p>å¦‚æœç™»å½•ä¹Ÿèƒ½å¤Ÿæ³¨å…¥ï¼Œè®¤è¯ SQL ç±»ä¼¼ <code>SELECT * FROM users WHERE username = &#39;${}&#39; AND passwd = &#39;${}&#39;</code>ï¼Œé‚£ä¹ˆç›´æ¥åœ¨ç¬¬ä¸€ä¸ª <code>${}</code> å¤„æ³¨å…¥ <code>admin&#39; OR 1=1; --</code></p><h3 id="åŸºäºæ—¶é—´çš„æ³¨å…¥"><a href="#åŸºäºæ—¶é—´çš„æ³¨å…¥" class="headerlink" title="åŸºäºæ—¶é—´çš„æ³¨å…¥"></a>åŸºäºæ—¶é—´çš„æ³¨å…¥</h3><p>ç»å¤§å¤šæ•°æ—¶å€™ï¼Œæ³¨å…¥ç»å¯¹æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚ä¹Ÿè®¸æ³¨å…¥ç‚¹èƒŒåçš„æ‹¼æ¥ SQL å¹¶ä¸å¯¹è¿”å›å€¼äº§ç”Ÿå½±å“ã€‚ä¾‹å¦‚ä»…ä»…åªæ˜¯ä¸ºäº†ä» DB æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶æ‰“ä¸€æ¡æ—¥å¿—ï¼Œè¿”å›çš„æ°¸è¿œæ˜¯é™æ€æ—¥å¿—ï¼ˆå½“ç„¶ï¼Œæˆ‘çŸ¥é“è¿™ä¸ªä¾‹å­ä¸æ°å½“ï¼Œæ— å¥ˆç›®å‰åªèƒ½æƒ³åˆ°è¿™ä¸ªï¼‰ã€‚</p><p>æ—¢ç„¶æ‹¼æ¥ SQL æ€»æ˜¯å­˜åœ¨ï¼Œä½†æ²¡æ³•ç»™æˆ‘ä»¬ä¸€ä¸ªç›´è§‚çš„æ³¨å…¥æˆåŠŸ OR å¤±è´¥çš„æç¤ºã€‚é‚£ä¹ˆï¼Œæ—¶é—´å°±æˆäº†ä¸€ä¸ªæœ€å¥½çš„åˆ¤æ–­ã€‚æ¯•ç«Ÿæ˜¯é˜»å¡å¼çš„æ‰§è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ <code>SELECT * FROM users WHERE username = &#39;${}&#39;</code> ä¸ºä¾‹ï¼Œä½¿ç”¨ç±»ä¼¼ <code>admin&#39; AND IF(passwd LIKE &#39;5%&#39;, SLEEP(5), 1);--</code> çš„ PAYLOAD ï¼Œå½“æ»¡è¶³ <code>passwd</code> ä»¥ 5 å¼€å§‹æ—¶ï¼Œåˆ™ IF åˆ¤æ–­è¿›å…¥ <code>SLEEP(5)</code> ï¼Œæ ¹æ®ç½‘é¡µçš„å“åº”æ—¶é•¿å°±å¯ä»¥è¿›è¡Œç›¸åº”çš„åˆ¤æ–­ã€‚</p><h3 id="åŸºäºæŠ¥é”™çš„æ³¨å…¥"><a href="#åŸºäºæŠ¥é”™çš„æ³¨å…¥" class="headerlink" title="åŸºäºæŠ¥é”™çš„æ³¨å…¥"></a>åŸºäºæŠ¥é”™çš„æ³¨å…¥</h3><p>è¿™åº”è¯¥ä¹Ÿç®—ä¸€ç§æ¯”è¾ƒå®¹æ˜“è‡ªåŠ¨åŒ–çš„æ³¨å…¥æ–¹å¼äº†ã€‚å…¶å®åœ¨çŒœè§£å­˜å‚¨å¯†ç å­—æ®µçš„å­—æ®µåæ—¶ï¼Œå‰é¢ä¹Ÿæ˜¯è¿™æ ·ç”¨çš„ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; SELECT * FROM users WHERE password ='1';</span><br><span class="line">ERROR 1054 (42S22): Unknown column 'password' in 'where clause'</span><br></pre></td></tr></table></figure><p>å¦‚æœç¨‹åºä¸åšä»»ä½•å¤„ç†ï¼Œå¯¹ SQL é”™è¯¯ç›´æ¥æŠ›å‡ºï¼Œé‚£ä¹ˆï¼Œé€šè¿‡è¿™ä¸ªå°±èƒ½è·å¾—ç›¸å½“å¤šçš„ä¿¡æ¯ã€‚</p><p>ç”±äºè¿™éƒ¨åˆ†æ¥è§¦ä¸æ·±ï¼Œä»…ä»…ç»™å‡º sqlmap æçš„ PAYLOAD</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AND (SELECT [RANDNUM] FROM(SELECT COUNT(*),CONCAT(&apos;[DELIMITER_START]&apos;,([QUERY]),&apos;[DELIMITER_STOP]&apos;,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)</span><br></pre></td></tr></table></figure><p>å¾ˆæ ‡å‡†çš„ PAYLOADï¼Œè€Œä¸”å®Œå…¨å¯ä»¥ã€‚<code>INFORMATION_SCHEMA</code> åº“çš„è¡¨å¯¹æ‰€æœ‰ç”¨æˆ·éƒ½å¯æŸ¥ï¼Œå› æ­¤ä¸å­˜åœ¨æˆæƒçš„é—®é¢˜ã€‚è€Œä¸”è¡¨ä¸­æ•°æ®è‡³å°‘å¤§äºç­‰äº 3 æ¡ã€‚</p><p>è¿™ä¸ª PAYLOAD ä¸€å®šå¯¼è‡´æŠ¥é”™çš„ä¸»å› ï¼Œå°±æ˜¯å¯¹ <code>RAND()</code> ä¸ <code>GROUP BY</code> çš„é…åˆåº”ç”¨ã€‚</p><blockquote><p>Use of a column with RAND() values in an ORDER BY or GROUP BY clause may yield unexpected results because for either clause a RAND() expression can be evaluated multiple times for the same row, each time returning a different result. If the goal is to retrieve rows in random order, you can use a statement like this:</p></blockquote><p>è€ŒçœŸæ­£æƒ³è¦å¾—åˆ°çš„å†…å®¹ï¼Œé€šè¿‡ <code>CONCAT(&#39;[DELIMITER_START]&#39;,([QUERY]),&#39;[DELIMITER_STOP]&#39;,FLOOR(RAND(0)*2))x</code> å¾—åˆ°ï¼Œ<code>[QUERY]</code> å°±æ˜¯çœŸæ­£æƒ³è¦æ³¨å…¥çš„å®Œæ•´SQLä¸²ã€‚</p><p>è€Œè¿™é‡Œçš„ <code>DELIMITER_START</code> <code>DELIMITER_STOP</code> ä½œä¸ºç•Œå®šç¬¦ï¼Œå¸®åŠ©ç¨‹åºæå– <code>[QUERY]</code> å¾—åˆ°çš„ç»“æœã€‚å¦åˆ™ï¼Œç›´æ¥å¯¹è¯·æ±‚è¿”å›çš„ç»“æœè¿›è¡Œè¿‡æ»¤å¯çœŸæ˜¯å¤ªå›°éš¾äº†ã€‚</p><h3 id="è”åˆæŸ¥è¯¢æ³¨å…¥"><a href="#è”åˆæŸ¥è¯¢æ³¨å…¥" class="headerlink" title="è”åˆæŸ¥è¯¢æ³¨å…¥"></a>è”åˆæŸ¥è¯¢æ³¨å…¥</h3><p>è”åˆæŸ¥è¯¢ï¼Œåº”è¯¥ç®—æ˜¯æœ€é¡¾åæ€ä¹‰çš„æ³¨å…¥æ–¹å¼ã€‚ä½¿ç”¨ <code>UNION</code> åœ¨åŸ SQL å·²ç»é™å®šäº†æŸ¥è¯¢è¡¨çš„å‰æä¸‹ï¼Œè·å¾—æ•°æ®åº“å…¶å®ƒåº“è¡¨çš„ä¿¡æ¯ã€‚</p><p>LIKE: <code>1&#39; UNION SELECT * FROM users;--</code> è¿™æ ·çš„ PAYLOADã€‚</p><h3 id="å †æŸ¥è¯¢æ³¨å…¥"><a href="#å †æŸ¥è¯¢æ³¨å…¥" class="headerlink" title="å †æŸ¥è¯¢æ³¨å…¥"></a>å †æŸ¥è¯¢æ³¨å…¥</h3><p>æˆ‘æƒ³è¿™åº”è¯¥æ˜¯æœ€è®©äººæ‘¸ä¸ç€å¤´è„‘çš„å‘½åæ–¹å¼äº†ã€‚</p><p>å½¢è±¡åŒ–çš„ï¼Œæˆ‘ä»¬åˆ©ç”¨ PAYLOAD æ¥è¿›è¡Œè¯´æ˜ã€‚<code>1&#39;; INSERT INTO users (user, passwd) VALUES (&#39;aaa&#39;, &#39;aaa&#39;);--</code></p><p>çœ‹èµ·æ¥å’Œ UNION æŒºåƒçš„å“ˆï¼Œéƒ½æ˜¯è¡¥å……ä¸Šä¸€ä¸ª OR å¤šä¸ª SQL ã€‚å½“ç„¶ï¼Œä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦åˆ™ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·ä¸€ç§æŠ€æœ¯å‘¢ã€‚</p><p>æœ€å¤§çš„åŒºåˆ«ï¼Œå°±æ˜¯å †æŸ¥è¯¢æ³¨å…¥èƒ½å¤Ÿå®Œæˆ <code>UPDATE</code>, <code>INSERT</code>, <code>DELETE</code> ç­‰æ“ä½œï¼Œæ¯•ç«Ÿï¼ŒUNION è”åˆçš„åªèƒ½æ˜¯ä½œä¸ºæŸ¥è¯¢äº†ï¼ˆå¯èƒ½è¯´æ³•ä¸å¤ªæ°å½“ï¼Œä½†å§‘ä¸”è¿™æ ·å§ï¼‰</p><h3 id="å¦ç±»æ³¨å…¥"><a href="#å¦ç±»æ³¨å…¥" class="headerlink" title="å¦ç±»æ³¨å…¥"></a>å¦ç±»æ³¨å…¥</h3><p>ä¹‹å‰çš„å‡ ç§ï¼Œæˆ‘ä»¬éƒ½æ˜¯åˆ©ç”¨äº† <code>SELECT</code> å®Œæˆçš„æ³¨å…¥ï¼Œé‚£ä¹ˆå¯¹äº <code>INSERT</code>, <code>UPDATE</code> ä¹‹ç±»çš„è¯­å¥æ˜¯å¦æœ‰æ³¨å…¥çš„å¯èƒ½å‘¢ã€‚å½“ç„¶ä¹Ÿæ˜¯å­˜åœ¨å¯èƒ½çš„ã€‚</p><p>ä¸è¿‡ï¼Œç²¾åŠ›æœ‰é™ï¼Œè€Œä¸”ç›®å‰çœ‹æ¥ä¹Ÿä¸éœ€è¦åšåˆ°è¿™ä¸€æ­¥ã€‚æš‚æ—¶æŒ–ä¸ªå‘å§ã€‚ä¸å¡«</p><h2 id="SQLMAP"><a href="#SQLMAP" class="headerlink" title="SQLMAP"></a>SQLMAP</h2><p>ç®€å•çš„äº†è§£äº†å‡ ç§æ³¨å…¥åŸç†ä¹‹åï¼Œè¿˜æ˜¯è¦çœ‹çœ‹ SQL æ³¨å…¥ç¥å™¨çš„â€”â€”<code>SQLMAP</code></p><p>ä¹Ÿç®—æ˜¯å°è¯•äº†å¥½ä¹…æ‰çœŸæ­£äº†è§£å®ƒçš„å¼ºå¤§ä¹‹å¤„ã€‚æ­¤å¤„å¼ºçƒˆæ¨è DVWAï¼Œ<code>Damn Vulnerable Web Application</code>ï¼Œä¸€ä¸ªç”¨æ¥åˆæ³•æ”»å‡»çš„å·¥å…·ã€‚</p><p>éƒ¨ç½²æ–¹å¼ä¹Ÿæ˜¯å¼€ç®±å¯ç”¨ï¼Œåªè¦æœ‰ dockerï¼Œç›´æ¥ <code>docker run --rm -it -p 80:80 vulnerables/web-dvwa</code> å³å¯å®Œæˆéƒ¨ç½²ã€‚</p><p>å¯¹äºå°† DVWA å®‰å…¨çº§åˆ«è®¾ç½®ä¸º low æ—¶ï¼Œä»…ä»…åªéœ€è¦æ‰§è¡Œä¸‹åˆ—å‘½ä»¤å°±å¯ä»¥è·å–åˆ° DB é‡Œå‡ ä¹å®Œæ•´çš„ä¿¡æ¯ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sqlmap -u http://127.0.0.1/vulnerabilities/sqli/\?id\=1\&amp;Submit\=Submit\<span class="comment"># --cookie="PHPSESSID=jhton35qahj78l3unjea9k2lf7;security=low" -v 3 --banner</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæ¢ä¸€ä¸‹ç›¸å…³è·å–çš„å†…å®¹ï¼Œä¾‹å¦‚æŠŠ <code>--banner</code> æ¢æˆ <code>--dump</code> ï¼Œæˆ‘ä»¬å€Ÿæ­¤æ¥ç®€å•çœ‹çœ‹ SQL æ³¨å…¥æ¼æ´çš„å¯æ€•ä¹‹å¤„</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[10:41:39] [INFO] using default dictionary</span><br><span class="line"><span class="keyword">do</span> you want to use common password suffixes? (slow!) [y/N]</span><br><span class="line">[10:41:40] [INFO] starting dictionary-based cracking (md5_generic_passwd)</span><br><span class="line">[10:41:40] [INFO] starting 8 processes</span><br><span class="line">[10:41:42] [INFO] cracked password <span class="string">'abc123'</span> <span class="keyword">for</span> <span class="built_in">hash</span> <span class="string">'e99a18c428cb38d5f260853678922e03'</span></span><br><span class="line">[10:41:44] [INFO] cracked password <span class="string">'charley'</span> <span class="keyword">for</span> <span class="built_in">hash</span> <span class="string">'8d3533d75ae2c3966d7e0d4fcc69216b'</span></span><br><span class="line">[10:41:47] [INFO] cracked password <span class="string">'letmein'</span> <span class="keyword">for</span> <span class="built_in">hash</span> <span class="string">'0d107d09f5bbe40cade3de5c71e9e9b7'</span></span><br><span class="line">[10:41:49] [INFO] cracked password <span class="string">'password'</span> <span class="keyword">for</span> <span class="built_in">hash</span> <span class="string">'5f4dcc3b5aa765d61d8327deb882cf99'</span></span><br><span class="line">[10:41:53] [DEBUG] post-processing table dump</span><br><span class="line">Database: dvwa</span><br><span class="line">Table: users</span><br><span class="line">[5 entries]</span><br><span class="line">+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+</span><br><span class="line">| user_id | avatar                      | user    | password                                    | last_name | first_name | last_login          | failed_login |</span><br><span class="line">+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+</span><br><span class="line">| 1       | /hackable/users/admin.jpg   | admin   | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | admin     | admin      | 2018-12-15 00:42:31 | 0            |</span><br><span class="line">| 2       | /hackable/users/gordonb.jpg | gordonb | e99a18c428cb38d5f260853678922e03 (abc123)   | Brown     | Gordon     | 2018-12-15 00:42:31 | 0            |</span><br><span class="line">| 3       | /hackable/users/1337.jpg    | 1337    | 8d3533d75ae2c3966d7e0d4fcc69216b (charley)  | Me        | Hack       | 2018-12-15 00:42:31 | 0            |</span><br><span class="line">| 4       | /hackable/users/pablo.jpg   | pablo   | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein)  | Picasso   | Pablo      | 2018-12-15 00:42:31 | 0            |</span><br><span class="line">| 5       | /hackable/users/smithy.jpg  | smithy  | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | Smith     | Bob        | 2018-12-15 00:42:31 | 0            |</span><br><span class="line">+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±å¯ä»¥çœ‹åˆ° <code>dvwa.users</code> è¡¨çš„å…¨éƒ¨å†…å®¹ï¼Œç”šè‡³è¿ç®€å•å¯†ç éƒ½å¸®ä½ å®Œæˆäº†çˆ†ç ´ã€‚</p><p>æ›´å¤šå†…å®¹å¯ä»¥è‡ªè¡Œå°è¯•ï¼Œè¯´çœŸçš„ï¼Œè¿™ä¸ªå·¥å…·ç›¸å½“å¼ºå¤§ã€‚å¦‚æœä»…ä»…è¯´æˆ‘é’ˆå¯¹æŸå‹æ•°æ®åº“(ä¾‹å¦‚ MySQL)å®Œæˆè¯¸å¦‚åŸºäºæŠ¥é”™çš„æ³¨å…¥ï¼Œåœ¨ä¸è€ƒè™‘é²æ£’æ€§çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥åšåˆ°ã€‚ä½†æ˜¯æ”¯æŒè¶…10ä½™ç§æ•°æ®åº“ï¼Œä¸”è‡ªåŠ¨å®Œæˆæ³¨å…¥çš„å…¨è¿‡ç¨‹â€¦</p><h2 id="é¢„ç¼–è¯‘-SQL"><a href="#é¢„ç¼–è¯‘-SQL" class="headerlink" title="é¢„ç¼–è¯‘ SQL"></a>é¢„ç¼–è¯‘ SQL</h2><p>æäº†è¿™ä¹ˆå¤šï¼Œç©¶ç«Ÿ SQL æ³¨å…¥å°±ä¸èƒ½å¤Ÿé¢„é˜²å—? å½“ç„¶å¯ä»¥ï¼Œä¸ç„¶æ•´ä¸ªç½‘ç»œç¯å¢ƒä¸‹çš„WEBåº”ç”¨ä¸å¾—éƒ½å®Œè›‹äº†ã€‚æœ‰é‡œåº•æŠ½è–ªçš„å¤„ç†æ–¹å¼å—ï¼Œä¹Ÿæœ‰ã€‚</p><p>é¢„ç¼–è¯‘ SQL å°±æ˜¯ä¸€ä¸ªè¶…çº§ OK çš„è§£å†³æ–¹æ¡ˆã€‚åŒæ—¶åœ¨ä½¿ç”¨ä¸Šä¹Ÿèƒ½å¤Ÿæ˜æ˜¾æå‡ DB æŸ¥è¯¢æ•ˆç‡</p><p>æˆ‘ç›¸ä¿¡é¢„ç¼–è¯‘ SQL å¾ˆå¤šäººå†™è¿‡ï¼Œæ¯•ç«Ÿå€ŸåŠ©ä¾‹å¦‚ MyBatis æ¡†æ¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®ç° SQL é¢„ç¼–è¯‘è¯­å¥çš„ç¼–å†™ã€‚åŒæ—¶åœ¨æ±‚å­¦è¿‡ç¨‹ä¸­ä¼°è®¡ä¹Ÿéƒ½ç”¨è¿‡ Java åŸç”Ÿ JDBC çš„ <code>PreparedStatement</code> ã€‚</p><p>é‚£ä¹ˆï¼Œä¸ MySQL äº¤äº’æ—¶çš„é¢„ç¼–è¯‘ SQL æ˜¯æ€ä¹ˆæ ·åœ°å¡«ä¸Šäº†å ä½ç¬¦å‘¢? å…ˆæ¥çœ‹çœ‹å†è¯´</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; prepare &#123;name&#125; from 'SELECT * FROM users WHERE user=? AND passwd=?'; # è¿™é‡Œçš„ &#123;name&#125; å¯ä»¥è‡ªå®šä¹‰å‘½åï¼Œæ— éœ€ &#123;&#125;</span><br><span class="line"></span><br><span class="line">mysql&gt; set @a='admin', @b='password';     # å£°æ˜å˜é‡ï¼Œå¹¶èµ‹å€¼</span><br><span class="line"></span><br><span class="line">mysql&gt; execute &#123;name&#125; using @a, @b;     # æä¾›å˜é‡å¹¶æ‰§è¡Œé¢„ç¼–è¯‘ SQL</span><br></pre></td></tr></table></figure><p>æˆ‘æƒ³çœ‹åˆ°è¿™é‡Œåº”è¯¥å°±åº”è¯¥èƒ½å¤Ÿæ˜ç™½äº†å§ï¼ŒMySQL å¯¹äºé¢„ç¼–è¯‘ SQL çš„æ¯ä¸€ä¸ªå ä½ç¬¦ï¼Œéƒ½å·²ç»è®¤å®šäº†æ˜¯å•ä¸€çš„å…ƒç´ ï¼Œä¹Ÿå°±ä¸å¯èƒ½å­˜åœ¨å…è®¸æ‰“ç ´å·²æœ‰é¢„ç¼–è¯‘ç»“æœçš„å†…å®¹äº†ã€‚</p><p>å³ä½¿çœŸçš„æ³¨å…¥äº† <code>admin OR 1=1</code> ä¹‹ç±»çš„å†…å®¹ï¼Œä¹Ÿæ˜¯ä¼šè¢«è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æ›¿ä»£ <code>user</code> å­—æ®µæˆ– <code>passwd</code> å­—æ®µï¼Œæ ¹æœ¬ä¸å¯èƒ½é‡æ–°æ‹†è§£ã€‚</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¯´å®è¯æ­¤å‰å¯¹ SQL æ³¨å…¥çš„ç†è§£ä»…ä»…åªæ˜¯çš®æ¯›ã€‚å½“ç„¶ï¼Œç›®å‰ä¹Ÿæ˜¯ï¼Œåªæ˜¯æœ‰äº†ä¸€å®šç¨‹åº¦çš„ç†è§£ã€‚&lt;/p&gt;
&lt;p&gt;æœ€è¿‘å¥½åƒå·¥å…·ç”¨å¾—æœ‰äº›è¿‡å¤´äº†ï¼Œéœ€è¦åœä¸‹æ¥æ•´ç†ä¸‹å·¥å…·çš„å®ç°åŸç†ã€‚&lt;/p&gt;
&lt;p&gt;æ›´å¥½åœ°ç†è§£äº†å·¥å…·å®ç°ï¼Œæ‰èƒ½æ›´åŠ å¿ƒå®‰ç†å¾—åœ°ä½¿ç”¨å·¥å…·ã€‚æ¯•ç«Ÿç­‰åˆ«äººæ€¼çš„æ—¶å€™ï¼Œè¿˜èƒ½å¤Ÿæ¯”è¾ƒå®‰å¿ƒåœ°å›é“: â€œæˆ‘ç”¨ä¸ç”¨ç°æˆçš„å·¥å…·åªæ˜¯å–å†³äºæˆ‘æƒ³ä¸æƒ³è‡ªå·±å†å†™ä¸€å¥—â€&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œæ¯•ç«Ÿæˆç†Ÿçš„å·¥å…·æœ‰æ›´å¤šçš„ä¼˜åŒ–ï¼Œè¿™å°±ä¸æ˜¯çŸ­æ—¶é—´å†…æˆ‘æƒ³ä¸æƒ³è‡ªå·±å†™çš„é—®é¢˜äº†ï¼Œå“ˆå“ˆã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Security" scheme="https://DorMOUSE-None.github.io/tags/Security/"/>
    
      <category term="SQL" scheme="https://DorMOUSE-None.github.io/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>æ­£åˆ™è¡¨è¾¾å¼æŒ‡æ•°çˆ†ç‚¸</title>
    <link href="https://DorMOUSE-None.github.io/2018-11-16-regex-exponential-explosion/"/>
    <id>https://DorMOUSE-None.github.io/2018-11-16-regex-exponential-explosion/</id>
    <published>2018-11-15T16:00:00.000Z</published>
    <updated>2018-11-16T07:22:56.617Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æ˜¨å¤©æ¥è§¦åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜, å…¬å¸æµ‹è¯•ç¯å¢ƒä¸€å°æœºå™¨ CPU è·‘åˆ°äº† 400%ï¼Œå¯¼è‡´è¯¥æœºå™¨ä¸Šçš„æ‰€æœ‰æœåŠ¡éƒ½æŒ‚æ‰äº†ã€‚</p><p>æœ€åæŸ¥åˆ°çš„åŸå› ç«Ÿç„¶æ˜¯æ­£åˆ™è¡¨è¾¾å¼æ‰€å¼•èµ·çš„ï¼Œå¤§å¤§å‡ºä¹æ„æ–™å•Šã€‚è™½ç„¶æ—©å°±çŸ¥é“æ­£åˆ™æ•ˆç‡å¾ˆå·®ï¼Œä½†ç»å¯¹æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´æ•´ä¸ªæœºå™¨ä¸ŠæœåŠ¡å´©æºƒçš„æƒ…å†µã€‚</p><p>å…ˆç®€å•å±•ç¤ºä¸‹é—®é¢˜æ­£åˆ™:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String regex = <span class="string">"(\\w+,?)+"</span>;</span><br><span class="line">String val = <span class="string">"abcdefghijklmno,abcdefghijklmno+"</span>;</span><br><span class="line">System.out.println(val.matches(regex));</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„æ‰§è¡Œæ—¶é—´æ˜¯ 17s å·¦å³ã€‚</p><p>ç›¸åï¼Œå¦‚æœæ”¹æˆ <code>String val = &quot;abcdefghijklmno,abcdefghijklmno&quot;</code> ï¼Œå®é™…æ‰§è¡Œæ—¶é—´ 1ms å·¦å³ã€‚</p><p>å“ˆå“ˆï¼Œå®Œå…¨ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ç»“æœã€‚</p><p>æœ€åï¼Œå½“ç„¶æ˜¯è¦æ‰¾åŸå› äº†:&lt; å½“ç„¶ï¼Œæœ‰å…¶å®ƒé‡è¦çš„äº‹åœ¨è€½æï¼Œæ²¡æ—¶é—´å»çœ‹ Java Regex æºç ã€‚ä¸è¿‡ï¼Œä»æ­£åˆ™æœ¬èº«ä¸‹æ‰‹åè€Œæ˜¯ä¸ªå¥½äº‹æƒ…ã€‚æ¯•ç«Ÿå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å¯¹æ­£åˆ™çš„æ”¯æŒã€‚è€ŒåŒæ ·çš„ï¼Œéƒ½å­˜åœ¨ç€è¿™æ ·çš„é—®é¢˜ã€‚é‚£å°±å¯ä»¥å¤§èƒ†çŒœæƒ³å…¶å®æ˜¯å’Œè¯­è¨€æœ¬èº«æ— å…³ï¼Œè€Œåœ¨äºæ­£åˆ™è§„èŒƒæœ¬èº«äº†ã€‚</p><p>å…ˆç»™ä¸ªç»“æœï¼Œç½ªé­ç¥¸é¦–å°±æ˜¯<code>æŒ‡æ•°çˆ†ç‚¸</code></p><a id="more"></a><h2 id="è¿½æœ¬æº¯æº"><a href="#è¿½æœ¬æº¯æº" class="headerlink" title="è¿½æœ¬æº¯æº"></a>è¿½æœ¬æº¯æº</h2><p>è¿™é‡Œå¹¶ä¸å‡†å¤‡ä¸€æ­¥ä¸€æ­¥åœ°é˜è¿°æ­£åˆ™çš„ï¼Œå¦‚æœçœŸçš„æ˜¯é›¶åŸºç¡€çš„è¯ï¼Œæ¨èå…ˆçœ‹ä¸€ä¸‹ <a href="https://github.com/ziishaned/learn-regex/blob/master/README-cn.md" target="_blank" rel="noopener">å­¦ä¹ æ­£åˆ™</a></p><p>å°±äº‹è®ºäº‹ï¼Œè¿˜æ˜¯ä»¥ <code>regex ::= (\w+,?)+</code> ä½œä¸ºç¤ºä¾‹æ¥è¿›è¡Œè¯´æ˜ã€‚</p><p>é¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯ <code>val.matches(regex)</code> æ‰€è¦è¿›è¡Œçš„å·¥ä½œæ˜¯åˆ¤æ–­ <code>val</code> å…¨ä¸²æ˜¯å¦ç¬¦åˆ <code>regex</code> æ­£åˆ™æ¨¡å¼ã€‚è€Œæ­£åˆ™æ‰€è¦åšçš„å·¥ä½œå°±æ˜¯å°è¯•æ‰€æœ‰çš„åŒ¹é…å¯èƒ½æ€§(å½“ç„¶ï¼Œå¯¹äº <code>val</code> è¿™ä¸ªä¸²æ¥è¯´ï¼Œæœ€ååŒ¹é…åˆ° <code>abcd..,abcd..mno+</code> çš„ <code>+</code> çš„æ—¶å€™ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œå› ä¸º <code>regex</code> å¹¶ä¸åŒ¹é… <code>+</code>)</p><p>ç®€å•æ‰©å±•ä¸€ä¸‹å¯¹<code>å°è¯•æ‰€æœ‰åŒ¹é…å¯èƒ½æ€§</code>è¿™å¥è¯çš„æè¿°:</p><p>æˆ‘ä»¬ä»¥ <code>()</code> å¯¹åº” <code>regex</code> ä¸­çš„ä¸€ç»„ <code>(\w+,?)</code> ï¼Œè€Œæœ€åä¸€ä¸ª <code>+</code> è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª(å³å…è®¸å­˜åœ¨å¤šä¸ª<code>()</code>)</p><p>å¯¹ <code>val</code> ä¸²çš„åŒ¹é…å¯èƒ½æ€§æœ‰</p><ul><li><p>(abcdefghijklmno,)(abcdefghijklmno)+</p></li><li><p>(abcd)(efghijklmno,)(abcdefghijklmno)+</p></li><li><p>(abcdefghijklmno,)(abcdef)(ghijklmno)+</p></li><li><p>(abc)(defghijklmno,)(abcde)(fg)(hijklmno)+</p></li><li><p>â€¦</p></li></ul><p>æœ‰ç›¸å½“å¤šçš„åŒ¹é…å¯èƒ½ï¼Œä¸å†ä¸€ä¸€è¯¦è¿°(äº‹å®ä¸Šï¼Œå…‰é ä¸ªäººæ‰‹å·¥æ ¹æœ¬åˆ—ä¸¾ä¸å®Œã€‚</p><p>é‚£ä¹ˆåˆ°åº•ä¼šæœ‰å¤šå°‘ä¸­åŒ¹é…å¯èƒ½æ€§å‘¢?</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥ç®€å•è®¡ç®—ä¸€ä¸‹:</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠ <code>(\w+,?)+</code> è¿™ä¸ªæ­£åˆ™æ‰©å±•ä¸€ä¸‹ï¼Œå®ƒä¸ä¸‹åˆ—è¿™äº›ä¸²éƒ½æ˜¯ç­‰ä»·çš„ <code>(\w+,|\w+)+</code>, <code>(\w+,)?(\w+)?(\w+,?)+</code>, <code>(\w+,)?(\w+)?(\w+)?(\w+,?)+</code> â€¦</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡³å°‘æŠŠ <code>abcdefghijklmno,abcdefghijklmno+</code> æŒ‰ç…§åŒ¹é…ä¸²åˆ’åˆ†å‡º1ç»„ï¼Œ2ç»„ï¼Œ3ç»„â€¦30ç»„(å› ä¸ºæ¯ä¸ªç»„è‡³å°‘éœ€è¦ä¸€ä¸ª<code>\w</code> )</p><p>ä¸è¿‡è¿™ä¸ªæŒ‰ç…§1ç»„ï¼Œ2ç»„â€¦å»è®¡ç®—å¯èƒ½æ€§çš„è¯å®åœ¨æ˜¯è´¹åŠ›ä¸è®¨å¥½çš„äº‹æƒ…ã€‚ç”¨ç»„åˆæ•°å­¦æ¥è€ƒè™‘è¿™ä¸ªé—®é¢˜</p><p>é¦–å…ˆï¼Œæ•´ä¸ª <code>abcdefghijklmno,abcdefghijklmno+</code> çš„å¼€å§‹åº”è¯¥æœ‰ä¸€ä¸ªå·¦æ‹¬å· <code>(</code>ï¼Œå³ <code>(abcdefghijklmno,abcdefghijklmno+</code></p><p>å…¶æ¬¡ï¼Œåˆ° <code>,</code> ä¸ºæ­¢è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªå³å·¦æ‹¬å· <code>)(</code>ï¼Œå³ <code>(abcdefghijklmno,)(abcdefghijklmno+</code></p><p>å†æ¬¡ï¼Œç”±äºåˆ° <code>o+</code> ä¸ºæ­¢ä¸€å®šåŒ¹é…å¤±è´¥ï¼Œå› æ­¤ï¼Œ<code>+</code> ä¹‹å‰åº”è¯¥æœ‰ä¸€ä¸ª <code>)</code>, å³ <code>(abcdefghijklmno,)(abcdefghijklmno)+</code></p><p>è‡³äºå…¶ä»–å­—ç¬¦é—´çš„ç©ºéš™ï¼Œé™¤äº† <code>o,</code> ä¹‹é—´ä¸èƒ½å­˜åœ¨å³å·¦æ‹¬å· <code>)(</code> ï¼Œå…¶ä»–å­—ç¬¦é—´éƒ½å¯ä»¥éšæ„æ’å…¥ <code>)(</code> (è‡³äºä¸ºä»€ä¹ˆæ˜¯å³å·¦æ‹¬å·ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªç»„çš„ç»“æŸä¸æ–°çš„ç»„çš„å¼€å§‹)</p><p>é‚£ä¹ˆæ€»å…±æœ‰å¤šå°‘ç§å¯èƒ½? </p><ul><li><p>æ’å…¥é›¶ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^0$ = 1 ç§å¯è¡Œæ–¹æ¡ˆ</p></li><li><p>æ’å…¥ä¸€ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^1$ = 28 ç§å¯è¡Œæ–¹æ¡ˆ (æ€»å…± 28 ä¸ªå¯ç”¨å­—ç¬¦é—´éš™)</p></li><li><p>æ’å…¥ä¸¤ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^2$ ç§å¯è¡Œæ–¹æ¡ˆ</p></li><li><p>â€¦</p></li><li><p>æ’å…¥28ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^{28}$ ç§å¯è¡Œæ–¹æ¡ˆ</p></li></ul><p>ç´¯åŠ çš„ç»“æœä¸º $C_{28}^1 + C_{28}^2 + C_{28}^3 + â€¦ + C_{28}^{28} = 2^{28}$</p><p>å¯æƒ³è€ŒçŸ¥ä¸ºä»€ä¹ˆä¼šèŠ± 17s äº†å§ã€‚æ¯•ç«Ÿè¾¾åˆ°äº† 2500 ä¸‡ä»¥ä¸Šçš„è®¡ç®—é‡çº§ï¼ŒåŠ ä¸Š regex æœ¬èº«å°±æ˜¯åæ…¢çš„ã€‚</p><p>è‡³äºä¸ºä»€ä¹ˆæŠŠ <code>abcdefghijklmno,abcdefghijklmno+</code> ä¸²çš„ <code>+</code> å»æ‰å°±å˜å¿«äº†ï¼Ÿç†ç”±ä¹Ÿå¾ˆç®€å•ï¼Œ<code>matches(regex)</code> åœ¨æ­£åˆ™ä¸²ä¸åŸä¸²åŒ¹é…ä¸Šä¹‹åå°±ä¼šå¿«é€Ÿç»“æŸï¼Œå› ä¸ºç»“æœåªéœ€è¦å‘ŠçŸ¥æŸæ¬¡åŒ¹é…æˆåŠŸäº†å³å¯ã€‚è€Œå¤±è´¥çš„åŒ¹é…ä¼šä¸æ–­åœ°å°è¯•æ‰€æœ‰çš„å¯èƒ½æ€§ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>è‡³äºè§£å†³æ–¹æ¡ˆï¼Œä»ä¸Šé¢çš„åŸå› å°±å¯ä»¥çœ‹åˆ°ï¼Œæ‹’ç»åœ¨è´ªå©ªç»„æ¨¡å¼ä¸‹(<code>(...)+</code>) çš„ç»„å†…å¤šæ¨¡å¼åŒ¹é…å¯èƒ½ã€‚å³ <code>(a+a+)+</code> æ˜¯ä¸èƒ½è¢«å…è®¸çš„ï¼Œè€Œ <code>(a+b+)+</code> æ˜¯å¯é çš„ã€‚</p><p>å†™å¾—ä»“ä¿ƒï¼Œå¦‚æœ‰æ ¹æºæ€§é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.regular-expressions.info/catastrophic.html" target="_blank" rel="noopener">Catastrophic Backtracking(ç¾éš¾æ€§å›æº¯)</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;æ˜¨å¤©æ¥è§¦åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜, å…¬å¸æµ‹è¯•ç¯å¢ƒä¸€å°æœºå™¨ CPU è·‘åˆ°äº† 400%ï¼Œå¯¼è‡´è¯¥æœºå™¨ä¸Šçš„æ‰€æœ‰æœåŠ¡éƒ½æŒ‚æ‰äº†ã€‚&lt;/p&gt;
&lt;p&gt;æœ€åæŸ¥åˆ°çš„åŸå› ç«Ÿç„¶æ˜¯æ­£åˆ™è¡¨è¾¾å¼æ‰€å¼•èµ·çš„ï¼Œå¤§å¤§å‡ºä¹æ„æ–™å•Šã€‚è™½ç„¶æ—©å°±çŸ¥é“æ­£åˆ™æ•ˆç‡å¾ˆå·®ï¼Œä½†ç»å¯¹æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´æ•´ä¸ªæœºå™¨ä¸ŠæœåŠ¡å´©æºƒçš„æƒ…å†µã€‚&lt;/p&gt;
&lt;p&gt;å…ˆç®€å•å±•ç¤ºä¸‹é—®é¢˜æ­£åˆ™:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;String regex = &lt;span class=&quot;string&quot;&gt;&quot;(\\w+,?)+&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;String val = &lt;span class=&quot;string&quot;&gt;&quot;abcdefghijklmno,abcdefghijklmno+&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;System.out.println(val.matches(regex));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æœ€ç»ˆçš„æ‰§è¡Œæ—¶é—´æ˜¯ 17s å·¦å³ã€‚&lt;/p&gt;
&lt;p&gt;ç›¸åï¼Œå¦‚æœæ”¹æˆ &lt;code&gt;String val = &amp;quot;abcdefghijklmno,abcdefghijklmno&amp;quot;&lt;/code&gt; ï¼Œå®é™…æ‰§è¡Œæ—¶é—´ 1ms å·¦å³ã€‚&lt;/p&gt;
&lt;p&gt;å“ˆå“ˆï¼Œå®Œå…¨ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ç»“æœã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œå½“ç„¶æ˜¯è¦æ‰¾åŸå› äº†:&amp;lt; å½“ç„¶ï¼Œæœ‰å…¶å®ƒé‡è¦çš„äº‹åœ¨è€½æï¼Œæ²¡æ—¶é—´å»çœ‹ Java Regex æºç ã€‚ä¸è¿‡ï¼Œä»æ­£åˆ™æœ¬èº«ä¸‹æ‰‹åè€Œæ˜¯ä¸ªå¥½äº‹æƒ…ã€‚æ¯•ç«Ÿå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å¯¹æ­£åˆ™çš„æ”¯æŒã€‚è€ŒåŒæ ·çš„ï¼Œéƒ½å­˜åœ¨ç€è¿™æ ·çš„é—®é¢˜ã€‚é‚£å°±å¯ä»¥å¤§èƒ†çŒœæƒ³å…¶å®æ˜¯å’Œè¯­è¨€æœ¬èº«æ— å…³ï¼Œè€Œåœ¨äºæ­£åˆ™è§„èŒƒæœ¬èº«äº†ã€‚&lt;/p&gt;
&lt;p&gt;å…ˆç»™ä¸ªç»“æœï¼Œç½ªé­ç¥¸é¦–å°±æ˜¯&lt;code&gt;æŒ‡æ•°çˆ†ç‚¸&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="regular expression" scheme="https://DorMOUSE-None.github.io/tags/regular-expression/"/>
    
      <category term="æŒ‡æ•°çˆ†ç‚¸" scheme="https://DorMOUSE-None.github.io/tags/%E6%8C%87%E6%95%B0%E7%88%86%E7%82%B8/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (6) - read &amp; write</title>
    <link href="https://DorMOUSE-None.github.io/2018-11-11-understand-Kernel-6/"/>
    <id>https://DorMOUSE-None.github.io/2018-11-11-understand-Kernel-6/</id>
    <published>2018-11-10T16:00:00.000Z</published>
    <updated>2018-11-11T02:42:26.367Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://dormouse-none.github.io/2018-10-14-understand-Kernel-5/">å‰ä¸€ç¯‡</a>å·²ç»æè¿°å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº†å®è§‚æ€§çš„æè¿°ï¼Œè¿™ä¸€ç¯‡ï¼Œå°†ä»¥ç‰¹å®šçš„æ–‡ä»¶è¯»å†™æ“ä½œä¸ºç¤ºä¾‹ï¼Œä¸²è”å¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œã€‚</p><p>é¦–å…ˆå…ˆæ¥çœ‹çœ‹å¹³å°ç›¸å…³çš„æ–‡ä»¶è¯»å†™æ“ä½œçš„ C ä»£ç æ˜¯æ€æ ·ä¸€ä¸ªè°ƒç”¨æ–¹å¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">panic</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s (errno=%d)\n"</span>, strerror(errno), errno);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* æ‰“å¼€æ–‡ä»¶ frw.txt (ä»¥å¯è¯»å†™ | è‹¥ä¸å­˜åœ¨åˆ™æ–°å»ºçš„å½¢å¼) */</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/root/frw.txt"</span>, O_RDWR | O_CREAT);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> panic();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘æ–‡ä»¶å†™å…¥ Hello World! å…±è®¡ 12 ä¸ªå­—ç¬¦ */</span></span><br><span class="line">    <span class="keyword">ssize_t</span> wsize = write(fd, <span class="string">"Hello World!"</span>, <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">if</span> (wsize == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> panic();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é‡å®šä½æ–‡ä»¶è¯»å†™æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="keyword">off_t</span> off = lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="keyword">if</span> (off == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> panic();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(wsize);</span><br><span class="line">    <span class="comment">/* è¯»å–æ–‡ä»¶å†…å®¹ */</span></span><br><span class="line">    <span class="keyword">ssize_t</span> rsize = read(fd, buf, wsize);</span><br><span class="line">    <span class="keyword">if</span> (rsize == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> panic();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, buf);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line">    <span class="keyword">int</span> stat = close(fd);</span><br><span class="line">    <span class="keyword">if</span> (stat == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> panic();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–"><a href="#é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–" class="headerlink" title="é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–"></a>é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–</h2><p>ä¸Šä¸€ç¯‡å·²ç»æè¿°è¿‡äº†ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ã€åŒ…æ‹¬æ•°æ®ï¼Œéƒ½æ˜¯æŒä¹…åŒ–åœ°å­˜å‚¨åœ¨å­˜å‚¨è®¾å¤‡ä¸­çš„ã€‚</p><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥ä¹Ÿéšçº¦çš„äº†è§£å¦ä¸€ä¸ªäº‹å®ï¼Œæ–‡ä»¶è¯»å†™æ“ä½œå¹¶ä¸ä¼šç›´æ¥æ“ä½œå­˜å‚¨è®¾å¤‡ä¸Šçš„æ•°æ®ï¼Œè€Œæ˜¯å…ˆç»è¿‡ä¸€ä¸ªç§°ä¹‹ä¸ºé«˜é€Ÿç¼“å†²çš„å†…å­˜åŒºåŸŸã€‚</p><p>é‚£ä¹ˆï¼Œé«˜é€Ÿç¼“å†²æ˜¯ä»€ä¹ˆ? ç©¶ç«Ÿæ‰¿æ‹…ä»€ä¹ˆå·¥ä½œ? å…ˆæ¥çœ‹çœ‹å®ƒçš„åˆå§‹åŒ–æµç¨‹å§ã€‚</p><p>é¦–å…ˆå›åˆ° <code>main.c</code> (å†…æ ¸ä»£ç çš„ä¸»å‡½æ•°)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> ROOT_DEV = ORIG_ROOT_DEV;</span><br><span class="line"> drive_info = DRIVE_INFO;</span><br><span class="line">memory_end = (<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + (EXT_MEM_K&lt;&lt;<span class="number">10</span>);</span><br><span class="line">memory_end &amp;= <span class="number">0xfffff000</span>;</span><br><span class="line"><span class="keyword">if</span> (memory_end &gt; <span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">memory_end = <span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"><span class="keyword">if</span> (memory_end &gt; <span class="number">12</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">buffer_memory_end = <span class="number">4</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (memory_end &gt; <span class="number">6</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">buffer_memory_end = <span class="number">2</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">buffer_memory_end = <span class="number">1</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">main_memory_start = buffer_memory_end;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RAMDISK</span></span><br><span class="line">main_memory_start += rd_init(main_memory_start, RAMDISK*<span class="number">1024</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">mem_init(main_memory_start,memory_end);</span><br><span class="line">trap_init();</span><br><span class="line">blk_dev_init();</span><br><span class="line">chr_dev_init();</span><br><span class="line">tty_init();</span><br><span class="line">time_init();</span><br><span class="line">sched_init();                       <span class="comment">// ç¬¬å››ç¯‡å·²ç»è®²è¿‡ï¼Œè´Ÿè´£ä»»åŠ¡è°ƒåº¦æ¨¡å—çš„åˆå§‹åŒ–</span></span><br><span class="line">buffer_init(buffer_memory_end);     <span class="comment">// æœ¬ç¯‡çš„èµ·å§‹ï¼Œè´Ÿè´£ç¼“å†²åŒºçš„åˆå§‹åŒ–</span></span><br><span class="line">hd_init();</span><br><span class="line">floppy_init();</span><br><span class="line">sti();</span><br><span class="line">move_to_user_mode();</span><br><span class="line"><span class="keyword">if</span> (!fork()) &#123;<span class="comment">/* we count on this going ok */</span></span><br><span class="line">init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(;;) pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>buffer_init(buffer_memory_end);</code> ç”¨æ¥åˆå§‹åŒ–ç¼“å†²åŒºã€‚æ­¤å¤„æœ‰å‡ ä¸ªåŸå› :</p><ol><li><p>CPU è¯»å†™æ“ä½œå¦‚æœç›´æ¥æ“ä½œå¤–å­˜ï¼Œé€Ÿåº¦ä¸Šæ˜¯ä¸€ä¸ªæå¤§çš„è€ƒéªŒã€‚æ¯•ç«Ÿå†…å­˜å·²ç»è¾ƒä¹‹ CPU é€Ÿåº¦æ…¢ï¼Œå¤–å­˜çš„è¯»å†™é€Ÿåº¦å°±æ›´æ…¢äº†ã€‚</p></li><li><p>è§£è€¦ï¼Œå…¶å®è¯»å†™æ“ä½œå¹¶ä¸ä»…ä»…å‘ç”Ÿåœ¨å¤–å­˜(å—å­˜å‚¨è®¾å¤‡)ï¼ŒåŒæ ·çš„ï¼Œå­—ç¬¦è®¾å¤‡ç­‰ç­‰ä¹Ÿéƒ½ä¼šéœ€è¦è¯»å†™æ“ä½œï¼Œå¢åŠ ä¸­é—´å±‚å¯ä»¥å°è£…å˜åŒ–ã€‚</p></li><li><p>æ›´å¤šï¼Œä¸ªäººäº†è§£æœ‰é™â€¦</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> &#123;</span></span><br><span class="line"> <span class="keyword">char</span> * b_data;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> b_blocknr;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> b_dev;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> b_uptodate;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> b_dirt;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> b_count;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> b_lock;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * <span class="title">b_wait</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">b_prev</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">b_next</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">b_prev_free</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">b_next_free</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* from fs/buffer.c */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buffer_init</span><span class="params">(<span class="keyword">long</span> buffer_end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">h</span> = <span class="title">start_buffer</span>;</span></span><br><span class="line"><span class="keyword">void</span> * b;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (buffer_end == <span class="number">1</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">b = (<span class="keyword">void</span> *) (<span class="number">640</span>*<span class="number">1024</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">b = (<span class="keyword">void</span> *) buffer_end;</span><br><span class="line"><span class="keyword">while</span> ( (b -= BLOCK_SIZE) &gt;= ((<span class="keyword">void</span> *) (h+<span class="number">1</span>)) ) &#123;</span><br><span class="line">h-&gt;b_dev = <span class="number">0</span>;</span><br><span class="line">h-&gt;b_dirt = <span class="number">0</span>;</span><br><span class="line">h-&gt;b_count = <span class="number">0</span>;</span><br><span class="line">h-&gt;b_lock = <span class="number">0</span>;</span><br><span class="line">h-&gt;b_uptodate = <span class="number">0</span>;</span><br><span class="line">h-&gt;b_wait = <span class="literal">NULL</span>;</span><br><span class="line">h-&gt;b_next = <span class="literal">NULL</span>;</span><br><span class="line">h-&gt;b_prev = <span class="literal">NULL</span>;</span><br><span class="line">h-&gt;b_data = (<span class="keyword">char</span> *) b;</span><br><span class="line">h-&gt;b_prev_free = h<span class="number">-1</span>;</span><br><span class="line">h-&gt;b_next_free = h+<span class="number">1</span>;</span><br><span class="line">h++;</span><br><span class="line">NR_BUFFERS++;</span><br><span class="line">        <span class="comment">/* è·³è¿‡ 640K ~ 1M çš„æ˜¾å­˜å’Œ BIOS RAM éƒ¨åˆ† */</span></span><br><span class="line"><span class="keyword">if</span> (b == (<span class="keyword">void</span> *) <span class="number">0x100000</span>)</span><br><span class="line">b = (<span class="keyword">void</span> *) <span class="number">0xA0000</span>;</span><br><span class="line">&#125;</span><br><span class="line">h--;</span><br><span class="line">free_list = start_buffer;</span><br><span class="line">free_list-&gt;b_prev_free = h;</span><br><span class="line">h-&gt;b_next_free = free_list;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;NR_HASH;i++)</span><br><span class="line">hash_table[i]=<span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼“å†²å—çš„æ‰€æœ‰å…³é”®ä¿¡æ¯éƒ½ç”± <code>buffer_head</code> æ•°æ®ç»“æ„è¿›è¡Œè®°å½•, è‡³äºæœ‰å¤šå°‘ä¸ª <code>buffer_head</code>? åªèƒ½è¯´èƒ½åˆ’åˆ†å¤šå°‘å°±åˆ’åˆ†å¤šå°‘ã€‚</p><p>æ¯”è¾ƒç›´è§‚çš„ç»“æ„ä¿¡æ¯å¦‚ä¸‹</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwy2iag1exj31kw0k1dgb.jpg" alt=""></p><p>åœ¨ <code>main.c</code> ä¸­å·²ç»æå‰ç¡®è®¤äº†å†…æ ¸ç¨‹åºå ç”¨å†…å­˜çš„å¤§å°ï¼Œç¼“å†²åŒºå¤§å°ä»¥åŠä¸»å†…å­˜å¤§å°ã€‚</p><p>åœ¨é«˜é€Ÿç¼“å†²åŒºçš„å¼€å§‹ä½ç½®ï¼Œéƒ½ç”¨æ¥å­˜å‚¨ <code>buffer_head</code> çš„ä¿¡æ¯ï¼Œä¸æ¯ä¸ªç¼“å†²å—(ä»ç¼“å†²åŒºç»“æŸä½ç½®å¼€å§‹åˆ†é…)ä¸€ä¸€å¯¹åº”ï¼Œç›´åˆ°ä¸­é—´æŸä¸ªä½ç½®ä¸è¶³ä»¥åˆ†é…ç¼“å†²å—ä¸ºæ­¢ã€‚</p><p>å¦å¤–çš„ä¿¡æ¯ï¼Œå°±æ˜¯å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code>hash_table</code> æ•°æ®ç»“æ„äº†ã€‚</p><p>åº”è¯¥éƒ½èƒ½å¤Ÿæƒ³è±¡ï¼Œæ¯ä¸ªç¼“å­˜å—ä¸å¤–å­˜ä¸­çš„æ•°æ®å—ç›¸å¯¹åº”ï¼Œé€šè¿‡è®¾å¤‡å· + æ•°æ®å—å·è¿›è¡Œå”¯ä¸€å®šä½ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•å¿«é€ŸæŸ¥æ‰¾éœ€è¦æ“ä½œçš„æ•°æ®å—æ˜¯å¦å·²ç»å­˜åœ¨ä¸é«˜é€Ÿç¼“å­˜ä¸­äº†å‘¢? æ˜¾ç„¶ç›´æ¥éå†æŸ¥æ‰¾æ˜¯ä¸å¤ªå¯é çš„åŠæ³•ã€‚é‡‡ç”¨å¼€æ”¾åœ°å€æ³•çš„å“ˆå¸Œè¡¨èƒ½å¤ŸååŠ©å¿«é€Ÿå®šä½ç¼“å†²å—ã€‚</p><h2 id="æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ"><a href="#æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ"></a>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</h2><p>æ—¢ç„¶é«˜é€Ÿç¼“å†²åŒºéƒ½å‡†å¤‡å°±ç»ªäº†ï¼Œé‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å·²ç»æŒ‚è½½äº†å‘¢? å¾ˆé—æ†¾ï¼ŒçŸ¥é“ <code>main()</code> è°ƒç”¨ <code>init()</code> å‡½æ•°ä¹‹å‰ï¼Œæ–‡ä»¶ç³»ç»Ÿä¾ç„¶æ²¡æœ‰æŒ‚è½½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCPU ä»ç„¶åªèƒ½é€šè¿‡åŸºæœ¬è¾“å…¥è¾“å‡ºå¯¹å­˜å‚¨è®¾å¤‡è¿›è¡Œç›¸å½“åˆçº§çš„ IO æ“ä½œã€‚</p><p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™æ‰èƒ½å»æŒ‚è½½æ ¹ç›®å½•å‘¢?</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from init/main.c */</span></span><br><span class="line"><span class="comment">/* ç”± main() è§¦å‘ */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> pid,i;</span><br><span class="line">    <span class="comment">/* è¿™æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ç¯äº†ï¼Œå¼€å§‹æŒ‚è½½çš„èµ·å§‹åŠ¨ä½œ */</span></span><br><span class="line">setup((<span class="keyword">void</span> *) &amp;drive_info);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setup</code> å‡½æ•°åšäº†ä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå†…åµŒæ±‡ç¼–ï¼Œä¸»è¦åšçš„å°±æ˜¯è§¦å‘ç³»ç»Ÿè°ƒç”¨ <code>int 0x80</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__inline__ int setup(void * BIOS) &#123; </span><br><span class="line">    long __res; </span><br><span class="line">    __asm__ volatile (</span><br><span class="line">            &quot;int $0x80&quot; </span><br><span class="line">            : &quot;=a&quot; (__res) </span><br><span class="line">            : &quot;0&quot; (0),&quot;b&quot; ((long)(BIOS))</span><br><span class="line">    ); </span><br><span class="line">    if (__res &gt;= 0) </span><br><span class="line">        return (int) __res; </span><br><span class="line">    errno = -__res; </span><br><span class="line">    return -1; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­çœ‹åˆ°ç»™å‡ºçš„ <code>EAX = 0</code>, æŸ¥è¡¨(è¡¨åœ¨ <code>include/linux/sys.h</code> é‡Œ) å¯ä»¥çŸ¥é“è§¦å‘çš„æ˜¯ <code>sys_setup</code> å‡½æ•°(å‡½æ•°ä½äº <code>kernel/blk_drv/hd.c</code>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This may be used only once, enforced by 'static int callable' */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_setup</span><span class="params">(<span class="keyword">void</span> * BIOS)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> callable = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> i,drive;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> cmos_disks;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">partition</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">bh</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* setup åªå…è®¸è¢«è°ƒç”¨ä¸€æ¬¡ */</span></span><br><span class="line"><span class="keyword">if</span> (!callable)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">callable = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* å¯ä»¥å¼ºåˆ¶åœ¨æºç ä¸­æŒ‡å®šç¡¬ç›˜å‚æ•°, æ‰€ä»¥åŠ äº†å®å®šä¹‰ä½œåˆ¤æ–­*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HD_TYPE</span></span><br><span class="line"><span class="keyword">for</span> (drive=<span class="number">0</span> ; drive&lt;<span class="number">2</span> ; drive++) &#123;</span><br><span class="line">hd_info[drive].cyl = *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *) BIOS;</span><br><span class="line">hd_info[drive].head = *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) (<span class="number">2</span>+BIOS);</span><br><span class="line">hd_info[drive].wpcom = *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *) (<span class="number">5</span>+BIOS);</span><br><span class="line">hd_info[drive].ctl = *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) (<span class="number">8</span>+BIOS);</span><br><span class="line">hd_info[drive].lzone = *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *) (<span class="number">12</span>+BIOS);</span><br><span class="line">hd_info[drive].sect = *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) (<span class="number">14</span>+BIOS);</span><br><span class="line">BIOS += <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (hd_info[<span class="number">1</span>].cyl)</span><br><span class="line">NR_HD=<span class="number">2</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">NR_HD=<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;NR_HD ; i++) &#123;</span><br><span class="line">hd[i*<span class="number">5</span>].start_sect = <span class="number">0</span>;</span><br><span class="line">hd[i*<span class="number">5</span>].nr_sects = hd_info[i].head*</span><br><span class="line">hd_info[i].sect*hd_info[i].cyl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">We querry CMOS about hard disks : it could be that</span></span><br><span class="line"><span class="comment">we have a SCSI/ESDI/etc controller that is BIOS</span></span><br><span class="line"><span class="comment">compatable with ST-506, and thus showing up in our</span></span><br><span class="line"><span class="comment">BIOS table, but not register compatable, and therefore</span></span><br><span class="line"><span class="comment">not present in CMOS.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Furthurmore, we will assume that our ST-506 drives</span></span><br><span class="line"><span class="comment">&lt;if any&gt; are the primary drives in the system, and</span></span><br><span class="line"><span class="comment">the ones reflected as drive 1 or 2.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The first drive is stored in the high nibble of CMOS</span></span><br><span class="line"><span class="comment">byte 0x12, the second in the low nibble.  This will be</span></span><br><span class="line"><span class="comment">either a 4 bit drive type or 0xf indicating use byte 0x19</span></span><br><span class="line"><span class="comment">for an 8 bit type, drive 1, 0x1a for drive 2 in CMOS.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Needless to say, a non-zero value means we have</span></span><br><span class="line"><span class="comment">an AT controller hard disk for that drive.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((cmos_disks = CMOS_READ(<span class="number">0x12</span>)) &amp; <span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">if</span> (cmos_disks &amp; <span class="number">0x0f</span>)</span><br><span class="line">NR_HD = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">NR_HD = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">NR_HD = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (i = NR_HD ; i &lt; <span class="number">2</span> ; i++) &#123;</span><br><span class="line">hd[i*<span class="number">5</span>].start_sect = <span class="number">0</span>;</span><br><span class="line">hd[i*<span class="number">5</span>].nr_sects = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* æ›´è¿›ä¸€æ­¥è®¾ç½®æ¯ä¸ªç›˜çš„å‚æ•° */</span></span><br><span class="line"><span class="keyword">for</span> (drive=<span class="number">0</span> ; drive&lt;NR_HD ; drive++) &#123;</span><br><span class="line">        <span class="comment">/* 0x300 å’Œ 0x305 åˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªç¡¬ç›˜ */</span></span><br><span class="line">        <span class="comment">/* è¯»å–æ¯ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€å—æ•°æ® (1024B) */</span></span><br><span class="line"><span class="keyword">if</span> (!(bh = bread(<span class="number">0x300</span> + drive*<span class="number">5</span>,<span class="number">0</span>))) &#123;</span><br><span class="line">printk(<span class="string">"Unable to read partition table of drive %d\n\r"</span>,</span><br><span class="line">drive);</span><br><span class="line">panic(<span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">/* åˆ¤æ–­ç¡¬ç›˜æœ‰æ•ˆæ€§ */</span></span><br><span class="line"><span class="keyword">if</span> (bh-&gt;b_data[<span class="number">510</span>] != <span class="number">0x55</span> || (<span class="keyword">unsigned</span> <span class="keyword">char</span>)</span><br><span class="line">    bh-&gt;b_data[<span class="number">511</span>] != <span class="number">0xAA</span>) &#123;</span><br><span class="line">printk(<span class="string">"Bad partition table on drive %d\n\r"</span>,drive);</span><br><span class="line">panic(<span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">/* è¯»å–åˆ†åŒºè¡¨ (ä½äº å¼•å¯¼æ‰‡åŒºç¬¬ 446 å­—èŠ‚å¼€å§‹å¤„ */</span></span><br><span class="line">p = <span class="number">0x1BE</span> + (<span class="keyword">void</span> *)bh-&gt;b_data;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">1</span>;i&lt;<span class="number">5</span>;i++,p++) &#123;</span><br><span class="line">hd[i+<span class="number">5</span>*drive].start_sect = p-&gt;start_sect;</span><br><span class="line">hd[i+<span class="number">5</span>*drive].nr_sects = p-&gt;nr_sects;</span><br><span class="line">&#125;</span><br><span class="line">brelse(bh);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (NR_HD)</span><br><span class="line">printk(<span class="string">"Partition table%s ok.\n\r"</span>,(NR_HD&gt;<span class="number">1</span>)?<span class="string">"s"</span>:<span class="string">""</span>);</span><br><span class="line">rd_load();              <span class="comment">/* å°è¯•åˆ›å»ºå¹¶åŠ è½½è™šæ‹Ÿç›˜ */</span></span><br><span class="line">mount_root();           <span class="comment">/* mount æ ¹æ–‡ä»¶ç³»ç»Ÿ */</span></span><br><span class="line"><span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»ˆäºåˆ°äº†æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™äº†</p><p><code>mount_root</code> ç”¨æ¥åšåˆçº§çš„åˆå§‹åŒ–å·¥ä½œã€‚åŒæ—¶ï¼Œä¸Šä¸€èŠ‚å·²ç»æè¿°è¿‡äº†ï¼Œå­˜å‚¨è®¾å¤‡çš„è¶…çº§å—æ˜¯ç”¨äº†è®°å½•æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ€é‡è¦çš„ç»“æ„ã€‚</p><p>é‚£ä¹ˆé€šè¿‡å°†è¶…çº§å—çš„ä¿¡æ¯è¯»å–åˆ°å†…å­˜ï¼Œä¹Ÿå°±å¯ä»¥å°†å†…å­˜ä¸å¤–å­˜çš„æ–‡ä»¶ç³»ç»Ÿç›¸äº’è”ç³»èµ·æ¥äº†ã€‚</p><p>ä¸‹é¢è¿™æ®µä»£ç æœ€é‡è¦çš„å†…å®¹å°±æ˜¯ <code>read_super()</code> å‡½æ•°äº† .</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mount_root</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i,<span class="built_in">free</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> * <span class="title">p</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">mi</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="number">32</span> != <span class="keyword">sizeof</span> (struct d_inode))</span><br><span class="line">panic(<span class="string">"bad i-node size"</span>);</span><br><span class="line">    <span class="comment">/* å…ˆåˆå§‹åŒ–æ–‡ä»¶è¡¨ï¼Œè¯¥ç‰ˆæœ¬æ“ä½œç³»ç»Ÿé™åˆ¶æœ€å¤§åŒæ—¶æ‰“å¼€ NR_FILE(64ä¸ª) æ–‡ä»¶ */</span></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;NR_FILE;i++)</span><br><span class="line">        <span class="comment">/* f_count = 0 è¡¨æ˜æ²¡æœ‰è¢«å¼•ç”¨ */</span></span><br><span class="line">file_table[i].f_count=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* å¦‚æœå¼•å¯¼ç›˜æ˜¯è½¯ç›˜çš„è¯ï¼Œæç¤ºæ’å…¥æ ¹æ–‡ä»¶ç³»ç»Ÿç›˜ */</span></span><br><span class="line"><span class="keyword">if</span> (MAJOR(ROOT_DEV) == <span class="number">2</span>) &#123;</span><br><span class="line">printk(<span class="string">"Insert root floppy and press ENTER"</span>);</span><br><span class="line">wait_for_keypress();</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–å†…å­˜è¶…çº§å—æ•°æ®ç»“æ„ (æ€»å…± 8 ä¸ª) */</span></span><br><span class="line"><span class="keyword">for</span>(p = &amp;super_block[<span class="number">0</span>] ; p &lt; &amp;super_block[NR_SUPER] ; p++) &#123;</span><br><span class="line">p-&gt;s_dev = <span class="number">0</span>;</span><br><span class="line">p-&gt;s_lock = <span class="number">0</span>;</span><br><span class="line">p-&gt;s_wait = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* Hint: è¯»å–è¶…çº§å—çš„ä¿¡æ¯ï¼ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿé‡è¦çš„éƒ¨åˆ†(ä»£ç è¯·å¾€ä¸‹ç¿») */</span></span><br><span class="line"><span class="keyword">if</span> (!(p=read_super(ROOT_DEV)))</span><br><span class="line">panic(<span class="string">"Unable to mount root"</span>);</span><br><span class="line">    <span class="comment">/* è¯»å–æ–‡ä»¶ç³»ç»Ÿçš„ 1 å·ièŠ‚ç‚¹ (å³è¯¥è®¾å¤‡ä¸Šæ–‡ä»¶ç³»ç»Ÿçš„æ ¹èŠ‚ç‚¹) */</span></span><br><span class="line"><span class="keyword">if</span> (!(mi=iget(ROOT_DEV,ROOT_INO)))</span><br><span class="line">panic(<span class="string">"Unable to read root i-node"</span>);</span><br><span class="line">mi-&gt;i_count += <span class="number">3</span> ;<span class="comment">/* NOTE! it is logically used 4 times, not 1 */</span></span><br><span class="line">p-&gt;s_isup = p-&gt;s_imount = mi;</span><br><span class="line">    <span class="comment">/* åº”è¯¥è¿˜è®°å¾—å§ï¼Œcurrent æŒ‡çš„æ˜¯å½“å‰çš„ä»»åŠ¡(ä»»åŠ¡1)ï¼Œä»¥åæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šç”±ä»»åŠ¡1æˆ–ä»»åŠ¡1çš„å­ä»»åŠ¡è¿›è¡Œæ´¾ç”Ÿï¼Œä¹Ÿå°±æ„å‘³ç€ current-&gt;root ä¼šä¸€ç›´å¤åˆ¶è¿‡å»</span></span><br><span class="line"><span class="comment">     * åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œåº”è¯¥è®¤ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠè¢«æŒ‚è½½äº†ã€‚æ˜¯ä¸æ˜¯è·Ÿè¢«è€äº†ä¸€æ ·?</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">current-&gt;pwd = mi;</span><br><span class="line">current-&gt;root = mi;</span><br><span class="line"><span class="built_in">free</span>=<span class="number">0</span>;</span><br><span class="line">i=p-&gt;s_nzones;</span><br><span class="line">    <span class="comment">/* ç»Ÿè®¡è¿˜æœ‰å¤šå°‘ç©ºé—²æ•°æ®å—ä»¥åŠå¤šå°‘å¯ç”¨ièŠ‚ç‚¹ (é™„ä¸Šä¸€å¼ å¯åŠ¨è¿‡ç¨‹ä¸­æ‰“å°çš„ä¿¡æ¯) */</span></span><br><span class="line"><span class="keyword">while</span> (-- i &gt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> (!set_bit(i&amp;<span class="number">8191</span>,p-&gt;s_zmap[i&gt;&gt;<span class="number">13</span>]-&gt;b_data))</span><br><span class="line"><span class="built_in">free</span>++;</span><br><span class="line">printk(<span class="string">"%d/%d free blocks\n\r"</span>,<span class="built_in">free</span>,p-&gt;s_nzones);</span><br><span class="line"><span class="built_in">free</span>=<span class="number">0</span>;</span><br><span class="line">i=p-&gt;s_ninodes+<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (-- i &gt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> (!set_bit(i&amp;<span class="number">8191</span>,p-&gt;s_imap[i&gt;&gt;<span class="number">13</span>]-&gt;b_data))</span><br><span class="line"><span class="built_in">free</span>++;</span><br><span class="line">printk(<span class="string">"%d/%d free inodes\n\r"</span>,<span class="built_in">free</span>,p-&gt;s_ninodes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwz8kvvgbpj30l006i3yb.jpg" alt=""></p><p>é‡è¦è¦çš„éƒ¨åˆ†ï¼Œ<code>read_super(int dev)</code>ï¼Œç”¨äºè¯»å–è¶…çº§å—çš„æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct super_block * <span class="title">read_super</span><span class="params">(<span class="keyword">int</span> dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> * <span class="title">s</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">bh</span>;</span></span><br><span class="line"><span class="keyword">int</span> i,block;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!dev)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">check_disk_change(dev);</span><br><span class="line">    <span class="comment">/* å¦‚æœè¯¥è¶…çº§å—å·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨ (å’Œè¿™é‡ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æµç¨‹æ— å…³) */</span></span><br><span class="line"><span class="keyword">if</span> (s = get_super(dev))</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">    <span class="comment">/* è®¾å¤‡è¶…çº§å—ä¸åœ¨å†…å­˜ä¸­ï¼Œå°±å…ˆæ‰¾ä¸€ä¸ªç©ºé—²çš„å†…å­˜è¶…çº§å— (æ€»å…±ç»´æŠ¤ 8 ä¸ªè¶…çº§å—æ•°æ®ç»“æ„) */</span></span><br><span class="line"><span class="keyword">for</span> (s = <span class="number">0</span>+super_block ;; s++) &#123;</span><br><span class="line"><span class="keyword">if</span> (s &gt;= NR_SUPER+super_block)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (!s-&gt;s_dev)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">s-&gt;s_dev = dev;</span><br><span class="line">s-&gt;s_isup = <span class="literal">NULL</span>;</span><br><span class="line">s-&gt;s_imount = <span class="literal">NULL</span>;</span><br><span class="line">s-&gt;s_time = <span class="number">0</span>;</span><br><span class="line">s-&gt;s_rd_only = <span class="number">0</span>;</span><br><span class="line">s-&gt;s_dirt = <span class="number">0</span>;</span><br><span class="line">lock_super(s);</span><br><span class="line">    <span class="comment">/* é€šè¿‡ block read è¯»å–è®¾å¤‡ç¬¬ä¸€ä¸ªç‰©ç†å— (æ¯ä¸ªç‰©ç†å— 1024 B) */</span></span><br><span class="line"><span class="keyword">if</span> (!(bh = bread(dev,<span class="number">1</span>))) &#123;</span><br><span class="line">s-&gt;s_dev=<span class="number">0</span>;</span><br><span class="line">free_super(s);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* å¤åˆ¶ä¸€ä»½è¶…çº§å—çš„æ•°æ® */</span></span><br><span class="line">*((struct d_super_block *) s) =</span><br><span class="line">*((struct d_super_block *) bh-&gt;b_data);</span><br><span class="line">    <span class="comment">/* é‡Šæ”¾ç¼“å†²åŒºçš„æ•°æ® */</span></span><br><span class="line">brelse(bh);</span><br><span class="line">    <span class="comment">/* éªŒè¯é­”æ•°, è¯¥ç‰ˆæœ¬æ“ä½œç³»ç»Ÿåªæ”¯æŒ 1.0 ç‰ˆ Minix æ–‡ä»¶ç³»ç»Ÿï¼Œé­”æ•° 0x137F */</span></span><br><span class="line"><span class="keyword">if</span> (s-&gt;s_magic != SUPER_MAGIC) &#123;</span><br><span class="line">s-&gt;s_dev = <span class="number">0</span>;</span><br><span class="line">free_super(s);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* å…ˆæ¸…ç©ºå†…å­˜ä¸­çš„æ•°æ® */</span></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;I_MAP_SLOTS;i++)</span><br><span class="line">s-&gt;s_imap[i] = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;Z_MAP_SLOTS;i++)</span><br><span class="line">s-&gt;s_zmap[i] = <span class="literal">NULL</span>;</span><br><span class="line">block=<span class="number">2</span>;</span><br><span class="line">    <span class="comment">/* è¯»å– i èŠ‚ç‚¹ä½å›¾å— */</span></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span> ; i &lt; s-&gt;s_imap_blocks ; i++)</span><br><span class="line"><span class="keyword">if</span> (s-&gt;s_imap[i]=bread(dev,block))</span><br><span class="line">block++;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">/* è¯»å–æ•°æ®å—ä½å›¾ */</span></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span> ; i &lt; s-&gt;s_zmap_blocks ; i++)</span><br><span class="line"><span class="keyword">if</span> (s-&gt;s_zmap[i]=bread(dev,block))</span><br><span class="line">block++;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (block != <span class="number">2</span>+s-&gt;s_imap_blocks+s-&gt;s_zmap_blocks) &#123;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;I_MAP_SLOTS;i++)</span><br><span class="line">brelse(s-&gt;s_imap[i]);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;Z_MAP_SLOTS;i++)</span><br><span class="line">brelse(s-&gt;s_zmap[i]);</span><br><span class="line">s-&gt;s_dev=<span class="number">0</span>;</span><br><span class="line">free_super(s);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">s-&gt;s_imap[<span class="number">0</span>]-&gt;b_data[<span class="number">0</span>] |= <span class="number">1</span>;</span><br><span class="line">s-&gt;s_zmap[<span class="number">0</span>]-&gt;b_data[<span class="number">0</span>] |= <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* ä¸å‰é¢çš„ wait_on_super() å¯¹åº”(è§£å¼€lockæ ‡å¿—) */</span></span><br><span class="line">free_super(s);</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯è§‰å¾—ä¹Ÿæ²¡ä»€ä¹ˆï¼Œå°±è¿™æ ·æ ¹æ–‡ä»¶ç³»ç»Ÿå·²ç»æŒ‚è½½äº†? æ¯«æ— å®æ„Ÿæ˜¯å§ã€‚</p><h2 id="Extra-æ™®é€šæŒ‚è½½"><a href="#Extra-æ™®é€šæŒ‚è½½" class="headerlink" title="Extra: æ™®é€šæŒ‚è½½"></a>Extra: æ™®é€šæŒ‚è½½</h2><p>æ—¢ç„¶è®²è¿‡äº†æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€‚é‚£å°±é¡ºå¸¦ç€è®²è®²æ™®é€šæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å§ã€‚</p><p>ç›¸ä¿¡ä»å‘½ä»¤ä¸Šæ¥è®²åº”è¯¥æ¯”è¾ƒç®€å•ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰å§ã€‚<code>mount disk.img /mnt</code> ä¹Ÿç®—æ˜¯æŒ‚è½½åˆ° /mnt ä¸‹äº†</p><p>ä½†æ˜¯ï¼Œç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ç°çš„å‘¢?</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_mount</span><span class="params">(<span class="keyword">char</span> * dev_name, <span class="keyword">char</span> * dir_name, <span class="keyword">int</span> rw_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">dev_i</span>, * <span class="title">dir_i</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> * <span class="title">sb</span>;</span></span><br><span class="line"><span class="keyword">int</span> dev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * çœç•¥å¤§éƒ¨åˆ†åˆ¤æ–­é€»è¾‘, ä¸»è¦å°±æ˜¯:</span></span><br><span class="line"><span class="comment">     * 1. åˆ¤æ–­ dev_name æ‰€å±çš„è®¾å¤‡å·ï¼Œè¯»å–è¯¥è®¾å¤‡ä¸Šçš„è¶…çº§å—</span></span><br><span class="line"><span class="comment">     * 2. è¯»å– dir_name (éœ€è¦æŒ‚è½½åˆ°çš„ä½ç½®)ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸è¢«æŒ‚è½½(æ¯”å¦‚æ ¹èŠ‚ç‚¹ä¸å…è®¸æŒ‚å…¶å®ƒè®¾å¤‡)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®è¶…çº§å—çš„ mount æ ‡å¿— */</span></span><br><span class="line">sb-&gt;s_imount=dir_i;</span><br><span class="line">    <span class="comment">/* è®¾ç½®è¯¥ i èŠ‚ç‚¹çš„ mount æ ‡å¿— */</span></span><br><span class="line">dir_i-&gt;i_mount=<span class="number">1</span>;</span><br><span class="line">dir_i-&gt;i_dirt=<span class="number">1</span>;<span class="comment">/* NOTE! we don't iput(dir_i) */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;<span class="comment">/* we do that in umount */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶è¯»å†™"><a href="#æ–‡ä»¶è¯»å†™" class="headerlink" title="æ–‡ä»¶è¯»å†™"></a>æ–‡ä»¶è¯»å†™</h2><p>å‰é¢è®²äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºåˆ°äº†æœ€å…³å¿ƒçš„éƒ¨åˆ†äº†ã€‚å½“ç„¶ï¼Œä¹Ÿå¹¶ä¸æ˜¯è¯´å‰é¢çš„å†…å®¹ä¸é‡è¦ï¼Œäº‹å®ä¸Šï¼Œç›¸å½“é‡è¦ï¼Œåªæ˜¯éƒ½éšè—åœ¨äº†å†…æ ¸å¼•å¯¼çš„è¿‡ç¨‹ä¸­ï¼Œä¸”è°ƒç”¨é¢‘åº¦ä½ï¼Œæ‰å¯¼è‡´äº†æ²¡æœ‰å­˜åœ¨æ„Ÿã€‚ä½†æ˜¯è¿™æ°æ°æ‰æ˜¯æ”¯æŒæ–‡ä»¶è¯»å†™çš„åŸºçŸ³ã€‚</p><p>ä¸å¤šè¯´åºŸè¯ï¼Œä¸‹é¢å°±è¦å¼€å§‹æ–‡ä»¶è¯»å†™çš„å†…å®¹ã€‚</p><h3 id="æ‰“å¼€æ–‡ä»¶"><a href="#æ‰“å¼€æ–‡ä»¶" class="headerlink" title="æ‰“å¼€æ–‡ä»¶"></a>æ‰“å¼€æ–‡ä»¶</h3><p>æ‰“å¼€æ–‡ä»¶çš„å‡½æ•°åŸå‹æ˜¯ <code>int open(const char * filename, int flag, ...);</code></p><p>å½“ç„¶ï¼Œæ­¤ç±»ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆçš„å®ç°éƒ½æ˜¯ <code>int 0x80</code> , æ˜ç¡®ä¸€ä¸ªè°ƒç”¨å·ï¼Œç„¶åå°±é™·å…¥å†…æ ¸æ€äº†ã€‚</p><p>å†…æ ¸æ€ä¸‹è°ƒç”¨çš„å‡½æ•°æ˜¯: <code>int sys_open(const char * filename,int flag,int mode)</code> </p><p>æ¥çœ‹çœ‹ç»†èŠ‚:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * filename,<span class="keyword">int</span> flag,<span class="keyword">int</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">inode</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">f</span>;</span></span><br><span class="line"><span class="keyword">int</span> i,fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * current æ˜¯ç”±å†…æ ¸æ•°æ®æ®µç»´æŠ¤çš„å½“å‰ä»»åŠ¡çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">     * umask æ˜¯æŒ‡å½“å‰ä»»åŠ¡åœ¨æ–°å»ºæ–‡ä»¶æ—¶çš„é»˜è®¤æ©ç </span></span><br><span class="line"><span class="comment">     *   ä¾‹å¦‚ Linux é»˜è®¤æ˜¯ 022, å³æ–°å»ºæ–‡ä»¶è¢«ç¦æ­¢äº†ç»„ç”¨æˆ·ä¸å…¶å®ƒç”¨æˆ·çš„å†™æƒé™</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œæ˜¯å…ˆç¡®å®šæ–°å»ºæ–‡ä»¶çš„æƒé™</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">mode &amp;= <span class="number">0777</span> &amp; ~current-&gt;umask;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯ä¸ªæ–‡ä»¶å•ç‹¬ç»´æŠ¤ä¸€å¥—ï¼Œä»¥æ•°å­—æ ‡è®°</span></span><br><span class="line"><span class="comment">     * æ‰¾ä¸€ä¸ªç©ºé—²çš„æ–‡ä»¶æè¿°ç¬¦é¡¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">for</span>(fd=<span class="number">0</span> ; fd&lt;NR_OPEN ; fd++)</span><br><span class="line"><span class="keyword">if</span> (!current-&gt;filp[fd])</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (fd&gt;=NR_OPEN)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * é¡¾åæ€ä¹‰ï¼Œè®¾ç½®åœ¨è°ƒç”¨ exec() å‡½æ•°æ—¶ä¸»åŠ¨å…³é—­çš„æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * exec() é€šå¸¸ä¸ fork() è”ç”¨ï¼Œfork() è´Ÿè´£å¤åˆ¶ä¸€ä¸ªä»»åŠ¡ï¼Œè€Œ exec è´Ÿè´£æ›¿æ¢æ–°ä»»åŠ¡çš„ä»£ç å’Œæ•°æ®æ®µ(ä»è€Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ä»»åŠ¡)</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œçš„å£°æ˜å³æ˜¯å¤ä½ fd ä½ç½®çš„æ ‡å¿—ï¼Œå…è®¸å­ä»»åŠ¡ä¹ŸæŒæœ‰ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦é¡¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">current-&gt;close_on_exec &amp;= ~(<span class="number">1</span>&lt;&lt;fd);</span><br><span class="line">f=<span class="number">0</span>+file_table;</span><br><span class="line">    <span class="comment">/* åœ¨æ–‡ä»¶è¡¨ä¸­æ‰¾ä¸€é¡¹ç©ºé—²çš„ */</span></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;NR_FILE ; i++,f++)</span><br><span class="line"><span class="keyword">if</span> (!f-&gt;f_count) <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (i&gt;=NR_FILE)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">/* å½“å‰ä»»åŠ¡çš„æ–‡ä»¶æè¿°ç¬¦é¡¹æŒ‡å‘æ–‡ä»¶è¡¨é¡¹, åŒæ—¶æ–‡ä»¶è¡¨é¡¹çš„å¼•ç”¨è®¡æ•°+1*/</span></span><br><span class="line">(current-&gt;filp[fd]=f)-&gt;f_count++;</span><br><span class="line">    <span class="comment">/* è°ƒç”¨ open_namei æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™é‡Šæ”¾åˆšæ‰å ç”¨çš„æ–‡ä»¶ç»“æ„ï¼Œå¹¶è¿”å›é”™è¯¯ç  */</span></span><br><span class="line"><span class="keyword">if</span> ((i=open_namei(filename,flag,mode,&amp;inode))&lt;<span class="number">0</span>) &#123;</span><br><span class="line">current-&gt;filp[fd]=<span class="literal">NULL</span>;</span><br><span class="line">f-&gt;f_count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * å¯¹ä¸åŒçš„æ–‡ä»¶è¿›è¡Œä¸åŒçš„ç‰¹æ®Šå¤„ç†, æ¯•ç«Ÿæœ‰ "ä¸€åˆ‡çš†æ–‡ä»¶" çš„å£å·å˜›</span></span><br><span class="line"><span class="comment">     * è¯¸å¦‚å­—ç¬¦è®¾å¤‡ç­‰ä¹Ÿéƒ½æ˜¯æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">/* ttys are somewhat special (ttyxx major==4, tty major==5) */</span></span><br><span class="line"><span class="keyword">if</span> (S_ISCHR(inode-&gt;i_mode))</span><br><span class="line"><span class="keyword">if</span> (MAJOR(inode-&gt;i_zone[<span class="number">0</span>])==<span class="number">4</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (current-&gt;leader &amp;&amp; current-&gt;tty&lt;<span class="number">0</span>) &#123;</span><br><span class="line">current-&gt;tty = MINOR(inode-&gt;i_zone[<span class="number">0</span>]);</span><br><span class="line">tty_table[current-&gt;tty].pgrp = current-&gt;pgrp;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (MAJOR(inode-&gt;i_zone[<span class="number">0</span>])==<span class="number">5</span>)</span><br><span class="line"><span class="keyword">if</span> (current-&gt;tty&lt;<span class="number">0</span>) &#123;</span><br><span class="line">iput(inode);</span><br><span class="line">current-&gt;filp[fd]=<span class="literal">NULL</span>;</span><br><span class="line">f-&gt;f_count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Likewise with block-devices: check for floppy_change */</span></span><br><span class="line"><span class="keyword">if</span> (S_ISBLK(inode-&gt;i_mode))</span><br><span class="line">check_disk_change(inode-&gt;i_zone[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–å†…å­˜æ–‡ä»¶ç»“æ„çš„å„ä¸ªå‚æ•° */</span></span><br><span class="line">f-&gt;f_mode = inode-&gt;i_mode;</span><br><span class="line">f-&gt;f_flags = flag;</span><br><span class="line">f-&gt;f_count = <span class="number">1</span>;</span><br><span class="line">f-&gt;f_inode = inode;</span><br><span class="line">f-&gt;f_pos = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> (fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ•´ä¸ªæ‰“å¼€æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†çœŸæ­£å»æ–‡ä»¶ç³»ç»ŸæŸ¥æ‰¾æ–‡ä»¶çš„æ—¶å€™ç”¨åˆ°äº†æ–‡ä»¶åï¼Œå…¶å®ƒæ—¶å€™ï¼Œéƒ½å°†æ˜¯ä»¥æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œäº¤äº’çš„ã€‚</p><p>å†çœ‹çœ‹æ›´ç»†èŠ‚çš„æ–¹é¢ï¼Œæ¯•ç«Ÿå°±ç›®å‰æ¥è¯´ï¼Œæˆ‘ä»¬è·³è¿‡äº†æœ€é‡è¦çš„ä¸€ç¯ <code>open_namei</code> ï¼Œä»è€Œçœ‹ä¼¼æ•´ä¸ªæµç¨‹éƒ½ç®€å•äº†å¾ˆå¤šå¾ˆå¤šã€‚</p><p>é€šå¸¸æˆ‘ä»¬åœ¨ç¼–ç è¿‡ç¨‹ä¸­éƒ½æ˜¯é€šè¿‡ç»å¯¹åœ°å€/ç›¸å¯¹åœ°å€æ¥å”¯ä¸€å®šä½ä¸€ä¸ªæ–‡ä»¶ã€‚å› æ­¤ï¼Œå°±å¿…ç„¶å­˜åœ¨é€çº§å¯»æ‰¾æ–‡ä»¶çš„è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct m_inode * <span class="title">get_dir</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * pathname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> c;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * thisname;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">inode</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">bh</span>;</span></span><br><span class="line"><span class="keyword">int</span> namelen,inr,idev;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dir_entry</span> * <span class="title">de</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ¤å®šå½“å‰ä»»åŠ¡è®¾å®šçš„æ ¹èŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ */</span></span><br><span class="line"><span class="keyword">if</span> (!current-&gt;root || !current-&gt;root-&gt;i_count)</span><br><span class="line">panic(<span class="string">"No root inode"</span>);</span><br><span class="line">    <span class="comment">/* åˆ¤å®šå½“å‰è·¯å¾„ièŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ */</span></span><br><span class="line"><span class="keyword">if</span> (!current-&gt;pwd || !current-&gt;pwd-&gt;i_count)</span><br><span class="line">panic(<span class="string">"No cwd inode"</span>);</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * è¿™é‡Œçš„ get_fs_byte(..) æ˜¯å®å®šä¹‰ï¼Œfs æŒ‡çš„æ˜¯ FS æ®µå¯„å­˜å™¨</span></span><br><span class="line"><span class="comment">     * Linux å†…æ ¸å°† DS, ES ç”¨äºå†…æ ¸æ•°æ®æ®µ, ç”¨ FS æŒ‡å‘å±€éƒ¨æè¿°ç¬¦è¡¨çš„å½“å‰ä»»åŠ¡æ•°æ®æ®µ</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œå¯ä»¥ç®€å•ç†è§£æˆå–å­—ç¬¦æ•°ç»„çš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">if</span> ((c=get_fs_byte(pathname))==<span class="string">'/'</span>) &#123;</span><br><span class="line">inode = current-&gt;root;</span><br><span class="line">pathname++;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (c)</span><br><span class="line">inode = current-&gt;pwd;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;<span class="comment">/* empty name is bad */</span></span><br><span class="line">inode-&gt;i_count++;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">thisname = pathname;</span><br><span class="line"><span class="keyword">if</span> (!S_ISDIR(inode-&gt;i_mode) || !permission(inode,MAY_EXEC)) &#123;</span><br><span class="line">iput(inode);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(namelen=<span class="number">0</span>;(c=get_fs_byte(pathname++))&amp;&amp;(c!=<span class="string">'/'</span>);namelen++)</span><br><span class="line"><span class="comment">/* nothing */</span> ;</span><br><span class="line"><span class="keyword">if</span> (!c)</span><br><span class="line"><span class="keyword">return</span> inode;</span><br><span class="line"><span class="keyword">if</span> (!(bh = find_entry(&amp;inode,thisname,namelen,&amp;de))) &#123;</span><br><span class="line">iput(inode);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">inr = de-&gt;inode;</span><br><span class="line">idev = inode-&gt;i_dev;</span><br><span class="line">brelse(bh);</span><br><span class="line">iput(inode);</span><br><span class="line"><span class="keyword">if</span> (!(inode = iget(idev,inr)))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *dir_namei()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å¤„ç†è·¯å¾„ pathname, å¤„ç†æˆièŠ‚ç‚¹è¡¨ç¤ºçš„æœ€ç»ˆä¸€çº§ç›®å½•+ç›®å½•ä¸‹æ–‡ä»¶å(ä¹Ÿå¯èƒ½pathnameè¡¨ç¤ºçš„å°±æ˜¯ç›®å½•)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct m_inode * <span class="title">dir_namei</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * pathname, <span class="keyword">int</span> * namelen, <span class="keyword">const</span> <span class="keyword">char</span> ** name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> c;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * basename;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">dir</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(dir = get_dir(pathname)))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">basename = pathname;</span><br><span class="line"><span class="keyword">while</span> (c=get_fs_byte(pathname++))</span><br><span class="line"><span class="keyword">if</span> (c==<span class="string">'/'</span>)</span><br><span class="line">basename=pathname;</span><br><span class="line">*namelen = pathname-basename<span class="number">-1</span>;</span><br><span class="line">*name = basename;</span><br><span class="line"><span class="keyword">return</span> dir;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *open_namei()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * namei for open - this is in fact almost the whole open-routine.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open_namei</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * pathname, <span class="keyword">int</span> flag, <span class="keyword">int</span> mode,</span></span></span><br><span class="line"><span class="function"><span class="params">struct m_inode ** res_inode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * basename;</span><br><span class="line"><span class="keyword">int</span> inr,dev,namelen;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">dir</span>, *<span class="title">inode</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">bh</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dir_entry</span> * <span class="title">de</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((flag &amp; O_TRUNC) &amp;&amp; !(flag &amp; O_ACCMODE))</span><br><span class="line">flag |= O_WRONLY;</span><br><span class="line">mode &amp;= <span class="number">0777</span> &amp; ~current-&gt;umask;</span><br><span class="line">mode |= I_REGULAR;</span><br><span class="line"><span class="keyword">if</span> (!(dir = dir_namei(pathname,&amp;namelen,&amp;basename)))</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line">    <span class="comment">/* å¦‚æœç»™çš„ pathname æ˜¯ä¸€ä¸ªç›®å½• */</span></span><br><span class="line"><span class="keyword">if</span> (!namelen) &#123;<span class="comment">/* special case: '/usr/' etc */</span></span><br><span class="line"><span class="keyword">if</span> (!(flag &amp; (O_ACCMODE|O_CREAT|O_TRUNC))) &#123;</span><br><span class="line">*res_inode=dir;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">iput(dir);</span><br><span class="line"><span class="keyword">return</span> -EISDIR;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* æ‰¾åˆ°ç›®å½•å¯¹åº”çš„ièŠ‚ç‚¹çš„æ•°æ®å— */</span></span><br><span class="line">bh = find_entry(&amp;dir,basename,namelen,&amp;de);</span><br><span class="line"><span class="keyword">if</span> (!bh) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(flag &amp; O_CREAT)) &#123;</span><br><span class="line">iput(dir);</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!permission(dir,MAY_WRITE)) &#123;</span><br><span class="line">iput(dir);</span><br><span class="line"><span class="keyword">return</span> -EACCES;</span><br><span class="line">&#125;</span><br><span class="line">inode = new_inode(dir-&gt;i_dev);</span><br><span class="line"><span class="keyword">if</span> (!inode) &#123;</span><br><span class="line">iput(dir);</span><br><span class="line"><span class="keyword">return</span> -ENOSPC;</span><br><span class="line">&#125;</span><br><span class="line">inode-&gt;i_uid = current-&gt;euid;</span><br><span class="line">inode-&gt;i_mode = mode;</span><br><span class="line">inode-&gt;i_dirt = <span class="number">1</span>;</span><br><span class="line">bh = add_entry(dir,basename,namelen,&amp;de);</span><br><span class="line"><span class="keyword">if</span> (!bh) &#123;</span><br><span class="line">inode-&gt;i_nlinks--;</span><br><span class="line">iput(inode);</span><br><span class="line">iput(dir);</span><br><span class="line"><span class="keyword">return</span> -ENOSPC;</span><br><span class="line">&#125;</span><br><span class="line">de-&gt;inode = inode-&gt;i_num;</span><br><span class="line">bh-&gt;b_dirt = <span class="number">1</span>;</span><br><span class="line">brelse(bh);</span><br><span class="line">iput(dir);</span><br><span class="line">*res_inode = inode;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">inr = de-&gt;inode;</span><br><span class="line">dev = dir-&gt;i_dev;</span><br><span class="line">brelse(bh);</span><br><span class="line">iput(dir);</span><br><span class="line"><span class="keyword">if</span> (flag &amp; O_EXCL)</span><br><span class="line"><span class="keyword">return</span> -EEXIST;</span><br><span class="line"><span class="keyword">if</span> (!(inode=iget(dev,inr)))</span><br><span class="line"><span class="keyword">return</span> -EACCES;</span><br><span class="line"><span class="keyword">if</span> ((S_ISDIR(inode-&gt;i_mode) &amp;&amp; (flag &amp; O_ACCMODE)) ||</span><br><span class="line">    !permission(inode,ACC_MODE(flag))) &#123;</span><br><span class="line">iput(inode);</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line">&#125;</span><br><span class="line">inode-&gt;i_atime = CURRENT_TIME;</span><br><span class="line"><span class="keyword">if</span> (flag &amp; O_TRUNC)</span><br><span class="line">truncate(inode);</span><br><span class="line">*res_inode = inode;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶å†™å…¥"><a href="#æ–‡ä»¶å†™å…¥" class="headerlink" title="æ–‡ä»¶å†™å…¥"></a>æ–‡ä»¶å†™å…¥</h3><p>æ¥ä¸‹æ¥å°±è¦è¿›è¡Œæ–‡ä»¶å†™å…¥çš„æµç¨‹äº†</p><p>å¦‚ä½•é™·å…¥å†…æ ¸æ€å‡½æ•°å°±ä¸å†ç»†è¯´äº†ï¼Œç›¸ä¿¡çœ‹è¿‡è¿™ä¹ˆå¤šç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¹Ÿèƒ½çŸ¥é“åŸºæœ¬ä¸Šç³»ç»Ÿè°ƒç”¨åœ¨å†…æ ¸æ€å¯¹åº”çš„å‡½æ•°éƒ½æ˜¯ä»¥ sys_<method> å½¢å¼å‡ºç°çš„</method></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd,<span class="keyword">char</span> * buf,<span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">inode</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* éæ³• fd , æŠ›å¼‚å¸¸ */</span></span><br><span class="line"><span class="keyword">if</span> (fd&gt;=NR_OPEN || count &lt;<span class="number">0</span> || !(file=current-&gt;filp[fd]))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">/* count = 0ï¼Œæ— éœ€å†™å…¥æ•°æ® */</span></span><br><span class="line"><span class="keyword">if</span> (!count)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">inode=file-&gt;f_inode;</span><br><span class="line">    <span class="comment">/* é’ˆå¯¹ä¸åŒçš„ièŠ‚ç‚¹ç±»å‹ï¼Œæœ‰ä¸åŒçš„å†™å…¥å‡½æ•° */</span></span><br><span class="line"><span class="keyword">if</span> (inode-&gt;i_pipe)</span><br><span class="line"><span class="keyword">return</span> (file-&gt;f_mode&amp;<span class="number">2</span>)?write_pipe(inode,buf,count):-EIO;</span><br><span class="line"><span class="keyword">if</span> (S_ISCHR(inode-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span> rw_char(WRITE,inode-&gt;i_zone[<span class="number">0</span>],buf,count,&amp;file-&gt;f_pos);</span><br><span class="line"><span class="keyword">if</span> (S_ISBLK(inode-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span> block_write(inode-&gt;i_zone[<span class="number">0</span>],&amp;file-&gt;f_pos,buf,count);</span><br><span class="line"><span class="keyword">if</span> (S_ISREG(inode-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span> file_write(inode,file,buf,count);</span><br><span class="line">printk(<span class="string">"(Write)inode-&gt;i_mode=%06o\n\r"</span>,inode-&gt;i_mode);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹å¯¹äºå¸¸è§„æ–‡ä»¶æ˜¯æ€ä¹ˆæ“ä½œçš„å§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">file_write</span><span class="params">(struct m_inode * inode, struct file * filp, <span class="keyword">char</span> * buf, <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">off_t</span> pos;      <span class="comment">/* åç§»é‡ */</span></span><br><span class="line"><span class="keyword">int</span> block,c;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">bh</span>;</span></span><br><span class="line"><span class="keyword">char</span> * p;</span><br><span class="line"><span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¦‚æœæ˜¯ Append æ¨¡å¼ï¼ŒæŠŠåç§»é‡é‡ç½®åˆ°æ–‡ä»¶æœ«å°¾ */</span></span><br><span class="line"><span class="keyword">if</span> (filp-&gt;f_flags &amp; O_APPEND) </span><br><span class="line">pos = inode-&gt;i_size;</span><br><span class="line">    <span class="comment">/* å¦åˆ™å°±ä½¿ç”¨å½“å‰æ–‡ä»¶æ•°æ®ç»“æ„æŒæœ‰çš„åç§»é‡ */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        é™„ä¸Šæ•°æ®ç»“æ„  file çš„å†…å®¹ </span></span><br><span class="line"><span class="comment">        struct file &#123;</span></span><br><span class="line"><span class="comment">        unsigned short f_mode;</span></span><br><span class="line"><span class="comment">        unsigned short f_flags;</span></span><br><span class="line"><span class="comment">        unsigned short f_count;</span></span><br><span class="line"><span class="comment">        struct m_inode * f_inode;</span></span><br><span class="line"><span class="comment">        off_t f_pos;    æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½å°†æŒæœ‰å½“å‰çš„åç§»å€¼</span></span><br><span class="line"><span class="comment">        &#125;;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">pos = filp-&gt;f_pos;</span><br><span class="line">    <span class="comment">/* é€å­—ç¬¦å‘ç¼“å†²åŒºå†™å…¥æ•°æ® */</span></span><br><span class="line"><span class="keyword">while</span> (i&lt;count) &#123;</span><br><span class="line">        <span class="comment">/* æœ€å¼€å§‹å½“ç„¶æ˜¯åˆ›å»ºåœ¨ç£ç›˜ä¸Šå ç”¨ä¸€ä¸ªæ•°æ®å—äº† (å¦‚æœæ–‡ä»¶å¯¹åº”çš„å—ä¸å­˜åœ¨çš„è¯) */</span></span><br><span class="line"><span class="keyword">if</span> (!(block = create_block(inode,pos/BLOCK_SIZE)))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/* æ ¹æ®æ•°æ®å—è·å¾—ç›¸åº”çš„ç¼“å†²å— */</span></span><br><span class="line"><span class="keyword">if</span> (!(bh=bread(inode-&gt;i_dev,block)))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/* åœ¨ç¼“å†²å—ä¸­çš„åç§»é‡ */</span></span><br><span class="line">c = pos % BLOCK_SIZE;</span><br><span class="line">        <span class="comment">/* å®šä½åˆ°å…·ä½“çš„ç¼“å†²åŒºçš„å†…å­˜åœ°å€ */</span></span><br><span class="line">p = c + bh-&gt;b_data;</span><br><span class="line">bh-&gt;b_dirt = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/* å½“å‰è¿™ä¸ªç¼“å†²å—è¿˜æœ‰å¤šå°‘å­—èŠ‚å¯å†™ */</span></span><br><span class="line">c = BLOCK_SIZE-c;</span><br><span class="line">        <span class="comment">/* å¦‚æœéœ€è¦å†™å…¥çš„æ•°æ®é‡å°‘äº c */</span></span><br><span class="line"><span class="keyword">if</span> (c &gt; count-i) c = count-i;</span><br><span class="line">        <span class="comment">/* æ·»åŠ åç§»é‡è®¡æ•°, æ›´æ–°æ•°æ®ç»“æ„ä¸­ç»´æŠ¤çš„å€¼ */</span></span><br><span class="line">pos += c;</span><br><span class="line"><span class="keyword">if</span> (pos &gt; inode-&gt;i_size) &#123;</span><br><span class="line">inode-&gt;i_size = pos;</span><br><span class="line">inode-&gt;i_dirt = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">i += c;</span><br><span class="line">        <span class="comment">/* å‘ç¼“å†²å—é€å­—èŠ‚å†™å…¥æ•°æ® */</span></span><br><span class="line"><span class="keyword">while</span> (c--&gt;<span class="number">0</span>)</span><br><span class="line">*(p++) = get_fs_byte(buf++);</span><br><span class="line">        <span class="comment">/* é‡Šæ”¾å¯¹ç¼“å†²å—çš„å ç”¨ï¼Œå½“ç„¶ï¼Œåœ¨é‡Šæ”¾å‰ä¼šå®Œæˆç¼“å†²å—&lt;-&gt;å¤–å­˜æ•°æ®å—çš„åŒæ­¥ */</span></span><br><span class="line">brelse(bh);</span><br><span class="line">&#125;</span><br><span class="line">inode-&gt;i_mtime = CURRENT_TIME;</span><br><span class="line"><span class="keyword">if</span> (!(filp-&gt;f_flags &amp; O_APPEND)) &#123;</span><br><span class="line">        <span class="comment">/* é APPEND æ¨¡å¼ï¼Œæ›´æ–°æ–‡ä»¶è¯»å†™æŒ‡é’ˆ(åç§»é‡); APPEND æ¨¡å¼æ˜¯ä½¿ç”¨ inode-&gt;i_size ï¼Œæ‰€æœ‰å°±ä¸éœ€è¦åœ¨è¿™é‡Œæ›´æ–°äº† */</span></span><br><span class="line">filp-&gt;f_pos = pos;</span><br><span class="line">inode-&gt;i_ctime = CURRENT_TIME;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (i?i:<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯è§‰å¾—ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤ªé«˜å¤§ä¸Šçš„æ“ä½œã€‚ç¡®å®å¦‚æ­¤ï¼Œæ›´å¤šå…³äºç¼“å­˜å—ä¸æ–‡ä»¶ç³»ç»Ÿæ•°æ®å—çš„åŒæ­¥éƒ½å·²ç»è¢«åŒ…è£…åˆ° bread(), brelse() ä¸­äº†ã€‚</p><p>ä¸è¿‡ï¼Œæš‚æ—¶æ— éœ€ç»†ç©¶ã€‚æ€»ä¹‹åˆ°æ­¤ä¸ºæ­¢ï¼Œå…ˆè¦æœ‰ä¸€ä¸ªåŸºç¡€çš„è§‚å¿µ: æ‰€æœ‰ä¸å¤–å­˜å‚¨å™¨(è¿™é‡Œä¹ŸåŒ…æ‹¬æ§åˆ¶å°ç­‰)è¿›è¡Œæ•°æ®äº¤äº’éƒ½å¿…é¡»ç»è¿‡ç¼“å†²åŒº</p><p>ç¼“å†²åŒºå°è£…äº†å¯¹å¤–å­˜å‚¨å™¨çš„å…¨éƒ¨æ“ä½œï¼Œè€Œæä¾›ç»™ CPU æ›´é«˜æ•ˆçš„ I/O æ“ä½œï¼Œå½“ç„¶ï¼Œä¹Ÿæ›´ä¸ºç®€å•å¿«æ·</p><h3 id="æ–‡ä»¶è¯»å–"><a href="#æ–‡ä»¶è¯»å–" class="headerlink" title="æ–‡ä»¶è¯»å–"></a>æ–‡ä»¶è¯»å–</h3><p>è‡³äºæ–‡ä»¶è¯»å–ï¼Œä¹ŸåŸºæœ¬ç±»ä¼¼äº†ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å†æ·±å…¥æè¿°ã€‚</p><p>å½“ç„¶ï¼Œè¦æ³¨æ„çš„å°±æ˜¯ï¼Œåœ¨æœ¬ç¯‡å¼€å§‹çš„éƒ¨åˆ†æä¾›çš„ä¾‹ç¨‹ä¸­ï¼Œwrite &amp; read ä¸­æ’å…¥äº† <code>off_t off = lseek(fd, 0, SEEK_SET);</code>  è¿™æ ·çš„ä»£ç ã€‚</p><p>åŸå› åº”è¯¥ä¹Ÿèƒ½å¤Ÿæƒ³åˆ°ï¼Œå­¦ä¹  <code>sys_write(..)</code> çš„æ—¶å€™æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œä»»åŠ¡å¯¹åŒä¸€ä¸ªæ–‡ä»¶åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸€ä¸ªæ–‡ä»¶è¯»å†™åç§»é‡ã€‚å› æ­¤ï¼Œè¦è¯»å–åˆšæ‰å†™å…¥çš„å†…å®¹ï¼Œå°±ä¸å¾—ä¸å…ˆæ”¹åŠ¨è¿™ä¸ªè¯»å†™åç§»é‡äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_read</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd,<span class="keyword">char</span> * buf,<span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">inode</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fd&gt;=NR_OPEN || count&lt;<span class="number">0</span> || !(file=current-&gt;filp[fd]))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (!count)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">verify_area(buf,count);</span><br><span class="line">inode = file-&gt;f_inode;</span><br><span class="line"><span class="keyword">if</span> (inode-&gt;i_pipe)</span><br><span class="line"><span class="keyword">return</span> (file-&gt;f_mode&amp;<span class="number">1</span>)?read_pipe(inode,buf,count):-EIO;</span><br><span class="line"><span class="keyword">if</span> (S_ISCHR(inode-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span> rw_char(READ,inode-&gt;i_zone[<span class="number">0</span>],buf,count,&amp;file-&gt;f_pos);</span><br><span class="line"><span class="keyword">if</span> (S_ISBLK(inode-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span> block_read(inode-&gt;i_zone[<span class="number">0</span>],&amp;file-&gt;f_pos,buf,count);</span><br><span class="line"><span class="keyword">if</span> (S_ISDIR(inode-&gt;i_mode) || S_ISREG(inode-&gt;i_mode)) &#123;</span><br><span class="line"><span class="keyword">if</span> (count+file-&gt;f_pos &gt; inode-&gt;i_size)</span><br><span class="line">count = inode-&gt;i_size - file-&gt;f_pos;</span><br><span class="line"><span class="keyword">if</span> (count&lt;=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> file_read(inode,file,buf,count);</span><br><span class="line">&#125;</span><br><span class="line">printk(<span class="string">"(Read)inode-&gt;i_mode=%06o\n\r"</span>,inode-&gt;i_mode);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™ç¯‡å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä»£ç å±‚é¢çš„æè¿°ï¼Œä»…ä»…åªæ˜¯æ¡äº†ä¸€ä¸ªç›¸å½“æœ‰é™çš„ç‰‡é¢ (å¸¸è§„æ–‡ä»¶è¯»å†™)ã€‚ä»æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å¼€å§‹æä¾›äº†ä¸€ä¸ªè¯»å†™çš„å®Œæ•´æµç¨‹ä»‹ç»(å½“ç„¶ï¼Œå¾ˆå¤šç»†èŠ‚æ˜¯ç¼ºå¤±çš„ï¼Œä¸è¿‡ä¸è¦ç€æ€¥)ã€‚</p><p>è™½ç„¶å¹³å¸¸éƒ½èƒ½å¤Ÿäº†è§£åˆ°ä¸€ä¸ªæ¯”è¾ƒæ¨¡ç³Šçš„å‰æï¼Œæ–‡ä»¶è¯»å†™éœ€è¦åˆ©ç”¨ç¼“å†²åŒºï¼Œä½†æ˜¯ç©¶ç«Ÿä»€ä¹ˆæ˜¯ç¼“å­˜åŒºï¼Œå¦‚ä½•ä½¿ç”¨éƒ½ä¸ä¼šæœ‰å¤ªå¤šçš„æ¦‚å¿µã€‚æœ¬ç¯‡æœ€å¤§çš„é‡ç‚¹ï¼Œå°±æ˜¯é¦–å…ˆè¯·è¯»è€…ä»¬å»ºç«‹èµ·ä¸€ä¸ªåŸºç¡€æ€§çš„å¯¹ç¼“å†²åŒºçš„äº†è§£ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªä¸­ä»‹åœ¨ I/O ä¸­æ‰®æ¼”äº†ç›¸å½“é‡è¦çš„è§’è‰²ã€‚è€Œä¸”å†…å­˜ä¹Ÿä¸ºå…¶æä¾›äº†ç›¸å½“å¤§çš„ä¸€ä»½ç©ºé—´ï¼Œå·®ä¸å¤šæœ‰ 1/4 äº†ã€‚</p><p>è·¨äº†å·®ä¸å¤šåŠä¸ªå¤šæœˆæ¥å†™ï¼Œä¸Šä¸‹æ–‡çš„æ‰¿æ¥å¯èƒ½æœ‰äº›ç”Ÿç¡¬äº†ï¼Œç”šè‡³ä¸ä¸€è‡´äº†â€¦ å°´å°¬â€¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://dormouse-none.github.io/2018-10-14-understand-Kernel-5/&quot;&gt;å‰ä¸€ç¯‡&lt;/a&gt;å·²ç»æè¿°å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº†å®è§‚æ€§çš„æè¿°ï¼Œè¿™ä¸€ç¯‡ï¼Œå°†ä»¥ç‰¹å®šçš„æ–‡ä»¶è¯»å†™æ“ä½œä¸ºç¤ºä¾‹ï¼Œä¸²è”å¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆå…ˆæ¥çœ‹çœ‹å¹³å°ç›¸å…³çš„æ–‡ä»¶è¯»å†™æ“ä½œçš„ C ä»£ç æ˜¯æ€æ ·ä¸€ä¸ªè°ƒç”¨æ–¹å¼&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;fcntl.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;errno.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;sys/types.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;sys/stat.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;%s (errno=%d)\n&quot;&lt;/span&gt;, strerror(errno), errno);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *argv[])&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* æ‰“å¼€æ–‡ä»¶ frw.txt (ä»¥å¯è¯»å†™ | è‹¥ä¸å­˜åœ¨åˆ™æ–°å»ºçš„å½¢å¼) */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; fd = open(&lt;span class=&quot;string&quot;&gt;&quot;/root/frw.txt&quot;&lt;/span&gt;, O_RDWR | O_CREAT);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (fd == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; panic();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* å‘æ–‡ä»¶å†™å…¥ Hello World! å…±è®¡ 12 ä¸ªå­—ç¬¦ */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ssize_t&lt;/span&gt; wsize = write(fd, &lt;span class=&quot;string&quot;&gt;&quot;Hello World!&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;12&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (wsize == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; panic();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* é‡å®šä½æ–‡ä»¶è¯»å†™æŒ‡é’ˆ */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;off_t&lt;/span&gt; off = lseek(fd, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, SEEK_SET);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (off == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; panic();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* buf = (&lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *) &lt;span class=&quot;built_in&quot;&gt;malloc&lt;/span&gt;(wsize);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* è¯»å–æ–‡ä»¶å†…å®¹ */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ssize_t&lt;/span&gt; rsize = read(fd, buf, wsize);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (rsize == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; panic();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;%s\n&quot;&lt;/span&gt;, buf);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;free&lt;/span&gt;(buf);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* å…³é—­æ–‡ä»¶ */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; stat = close(fd);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (stat == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; panic();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="File System" scheme="https://DorMOUSE-None.github.io/tags/File-System/"/>
    
      <category term="read &amp; write" scheme="https://DorMOUSE-None.github.io/tags/read-write/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (5) - æ–‡ä»¶ç³»ç»Ÿ(å®è§‚æè¿°)</title>
    <link href="https://DorMOUSE-None.github.io/2018-10-14-understand-Kernel-5/"/>
    <id>https://DorMOUSE-None.github.io/2018-10-14-understand-Kernel-5/</id>
    <published>2018-10-13T16:00:00.000Z</published>
    <updated>2018-10-28T05:01:34.567Z</updated>
    
    <content type="html"><![CDATA[<p>ç”¨æƒ¯äº†ç±» Unix ç³»ç»Ÿï¼Œåº”è¯¥è¯´æ–‡ä»¶ç³»ç»Ÿæ˜¯æ—¥å¸¸æœ€å¸¸æ¥è§¦çš„ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ¨¡å—ä¹‹ä¸€äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">Applications Network      Users        bin          data         etc          net          sbin         usr</span><br><span class="line">Library      System       Volumes      cores        dev          home         private      tmp          var</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œç©¶ç«Ÿä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿ? ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ç³»ç»Ÿ? éš¾é“æ–‡ä»¶ä¸æ˜¯ç®€å•åœ°å­˜å‚¨åˆ°å­˜å‚¨è®¾å¤‡ä¸€å—è¿ç»­åŒºåŸŸçš„å—?</p><a id="more"></a><h2 id="æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼"><a href="#æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼"></a>æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼</h2><p>é¦–å…ˆæˆ‘ä»¬å‡è®¾æ–‡ä»¶æ˜¯ç®€å•åœ°å­˜å‚¨åœ¨å­˜å‚¨è®¾å¤‡(ç¡¬ç›˜ç­‰)æŸä¸€å—è¿ç»­åŒºåŸŸçš„ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•åœ¨å°åˆ™å‡ ç™¾Gï¼Œå¤§åˆ™å‡ åTç”šè‡³æ›´å¤§çš„å­˜å‚¨è®¾å¤‡ä¸Šæ‰¾åˆ°å…·ä½“çš„æŸä¸€æ–‡ä»¶ï¼Œå¹¶è¯»å–çš„å†…å­˜ä¸­å‘¢?</p><p>æœ€æ™®é€šçš„ï¼Œå°±åªèƒ½åœ¨å­˜å‚¨è®¾å¤‡ä¸Šä¸€å­—èŠ‚ä¸€å­—èŠ‚çš„æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸åº”çš„ç›®æ ‡æ–‡ä»¶ã€‚æ˜¯ä¸æ˜¯å¯ä»¥æƒ³è±¡ï¼Œè¿™ä¼šå¾ˆæ…¢å¾ˆæ…¢ã€‚</p><p>æœ‰æ²¡æœ‰å¿«ä¸€ç‚¹çš„ï¼Ÿå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå‚è€ƒç±»ä¼¼å­—å…¸çš„å½¢å¼å°±å¯ä»¥äº†ã€‚</p><p><strong>ç›®å½•å½¢å¼</strong></p><p>æ–‡ä»¶å†…å®¹å¯èƒ½å¾ˆå¤§ï¼Œä½†ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ–‡ä»¶åå°±å°äº†å¾ˆå¤š(å°±ç®—ä¸åŒç›®å½•ä¸‹åŒåæ–‡ä»¶å¾ˆå¤šï¼Œä½†æ˜¯è®°å½•å…¨è·¯å¾„åä¹Ÿä»£ä»·ä¸å¤§ã€‚å½“ç„¶äº†ï¼Œå¦‚æœéƒ½æ˜¯å°æ–‡ä»¶ã€ç©ºæ–‡ä»¶ï¼Œé‚£å°±ä¸ä¸€æ ·äº†)</p><p>é€šè¿‡ä¸ºæ‰€æœ‰æ–‡ä»¶é€šè¿‡æ–‡ä»¶åç¼–ä¸€ä¸ªç›®å½•ï¼ŒæŒ‡æ˜æ¯ä¸ªæ–‡ä»¶åœ¨å­˜å‚¨è®¾å¤‡ä¸Šçš„å…·ä½“ä½ç½®ã€‚è¿™æ ·éœ€è¦æ‰«æçš„å†…å®¹å°±ä¼šå°å¾ˆå¤šï¼Œä¹Ÿèƒ½æ›´å¿«åœ°å®šä½åˆ°æ–‡ä»¶å†…å®¹ã€‚</p><p><strong>é€çº§ç›®å½•</strong></p><p>ä»…ä»…åªç¼–åˆ¶ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆå±‚æ¬¡ç›®å½•åˆæœ‰ä»€ä¹ˆå®é™…æ„ä¹‰å—ï¼Ÿåªæ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·åˆ†ç±»ä¸åŒåŠŸèƒ½ã€ç›®çš„çš„æ–‡ä»¶å—ï¼Ÿ</p><p>åˆ©ç”¨é€çº§ç›®å½•ï¼Œå¯ä»¥è€ƒè™‘å¯¹æ¬¡çº§ç›®å½•çš„å†…å®¹ç¼–åˆ¶ä¸Šä¸€çº§ç›®å½•ã€‚é€šè¿‡é¡¶çº§ç›®å½•å®šä½æ¬¡çº§ç›®å½•çš„å†…å®¹ï¼Œæ¬¡çº§ç›®å½•å®šä½å†æ¬¡çº§ç›®å½•ï¼Œæœ€åå¯¹åº”ç›®å½•ä¸‹çš„æ–‡ä»¶çš„å†…å®¹ã€‚</p><h2 id="æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡"><a href="#æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡"></a>æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡</h2><p>åœ¨ä¹‹å‰çš„ç†è§£é‡Œï¼Œæ–‡ä»¶ç³»ç»Ÿæ˜¯æ¥ç®¡äº†æ•´ä¸ªå­˜å‚¨è®¾å¤‡ã€‚ä¼¼ä¹æ–‡ä»¶ç³»ç»Ÿå’Œå­˜å‚¨è®¾å¤‡å°±æ˜¯ç›´æ¥å…³è”çš„ï¼Œä¸¤ä¸ªä¸å¯åˆ†å‰²ã€‚æ²¡æœ‰å»ºç«‹æ–‡ä»¶ç³»ç»Ÿçš„ç¡¬ç›˜å°±ä¸èƒ½ä½¿ç”¨ï¼Œè€Œæ²¡æœ‰ç¡¬ç›˜ï¼Œæ–‡ä»¶ç³»ç»Ÿå°±æ²¡æœ‰äº†è½½ä½“ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨å­¦ä¹  Linux çš„è¿‡ç¨‹ä¸­ï¼Œä¼¼ä¹å‘ç°ä¹Ÿå¹¶ä¸æ˜¯è¿™ä¹ˆä¸€å›äº‹ã€‚æ²¡æœ‰ç›´æ¥ç¡¬ç›˜ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸€æ ·å¯ä»¥å­˜åœ¨ã€‚ä¸€ç›´éƒ½æœ‰åœ¨ä½¿ç”¨ <code>.img</code> ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œåªæ˜¯æ²¡æœ‰æ„è¯†åˆ°ï¼Œè¿™æ„è¯†æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç§è½½ä½“ã€‚åŒæ ·çš„ï¼Œæ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨æ“ä½œç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ ·æ˜¯å¯ä»¥åŠ è½½å„ç§å†…å®¹ï¼Œä¹ƒè‡³é¢„ç½®çš„æ–‡ä»¶ä¿¡æ¯ã€‚</p><p>åœ¨ Linux ä¸­ï¼Œæœ€å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯ ext2, ext3, ext4 ä¹‹æµäº†ã€‚å¶å°”ä¹Ÿæœ‰å¬è¿‡ç”¨è¿‡ï¼Œæ¯”å¦‚è¯´å‡†å¤‡æ¥å…¥æ–°çš„ç¡¬ç›˜çš„æ—¶å€™ã€‚ä½†æ˜¯ï¼ŒçœŸæ­£é‡Œé¢æ˜¯ä»€ä¹ˆæ ·çš„ã€‚è¿˜çœŸä¸äº†è§£ï¼Œext2,3,4 çš„åŒºåˆ«ï¼Œä¹Ÿæ ¹æœ¬ä¸çŸ¥é“ã€‚</p><p>å½“ç„¶äº†ï¼Œæœ¬æ¬¡ä¹Ÿå¹¶ä¸ä¼šå¯¹è¿™äº›å†…å®¹è¿›è¡Œæè¿°ã€‚ç”±äºä¸€ç›´åœ¨å­¦ä¹  Linux 0.11 ç‰ˆæœ¬çš„æºç ï¼Œæ¥ä¸‹æ¥è¦æè¿°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ 0.11 ç‰ˆæœ¬ç›´æ¥ä½¿ç”¨çš„ minix æ–‡ä»¶ç³»ç»Ÿäº†ã€‚</p><p>æœ€å¼€å§‹ï¼Œå½“ç„¶æ˜¯åº”è¯¥æœ‰ä¸€ä¸ªæ„Ÿå®˜çš„å°è±¡ï¼Œæ‰èƒ½æ›´æ–¹ä¾¿åœ°æ¥ç†è§£æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡å½¢å¼å•¦!</p><h3 id="åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ"><a href="#åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ"></a>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</h3><p>è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª 512 KB å¤§å°çš„æ–‡ä»¶ç³»ç»Ÿ</p><p><code>mkfs</code> åº”è¯¥æ˜¯æœ€ç®€å•çš„æ–¹å¼äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> touch disk.img            <span class="comment"># ç£ç›˜æ˜ åƒæ–‡ä»¶ (ç”±äºæ²¡æœ‰é¢å¤–çš„ç£ç›˜ï¼Œå°±ä»¥æ­¤ä½œä¸ºæ–°åˆ›å»ºçš„ minix æ–‡ä»¶ç³»ç»Ÿçš„è½½ä½“)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dd <span class="keyword">if</span>=/dev/zero of=disk.img bs=1024 count=512     <span class="comment"># å…ˆå°†æ–‡ä»¶çš„å¤§å°æ‰©å±•åˆ° 512 KB ï¼Œå¦åˆ™åœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ä¼šå¤±è´¥</span></span></span><br><span class="line">512+0 records in</span><br><span class="line">512+0 records out</span><br><span class="line">524288 bytes (524 kB, 512 KiB) copied, 0.00216049 s, 243 MB/s</span><br><span class="line"><span class="meta">$</span><span class="bash"> mkfs.minix disk.img 512   <span class="comment"># åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</span></span></span><br><span class="line">192 inodes                  # inodes - åº”è¯¥å¾ˆç†Ÿæ‚‰å§ã€‚æ¯ä¸ªæ–‡ä»¶éƒ½å ç”¨ä¸€ä¸ª inode</span><br><span class="line">512 blocks                  # æ€»å…± 512 ä¸ªç£ç›˜å—</span><br><span class="line">Firstdatazone=10 (10)       # ç¬¬ 10 ä¸ªç£ç›˜å—å¼€å§‹æ˜¯çœŸæ­£çš„æ•°æ®å—ã€‚å‰é¢æ˜¯ä»€ä¹ˆ? å¤§éƒ¨åˆ†æ˜¯ç›®å½•å ç”¨çš„</span><br><span class="line">Zonesize=1024               # æ¯ä¸ªç£ç›˜å—çš„å¤§å°ä¸º 1024 B</span><br><span class="line">Maxsize=268966912           # å•ä¸€æ–‡ä»¶çš„æœ€å¤§å¤§å°</span><br></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹çœ‹ç›®å‰ disk.img é‡Œé¢çš„å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexdump disk.img</span></span><br><span class="line">0000000 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*                                                   # * è¡¨ç¤ºè¿™æ®µæ•°æ®å…¨ä¸º 0</span><br><span class="line">0000400 00c0 0200 0001 0001 000a 0000 1c00 1008</span><br><span class="line">0000410 138f 0001 0000 0000 0000 0000 0000 0000</span><br><span class="line">0000420 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0000800 0003 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">0000810 0000 0000 0000 0000 fffe ffff ffff ffff</span><br><span class="line">0000820 ffff ffff ffff ffff ffff ffff ffff ffff</span><br><span class="line">*                                                   # * è¡¨ç¤ºè¿™æ®µæ•°æ®å…¨ä¸º ff ( * æ€»æ˜¯è¡¨ç¤ºä¸å‰ä¸€æ®µæ•°æ®ä¸€è‡´çš„çœç•¥)</span><br><span class="line">0000c00 0003 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">0000c10 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0000c30 0000 0000 0000 0000 0000 0000 0000 ff80</span><br><span class="line">0000c40 ffff ffff ffff ffff ffff ffff ffff ffff</span><br><span class="line">*</span><br><span class="line">0001000 41ed 0000 0040 0000 cf12 5bd3 0200 000a</span><br><span class="line">0001010 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0002800 0001 002e 0000 0000 0000 0000 0000 0000</span><br><span class="line">0002810 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">0002820 0001 2e2e 0000 0000 0000 0000 0000 0000</span><br><span class="line">0002830 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">0002840 0000 622e 6461 6c62 636f 736b 0000 0000</span><br><span class="line">0002850 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0080000                                             # æˆªæ­¢å­—èŠ‚ï¼Œ0x80000 = 512 KB å¹¶ä¸å­˜åœ¨</span><br></pre></td></tr></table></figure><p>ä¼¼ä¹å¹¶æ²¡æœ‰å¤ªå¤šçš„æ„Ÿè§‰ï¼Œç°åœ¨æˆ‘ä»¬å¾€ disk.img è¿™ä¸ªç£ç›˜æ˜ åƒæ–‡ä»¶ä¸­æ·»äº›å†…å®¹å†æ¥çœ‹çœ‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mount disk.img /mnt   <span class="comment"># æŠŠ disk.img æŒ‚è½½åˆ° /mnt ç›®å½•ä¸‹</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /mnt</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"#include &lt;stdio.h&gt;"</span> &gt; hello.c       <span class="comment"># åˆ›å»º hello.c æ–‡ä»¶ï¼Œå¹¶å†™å…¥ #include &lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> umount /mnt           <span class="comment"># è§£æŒ‚ disk.img</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexdump -C disk.img</span></span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00000400  c0 00 00 02 01 00 01 00  0a 00 00 00 00 1c 08 10  |................|</span><br><span class="line">00000410  8f 13 01 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000420  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00000800  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000810  00 00 00 00 00 00 00 00  fe ff ff ff ff ff ff ff  |................|</span><br><span class="line">00000820  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line">00000c00  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000c10  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00000c30  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 ff  |................|</span><br><span class="line">00000c40  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line">00001000  ed 41 00 00 60 00 00 00  e5 0d d4 5b 00 02 0a 00  |.A..`......[....|</span><br><span class="line">00001010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00001020  a4 81 00 00 13 00 00 00  e5 0d d4 5b 00 01 0b 00  |...........[....|</span><br><span class="line">00001030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00002800  01 00 2e 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002810  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002820  01 00 2e 2e 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002840  02 00 68 65 6c 6c 6f 2e  63 00 00 00 00 00 00 00  |..hello.c.......|</span><br><span class="line">00002850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00002c00  23 69 6e 63 6c 75 64 65  20 3c 73 74 64 69 6f 2e  |#include &lt;stdio.|</span><br><span class="line">00002c10  68 3e 0a 00 00 00 00 00  00 00 00 00 00 00 00 00  |h&gt;..............|</span><br><span class="line">00002c20  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00080000</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† <code>#include &lt;stdio.h&gt;</code> å­—æ ·çš„å†…å®¹ï¼ŒåŒæ—¶ä¹Ÿå‡ºç°äº† <code>hello.c</code> çš„æ–‡ä»¶åã€‚</p><p>éœ€è¦æ³¨æ„ï¼Œæ–‡ä»¶åå’Œæ–‡ä»¶å†…å®¹æ˜¯ç›¸äº’å‰²è£‚çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨åœ¨ä¸€èµ·ã€‚</p><h3 id="æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç»“æ„"><a href="#æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç»“æ„" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç»“æ„"></a>æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç»“æ„</h3><p>é‚£ä¹ˆï¼Œé…åˆç€ä¸Šé¢çš„å†…å®¹æ¥çœ‹çœ‹æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡ç»“æ„ã€‚</p><p>é¦–å…ˆå¯ä»¥æ³¨æ„åˆ°çš„æ˜¯ï¼Œæ¯ä¸€æ®µéé›¶çš„æ•°æ®çš„å¼€å§‹åœ°å€ï¼ŒåŸºæœ¬éƒ½æ˜¯åœ¨ <code>0x0000, 0x0400, 0x0800, 0x0c00, 0x1000</code> ã€‚é—´éš”äº† 0x0400 = 1KBï¼Œè¿™å°±æ˜¯æœ€åŸºæœ¬çš„å—çš„å¤§å°ã€‚</p><p>Minix æ–‡ä»¶ç³»ç»Ÿå°† 1024 B ä½œä¸ºåŸºæœ¬å—çš„å¤§å°ã€‚<code>disk.img</code> è¿™ä¸ª 512 KB çš„ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œä¹Ÿå°±æ°å¥½è¢«åˆ†å‰²æˆ 512 å—ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkfs.minix disk.img 512   <span class="comment"># åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</span></span></span><br><span class="line">192 inodes                  # inodes - åº”è¯¥å¾ˆç†Ÿæ‚‰å§ã€‚æ¯ä¸ªæ–‡ä»¶éƒ½å ç”¨ä¸€ä¸ª inode</span><br><span class="line">512 blocks                  # æ€»å…± 512 ä¸ªç£ç›˜å—</span><br><span class="line">Firstdatazone=10 (10)       # ç¬¬ 10 ä¸ªç£ç›˜å—å¼€å§‹æ˜¯çœŸæ­£çš„æ•°æ®å—ã€‚å‰é¢æ˜¯ä»€ä¹ˆ? å¤§éƒ¨åˆ†æ˜¯ç›®å½•å ç”¨çš„</span><br><span class="line">Zonesize=1024               # æ¯ä¸ªç£ç›˜å—çš„å¤§å°ä¸º 1024 B</span><br><span class="line">Maxsize=268966912           # å•ä¸€æ–‡ä»¶çš„æœ€å¤§å¤§å°</span><br></pre></td></tr></table></figure><p>åœ¨å›è¿‡å¤´æ¥çœ‹çœ‹å‰é¢åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™çš„ä¿¡æ¯ï¼Œç›¸ä¿¡ä¹Ÿå°±èƒ½å¤Ÿçœ‹æ‡‚ä¸€éƒ¨åˆ†äº†ã€‚</p><p><strong>å—çš„ä½œç”¨åˆ’åˆ†</strong></p><p>é‚£ä¹ˆï¼Œæ¯ä¸ªå—å¦‚ä½•è¿›è¡Œä½¿ç”¨å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œæœ€å¼€å§‹çš„ä¸€ä¸ªå—å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬çŸ¥é“å¼•å¯¼ç¨‹åºåº”è¯¥å‡ºç°åœ¨å¼•å¯¼ç›˜æœ€å¼€å§‹ 512 Bã€‚ä½†æ˜¯ï¼Œæœ‰äº›ç›˜æœ‰å¼•å¯¼ç¨‹åºï¼Œæœ‰äº›ç›˜åˆæ²¡æœ‰ï¼Œå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p><p>æ–‡ä»¶ç³»ç»Ÿç»“æ„ä¸­ï¼Œé»˜è®¤åœ°ä¸å¯¹ç¬¬ä¸€ä¸ª 1024 B çš„å—è¿›è¡Œæ“ä½œï¼Œå³åŸæœ¬æ˜¯ä»€ä¹ˆæ•°æ®å°±æ˜¯ä»€ä¹ˆæ•°æ®ï¼Œä¸æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸ç›¸å¹²ã€‚</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwnnc753epj31kw04tq35.jpg" alt=""></p><p>é™¤äº†å¼•å¯¼å—ï¼Œä¹‹åè¿˜æœ‰è¶…çº§å—ï¼Œinode ä½å›¾ï¼Œé€»è¾‘å—ä½å›¾ï¼Œinode åŒºå—ï¼Œæ•°æ®åŒºå—</p><p><strong>è¶…çº§å—</strong></p><p>çœŸæ­£å¯¹ MINIX æ–‡ä»¶ç³»ç»Ÿèµ·ç€ç»Ÿé¢†æ€§ä½œç”¨çš„ï¼Œæ˜¯è¶…çº§å—(ç¬¬äºŒä¸ªå—)ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> &#123;</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_ninodes;          <span class="comment">/* i èŠ‚ç‚¹çš„æ•°é‡ */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_nzones;           <span class="comment">/* æ€»åŒºå—æ•°é‡ */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_imap_blocks;      <span class="comment">/* i èŠ‚ç‚¹ä½å›¾çš„æ•°é‡ */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_zmap_blocks;      <span class="comment">/* åŒºå—ä½å›¾çš„æ•°é‡ */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_firstdatazone;    <span class="comment">/* ç¬¬ä¸€ä¸ªæ•°æ®å—çš„ç¼–å· */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_log_zone_size;    <span class="comment">/* log2(ç£ç›˜å—å¤§å° / é€»è¾‘å—å¤§å°) */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> s_max_size;          <span class="comment">/* å•æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_magic;            <span class="comment">/* æ–‡ä»¶ç³»ç»Ÿçš„é­”æ•° */</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* ä¸‹é¢çš„å†…å®¹æ˜¯åœ¨å†…å­˜ä¸­ä½¿ç”¨çš„ï¼Œå¹¶ä¸ä¼šåœ¨ç£ç›˜ä¸Šè¿›è¡Œè¯»å†™ */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">s_imap</span>[8];</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">s_zmap</span>[8];</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> s_dev;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">s_isup</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">s_imount</span>;</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> s_time;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * <span class="title">s_wait</span>;</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> s_lock;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> s_rd_only;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> s_dirt;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“åˆç€ <code>disk.img</code> çš„æ•°æ®æ¥çœ‹çœ‹ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00000400  c0 00 00 02 01 00 01 00  0a 00 00 00 00 1c 08 10  |................|</span><br><span class="line">00000410  8f 13 01 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">0x00c0  -&gt; 192 ä¸ª i èŠ‚ç‚¹</span><br><span class="line">0x0200  -&gt; 512 ä¸ªé€»è¾‘å—</span><br><span class="line">0x0001  -&gt; ä¸€ä¸ªièŠ‚ç‚¹ä½å›¾</span><br><span class="line">0x0001  -&gt; ä¸€ä¸ªé€»è¾‘å—ä½å›¾</span><br><span class="line">0x000a  -&gt; ç¬¬ä¸€ä¸ªæ•°æ®å—ç¼–å·ä¸º 10 </span><br><span class="line">0x0000  -&gt; log2(ç£ç›˜å—å¤§å° / é€»è¾‘å—å¤§å°) = 0 ï¼Œå³ç£ç›˜å—å¤§å° = é€»è¾‘å—å¤§å° = 1024 B</span><br><span class="line">0x10081c00 -&gt; å•æ–‡ä»¶æœ€å¤§ 268966912 B</span><br></pre></td></tr></table></figure><p><strong>inode ä½å›¾</strong></p><p>inode ä½å›¾çš„æ•°æ®æ¯”è¾ƒç®€å•ï¼Œæ˜¯é€šè¿‡è®¾ç½®æ¯”ç‰¹ä½ 0ã€1 çš„æ–¹å¼ï¼Œæ¥ç›´æ¥è¡¨æ˜ç›¸åº”ç¼–å·çš„ i èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚<br>é»˜è®¤ i èŠ‚ç‚¹ä» 1 å·å¼€å§‹ç¼–å·ï¼Œ0 å·èŠ‚ç‚¹åœ¨ inode ä½å›¾ä¸Šä¸€å®šè®¾ç½®ä¸º 1 </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000800  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000810  00 00 00 00 00 00 00 00  fe ff ff ff ff ff ff ff  |................|</span><br><span class="line">00000820  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br></pre></td></tr></table></figure><p>æ€»å…± 192 ä¸ª i èŠ‚ç‚¹ï¼ŒåŠ ä¸Š 0 å·èŠ‚ç‚¹æ€»è®¡éœ€å ç”¨ 193 ä½ ( = 193 / 8 = 24 å­—èŠ‚ + 1 ä½)</p><p>å…¶ä½™å¤šä½™çš„ä½ï¼Œå…¨éƒ¨ç½®ä½ä¸º 1 ã€‚</p><p>ä½å›¾å­˜å‚¨çš„æœ€åˆæ•°æ® 0x07 (æ³¨æ„ï¼Œå°ç«¯å­˜å‚¨æ³•) = 0b111</p><p>ç”±æ­¤ï¼Œæ€»å…±æœ‰1å·å’Œ2å·ièŠ‚ç‚¹ã€‚</p><p><strong>é€»è¾‘å—ä½å›¾</strong></p><p>ç±»ä¼¼çš„ï¼Œé€»è¾‘å—ä½å›¾æ˜¯ä¸ºäº†è¡¨æ˜ç¬¬nä¸ªé€»è¾‘å—å­˜å‚¨æœ‰æ•°æ®ï¼Œæˆ–å¤„äºç©ºé—²çŠ¶æ€ã€‚</p><p><strong>inode åŒºå—</strong></p><p>å‚ç…§å‰é¢è®²è¿‡çš„å­—å…¸ç›®å½•çš„å½¢å¼ï¼Œinode å°±æ˜¯ä¸€ç§åˆ†çº§ç¼–æ’åçš„ç›®å½•ã€‚</p><p>å½“ç„¶ï¼Œè¯´ç›®å½•å¯èƒ½è¿˜ä¼šå¼•å‘è¯¯è§£ã€‚è¿™é‡Œæ— è®ºæ˜¯å¯¹äºæ“ä½œç³»ç»Ÿä¸‹çš„ç›®å½•æˆ–æ˜¯æ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªéƒ½å¯¹åº”ç€ä¸€ä¸ªç‹¬ç‰¹çš„ inode</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">d_inode</span> &#123;</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> i_mode;     <span class="comment">/* æ–‡ä»¶ç±»å‹å’Œå±æ€§ (rwx ä½) */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> i_uid;      <span class="comment">/* æ–‡ä»¶æ‰€æœ‰è€… id */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> i_size;      <span class="comment">/* æ–‡ä»¶å¤§å° */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> i_time;      <span class="comment">/* ä¿®æ”¹æ—¶é—´ */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> i_gid;       <span class="comment">/* æ–‡ä»¶æ‰€åœ¨ç»„ id */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> i_nlinks;    <span class="comment">/* æœ‰å¤šå°‘ä¸ªé“¾æ¥æ•° (æœ‰å¤šå°‘ä¸ªæ–‡ä»¶ç›®å½•é¡¹æŒ‡å‘è¯¥ i èŠ‚ç‚¹) */</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> i_zone[<span class="number">9</span>];  <span class="comment">/* æ–‡ä»¶æ•°æ®æ‰€å ç”¨æ•°æ®ç›˜çš„æŒ‡é’ˆ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªièŠ‚ç‚¹çš„æ•°æ®åˆ†åˆ« 32 å­—èŠ‚</p><p>åŒæ ·çš„ï¼Œç»“åˆ <code>disk.img</code> çš„æ•°æ®æ¥çœ‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">00001000  ed 41 00 00 60 00 00 00  e5 0d d4 5b 00 02 0a 00  |.A..`......[....|</span><br><span class="line">00001010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00001020  a4 81 00 00 13 00 00 00  e5 0d d4 5b 00 01 0b 00  |...........[....|</span><br><span class="line">00001030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">0x41ed  -&gt; </span><br><span class="line">0x0000  -&gt;  æ–‡ä»¶æ‰€æœ‰è€…ä¸º 0 å³ root</span><br><span class="line">0x00000060  -&gt;  æ–‡ä»¶å¤§å°ä¸º 96 B</span><br><span class="line">0x5bd40de5  -&gt;  æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´ä¸º Unix TimeStamp 1540623845 =&gt; 2018/10/27 15:4:5</span><br><span class="line">0x00    -&gt;  æ–‡ä»¶æ‰€åœ¨ç»„ id</span><br><span class="line">0x02    -&gt;  æœ‰ä¸¤ä¸ªæ–‡ä»¶ç›®å½•é¡¹æŒ‡å‘1å·ièŠ‚ç‚¹</span><br><span class="line">0x000a  -&gt;  1 å· i èŠ‚ç‚¹æŒ‡å‘çš„ç¬¬0å—æ•°æ®ä¸ºç¬¬10ä¸ªé€»è¾‘å—(å³ç¬¬1ä¸ªæ•°æ®å—)</span><br><span class="line">0x0000  =&gt;  ç”±äºæ•°æ®æ¯”è¾ƒå°ï¼Œåé¢çš„ i_zone[1] ~ i_zone[8] å‡ä¸º 0</span><br></pre></td></tr></table></figure><p>i_zone æŒ‡å‘çš„æ˜¯æ•°æ®å®é™…å­˜å‚¨çš„æ•°æ®å—çš„ä½ç½®ã€‚</p><p>ä½†æ˜¯ï¼Œä»…ä»…åªæœ‰ 9 ä¸ªæŒ‡é’ˆï¼Œæ¯ä¸ªæ•°æ®å—èƒ½å­˜å‚¨ 1024 B ï¼Œæ˜¯è¿œè¿œè¾¾ä¸åˆ°ä¹‹å‰æ‰€æè¿°çš„å•æ–‡ä»¶ <code>0x10081c00 = 268966912 B</code> çš„ä¸Šé™çš„ã€‚</p><p>äº‹å®ä¸Šï¼Œminix åœ¨å®é™…å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠå‰7ä¸ªæŒ‡é’ˆä½œä¸ºç›´æ¥æ•°æ®å—æŒ‡é’ˆï¼Œæœ€å¤šå­˜å‚¨ 7168 B æ•°æ®ã€‚</p><p>i_zone[7] è¡¨ç¤ºä¸€æ¬¡é—´æ¥æŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸€ä¸ªæ•°æ®å—ï¼Œä½†æ˜¯è¯¥æ•°æ®å—æ¯2å­—èŠ‚ä½œä¸ºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘çœŸæ­£çš„æ•°æ®å—ã€‚</p><p>i_zone[8] è¡¨ç¤ºäºŒæ¬¡é—´æ¥æŒ‡é’ˆã€‚</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwnu3zrwuij310y0m6abj.jpg" alt=""><br><small>Copied from Linux å†…æ ¸å®Œå…¨æ³¨é‡ŠV3.0</small></p><p><strong>æ•°æ®å—</strong></p><p>æœ€åï¼Œæˆ‘ä»¬çœ‹çœ‹æ•°æ®å—çš„å†…å®¹ï¼Œä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ›´å¥½åœ°æ¥ç†è§£ Linux ç›®å½•å’Œæ–‡ä»¶çš„å¼‚åŒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00002800  01 00 2e 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002810  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002820  01 00 2e 2e 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00002840  02 00 68 65 6c 6c 6f 2e  63 00 00 00 00 00 00 00  |..hello.c.......|</span><br><span class="line">00002850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00002c00  23 69 6e 63 6c 75 64 65  20 3c 73 74 64 69 6f 2e  |#include &lt;stdio.|</span><br><span class="line">00002c10  68 3e 0a 00 00 00 00 00  00 00 00 00 00 00 00 00  |h&gt;..............|</span><br><span class="line">00002c20  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br></pre></td></tr></table></figure><p>åœ¨ièŠ‚ç‚¹åŒºå—ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰1å·ièŠ‚ç‚¹å’Œ2å·ièŠ‚ç‚¹å·²ç»è¢«ä½¿ç”¨äº†ã€‚</p><p>0x2800 ~ 0x2860 çš„ä½ç½®è¡¨ç¤ºçš„å°±æ˜¯ 1 å·ièŠ‚ç‚¹çš„æ•°æ®ã€‚äº‹å®ä¸Šè¿™æ˜¯ä¸€ä¸ªç›®å½•(å½“ç„¶ï¼Œæ€ä¹ˆåŒºåˆ†ç›®å½•è¿˜æ˜¯æ–‡ä»¶ï¼Œåœ¨ièŠ‚ç‚¹åŒºå—çš„ i_mode å­—æ®µå·²ç»æè¿°è¿‡äº†)</p><p>å¯¹äºç›®å½•æ–‡ä»¶ï¼Œå½“ç„¶æ˜¯ç”¨æ¥è®°è½½ç›®å½•é¡¹çš„ï¼Œæ¯ä¸ªç›®å½•é¡¹å ç”¨ 32 å­—èŠ‚ã€‚</p><blockquote><p>è¿™é‡Œéœ€è¦è¿›è¡Œè¯´æ˜ï¼ŒMINIX 1.0 ç‰ˆæœ¬çš„æ–‡ä»¶ç³»ç»Ÿä¼¼ä¹æ˜¯å¯¹æ¯ä¸ªç›®å½•é¡¹å ç”¨ 16 å­—èŠ‚çš„ã€‚</p><p>è¿™é‡Œæä¾›ä¸€ä¸ª Linux 0.11 ç‰ˆæœ¬çš„ä»¿çœŸè¿è¡Œç»“æœä»¥ä¾›è¯æ˜<br><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwnuexcwx7j30nw0c8745.jpg" alt=""></p><p>ä¸Šé¢æè¿°çš„ <code>disk.img</code> æ˜¯åœ¨ Ubuntu 16.04 LTS ä¸‹è·‘å‡ºæ¥çš„ç»“æœï¼Œæ‰€æœ‰ç¡®å®å‡ºç°äº†ä¸€äº›å·®åˆ«ã€‚<br>è‡³äºå…·ä½“çš„ä¸€ä¸ªè§„èŒƒï¼Œç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰€æœ‰è¿™éƒ¨åˆ†åªèƒ½åšæ¨¡ç³Šå¤„ç†äº†ï¼Œå‹¿æ€ªã€‚</p></blockquote><p>å‰2ä¸ªå­—èŠ‚ç”¨æ¥è¡¨ç¤ºè¯¥ç›®å½•é¡¹æ‰€å¯¹åº”çš„ i èŠ‚ç‚¹ç¼–å·ã€‚ä¹‹åçš„30ä¸ªå­—èŠ‚ç”¨æ¥æè¿°è¯¥ç›®å½•é¡¹çš„åå­—ã€‚</p><p>å› æ­¤ï¼Œå¯¹ 0x2800 ~ 0x2860 çš„æ•°æ®è¿›è¡Œé‡å»ºçš„ç»“æœå°±æ˜¯ <code>. .. hello.c</code> ä¸‰ä¸ªç›®å½•é¡¹äº†ã€‚å…¶ä¸­ï¼Œç”±äºæ˜¯æ ¹ç›®å½•ï¼Œ<code>.</code> å’Œ <code>..</code> æ‰€æŒ‡å‘çš„ièŠ‚ç‚¹çš„ç›¸åŒçš„ï¼Œéƒ½æ˜¯1å·ièŠ‚ç‚¹ã€‚</p><p>è€Œ hello.c æ–‡ä»¶æŒ‡å‘çš„æ˜¯ 2 å·ièŠ‚ç‚¹ã€‚</p><p>å“ˆå“ˆï¼Œ2å·ièŠ‚ç‚¹çš„æ•°æ®å†…å®¹å°±åœ¨ 0x2c00 å¼€å§‹çš„ä½ç½®ã€‚é€šè¿‡å³ä¾§çš„ ASCII ç»“æœæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ã€‚</p><p>å½“ç„¶ï¼Œä¹‹å‰è¯´è¿‡æ¯ä¸ªæ•°æ®å—æ˜¯ 1024 B ï¼Œé‚£ä¹ˆæ•°æ®å—å¤šä½™çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ç•™ç©ºå’¯ï¼Œè€Œä¸ä¼šè¢«å…¶å®ƒièŠ‚ç‚¹å ç”¨(é™¤éè¯¥æ–‡ä»¶orç›®å½•è¢«å®Œå…¨ç§»é™¤äº†)</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæ–‡ä»¶ç³»ç»Ÿå®è§‚çš„æè¿°å°±å·²ç»å®Œç»“äº†ã€‚</p><p>ä¸‹ä¸€èŠ‚å°†å¯¹æ“ä½œç³»ç»Ÿå¦‚ä½•ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæè¿°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç”¨æƒ¯äº†ç±» Unix ç³»ç»Ÿï¼Œåº”è¯¥è¯´æ–‡ä»¶ç³»ç»Ÿæ˜¯æ—¥å¸¸æœ€å¸¸æ¥è§¦çš„ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ¨¡å—ä¹‹ä¸€äº†ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; ls&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Applications Network      Users        bin          data         etc          net          sbin         usr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Library      System       Volumes      cores        dev          home         private      tmp          var&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œç©¶ç«Ÿä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿ? ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ç³»ç»Ÿ? éš¾é“æ–‡ä»¶ä¸æ˜¯ç®€å•åœ°å­˜å‚¨åˆ°å­˜å‚¨è®¾å¤‡ä¸€å—è¿ç»­åŒºåŸŸçš„å—?&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="File System" scheme="https://DorMOUSE-None.github.io/tags/File-System/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (4) - ä»»åŠ¡è°ƒåº¦</title>
    <link href="https://DorMOUSE-None.github.io/2018-10-12-understand-Kernel-4/"/>
    <id>https://DorMOUSE-None.github.io/2018-10-12-understand-Kernel-4/</id>
    <published>2018-10-12T01:36:23.239Z</published>
    <updated>2018-10-13T02:22:59.351Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é¢å‡ èŠ‚å·²ç»æè¿°è¿‡ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ã€‚CPU å°±å¤„äºä¸æ–­åœ°æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(æˆ–è€…é€šè¿‡ <code>hlt</code> æŒ‡ä»¤ç›´æ¥åœæ­¢å·¥ä½œ)ã€‚</p><p>é’ˆå¯¹äºæ¯ä¸€ä¸ªç¨‹åºæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯é€šè¿‡ CPU ä¸­å‡ ç»„å¯„å­˜å™¨(é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ç­‰) å’Œå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®åä½œå®Œæˆçš„ã€‚</p><p>å¦‚æœè¦è¾¾åˆ°å•æ ¸å¤šä»»åŠ¡çš„ç›®çš„ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å®Œæˆå¯¹å‡ ç»„å¯„å­˜å™¨ä¸­å½“å‰å€¼çš„ä¿å­˜(æˆ‘ç§°ä¹‹ä¸ºä¿å­˜ç°åœº)ã€‚è€Œå¯¹äºå†…å­˜æ¥è¯´ï¼Œå¤šä¸ªä»»åŠ¡çš„ä»£ç ã€æ•°æ®åŒæ—¶å­˜åœ¨å†…å­˜æ˜¯å®Œå…¨åˆç†ä¸”å¯è¡Œçš„ã€‚æ¯•ç«Ÿç›¸è¾ƒäºæœ‰é™çš„å¯„å­˜å™¨ï¼Œå†…å­˜å®åœ¨æ˜¯å¤ªå¤§äº†(ç›¸å¯¹è€Œè¨€)ã€‚</p><a id="more"></a><h2 id="ä»»åŠ¡è°ƒåº¦çš„å®è§‚æè¿°"><a href="#ä»»åŠ¡è°ƒåº¦çš„å®è§‚æè¿°" class="headerlink" title="ä»»åŠ¡è°ƒåº¦çš„å®è§‚æè¿°"></a>ä»»åŠ¡è°ƒåº¦çš„å®è§‚æè¿°</h2><p>ä»å®è§‚ä¸Šæ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿç»´æŠ¤äº†è‹¥å¹²ä¸ªä»»åŠ¡(å‡è®¾æœ‰ 0, 1, 5, 6)ã€‚</p><p>ä¸‹é¢ä»¥ä¸€ä¸ªå‡è±¡çš„ä¾‹å­æ¥å¯¹ä»»åŠ¡è°ƒåº¦åšä¸€äº›å½¢è±¡çš„è¯´æ˜:</p><ol><li><p>å‡è®¾å½“å‰ä»»åŠ¡æ˜¯ä»»åŠ¡ 5 ï¼Œæ“ä½œç³»ç»Ÿåˆ†é…ç»™å®ƒçš„ CPU ä½¿ç”¨æ—¶é—´æ˜¯ 30msã€‚</p></li><li><p>æ¯ 10ms è®¡æ—¶å™¨(Intel 8253, å¯ç¼–ç¨‹è®¡æ•°å™¨/å®šæ—¶å™¨) å‘ CPU å‘èµ·ä¸€ä¸ªæ—¶é’Ÿä¸­æ–­ã€‚</p></li><li><p>CPU å¼€å§‹å¤„ç†æ—¶é’Ÿä¸­æ–­(æ­¤æ—¶æ˜¯<strong>å†…æ ¸æ€</strong>)ã€‚å½“å‰ä»»åŠ¡å‰©ä½™å¯ç”¨æ—¶é—´ -10msã€‚</p></li><li><p>æ£€æŸ¥å½“å‰ä»»åŠ¡çš„å‰©ä½™æ—¶é—´ç‰‡ï¼Œæœ‰å‰©ä½™ -&gt; æ­¥éª¤ 5 ; å¦åˆ™ -&gt; æ­¥éª¤ 6 </p></li><li><p>ç›´æ¥é€€å‡ºå¯¹æ—¶é’Ÿä¸­æ–­çš„å¤„ç†å‡½æ•°(å›åˆ° <strong>ç”¨æˆ·æ€</strong>), é‡å¤æ­¥éª¤ 1 </p></li><li><p>æ ¹æ®æ¯ä¸ªä»»åŠ¡çš„ä¼˜å…ˆçº§åŠå…¶å®ƒä¸€äº›å› ç´ ç¡®å®šæŠŠæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´åˆ†é…ç»™å“ªä¸ªä»»åŠ¡ã€‚(å‡è®¾åˆ†é…ç»™ä»»åŠ¡ 6 ï¼Œ30ms çš„ CPU ä½¿ç”¨æ—¶é—´) -&gt; é‡å¤æ­¥éª¤ 2 ã€‚</p></li></ol><p>å½“ç„¶ï¼Œä¸Šé¢çš„æè¿°ä¸­å¿½ç•¥äº†å¾ˆå¤šçš„å› ç´ ã€‚</p><h2 id="ä»»åŠ¡è°ƒåº¦å‡†å¤‡é˜¶æ®µ"><a href="#ä»»åŠ¡è°ƒåº¦å‡†å¤‡é˜¶æ®µ" class="headerlink" title="ä»»åŠ¡è°ƒåº¦å‡†å¤‡é˜¶æ®µ"></a>ä»»åŠ¡è°ƒåº¦å‡†å¤‡é˜¶æ®µ</h2><p>è¿™é‡Œéƒ½å°†ä»¥ Linux 0.11 ç‰ˆæœ¬ä»£ç ä½œä¸ºå®ä¾‹ã€‚å½“ç„¶ï¼Œå…¶ä¸­ä¸€äº›ä»£ç ä¸ºäº†é€‚åº”ç°åœ¨çš„ GCC åšäº†ä¸€äº›ä¿®æ”¹ï¼Œå¦å¤–è¿˜å¯èƒ½ç›´æ¥æ‘†å‡º GCC ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç æ¥è§£é‡Šè¯´æ˜ã€‚</p><p>é¦–å…ˆï¼Œå†…æ ¸ä»£ç åœ¨ç»è¿‡ä¸€ç³»åˆ—çš„å‡†å¤‡æµç¨‹(åŒ…æ‹¬è®¾ç½®ä¸€äº›å¯„å­˜å™¨ä»¥åŠåœ¨å†…å­˜ä¸­æš‚å­˜æŸäº›å€¼ï¼Œè¯»å–è®¡ç®—æœºçš„ç¡¬ä»¶é…ç½®ç­‰)ã€‚çœŸæ­£å¼€å§‹å‡ºç°ä»»åŠ¡ 0 å§‹äºä¸‹åˆ—è¿™æ®µä»£ç :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ¥è‡ª Linux0.11 init/main.c */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">sched_init();       <span class="comment">/* schedule, é¡¾åæ€ä¹‰å°±æ˜¯æ—¶é—´å®‰æ’å’¯ */</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">sti();</span><br><span class="line">move_to_user_mode();</span><br><span class="line"><span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(;;) pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ“ä½œç³»ç»Ÿçš„ä¸»å‡½æ•°ä¸­ï¼Œå¼€å§‹å¯¹ä»»åŠ¡è°ƒåº¦è¿›è¡Œä¸€å®šçš„å‡†å¤‡å·¥ä½œã€‚çœ‹çœ‹å…·ä½“ä»£ç å§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è¿™é‡Œç»™å‡ºçš„æ˜¯ Linux0.11 kernel/sched.c ç»è¿‡é¢„ç¼–è¯‘çš„å‡½æ•°(é‡Œé¢æœ‰ä¸€äº›å†…è”æ±‡ç¼–) */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sched_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> * <span class="title">p</span>;</span>    <span class="comment">/* å£°æ˜ä¸€ä¸ªæè¿°ç¬¦æŒ‡é’ˆ */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">sizeof</span>(struct sigaction) != <span class="number">16</span>)</span><br><span class="line">        panic(<span class="string">"Struct sigaction MUST be 16 bytes"</span>);</span><br><span class="line">    __asm__ (                           <span class="comment">/* è¿™æ®µæ˜¯ä¸ºäº†è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨GDTçš„ç¬¬4é¡¹ï¼Œæ˜¯ä¸€ä¸ª 0 å·ä»»åŠ¡(å½“å‰ä»»åŠ¡)çš„ä»»åŠ¡è°ƒç”¨é—¨*/</span></span><br><span class="line">            <span class="string">"movw $104,%1\n\t"</span> </span><br><span class="line">            <span class="string">"movw %%ax,%2\n\t"</span> </span><br><span class="line">            <span class="string">"rorl $16,%%eax\n\t"</span> </span><br><span class="line">            <span class="string">"movb %%al,%3\n\t"</span> </span><br><span class="line">            <span class="string">"movb $"</span> <span class="string">"0x89"</span> <span class="string">",%4\n\t"</span> </span><br><span class="line">            <span class="string">"movb $0x00,%5\n\t"</span> </span><br><span class="line">            <span class="string">"movb %%ah,%6\n\t"</span> </span><br><span class="line">            <span class="string">"rorl $16,%%eax"</span> </span><br><span class="line">            ::<span class="string">"a"</span> (&amp;(init_task.task.tss)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+<span class="number">4</span>)))), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+<span class="number">4</span>))+<span class="number">2</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+<span class="number">4</span>))+<span class="number">4</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+<span class="number">4</span>))+<span class="number">5</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+<span class="number">4</span>))+<span class="number">6</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+<span class="number">4</span>))+<span class="number">7</span>)) </span><br><span class="line">            );</span><br><span class="line">    __asm__ (                           <span class="comment">/* è¿™é‡Œè®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨çš„ç¬¬5é¡¹ï¼Œ0å·ä»»åŠ¡çš„å±€éƒ¨æè¿°ç¬¦è¡¨åŸºå€é€‰æ‹©ç¬¦ */</span></span><br><span class="line">            <span class="string">"movw $104,%1\n\t"</span> </span><br><span class="line">            <span class="string">"movw %%ax,%2\n\t"</span> </span><br><span class="line">            <span class="string">"rorl $16,%%eax\n\t"</span> </span><br><span class="line">            <span class="string">"movb %%al,%3\n\t"</span> </span><br><span class="line">            <span class="string">"movb $"</span> <span class="string">"0x82"</span> <span class="string">",%4\n\t"</span> </span><br><span class="line">            <span class="string">"movb $0x00,%5\n\t"</span> </span><br><span class="line">            <span class="string">"movb %%ah,%6\n\t"</span> </span><br><span class="line">            <span class="string">"rorl $16,%%eax"</span> </span><br><span class="line">            ::<span class="string">"a"</span> (&amp;(init_task.task.ldt)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+(<span class="number">4</span> +<span class="number">1</span>))))), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+(<span class="number">4</span> +<span class="number">1</span>)))+<span class="number">2</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+(<span class="number">4</span> +<span class="number">1</span>)))+<span class="number">4</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+(<span class="number">4</span> +<span class="number">1</span>)))+<span class="number">5</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+(<span class="number">4</span> +<span class="number">1</span>)))+<span class="number">6</span>)), <span class="string">"m"</span> (*(((<span class="keyword">char</span> *) (gdt+(<span class="number">4</span> +<span class="number">1</span>)))+<span class="number">7</span>)) </span><br><span class="line">            );</span><br><span class="line">    p = gdt+<span class="number">2</span>+<span class="number">4</span>;        <span class="comment">/* æè¿°ç¬¦æŒ‡é’ˆæŒ‡å‘ GDT ç¬¬6é¡¹ã€‚å› ä¸ºå‰é¢å·²ç»å ç”¨äº†ç¬¬4ï¼Œ5é¡¹ã€‚ç”±å†…æ ¸å ç”¨äº† 0ï¼Œ1ï¼Œ2ï¼Œ3ã€‚*/</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;<span class="number">64</span>;i++) &#123;         <span class="comment">/* å¾ªç¯ 63 æ¬¡ï¼Œè¿™æ˜¯ Linux0.11 æœ€å¤§æ”¯æŒ 64 ä¸ªä»»åŠ¡åŒæ—¶å­˜åœ¨ã€‚å½“å‰ä»»åŠ¡å·²ç»å äº†ä¸€ä¸ªä»»åŠ¡äº†*/</span></span><br><span class="line">        task[i] = ((<span class="keyword">void</span> *) <span class="number">0</span>); <span class="comment">/* 63ä¸ªä»»åŠ¡æŒ‡é’ˆå…¨éƒ¨å€¼ä¸º NULL */</span></span><br><span class="line">        p-&gt;a=p-&gt;b=<span class="number">0</span>;            <span class="comment">/* GDT ç´¯ç§¯ 126 é¡¹(126 * 8 å­—èŠ‚)å…¨éƒ¨ç½®ä¸º 0 ã€‚æ¯ä¸ªä»»åŠ¡å ç”¨ GDT ä¸¤é¡¹ï¼Œä¸€ä¸ºä»»åŠ¡é—¨ï¼Œä¸€ä¸ºå±€éƒ¨æè¿°ç¬¦è¡¨é€‰æ‹©ç¬¦*/</span></span><br><span class="line">        p++;</span><br><span class="line">        p-&gt;a=p-&gt;b=<span class="number">0</span>;</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __asm__(<span class="string">"pushfl ; andl $0xffffbfff,(%esp) ; popfl"</span>);</span><br><span class="line">    __asm__(<span class="string">"ltr %%ax"</span>::<span class="string">"a"</span> (((((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="number">0</span>)&lt;&lt;<span class="number">4</span>)+(<span class="number">4</span>&lt;&lt;<span class="number">3</span>))));           <span class="comment">/* load Task Register TR è®°å½•å½“å‰ä»»åŠ¡é—¨ä¸º gdt ç¬¬4é¡¹ */</span></span><br><span class="line">    __asm__(<span class="string">"lldt %%ax"</span>::<span class="string">"a"</span> (((((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="number">0</span>)&lt;&lt;<span class="number">4</span>)+((<span class="number">4</span> +<span class="number">1</span>)&lt;&lt;<span class="number">3</span>))));     <span class="comment">/* load Local Descriptor Table Register LDTR è®°å½•å½“å‰é€‰æ‹©ç¬¦ä¸º gdt ç¬¬5é¡¹ */</span></span><br><span class="line">    <span class="comment">/* ç»™8253èŠ¯ç‰‡ç¼–ç¨‹ï¼Œæ¯ 10ms å‘èµ·ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­(ä¸‹é¢3è¡Œçš„å·¥ä½œ) */</span></span><br><span class="line">    __asm__ (<span class="string">"outb %%al,%%dx\n"</span> <span class="string">"\tjmp 1f\n"</span> <span class="string">"1:\tjmp 1f\n"</span> <span class="string">"1:"</span>::<span class="string">"a"</span> (<span class="number">0x36</span>),<span class="string">"d"</span> (<span class="number">0x43</span>));   </span><br><span class="line">    __asm__ (<span class="string">"outb %%al,%%dx\n"</span> <span class="string">"\tjmp 1f\n"</span> <span class="string">"1:\tjmp 1f\n"</span> <span class="string">"1:"</span>::<span class="string">"a"</span> ((<span class="number">1193180</span>/<span class="number">100</span>) &amp; <span class="number">0xff</span>),<span class="string">"d"</span> (<span class="number">0x40</span>));</span><br><span class="line">    __asm__ (<span class="string">"outb %%al,%%dx"</span>::<span class="string">"a"</span> ((<span class="number">1193180</span>/<span class="number">100</span>) &gt;&gt; <span class="number">8</span>),<span class="string">"d"</span> (<span class="number">0x40</span>));</span><br><span class="line">    __asm__ (<span class="string">"movw %%dx,%%ax\n\t"</span> <span class="string">"movw %0,%%dx\n\t"</span> <span class="string">"movl %%eax,%1\n\t"</span> <span class="string">"movl %%edx,%2"</span> : : <span class="string">"i"</span> ((<span class="keyword">short</span>) (<span class="number">0x8000</span>+(<span class="number">0</span>&lt;&lt;<span class="number">13</span>)+(<span class="number">14</span>&lt;&lt;<span class="number">8</span>))), <span class="string">"o"</span> (*((<span class="keyword">char</span> *) (&amp;idt[<span class="number">0x20</span>]))), <span class="string">"o"</span> (*(<span class="number">4</span>+(<span class="keyword">char</span> *) (&amp;idt[<span class="number">0x20</span>]))), <span class="string">"d"</span> ((<span class="keyword">char</span> *) (&amp;timer_interrupt)),<span class="string">"a"</span> (<span class="number">0x00080000</span>)); <span class="comment">/* åœ¨ IDT ä¸­è®¾ç½®æ—¶é’Ÿä¸­æ–­æè¿°ç¬¦é¡¹ï¼Œç¬¬32é¡¹ä¸ºæ—¶é’Ÿä¸­æ–­*/</span></span><br><span class="line">    __asm__ (<span class="string">"outb %%al,%%dx"</span>::<span class="string">"a"</span> ((&#123; <span class="keyword">unsigned</span> <span class="keyword">char</span> _v; __asm__ <span class="keyword">volatile</span> (<span class="string">"inb %%dx,%%al\n"</span> <span class="string">"\tjmp 1f\n"</span> <span class="string">"1:\tjmp 1f\n"</span> <span class="string">"1:"</span>:<span class="string">"=a"</span> (_v):<span class="string">"d"</span> (<span class="number">0x21</span>)); _v; &#125;)&amp;~<span class="number">0x01</span>),<span class="string">"d"</span> (<span class="number">0x21</span>)); <span class="comment">/*é‡æ–°è®¾ç½®æ—¶é’Ÿä¸­æ–­çš„å¯å±è”½å±æ€§ï¼Œè¿™æ ·å°±å¯åœ¨è°ƒç”¨ hlt åè¢«æ—¶é’Ÿä¸­æ–­å”¤é†’ */</span></span><br><span class="line">    __asm__ (<span class="string">"movw %%dx,%%ax\n\t"</span> <span class="string">"movw %0,%%dx\n\t"</span> <span class="string">"movl %%eax,%1\n\t"</span> <span class="string">"movl %%edx,%2"</span> : : <span class="string">"i"</span> ((<span class="keyword">short</span>) (<span class="number">0x8000</span>+(<span class="number">3</span>&lt;&lt;<span class="number">13</span>)+(<span class="number">15</span>&lt;&lt;<span class="number">8</span>))), <span class="string">"o"</span> (*((<span class="keyword">char</span> *) (&amp;idt[<span class="number">0x80</span>]))), <span class="string">"o"</span> (*(<span class="number">4</span>+(<span class="keyword">char</span> *) (&amp;idt[<span class="number">0x80</span>]))), <span class="string">"d"</span> ((<span class="keyword">char</span> *) (&amp;system_call)),<span class="string">"a"</span> (<span class="number">0x00080000</span>)); <span class="comment">/* åœ¨ IDT ä¸­è®¾ç½®ç³»ç»Ÿä¸­æ–­ï¼Œç¬¬128é¡¹ä¸ºæ—¶é’Ÿä¸­æ–­ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ‰§è¡Œ <code>sched_init()</code> ï¼Œæ“ä½œç³»ç»Ÿå¼€å§‹æœ‰äº†ä»»åŠ¡çš„æ¦‚å¿µã€‚å¹¶ä¸”æŠŠå½“å‰ä»»åŠ¡ä½œä¸ºä»»åŠ¡ 0 æ¥åŠ ä»¥è®¤è¯†ã€‚</p><p>åŒæ—¶ï¼Œé¢„ç½®äº† 64 ä¸ªä»»åŠ¡çŠ¶æ€æ•°ç»„ï¼Œç”¨æ¥è¾…åŠ©ä»»åŠ¡è°ƒåº¦å™¨å®Œæˆæœªæ¥è°ƒåº¦ä»»åŠ¡æ—¶ç¡®è®¤ç›®å‰æ‰€æœ‰ä»»åŠ¡çš„åŸºç¡€æ€§æ”¯æŒã€‚</p><p>æœ€é‡è¦çš„ï¼Œå½“ç„¶æ˜¯å¯¹ 8253 èŠ¯ç‰‡çš„ç¼–ç¨‹ï¼Œä½¿å…¶æ¯ 10ms å‘ CPU å‘èµ·ä¸€ä¸ªç¡¬ä»¶æ—¶é’Ÿä¸­æ–­ã€‚ç”±æ­¤å°†æŠŠç³»ç»Ÿæš‚æ—¶æ€§çš„å¸¦å…¥<strong>å†…æ ¸æ€</strong> æ¥å®Œæˆ CPU ä¸‹ä¸€ä¸ª 10ms éœ€è¦è¿›è¡Œçš„ä»»åŠ¡çš„å†³ç­–å·¥ä½œã€‚</p><p>æœ€åçš„è®¾ç½®æ—¶é’Ÿä¸­æ–­æè¿°ç¬¦å’Œç³»ç»Ÿä¸­æ–­æè¿°ç¬¦è‡ªä¸ç”¨è¯´ã€‚ä¸è®¾ç½®çš„è¯ï¼Œå¯¹äºæ¥æ”¶åˆ°çš„ä¸­æ–­æ ¹æœ¬å°±æ²¡åŠæ³•ç¡®è®¤å¤„ç†ä¸­æ–­çš„ä»£ç åœ¨å“ª(æ¯•ç«Ÿä¸­æ–­å¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç”± CPU æ‰§è¡ŒæŒ‡ä»¤æ¥è§£å†³çš„)</p><h2 id="ä»»åŠ¡è°ƒåº¦å®æ–½é˜¶æ®µ"><a href="#ä»»åŠ¡è°ƒåº¦å®æ–½é˜¶æ®µ" class="headerlink" title="ä»»åŠ¡è°ƒåº¦å®æ–½é˜¶æ®µ"></a>ä»»åŠ¡è°ƒåº¦å®æ–½é˜¶æ®µ</h2><p>ç”±äºæ—¶é’Ÿä¸­æ–­æ˜¯ç”±ç¡¬ä»¶èŠ¯ç‰‡è¿›è¡Œæ§åˆ¶ï¼Œæ ¹æœ¬ä¸ä¼šé¡¾åŠå½“å‰ CPU æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å·²ç»æ‰§è¡Œåˆ°äº†å“ªä¸ªæŒ‡ä»¤ (å“ˆå“ˆï¼Œè¿™ä¸å¾—æ˜¯å½“ç„¶çš„å˜›ï¼Œä¸ç„¶è¦ä»»åŠ¡è°ƒåº¦åšä»€ä¹ˆï¼Œæ‰€æœ‰ä»»åŠ¡æµæ°´çº¿ä½œä¸šå¾—äº†)ã€‚</p><p>å› æ­¤ï¼Œä¸‹é¢çš„æè¿°å°†å€Ÿç€ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­ï¼Œæ¥çœ‹ä¸€ä¸‹æ•´ä¸€ä¸ªä»»åŠ¡è°ƒåº¦æ“ä½œã€‚</p><h3 id="å®šä½æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘"><a href="#å®šä½æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘" class="headerlink" title="å®šä½æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘"></a>å®šä½æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘</h3><p>Intel 8253èŠ¯ç‰‡å‘èµ·æ—¶é’Ÿä¸­æ–­ä¹‹åï¼ŒCPU ç«‹å³å¼€å§‹å¤„ç†è¯¥ä¸­æ–­</p><ol><li><p>é€šè¿‡ IDTR èŠ¯ç‰‡æŸ¥æ‰¾ä¸­æ–­æè¿°ç¬¦è¡¨(IDT, æœ€å¤š256é¡¹ï¼Œæ¯é¡¹8å­—èŠ‚) çš„åŸºå€ã€‚</p></li><li><p>ç»“åˆä¸­æ–­å·ä½œä¸ºåç§»é‡ï¼Œå®šä½è¡¨ä¸­æŸä¸€é¡¹å…·ä½“çš„ä¸­æ–­æè¿°ç¬¦ (æ—¶é’Ÿä¸­æ–­æ˜¯0x20ï¼Œå› æ­¤åç§»å°±æ˜¯ 0x20 * 8 = 256)</p></li></ol><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fw51zkvo2nj313q0mm3z3.jpg" alt=""><br><small>Copied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</small></p><ol start="3"><li>æ¯ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦é¡¹éƒ½å°†æ˜¯ä»»åŠ¡é—¨ï¼Œä¸­æ–­é—¨ï¼Œé™·é˜±é—¨ä¸‰ç±»ä¸­çš„ä¸€ç±»ï¼Œå…¶æ‰€å ç”¨çš„ 8 å­—èŠ‚æ•°æ®å°†æŒ‰å¦‚ä¸‹çš„å½¢å¼è¿›è¡Œå­˜å‚¨</li></ol><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fw527o8903j314614ita0.jpg" alt=""><br><small>Copied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</small></p><ol start="4"><li>æ—¶é’Ÿä¸­æ–­æ˜¯ä¸€ç§ä¸­æ–­é—¨ï¼Œå¯ä»¥çœ‹åˆ°ä½ 0~15 ä½å’Œé«˜ 48~63 ä½å…±åŒç»„æˆäº†æ®µå†…åç§»é‡ï¼Œè€Œä½16~31ä½ç»„æˆäº†ä¸€ä¸ªæ®µé€‰æ‹©ç¬¦(å¯ä»¥å» GDT æ‰¾åˆ°ç›¸åº”çš„æ®µ)ã€‚</li></ol><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fw52a4jbe0j31440zeq3j.jpg" alt=""><br><small>Copied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</small></p><ol start="5"><li>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä½åˆ°å¤„ç†æ—¶é’Ÿä¸­æ–­çš„ä»£ç ç©¶ç«Ÿåœ¨å‘¢ã€‚ä¹‹åä¹Ÿå°±æ˜¯æ™®é€šçš„ CPU ç»§ç»­æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(å½“ç„¶ï¼Œéœ€è¦æ³¨æ„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ³¨æ„å½“å‰æ®µé€‰æ‹©ç¬¦æ‰€è¡¨ç¤ºçš„ DPL=0 ï¼Œå³å·²ç»è¿›å…¥äº†å†…æ ¸æ€)</li></ol><h3 id="æ¨¡æ¿å¼çš„ä¿å­˜ç°åœº-timer-interrupt"><a href="#æ¨¡æ¿å¼çš„ä¿å­˜ç°åœº-timer-interrupt" class="headerlink" title="æ¨¡æ¿å¼çš„ä¿å­˜ç°åœº timer_interrupt"></a>æ¨¡æ¿å¼çš„ä¿å­˜ç°åœº timer_interrupt</h3><p>åœ¨ä¸Šä¸€å°èŠ‚ç¬¬ 5 æ­¥å®šä½æ—¶é’Ÿä¸­æ–­çš„ä»£ç æ—¶ï¼Œç”±äºå‘ç”Ÿäº†ç‰¹æƒçº§çš„åˆ‡æ¢ï¼Œå› æ­¤ä¸­æ–­å¤„ç†æµç¨‹ä¼šè‡ªåŠ¨åœ°åœ¨æ–°çš„æ ˆ(è¿™é‡ŒæŒ‡å¤„ç†æ—¶é’Ÿä¸­æ–­ä½¿ç”¨çš„å†…æ ¸æ ˆ)ä¸­ä¿å­˜åŸæ¥ä»»åŠ¡çš„ä¿¡æ¯ï¼Œä¾æ¬¡å…¥æ–°æ ˆçš„æ•°æ®æœ‰åŸä»»åŠ¡çš„ SS, ESP, EFLAGS, CS, EIP, (Error Code) ã€‚</p><p>ç„¶åå°†æ­£å¼è¿›å…¥åˆ° IDT å®šä½çš„æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘çš„å¼€å§‹ä½ç½® (å½“ç„¶äº†ï¼Œåˆ°è¿™é‡Œä¹Ÿè¿˜æ˜¯åœ¨ä¿å­˜ç°åœºã€‚æ¯•ç«Ÿè¿˜æœ‰å¥½å¤šå¯„å­˜å™¨çš„æ•°æ®è¦ä¿å­˜çš„)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.align 4</span><br><span class="line">_timer_interrupt:</span><br><span class="line">push %ds# save ds,es and put kernel data space</span><br><span class="line">push %es# into them. %fs is used by _system_call</span><br><span class="line">push %fs</span><br><span class="line">pushl %edx# we save %eax,%ecx,%edx as gcc doesn&apos;t</span><br><span class="line">pushl %ecx# save those across function calls. %ebx</span><br><span class="line">pushl %ebx# is saved as we use that in ret_sys_call</span><br><span class="line">pushl %eax</span><br><span class="line">movl $0x10,%eax # 0x10 æ˜¯å†…æ ¸æ•°æ®æ®µé€‰æ‹©ç¬¦ï¼Œå³ GDT ç¬¬äºŒé¡¹</span><br><span class="line">mov %ax,%ds</span><br><span class="line">mov %ax,%es</span><br><span class="line">movl $0x17,%eax # 0x17 æ˜¯å½“å‰ä»»åŠ¡æ•°æ®æ®µé€‰æ‹©ç¬¦ï¼ŒLDT ç¬¬äºŒé¡¹ (åŒºåˆ†é€‰æ‹©ç¬¦æ˜¯ä½¿ç”¨ GDT or LDT ï¼Œçœ‹ val &amp; 0x4 çš„ç»“æœï¼Œå¦‚æœä¸º 1 ä½¿ç”¨ LDTï¼Œå¦åˆ™ GDT</span><br><span class="line">mov %ax,%fs</span><br><span class="line">incl _jiffies   # åæ­£æ¯æ¬¡æ—¶é’Ÿä¸­æ–­ +1 ï¼Œæƒ³ä¸åˆ°åˆé€‚çš„ä¸­æ–‡ç¿»è¯‘</span><br><span class="line">movb $0x20,%al# EOI to interrupt controller #1 å‘é€æŒ‡ä»¤è¯·æ±‚ç¡¬ä»¶ç»“æŸè¿™æ¬¡æ—¶é’Ÿä¸­æ–­çš„æŠ¥å‘Š</span><br><span class="line">outb %al,$0x20</span><br><span class="line">movl CS(%esp),%eax  # è¿™ä¸ª CS æ˜¯ä¸ªå¸¸é‡ï¼Œå–å‡ºå†…æ ¸æ ˆæš‚å­˜çš„åŸæ¥æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çš„ä»£ç æ®µé€‰æ‹©ç¬¦</span><br><span class="line">andl $3,%eax# %eax is CPL (0 or 3, 0=supervisor)    åˆ¤æ–­ä¸€ä¸‹åœ¨ä¸­æ–­å¼€å§‹å‰ä»£ç çš„ç‰¹æƒçº§ 0 æ˜¯å†…æ ¸æ€ï¼Œ3 æ˜¯ç”¨æˆ·æ€</span><br><span class="line">pushl %eax</span><br><span class="line">call _do_timer# è°ƒç”¨ do_timer(long CPL) ã€‚çœŸæ­£çš„å¤„ç†æ—¶é’Ÿä¸­æ–­</span><br><span class="line">addl $4,%esp# task switching to accounting ...</span><br><span class="line">jmp ret_from_sys_call</span><br></pre></td></tr></table></figure><h3 id="ä»»åŠ¡è°ƒåº¦-do-timer"><a href="#ä»»åŠ¡è°ƒåº¦-do-timer" class="headerlink" title="ä»»åŠ¡è°ƒåº¦ do_timer"></a>ä»»åŠ¡è°ƒåº¦ do_timer</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_timer</span><span class="params">(<span class="keyword">long</span> cpl)</span>     <span class="comment">/* è¿™ä¸ª cpl æ˜¯ä¸Šä¸€å°èŠ‚è·å–çš„åŸä»»åŠ¡æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„ç‰¹æƒçº§ */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">int</span> beepcount;       <span class="comment">/* æ‰¬å£°å™¨å‘å£°è®¡æ•° */</span></span><br><span class="line">    <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">sysbeepstop</span><span class="params">(<span class="keyword">void</span>)</span></span>;  <span class="comment">/* å…³é—­æ‰¬å£°å™¨çš„å‡½æ•°å£°æ˜ */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beepcount)              <span class="comment">/* è¿™æ®µé€»è¾‘ä½œç”¨å¾ˆä¸æ¸…æ™°ï¼Œå¯èƒ½æ˜¯å¯Œæœ‰å¹´ä»£æ„Ÿçš„äº§ç‰© */</span></span><br><span class="line">        <span class="keyword">if</span> (!--beepcount)</span><br><span class="line">            sysbeepstop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpl)                    <span class="comment">/* åˆ¤æ–­ç‰¹æƒçº§ ç„¶åç»™å½“å‰ä»»åŠ¡çš„ç”¨æˆ·æ€/å†…æ ¸æ€ç”¨æ—¶è®¡æ•° */</span></span><br><span class="line">        current-&gt;utime++;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        current-&gt;stime++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è¿™æ®µé€»è¾‘æ˜¯ç»™æ“ä½œç³»ç»Ÿå®šæ—¶ä»»åŠ¡ç”¨çš„ï¼Œç”¨å…´è¶£çš„æ¬¢è¿è‡ªå·±å­¦ä¹  */</span></span><br><span class="line">    <span class="keyword">if</span> (next_timer) &#123;</span><br><span class="line">        next_timer-&gt;jiffies--;</span><br><span class="line">        <span class="keyword">while</span> (next_timer &amp;&amp; next_timer-&gt;jiffies &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">void</span> (*fn)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">            fn = next_timer-&gt;fn;</span><br><span class="line">            next_timer-&gt;fn = ((<span class="keyword">void</span> *) <span class="number">0</span>);</span><br><span class="line">            next_timer = next_timer-&gt;next;</span><br><span class="line">            (fn)();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (current_DOR &amp; <span class="number">0xf0</span>)</span><br><span class="line">        do_floppy_timer();</span><br><span class="line">    <span class="keyword">if</span> ((--current-&gt;counter)&gt;<span class="number">0</span>) <span class="keyword">return</span>;     <span class="comment">/* åˆ†é…ç»™å½“å‰ä»»åŠ¡çš„æ—¶é—´ç‰‡ -1 ã€‚å¦‚æœä¸ä¸º0ï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºæ—¶é’Ÿä¸­æ–­ï¼Œè®©ä»»åŠ¡ç»§ç»­æ‰§è¡Œ */</span></span><br><span class="line">    current-&gt;counter=<span class="number">0</span>;     <span class="comment">/* å¦åˆ™ï¼Œå½“å‰ä»»åŠ¡çš„æ—¶é—´ç‰‡è®°ä¸º 0 */</span></span><br><span class="line">    <span class="keyword">if</span> (!cpl) <span class="keyword">return</span>;       <span class="comment">/* å¦‚æœå½“å‰ä»»åŠ¡æ­£å¤„äºå†…æ ¸æ€(æ¯”å¦‚ç”¨æˆ·ç¨‹åºä¸­ä½¿ç”¨äº†ä¸€äº›ç³»ç»Ÿè°ƒç”¨)ï¼Œé‚£ä¹ˆå…ˆè®©è¿™ä¸ªä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œé¿å…ä»»åŠ¡åˆ‡æ¢å¼•èµ·çš„éº»çƒ¦ */</span></span><br><span class="line">    schedule();             <span class="comment">/* ä»»åŠ¡è°ƒç”¨ï¼Œå†³å®šä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡çš„ä¸»äºº */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä»»åŠ¡è°ƒåº¦-schedule"><a href="#ä»»åŠ¡è°ƒåº¦-schedule" class="headerlink" title="ä»»åŠ¡è°ƒåº¦ schedule()"></a>ä»»åŠ¡è°ƒåº¦ schedule()</h3><p>schedule() å°±å¼€å§‹å¯¹ CPU ä¹‹åè¦æŠŠæ—¶é—´ç‰‡åˆ†é…ç»™å“ªä¸ªä»»åŠ¡åšä¸€æ¬¡å†³ç­–äº†ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ç»“æ„ä½“ task_struct </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="keyword">long</span> state;<span class="comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span></span><br><span class="line"><span class="keyword">long</span> counter;</span><br><span class="line"><span class="keyword">long</span> priority;</span><br><span class="line"><span class="keyword">long</span> signal;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sigaction</span>[32];</span></span><br><span class="line"><span class="keyword">long</span> blocked;<span class="comment">/* bitmap of masked signals */</span></span><br><span class="line"><span class="comment">/* various fields */</span></span><br><span class="line"><span class="keyword">int</span> exit_code;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> start_code,end_code,end_data,brk,start_stack;</span><br><span class="line"><span class="keyword">long</span> pid,father,pgrp,session,leader;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> uid,euid,suid;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> gid,egid,sgid;</span><br><span class="line"><span class="keyword">long</span> alarm;</span><br><span class="line"><span class="keyword">long</span> utime,stime,cutime,cstime,start_time;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> used_math;</span><br><span class="line"><span class="comment">/* file system info */</span></span><br><span class="line"><span class="keyword">int</span> tty;<span class="comment">/* -1 if no tty, so it must be signed */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> umask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">pwd</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">root</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">executable</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> close_on_exec;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">filp</span>[<span class="title">NR_OPEN</span>];</span></span><br><span class="line"><span class="comment">/* ldt for this task 0 - zero 1 - cs 2 - ds&amp;ss */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>[3];</span></span><br><span class="line"><span class="comment">/* tss for this task */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tss_struct</span> <span class="title">tss</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åŒ†åŒ†ä¸€ç¥ï¼Œä¸è¿‡æ˜¯ä¸æ˜¯è§‰å¾—æœ‰äº›å˜é‡åè¿˜æ˜¯å¾ˆç†Ÿæ‚‰çš„ï¼Œæ¯”å¦‚è¯´ priority, utime, uid, eid, gid ç­‰ç­‰ã€‚<br>ä½†æ˜¯æš‚æ—¶è¿˜ç”¨ä¸ä¸Šè¿™ä¹ˆå¤šã€‚åªè¦æœ‰ä¸ªæ¦‚å¿µå°±å¥½ã€‚æ“ä½œç³»ç»Ÿé€šè¿‡ä¸Šè¿°è¿™äº›å€¼å…±åŒç»´æŠ¤èµ·äº†ä¸€ä¸ªä»»åŠ¡çš„æ–¹æ–¹é¢é¢çš„ä¿¡æ¯ã€‚</p><p>å…¶ä¸­ï¼Œéœ€è¦å†æ¬¡æ³¨æ„çš„æ˜¯ï¼ŒLinux0.11 ç‰ˆæœ¬æœ€å¤šåªæ”¯æŒ 64 ä¸ªä»»åŠ¡ (è¿™æ˜¯ç¡¬ç¼–ç å†³å®šçš„ä¸Šé™ï¼Œå› ä¸ºè¿™ä¸ª task_struct ç»“æ„å®ä¾‹åªå£°æ˜äº† 64 ä¸ª)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  'schedule()' is the scheduler function. This is GOOD CODE! There</span></span><br><span class="line"><span class="comment"> * probably won't be any reason to change this, as it should work well</span></span><br><span class="line"><span class="comment"> * in all circumstances (ie gives IO-bound processes good response etc).</span></span><br><span class="line"><span class="comment"> * The one thing you might take a look at is the signal-handler code here.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   NOTE!!  Task 0 is the 'idle' task, which gets called when no other</span></span><br><span class="line"><span class="comment"> * tasks can run. It can not be killed, and it cannot sleep. The 'state'</span></span><br><span class="line"><span class="comment"> * information in task[0] is never used.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i,next,c;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> ** <span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* check alarm, wake up any interruptible tasks that have got a signal */</span></span><br><span class="line"><span class="comment">/* æ£€æµ‹ alarm (ä»»åŠ¡å®šæ—¶æŠ¥è­¦ä¿¡å·)ï¼Œå¹¶å”¤é†’å¯ä¸­æ–­çš„ä»»åŠ¡æ¥å®Œæˆé¢„å®šä¹‰çš„å·¥ä½œ, å¥½åƒè‡ªå·±ç”¨å¾—å°‘ï¼Œè¿˜ä¸å¤ªäº†è§£ alarm(xxx) çš„ç»†èŠ‚</span></span><br><span class="line"><span class="comment"> * ä»ä»»åŠ¡ 63 å·å¼€å§‹(æ€»å…± 64 ä¸ªä»»åŠ¡, 0~63) ï¼Œå€’ç€éå†æ‰€æœ‰ä»»åŠ¡ï¼Œæ£€æµ‹ alarm </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span>(p = &amp;LAST_TASK ; p &gt; &amp;FIRST_TASK ; --p)</span><br><span class="line"><span class="keyword">if</span> (*p) &#123;</span><br><span class="line"><span class="keyword">if</span> ((*p)-&gt;alarm &amp;&amp; (*p)-&gt;alarm &lt; jiffies) &#123;</span><br><span class="line">(*p)-&gt;signal |= (<span class="number">1</span>&lt;&lt;(SIGALRM<span class="number">-1</span>));</span><br><span class="line">(*p)-&gt;alarm = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (((*p)-&gt;signal &amp; ~(_BLOCKABLE &amp; (*p)-&gt;blocked)) &amp;&amp;</span><br><span class="line">(*p)-&gt;state==TASK_INTERRUPTIBLE)</span><br><span class="line">(*p)-&gt;state=TASK_RUNNING;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* this is the scheduler proper: */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">c = <span class="number">-1</span>;</span><br><span class="line">next = <span class="number">0</span>;</span><br><span class="line">i = NR_TASKS;   <span class="comment">/* è¿™é‡Œçš„å® NR_TASKS = 64 */</span></span><br><span class="line">p = &amp;task[NR_TASKS];</span><br><span class="line"><span class="keyword">while</span> (--i) &#123;</span><br><span class="line"><span class="keyword">if</span> (!*--p)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">/* é€‰æ‹©ä»»åŠ¡çŠ¶æ€ä¸º å°±ç»ªæ€ï¼Œä¸” counter å€¼æœ€å¤§çš„ä»»åŠ¡å·ä½œä¸ºä¸‹ä¸€ä¸ªå ç”¨ CPU çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">if ((*p)-&gt;state == TASK_RUNNING &amp;&amp; (*p)-&gt;counter &gt; c) </span></span><br><span class="line"><span class="comment">c = (*p)-&gt;counter, next = i;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">        /* å¦‚æœæ²¡æœ‰å…¶å®ƒä»»åŠ¡ï¼Œé‚£ä¹ˆ next = 0 ï¼Œå³æ¥ä¸‹æ¥å ç”¨ cpu çš„ä»»åŠ¡å°±æ˜¯ 0å·ä»»åŠ¡(0å·ä»»åŠ¡ä¸€å®šå­˜åœ¨ï¼Œä¸èƒ½è¢« kill ) */</span></span><br><span class="line"><span class="keyword">if</span> (c) <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/* å¦‚æœ 1~63 å·ä»»åŠ¡(ä¸å­˜åœ¨æˆ–ä¸åœ¨å°±ç»ªæ€)è‡³å°‘å­˜åœ¨ä¸€ä¸ªä»»åŠ¡ï¼Œä¸”æ—¶é—´ç‰‡éƒ½ä¸º 0 ï¼Œé‚£ä¹ˆé‡æ–°è®¡ç®—åˆ†é…ç»™æ¯ä¸ªä»»åŠ¡çš„ counter å€¼ */</span></span><br><span class="line"><span class="keyword">for</span>(p = &amp;LAST_TASK ; p &gt; &amp;FIRST_TASK ; --p)</span><br><span class="line"><span class="keyword">if</span> (*p)</span><br><span class="line">(*p)-&gt;counter = ((*p)-&gt;counter &gt;&gt; <span class="number">1</span>) + (*p)-&gt;priority;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* å°†å½“å‰ä»»åŠ¡åˆ‡æ¢ä¸º next ï¼Œç„¶åå°±å¯ä»¥ä¸€åˆ‡å°±ç»ªï¼Œé€€å‡ºæ—¶é’Ÿä¸­æ–­ï¼Œå°±å˜æˆæ–°çš„å ç”¨cpuçš„ä»»åŠ¡æ¥æ‰§è¡Œäº† */</span></span><br><span class="line">switch_to(next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>switch_to(next)</strong></p><p>switch_to(next) è¿™ä¸ªå‡½æ•°ï¼Œæ˜¯é€šè¿‡å†…åµŒæ±‡ç¼–å†™çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ç»†èŠ‚(è¿™é‡Œé€‰ç”¨ GCC ç¼–è¯‘å‡ºæ¥çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œä¸ç›´æ¥ä½¿ç”¨å†…åµŒæ±‡ç¼–)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># è¿™é‡Œçš„æ±‡ç¼–æŒ‡ä»¤ç´§è·Ÿåœ¨ if(c) break; ä¹‹å</span><br><span class="line">.L36:</span><br><span class="line">movl%ebx, %edx          # è¿™é‡Œ ebx å­˜å‚¨çš„æ˜¯ next å˜é‡çš„å€¼ï¼Œç°åœ¨å¤åˆ¶åˆ° edx ä¸Š</span><br><span class="line">sall$4, %edx            # sallã€addl ä¸¤è¡Œçš„ç›®çš„æ˜¯è®¡ç®—å¾—åˆ°ä¸€ä¸ª TSS é€‰æ‹©ç¬¦ï¼ŒTSS0 åœ¨ GDT æ˜¯ç¬¬4é¡¹ï¼ŒTSS1 åœ¨ GDT æ˜¯ç¬¬ 6 é¡¹ï¼Œç±»æ¨...å…¶ä¸­é€‰æ‹©ç¬¦å3ä½ä¸ºDPLå’Œ GDTR/LDTR é€‰é¡¹</span><br><span class="line">addl$32, %edx</span><br><span class="line">movl_task(,%ebx,4), %ecx    # æ‰¾åˆ° next å·ä»»åŠ¡çš„ task_struct çš„æŒ‡é’ˆ (å­˜å‚¨åœ¨ task[64] çš„æ•°ç»„ä¸­)</span><br><span class="line">#APP</span><br><span class="line"># 141 &quot;sched.c&quot; 1</span><br><span class="line">cmpl %ecx,_current          # ç¡®è®¤æ˜¯ä¸æ˜¯åŸä»»åŠ¡</span><br><span class="line">je 1f                       # æ˜¯çš„è¯ç›´æ¥è·³å‡º (è·³åˆ°æœ€è¿‘çš„æ ‡ç­¾ 1 )</span><br><span class="line">movw %dx,8(%esp)</span><br><span class="line">xchgl %ecx,_current         # äº¤æ¢ ecx å’Œ _current å­˜å‚¨çš„å€¼</span><br><span class="line">ljmp 4(%esp)                # é€šè¿‡é—´æ¥è·³è½¬å®Œæˆä»»åŠ¡åˆ‡æ¢ã€‚é€šç”¨çš„å½¢å¼æ˜¯ jmp CS:IPï¼Œä½†æ˜¯ä½¿ç”¨é—´æ¥è·³è½¬ï¼Œåœ¨å†…å­˜ä¸­çš„å€¼å…ˆè¯»å– 32 ä½åç§»é‡ï¼Œå†è¯» 16 ä½æ®µé€‰æ‹©ç¬¦</span><br><span class="line">cmpl %ecx,_last_task_used_math</span><br><span class="line">jne 1f</span><br><span class="line">clts                        # æ¸…é™¤ CR0 å¯„å­˜å™¨ä¸­çš„ TS Flag </span><br><span class="line">1:</span><br><span class="line"># 0 &quot;&quot; 2</span><br><span class="line">#NO_AP</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µç¨‹åºæœ‰å¿…è¦å°†å®ƒå‰²è£‚æˆä¸¤éƒ¨åˆ†æ¥çœ‹å¾…ï¼Œä»¥ <code>ljmp 4(%esp)</code> ä¸ºç•Œã€‚</p><p><code>jmp</code> ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å½“æ˜æ˜¾çš„ç¨‹åºè·³è½¬ã€‚è¿™é‡Œ jmp ç»™å‡ºçš„é€‰æ‹©ç¬¦æ˜¯ GDT ä¸ŠæŸä¸ªä»»åŠ¡çš„ TSS æè¿°ç¬¦</p><p>é€šè¿‡ <code>jmp</code> CPU å°†å®Œæˆè€çš„ä»»åŠ¡æ‰€æœ‰å¯„å­˜å™¨çš„ä¿å­˜ç°åœºï¼Œä»¥åŠæ–°çš„ä»»åŠ¡æ‰€æœ‰å¯„å­˜å™¨æš‚å­˜ç»“æœçš„è½½å…¥ã€‚</p><p>CPU æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå°†æ˜¯æ–°çš„ä»»åŠ¡ CS:EIP æ‰€æŒ‡æ˜çš„æŒ‡ä»¤ã€‚</p><p>ç›¸åº”çš„ï¼Œ<code>ljmp</code> ä¹‹åçš„æŒ‡ä»¤å°†åœ¨è¯¥ä»»åŠ¡é‡æ–°è·å¾—å ç”¨ CPU åè·å¾—æ‰§è¡Œã€‚</p><h2 id="ä»»åŠ¡è°ƒåº¦çš„ç»“æŸé˜¶æ®µ"><a href="#ä»»åŠ¡è°ƒåº¦çš„ç»“æŸé˜¶æ®µ" class="headerlink" title="ä»»åŠ¡è°ƒåº¦çš„ç»“æŸé˜¶æ®µ"></a>ä»»åŠ¡è°ƒåº¦çš„ç»“æŸé˜¶æ®µ</h2><p>è¿™æ®µå°±æ¯”è¾ƒç»•äº†ï¼Œç°åœ¨å‡è®¾ä¸€ä¸ªå‰æï¼Œå°±æ˜¯ä»»åŠ¡ A ä¹Ÿæ˜¯åœ¨æ—¶é’Ÿä¸­æ–­é‡æ–°è¿›è¡Œä»»åŠ¡è°ƒåº¦çš„æ—¶å€™è¢«æ›¿æ¢æ‰çš„ï¼Œç°åœ¨ CPU åˆ†é…çš„æ—¶é—´ç‰‡åˆè½®åˆ°äº†ä»»åŠ¡ A ã€‚</p><p>ä¹Ÿå°±æ˜¯ç´§éšç€ä¸Šä¸€å°èŠ‚ <code>ljmp</code> çœ‹çœ‹ä»ä»»åŠ¡å†…æ ¸æ€å›åˆ°ç”¨æˆ·æ€çš„æµç¨‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    # è¿™æ®µä¸ä¸Šé¢ä¸€æ®µæŒ‡ä»¤æ˜¯ç›´æ¥æ‰¿æ¥çš„</span><br><span class="line">movl12(%esp), %eax</span><br><span class="line">xorl%gs:20, %eax</span><br><span class="line">je.L40</span><br><span class="line">call___stack_chk_fail</span><br><span class="line">.L40:</span><br><span class="line">addl$24, %esp           # è¿™é‡Œè¿”è¿˜è¿™æ¬¡ call é¢å¤–ç”³è¯·çš„å†…æ ¸æ ˆç©ºé—´</span><br><span class="line">.cfi_def_cfa_offset 8</span><br><span class="line">popl%ebx                # æ¢å¤è¿›å…¥ call çš„æ—¶å€™æš‚å­˜çš„ ebx</span><br><span class="line">.cfi_restore 3</span><br><span class="line">.cfi_def_cfa_offset 4</span><br><span class="line">ret                         # return è·³è½¬å›åˆ°å½“åˆè°ƒç”¨çš„åœ°æ–¹</span><br><span class="line">.cfi_endproc</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯ä»æ±‡ç¼–æŒ‡ä»¤æ¥çœ‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">call_schedule           # åŸå…ˆè°ƒç”¨ schedule() çš„åœ°æ–¹</span><br><span class="line">.L93:</span><br><span class="line">    # return è·³è½¬å›æ¥ï¼Œç›´æ¥æ‰¿æ¥çš„æŒ‡ä»¤</span><br><span class="line">addl$8, %esp</span><br><span class="line">.cfi_def_cfa_offset 8</span><br><span class="line">popl%ebx</span><br><span class="line">.cfi_restore 3</span><br><span class="line">.cfi_def_cfa_offset 4</span><br><span class="line">ret                         # ç»§ç»­ return ï¼Œè·³å‡º do_timer() </span><br><span class="line">.cfi_endproc</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   call _do_timer# &apos;do_timer(long CPL)&apos; does everything from</span><br><span class="line">addl $4,%esp# task switching to accounting ...</span><br><span class="line">jmp ret_from_sys_call</span><br></pre></td></tr></table></figure><p><strong>ret_from_sys_call</strong></p><p>è¿™é‡Œå°±æ‰“ç®—æ­£å¼ç»“æŸç”±äºè¿™æ¬¡æ—¶é’Ÿä¸­æ–­æ‰€å¼•å‘çš„å†…æ ¸æ€æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹ï¼Œæ­£å¼å›å½’ç”¨æˆ·æ€äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ret_from_sys_call:</span><br><span class="line">    # è¿™ 3 è¡Œæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ä»»åŠ¡0ï¼Œå¦‚æœæ˜¯å°±ä¸è¿›è¡Œä¿¡å·é‡çš„å¤„ç†äº†</span><br><span class="line">movl _current,%eax# task[0] cannot have signals</span><br><span class="line">cmpl _task,%eax</span><br><span class="line">je 3f</span><br><span class="line">    # åˆ¤æ–­åœ¨å‘ç”Ÿæ—¶é’Ÿä¸­æ–­å‰ï¼ŒCS è¡¨ç¤ºçš„æ˜¯ä¸æ˜¯ LDT ç¬¬ 1 é¡¹ (å±€éƒ¨å˜é‡è¡¨çš„ä»£ç æ®µ)</span><br><span class="line">    # å¦åˆ™ CS å°±åº”è¯¥å†…æ ¸æ€ä»£ç æ®µäº†ï¼Œä¸è¿›è¡Œä¿¡å·é‡å¤„ç†</span><br><span class="line">cmpw $0x0f,CS(%esp)# was old code segment supervisor ?</span><br><span class="line">jne 3f</span><br><span class="line">    # åˆ¤æ–­åœ¨å‘ç”Ÿæ—¶é’Ÿä¸­æ–­å‰ï¼ŒSS è¡¨ç¤ºçš„æ˜¯ä¸æ˜¯ LDT ç¬¬ 2 é¡¹ (å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®æ®µ)</span><br><span class="line">    # å¦åˆ™è®¤ä¸ºç¨‹åºè¿˜å¤„åœ¨å†…æ ¸æ€ï¼Œä¸è¿›è¡Œä¿¡å·é‡å¤„ç†</span><br><span class="line">cmpw $0x17,OLDSS(%esp)# was stack segment = 0x17 ?</span><br><span class="line">jne 3f</span><br><span class="line">    # è®¾ç½®ä¿¡å·é‡ (ä¸æ¸…æ¥šï¼Œå…ˆæŒ–ä¸ªå‘)</span><br><span class="line">movl signal(%eax),%ebx</span><br><span class="line">movl blocked(%eax),%ecx</span><br><span class="line">notl %ecx</span><br><span class="line">andl %ebx,%ecx</span><br><span class="line">bsfl %ecx,%ecx</span><br><span class="line">je 3f</span><br><span class="line">btrl %ecx,%ebx</span><br><span class="line">movl %ebx,signal(%eax)</span><br><span class="line">incl %ecx</span><br><span class="line">pushl %ecx</span><br><span class="line">call _do_signal</span><br><span class="line">popl %eax</span><br><span class="line">3:popl %eax</span><br><span class="line">popl %ebx</span><br><span class="line">popl %ecx</span><br><span class="line">popl %edx</span><br><span class="line">pop %fs</span><br><span class="line">pop %es</span><br><span class="line">pop %ds</span><br><span class="line">iret</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œé€šè¿‡ iret å°†è·³è½¬å›åˆ°ç”¨æˆ·æ€ä»£ç è¢«ä¸­æ–­çš„ä½ç½®ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ</p><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><h3 id="pause"><a href="#pause" class="headerlink" title="pause()"></a>pause()</h3><p><a href="https://dormouse-none.github.io/2018-10-06-understand-Kernel-3/">Linux Kernel(3) - æ“ä½œç³»ç»Ÿå¯åŠ¨</a> ä¸­ï¼Œæè¿°è¿‡ä»»åŠ¡0åœ¨å®Œæˆäº†æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹ä¹‹åï¼Œå”¯ä¸€åœ¨åšçš„äº‹æƒ…ï¼Œå°±æ˜¯è°ƒç”¨ <code>for(;;) pause();</code> </p><p>CPU æ¯æ¬¡æŠŠæ—¶é—´ç‰‡åˆ†é…ç»™å®ƒï¼Œå®ƒå°±å¼€å§‹æµªè´¹æƒåŠ›ï¼Œç›´æ¥ä¸è¦äº†è¿™ä¸ªæ—¶é—´ç‰‡ã€‚</p><p>ä¹‹å‰ä¸€ç›´ä»¥ä¸º pause() ä¼šé€‰æ‹©æ‰§è¡Œ <code>HLT</code> æŒ‡ä»¤è®© CPU æš‚æ—¶åœ°é™·å…¥åœæ­¢çŠ¶æ€ã€‚ä½†æ˜¯å‡ºä¹æ„æ–™ï¼Œå¹¶ä¸æ˜¯è¿™ä¸ªç»“æœ(å½“ç„¶ï¼Œæœ€ç»ˆæ˜¯ä¸æ˜¯è¿˜æ˜¯å¦ä¸€ä¸ªè¯´æ³•ã€‚æ¯•ç«Ÿä»£ç éƒ½æ˜¯äººå†™çš„ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥å„è‡ªæœ‰ä¸€å¥—å®ç°)ã€‚</p><p>å½“ CPU æŠŠæ‰§è¡ŒæŒ‡ä»¤çš„æƒåŠ›äº¤ä¸ªä»»åŠ¡ 0 æ—¶ï¼Œé€‰æ‹©è®© CPU åœæ­¢ï¼Œç›´åˆ°æ¥æ”¶åˆ°ç¡¬ä»¶ä¸­æ–­ä¸ºæ­¢ä¹Ÿä¸å¤±ä¸ºä¸€ç§é€‰æ‹©ã€‚å½“ç„¶ï¼Œä¸è®ºå…¶å®ƒï¼ŒLinux0.11ç‰ˆæœ¬çš„ä»£ç ä¸æ˜¯è¿™æ ·çš„ã€‚</p><p>é€šè¿‡ <code>INT 0x80</code> é…åˆç³»ç»Ÿè°ƒç”¨å‡½æ•°æŸ¥è¡¨ï¼Œæœ€åå®šä½åˆ°çš„å°±æ˜¯ sys_pause() äº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">_sys_pause:</span><br><span class="line">.LFB13:</span><br><span class="line">.cfi_startproc</span><br><span class="line">subl$12, %esp</span><br><span class="line">.cfi_def_cfa_offset 16</span><br><span class="line">movl_current, %eax</span><br><span class="line">movl$1, (%eax)</span><br><span class="line">call_schedule       # è°ƒç”¨ schedule() é‡æ–°åˆ’åˆ†æ—¶é—´ç‰‡</span><br><span class="line">movl$0, %eax</span><br><span class="line">addl$12, %esp</span><br><span class="line">.cfi_def_cfa_offset 4</span><br><span class="line">ret</span><br><span class="line">.cfi_endproc</span><br></pre></td></tr></table></figure></p><h3 id="timer-å®šæ—¶å™¨"><a href="#timer-å®šæ—¶å™¨" class="headerlink" title="timer å®šæ—¶å™¨"></a>timer å®šæ—¶å™¨</h3><p>ä¹‹å‰åœ¨ <code>do_timer()</code> å‡½æ•°ä¸­ä¹Ÿçœ‹è¿‡äº†æ¯æ¬¡æ—¶é’Ÿä¸­æ–­ï¼Œéƒ½ä¼šæ£€æŸ¥ä¸€éå®šæ—¶å™¨ï¼Œå¹¶å†³å®šæ˜¯å¦è§¦å‘é¢„ç½®çš„å®šæ—¶å™¨å¤„ç†å‡½æ•°ã€‚</p><p>å½“ç„¶äº†ï¼Œæ—¢ç„¶æ˜¯è§¦å‘å®šæ—¶å™¨ï¼Œæ€»æ˜¯è¦æœ‰ä¸€ä¸ªå‰æâ€”â€”è®¾ç½®å®šæ—¶å™¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_timer</span><span class="params">(<span class="keyword">long</span> jiffies, <span class="keyword">void</span> (*fn)(<span class="keyword">void</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> * <span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!fn)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">cli();</span><br><span class="line"><span class="keyword">if</span> (jiffies &lt;= <span class="number">0</span>)</span><br><span class="line">(fn)();</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (p = timer_list ; p &lt; timer_list + TIME_REQUESTS ; p++)</span><br><span class="line"><span class="keyword">if</span> (!p-&gt;fn)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (p &gt;= timer_list + TIME_REQUESTS)</span><br><span class="line">panic(<span class="string">"No more time requests free"</span>);</span><br><span class="line">p-&gt;fn = fn;</span><br><span class="line">p-&gt;jiffies = jiffies;</span><br><span class="line">p-&gt;next = next_timer;</span><br><span class="line">next_timer = p;</span><br><span class="line"><span class="keyword">while</span> (p-&gt;next &amp;&amp; p-&gt;next-&gt;jiffies &lt; p-&gt;jiffies) &#123;</span><br><span class="line">p-&gt;jiffies -= p-&gt;next-&gt;jiffies;</span><br><span class="line">fn = p-&gt;fn;</span><br><span class="line">p-&gt;fn = p-&gt;next-&gt;fn;</span><br><span class="line">p-&gt;next-&gt;fn = fn;</span><br><span class="line">jiffies = p-&gt;jiffies;</span><br><span class="line">p-&gt;jiffies = p-&gt;next-&gt;jiffies;</span><br><span class="line">p-&gt;next-&gt;jiffies = jiffies;</span><br><span class="line">p = p-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">sti();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å¯¹äºä»»åŠ¡è°ƒåº¦ï¼Œæ›´éš¾çš„æ˜¯å¯¹ä¸€ä¸ªæ—¶é—´æ–­å±‚çš„ç†è§£ã€‚åœ¨è°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œæ—§ä»»åŠ¡è¢«æš‚åœï¼Œæ–°çš„ä»»åŠ¡è¢«é‡æ–°å¯åŠ¨, ç›´åˆ°æ—§çš„ä»»åŠ¡åˆè¢«å¯åŠ¨ã€‚è¿™é‡Œå°±å¿…é¡»äººä¸ºåœ°å°†è¢«ä¸­æ–­çš„ä»»åŠ¡ä¸»åŠ¨çš„è¿æ¥èµ·æ¥çœ‹å¾…ã€‚</p><p>æ—©æœŸç‰ˆæœ¬çš„ä»»åŠ¡è°ƒåº¦æ¨¡å—ç¡®å®æ¯”è¾ƒç®€å•ï¼Œç´¯è®¡ä¸è¿‡ç™¾è¡Œ C ä»£ç ã€‚å“ˆå“ˆã€‚ä¸€ç‚¹ä¸€ç‚¹ç»§ç»­æ¥å§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰é¢å‡ èŠ‚å·²ç»æè¿°è¿‡ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ã€‚CPU å°±å¤„äºä¸æ–­åœ°æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(æˆ–è€…é€šè¿‡ &lt;code&gt;hlt&lt;/code&gt; æŒ‡ä»¤ç›´æ¥åœæ­¢å·¥ä½œ)ã€‚&lt;/p&gt;
&lt;p&gt;é’ˆå¯¹äºæ¯ä¸€ä¸ªç¨‹åºæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯é€šè¿‡ CPU ä¸­å‡ ç»„å¯„å­˜å™¨(é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ç­‰) å’Œå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®åä½œå®Œæˆçš„ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœè¦è¾¾åˆ°å•æ ¸å¤šä»»åŠ¡çš„ç›®çš„ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å®Œæˆå¯¹å‡ ç»„å¯„å­˜å™¨ä¸­å½“å‰å€¼çš„ä¿å­˜(æˆ‘ç§°ä¹‹ä¸ºä¿å­˜ç°åœº)ã€‚è€Œå¯¹äºå†…å­˜æ¥è¯´ï¼Œå¤šä¸ªä»»åŠ¡çš„ä»£ç ã€æ•°æ®åŒæ—¶å­˜åœ¨å†…å­˜æ˜¯å®Œå…¨åˆç†ä¸”å¯è¡Œçš„ã€‚æ¯•ç«Ÿç›¸è¾ƒäºæœ‰é™çš„å¯„å­˜å™¨ï¼Œå†…å­˜å®åœ¨æ˜¯å¤ªå¤§äº†(ç›¸å¯¹è€Œè¨€)ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="time interrupt" scheme="https://DorMOUSE-None.github.io/tags/time-interrupt/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (3) - æ“ä½œç³»ç»Ÿå¯åŠ¨</title>
    <link href="https://DorMOUSE-None.github.io/2018-10-06-understand-Kernel-3/"/>
    <id>https://DorMOUSE-None.github.io/2018-10-06-understand-Kernel-3/</id>
    <published>2018-10-05T16:00:00.000Z</published>
    <updated>2018-10-06T11:26:56.685Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æ‹–å¾—æœ‰å¤Ÿä¹…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å°†çŸ¥è¯†ä¸²è”èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ›´ä½•å†µå¾ˆå¤šå†…å®¹å¯ä»¥è¯´å’Œå¸¸ç†(ä¸ªäººç†è§£çš„å¸¸ç†)æœ‰äº†æ¯”è¾ƒå¤§çš„åå·®ã€‚</p><p>ä¸è¿‡ç¡®å®æ¯”è¾ƒæœ‰æ„æ€ã€‚ä»å¼•å¯¼ç¨‹åºåˆ°æ“ä½œç³»ç»Ÿå¯åŠ¨ï¼Œè¿™ä¸­é—´ç©¶ç«Ÿç»å†äº†å¤šå°‘æµç¨‹å‘¢ï¼Ÿ</p><p>ç”±äºæœ‰äº†å‰å‡ èŠ‚çš„å†…å®¹ï¼Œè¿™é‡Œä¸ä¼šå†å¯¹å¼•å¯¼ç¨‹åºåŠæ±‡ç¼–è¯­æ³•åšè¿‡å¤šçš„ä»‹ç»ã€‚è€Œç€é‡åœ¨äºæ•´ä¸ªæµç¨‹çš„æè¿°ã€‚</p><a id="more"></a><h2 id="å¼•å¯¼ç¨‹åº"><a href="#å¼•å¯¼ç¨‹åº" class="headerlink" title="å¼•å¯¼ç¨‹åº"></a>å¼•å¯¼ç¨‹åº</h2><p>ä» BIOS å°†512å­—èŠ‚é•¿çš„å¼•å¯¼ç¨‹åºåŠ è½½åˆ°ç‰©ç†å†…å­˜<code>0x7c00</code>å¼€å§‹çš„è¿ç»­é€’å¢ç©ºé—´åï¼Œå³å°†ç¨‹åºçš„æ‰§è¡Œæƒäº¤ç»™äº†å¼•å¯¼ç¨‹åº(è¿™é‡ŒæŒ‡çš„æ‰§è¡Œæƒå¯ä»¥ç®€å•ç†è§£æˆCS:IP)</p><blockquote><p><em>CS:IP</em></p><p><strong>CS</strong>. ä»£ç æ®µåŸºå€ã€‚ä¸€èˆ¬ç”¨äºåˆ’å®šä¸€æ®µè¿ç»­ä»£ç å¼€å§‹çš„åœ°å€ã€‚æ˜¯ä¸€ä¸ª16ä½æ®µå¯„å­˜å™¨ï¼Œç±»ä¼¼çš„è¿˜æœ‰ DS, ES, FS, GS, SS ç­‰16ä½æ®µå¯„å­˜å™¨ï¼Œåˆ†åˆ«æä¾›ä¸åŒçš„æ®µåŸºå€å­˜å‚¨åŠŸèƒ½)<br><strong>IP</strong>. ä»£ç æ®µåç§»å€¼ã€‚é…åˆ CS å…±åŒä¸º CPU ç¡®å®šä¸‹ä¸€ä¸ªå°†è¦è¢«æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤çš„çº¿æ€§åœ°å€ã€‚</p></blockquote><p>Linux 0.11 ç‰ˆæœ¬çš„å¼•å¯¼ç¨‹åºå®ç°çš„æ”¯æŒæ¯”è¾ƒç®€å•ã€‚</p><ol><li>å°†å¼•å¯¼ç¨‹åºä»£ç (è‡ªèº«) 512 å­—èŠ‚çš„å†…å®¹ç§»åŠ¨åˆ° <code>0x90000</code> å¼€å§‹çš„ 512B å†…å­˜ç©ºé—´ä¸Š</li><li>è·³åˆ° <code>0x90000</code> å¼€å§‹çš„æ®µçš„ç›¸åº”ä½ç½®ç»§ç»­æ‰§è¡Œ</li><li>ä»ç£ç›˜ä¸­è¯»å– 4*512 å­—èŠ‚çš„ setup ç¨‹åºçš„äºŒè¿›åˆ¶å†…å®¹</li><li>è¯»å–æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶å†…å®¹åˆ°å†…å­˜ <code>0x10000</code> å¼€å§‹çš„è¿ç»­åœ°å€ç©ºé—´ä¸­ (æ­¤å¤„æœ€å¤§å¯ä»¥æœ‰ 0x90000 - 0x10000 = 0x80000 = 512 KBï¼Œå³å½“æ—¶çš„æ“ä½œç³»ç»ŸäºŒè¿›åˆ¶ç¨‹åº+æ•°æ®æœ€å¤§åªèƒ½æ˜¯ 512KB, ä¸è¿‡ä¹Ÿå¾ˆå¤šäº†)</li><li>ç¡®è®¤å°†è¦ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜æ˜¯å¦å­˜åœ¨</li><li>å°†æ§åˆ¶æƒäº¤ç»™ setup ç¨‹åº</li></ol><h2 id="SETUP-ç¨‹åº"><a href="#SETUP-ç¨‹åº" class="headerlink" title="SETUP ç¨‹åº"></a>SETUP ç¨‹åº</h2><p><strong>è¯»å–ç¡¬ä»¶é…ç½®</strong></p><p>setup ç¨‹åºï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨æä¸€äº›é…ç½®ã€‚é‚£ä¹ˆç©¶ç«Ÿåœ¨é…ç½®ä»€ä¹ˆï¼Ÿ</p><p>å°±æ˜¯é€šè¿‡ BIOS ä¸­æ–­è¯»å–å„ç§ç¡¬ä»¶ä¿¡æ¯(è¯¸å¦‚å†…å­˜å¤§å°ï¼Œæ˜¾ç¤ºå™¨é•¿å®½æ¯”ï¼Œç£ç›˜ç­‰)ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å†…å­˜çš„æŒ‡å®šä½ç½®ã€‚</p><p>å“ˆå“ˆï¼Œç”±äºå¼•å¯¼ç¨‹åºå·²ç»æ‰§è¡Œå®Œäº†ï¼Œå†ä¹Ÿä¸ä¼šä½¿ç”¨äº†ã€‚å› æ­¤ï¼Œsetup ç¨‹åºå°±æ˜¯å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°äº†åŸå¼•å¯¼ç¨‹åºæ‰€åœ¨çš„ä½ç½®ï¼Œå³ 0x90000 ~ 0x901FF å…± 512 B çš„å†…å­˜ä¸­ã€‚</p><p>å½“ç„¶ï¼Œæ¯ä¸ªå­—èŠ‚å­˜çš„æ˜¯ä»€ä¹ˆå†…å®¹éƒ½æ˜¯ä¸€ç§çº¦å®š(æ¯”å¦‚ setup ç¨‹åºæŠŠå†…å­˜å¤§å°çš„ä¿¡æ¯å­˜åˆ°äº†å“ªï¼Œåé¢å…¶å®ƒç¨‹åºå°±åˆ°ç›¸åº”çš„ä½ç½®å»å–)ã€‚</p><p><strong>ç§»åŠ¨æ“ä½œç³»ç»Ÿç¨‹åº</strong></p><p>OKï¼Œsetup ç¨‹åºä¹Ÿä¸æ˜¯ä»…ä»…åªå¹²è¿™ä¹ˆç‚¹äº‹æƒ…çš„ï¼Œä¸ç„¶è¦ 4*512 å­—èŠ‚å²‚ä¸æ˜¯å¤ªæµªè´¹äº†ï¼Œå“ªç”¨å¾—äº†è¿™ä¹ˆå¤šã€‚</p><p>setup è¿˜è¦è´Ÿè´£å°†æ“ä½œç³»ç»Ÿç¨‹åºç§»åŠ¨åˆ°<em>æ–¹ä¾¿</em>çš„ä½ç½®ã€‚å‰é¢å°†æ“ä½œç³»ç»Ÿç¨‹åºåŠ è½½åˆ°äº†å†…å­˜ 0x10000 å¤„ï¼Œä¸»è¦æ˜¯ä¸ºäº†æš‚æ—¶ä¿æŒ BIOS ä¸­æ–­å‘é‡è¡¨ (ä½äº 0x0000 å¼€å§‹çš„è¿ç»­ 1024 B å†…å­˜ä¸­ï¼Œç”± BIOS ç¨‹åºåˆ›å»ºï¼Œç”¨äºå„ç§ä¸­æ–­è°ƒç”¨) ã€‚åœ¨ setup å†³å®šä¸å†ä½¿ç”¨ BIOS ä¸­æ–­ä¹‹åï¼Œå°±å·²ç»å¯ä»¥å®Œå…¨åºŸå¼ƒäº†ã€‚</p><p>å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿç¨‹åºå°†ä» 0x10000 é¡ºæ¬¡ç§»åŠ¨åˆ° 0x00000 çš„ä½ç½®ã€‚</p><p><strong>é‡ç½®ä¸­æ–­</strong></p><p>è½¯ä¸­æ–­ä¸ç¡¬ä¸­æ–­ï¼Œåº”è¯¥æ˜¯åœ¨è½¯ç¡¬ä»¶åˆ’åˆ†ä¸‹å”¯äºŒçš„ä¸¤ç§ä¸­æ–­å½¢å¼ã€‚è½¯ä¸­æ–­ä¸€èˆ¬é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ <code>INT {ä¸­æ–­å·}</code> çš„å½¢å¼é€šè¿‡è½¯ä»¶æ‰§è¡Œçš„å½¢å¼äº§ç”Ÿï¼Œè€Œç¡¬ä¸­æ–­æ˜¯ç¡¬ä»¶ç”±äºæŸäº›é”™è¯¯æŒ‡ä»¤è€Œè‡ªåŠ¨äº§ç”Ÿçš„ä¸­æ–­ã€‚</p><p>å½“ç„¶ï¼Œè¿™äº›ä¸­æ–­éƒ½éœ€è¦ CPU è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚é‚£ä¹ˆï¼Œåœ¨ BIOS  ä¸­æ–­å‘é‡è¡¨è¢«è¦†ç›–äº†ä¹‹åï¼Œå¦‚ä½•æ¥å¤„ç†è¿™äº›ä¸­æ–­å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œåœ¨ä¸Šä¸€æ­¥ <strong>ç§»åŠ¨æ“ä½œç³»ç»Ÿç¨‹åº</strong> å¼€å§‹æ—¶ï¼Œå°±ç›´æ¥é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ <code>cli</code> å¼ºåˆ¶ç¦æ­¢é™¤ <em>éå¯å±è”½ä¸­æ–­</em> å¤–çš„æ‰€æœ‰ä¸­æ–­ï¼Œå› æ­¤ä¹Ÿå°±åŸºæœ¬ä¸è€ƒè™‘ä¸­æ–­çš„é—®é¢˜ã€‚</p><p>ä½†æ˜¯ï¼Œæ€»è¿˜å¾—è§£é™¤ç¦æ­¢å§ã€‚å› æ­¤ï¼Œsetup ç¨‹åºå°½å¿«åœ°é‡æ–°ç¼–åˆ¶äº†ç¡¬ä»¶ä¸­æ–­ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼ã€‚ä½¿ç”¨ä¿æŠ¤æ¨¡å¼ä¸‹çš„ä¸­æ–­æè¿°ç¬¦è¡¨æ¥æ›¿ä»£ BIOS ä¸­æ–­å‘é‡è¡¨ã€‚</p><p>è‡³äºå¦‚ä½•åˆ›å»ºä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œå“ˆå“ˆï¼Œè¿™éƒ½æ˜¯ç›´æ¥åœ¨æ±‡ç¼–ç¼–ç¨‹çš„æ—¶å€™å†™å¥½çš„ã€‚ç›´æ¥åˆ’å‡ºäº†ä¸€å—åŒºåŸŸå†™ä¸Šäº†ä¸­æ–­æè¿°ç¬¦è¡¨çš„è¡¨é¡¹ï¼Œç„¶åä¸ setup ä»£ç ä¸€èµ·è¢«è¯»å–åˆ°äº†å†…å­˜çš„æŒ‡å®šä½ç½®ã€‚è‡³äºå”¯ä¸€è¦åšçš„ï¼Œå°±æ˜¯å°† IDTR (ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨) ä¿®æ”¹ä¸ºä¸­æ–­æè¿°ç¬¦è¡¨åœ¨å†…å­˜çš„å¼€å§‹åœ°å€ã€‚</p><p><strong>è¿›å…¥ä¿æŠ¤æ¨¡å¼</strong></p><p>é¦–å…ˆï¼Œç®€å•ä»‹ç»ä¸€ä¸‹å®æ¨¡å¼ &amp; ä¿æŠ¤æ¨¡å¼ã€‚</p><p>ä¿æŠ¤æ¨¡å¼ä¸å®æ¨¡å¼çš„ä¸»è¦åŒºåˆ«ï¼Œå°±åœ¨äºä¸¤è€…çš„å†…å­˜å¯»å€æ–¹å¼ï¼Œå½’æ ¹ç»“åº•ä¹Ÿå°±æ˜¯æ®µå¯„å­˜å™¨å¦‚ä½•è¾…åŠ©å®Œæˆå†…å­˜åœ°å€å®šä½çš„é—®é¢˜ã€‚</p><p>å…ˆç®€å•çš„å›é¡¾ä¸‹å®æ¨¡å¼ä¸‹çš„å¯»å€æ–¹å¼</p><p>æ®µå¯„å­˜å™¨çš„å‡ºç°ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†å¯¹ 16 bit CPU ä¸‹å¯å¯»å€åœ°å€ä¸è¶³æ‰€ä½œå‡ºçš„è¡¥å……ã€‚<br>è¯¸å¦‚ CS:IP = 0x07C0:0x0001 -&gt; 0x07C01 ã€‚é€šè¿‡CS:IP çš„é…åˆï¼Œç‰©ç†åœ°å€ = CS &lt;&lt; 4 + IP ï¼Œå°†åŸæœ¬ 128 KB çš„å¯å¯»å€ç©ºé—´æ‰©å±•åˆ° 0xFFFF:0xFFFF -&gt; 0x10FFFE çš„å¯»å€ç©ºé—´</p><p>è€Œä¿æŠ¤æ¨¡å¼çš„å‡ºç°ï¼Œä¹Ÿæ˜¯ç”±äºå®æ¨¡å¼ä¸‹çš„åœ°å€å¯»å€ä»ç„¶ä¸èƒ½æ»¡è¶³å¯¹å†…å­˜å¯»å€çš„éœ€æ±‚ã€‚</p><p>é‚£ä¹ˆä¿æŠ¤æ¨¡å¼ç©¶ç«Ÿå°†å¦‚ä½•è¿›è¡Œå¯»å€å‘¢ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡æ–°å¢äº†ä¸€ä¸ªå¯„å­˜å™¨ GDTR (å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨ã€‚å½“ç„¶ï¼Œæš‚æ—¶ä¸è€ƒè™‘ LDTR) ç”¨æ¥å­˜å‚¨å…¨å±€æè¿°ç¬¦è¡¨(å…¨å±€æè¿°ç¬¦è¡¨æ˜¯ä¸€äº›åœ¨å†…å­˜ä¸­çš„æœ‰ç»“æ„çš„æ•°æ®) ï¼Œé‚£ä¹ˆç±»ä¼¼çš„ï¼Œæœ¬æ¥æ˜¯æ®µå¯„å­˜å™¨ä¸­æ˜¯è¡¨ç¤ºä¸€ä¸ªå†…å­˜æ®µåŸºå€ï¼Œç°åœ¨é€šè¿‡å€ŸåŠ©ä¸­é—´é¡¹ (GDTR) ï¼Œç”±å…¨å±€æè¿°ç¬¦è¡¨çš„æ¯ä¸€ä¸ªè¡¨é¡¹æ¥è¡¨ç¤ºæ¯ä¸€ä¸ªå†…å­˜æ®µåŸºå€ï¼Œä»è€Œè¾¾åˆ°åœ¨æœ€å¤§ 4GB çš„å†…å­˜ä¸­è¿›è¡Œå†…å­˜åœ°å€çš„å¯»å€ã€‚</p><p>è€Œä¸ä¸Šé¢çš„ä¸­æ–­æè¿°ç¬¦è¡¨ç±»ä¼¼çš„ï¼Œå…¨å±€æè¿°ç¬¦è¡¨ä¹Ÿæ˜¯ä»¥åŒæ ·çš„æ–¹å¼ï¼Œé¢„å…ˆå†™å¥½ï¼Œç„¶åè®¾ç½®ä¸€ä¸‹ GDTR å°± OK äº†ã€‚</p><p><strong>è½¬å…¥æ“ä½œç³»ç»Ÿç¨‹åº</strong></p><p>æœ€åçš„æœ€åï¼Œå½“ç„¶æ˜¯æŠŠæ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿç¨‹åºã€‚å³è·³è½¬åˆ°å†…å­˜ 0x00000 å¤„ã€‚å½“ç„¶ï¼Œç”±äºç°åœ¨å·²ç»å¤„äºä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå› æ­¤ jmp æŒ‡ä»¤ç•¥æœ‰ä¸åŒã€‚ ä¸º <code>jmpi 0, 8</code>ã€‚</p><p>ç®€å•è§£é‡Šä¸€ä¸‹è¿™ä¸€æ¡æŒ‡ä»¤ </p><p><code>jmpi</code> æŒ‡ä»¤è¡¨ç¤ºè¿›è¡Œæ®µé—´è·³è½¬ã€‚(æ®µé—´è·³è½¬ä¸æ®µå†…è·³è½¬çš„åŒºåˆ«åœ¨äº: ç¨‹åºä»£ç çš„å¯»å€ä¸€èˆ¬é€šè¿‡ CS:IP é…åˆå®Œæˆï¼Œå¦‚æœæ˜¯æ®µå†…è·³è½¬ï¼Œåˆ™æ®µåŸºå€ä¸å˜ï¼Œå³ CS ä¸å˜ï¼Œåªéœ€è¦ç»™å‡º IP å³å¯ï¼›è€Œæ®µé—´è·³è½¬éœ€è¦åŒæ—¶ç»™å‡ºæ–°çš„æ®µåŸºå€(CS)å’Œæ–°çš„æ®µåç§»(IP)ã€‚</p><p><code>0</code> è¿™é‡Œ 0 å°±è¡¨ç¤ºçš„æ˜¯æ®µåç§»ã€‚</p><p><code>8</code> ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨ä»¥ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼æ¥é…åˆ GDTR/LDTR æ¥å®Œæˆå¯¹å…¨å±€/å±€éƒ¨æè¿°ç¬¦è¡¨é¡¹çš„å®šä½ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æœ€åä¸¤ä½è¡¨ç¤ºç‰¹æƒçº§ï¼Œç”¨äºåŒºåˆ†ç”¨æˆ·æ€(11) or å†…æ ¸æ€(00) (Linux åªä½¿ç”¨äº†ä¸¤ä¸ªï¼Œè¿˜æœ‰ 01 å’Œ 10 ä¸ä½¿ç”¨)</p><p>ç¬¬ä¸‰ä½è¡¨ç¤ºä½¿ç”¨ GDTR è¿˜æ˜¯ LDTR</p><p>é«˜ 13 ä½å…±åŒç»„æˆäº†å¯¹ GDTR/LDTR è¡¨é¡¹çš„æè¿°ï¼Œç©¶ç«Ÿä½¿ç”¨å“ªä¸€ä¸ªè¡¨é¡¹ã€‚å½“ç„¶ï¼Œè¿™é‡Œå…¶å®ä¹Ÿä¾§é¢åæ˜ äº†ï¼Œå…¶å®æ¯ä¸ªå…¨å±€æè¿°ç¬¦è¡¨/å±€éƒ¨æè¿°ç¬¦è¡¨æœ€å¤šåªèƒ½æœ‰ $2^{13} = 8192$ ä¸ªè¡¨é¡¹ã€‚</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fulm7vumywj31220aw74f.jpg" alt=""></p><h2 id="æ“ä½œç³»ç»Ÿç¨‹åº"><a href="#æ“ä½œç³»ç»Ÿç¨‹åº" class="headerlink" title="æ“ä½œç³»ç»Ÿç¨‹åº"></a>æ“ä½œç³»ç»Ÿç¨‹åº</h2><p>ç»ˆäºè¦åˆ°æ“ä½œç³»ç»Ÿç¨‹åºäº†ã€‚è¿™ä¸ªå°±æ¯”è¾ƒå¤æ‚äº†ã€‚è¿™é‡Œåªç®€å•æè¿°å°†æ“ä½œç³»ç»Ÿå¯åŠ¨èµ·æ¥çš„æœ€åŸºæœ¬ä½¿ç”¨åˆ°çš„ä»£ç ã€‚å…¶å®ƒä»¥åç»§ç»­ã€‚</p><p>å…¶å®æ•´ä¸€ä¸ªæ“ä½œç³»ç»Ÿç¨‹åºæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é‡ï¼Œæ¯•ç«Ÿæœ€å¤§èƒ½å¤Ÿè¾¾åˆ° 512 KB å‘¢ã€‚</p><p>ç®€å•çš„çœ‹ä¸€ä¸‹æ–‡æ¡£æ ‘ï¼Œè§é™„å½•ä¸€ï¼Œç¼–è¯‘å‰çš„æºä»£ç æ–‡ä»¶æ€»è®¡ 100 å¤šä¸ªã€‚</p><p>é¦–å…ˆè¢«æ‰§è¡Œçš„æ˜¯ head.s ä¸­çš„ä»£ç ï¼Œè¿™é‡Œå®Œæˆçš„å·¥ä½œä¸»è¦åŒ…æ‹¬:</p><ol><li><p>é‡æ–°ç¼–åˆ¶æ¯ä¸ªä¸­æ–­çš„å…·ä½“å¤„ç†ä»£ç (è¿™ä¸ªåº”è¯¥æ¯”è¾ƒå¥½ç†è§£ï¼Œè¯´åˆ°åº•ä¸­æ–­å‡ºç°äº†ï¼Œä¹Ÿè¿˜æ˜¯è¦é€šè¿‡å®ç°ä»£ç æ¥å®Œæˆä¸­æ–­é€»è¾‘ã€‚ä¸è®ºæ˜¯ BIOS ä¸­æ–­å‘é‡è¿˜æ˜¯ä¿æŠ¤æ¨¡å¼ä¸‹ä½¿ç”¨çš„ä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œéƒ½ä¸è¿‡æ˜¯è®°å½•äº†ä¸€ä¸‹ä¸­æ–­å¤„ç†ä»£ç çš„ä½ç½®ï¼Œè¿›è¡Œäº†å®šä½è€Œå·²)ã€‚</p></li><li><p>åˆå§‹åŒ–åˆ†é¡µæ¨¡å¼(ä¸è¯¦è¿°ï¼Œä»¥åæœ‰æœºä¼šåœ¨è¯´)</p></li><li><p>éªŒè¯ 80387 æ•°å­¦åå¤„ç†å™¨ã€‚</p></li><li><p>è¿›å…¥ main.c ç¨‹åº (æ—¢ç„¶ Linus éƒ½å°†å…¶å‘½åä¸º main äº†ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™æ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†äº†)ã€‚</p></li></ol><h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><p>ä¸‹é¢å°†ç®€å•ç»™å‡º main.c ç¨‹åºçš„ä¸¤æ®µä»£ç  <code>main(...)</code> å’Œ <code>init(...)</code>ï¼Œå¹¶ç›´æ¥é’ˆå¯¹ä»£ç è¿›è¡Œç›´æ¥è§£é‡Šã€‚</p><h4 id="main-void"><a href="#main-void" class="headerlink" title="main(void)"></a>main(void)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> ROOT_DEV = ORIG_ROOT_DEV;   <span class="comment">// è¯»å–åœ¨å¼•å¯¼ç¨‹åºæ‰§è¡Œæ—¶è·å–åˆ°çš„æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„ç£ç›˜</span></span><br><span class="line"> drive_info = DRIVE_INFO;</span><br><span class="line">memory_end = (<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + (EXT_MEM_K&lt;&lt;<span class="number">10</span>); <span class="comment">// é¦–å…ˆå…ˆç¡®è®¤æ•´ä¸ªå†…å­˜çš„å¤§å°</span></span><br><span class="line">memory_end &amp;= <span class="number">0xfffff000</span>;               <span class="comment">// å½“ç„¶ï¼Œè¿™é‡Œä¸ºäº†åˆ†é¡µæ–¹ä¾¿ (æ¯é¡µ 4096 B)ï¼Œç›´æ¥å°†ä¸æ»¡ä¸€é¡µçš„å†…å­˜å¿½ç•¥æ‰äº†</span></span><br><span class="line"><span class="keyword">if</span> (memory_end &gt; <span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>)          <span class="comment">// æœ€å¤§æ”¯æŒ 16 MB çš„å†…å­˜ï¼Œè¿™é‡Œæ˜¯ Linus å½“æ—¶çš„æœºå™¨åªæœ‰ 16 MBï¼Œå› æ­¤æ²¡æœ‰åšæ›´å¤§å†…å­˜çš„æ”¯æŒï¼Œä½†å¯ä»¥è‡ªå·±å»æ”¹æºç </span></span><br><span class="line">memory_end = <span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"><span class="keyword">if</span> (memory_end &gt; <span class="number">12</span>*<span class="number">1024</span>*<span class="number">1024</span>)          <span class="comment">// ç¡®è®¤ç¼“å­˜åŒºçš„æœ«åœ°å€ (æ ¹æ®å®é™…å†…å­˜å¤§å°è°ƒæ•´, &gt;12MB ç•™ 4MB ç¼“å­˜ï¼Œ&gt;6MB ç•™ 2 MB ç¼“å­˜ï¼Œå¦åˆ™ 1MB )</span></span><br><span class="line">buffer_memory_end = <span class="number">4</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (memory_end &gt; <span class="number">6</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">buffer_memory_end = <span class="number">2</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">buffer_memory_end = <span class="number">1</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">main_memory_start = buffer_memory_end;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RAMDISK</span></span><br><span class="line">main_memory_start += rd_init(main_memory_start, RAMDISK*<span class="number">1024</span>);      <span class="comment">// å¦‚æœéœ€è¦è™šæ‹Ÿç›˜ï¼Œåˆ™å†ç•™ä¸€éƒ¨åˆ†ä½œä¸ºäº¤æ¢åŒº</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">mem_init(main_memory_start,memory_end); <span class="comment">// å†…å­˜åˆå§‹åŒ–ï¼Œæ¯•ç«Ÿ Linux æ“ä½œç³»ç»Ÿä¸‹çš„æ‰€æœ‰å†…å­˜éƒ½å°†è¢«ç»Ÿä¸€åˆ†é…ï¼Œç”¨æˆ·ç¨‹åºæ²¡æœ‰æƒé™éšä¾¿ä½¿ç”¨å†…å­˜ï¼Œåªèƒ½ç”¨è¢«åˆ†é…çš„</span></span><br><span class="line">trap_init();            <span class="comment">// åˆå§‹åŒ–ä¸­æ–­</span></span><br><span class="line">blk_dev_init();         <span class="comment">// åˆå§‹åŒ–å—è®¾å¤‡</span></span><br><span class="line">chr_dev_init();         <span class="comment">// åˆå§‹åŒ–å­—ç¬¦è®¾å¤‡</span></span><br><span class="line">tty_init();             <span class="comment">// åˆå§‹åŒ– tty</span></span><br><span class="line">time_init();            <span class="comment">// è®¾ç½®å¼€æœºå¯åŠ¨æ—¶é—´</span></span><br><span class="line">sched_init();           <span class="comment">// åˆå§‹åŒ–ä»»åŠ¡è°ƒåº¦ç¨‹åºï¼Œç”±æ­¤å°±å°†å¯ä»¥è¿›è¡Œå¤šä»»åŠ¡åˆ‡æ¢äº†</span></span><br><span class="line">buffer_init(buffer_memory_end); <span class="comment">// ç¼“å­˜åŒºåˆå§‹åŒ–</span></span><br><span class="line">hd_init();              <span class="comment">// ç¡¬ç›˜åˆå§‹åŒ–</span></span><br><span class="line">floppy_init();          <span class="comment">// è½¯ç›˜åˆå§‹åŒ–</span></span><br><span class="line">sti();                  <span class="comment">// ä¸å†ç¦æ­¢ä¸­æ–­ï¼Œç°åœ¨å¼€å§‹åˆå…è®¸ä¸­æ–­äº†</span></span><br><span class="line">move_to_user_mode();    <span class="comment">// è¿›å…¥ç”¨æˆ·æ€</span></span><br><span class="line"><span class="keyword">if</span> (!fork()) &#123;          <span class="comment">// å…³äº fork å‡½æ•°ï¼Œä¸‹é¢å°†ç®€å•ä»‹ç»ã€‚</span></span><br><span class="line">init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(;;) pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>fork()</strong></p><p>å¦‚æœç†Ÿæ‚‰ C è¯­è¨€ï¼Œåº”è¯¥å¯¹ fork() ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰å§ã€‚è¿™å°†æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ (è¿™é‡Œå°†åŸæ¥çš„æ“ä½œç³»ç»Ÿç¨‹åºè®¤ä¸ºæ˜¯ 0 å·è¿›ç¨‹/ä»»åŠ¡ï¼Œå°†äº§ç”Ÿ 1 å·è¿›ç¨‹/ä»»åŠ¡)ã€‚æ–°çš„ä»»åŠ¡ä¸åŸæœ‰ä»»åŠ¡å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œé™¤äº† fork() è°ƒç”¨çš„è¿”å›å€¼ä¸åŒã€‚å­ä»»åŠ¡å°†è¿”å› 0 ï¼ŒåŸæœ‰ä»»åŠ¡å°†è¿”å›å­ä»»åŠ¡çš„ä»»åŠ¡å·ã€‚</p><p>å› æ­¤ï¼Œå¯¹äºä¸Šé¢çš„ä»£ç ï¼Œ<code>if(!fork())</code> ï¼Œ0å·ä»»åŠ¡å°†ä¸æ‰§è¡Œ <code>if(){}</code> è¯­å¥å—å†…çš„ init ï¼Œè€Œ 1 å·ä»»åŠ¡å°†æ‰§è¡Œ <code>init()</code> å‡½æ•°</p><p>è€Œ 0 å·è¿›ç¨‹åœ¨åšä»€ä¹ˆå‘¢? </p><p>å¾ˆç®€å•ï¼Œä¸‹é¢ <code>for(;;) pause();</code>ã€‚ <code>pause()</code> æ˜¯æŒ‡è®© CPU å®Œå…¨åœæ­¢ï¼Œåªæœ‰å‘ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œ CPU æ‰ä¼šä»åœæ­¢çŠ¶æ€ä¸­æ¢å¤ (å‰é¢å·²ç»è®¾ç½®äº†å®šæ—¶çš„/ 10ms/æ¬¡çš„æ—¶é’Ÿä¸­æ–­ï¼Œå› æ­¤ CPU æ€»æ˜¯èƒ½å¤Ÿæ¢å¤)ï¼Œ </p><p>å…·ä½“çš„æè¿°å°±æ˜¯ï¼Œå¦‚æœä»»åŠ¡è°ƒåº¦ç¨‹åºæŠŠæ—¶é—´ç‰‡åˆ†é…ç»™äº† 0 å·è¿›ç¨‹ï¼Œé‚£ä¹ˆ 0 å·è¿›ç¨‹å”¯ä¸€åšçš„ï¼Œå°±æ˜¯è®© CPU åœæ­¢ã€‚è€Œä¸” 0 å·è¿›ç¨‹çš„ <code>for</code> æ˜¯æ­»å¾ªç¯ï¼Œæ¯æ¬¡æŠŠæ—¶é—´åˆ†é…ç»™ 0 å·è¿›ç¨‹ï¼Œå®ƒå°± CPU åœæ­¢ã€‚æˆ‘ä»¬åœ¨ Linux æ“ä½œç³»ç»Ÿä¸Šï¼Œé€šè¿‡ top å¯ä»¥çœ‹åˆ°å¯¹ cpu æœ‰å¦‚ä¸‹æè¿°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å¯¹ idle(id) çš„ç»Ÿè®¡ï¼Œå…¶å®å°±åœ¨ 0 å·ä»»åŠ¡è®© cpu åœæ­¢å·¥ä½œäº†è€Œå·²ã€‚</p><h4 id="init-void"><a href="#init-void" class="headerlink" title="init(void)"></a>init(void)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> pid,i;</span><br><span class="line"></span><br><span class="line">setup((<span class="keyword">void</span> *) &amp;drive_info);</span><br><span class="line">(<span class="keyword">void</span>) open(<span class="string">"/dev/tty0"</span>,O_RDWR,<span class="number">0</span>);</span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>);</span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d buffers = %d bytes buffer space\n\r"</span>,NR_BUFFERS,</span><br><span class="line">NR_BUFFERS*BLOCK_SIZE);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Free mem: %d bytes\n\r"</span>,memory_end-main_memory_start);</span><br><span class="line"><span class="keyword">if</span> (!(pid=fork())) &#123;</span><br><span class="line">close(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (open(<span class="string">"/etc/rc"</span>,O_RDONLY,<span class="number">0</span>))</span><br><span class="line">_exit(<span class="number">1</span>);</span><br><span class="line">execve(<span class="string">"/bin/sh"</span>,argv_rc,envp_rc);</span><br><span class="line">_exit(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pid&gt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">while</span> (pid != wait(&amp;i))</span><br><span class="line"><span class="comment">/* nothing */</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> ((pid=fork())&lt;<span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Fork failed in init\r\n"</span>);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">close(<span class="number">0</span>);close(<span class="number">1</span>);close(<span class="number">2</span>);</span><br><span class="line">setsid();</span><br><span class="line">(<span class="keyword">void</span>) open(<span class="string">"/dev/tty0"</span>,O_RDWR,<span class="number">0</span>);</span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>);</span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>);</span><br><span class="line">_exit(execve(<span class="string">"/bin/sh"</span>,argv,envp));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> (pid == wait(&amp;i))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n\rchild %d died with code %04x\n\r"</span>,pid,i);</span><br><span class="line">sync();</span><br><span class="line">&#125;</span><br><span class="line">_exit(<span class="number">0</span>);<span class="comment">/* NOTE! _exit, not exit() */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ 1 å·ä»»åŠ¡åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿçœ‹ init çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¤§é‡è¯¸å¦‚ <code>/dev/tty0</code>, <code>/bin/sh</code> çš„ä»£ç ã€‚å“ˆå“ˆï¼Œä¸‹é¢é€šè¿‡ 1,2,3â€¦ å¯¹æ­¥éª¤è¿›è¡Œæ ‡å·ç®€å•æè¿°ä¸€ä¸‹ã€‚</p><ol><li><p>1 å·è¿›ç¨‹åœ¨åšçš„æ˜¯ fork å‡ºæ–°çš„è¿›ç¨‹(æš‚æ—¶å«å®ƒè¿›ç¨‹ X )</p></li><li><p>1 å·è¿›ç¨‹ä¸æ–­è¯¢é—® X æ˜¯å¦è¢«é”€æ¯ </p><ul><li>å¦‚æœ X è¿›ç¨‹è¢«é”€æ¯äº†ï¼šé‚£ä¹ˆç»§ç»­æ‰§è¡Œæ­¥éª¤ 1</li><li>å¦åˆ™ï¼šç»§ç»­æ‰§è¡Œæ­¥éª¤ 2 ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸æ–­å¾ªç¯å‘¢ï¼Ÿå…¶å®ç”±äºä»»åŠ¡è°ƒåº¦ç¨‹åºçš„å­˜åœ¨ï¼Œåœ¨å•ä¸ª CPU çœ‹æ¥ï¼Œè¿™ä¸ªè½®è¯¢å¹¶ä¸ä¸€ç›´å‘ç”Ÿï¼Œæœ‰ä¸€äº›æ—¶é—´ç‰‡å·²ç»ç»™äº†å…¶ä»–è¿›ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡äº†</li></ul></li><li><p>X ä»»åŠ¡é€šè¿‡è°ƒç”¨ <code>execve()</code> æŠŠå½“å‰ç¨‹åºçš„ä»£ç +æ•°æ®å…¨éƒ¨æ›¿æ¢æˆæ˜¯ shell çš„ (å…¶å®å¤§é‡çš„ç”¨æˆ·ç¨‹åºéƒ½æ˜¯é€šè¿‡è¿™ç§ fork + execve çš„å½¢å¼å‡ºç°çš„)</p></li><li>X ä»»åŠ¡(ä¹Ÿå°±æ˜¯ Shell ç¨‹åº) å¼€å§‹é€šè¿‡ tty ä¸ç”¨æˆ·å¼€å§‹äº¤äº’ã€‚ç›´åˆ°ç”¨æˆ·é€‰æ‹© <code>exit</code> é€€å‡º shell </li></ol><p><strong>execve(â€¦)</strong></p><p>å‰é¢ä»‹ç»è¿‡ fork æ˜¯å¤åˆ¶ä¸€ä»½ç¨‹åºçš„å„ä¸ªå¯„å­˜å™¨çš„çŠ¶æ€ + ç¨‹åºçš„æ•°æ®ã€‚ç°åœ¨ execve åšå‡ºçš„æ“ä½œæ˜¯ç›´æ¥å°†å½“å‰ç¨‹åºçš„ä»£ç å’Œæ•°æ®æ›¿æ¢æˆç›®æ ‡ç¨‹åºçš„ä»£ç å’Œæ•°æ®ï¼Œå¹¶é€šè¿‡å¯¹å¯„å­˜å™¨ä¸€å®šçš„é‡ç½®ï¼Œå®Œæˆä¸€ä¸ªç”¨æˆ·ç¨‹åºçš„å¯åŠ¨æµç¨‹(ç¨‹åºå¯åŠ¨è¯´åˆ°åº•ä¸å°±æ˜¯åœ¨å†…å­˜ä¸­å­˜åœ¨è¿™ä¸ªç¨‹åºçš„ä»£ç ï¼Œç„¶åé€šè¿‡ CS:IP å®šä½åˆ°å³å°†æ‰§è¡Œçš„ç¨‹åºæŒ‡ä»¤ï¼Œæœ€åè®© CPU å¼€å§‹æ‰§è¡Œå°± OK äº†)</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹å°±ç®€å•åœ°ä»‹ç»åˆ°è¿™é‡Œã€‚</p><p>0 å·ä»»åŠ¡ä½œä¸ºæ“ä½œç³»ç»Ÿçš„å¸¸é©»ç¨‹åºï¼Œåœ¨ OS å¯åŠ¨å®Œæˆï¼Œæ¯æ¬¡æ—¶é—´ç‰‡è¢«åˆ†é…ç»™å®ƒï¼Œå®ƒå°±è®© CPU åœæ­¢å·¥ä½œ(é€šè¿‡ pause() ç³»ç»Ÿè°ƒç”¨)</p><p>1 å·ä»»åŠ¡ä½œä¸ºæ“ä½œç³»ç»Ÿçš„å¸¸é©»ç¨‹åºï¼Œå”¯ä¸€çš„ä»»åŠ¡å°±æ˜¯åˆ¤æ–­è¿›ç¨‹Xæ˜¯å¦è¢«é€€å‡ºï¼Œå¦‚æœé€€å‡ºäº†ï¼Œå°±é‡æ–°åˆ›å»ºä¸€ä¸ª(å½“ç„¶ï¼Œä¹Ÿå¯èƒ½æœ‰äººæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆç°åœ¨çš„ Linux å¼€å¤šä¸ª bash éƒ½æ²¡æœ‰é—®é¢˜å‘¢? è¿™é‡Œæœ‰ä¸ªçŒœæµ‹æ˜¯æœ‰ä¸€ä¸ªéšè—çš„ shell æ˜¯è¢« 1 å·ä»»åŠ¡å¯åŠ¨çš„ï¼Œå…¶å®ƒçš„ bash æ˜¯å¤šä½™çš„ã€‚ä¸è¿‡è¿™åªæ˜¯çŒœæµ‹ï¼Œå¾…è€ƒå¯Ÿ)</p><h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><h3 id="é™„å½•ä¸€"><a href="#é™„å½•ä¸€" class="headerlink" title="é™„å½•ä¸€"></a>é™„å½•ä¸€</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">|-- Makefile</span><br><span class="line">|-- boot</span><br><span class="line">|   |-- head.s</span><br><span class="line">|-- fs</span><br><span class="line">|   |-- Makefile</span><br><span class="line">|   |-- bitmap.c</span><br><span class="line">|   |-- block_dev.c</span><br><span class="line">|   |-- buffer.c</span><br><span class="line">|   |-- char_dev.c</span><br><span class="line">|   |-- exec.c</span><br><span class="line">|   |-- fcntl.c</span><br><span class="line">|   |-- file_dev.c</span><br><span class="line">|   |-- file_table.c</span><br><span class="line">|   |-- inode.c</span><br><span class="line">|   |-- ioctl.c</span><br><span class="line">|   |-- namei.c</span><br><span class="line">|   |-- open.c</span><br><span class="line">|   |-- pipe.c</span><br><span class="line">|   |-- read_write.c</span><br><span class="line">|   |-- stat.c</span><br><span class="line">|   |-- super.c</span><br><span class="line">|   `-- truncate.c</span><br><span class="line">|-- include</span><br><span class="line">|   |-- a.out.h</span><br><span class="line">|   |-- asm</span><br><span class="line">|   |   |-- io.h</span><br><span class="line">|   |   |-- memory.h</span><br><span class="line">|   |   |-- segment.h</span><br><span class="line">|   |   `-- system.h</span><br><span class="line">|   |-- const.h</span><br><span class="line">|   |-- ctype.h</span><br><span class="line">|   |-- errno.h</span><br><span class="line">|   |-- fcntl.h</span><br><span class="line">|   |-- linux</span><br><span class="line">|   |   |-- config.h</span><br><span class="line">|   |   |-- fdreg.h</span><br><span class="line">|   |   |-- fs.h</span><br><span class="line">|   |   |-- hdreg.h</span><br><span class="line">|   |   |-- head.h</span><br><span class="line">|   |   |-- kernel.h</span><br><span class="line">|   |   |-- mm.h</span><br><span class="line">|   |   |-- sched.h</span><br><span class="line">|   |   |-- sys.h</span><br><span class="line">|   |   `-- tty.h</span><br><span class="line">|   |-- signal.h</span><br><span class="line">|   |-- stdarg.h</span><br><span class="line">|   |-- stddef.h</span><br><span class="line">|   |-- string.h</span><br><span class="line">|   |-- sys</span><br><span class="line">|   |   |-- stat.h</span><br><span class="line">|   |   |-- times.h</span><br><span class="line">|   |   |-- types.h</span><br><span class="line">|   |   |-- utsname.h</span><br><span class="line">|   |   `-- wait.h</span><br><span class="line">|   |-- termios.h</span><br><span class="line">|   |-- time.h</span><br><span class="line">|   |-- unistd.h</span><br><span class="line">|   `-- utime.h</span><br><span class="line">|-- init</span><br><span class="line">|   |-- main.c</span><br><span class="line">|-- kernel</span><br><span class="line">|   |-- Makefile</span><br><span class="line">|   |-- asm.o</span><br><span class="line">|   |-- asm.s</span><br><span class="line">|   |-- blk_drv</span><br><span class="line">|   |   |-- Makefile</span><br><span class="line">|   |   |-- blk.h</span><br><span class="line">|   |   |-- floppy.c</span><br><span class="line">|   |   |-- hd.c</span><br><span class="line">|   |   |-- ll_rw_blk.c</span><br><span class="line">|   |   `-- ramdisk.c</span><br><span class="line">|   |-- chr_drv</span><br><span class="line">|   |   |-- Makefile</span><br><span class="line">|   |   |-- console.c</span><br><span class="line">|   |   |-- keyboard.S</span><br><span class="line">|   |   |-- rs_io.s</span><br><span class="line">|   |   |-- serial.c</span><br><span class="line">|   |   |-- tty_io.c</span><br><span class="line">|   |   `-- tty_ioctl.c</span><br><span class="line">|   |-- exit.c</span><br><span class="line">|   |-- fork.c</span><br><span class="line">|   |-- fork.i</span><br><span class="line">|   |-- math</span><br><span class="line">|   |   |-- Makefile</span><br><span class="line">|   |   `-- math_emulate.c</span><br><span class="line">|   |-- mktime.c</span><br><span class="line">|   |-- panic.c</span><br><span class="line">|   |-- printk.c</span><br><span class="line">|   |-- sched.c</span><br><span class="line">|   |-- sched.o</span><br><span class="line">|   |-- signal.c</span><br><span class="line">|   |-- sys.c</span><br><span class="line">|   |-- system_call.o</span><br><span class="line">|   |-- system_call.s</span><br><span class="line">|   |-- traps.c</span><br><span class="line">|   |-- traps.o</span><br><span class="line">|   `-- vsprintf.c</span><br><span class="line">|-- lib</span><br><span class="line">|   |-- Makefile</span><br><span class="line">|   |-- _exit.c</span><br><span class="line">|   |-- close.c</span><br><span class="line">|   |-- ctype.c</span><br><span class="line">|   |-- dup.c</span><br><span class="line">|   |-- errno.c</span><br><span class="line">|   |-- execve.c</span><br><span class="line">|   |-- malloc.c</span><br><span class="line">|   |-- open.c</span><br><span class="line">|   |-- setsid.c</span><br><span class="line">|   |-- string.c</span><br><span class="line">|   |-- wait.c</span><br><span class="line">|   `-- write.c</span><br><span class="line">|-- mm</span><br><span class="line">|   |-- Makefile</span><br><span class="line">|   |-- memory.c</span><br><span class="line">|   `-- page.s</span><br><span class="line">`-- tools</span><br><span class="line">    `-- build.c</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æ¬¡æ‹–å¾—æœ‰å¤Ÿä¹…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å°†çŸ¥è¯†ä¸²è”èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ›´ä½•å†µå¾ˆå¤šå†…å®¹å¯ä»¥è¯´å’Œå¸¸ç†(ä¸ªäººç†è§£çš„å¸¸ç†)æœ‰äº†æ¯”è¾ƒå¤§çš„åå·®ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¿‡ç¡®å®æ¯”è¾ƒæœ‰æ„æ€ã€‚ä»å¼•å¯¼ç¨‹åºåˆ°æ“ä½œç³»ç»Ÿå¯åŠ¨ï¼Œè¿™ä¸­é—´ç©¶ç«Ÿç»å†äº†å¤šå°‘æµç¨‹å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;ç”±äºæœ‰äº†å‰å‡ èŠ‚çš„å†…å®¹ï¼Œè¿™é‡Œä¸ä¼šå†å¯¹å¼•å¯¼ç¨‹åºåŠæ±‡ç¼–è¯­æ³•åšè¿‡å¤šçš„ä»‹ç»ã€‚è€Œç€é‡åœ¨äºæ•´ä¸ªæµç¨‹çš„æè¿°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="OS" scheme="https://DorMOUSE-None.github.io/tags/OS/"/>
    
  </entry>
  
  <entry>
    <title>Understand MAIL</title>
    <link href="https://DorMOUSE-None.github.io/2018-09-27-mail/"/>
    <id>https://DorMOUSE-None.github.io/2018-09-27-mail/</id>
    <published>2018-09-26T16:00:00.000Z</published>
    <updated>2018-09-28T10:10:21.579Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç½‘ç»œåè®®ä¸Šï¼Œé«˜å±‚åè®®ç¡®å®æ¯”åº•å±‚åè®®æ›´å®¹æ˜“ç†è§£ï¼Œä¹Ÿæ›´åŠ çš„äººæ€§åŒ–ã€‚<br>ä¼ è¾“å±‚çš„ TCP, UDP éƒ½è¿˜åœç•™åœ¨å„ç§å­—èŠ‚å†…å®¹çš„æ•´åˆå’Œæ ¡éªŒä¸Šï¼Œè€Œæ›´ä¸Šå±‚çš„åº”ç”¨å±‚åè®®å°±å·²ç»èƒ½å¤Ÿç›´è§‚åˆ°é€šè¿‡ç›´æ¥è§£è¯»å°±èƒ½ç†è§£å…¶æ¯æ¡æ¶ˆæ¯çš„å«ä¹‰äº†ã€‚</p><a id="more"></a><h2 id="SMTP-åè®®"><a href="#SMTP-åè®®" class="headerlink" title="SMTP åè®®"></a>SMTP åè®®</h2><p>SMTPï¼Œç®€å•é‚®ä»¶ä¼ è¾“åè®®ã€‚å•ä»åè®®å†…å®¹ä¸Šæ¥è¯´ç¡®å®æ²¡æœ‰å¤ªå¤šçš„å­¦ä¹ éš¾åº¦ã€‚ä½†æ˜¯ï¼Œæ‰­è½¬â€œå¸¸è¯†â€æ°æ°æ˜¯å·¨å¤§çš„ç»Šè„šçŸ³ã€‚<br>ç›´æ¥å°±è¿›å…¥äº†ç½‘é¡µé‚®ä»¶ç³»ç»Ÿ or å®¢æˆ·ç«¯é‚®ä»¶ç³»ç»Ÿçš„æ—¶ä»£ã€‚å›¾å½¢åŒ–çš„ç•Œé¢é…åˆä¸Šä¸€äº›å…³é”®å­—çš„å†…å®¹ (æ¯”å¦‚æ”¶ä»¶äººï¼Œä¸»é¢˜ç­‰)ã€‚<br>ç‚¹å‡»å‘é€å°±è§‰å¾—ä¸€å°é‚®ä»¶å·²ç»å‘å‡ºå»äº†ã€‚</p><p>ä½†æ˜¯ï¼Œç©¶ç«Ÿè¿™ä¸­é—´åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ<br>163ï¼ŒGMAIL, QQ ç­‰é‚®ç®±ç©¶ç«Ÿåˆåœ¨å…¶ä¸­æ‰®æ¼”ç€æ€æ ·çš„ä¸€ä¸ªè§’è‰²ï¼Ÿ</p><p>é¦–å…ˆï¼ŒSMTP æ˜¯ä¸ºäº†é«˜æ•ˆã€å¯é åœ°ä¼ é€’é‚®ä»¶è€Œå­˜åœ¨çš„ã€‚</p><p>ä¸‹é¢å…ˆç»™ä¸€æ®µæ¼”ç¤ºã€‚é€šè¿‡ telnet è¿æ¥åˆ° 183.57.48.34 (è¿™ä¸ªæ˜¯è…¾è®¯ä¼ä¸šé‚®å…¶ä¸­ä¸€å°æœºå™¨çš„ IP) 25 (SMTP æœåŠ¡ç«¯å£) ï¼Œä»¥æœ¬æœºä½œä¸º SMTP çš„å®¢æˆ·ç«¯ï¼Œè€Œå°† 183.XXX ä½œä¸º SMTP çš„æœåŠ¡ç«¯ï¼Œæ¥å®Œæˆé‚®ä»¶ä¿¡æ¯çš„ä¸€æ¬¡äº¤äº’ã€‚ (å½“ç„¶ï¼Œæœ€åå¤±è´¥äº†ã€‚è¢«ä¼ä¸šé‚®è¯†åˆ«ä¸ºåƒåœ¾é‚®ä»¶äº†â€¦)</p><p>ä¸‹åˆ—æ¯è¡Œ <code>#</code> å¼€å§‹åŠä¹‹åçš„å†…å®¹æ˜¯ä¸ªäººæ·»åŠ çš„æ³¨é‡Šï¼Œå…¶å®ƒå†…å®¹æ˜¯ telnet äº¤äº’çš„å†…å®¹ã€‚<br>åŒæ—¶ï¼Œ<code>--</code> æ ‡å¿—è¯¥è¡Œå†…å®¹ç”±</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ telnet 183.57.48.34 25</span><br><span class="line">Trying 183.57.48.34...</span><br><span class="line">Connected to 183.57.48.34.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">220 bizmx17.qq.com MX QQ Mail Server</span><br><span class="line">HELO test                               -- # MEANS HELLO &lt;domain&gt; åœ¨æ¯æ¬¡å»ºç«‹è¿æ¥é€šé“åï¼Œå‘é€çš„ç¬¬ä¸€æ¡æ¶ˆæ¯</span><br><span class="line">250 bizmx17.qq.com                         # æœåŠ¡å™¨çš„å›å¤å€¼ Code 250 </span><br><span class="line">MAIL FROM: &lt;from@test.net&gt;              -- # MAIL è¡¨ç¤ºé‚®ä»¶çš„å‘èµ·æ–¹ï¼Œç”¨äºé€€ä¿¡ç­‰å…¶ä»–é‚®ä»¶åå‘äº‹ä»¶</span><br><span class="line">250 Ok                                   </span><br><span class="line">RCPT TO: &lt;to@xxx.xxx&gt;                   -- # RCPT è¡¨ç¤ºé‚®ä»¶çš„æ¥æ”¶æ–¹ï¼Œç”¨äºæŠ•é€’é‚®ä»¶ç­‰æ­£å‘äº‹ä»¶</span><br><span class="line">250 Ok</span><br><span class="line">DATA                                    -- # DATA è¡¨ç¤ºä¹‹åçš„å†…å®¹å°†ä½œä¸ºé‚®ä»¶æ­£æ–‡ (æ­£æ–‡è¿™ä¸ªæè¿°å¯èƒ½ä¸å¤ªæ°å½“ï¼Œæ›´åº”è¯¥æ˜¯ç­‰åŒäºä¿¡å°å†…çš„æ‰€æœ‰å†…å®¹)</span><br><span class="line">354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line">                                        --</span><br><span class="line">It&apos;s a fake mail.                       -- # é‚®ä»¶æ­£æ–‡ï¼Œå…¶å®è¿˜å¯ä»¥å†™ä¸Šè¯¸å¦‚ &apos;Subject: XXX&apos; &apos;Cc: XXX&apos; çš„å†…å®¹</span><br><span class="line">.                                       -- # æ­£æ–‡å†…å®¹ç»“æŸçš„æ ‡å¿—ï¼Œ&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line">550 Mail content denied. http://service.exmail.qq.com/cgi-bin/help?subtype=1&amp;&amp;id=20022&amp;&amp;no=1000726 # è¿™é‡Œå¾ˆæ— å¥ˆï¼Œæ²¡è…¾è®¯ç»™æ‹¦äº†ï¼Œæ²¡å‘å‡ºå»ã€‚ä¸è¿‡åæ­£æ˜¯å‡çš„ï¼Œé‚®ä»¶ä¿¡æ¯ä¸å…¨ã€‚</span><br></pre></td></tr></table></figure><h3 id="å‡ ä¸ªä¸»è¦çš„-SMTP-äº¤äº’æŒ‡ä»¤"><a href="#å‡ ä¸ªä¸»è¦çš„-SMTP-äº¤äº’æŒ‡ä»¤" class="headerlink" title="å‡ ä¸ªä¸»è¦çš„ SMTP äº¤äº’æŒ‡ä»¤"></a>å‡ ä¸ªä¸»è¦çš„ SMTP äº¤äº’æŒ‡ä»¤</h3><ul><li>HELO: (HELLO)<br>  ä¸»è¦ç”¨äºè®© SMTP æœåŠ¡å™¨å¯¹å½“å‰è¿æ¥çš„ SMTP å®¢æˆ·ç«¯(ä¸Šä¾‹æ˜¯ telnet æ¨¡æ‹Ÿçš„) å»ºç«‹ä¸€ä¸ªèº«ä»½æ ‡å¿— (ä¸€èˆ¬æ˜¯å½“å‰çš„ä¸»æœºå)</li><li>MAIL:<br>  ç”¨æ³• MAIL FROM: <a href="mailto:&#120;&#x78;&#x40;&#x78;&#x78;&#x2e;&#x78;&#x78;" target="_blank" rel="noopener">&#120;&#x78;&#x40;&#x78;&#x78;&#x2e;&#x78;&#x78;</a> (ä¸åŒºåˆ†å¤§å°å†™)<br>  å¯ä»¥å°†å…¶ä¸æ™®é€šä¿¡ä»¶çš„ä¿¡å°ç­‰åŒã€‚æ¯•ç«Ÿéƒ½æ˜¯è¦å†™ä¸Šå‘ä¿¡äººï¼Œå¦‚æœæ²¡äººæ”¶ä¿¡ï¼Œä¹Ÿå°±å¯ä»¥æ ¹æ®è¿™ä¸ªå£°æ˜å°†ä¿¡ä»¶é€€å›ã€‚</li><li>RCPT: (RECIPIENT)<br>  ç”¨æ³• RCPT TO: <a href="mailto:&#120;&#120;&#x40;&#120;&#x78;&#46;&#120;&#x78;" target="_blank" rel="noopener">&#120;&#120;&#x40;&#120;&#x78;&#46;&#120;&#x78;</a> (å¯å¤šæ¬¡é‡å¤å£°æ˜ï¼Œå³å°†ä¸€å°ä¿¡ä»¶å¤åˆ¶å¤šæ¬¡æŠ•é€ç»™æ¯æ¬¡å£°æ˜çš„å¯¹è±¡)<br>  ç›¸å½“äºæ™®é€šä¿¡ä»¶çš„æ”¶ä¿¡äººã€‚ä¸è¿‡ä¹Ÿæœ‰ç‚¹åŒºåˆ«ï¼Œæ¯•ç«Ÿæ™®é€šä¿¡ä»¶æ²¡æ³•ä¸€ä»¶å¤šå‘å˜›ã€‚</li><li>DATA:<br>  <code>DATA</code> ä¹‹ååˆ° <code>&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</code> ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½ä½œä¸ºé‚®ä»¶çš„æ­£æ–‡å†…å®¹ã€‚ç­‰åŒäºæ™®é€šä¿¡ä»¶ä¿¡å°å†…çš„ä¿¡çº¸(å½“ç„¶äº†ï¼Œä¿¡çº¸ä¸Šåœ¨å†™ä¸Š <code>To XXX:</code> <code>Yours XXX</code> ä¹Ÿæ˜¯å¾ˆæ­£å¸¸çš„å˜›)ï¼Œç±»ä¼¼çš„ä¹Ÿå°±æ˜¯ DATA æ•°æ®ä¸­ä¹Ÿå¯ä»¥åŒ…æ‹¬ <code>Subject:</code> (ä¸»é¢˜), <code>From:</code> (å†™ä¿¡äºº), <code>Date:</code> (æ—¥æœŸ), <code>To:</code>(æ”¶ä»¶äºº)ç­‰å†…å®¹ã€‚</li></ul><hr><h3 id="å‡ ä¸ªæ¬¡è¦çš„-SMTP-äº¤äº’æŒ‡ä»¤"><a href="#å‡ ä¸ªæ¬¡è¦çš„-SMTP-äº¤äº’æŒ‡ä»¤" class="headerlink" title="å‡ ä¸ªæ¬¡è¦çš„ SMTP äº¤äº’æŒ‡ä»¤"></a>å‡ ä¸ªæ¬¡è¦çš„ SMTP äº¤äº’æŒ‡ä»¤</h3><ul><li><p>RSET: (Reset)<br>  é‡ç½®ï¼Œä¸¢å¼ƒä¹‹å‰é’ˆå¯¹é‚®ä»¶æ‰€æè¿°çš„æ‰€æœ‰å†…å®¹ï¼Œé‡æ–°å¼€å§‹ã€‚</p></li><li><p>VRFY: (VERIFY)<br>  ç”¨äºç¡®è®¤æ”¶ä»¶äººæ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠæ”¶ä»¶äººçš„å®Œæ•´åœ°å€</p></li><li><p>NOOP:<br>  å¼ºåˆ¶æœåŠ¡å™¨åšå‡ºä¸€ä¸ªå›åº”ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚</p></li><li><p>QUIT:<br>  è¦æ±‚æ”¶ä¿¡æœåŠ¡å™¨è¿”å›ä¸€ä¸ªé‚®ä»¶æ¥æ”¶æˆåŠŸçš„ä¿¡å·ï¼Œä¹‹åé‡Šæ”¾è¿æ¥é€šé“ã€‚</p></li></ul><h2 id="SMTP-æ‰©å±•"><a href="#SMTP-æ‰©å±•" class="headerlink" title="SMTP æ‰©å±•"></a>SMTP æ‰©å±•</h2><p>å‰é¢æè¿°äº†è¿™ä¹ˆå¤šï¼Œåº”è¯¥æ¥è¯´æ‰¾ä¸€äº›æ”¯æŒ TCP (æˆ–è€…å…¶ä»–ç¨³å®šçš„ä¼ è¾“å±‚è¿æ¥ä¹Ÿæ˜¯å¯ä»¥çš„) è¿æ¥çš„å‘½ä»¤å°±å®Œå…¨å¯ä»¥æ”¯æŒä¸€æ¬¡é‚®ä»¶å‘é€çš„éœ€æ±‚ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœæƒ³è¦å‘é€ä¸€äº›ä¸­æ–‡å­—ç¬¦ä¹‹ç±»çš„ï¼Œé©¬ä¸Šå°±å‡ºç°äº†é—®é¢˜ã€‚</p><p>è¿™é‡Œæœ‰å‡ ç§æ–¹å¼ï¼Œä½†æœ¬äººè¿˜æ²¡æœ‰ç†è§£é€å½»ã€‚ä»…åˆ—å‡ºçŸ¥é“çš„å¯è¡Œæ–¹æ¡ˆã€‚</p><ul><li>é€šè¿‡ IMF (Internet Message Format) è¿›è¡Œå‘ä»¶</li><li>é€šè¿‡ ESMTP </li></ul><h2 id="SMTP-å®‰å…¨"><a href="#SMTP-å®‰å…¨" class="headerlink" title="SMTP å®‰å…¨"></a>SMTP å®‰å…¨</h2><p>å‡ºäº SMTP æœ¬èº«åè®®çš„è®¾è®¡ï¼Œæ²¡æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„èº«ä»½è®¤è¯æœºåˆ¶ã€‚</p><p>çºµä½¿é€šè¿‡ <code>MAIL FROM: &lt;A@test.net&gt;</code> åœ¨ä¿¡å°ä¸Šå†™æ˜äº†æ˜¯ç”± A å‘å‡ºçš„ä¿¡ä»¶ã€‚<br>ä½†æ˜¯ï¼Œè£…åœ¨ä¿¡å°å†…çš„ä¿¡çº¸å´å¯ä»¥å±ä¸Šå¦ä¸€ä¸ªäººçš„åå­—ã€‚</p><p>åˆ©ç”¨è¿™ç§è§„åˆ™ï¼Œä¹Ÿå°±å‡ºç°äº†ä¼ªè£…å‘ä¿¡äººè¿™æ ·çš„æ“ä½œã€‚å½“ç„¶ï¼Œç°åœ¨çš„å¤§é‡é‚®ç®±æœåŠ¡æä¾›å•†éƒ½ä¼šå¯¹è¿™ç§æƒ…å†µè¿›è¡Œæ ‡è®°ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fvpbzedf67j315e01q0sp.jpg" alt="â€œä»£å‘â€æ ‡è®°"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://tools.ietf.org/html/rfc821" target="_blank" rel="noopener">SIMPLE MAIL TRANSFER PROTOCOL</a></li><li><a href="http://www.ruanyifeng.com/blog/2008/06/mime.html" target="_blank" rel="noopener">MIME</a></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ç½‘ç»œåè®®ä¸Šï¼Œé«˜å±‚åè®®ç¡®å®æ¯”åº•å±‚åè®®æ›´å®¹æ˜“ç†è§£ï¼Œä¹Ÿæ›´åŠ çš„äººæ€§åŒ–ã€‚&lt;br&gt;ä¼ è¾“å±‚çš„ TCP, UDP éƒ½è¿˜åœç•™åœ¨å„ç§å­—èŠ‚å†…å®¹çš„æ•´åˆå’Œæ ¡éªŒä¸Šï¼Œè€Œæ›´ä¸Šå±‚çš„åº”ç”¨å±‚åè®®å°±å·²ç»èƒ½å¤Ÿç›´è§‚åˆ°é€šè¿‡ç›´æ¥è§£è¯»å°±èƒ½ç†è§£å…¶æ¯æ¡æ¶ˆæ¯çš„å«ä¹‰äº†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="mail" scheme="https://DorMOUSE-None.github.io/tags/mail/"/>
    
      <category term="SMTP" scheme="https://DorMOUSE-None.github.io/tags/SMTP/"/>
    
      <category term="TCP" scheme="https://DorMOUSE-None.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>TCP SYN åŒ…æ¨¡æ‹Ÿ</title>
    <link href="https://DorMOUSE-None.github.io/2018-09-18-TCP-SYN/"/>
    <id>https://DorMOUSE-None.github.io/2018-09-18-TCP-SYN/</id>
    <published>2018-09-17T16:00:00.000Z</published>
    <updated>2018-09-18T10:05:46.320Z</updated>
    
    <content type="html"><![CDATA[<p>å†™äº†ä¸¤å¤©ï¼Œå‡ ä¹æ˜¯ä»é›¶å¼€å§‹ï¼ŒC è¯­è¨€æäº†ä¸€ä¸ªå‘ TCP SYN åŒ…çš„å°ç¨‹åºã€‚<br>ä»åè®®åˆ°ç¨‹åºä»£ç çš„è½¬æ¢ï¼Œç¡®å®æ²¡æœ‰èŠ±è´¹å¤ªå¤šçš„æ—¶é—´ï¼Œä½†æ˜¯ä¸ºäº†å­—èŠ‚åº(byteorder)çš„é—®é¢˜ç®€ç›´æŠ˜è…¾å¾—â€¦</p><a id="more"></a><h2 id="TCP-é¦–éƒ¨æ ¼å¼"><a href="#TCP-é¦–éƒ¨æ ¼å¼" class="headerlink" title="TCP é¦–éƒ¨æ ¼å¼"></a>TCP é¦–éƒ¨æ ¼å¼</h2><p>ä» RFC 793 äº†è§£åˆ°åŸºç¡€çš„ TCP é¦–éƒ¨æ ¼å¼(å½“ç„¶ï¼Œæ¨¡æ‹Ÿä¸‰æ¬¡æ¡æ‰‹çš„ SYN åŒ…ä¹Ÿæ ¹æœ¬ä¸éœ€è¦å¡«å……ä»»ä½•æ•°æ®)ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          Source Port          |       Destination Port        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                        Sequence Number                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Acknowledgment Number                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Data |           |U|A|P|R|S|F|                               |</span><br><span class="line">| Offset| Reserved  |R|C|S|S|Y|I|            Window             |</span><br><span class="line">|       |           |G|K|H|T|N|N|                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Checksum            |         Urgent Pointer        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                             data                              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p>å¯¹äºä»…ä»…æ¨¡æ‹Ÿä¸€ä¸ª SYN åŒ…è€Œè¨€ï¼Œä¼¼ä¹æ— éœ€å…³å¿ƒ Sequence Number, Ack Number, Window ç­‰ä¿¡æ¯ï¼Œæ¯•ç«Ÿéƒ½ä¸å…³å¿ƒæœåŠ¡å™¨ç«¯ç»™çš„è¿”å›ã€‚<br>æœ€ä½çš„è¦æ±‚ï¼Œä»…ä»…æ˜¯å‘ä¸€ä¸ªåˆæ³•çš„ TCP æŠ¥æ–‡ï¼Œå¾—åˆ°æœåŠ¡å™¨ç«¯çš„åé¦ˆï¼Œè€Œéç›´æ¥è¢«æœåŠ¡å™¨ç«¯ä¸¢å¼ƒ(å¦‚æœè¢«éªŒè¯åˆ°æŠ¥æ–‡éæ³•æˆ–è€…æ•°æ®å‡ºé”™ç­‰)ã€‚</p><p>é‚£ä¹ˆï¼Œæœ€ä¸ºé‡è¦çš„ç»†èŠ‚å°±æ˜¯ Checksum (æ ¡éªŒå’Œ) äº†ã€‚æœåŠ¡å™¨ç«¯ä¼šå¯¹æ¥æ”¶åˆ°çš„æ•°æ®æµè¿›è¡Œæ ¡éªŒï¼Œå¦‚æœæœ‰å·®é”™ï¼Œåˆ™ç›´æ¥ä¸¢å¼ƒï¼Œè€Œæ— ä»»ä½•ç»“æœã€‚</p><h2 id="æ ¡éªŒå’Œ"><a href="#æ ¡éªŒå’Œ" class="headerlink" title="æ ¡éªŒå’Œ"></a>æ ¡éªŒå’Œ</h2><p>ä»ç»†èŠ‚ä¸Šæ¥è¯´ï¼Œç½‘ç»œåè®®ä¸­çš„æ ¡éªŒå’Œæ˜¾å¾—æ¯”è¾ƒç®€å•ã€‚ä»¥ TCP åè®®çš„ Checksum å­—æ®µä¸¾ä¾‹ï¼Œå°±æ˜¯ä¸ºäº†è®©ä¼ªé¦–éƒ¨(TCP é¦–éƒ¨ + source IP + destination IP ç­‰ä¸€äº›é¢å¤–ä¿¡æ¯)<br>ä»¥æ¯ 16 ä½ (2 å­—èŠ‚) ä¸ºä¸€ä¸ªå•ä½ï¼Œå¾ªç¯ç´¯åŠ å’Œæœ€ç»ˆè¾¾åˆ° 0xFFFF çš„æ•ˆæœã€‚</p><p>ä¸‹é¢ä»¥ä¸€ä¸ªç”± Source IP: 172.16.2.101 -&gt; Destination IP: 172.16.2.127 çš„ TCP é¦–éƒ¨ä¸ºä¾‹è¿›è¡Œç»†èŠ‚æè¿°:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># æ€»é•¿ä¸º 20 å­—èŠ‚çš„ TCP æŠ¥æ–‡é¦–éƒ¨</span><br><span class="line">27 11 0f a0 00 00 00 00 00 00 00 00 50 02 ff 00 1d 2c 00 00</span><br><span class="line"></span><br><span class="line">src Port: 0x2711 -&gt; 10001</span><br><span class="line">dst Port: 0x0fa0 -&gt; 4000</span><br><span class="line">Seq nr: 0x00000000 -&gt; 0</span><br><span class="line">Ack nr: 0x00000000 -&gt; 0</span><br><span class="line">Data off: 5 -&gt; 32 bits æ•°é‡æ˜¯ 5 -&gt; 20 å­—èŠ‚ (å³ TCP é¦–éƒ¨é•¿åº¦ä¸º 20 å­—èŠ‚)</span><br><span class="line">FLAG: 0x02 -&gt; urg ack psh rst SYN fin </span><br><span class="line">Window: 0xFF00 (çª—å£å¤§å°ä¸º 65280 å­—èŠ‚)</span><br><span class="line">chk sum: 0x1d2c</span><br><span class="line">urg pointer: 0x0000</span><br></pre></td></tr></table></figure><p>åœ¨è®¡ç®—ä¹‹å‰ï¼ŒTCP æ ¡éªŒå’Œè¿˜å°†æ¶‰åŠåˆ°ä¼ªé¦–éƒ¨çš„æ¦‚å¿µ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|           Source Address          |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|         Destination Address       |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|  zero  |  PTCL  |    TCP Length   |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line"></span><br><span class="line">åœ¨æ­¤ä¾‹ä¸­:</span><br><span class="line">Source Address: 172.16.2.101 -&gt; 0xAC100265</span><br><span class="line">Destination Address: 172.16.2.127 -&gt; 0XAC10027F</span><br><span class="line">zero: 0x00</span><br><span class="line">PTCL(protocol): TCP(6) -&gt; 0x06</span><br><span class="line">TCP Length: 20 bytes -&gt; 0x0014</span><br></pre></td></tr></table></figure><p>å³åŠ ä¸Šä¼ªé¦–éƒ¨çš„å†…å®¹ï¼Œéœ€è¦å…±åŒè¿›è¡Œæ ¡éªŒçš„æ•°æ®æµå¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ac 10 02 65 ac 10 02 7f 00 06 00 14 27 11 0f a0 00 00 00 00 00 00 00 00 50 02 ff 00 1d 2c 00 00</span><br></pre></td></tr></table></figure></p><h3 id="æœåŠ¡å™¨ç«¯æ ¡éªŒ"><a href="#æœåŠ¡å™¨ç«¯æ ¡éªŒ" class="headerlink" title="æœåŠ¡å™¨ç«¯æ ¡éªŒ"></a>æœåŠ¡å™¨ç«¯æ ¡éªŒ</h3><p>æœåŠ¡å™¨ç«¯æ¥æ”¶åˆ° TCP æŠ¥æ–‡åï¼Œå°†å¯¹æ•´ä¸ªéœ€è¦æ ¡éªŒçš„æ•°æ®æµï¼ŒæŒ‰ 16 bits (2å­—èŠ‚) ä¸ºå•ä½ï¼Œè¿›è¡Œç´¯åŠ ã€‚</p><p>å³: <code>0xac10+0x0265+0xac10+0x027f+0x0006+0x0014+0x2711+0x0fa0+0x0000+0x0000+0x0000+0x0000+0x5002+0xff00+0x1d2c+0x0000 = 0x2fffd</code></p><p>å¯¹äºè¶…é•¿è®¡ç®—ç»“æœ (è¶…å‡º 0xFFFF) ï¼Œå¾ªç¯å°†é«˜ä½å³ç§» 16 ä½ä¸ä½ä½è¿›è¡Œç´¯åŠ ï¼Œç›´åˆ°ç»“æœ &lt;= 0xFFFF ï¼Œå³ <code>0x20000 &gt;&gt; 16 + 0xfffd = 0xffff</code></p><p>å¦‚æœæœ€ç»ˆç»“æœ <code>=0xffff</code>(å…¨ä¸º 1) ï¼Œåˆ™è®¤ä¸º TCP é¦–éƒ¨æ²¡æœ‰é—®é¢˜ï¼ŒæœåŠ¡å™¨ç«¯æ¥æ”¶æŠ¥æ–‡ï¼Œå¹¶å›å¤ ACK SYN åŒ…ã€‚</p><h3 id="å®¢æˆ·ç«¯æ„é€ æ ¡éªŒå’Œ"><a href="#å®¢æˆ·ç«¯æ„é€ æ ¡éªŒå’Œ" class="headerlink" title="å®¢æˆ·ç«¯æ„é€ æ ¡éªŒå’Œ"></a>å®¢æˆ·ç«¯æ„é€ æ ¡éªŒå’Œ</h3><p>ä¸æœåŠ¡å™¨ç«¯ç›¸å¯¹ï¼Œæ˜¾ç„¶å®¢æˆ·ç«¯å¿…é¡»é€šè¿‡ Check sum ï¼Œä½¿å¾—æœ€ç»ˆçš„ç»“æœæœåŠ¡å™¨ç«¯æ ¡éªŒçš„æ¡ä»¶ã€‚</p><p>ä½œä¸ºåå‘é—®é¢˜ï¼ŒåŒæ ·ä»¥ä¸Šé¢ä¸ºä¾‹å­ï¼Œå‡è®¾ check sum è¿˜æœªç¡®å®šå…·ä½“çš„å€¼ã€‚åˆ™è®¡ç®—æ–¹å¼å¦‚ä¸‹:</p><p>åŠ ä¸Šä¼ªé¦–éƒ¨, æ ¡éªŒå’Œæš‚æ—¶ç½®é›¶çš„æ•°æ®æµ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ac 10 02 65 ac 10 02 7f 00 06 00 14 27 11 0f a0 00 00 00 00 00 00 00 00 50 02 ff 00 00 00 00 00</span><br></pre></td></tr></table></figure><p>ä½œä¸ºé€†è¿‡ç¨‹ï¼ŒæŒ‰ 16 bits ä¸ºå•ä½ï¼Œè¿›è¡Œç´¯åŠ ã€‚å³: <code>0xac10+0x0265+0xac10+0x027f+0x0006+0x0014+0x2711+0x0fa0+0x0000+0x0000+0x0000+0x0000+0x5002+0xff00+0x0000+0x0000 = 0x2e2d1</code></p><p>è¶…é•¿éƒ¨åˆ†å¾ªç¯ç´¯åŠ ï¼Œ<code>0x20000 &gt;&gt; 16 + 0xe2d1 = 0xe2d3</code></p><p>ç»“æœå–åï¼Œ<code>~ 0xe2d3 = 0x1d2c</code></p><p>å³è®¤ä¸º <code>0x1d2c</code> ä¸ºæ ¡éªŒå’Œ</p><h2 id="HBO-ä¸-NBO"><a href="#HBO-ä¸-NBO" class="headerlink" title="HBO ä¸ NBO"></a>HBO ä¸ NBO</h2><p>HBO: host byte order<br>NBO: network byte order </p><p>è¯´èµ·å­—èŠ‚åºç®€ç›´èƒ½å¤ŸæŠŠäººé€¼ç–¯ï¼Œè¯´å®è¯è™½ç„¶æœ‰ä¸€å®šçš„å†å²åŸå› ï¼Œä½†æ˜¯ä¸åšç»Ÿä¸€çœŸçš„å¯¹åº•å±‚ç¼–ç¨‹ç›¸å½“å¾—ä¸å‹å¥½ã€‚</p><p>ä¸è¿‡ï¼Œå†åŒçƒ¦ä¹Ÿä¸èƒ½æ”¹å˜ä»€ä¹ˆã€‚æ€»è¿˜å¾—ç»§ç»­å†™ä»£ç ä¸æ˜¯å˜›ã€‚</p><h3 id="ä¸»æœºå­—èŠ‚åº-HBO-Host-Byte-Order"><a href="#ä¸»æœºå­—èŠ‚åº-HBO-Host-Byte-Order" class="headerlink" title="ä¸»æœºå­—èŠ‚åº (HBO, Host Byte Order)"></a>ä¸»æœºå­—èŠ‚åº (HBO, Host Byte Order)</h3><p>é‡‡ç”¨å°ç«¯å­—èŠ‚æ’åºæ–¹å¼ã€‚ç®€å•æè¿°ä¸º é«˜ä½å­—èŠ‚å­˜æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€å¤„ï¼Œä½ä½å­—èŠ‚å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€å¤„ã€‚</p><p>ä»¥ 4 å­—èŠ‚ int å‹æ•°æ® 0xAB1267EF ä¸ºä¾‹:</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fvdu3zhh92j31040newel.jpg" alt=""></p><p>è€Œç¨‹åºè¯»å–æ•°æ®çš„é¡ºåºï¼Œå¦‚æœä¸è€ƒè™‘æ•°æ®ç±»å‹ï¼ŒæŒ‰å­—èŠ‚è¯»å–ï¼Œæ™®éå°†é‡‡ç”¨å­—èŠ‚é€’å¢åºè¯»å–ï¼Œåˆ™ä¼˜å…ˆå°†è¯»åˆ° 0xEF ç­‰ä½ä½å­—èŠ‚æ•°æ®</p><h3 id="ç½‘ç»œå­—èŠ‚åº-NBO-Network-Byte-Order"><a href="#ç½‘ç»œå­—èŠ‚åº-NBO-Network-Byte-Order" class="headerlink" title="ç½‘ç»œå­—èŠ‚åº (NBO, Network Byte Order)"></a>ç½‘ç»œå­—èŠ‚åº (NBO, Network Byte Order)</h3><p>é‡‡ç”¨å¤§ç«¯å­—èŠ‚æ’åºæ–¹å¼ã€‚ç®€å•æè¿°ä¸ºé€šè¿‡ç½‘ç»œæ¥æ”¶åˆ°æ•°æ®æ—¶å°†ä¼˜å…ˆæ¥æ”¶åˆ°æ•°æ®çš„é«˜ä½å­—èŠ‚ï¼Œç„¶åå†å¾—åˆ°ä½ä½å­—èŠ‚ã€‚</p><p>è¿˜æ˜¯ä»¥ 4 å­—èŠ‚ int å‹æ•°æ® 0xAB1267EF ä¸ºä¾‹:</p><p>åˆ™é€šè¿‡ç½‘ç»œå¾—åˆ°çš„æ•°æ®æµå°†æ˜¯ <code>0xEF 0x67 0x12 0xAB</code></p><h3 id="å®é™…ä½¿ç”¨"><a href="#å®é™…ä½¿ç”¨" class="headerlink" title="å®é™…ä½¿ç”¨"></a>å®é™…ä½¿ç”¨</h3><p>C è¯­è¨€ï¼ŒBSD å¹³å°çš„ netinet/tcp.h å®šä¹‰äº† tcp header ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span>th_sport;<span class="comment">/* source port */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span>th_dport;<span class="comment">/* destination port */</span></span><br><span class="line">tcp_seqth_seq;<span class="comment">/* sequence number */</span></span><br><span class="line">tcp_seqth_ack;<span class="comment">/* acknowledgement number */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __DARWIN_BYTE_ORDER == __DARWIN_LITTLE_ENDIAN</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>th_x2:<span class="number">4</span>,<span class="comment">/* (unused) */</span></span><br><span class="line">th_off:<span class="number">4</span>;<span class="comment">/* data offset */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __DARWIN_BYTE_ORDER == __DARWIN_BIG_ENDIAN</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>th_off:<span class="number">4</span>,<span class="comment">/* data offset */</span></span><br><span class="line">th_x2:<span class="number">4</span>;<span class="comment">/* (unused) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>th_flags;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_FIN0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_SYN0x02</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_RST0x04</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_PUSH0x08</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_ACK0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_URG0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_ECE0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_CWR0x80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>TH_FLAGS(TH_FIN|TH_SYN|TH_RST|TH_ACK|TH_URG|TH_ECE|TH_CWR)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span>th_win;<span class="comment">/* window */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span>th_sum;<span class="comment">/* checksum */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span>th_urp;<span class="comment">/* urgent pointer */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>unsigned char</code> ä¹‹ç±»çš„å•å­—èŠ‚æ•°æ®ï¼Œå°†ä¸å­˜åœ¨ä»»ä½•é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¯¸å¦‚ <code>unsigned short</code> ç­‰å¤šå­—èŠ‚æ•°æ®ï¼Œå°†æ¶‰åŠåˆ°å­—èŠ‚åºçš„è½¬æ¢ã€‚</p><p>æ¯”å¦‚ï¼Œè™½ç„¶ä»¤ <code>th_sport = 0x2711 (10001)</code> çœ‹ä¼¼åˆç†ã€‚ä½†æ˜¯ï¼Œä»å†…å­˜çš„è§’åº¦æ¥çœ‹ï¼Œæ•°æ®å°†è¢«å­˜å‚¨ä¸º </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># å‡è®¾èµ·å§‹ç‰©ç†å†…å­˜åœ°å€ä¸º 0x00007c000</span><br><span class="line">0x00007c01: 0x27 </span><br><span class="line">0x00007c00: 0x11</span><br></pre></td></tr></table></figure><p>ç­‰åˆ°æ„é€ å®Œ TCP é¦–éƒ¨ï¼Œé¡ºæ¬¡åœ°å‘é€æ•°æ®æ—¶ï¼Œå‘ˆç°çš„æ•°æ®æµå°†å½¢å¦‚: <code>0x11 0x27...</code> å³ä½¿ç”¨é‡Œ HBO (å°ç«¯å­—èŠ‚åº) çš„æ•°æ®æ— æ³•æ»¡è¶³ NBO (å¤§ç«¯å­—èŠ‚åº) çš„è¦æ±‚ã€‚<br>æ¯•ç«Ÿï¼Œä¸¤è€…ç›¸äº’å¯¹ç«‹ã€‚</p><p>å› æ­¤ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„å­—èŠ‚åºçš„é—®é¢˜ã€‚å½“ç„¶ï¼ŒC è¯­è¨€è¿˜æ˜¯æƒ³å½“å‹å¥½åœ°æä¾›äº†å­—èŠ‚åºè½¬æ¢çš„å·¥å…· <code>htons</code>, <code>htonl</code>, <code>ntohs</code>, <code>ntohl</code> ã€‚è¯¦æƒ…è¯·é€šè¿‡ <code>man byteorder</code> æŸ¥çœ‹ã€‚</p><h2 id="TCP-SYN-çš„ç®€å•ä¾‹ç¨‹"><a href="#TCP-SYN-çš„ç®€å•ä¾‹ç¨‹" class="headerlink" title="TCP SYN çš„ç®€å•ä¾‹ç¨‹"></a>TCP SYN çš„ç®€å•ä¾‹ç¨‹</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * +--------+--------+--------+--------+</span></span><br><span class="line"><span class="comment"> * |           Source Address          |</span></span><br><span class="line"><span class="comment"> * +--------+--------+--------+--------+</span></span><br><span class="line"><span class="comment"> * |         Destination Address       |</span></span><br><span class="line"><span class="comment"> * +--------+--------+--------+--------+</span></span><br><span class="line"><span class="comment"> * |  zero  |  PTCL  |    TCP Length   |</span></span><br><span class="line"><span class="comment"> * +--------+--------+--------+--------+</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pseudohdr</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> src_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> dst_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> zero:<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> protocol:<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> tcp_length;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> <span class="title">tcpHdr</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">check_sum</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> *ptr, <span class="keyword">size_t</span> nbytes)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(nbytes &gt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        sum += htons(*ptr++);</span><br><span class="line">        nbytes -= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sum = (sum &gt;&gt; <span class="number">16</span>) + (sum &amp; <span class="number">0xFFFF</span>);</span><br><span class="line">    sum = (sum &gt;&gt; <span class="number">16</span>) + (sum &amp; <span class="number">0xFFFF</span>);</span><br><span class="line"></span><br><span class="line">    sum = ~sum;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">short</span>) sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct tcphdr * <span class="title">init_tcp_header</span><span class="params">(<span class="keyword">int</span> sport)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> * <span class="title">header</span> = (<span class="title">struct</span> <span class="title">tcphdr</span> *) <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">tcphdr</span>));</span></span><br><span class="line">    header-&gt;th_sport = htons(sport);    <span class="comment">// æºç«¯å£</span></span><br><span class="line">    header-&gt;th_dport = htons(<span class="number">4000</span>);     <span class="comment">// ç›®æ ‡ç«¯å£</span></span><br><span class="line">    header-&gt;th_seq = <span class="number">0</span>;                <span class="comment">// åºåˆ—å·</span></span><br><span class="line">    header-&gt;th_ack = <span class="number">0</span>;                <span class="comment">// ç¡®è®¤åºå· | ACK ç½®ä½æ—¶æœ‰æ•ˆ</span></span><br><span class="line">    header-&gt;th_off = <span class="keyword">sizeof</span>(struct tcphdr) / <span class="number">4</span>;   <span class="comment">// TCP é¦–éƒ¨é•¿åº¦ (å­—èŠ‚)</span></span><br><span class="line">    header-&gt;th_flags = TH_SYN;      <span class="comment">// æ ‡å¿—ä½</span></span><br><span class="line">    header-&gt;th_win = <span class="number">255</span>;           <span class="comment">// æ•°æ®çª—å£å¤§å°</span></span><br><span class="line">    header-&gt;th_sum = <span class="number">0</span>;             <span class="comment">// æ ¡éªŒå€¼ (å…ˆç½®ä¸º 0, ç­‰ä¼šå†ä¿®æ­£)</span></span><br><span class="line">    header-&gt;th_urp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> header;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcp_syn</span><span class="params">(<span class="keyword">int</span> tcp_sock, struct tcphdr *header)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *) <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">sockaddr_in</span>));</span></span><br><span class="line">    addr-&gt;sin_family = PF_INET;</span><br><span class="line">    addr-&gt;sin_port = htons(<span class="number">4000</span>);</span><br><span class="line">    addr-&gt;sin_addr.s_addr = inet_addr(<span class="string">"172.16.2.127"</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> size = sendto(tcp_sock, header, <span class="keyword">sizeof</span>(struct tcphdr), <span class="number">0</span>, (struct sockaddr *)addr, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tcp_sock = socket(PF_INET, SOCK_RAW, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span>(tcp_sock == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Open Socket Failed: %s(errno: %d)\n"</span>, strerror(errno), errno);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcpHdr</span> = <span class="title">init_tcp_header</span>(10001);</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pseudohdr</span> *<span class="title">psdHdr</span> = (<span class="title">struct</span> <span class="title">pseudohdr</span> *) <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">pseudohdr</span>));</span></span><br><span class="line">    psdHdr-&gt;src_addr = inet_addr(<span class="string">"172.16.2.101"</span>);</span><br><span class="line">    psdHdr-&gt;dst_addr = inet_addr(<span class="string">"172.16.2.127"</span>);</span><br><span class="line">    psdHdr-&gt;zero = <span class="number">0</span>;</span><br><span class="line">    psdHdr-&gt;protocol = <span class="number">6</span>;</span><br><span class="line">    psdHdr-&gt;tcp_length = htons(<span class="keyword">sizeof</span>(struct tcphdr));</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;psdHdr-&gt;tcpHdr, tcpHdr, <span class="keyword">sizeof</span>(struct tcphdr));</span><br><span class="line">    tcpHdr-&gt;th_sum = htons(check_sum((<span class="keyword">unsigned</span> <span class="keyword">short</span> *) psdHdr, <span class="keyword">sizeof</span>(struct pseudohdr)));</span><br><span class="line">    <span class="built_in">free</span>(psdHdr);</span><br><span class="line"></span><br><span class="line">    tcp_syn(tcp_sock, tcpHdr);</span><br><span class="line">    <span class="built_in">free</span>(tcpHdr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å†™äº†ä¸¤å¤©ï¼Œå‡ ä¹æ˜¯ä»é›¶å¼€å§‹ï¼ŒC è¯­è¨€æäº†ä¸€ä¸ªå‘ TCP SYN åŒ…çš„å°ç¨‹åºã€‚&lt;br&gt;ä»åè®®åˆ°ç¨‹åºä»£ç çš„è½¬æ¢ï¼Œç¡®å®æ²¡æœ‰èŠ±è´¹å¤ªå¤šçš„æ—¶é—´ï¼Œä½†æ˜¯ä¸ºäº†å­—èŠ‚åº(byteorder)çš„é—®é¢˜ç®€ç›´æŠ˜è…¾å¾—â€¦&lt;/p&gt;
    
    </summary>
    
    
      <category term="TCP" scheme="https://DorMOUSE-None.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>Preprocessor Output</title>
    <link href="https://DorMOUSE-None.github.io/2018-09-08-preprocessor-output/"/>
    <id>https://DorMOUSE-None.github.io/2018-09-08-preprocessor-output/</id>
    <published>2018-09-07T16:00:00.000Z</published>
    <updated>2018-09-08T06:59:35.638Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘é‡æ–°å¼€å§‹å›é¡¾ C è¯­è¨€ä»¥åŠå…¶ç¼–è¯‘åçš„æ–‡ä»¶æ ¼å¼ ELFã€‚<br>æš‚æ—¶å‘Šåˆ«ä¸€æ­¥åˆ°ä½çš„å‘½ä»¤ <code>gcc main.c</code>ï¼Œå¦‚æœä» <code>.c</code> æ–‡ä»¶çš„ç¼–è¯‘æ¥è¯´ï¼Œä¸»è¦åˆ†ä¸ºé¢„ç¼–è¯‘(preprocess)ã€ç¼–è¯‘(Compilation)ã€æ±‡ç¼–(Assembly)ã€é“¾æ¥(Linking) å››ä¸ªæ­¥éª¤ã€‚<br>ä½†æ˜¯ï¼Œä»…ä»…ä»ç¬¬ä¸€ä¸ªæµç¨‹ <strong>é¢„ç¼–è¯‘</strong> è€Œè¨€ï¼Œå°±å·²ç»é‡åˆ°äº†ä¸€äº›éº»çƒ¦ã€‚</p><p><small>program.i</small><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;built-in&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"/usr/include/stdc-predef.h"</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span> <span class="number">2</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"header.h"</span> <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"># <span class="number">2</span> <span class="string">"program.c"</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é¢„ç¼–è¯‘åçš„é—®é¢˜å‡ºç°äº†è¯¸å¦‚ <code># 1 &quot;program.c&quot;</code> çš„ <em>æ³¨é‡Š?</em> </p><p>è¿™é‡Œç®€å•è®°å½•é¢„å¤„ç†è¾“å‡ºæ–‡ä»¶çš„åŸºæœ¬æ ¼å¼ï¼Œæ–¹ä¾¿ä»Šåå›é¡¾ã€‚<br><a id="more"></a></p><h2 id="Output-File-format"><a href="#Output-File-format" class="headerlink" title="Output File format"></a>Output File format</h2><p>é¦–å…ˆï¼Œä»é¢„ç¼–è¯‘çš„ç»“æœçœ‹ï¼Œ<code>cpp (C preprocessor)</code> ç¨‹åºä¸»è¦æ˜¯å¤„ç†äº†æ‰€æœ‰çš„<strong>å®æŒ‡ä»¤</strong>ã€‚ç„¶åæ·»åŠ ä¸Šäº†ä¸€äº›æ‰€è°“<strong>çº¿æ€§æ ‡è®°</strong>çš„å†…å®¹ã€‚<br>æœ€ç»ˆå¾—åˆ°çš„å°±æ˜¯ç±»ä¼¼ <code>program.i</code> çš„ç»“æœã€‚</p><p>ä»ç»†èŠ‚ä¸Šæ¥è¯´:<br>é¦–å…ˆï¼Œæ‰€æœ‰çš„å®æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ <code>#include</code> (ç”¨äºå¼•å…¥ç”¨æˆ·è‡ªå®šä¹‰åŠç³»ç»Ÿé¢„å®šä¹‰çš„å¤´æ–‡ä»¶)ã€<code>#define</code> (ç”¨äºå°†ä½¿ç”¨åˆ°çš„å®è¿›è¡Œæ›¿æ¢)ã€‚<br>å½“ç„¶ï¼Œåœ¨æ›¿æ¢å®Œæˆåï¼Œè¿™äº›æŒ‡ä»¤æ‰€åœ¨çš„è¡Œå°†è¢«æ›¿æ¢æˆç©ºè¡Œã€‚åŒæ—¶ï¼Œæ‰€æœ‰çš„æ³¨é‡Šè¡Œä¹Ÿå°†è¢«æ›¿æ¢æˆç©ºè¡Œã€‚</p><p>æ­¤å¤–ï¼Œå°†æ·»åŠ ä¸Šæ³¨å…¥ <code>#1 &quot;program.c&quot;</code> çš„<strong>çº¿æ€§æ ‡è®°</strong>ã€‚</p><h3 id="çº¿æ€§æ ‡è®°"><a href="#çº¿æ€§æ ‡è®°" class="headerlink" title="çº¿æ€§æ ‡è®°"></a>çº¿æ€§æ ‡è®°</h3><p>çº¿æ€§æ ‡è®°çš„æ ‡å‡†æ ¼å¼:</p><p><code># linenum filename flags</code></p><p>linenum æ˜¯ä¸ºäº†é…åˆé¢„å®šä¹‰å® <code>__LINE__</code> æ˜¯ä½¿ç”¨çš„ï¼Œç”¨äºå®šä½ç´§éšçš„ä¸‹ä¸€è¡Œå†…å®¹åœ¨åŸæ–‡ä»¶ä¸­æ‰€åœ¨çš„è¡Œã€‚</p><p>filename æŒ‡å‡ºäº†æ¥ä¸‹æ¥çš„å†…å®¹æ¥è‡ªå“ªä¸ªåŸæ–‡ä»¶</p><p>flags æœ‰å¦‚ä¸‹å‡ ä¸ªå–å€¼:</p><ul><li>1 : è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–°çš„æ–‡ä»¶çš„å¼€å§‹</li><li>2 : è¡¨ç¤ºå›åˆ°æ–‡ä»¶ <code>filename</code> çš„å†…å®¹ (ä»å…¶ä»–çš„ <em>include</em> çš„æ–‡ä»¶ä¸­)</li><li>3 : è¡¨ç¤ºæ¥ä¸‹æ¥çš„å†…å®¹æ˜¯ä»ç³»ç»Ÿé¢„å®šä¹‰å¤´æ–‡ä»¶ä¸­æ¥çš„ï¼Œå› æ­¤éœ€è¦æŠ‘åˆ¶æŸäº›è­¦å‘Š</li><li>4 : è¡¨ç¤ºæ¥ä¸‹æ¥çš„å†…å®¹éœ€è¦è¢«è§†ä½œæ˜¯è¢«å°è£…çš„éšå¼ <code>extern &quot;C&quot;</code> å—</li></ul><h3 id="å®ä¾‹è§£è¯»"><a href="#å®ä¾‹è§£è¯»" class="headerlink" title="å®ä¾‹è§£è¯»"></a>å®ä¾‹è§£è¯»</h3><p><small>program.c</small><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"header.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(test());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><small>header.h</small><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥çš„æ¼”ç¤ºéƒ½å°†ä»¥ <strong>program.c</strong> å’Œ <strong>header.h</strong> ä¸¤ä¸ªæ–‡ä»¶ä½œä¸ºæ ‡å‡†ç¤ºä¾‹ã€‚<br>æœŸé—´ï¼Œå°†å¯¹ <strong>program.c</strong> or <strong>header.h</strong> åšä¸åŒç¨‹åº¦çš„ä¿®æ”¹ï¼Œå·²è¾¾åˆ°æ›´å¥½çš„å±•ç¤ºæ•ˆæœã€‚<br><em>æ³¨æ„:</em> é¢å¤–æ·»åŠ çš„æ³¨é‡Šç”± <code>!</code> å¼€å§‹åˆ°è¯¥è¡Œç»“æŸ(å¹¶ä¸ç¬¦åˆ C è¯­è¨€è¯­æ³•)ï¼Œä½†æ˜¯å¸®åŠ©ç†è§£</p><p><strong>Sample 1</strong></p><p>ç›´æ¥åˆ©ç”¨ program.c ä¸ header.h è¿›è¡Œé¢„ç¼–è¯‘ <code>cpp -o program.i program.c</code><br>ç»“æœå¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;built-in&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"/usr/include/stdc-predef.h"</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span> <span class="number">2</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"header.h"</span> <span class="number">1</span>            ! ä¸‹ä¸€è¡Œä»£ç å¯¹åº”çš„æ˜¯ header.h æ–‡ä»¶ç¬¬ä¸€è¡Œ</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"># <span class="number">2</span> <span class="string">"program.c"</span> <span class="number">2</span>           ! flag=<span class="number">2</span> è¡¨ç¤ºä¸‹åˆ—å†…å®¹ç”±å›åˆ°äº† program.c ä¸­ï¼Œä¸‹ä¸€è¡Œå¯¹åº”åŸæ–‡ä»¶ç¬¬äºŒè¡Œ</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(test());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Sample 2</strong></p><p>æ¥ç€ï¼Œç»™ <strong>program.c</strong> åŠ ç‚¹æ³¨é‡Šï¼Œåœ¨åŠ ç‚¹ç©ºè¡Œ</p><p><small>program.c - sub 1<small><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is comment          ! è¿™é‡Œæ·»åŠ äº†ä¸€è¡Œæ³¨é‡Š</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"header.h"</span></span></span><br><span class="line"></span><br><span class="line">                            ! è¿™é‡ŒåŠ äº†ä¸ªç©ºè¡Œ</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(test());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></small></small></p><p>å†çœ‹çœ‹æ•ˆæœ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;built-in&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"/usr/include/stdc-predef.h"</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span> <span class="number">2</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span>             ! ä¸‹ä¸€è¡Œä»£ç å¯¹åº”åŸä»£ç ä¸­ç¬¬ <span class="number">1</span> è¡Œï¼Œæœ¬æ¥æ˜¯æ³¨é‡Šï¼Œä½†ä¼šè¢«é¢„ç¼–è¯‘å™¨å¤„ç†æˆç©ºè¡Œ (å¤šè¡Œå°†é€ä¸€å¤„ç†ï¼Œä½†è¡Œæ•°ä¸ä¼šå˜)</span><br><span class="line"></span><br><span class="line"># <span class="number">1</span> <span class="string">"header.h"</span> <span class="number">1</span>            ! ä¸‹é¢å°†æè¿° header.h çš„ä»£ç </span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"># <span class="number">3</span> <span class="string">"program.c"</span> <span class="number">2</span>           ! ç»§ç»­æè¿° program.c ï¼Œä¸‹ä¸€è¡Œå¯¹åº”åŸä»£ç ç¬¬ <span class="number">3</span> è¡Œã€‚è‡³äºç¬¬ <span class="number">2</span> è¡Œï¼Œå°±æ˜¯ <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"header.h"</span> ï¼Œä¸ä¼šç›´æ¥è¡¨ç°äº†</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(test());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Sample 3</strong></p><p>åœ¨æ”¹å˜ä¸€äº›</p><p><small>program.c - sub 2</small><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is comment</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"header.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEN 10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(test());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>çœ‹çœ‹ç»“æœ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;built-in&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"/usr/include/stdc-predef.h"</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span> <span class="number">2</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"program.c"</span></span><br><span class="line"></span><br><span class="line"># <span class="number">1</span> <span class="string">"header.h"</span> <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"># <span class="number">3</span> <span class="string">"program.c"</span> <span class="number">2</span></span><br><span class="line">                        ! åŸä»£ç ä¸­å¯¹åº”è¡Œæ˜¯å® <span class="meta">#<span class="meta-keyword">define</span> TEN 10 ï¼Œå·²ç»è¢«ç©ºè¡Œæ›¿æ¢æ‰äº†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(test());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘é‡æ–°å¼€å§‹å›é¡¾ C è¯­è¨€ä»¥åŠå…¶ç¼–è¯‘åçš„æ–‡ä»¶æ ¼å¼ ELFã€‚&lt;br&gt;æš‚æ—¶å‘Šåˆ«ä¸€æ­¥åˆ°ä½çš„å‘½ä»¤ &lt;code&gt;gcc main.c&lt;/code&gt;ï¼Œå¦‚æœä» &lt;code&gt;.c&lt;/code&gt; æ–‡ä»¶çš„ç¼–è¯‘æ¥è¯´ï¼Œä¸»è¦åˆ†ä¸ºé¢„ç¼–è¯‘(preprocess)ã€ç¼–è¯‘(Compilation)ã€æ±‡ç¼–(Assembly)ã€é“¾æ¥(Linking) å››ä¸ªæ­¥éª¤ã€‚&lt;br&gt;ä½†æ˜¯ï¼Œä»…ä»…ä»ç¬¬ä¸€ä¸ªæµç¨‹ &lt;strong&gt;é¢„ç¼–è¯‘&lt;/strong&gt; è€Œè¨€ï¼Œå°±å·²ç»é‡åˆ°äº†ä¸€äº›éº»çƒ¦ã€‚&lt;/p&gt;
&lt;p&gt;&lt;small&gt;program.i&lt;/small&gt;&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;program.c&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&amp;lt;built-in&amp;gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&amp;lt;command-line&amp;gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/usr/include/stdc-predef.h&quot;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&amp;lt;command-line&amp;gt;&quot;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;program.c&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;header.h&quot;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;program.c&quot;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;é¢„ç¼–è¯‘åçš„é—®é¢˜å‡ºç°äº†è¯¸å¦‚ &lt;code&gt;# 1 &amp;quot;program.c&amp;quot;&lt;/code&gt; çš„ &lt;em&gt;æ³¨é‡Š?&lt;/em&gt; &lt;/p&gt;
&lt;p&gt;è¿™é‡Œç®€å•è®°å½•é¢„å¤„ç†è¾“å‡ºæ–‡ä»¶çš„åŸºæœ¬æ ¼å¼ï¼Œæ–¹ä¾¿ä»Šåå›é¡¾ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="C" scheme="https://DorMOUSE-None.github.io/tags/C/"/>
    
      <category term="CPP" scheme="https://DorMOUSE-None.github.io/tags/CPP/"/>
    
      <category term="GCC" scheme="https://DorMOUSE-None.github.io/tags/GCC/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (2) - å¤šä»»åŠ¡åˆ‡æ¢</title>
    <link href="https://DorMOUSE-None.github.io/2018-08-26-understand-Kernel-2/"/>
    <id>https://DorMOUSE-None.github.io/2018-08-26-understand-Kernel-2/</id>
    <published>2018-08-25T16:00:00.000Z</published>
    <updated>2018-08-26T05:40:04.404Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ã€Šåªæ˜¯ä¸ºäº†å¥½ç©ã€‹ä¸€ä¹¦ä¸­ï¼Œæ—çº³æ–¯æè¿°è¿‡ä»–æœ€æ—©çš„è¯•éªŒæ€§ç¨‹åºå°±æ˜¯è®© CPU æ‰§è¡Œä¸¤ä¸ªä¸åŒçš„ä»»åŠ¡(ä¸€ä¸ªä¸æ–­è¾“å‡ºAï¼Œå¦ä¸€ä¸ªè¾“å‡ºB)ï¼ŒåŒæ—¶ä¸æ–­åœ°è®© CPU åœ¨ä¸¤ä¸ªä»»åŠ¡é—´çš„åˆ‡æ¢ã€‚</p><p>ç»“åˆã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸€ä¹¦ï¼Œå¾—åˆ°äº†å¤šä»»åŠ¡åˆ‡æ¢çš„ç¤ºä¾‹ç¨‹åºã€‚</p><p>æœ¬èŠ‚æ‰€è¦æè¿°çš„å†…å®¹ï¼Œæ­£æ˜¯ç»“åˆä¸€ä¸ªæ¡†æ¶å¼çš„æ±‡ç¼–ç¨‹åº(å¤šä»»åŠ¡åˆ‡æ¢ç¨‹åº, ä¹¦ä¸­æä¾›çš„å†…å®¹æ¯”è¾ƒè€ï¼Œæ— æ³•é€‚åº”ç›®å‰çš„å„ç§å·¥å…·ã€ç¯å¢ƒ)ï¼Œåœ¨ç°æœ‰ç¯å¢ƒä¸­åŠ ä»¥å¤„ç†å¹¶æˆåŠŸè¿è¡Œã€‚</p><p>å…³äºè¿è¡Œç¯å¢ƒçš„è¯´æ˜ï¼Œæ¬¢è¿å‚è€ƒ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">ç†è§£ Linux Kernel (0)</a></p><a id="more"></a><h2 id="å¼•å¯¼ç¨‹åº"><a href="#å¼•å¯¼ç¨‹åº" class="headerlink" title="å¼•å¯¼ç¨‹åº"></a>å¼•å¯¼ç¨‹åº</h2><p>åœ¨ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-1/">ç†è§£ Linux Kernel (1)</a> å·²ç»æè¿°è¿‡é€šè¿‡ BIOS åŠ è½½å¼•å¯¼ç¨‹åºï¼Œå¹¶æ‰§è¡Œå¼•å¯¼ç¨‹åºçš„å…¨éƒ¨æµç¨‹ã€‚<br>å½“ç„¶ï¼Œä¹Ÿå°±ä»…ä»…åˆ°å¼•å¯¼ç¨‹åºå°±ç»“æŸäº†ã€‚è¯¸å¦‚æ“ä½œç³»ç»Ÿä¹‹ç±»çš„å†…å®¹æ ¹æœ¬å°±æ²¡æœ‰æ¶‰åŠã€‚</p><p>ä¸è¿‡ï¼Œæ— è®ºæ˜¯æ“ä½œç³»ç»Ÿï¼Œè¿˜æ˜¯ç”¨æˆ·ç¨‹åºï¼Œéƒ½æ˜¯åŸºäº CPUã€å†…å­˜ç­‰ç¡¬ä»¶è€Œè¿›ä¸€æ­¥æŠ½è±¡çš„ä¸Šå±‚æ¦‚å¿µã€‚å¦‚æœé—®æ²¡æœ‰æ“ä½œç³»ç»Ÿè€Œç›´æ¥è¿è¡Œç¨‹åºæ˜¯å¦å¯è¡Œï¼Ÿæ¯«æ— ç–‘é—®ï¼Œè¿™ç»å¯¹æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><p>CPU åªæ˜¯å¿ å®åœ°æ‰§è¡Œå¯„å­˜å™¨å®šä½åˆ°çš„æœºå™¨æŒ‡ä»¤ï¼Œå¹¶åŠ ä»¥æ‰§è¡Œã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœåœ¨ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-1/">ç†è§£ Linux Kernel (1)</a> æä¾›çš„è¾“å‡º â€œSystem Loadingâ€¦â€ çš„ç¤ºä¾‹ç¨‹åºä¸Šç»§ç»­åŠ ä»¥æ”¹ç¼–ï¼Œæ— è®ºæ˜¯ç®—æœ¯è¿ç®—ã€æ˜¾ç¤ºæ–‡æœ¬ç­‰ç­‰ç›®çš„éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚<br>å½“ç„¶ï¼Œé™åˆ¶ä¹Ÿè¿˜æ˜¯æœ‰çš„ï¼Œ512B æ˜¯å¼•å¯¼ç¨‹åºçš„ä¸Šé™ã€‚</p><p>åœ¨æœºå™¨ä¸Šç”µå¯åŠ¨ä¹‹åï¼Œå­˜å‚¨åœ¨éæ˜“å¤±æ€§å­˜å‚¨å™¨ / åªè¯»å­˜å‚¨å™¨ä¸Šçš„ BIOS ç¨‹åºå°†è¢«åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶è¿›è¡Œæ‰§è¡Œ(è‡³äºç»†èŠ‚ï¼Œä¸ç”šäº†è§£ï¼Œä¸è¡¨)<br>ä¹‹åï¼ŒBIOS å°†é»˜è®¤åœ°å°†æŒ‡å®šç£ç›˜(è½¯ç›˜ã€ç¡¬ç›˜ç­‰) é¦–ä¸ªæ‰‡åŒº 512 å­—èŠ‚çš„å†…å®¹(ç§°ä¸º boot å¼•å¯¼ç¨‹åº)åŠ è½½åˆ°å†…å­˜åœ°å€ï¼Œå¹¶ JMP åˆ° CS:IP = 0x07c00:0x0000 çš„ä½ç½®ã€‚ä»è€Œè§¦å‘å¼•å¯¼ç¨‹åºã€‚</p><p>ç»§è€Œï¼Œå¦‚æœåœ¨ç¼–å†™ boot å¼•å¯¼ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿å…¶èƒ½å¤Ÿä»å¤–å­˜åŠ è½½é¢å¤–çš„ä»£ç ï¼Œå¹¶åœ¨å¼•å¯¼ç¨‹åºç»“æŸä½ç½®å°† CPU çš„æ§åˆ¶æƒäº¤ç»™è¿™æ®µé¢å¤–åŠ è½½çš„ä»£ç ã€‚æ˜¾ç„¶ï¼Œæ“ä½œç³»ç»Ÿå°±æ˜¯è¿™æ ·å­è¢«åŠ è½½çš„ã€‚</p><p><code>BIOS -&gt; boot å¼•å¯¼ç¨‹åº -&gt; æ“ä½œç³»ç»Ÿå¼•å¯¼ç¨‹åº -&gt; æ“ä½œç³»ç»Ÿ</code><br>è¿™å°±æ„æˆäº†ä¸€ä¸ªå®è§‚çš„æ“ä½œç³»ç»Ÿå¯åŠ¨çš„ä¸€ä¸ªæµç¨‹ã€‚</p><p>boot.s å¼•å¯¼ç¨‹åº <small>ä¸»ä½“ä»£ç æ¥è‡ªã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ï¼Œè¿›è¡Œäº†ä¸€å®šé‡çš„æ”¹å†™</small></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">BOOTSEG = 0x07c0</span><br><span class="line">SYSSEG = 0x0100</span><br><span class="line">SYSLEN = 17</span><br><span class="line"></span><br><span class="line">entry start</span><br><span class="line">start:</span><br><span class="line">    jmpi    go,#BOOTSEG</span><br><span class="line">go:</span><br><span class="line">    mov ax,cs</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov ss,ax</span><br><span class="line">    mov sp,#0x0400</span><br><span class="line"></span><br><span class="line">load_system:</span><br><span class="line">    xor dx,dx       ! å¼€å§‹ä½ç½®, ç£å¤´:ç¡¬ç›˜å·</span><br><span class="line">    mov cx,#0x0002  ! å¼€å§‹ä½ç½®, ç£é“:æ‰‡åŒº</span><br><span class="line">    mov ax,#0x0100</span><br><span class="line">    mov es,ax       ! è½½å…¥åˆ°, ES æ®µ</span><br><span class="line">    xor bx,bx       ! è½½å…¥åˆ°, åç§»é‡ </span><br><span class="line">    mov ax,#0x0211  ! AH: è¯»å–æ‰‡åŒºå­åŠŸèƒ½, AL: è¯»å–å¤šå°‘ä¸ªæ‰‡åŒº</span><br><span class="line">    int 0x13        ! BIOS 13 å·ä¸­æ–­</span><br><span class="line">    jnc continue_load   ! JUMP if CF = 0</span><br><span class="line">die:</span><br><span class="line">    jmp die</span><br><span class="line"></span><br><span class="line">continue_load:</span><br><span class="line">    cli             ! æ¸…é™¤ä¸­æ–­å…è®¸ä½æ ‡å¿—</span><br><span class="line">    mov ax,#SYSSEG </span><br><span class="line">    mov ds,ax       ! è®¾ç½®æ•°æ®æ®µå¯„å­˜å™¨ä½ç½® 0x1000</span><br><span class="line">    xor ax,ax</span><br><span class="line">    mov es,ax       ! è®¾ç½®æ‰©å±•æ®µå¯„å­˜å™¨ 0x0000</span><br><span class="line">    mov cx,#0x1000  ! è®¡æ•°å™¨</span><br><span class="line">    sub si,si</span><br><span class="line">    sub di,di</span><br><span class="line">    rep </span><br><span class="line">    movsw</span><br><span class="line"></span><br><span class="line">    mov ax,#BOOTSEG</span><br><span class="line">    mov ds,ax       ! é‡æ–°è®¾ç½®æ•°æ®æ®µå¯„å­˜å™¨åˆ°å½“å‰æ•°æ®æ®µåŸºåœ°å€</span><br><span class="line">    lidt idt_48     ! è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨</span><br><span class="line">    lgdt gdt_48     ! è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨</span><br><span class="line"></span><br><span class="line">    mov ax,#0x0001</span><br><span class="line">    lmsw ax         ! è®¾ç½® CR0, è¿›å…¥ä¿æŠ¤æ¨¡å¼</span><br><span class="line">    jmpi 0,8</span><br><span class="line"></span><br><span class="line">gdt:</span><br><span class="line">    .word   0,0,0,0</span><br><span class="line">    .word   0x07FF,0x0000,0x9A00,0x00C0</span><br><span class="line">    .word   0x07FF,0x0000,0x9200,0x00C0</span><br><span class="line"></span><br><span class="line">idt_48:</span><br><span class="line">    .word   0,0,0</span><br><span class="line">gdt_48:</span><br><span class="line">    .word   0x07FF,0x7C00+gdt,0</span><br><span class="line"></span><br><span class="line">.org 510</span><br><span class="line">    .word   0xAA55</span><br></pre></td></tr></table></figure><p>è¿™æ®µæ±‡ç¼–ç¨‹åºï¼Œé€šè¿‡ <code>load_system</code> æ ‡è¯†ç¬¦æ ‡è¯†çš„è¿™æ®µç¨‹åºè¡¨æ˜éœ€è¦åŠ è½½0å·ç£ç›˜,0å·ç£å¤´,0å·ç£é“,ä»ç¬¬2æ‰‡åŒºå¼€å§‹,è¿ç»­17ä¸ªæ‰‡åŒºçš„å†…å®¹(è¿™é‡Œå°†å­˜å‚¨æ”¯æŒä»»åŠ¡åˆ‡æ¢çš„ç¨‹åº)ï¼ŒåŠ è½½åˆ°å†…å­˜ä»¥ 0x1000 å¼€å§‹çš„ç‰©ç†åœ°å€å¤„ã€‚</p><p><code>continue_load</code> æ ‡è¯†å°† 0x1000 ç‰©ç†åœ°å€å¼€å§‹çš„ 4096 å­— (å³ 8192 å­—èŠ‚) çš„å†…å®¹ä¾æ¬¡å¤åˆ¶åˆ°ä»¥ 0x0000 å¼€å§‹çš„ç‰©ç†åœ°å€å¤„ã€‚</p><p>å…¶åï¼Œè®¾ç½® IDT (ä¸­æ–­æè¿°ç¬¦è¡¨)ã€IDTR(ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨) åŠ GDT(å…¨å±€æè¿°ç¬¦è¡¨)ã€GDTR(å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨)ï¼Œå°† CPU è¿è¡Œæ¨¡å¼æ”¹æˆ <code>ä¿æŠ¤æ¨¡å¼</code> ï¼Œç»§è€Œå°†æ§åˆ¶æƒè½¬äº¤ç»™è¿™ä¸ªè¢«åŠ è½½è¿›æ¥çš„ç¨‹åºã€‚</p><h2 id="å¤šä»»åŠ¡ç¨‹åº"><a href="#å¤šä»»åŠ¡ç¨‹åº" class="headerlink" title="å¤šä»»åŠ¡ç¨‹åº"></a>å¤šä»»åŠ¡ç¨‹åº</h2><p><small>ä¸»ä½“å†…å®¹æ¥è‡ªã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ï¼Œç»è¿‡ä¸€å®šé‡æ”¹å˜ä»¥é€‚åº”å½“å‰è¿è¡Œç¯å¢ƒ</small><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"># head.s</span><br><span class="line">.code32</span><br><span class="line">LATCH = 11930</span><br><span class="line">SCRN_SEL = 0x18</span><br><span class="line">TSS0_SEL = 0x20</span><br><span class="line">LDT0_SEL = 0x28</span><br><span class="line">TSS1_SEL = 0x30</span><br><span class="line">LDT1_SEL = 0x38</span><br><span class="line"></span><br><span class="line">.text</span><br><span class="line">.globl startup_32</span><br><span class="line">startup_32:</span><br><span class="line"></span><br><span class="line">    movl $0x00000010,%eax       # æ®µé€‰æ‹©ç¬¦ 2</span><br><span class="line">    mov %ax,%ds                </span><br><span class="line">    lss init_stack,%esp         # Load Far Pointer åŠ è½½åˆ° SS:ESP </span><br><span class="line"></span><br><span class="line">    call setup_idt              # è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨</span><br><span class="line">    call setup_gdt              # è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨</span><br><span class="line">    movl $0x00000010,%eax</span><br><span class="line">    mov %ax,%ds</span><br><span class="line">    mov %ax,%es</span><br><span class="line">    mov %ax,%fs</span><br><span class="line">    mov %ax,%gs</span><br><span class="line">    lss init_stack,%esp         # Load Far Pointer åŠ è½½åˆ° SS:ESP</span><br><span class="line"></span><br><span class="line"># è®¾ç½® 8253 å®šæ—¶èŠ¯ç‰‡ 10s ä¸€ä¸ªä¸­æ–­</span><br><span class="line">    movb $0x36,%al  </span><br><span class="line">    movl $0x00000043,%edx</span><br><span class="line">    outb %al,%dx</span><br><span class="line">    movl $LATCH,%eax</span><br><span class="line">    movl $0x40,%edx</span><br><span class="line">    outb %al,%dx</span><br><span class="line">    movb %ah,%al</span><br><span class="line">    outb %al,%dx</span><br><span class="line"></span><br><span class="line">    movl $0x00080000,%eax       # é‡æ–°è®¾ç½® int 0x08 æ—¶é’Ÿä¸­æ–­</span><br><span class="line">    movw $timer_interrupt,%ax</span><br><span class="line">    movw $0x8E00,%dx</span><br><span class="line">    movl $0x08,%ecx</span><br><span class="line">    lea idt(,%ecx,8),%esi</span><br><span class="line">    movl %eax,(%esi)</span><br><span class="line">    movl %edx,4(%esi)</span><br><span class="line">    movw $system_interrupt,%ax  # é‡æ–°è®¾ç½® int 0x80 ç³»ç»Ÿä¸­æ–­</span><br><span class="line">    movw $0xef00,%dx</span><br><span class="line">    movl $0x80,%ecx</span><br><span class="line">    lea idt(,%ecx,8),%esi</span><br><span class="line">    movl %eax,(%esi)</span><br><span class="line">    movl %edx,4(%esi)</span><br><span class="line"></span><br><span class="line">    pushfl                      # é‡ç½® EFLAGS åµŒå¥—ä»»åŠ¡æ ‡å¿—ä½</span><br><span class="line">    andl $0xffffbfff,(%esp)</span><br><span class="line">    popfl</span><br><span class="line">    movl $TSS0_SEL,%eax</span><br><span class="line">    ltr %ax                     # Load Task Register</span><br><span class="line">    movl $LDT0_SEL,%eax</span><br><span class="line">    lldt %ax                    # Load Local Descriptor Register</span><br><span class="line">    movl $0,current</span><br><span class="line">    sti                         # set interrupt flag</span><br><span class="line">    pushl $0x17</span><br><span class="line">    pushl $init_stack</span><br><span class="line">    pushfl</span><br><span class="line">    pushl $0x0f</span><br><span class="line">    pushl $task0</span><br><span class="line">    iret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setup_gdt:</span><br><span class="line">    lgdt lgdt_opcode</span><br><span class="line">    ret</span><br><span class="line">setup_idt:</span><br><span class="line">    lea ignore_int,%edx         # é¢„å…ˆæŠŠä¸­æ–­å¤„ç†ç¨‹åºçš„åç§»åœ°å€ ignore_int å­˜åˆ° EDX</span><br><span class="line">    movl $0x00080000,%eax       # é¢„å­˜ 0x0008 - æ®µé€‰æ‹©ç¬¦</span><br><span class="line">    movw %dx,%ax                # è¡¥ä¸Š 0-15 ä½åç§»åœ°å€</span><br><span class="line">    movw $0x8E00,%dx            # DX è¡¥ä¸Šæ ‡å¿—ä½</span><br><span class="line">    lea idt,%edi</span><br><span class="line">    mov $256,%ecx</span><br><span class="line">rp_idt: movl %eax,(%edi)        # å¾ªç¯ 256 éå¤„ç† IDT</span><br><span class="line">    movl %edx,4(%edi)</span><br><span class="line">    addl $8,%edi</span><br><span class="line">    dec %ecx</span><br><span class="line">    jne rp_idt</span><br><span class="line">    lidt lidt_opcode</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write_char:</span><br><span class="line">    push %gs</span><br><span class="line">    pushl %ebx</span><br><span class="line">    mov $SCRN_SEL,%ebx</span><br><span class="line">    mov %bx,%gs</span><br><span class="line">    movl scr_loc,%ebx</span><br><span class="line">    shl $1,%ebx</span><br><span class="line">    movb %al,%gs:(%ebx)</span><br><span class="line">    shr $1,%ebx</span><br><span class="line">    incl %ebx</span><br><span class="line">    cmpl $2000,%ebx</span><br><span class="line">    jb 1f</span><br><span class="line">    movl $0,%ebx</span><br><span class="line">1:  movl %ebx,scr_loc</span><br><span class="line">    popl %ebx</span><br><span class="line">    pop %gs</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">ignore_int:                 # é»˜è®¤çš„ä¸­æ–­å¤„ç†ç¨‹åº</span><br><span class="line">    push %ds</span><br><span class="line">    pushl %eax</span><br><span class="line">    movl $0x10,%eax</span><br><span class="line">    mov %ax,%ds</span><br><span class="line">    movl $67,%eax</span><br><span class="line">    call write_char</span><br><span class="line">    popl %eax</span><br><span class="line">    pop %ds</span><br><span class="line">    iret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">timer_interrupt:            # å®šæ—¶ä¸­æ–­å¤„ç†ç¨‹åº</span><br><span class="line">    push %ds</span><br><span class="line">    pushl %eax</span><br><span class="line">    movl $0x10,%eax</span><br><span class="line">    mov %ax,%ds</span><br><span class="line">    movb $0x20,%al</span><br><span class="line">    outb %al,$0x20</span><br><span class="line">    movl $1,%eax</span><br><span class="line">    cmpl %eax,current</span><br><span class="line">    je 1f</span><br><span class="line">    movl %eax,current</span><br><span class="line">    jmp $TSS1_SEL, $0</span><br><span class="line">    jmp 2f</span><br><span class="line">1:  movl $0,current</span><br><span class="line">    jmp $TSS0_SEL, $0</span><br><span class="line">2:  popl %eax</span><br><span class="line">    pop %ds</span><br><span class="line">    iret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">system_interrupt:           # ç³»ç»Ÿè°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åº</span><br><span class="line">    push %ds</span><br><span class="line">    pushl %edx</span><br><span class="line">    pushl %ecx</span><br><span class="line">    pushl %ebx</span><br><span class="line">    pushl %eax</span><br><span class="line">    movl $0x10,%edx</span><br><span class="line">    mov %dx,%ds</span><br><span class="line">    call write_char</span><br><span class="line">    popl %eax</span><br><span class="line">    popl %ebx</span><br><span class="line">    popl %ecx</span><br><span class="line">    popl %edx</span><br><span class="line">    pop %ds</span><br><span class="line">    iret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">current:.long 0</span><br><span class="line">scr_loc:.long 0</span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">lidt_opcode:</span><br><span class="line">    .word 256*8-1</span><br><span class="line">    .long idt</span><br><span class="line">lgdt_opcode:</span><br><span class="line">    .word (end_gdt-gdt)-1</span><br><span class="line">    .long gdt</span><br><span class="line"></span><br><span class="line">.align 8</span><br><span class="line">idt:    .fill 256,8,0</span><br><span class="line"></span><br><span class="line">gdt:    .quad 0x0000000000000000</span><br><span class="line">        .quad 0x00c09a00000007ff</span><br><span class="line">        .quad 0x00c09200000007ff</span><br><span class="line">        .quad 0x00c0920b80000002</span><br><span class="line">        .word 0x68,tss0,0xe900,0x0</span><br><span class="line">        .word 0x40,ldt0,0xe200,0x0</span><br><span class="line">        .word 0x68,tss1,0xe900,0x0</span><br><span class="line">        .word 0x40,ldt1,0xe200,0x0</span><br><span class="line">end_gdt:</span><br><span class="line">        .fill 128,4,0</span><br><span class="line">init_stack:</span><br><span class="line">    .long init_stack</span><br><span class="line">    .word 0x0010</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.align 8</span><br><span class="line">ldt0:   .quad 0x0000000000000000</span><br><span class="line">        .quad 0x00c0fa00000003ff</span><br><span class="line">        .quad 0x00c0f200000003ff</span><br><span class="line"></span><br><span class="line">tss0:   .long 0</span><br><span class="line">        .long krn_stk0, 0x10</span><br><span class="line">        .long 0,0,0,0,0</span><br><span class="line">        .long 0,0,0,0,0</span><br><span class="line">        .long 0,0,0,0,0</span><br><span class="line">        .long 0,0,0,0,0,0</span><br><span class="line">        .long LDT0_SEL,0x8000000</span><br><span class="line"></span><br><span class="line">        .fill 128,4,0</span><br><span class="line">krn_stk0:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.align 8</span><br><span class="line">ldt1:   .quad 0x0000000000000000</span><br><span class="line">        .quad 0x00c0fa00000003ff</span><br><span class="line">        .quad 0x00c0f200000003ff</span><br><span class="line"></span><br><span class="line">tss1:   .long 0</span><br><span class="line">        .long krn_stk1,0x10</span><br><span class="line">        .long 0,0,0,0,0</span><br><span class="line">        .long task1,0x200</span><br><span class="line">        .long 0,0,0,0</span><br><span class="line">        .long usr_stk1,0,0,0</span><br><span class="line">        .long 0x17,0x0f,0x17,0x17,0x17,0x17</span><br><span class="line">        .long LDT1_SEL,0x8000000</span><br><span class="line"></span><br><span class="line">        .fill 128,4,0</span><br><span class="line">krn_stk1:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">task0:</span><br><span class="line">    movl $0x17,%eax</span><br><span class="line">    movw %ax,%ds</span><br><span class="line">    mov $65,%al</span><br><span class="line">    int $0x80</span><br><span class="line">    movl $0xfff,%ecx</span><br><span class="line">1:  loop 1b</span><br><span class="line">    jmp task0</span><br><span class="line">task1:</span><br><span class="line">    mov $66,%al</span><br><span class="line">    int $0x80</span><br><span class="line">    movl $0xfff,%ecx</span><br><span class="line">1:  loop 1b</span><br><span class="line">    jmp task1</span><br><span class="line"></span><br><span class="line">    .fill 128,4,0</span><br><span class="line">usr_stk1:</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„è¿™ä¸ªç¨‹åºå†…å®¹ä¸å†è¯¦è¿°ï¼Œæƒ³äº†è§£ç»†èŠ‚è¯·å‚è€ƒ ã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹</p><p>ä¸‹é¢æä¾›ç¼–è¯‘ <code>boot.s</code> ä»¥åŠ <code>head.s</code> çš„å¯ç”¨ Makefile</p><p>é¦–å…ˆæè¿°ä¸€ä¸‹é¢å¤–çš„å·¥å…·ç‰ˆæœ¬</p><ul><li>GNU as : GNU assembler version 2.26.1 </li><li>GNU ld : GNU ld 2.26.1<br>å…¶å®ƒå†…å®¹è¯¦è§ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">ç†è§£ Linux Kernel (0)</a></li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile for the simple example kernel.</span></span><br><span class="line">AS86=as86 -0 -a</span><br><span class="line">LD86=ld86 -0</span><br><span class="line">AS=as</span><br><span class="line">ASFLAGS =-32</span><br><span class="line">LD=ld</span><br><span class="line">LDFLAGS=-s -x -M -m elf_i386 -e startup_32 -Ttext 0x0</span><br><span class="line"></span><br><span class="line"><span class="section">all:Image</span></span><br><span class="line"></span><br><span class="line"><span class="section">Image: boot system</span></span><br><span class="line">dd bs=32 if=boot of=Image skip=1</span><br><span class="line">dd bs=512 if=system of=Image skip=8 seek=1</span><br><span class="line">sync</span><br><span class="line"></span><br><span class="line"><span class="section">disk: Image</span></span><br><span class="line">dd bs=8192 if=Image of=/dev/fd0</span><br><span class="line">sync;sync;sync</span><br><span class="line"></span><br><span class="line"><span class="section">head.o: </span></span><br><span class="line"><span class="variable">$(AS)</span> <span class="variable">$(ASFLAGS)</span> -o head.o head.s</span><br><span class="line"></span><br><span class="line"><span class="section">system:head.o </span></span><br><span class="line"><span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> head.o  -o system &gt; System.map</span><br><span class="line"></span><br><span class="line"><span class="section">boot:boot.s</span></span><br><span class="line"><span class="variable">$(AS86)</span> -o boot.o boot.s</span><br><span class="line"><span class="variable">$(LD86)</span> -s -o boot boot.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f Image System.map core boot *.o system</span><br></pre></td></tr></table></figure><h2 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h2><p>æƒ³äº†è§£æ›´å¤šç»†èŠ‚çš„è¯·è‡ªè¡Œå®æ“æŸ¥çœ‹å§!</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fun1fvafhwg30k40d4x6p.gif" alt=""></p><h2 id="é™„ä»¶"><a href="#é™„ä»¶" class="headerlink" title="é™„ä»¶"></a>é™„ä»¶</h2><p><a href="https://raw.githubusercontent.com/DorMOUSE-None/Repo/master/understand-kernel-2.zip" target="_blank" rel="noopener">ç¨‹åºæºç </a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h2&gt;&lt;p&gt;ã€Šåªæ˜¯ä¸ºäº†å¥½ç©ã€‹ä¸€ä¹¦ä¸­ï¼Œæ—çº³æ–¯æè¿°è¿‡ä»–æœ€æ—©çš„è¯•éªŒæ€§ç¨‹åºå°±æ˜¯è®© CPU æ‰§è¡Œä¸¤ä¸ªä¸åŒçš„ä»»åŠ¡(ä¸€ä¸ªä¸æ–­è¾“å‡ºAï¼Œå¦ä¸€ä¸ªè¾“å‡ºB)ï¼ŒåŒæ—¶ä¸æ–­åœ°è®© CPU åœ¨ä¸¤ä¸ªä»»åŠ¡é—´çš„åˆ‡æ¢ã€‚&lt;/p&gt;
&lt;p&gt;ç»“åˆã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸€ä¹¦ï¼Œå¾—åˆ°äº†å¤šä»»åŠ¡åˆ‡æ¢çš„ç¤ºä¾‹ç¨‹åºã€‚&lt;/p&gt;
&lt;p&gt;æœ¬èŠ‚æ‰€è¦æè¿°çš„å†…å®¹ï¼Œæ­£æ˜¯ç»“åˆä¸€ä¸ªæ¡†æ¶å¼çš„æ±‡ç¼–ç¨‹åº(å¤šä»»åŠ¡åˆ‡æ¢ç¨‹åº, ä¹¦ä¸­æä¾›çš„å†…å®¹æ¯”è¾ƒè€ï¼Œæ— æ³•é€‚åº”ç›®å‰çš„å„ç§å·¥å…·ã€ç¯å¢ƒ)ï¼Œåœ¨ç°æœ‰ç¯å¢ƒä¸­åŠ ä»¥å¤„ç†å¹¶æˆåŠŸè¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;å…³äºè¿è¡Œç¯å¢ƒçš„è¯´æ˜ï¼Œæ¬¢è¿å‚è€ƒ &lt;a href=&quot;https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/&quot;&gt;ç†è§£ Linux Kernel (0)&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="Multi-Task" scheme="https://DorMOUSE-None.github.io/tags/Multi-Task/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (0) - æ¦‚è¿°</title>
    <link href="https://DorMOUSE-None.github.io/2018-08-19-understand-Kernel-0/"/>
    <id>https://DorMOUSE-None.github.io/2018-08-19-understand-Kernel-0/</id>
    <published>2018-08-18T16:00:00.000Z</published>
    <updated>2018-08-19T04:46:27.020Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ä¹‹æ‰€ä»¥æƒ³è¦äº†è§£ Linux Kernelï¼Œä¸å‰ä¸€ä¸ªæœˆçš„ JVM ClassFile çš„å­¦ä¹ æœ‰è¿™å¾ˆå¤§çš„å…³è”ã€‚</p><p>è¯´å®è¯ï¼Œåˆ¨é™¤ JVM çš„å…·ä½“å®ç°ï¼ŒSun (æˆ–è€…ç°åœ¨è¯¥è¯´æ˜¯ Oracle) ç¡®å®å°† Java çš„åº•å±‚é€»è¾‘è®¾è®¡å¾—ç›¸å½“ç®€å•ã€‚</p><ol><li>æœ‰é™è€Œç»Ÿä¸€çš„æŒ‡ä»¤é›†(ä¸è¶…è¿‡ 256 ä¸ªï¼Œå¯ä»¥ç”¨ 1 å­—èŠ‚è¡¨ç¤º)</li><li>æ“ä½œæ•°æ ˆ+å±€éƒ¨å˜é‡è¡¨å…±åŒå®ç°çš„æŒ‡ä»¤è¿ç®—</li><li>é«˜åº¦å°è£…çš„æˆå‘˜å˜é‡/æ–¹æ³•çš„å¯»å€æ–¹å¼</li><li>â€¦ (è§è¯†çŸ­æµ…ï¼Œæƒ³ä¸åˆ°äº†â€¦ä»¥åå†è¡¥å……å§)</li></ol><p>ä½†æ˜¯ï¼Œä¸ JVM æ¨¡æ‹Ÿçš„è™šæ‹Ÿæœºä¸åŒï¼Œå®ä½“æœºå™¨æœ‰ç€æ›´ä¸ºå¤æ‚çš„ç»“æ„ã€‚<br>æœ€æ ¹æœ¬çš„ï¼Œä¸åŒå‚å•†çš„æœºå™¨å°±å¸¦æ¥äº†ä¸åŒçš„ CPU æŒ‡ä»¤é›†ï¼Œè¿™å°±å·²ç»è®©äººéš¾ä»¥æ¥å—äº†ã€‚</p><p>å…¶å®æœ€åˆï¼Œæ˜¯æƒ³è¦ç»§ç»­å»çœ‹çœ‹ Hotspot è™šæ‹Ÿæœºçš„ã€‚ä½†æ˜¯ï¼Œæ··æ‚çš„ä»£ç (C++, Java, å¹³å°ç›¸å…³å„ç§å®ç°) å¸¦æ¥äº†å¾ˆå¤§çš„é˜…è¯»éšœç¢ã€‚<br>æœ€æ ¹æœ¬çš„ï¼Œæˆ‘ç”šè‡³æ‰¾ä¸åˆ°ä¸€ä¸ªå­¦ä¹ çš„åŸºæœ¬ç«‹è¶³ç‚¹ï¼Œå‡ºå‘ç‚¹(å½“ç„¶ï¼Œä¹Ÿå¯èƒ½æˆ‘æ ¹æœ¬å°±æ²¡ä»”ç»†å»çœ‹ï¼Œå“ˆå“ˆ)ã€‚</p><p>å€Ÿç€ä¸€æ¬¡æœºä¼šï¼Œæˆ‘å¼€å§‹çœ‹ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹ä¸€ä¹¦ã€‚ç¡®å®æ— è®ºæ˜¯ ELF æ ¼å¼ï¼Œé™æ€é“¾æ¥ä¸åŠ¨æ€é“¾æ¥ç”šè‡³ Linux çš„å†…å»ºå‡½æ•°<br>éƒ½ç»™äº†æˆ‘æ¯”è¾ƒæ·±åˆ»çš„å°è±¡ï¼Œå‘æˆ‘å±•ç¤ºäº† C æ›´æ·±å…¥çš„ä¸€é¢ã€‚ä½†æ˜¯ï¼ŒmacOS ç»™æˆ‘å¸¦æ¥äº†æ¯”è¾ƒå¤§çš„å®¢è§‚é˜»ç¢(å³ä½¿ç”¨ Docker å®¹å™¨å¾—åˆ°äº†ä¸€ä¸ªå¯ç”¨çš„ Linux ç¯å¢ƒï¼Œä½†æ˜¯å¦ä¸ç›´æ¥å»ºç«‹åœ¨æœºå™¨ä¸Šçš„ç³»ç»Ÿæœ‰æ‰€åŒºåˆ«ï¼Œæ­¤å¤„è¿˜å¾—æ‰“ä¸ªé—®å·)ã€‚<br>åŒæ—¶ï¼Œä¹¦ä¸­çš„éƒ¨åˆ†å†…å®¹ä¸Šä¸‹ä¸ç»Ÿä¸€ï¼Œç¼ºå°‘å‰åæ–‡ä¹Ÿæ˜¯ä¸€ä¸ªé‡å¤§çš„é—®é¢˜ã€‚æ€»ä¹‹ï¼Œè¿™å¹¶ä¸å®Œå…¨é€‚åˆæˆ‘è¿™ç§åˆå­¦è€…é€ä¸€è¿›è¡Œä¹¦ä¸­æ‰€æè¿°çš„å…¨éƒ¨å®éªŒã€‚</p><p>æœ€åï¼Œæˆ‘å†³å®šå±•å¼€å¯¹ Linux Kernel çš„å­¦ä¹ ï¼Œè¯•å›¾é€šè¿‡å¯¹ç›´æ¥æ„æ¶åœ¨ç¡¬ä»¶ä¸Šçš„æ“ä½œç³»ç»Ÿè¿›è¡Œä¸€ç•ªæ¯”è¾ƒæ·±å…¥çš„å­¦ä¹ ã€‚</p><p>æœŸé—´ï¼Œæ‰¾è¿‡ä¸€äº›èµ„æ–™ï¼Œä¹Ÿäº†è§£åˆ° Linus Torvals ç›´æ¥é¢†å¯¼ç€çš„ <a href="https://www.kernel.org/" target="_blank" rel="noopener">Kernel é¡¹ç›®çš„å®˜ç½‘</a>ï¼›ç”šè‡³ï¼Œæ‰¾åˆ°äº†å„ä¸ªç‰ˆæœ¬çš„ kernel æºç (è™½ç„¶ç¡®å®åœ°ä¸¢å¤±äº†æœ€æ—©æœŸ 0.XX çš„è‹¥å¹²ç‰ˆæœ¬)ã€‚<br>ä¸å¾—ä¸è¯´ï¼Œå°±ç›®å‰æ¥è®²ï¼Œæˆ‘è§‰å¾—ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹æ˜¯æœ€é€‚åˆ(<em>æ‰“ä¸ªé—®å·ï¼Œè‡³å°‘æš‚æ—¶æ˜¯çš„</em>)æˆ‘å­¦ä¹ çš„ä¸€ä¹¦ã€‚</p><p>ä¹‹åçš„è‹¥å¹²åšæ–‡ï¼Œå°†éƒ½ä»¥ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸­çš„å†…å®¹ä¸ºåŸºç¡€ï¼Œç»“åˆç›®å‰çš„å®é™…éœ€è¦ï¼Œä»è€Œè¿›è¡Œå®æ“æ€§çš„è®¤çŸ¥ä¸å­¦ä¹ ã€‚</p><a id="more"></a><h2 id="è½¯ç¡¬ä»¶æè¿°"><a href="#è½¯ç¡¬ä»¶æè¿°" class="headerlink" title="è½¯ç¡¬ä»¶æè¿°"></a>è½¯ç¡¬ä»¶æè¿°</h2><p>è¿›è¡Œè¿™æ–¹é¢çš„æè¿°ï¼Œæ˜¯å› ä¸º Linux Kernel å°†ç›´æ¥ä¸åº•å±‚ç¡¬ä»¶æ‰“äº¤é“(å½“ç„¶ï¼Œè¿™æ–¹é¢ä½¿ç”¨çš„ Bochs ä»¿çœŸå™¨)ã€‚<br>ä½†æ˜¯ï¼Œå‡†å¤‡è¯¸å¦‚ .img (ç£ç›˜æ˜ åƒæ–‡ä»¶), æœºå™¨æŒ‡ä»¤æ–‡ä»¶ç­‰éƒ½ä¸å¾—ä¸å€ŸåŠ©äºç°æœ‰çš„å¹³å°ã€‚</p><ul><li>æ“ä½œç³»ç»Ÿ: macOS 10.13.6 , Ubuntu 16.04 (Docker è™šæ‹Ÿæœºå®¹å™¨)</li><li>ä»¿çœŸå™¨  : Bochs 2.6.9_2 (macOS ä¸ Ubuntu ä¸Šç›¸åŒ)</li><li>æ›´å¤š    : å°†ç›´æ¥åœ¨æ­£æ–‡é¦–æ¬¡ä½¿ç”¨åˆ°æ—¶è¿›è¡Œè¯´æ˜</li></ul><h2 id="Bochs"><a href="#Bochs" class="headerlink" title="Bochs"></a>Bochs</h2><p><a href="http://bochs.sourceforge.net/" target="_blank" rel="noopener">Bochs å®˜ç½‘</a></p><p><a href="https://sourceforge.net/projects/bochs/files/" target="_blank" rel="noopener">Bochs ä¸‹è½½é“¾</a></p><p>è¯´å®è¯è¿™ä¸€å‘¨éƒ½å·®ä¸å¤šè¦è¢« Bochs æŠ˜è…¾æ­»ï¼Œç”¨æºç è¿›è¡Œç¼–è¯‘å‡ºç°å„ç§å„æ ·çš„é—®é¢˜ã€‚(æˆ‘çŒœæ–°ç‰ˆæœ¬æ ¹æœ¬å°±æ²¡è€ƒè™‘å¯¹ macOS åšå…¼å®¹)</p><p>æœ€åï¼Œä¸å¾—ä¸ä½¿ç”¨ç»ç¼–è¯‘åçš„äºŒè¿›åˆ¶åˆ†å‘ç‰ˆã€‚ <code>brew install bochs</code> å½“ç„¶äº†ï¼Œåæ­£ä¹Ÿèƒ½ç”¨ï¼Œå°±ä¸çº ç»“éå¾—è‡ªå·±ç¼–è¯‘äº†ã€‚(å¦‚æœå“ªä½èƒ½æˆåŠŸç¼–è¯‘ä¸ª macOS å¯ç”¨çš„åº”ç”¨ï¼Œå¸Œæœ›èƒ½æŠŠè¸©å¾—å‘æ•´ç†æ•´ç†ï¼Œä¾›åæ¥è€…å‚è€ƒ)</p><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ CHANGES</span><br><span class="line">â”œâ”€â”€ COPYING</span><br><span class="line">â”œâ”€â”€ INSTALL_RECEIPT.json</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ README</span><br><span class="line">â”œâ”€â”€ TODO</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ bochs                           // bochs å¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">â”‚Â Â  â””â”€â”€ bximage                         // åˆ¶ä½œç£ç›˜æ˜ åƒæ–‡ä»¶çš„å·¥å…·</span><br><span class="line">â”œâ”€â”€ lib                                 // åŠ¨æ€åº“ç›®å½•</span><br><span class="line">â”‚Â Â  â””â”€â”€ bochs</span><br><span class="line">â”‚Â Â      â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ libbx_acpi.0.0.0.so</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ ... ç•¥</span><br><span class="line">â”‚Â Â          â””â”€â”€ libbx_vga.so -&gt; libbx_vga.0.0.0.so</span><br><span class="line">â””â”€â”€ share                               // ä¸ä½“ç³»ç»“æ„æ— å…³çš„æ–‡ä»¶æ”¾åœ¨æ­¤ç›®å½•ä¸‹</span><br><span class="line">    â”œâ”€â”€ bochs</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ BIOS-bochs-latest</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ BIOS-bochs-legacy</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ SeaBIOS-README</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ VGABIOS-elpin-2.40</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ VGABIOS-elpin-LICENSE</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-README</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest-cirrus</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest-cirrus-debug</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest-debug</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ bios.bin-1.7.5</span><br><span class="line">    â”‚Â Â  â””â”€â”€ keymaps</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ sdl-pc-us.map</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ ... ç•¥</span><br><span class="line">    â”‚Â Â      â””â”€â”€ x11-pc-us.map</span><br><span class="line">    â”œâ”€â”€ doc</span><br><span class="line">    â”‚Â Â  â””â”€â”€ bochs</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ CHANGES</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ COPYING</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ LICENSE</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ README</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ TODO</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ bochsrc-sample.txt      // bochsrc é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹æ ·æ¿</span><br><span class="line">    â”‚Â Â      â””â”€â”€ slirp.conf</span><br><span class="line">    â””â”€â”€ man</span><br><span class="line">        â”œâ”€â”€ man1</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ bochs-dlx.1.gz</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ bochs.1.gz</span><br><span class="line">        â”‚Â Â  â””â”€â”€ bximage.1.gz</span><br><span class="line">        â””â”€â”€ man5</span><br><span class="line">            â””â”€â”€ bochsrc.5.gz</span><br></pre></td></tr></table></figure><h3 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h3><p>Bochs ä¸‹è½½é“¾æä¾›äº† Bochs ä¸åŒç‰ˆæœ¬çš„æºç çš„ä¸‹è½½ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä¸€äº›å¯ç”¨çš„ç£ç›˜æ˜ åƒæ–‡ä»¶(éƒ½æ˜¯ä¸€äº›å·²ç»ç»è¿‡å¤„ç†ï¼Œå¯ç”¨ä½¿ç”¨è¿›è¡Œä»¿çœŸè¿è¡Œçš„ OS )</p><p>è¯´å®è¯ï¼Œè¿™æ˜¯ç»å¯¹æœ‰å¿…è¦è¿›è¡Œçš„ä¸€æ­¥ï¼Œä¸ä»…ä»…æ˜¯äº†è§£é…ç½®æ–‡ä»¶ bochsrc çš„é…ç½®æ–¹å¼ï¼Œæ›´å¯ç”¨å€Ÿæ­¤äº†è§£ä¸€ä¸‹ä»¿çœŸå™¨çš„ä½¿ç”¨æ–¹å¼ã€‚(åœ¨å¯åŠ¨ç³»ç»Ÿä¸Šï¼Œæˆ‘ä¹Ÿè¢«å‘äº†ä¸€å¤©ï¼Œåé¢ç»†è¯´)</p><p>é¦–å…ˆï¼Œè¿™é‡Œæ¼”ç¤ºçš„å°†æ˜¯ DLX Linux ã€‚</p><ol><li><p>ä¸‹è½½ï¼Œè§£å‹ï¼Œè¿›å…¥ç›®å½•ã€‚</p></li><li><p>ç›®å½•ä¸‹æ–‡ä»¶å¦‚ä¸‹</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ bochsrc.txt         // bochs å¯åŠ¨æ—¶å°†é»˜è®¤é€šè¿‡è¿™ä¸ªæ–‡ä»¶è¯»å–ä»¿çœŸå™¨é…ç½®</span><br><span class="line">â”œâ”€â”€ hd10meg.img         // ç£ç›˜æ˜ åƒæ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ readme.txt</span><br><span class="line">â””â”€â”€ testform.txt</span><br></pre></td></tr></table></figure><ol start="3"><li>å¯åŠ¨ä»¿çœŸå™¨</li></ol><p>åœ¨ DLX Linux ç›®å½•ä¸‹é”®å…¥å‘½ä»¤ <code>bochs</code>, è§‚å¯Ÿåˆ°å‘½ä»¤è¡Œè¾“å‡º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">========================================================================</span><br><span class="line">                       Bochs x86 Emulator 2.6.9</span><br><span class="line">               Built from SVN snapshot on April 9, 2017</span><br><span class="line">                  Compiled on May  2 2018 at 13:26:32</span><br><span class="line">========================================================================</span><br><span class="line">00000000000i[      ] LTDL_LIBRARY_PATH not set. using compile time default &apos;/usr/local/Cellar/bochs/2.6.9_2/lib/bochs/plugins&apos;</span><br><span class="line">00000000000i[      ] BXSHARE not set. using compile time default &apos;/usr/local/Cellar/bochs/2.6.9_2/share/bochs&apos;</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef2252a500</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_usb_common.so</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef2252a8a0</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_unmapped.so</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef2252ad00</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_biosdev.so</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef2252b1e0</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_speaker.so</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef2252ba50</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_extfpuirq.so</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef2252be70</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_parallel.so</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef238013c0</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_serial.so</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef22706cd0</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_iodebug.so</span><br><span class="line">00000000000i[      ] reading configuration from bochsrc.txt</span><br><span class="line">------------------------------</span><br><span class="line">Bochs Configuration: Main Menu</span><br><span class="line">------------------------------</span><br><span class="line"></span><br><span class="line">This is the Bochs Configuration Interface, where you can describe the</span><br><span class="line">machine that you want to simulate.  Bochs has already searched for a</span><br><span class="line">configuration file (typically called bochsrc.txt) and loaded it if it</span><br><span class="line">could be found.  When you are satisfied with the configuration, go</span><br><span class="line">ahead and start the simulation.</span><br><span class="line"></span><br><span class="line">You can also start bochs with the -q option to skip these menus.</span><br><span class="line"></span><br><span class="line">1. Restore factory default configuration</span><br><span class="line">2. Read options from...</span><br><span class="line">3. Edit options</span><br><span class="line">4. Save options to...</span><br><span class="line">5. Restore the Bochs state from...</span><br><span class="line">6. Begin simulation</span><br><span class="line">7. Quit now</span><br><span class="line"></span><br><span class="line">Please choose one: [6]</span><br></pre></td></tr></table></figure><p>bochs é»˜è®¤è¯»å–å½“å‰ç›®å½•ä¸‹ <code>bochsrc.txt</code> æ–‡ä»¶ï¼Œå› æ­¤ä¸éœ€è¦å…¶ä»–é…ç½®ã€‚</p><p>é€‰æ‹© 6 æˆ–è€…ç›´æ¥ <em>å›è½¦</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00000000000i[      ] lt_dlhandle is 0x7fef22707270</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_sdl2.so</span><br><span class="line">00000000000i[      ] installing sdl2 module as the Bochs GUI</span><br><span class="line">00000000000i[SDL2  ] maximum host resolution: x=2880 y=1800</span><br><span class="line">00000000000i[      ] using log file bochsout.txt</span><br><span class="line">Next at t=0</span><br><span class="line">(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0</span><br><span class="line">&lt;bochs:1&gt;</span><br></pre></td></tr></table></figure><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fuevtktuh0j30zc0tcwfd.jpg" alt=""></p><p>ç»ˆç«¯å‡ºç°æ›´å¤šè¾“å‡ºï¼ŒåŒæ—¶ Bochs å¼€å¯äº†ä¸€ä¸ªå¯è§†åŒ–ç»ˆç«¯(å½“ç„¶ï¼Œç°åœ¨è¿˜æ²¡æœ‰ä»»ä½•å†…å®¹)ã€‚</p><p>åœ¨è¿™å„¿è¢«å‘äº†å¥½ä¹…ã€‚æœ¬æ¥ä»¥ä¸º Bochs ä¼šç›´æ¥æ‰§è¡Œ BIOS æŒ‡ä»¤ï¼Œå¯åŠ¨æ“ä½œç³»ç»Ÿï¼Œä½†æ˜¯è‡ªå§‹è‡³ç»ˆï¼Œåœåœ¨è¿™é‡Œå°±æ²¡åŠ¨è¿‡â€¦</p><p>è¿™è¾¹æ˜¯ç”±äº Bochs æœ¬èº«æ˜¯æ”¯æŒè°ƒè¯•çš„(T_Tï¼Œè§é¬¼)ï¼Œå°±åƒæ˜¯ GDB å’Œ LLDB ä¸€æ ·ï¼Œè¿›å…¥è°ƒè¯•åï¼Œéœ€è¦æŒ‡ä»¤ <code>c</code> (continue) æ¥ç»§ç»­æ‰§è¡Œ(å½“ç„¶ï¼Œè¿˜æœ‰å…¶å®ƒè°ƒè¯•å‘½ä»¤)</p><ol start="4"><li>é”®å…¥ <code>c</code> </li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:1&gt; c</span><br></pre></td></tr></table></figure><p>ä»¿çœŸå™¨å¼€å§‹å¼•å¯¼ç¨‹åºçš„åŠ è½½</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fuew9zoocuj313c0pstaw.jpg" alt=""></p><p>OS Kernel å¯åŠ¨ï¼Œç­‰å¾…ç”¨æˆ·ç™»å½• (é»˜è®¤çš„ç”¨æˆ·æ˜¯ root , æ²¡æœ‰å¯†ç )ã€‚<br>ä¹‹åå°±å’Œæ™®é€šçš„ Linux æœºå™¨ç±»ä¼¼ï¼Œä¸è¿‡æ”¯æŒçš„å‘½ä»¤æ¯”è¾ƒå°‘ã€‚æ¯•ç«Ÿæ˜¯ä¸€ä¸ªç²¾ç®€åçš„ç³»ç»Ÿã€‚</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fuewamqzm6j313q0pqjtw.jpg" alt=""></p><ol start="5"><li>å…³æœº</li></ol><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fuewi9wjawj313q0q2gnc.jpg" alt=""></p><p>ä»¿çœŸå™¨ä»¿çœŸäº†è®¸å¤šå®ä½“æœºæ¡ˆä»¶ï¼Œå³ä¸Šè§’æœ€åä¸€ä¸ªå°±æ˜¯å…³æœºé”®</p><h2 id="Docker-å®¹å™¨ä¸­è¿è¡Œ-Ubuntu"><a href="#Docker-å®¹å™¨ä¸­è¿è¡Œ-Ubuntu" class="headerlink" title="Docker å®¹å™¨ä¸­è¿è¡Œ Ubuntu"></a>Docker å®¹å™¨ä¸­è¿è¡Œ Ubuntu</h2><p>è¿™éƒ¨åˆ†ä¸è¯¦è¿°ï¼Œä½œä¸ºä¸€ä¸ªçƒ­é—¨çš„æŠ€æœ¯ï¼Œè¿™æ–¹é¢çš„èµ„æ–™å¾ˆå¤šã€‚Ubuntu ç³»ç»Ÿåªæ˜¯ä¸ºäº†æ¥æ‰§è¡Œä¸€äº› macOS ä¸Šæ²¡æœ‰çš„å‘½ä»¤çš„(æ¯”å¦‚ <code>as86</code>, <code>ld86</code>)</p><p>ç®€è¿°ä¸¤ä¸ª docker å®¹å™¨å’Œå®¿ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶çš„å‘½ä»¤ </p><p>åœ¨å®¿ä¸»æœºä¸‹æ‰§è¡Œå‘½ä»¤:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-</span><br><span class="line">docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH [flags]</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp linux:/root/hello.c ./hello.c         <span class="comment"># è¿™é‡Œ linux æ˜¯ docker å®¹å™¨å</span></span><br><span class="line">docker cp 92dfc8ad70e1:/root/hello.c ./hello.c  <span class="comment"># è¿™é‡Œ 92dfc8ad70e1 æ˜¯ docker å®¹å™¨ ID</span></span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1]. ä¿ç”²å­. ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»[M]. ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾, 2009.<br>[2]. èµµç‚¯. Linuxå†…æ ¸å®Œå…¨æ³¨é‡Š å†…æ ¸ç‰ˆæœ¬0.11 V3.0[EB/OL]. <a href="http://www.oldlinux.org/" target="_blank" rel="noopener">http://www.oldlinux.org/</a>, 2007</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h2&gt;&lt;p&gt;ä¹‹æ‰€ä»¥æƒ³è¦äº†è§£ Linux Kernelï¼Œä¸å‰ä¸€ä¸ªæœˆçš„ JVM ClassFile çš„å­¦ä¹ æœ‰è¿™å¾ˆå¤§çš„å…³è”ã€‚&lt;/p&gt;
&lt;p&gt;è¯´å®è¯ï¼Œåˆ¨é™¤ JVM çš„å…·ä½“å®ç°ï¼ŒSun (æˆ–è€…ç°åœ¨è¯¥è¯´æ˜¯ Oracle) ç¡®å®å°† Java çš„åº•å±‚é€»è¾‘è®¾è®¡å¾—ç›¸å½“ç®€å•ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æœ‰é™è€Œç»Ÿä¸€çš„æŒ‡ä»¤é›†(ä¸è¶…è¿‡ 256 ä¸ªï¼Œå¯ä»¥ç”¨ 1 å­—èŠ‚è¡¨ç¤º)&lt;/li&gt;
&lt;li&gt;æ“ä½œæ•°æ ˆ+å±€éƒ¨å˜é‡è¡¨å…±åŒå®ç°çš„æŒ‡ä»¤è¿ç®—&lt;/li&gt;
&lt;li&gt;é«˜åº¦å°è£…çš„æˆå‘˜å˜é‡/æ–¹æ³•çš„å¯»å€æ–¹å¼&lt;/li&gt;
&lt;li&gt;â€¦ (è§è¯†çŸ­æµ…ï¼Œæƒ³ä¸åˆ°äº†â€¦ä»¥åå†è¡¥å……å§)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œä¸ JVM æ¨¡æ‹Ÿçš„è™šæ‹Ÿæœºä¸åŒï¼Œå®ä½“æœºå™¨æœ‰ç€æ›´ä¸ºå¤æ‚çš„ç»“æ„ã€‚&lt;br&gt;æœ€æ ¹æœ¬çš„ï¼Œä¸åŒå‚å•†çš„æœºå™¨å°±å¸¦æ¥äº†ä¸åŒçš„ CPU æŒ‡ä»¤é›†ï¼Œè¿™å°±å·²ç»è®©äººéš¾ä»¥æ¥å—äº†ã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®æœ€åˆï¼Œæ˜¯æƒ³è¦ç»§ç»­å»çœ‹çœ‹ Hotspot è™šæ‹Ÿæœºçš„ã€‚ä½†æ˜¯ï¼Œæ··æ‚çš„ä»£ç (C++, Java, å¹³å°ç›¸å…³å„ç§å®ç°) å¸¦æ¥äº†å¾ˆå¤§çš„é˜…è¯»éšœç¢ã€‚&lt;br&gt;æœ€æ ¹æœ¬çš„ï¼Œæˆ‘ç”šè‡³æ‰¾ä¸åˆ°ä¸€ä¸ªå­¦ä¹ çš„åŸºæœ¬ç«‹è¶³ç‚¹ï¼Œå‡ºå‘ç‚¹(å½“ç„¶ï¼Œä¹Ÿå¯èƒ½æˆ‘æ ¹æœ¬å°±æ²¡ä»”ç»†å»çœ‹ï¼Œå“ˆå“ˆ)ã€‚&lt;/p&gt;
&lt;p&gt;å€Ÿç€ä¸€æ¬¡æœºä¼šï¼Œæˆ‘å¼€å§‹çœ‹ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹ä¸€ä¹¦ã€‚ç¡®å®æ— è®ºæ˜¯ ELF æ ¼å¼ï¼Œé™æ€é“¾æ¥ä¸åŠ¨æ€é“¾æ¥ç”šè‡³ Linux çš„å†…å»ºå‡½æ•°&lt;br&gt;éƒ½ç»™äº†æˆ‘æ¯”è¾ƒæ·±åˆ»çš„å°è±¡ï¼Œå‘æˆ‘å±•ç¤ºäº† C æ›´æ·±å…¥çš„ä¸€é¢ã€‚ä½†æ˜¯ï¼ŒmacOS ç»™æˆ‘å¸¦æ¥äº†æ¯”è¾ƒå¤§çš„å®¢è§‚é˜»ç¢(å³ä½¿ç”¨ Docker å®¹å™¨å¾—åˆ°äº†ä¸€ä¸ªå¯ç”¨çš„ Linux ç¯å¢ƒï¼Œä½†æ˜¯å¦ä¸ç›´æ¥å»ºç«‹åœ¨æœºå™¨ä¸Šçš„ç³»ç»Ÿæœ‰æ‰€åŒºåˆ«ï¼Œæ­¤å¤„è¿˜å¾—æ‰“ä¸ªé—®å·)ã€‚&lt;br&gt;åŒæ—¶ï¼Œä¹¦ä¸­çš„éƒ¨åˆ†å†…å®¹ä¸Šä¸‹ä¸ç»Ÿä¸€ï¼Œç¼ºå°‘å‰åæ–‡ä¹Ÿæ˜¯ä¸€ä¸ªé‡å¤§çš„é—®é¢˜ã€‚æ€»ä¹‹ï¼Œè¿™å¹¶ä¸å®Œå…¨é€‚åˆæˆ‘è¿™ç§åˆå­¦è€…é€ä¸€è¿›è¡Œä¹¦ä¸­æ‰€æè¿°çš„å…¨éƒ¨å®éªŒã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œæˆ‘å†³å®šå±•å¼€å¯¹ Linux Kernel çš„å­¦ä¹ ï¼Œè¯•å›¾é€šè¿‡å¯¹ç›´æ¥æ„æ¶åœ¨ç¡¬ä»¶ä¸Šçš„æ“ä½œç³»ç»Ÿè¿›è¡Œä¸€ç•ªæ¯”è¾ƒæ·±å…¥çš„å­¦ä¹ ã€‚&lt;/p&gt;
&lt;p&gt;æœŸé—´ï¼Œæ‰¾è¿‡ä¸€äº›èµ„æ–™ï¼Œä¹Ÿäº†è§£åˆ° Linus Torvals ç›´æ¥é¢†å¯¼ç€çš„ &lt;a href=&quot;https://www.kernel.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Kernel é¡¹ç›®çš„å®˜ç½‘&lt;/a&gt;ï¼›ç”šè‡³ï¼Œæ‰¾åˆ°äº†å„ä¸ªç‰ˆæœ¬çš„ kernel æºç (è™½ç„¶ç¡®å®åœ°ä¸¢å¤±äº†æœ€æ—©æœŸ 0.XX çš„è‹¥å¹²ç‰ˆæœ¬)ã€‚&lt;br&gt;ä¸å¾—ä¸è¯´ï¼Œå°±ç›®å‰æ¥è®²ï¼Œæˆ‘è§‰å¾—ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹æ˜¯æœ€é€‚åˆ(&lt;em&gt;æ‰“ä¸ªé—®å·ï¼Œè‡³å°‘æš‚æ—¶æ˜¯çš„&lt;/em&gt;)æˆ‘å­¦ä¹ çš„ä¸€ä¹¦ã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹åçš„è‹¥å¹²åšæ–‡ï¼Œå°†éƒ½ä»¥ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸­çš„å†…å®¹ä¸ºåŸºç¡€ï¼Œç»“åˆç›®å‰çš„å®é™…éœ€è¦ï¼Œä»è€Œè¿›è¡Œå®æ“æ€§çš„è®¤çŸ¥ä¸å­¦ä¹ ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Linux Kernel (1) - BIOS</title>
    <link href="https://DorMOUSE-None.github.io/2018-08-19-understand-Kernel-1/"/>
    <id>https://DorMOUSE-None.github.io/2018-08-19-understand-Kernel-1/</id>
    <published>2018-08-18T16:00:00.000Z</published>
    <updated>2018-08-19T08:22:30.382Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨<a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">æ¦‚è¿°</a>ï¼Œæˆ‘æƒ³æˆ‘å·²ç»ä»‹ç»è¿‡æˆ‘å¼€å§‹è¿™ä¸€äº›åˆ—åšæ–‡çš„åŸå› ã€‚<br>æˆ‘ä¸èƒ½æ‹…ä¿æˆ‘æ‰€è¿›è¡Œçš„æ‰€æœ‰è¯•éªŒæ€§æ“ä½œéƒ½æ˜¯å¯¹çš„ï¼Œä½†æ˜¯ï¼Œè‡³å°‘è¿™äº›åœ¨æˆ‘æ‰€æè¿°çš„ç¯å¢ƒä¸‹æˆåŠŸçš„è¿è¡Œäº†èµ·æ¥ï¼Œå¹¶å¸®åŠ©æˆ‘è§¦åŠæˆ‘å§‹ç»ˆæ•¬ç•è€Œåˆæ•¬è€Œè¿œä¹‹çš„<strong>ç¡¬ä»¶&amp;OS</strong></p><p>åœ¨ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸€ä¹¦ç¬¬ä¸‰ç« â€”â€”å†…æ ¸ç¼–ç¨‹è¯­è¨€å’Œç¯å¢ƒï¼Œæè¿°äº†ç”¨ as86 æ±‡ç¼–è¯­è¨€æ„å»º boot å¼•å¯¼ç¨‹åºï¼Œå¹¶æœ€ç»ˆé€šè¿‡ Bochs ä»¿çœŸå™¨åœ¨æ¨¡æ‹Ÿå¼€æœºé€šç”µåï¼ŒBIOS Load<br>boot ç¨‹åºï¼Œé€šè¿‡æ˜¾ç¤ºå™¨è¾“å‡º <em>Loading Systemâ€¦</em> ã€‚</p><p>è¿™äº›ï¼Œå°†æ˜¯è¿™é‡Œæ‰€è¦æè¿°çš„ä¸»è¦å†…å®¹ã€‚</p><a id="more"></a><h2 id="boot-s-æ±‡ç¼–ç¨‹åº"><a href="#boot-s-æ±‡ç¼–ç¨‹åº" class="headerlink" title="boot.s æ±‡ç¼–ç¨‹åº"></a>boot.s æ±‡ç¼–ç¨‹åº</h2><p>è¿™é‡Œæ²¡æ³•å¤šè¯´ï¼Œéƒ½æ˜¯ä¹¦ä¸­çš„æºç ï¼Œåªæ˜¯ä¾›æœªè¯»è¿‡ä¹¦çš„è¯»è€…å‚è€ƒï¼Œç‰¹æ„æ‘˜å½•äº†ä¸‹æ¥(ä¸è¿‡ï¼Œå°±ä¸åŠ æ³¨é‡Šäº†)</p><p>boot.s æºä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.global begtext, begdata, begbss, endtext, enddata, endbss</span><br><span class="line">.text</span><br><span class="line">begtext:</span><br><span class="line">.data</span><br><span class="line">begdata:</span><br><span class="line">.bss</span><br><span class="line">begbss:</span><br><span class="line">.text</span><br><span class="line">BOOTSEG=0x07c0</span><br><span class="line"></span><br><span class="line">entry start</span><br><span class="line">start:</span><br><span class="line">    jmpi    go,BOOTSEG</span><br><span class="line">go: mov ax,cs</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov [msg+17],ah</span><br><span class="line">    mov cx,#20</span><br><span class="line">    mov dx,#0x1004</span><br><span class="line">    mov bx,#0x000c</span><br><span class="line">    mov bp,#msg</span><br><span class="line">    mov ax,#0x1301</span><br><span class="line">    int 0x10</span><br><span class="line">loop1:  jmp loop1</span><br><span class="line">msg:    .ascii  &quot;Loading System...&quot;</span><br><span class="line">        .byte   13,10</span><br><span class="line">.org    510</span><br><span class="line">.word   0xAA55</span><br><span class="line">.text</span><br><span class="line">endtext:</span><br><span class="line">.data</span><br><span class="line">enddata:</span><br><span class="line">.bss</span><br><span class="line">endbss:</span><br></pre></td></tr></table></figure><p>è¿™æ®µç¨‹åºçš„ä¸»è¦çš„æ‰§è¡Œæµç¨‹å°†æ˜¯:</p><ol><li>é€šè¿‡ BIOS åŠ è½½è¿™æ®µ boot å¼•å¯¼ç¨‹åº</li><li>çº¢è‰²å­—ä½“æ‰“å° <em>Loading Systemâ€¦</em> å¹¶å“é“ƒ</li><li>æŒ‡ä»¤è‡ªå¾ªç¯ (<code>loop1 jmp loop1</code>) ï¼Œå°†å§‹ç»ˆå±•ç¤ºä¸Šè¿°å­—æ ·ï¼Œå¹¶ä¸æ¥æ”¶å‘½ä»¤</li></ol><p>ä¸‹é¢å°±è¯¥æŠŠè¿™ä¸ªæ±‡ç¼–ç¨‹åº <em>ç¼–è¯‘ + é“¾æ¥</em> æˆ boot å¼•å¯¼ç¨‹åºã€‚</p><p>è™½ç„¶åœ¨ macOS ä¸Šç¡®å®æ‰¾åˆ°äº†ä¸€ä¸ª as86 æ±‡ç¼–å™¨(æ¥è‡ª nasm çš„ä¸€ä¸ªç¼–è¯‘é€‰é¡¹ï¼Œä½†æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆå§‹ç»ˆæ— æ³•æ­£å¸¸ç¼–è¯‘ï¼Œä¹Ÿå¯èƒ½è¿™ä¸ªæ ¹æœ¬å°±ä¸æ˜¯æˆ‘æƒ³è¦çš„)ã€‚</p><p>é€šè¿‡ docker å®¹å™¨éƒ¨ç½²çš„ Ubuntuï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å¾—åˆ°ä¸€ä¸ª as86 æ±‡ç¼–ç¨‹åºã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apt-get install bin86   <span class="comment"># as86, ld86 éƒ½åœ¨è¿™ä¸ªåŒ…é‡Œæä¾›äº†</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™å¥éœ€è¦åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œ</span></span><br><span class="line">docker cp boot.s linux:/root/boot.s     <span class="comment"># è¿™é‡Œ linux æ˜¯æˆ‘ docker éƒ¨ç½²çš„ Ubuntu çš„å®¹å™¨çš„åç§°ã€‚   å¦‚æœä¹‹å‰ boot.s åœ¨å®¿ä¸»æœºä¸Šï¼Œå¯ä»¥è¿™æ ·æ‹·è´åˆ°å®¹å™¨ä¸­</span></span><br><span class="line"></span><br><span class="line">as86 -0 -a -o boot.o boot.s             <span class="comment"># ç¼–è¯‘</span></span><br><span class="line"></span><br><span class="line">ld86 -0 -s -o execfile boot.o           <span class="comment"># é“¾æ¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“ç„¶ï¼Œåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå…¶å®éƒ½å¯ä»¥ç†è§£æˆåœ¨å°†æ±‡ç¼–ä»£ç ç¼–è¯‘é“¾æ¥æˆå¯æ‰§è¡Œç¨‹åº (å’Œ boot å¼•å¯¼ç¨‹åºæ²¡æœ‰å¤ªå¤§å…³ç³»ï¼Œå”¯ä¸€æœ‰å…³ç³»çš„å°±æ˜¯è¿™æ®µæ±‡ç¼–è¯­è¨€æ˜¯ä»¥å¼•å¯¼ä¸ºç›®çš„å†™çš„)</span></span><br><span class="line"></span><br><span class="line">dd bs=32 <span class="keyword">if</span>=execfile of=boot skip=1     <span class="comment"># è¿™é‡Œå»æ‰å¯æ‰§è¡Œç¨‹åºçš„å‰ 32 å­—èŠ‚ï¼Œå½¢æˆåˆšå¥½ 512 å­—èŠ‚çš„ boot å¼•å¯¼ç¨‹åº</span></span><br></pre></td></tr></table></figure><h2 id="ç”¨ä»¿çœŸå™¨å¯åŠ¨å¼•å¯¼ç¨‹åº"><a href="#ç”¨ä»¿çœŸå™¨å¯åŠ¨å¼•å¯¼ç¨‹åº" class="headerlink" title="ç”¨ä»¿çœŸå™¨å¯åŠ¨å¼•å¯¼ç¨‹åº"></a>ç”¨ä»¿çœŸå™¨å¯åŠ¨å¼•å¯¼ç¨‹åº</h2><p>äº‹å®ä¸Šï¼Œè¿™éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘å§‹ç»ˆæ²¡æœ‰ææ¸…æ¥š <strong>ç£ç›˜æ˜ åƒæ–‡ä»¶</strong> å’Œ <strong>boot å¼•å¯¼ç¨‹åº</strong> é—´çš„å…³ç³»(å½“ç„¶è¿˜æœ‰ floppy å’Œ ata0~3)</p><p>åœ¨ä¸Šä¸€èŠ‚æˆåŠŸæ‹¿åˆ° <em>512B</em> çš„ boot å¼•å¯¼ç¨‹åºä¹‹åï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªè²Œä¼¼æˆ‘ä¹Ÿè¿è¡ŒæˆåŠŸäº†(æ ¹æœ¬å°±ä¸éœ€è¦åˆ›å»ºç£ç›˜æ˜ åƒæ–‡ä»¶å¹¶å°†å¼•å¯¼ç¨‹åºå†™å…¥æ˜ åƒæ–‡ä»¶ä¸­ï¼Œä¸è¿‡ï¼Œä¹Ÿè®¸åªæ˜¯å› ä¸ºè¿™ä¸ªå¼•å¯¼ç¨‹åºå¤ªç®€å•äº†ï¼Œæ ¹æœ¬å°±ä¸éœ€è¦å…¶ä»–ç¨‹åºçš„é…åˆã€‚å®ƒæœ€åå°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ )</p><p>æ€»ä¹‹ï¼Œå…ˆæŒ‰ç…§æœ€ç®€å•çš„æ¥å§ã€‚</p><p>æŠŠ boot å¼•å¯¼ç¨‹åºæ‹·è´åˆ°å®¿ä¸»æœºä¸Š(è²Œä¼¼é¢‘ç¹åœ°åœ¨ä¸¤ä¸ªOSä¸Šäº¤äº’æ–‡ä»¶ï¼Œè¿™ä¸ªå¾ˆæ— å¥ˆï¼Œdockerå®¹å™¨ä¸­çš„è¿›ç¨‹éš¾ä»¥å¯åŠ¨æ˜¾ç¤ºç¨‹åº)</p><ol><li>åœ¨å®¿ä¸»æœºæ–°å»ºä¸€ä¸ªç›®å½• <em>linux-boot</em></li><li>æ‹·è´ boot å¼•å¯¼ç¨‹åºåˆ°å®¿ä¸»æœºä¸Š <code>docker cp linux:/root/boot linux-boot/</code></li><li>åœ¨ <em>linux-boot</em> ä¸‹å»ºç«‹ bochsrc æ–‡ä»¶(è¿™å°†æ˜¯æ•´ä¸ªä»¿çœŸå™¨çš„é…ç½®ï¼Œç”¨äºæ¨¡æ‹Ÿç»„è£…æœºå™¨æ¶‰åŠçš„ CPU, å†…å­˜, BIOS, æ˜¾ç¤ºå™¨ç­‰)</li><li>è¿™é‡Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹:</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># You may now use double quotes around pathnames, in case</span><br><span class="line"># your pathname includes spaces.</span><br><span class="line"></span><br><span class="line">cpu: model=pentium, count=1, ips=50000000, reset_on_triple_fault=1, ignore_bad_msrs=1, msrs=&quot;msrs.def&quot;</span><br><span class="line">cpu: cpuid_limit_winnt=0</span><br><span class="line"></span><br><span class="line">memory: guest=512, host=256</span><br><span class="line"></span><br><span class="line">romimage: file=$BXSHARE/BIOS-bochs-legacy, options=fastboot     # BIOS é…ç½®</span><br><span class="line"></span><br><span class="line">vgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest</span><br><span class="line"></span><br><span class="line">mouse: enabled=0</span><br><span class="line"></span><br><span class="line">pci: enabled=1, chipset=i440fx</span><br><span class="line"></span><br><span class="line">private_colormap: enabled=0</span><br><span class="line"></span><br><span class="line">floppya: 1\_44=&quot;./boot&quot;, status=inserted         # è£…è½½ä¸€ä¸ªè½¯ç›˜ A ï¼Œè¿™é‡Œç”¨å½“å‰ç›®å½•ä¸‹çš„ boot (boot å¼•å¯¼ç¨‹åºï¼Œäº‹å®ä¸Šä¹¦ä¸­è¯´è¦ç”¨ .img ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œä½†è¿™é‡Œä¸å½±å“å®é™…æ•ˆæœ)</span><br><span class="line"></span><br><span class="line">ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14</span><br><span class="line">ata1: enabled=1, ioaddr1=0x170, ioaddr2=0x370, irq=15</span><br><span class="line">ata2: enabled=0, ioaddr1=0x1e8, ioaddr2=0x3e0, irq=11</span><br><span class="line">ata3: enabled=0, ioaddr1=0x168, ioaddr2=0x360, irq=9</span><br><span class="line"></span><br><span class="line">boot: a                                         # é…ç½®å¼•å¯¼ç¨‹åºæ‰€åœ¨çš„ç£ç›˜</span><br><span class="line"></span><br><span class="line">floppy_bootsig_check: disabled=0</span><br><span class="line"></span><br><span class="line">log: bochsout.txt</span><br><span class="line"></span><br><span class="line">panic: action=ask</span><br><span class="line">error: action=report</span><br><span class="line">info: action=report</span><br><span class="line">debug: action=ignore, pci=report # report BX_DEBUG from module &apos;pci&apos;</span><br><span class="line"></span><br><span class="line">debugger_log: -</span><br><span class="line"></span><br><span class="line">parport1: enabled=1, file=&quot;parport.out&quot;</span><br><span class="line"></span><br><span class="line">speaker: enabled=1, mode=sound</span><br></pre></td></tr></table></figure><ol start="5"><li>å½“å‰ç›®å½• <em>linux-boot</em> ä¸‹ï¼Œé”®å…¥å‘½ä»¤ <code>bochs</code></li><li>ç”±äºè¯»å–åˆ° <em>bochsrc</em> é…ç½®æ–‡ä»¶çš„å­˜åœ¨ï¼Œmenu çš„é»˜è®¤é€‰é¡¹ä¸º 6 (å¼€å§‹æ¨¡æ‹Ÿæœºå™¨)</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">You can also start bochs with the -q option to skip these menus.</span><br><span class="line"></span><br><span class="line">1. Restore factory default configuration</span><br><span class="line">2. Read options from...</span><br><span class="line">3. Edit options</span><br><span class="line">4. Save options to...</span><br><span class="line">5. Restore the Bochs state from...</span><br><span class="line">6. Begin simulation</span><br><span class="line">7. Quit now</span><br><span class="line"></span><br><span class="line">Please choose one: [6]</span><br></pre></td></tr></table></figure><ol start="7"><li>ç›´æ¥å¼€å§‹è¿è¡Œæœºå™¨ï¼Œé”®å…¥å‘½ä»¤ <code>c</code> (è¿™éƒ¨åˆ†åœ¨ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">æ¦‚è¿°</a> æœ‰è¿‡äº†æè¿°ï¼Œä»¥åå°†ä¸å†æè¿°)</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Please choose one: [6]</span><br><span class="line">00000000000i[      ] lt_dlhandle is 0x7f85d0405ff0</span><br><span class="line">00000000000i[PLUGIN] loaded plugin libbx_sdl2.so</span><br><span class="line">00000000000i[      ] installing sdl2 module as the Bochs GUI</span><br><span class="line">00000000000i[SDL2  ] maximum host resolution: x=2880 y=1800</span><br><span class="line">00000000000i[      ] using log file bochsout.txt</span><br><span class="line">Next at t=0</span><br><span class="line">(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0</span><br><span class="line">&lt;bochs:1&gt; c</span><br></pre></td></tr></table></figure><ol start="8"><li>è§‚å¯Ÿä»¿çœŸå™¨çš„è¡¨ç°</li></ol><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fuf2kicsqyj313y0q0gn4.jpg" alt=""></p><p>Oh, YES! æˆåŠŸè¾“å‡ºäº† <em>Loading Systemâ€¦</em> (ä¸è¿‡å“é“ƒæ²¡æœ‰å¬åˆ°ï¼Œå¯èƒ½ä¸æˆ‘æ²¡æœ‰é…ç½® sound æœ‰å…³)</p><ol start="9"><li>å…³æœº</li></ol><p>æ— éœ€å¤šè¨€ï¼Œå³ä¸Šè§’æ¨¡æ‹Ÿçš„å°±æ˜¯<strong>å…³æœºå®ä½“æŒ‰é”®</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åœ¨&lt;a href=&quot;https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/&quot;&gt;æ¦‚è¿°&lt;/a&gt;ï¼Œæˆ‘æƒ³æˆ‘å·²ç»ä»‹ç»è¿‡æˆ‘å¼€å§‹è¿™ä¸€äº›åˆ—åšæ–‡çš„åŸå› ã€‚&lt;br&gt;æˆ‘ä¸èƒ½æ‹…ä¿æˆ‘æ‰€è¿›è¡Œçš„æ‰€æœ‰è¯•éªŒæ€§æ“ä½œéƒ½æ˜¯å¯¹çš„ï¼Œä½†æ˜¯ï¼Œè‡³å°‘è¿™äº›åœ¨æˆ‘æ‰€æè¿°çš„ç¯å¢ƒä¸‹æˆåŠŸçš„è¿è¡Œäº†èµ·æ¥ï¼Œå¹¶å¸®åŠ©æˆ‘è§¦åŠæˆ‘å§‹ç»ˆæ•¬ç•è€Œåˆæ•¬è€Œè¿œä¹‹çš„&lt;strong&gt;ç¡¬ä»¶&amp;amp;OS&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸€ä¹¦ç¬¬ä¸‰ç« â€”â€”å†…æ ¸ç¼–ç¨‹è¯­è¨€å’Œç¯å¢ƒï¼Œæè¿°äº†ç”¨ as86 æ±‡ç¼–è¯­è¨€æ„å»º boot å¼•å¯¼ç¨‹åºï¼Œå¹¶æœ€ç»ˆé€šè¿‡ Bochs ä»¿çœŸå™¨åœ¨æ¨¡æ‹Ÿå¼€æœºé€šç”µåï¼ŒBIOS Load&lt;br&gt;boot ç¨‹åºï¼Œé€šè¿‡æ˜¾ç¤ºå™¨è¾“å‡º &lt;em&gt;Loading Systemâ€¦&lt;/em&gt; ã€‚&lt;/p&gt;
&lt;p&gt;è¿™äº›ï¼Œå°†æ˜¯è¿™é‡Œæ‰€è¦æè¿°çš„ä¸»è¦å†…å®¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://DorMOUSE-None.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://DorMOUSE-None.github.io/tags/Kernel/"/>
    
      <category term="BIOS" scheme="https://DorMOUSE-None.github.io/tags/BIOS/"/>
    
  </entry>
  
  <entry>
    <title>Java Instrumentation</title>
    <link href="https://DorMOUSE-None.github.io/2018-08-15-Java-Instrumentation/"/>
    <id>https://DorMOUSE-None.github.io/2018-08-15-Java-Instrumentation/</id>
    <published>2018-08-14T16:00:00.000Z</published>
    <updated>2018-08-17T09:34:33.762Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p>ä»ç°æœ‰çš„å‰ç½®çŸ¥è¯†æ¥è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¤è¯†åˆ°ä¸¤ä¸ªäº‹å®:</p><ol><li>Java Class é€šè¿‡ ClassLoader è¿›è¡ŒåŠ è½½ã€‚<br>é€šè¿‡<code>å…¨é™å®šå</code>è¿›è¡ŒåŒºåˆ†ã€‚å½“éœ€è¦åŠ è½½æ–°çš„ç±»æ—¶ï¼ŒClassLoader é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™ä¸ªç±»ã€‚<br>æ¢å¥è¯è¯´: Class ä¸€ç»åŠ è½½ï¼Œå°±ä¸ä¼šå°è¯•é‡å¤åŠ è½½ (è‡³å°‘æŒ‰ç»å¤§å¤šæ•°äººçš„è®¤çŸ¥æ¥è¯´ï¼Œç¡®å®æ˜¯çš„)</li><li>æœ‰æ²¡æœ‰å¯èƒ½è®©è¢«åŠ è½½çš„ Class ä¸ç‰©ç†å­˜å‚¨ä¸Šçš„ .class å†…å®¹ä¸åŒã€‚<br>å½“ç„¶ä¹Ÿæ˜¯å®Œå…¨å¯ä»¥åšåˆ°çš„ã€‚ä¸ç®¡æ€ä¹ˆè¯´ï¼ŒCGlib å’Œ Java Proxy ä¹Ÿæ˜¯ä¸€ä¸ªè€³ç†Ÿèƒ½è¯¦çš„æ¦‚å¿µå§<br>(è™½ç„¶å¯èƒ½ä¸äº†è§£ç»†èŠ‚ã€‚åœ¨æ­¤ï¼Œæ¬¢è¿å­¦ä¹ å‰ç½®æŠ€èƒ½ <a href="https://dormouse-none.github.io/2018-07-10-CGlib-Enhancer/">CGlib Enhancer ä¸»æµç¨‹æºç è§£æ</a> å’Œ <a href="https://dormouse-none.github.io/2018-07-20-Java-Proxy/">Java Proxy æºç è§£æ</a>ã€‚ä¸è¿‡ä¸å½±å“æœ¬æ–‡åç»­å†…å®¹)</li></ol><p>å¦ä¸€ä¸ªæ–¹é¢ï¼Œä¹Ÿè®¸ç»å¤§å¤šæ•°äººéƒ½å¬è¯´è¿‡æ‰€è°“çš„<code>çƒ­éƒ¨ç½²</code>ã€‚ä½†æ˜¯ç©¶ç«Ÿæ€ä¹ˆæ‰èƒ½åšåˆ° <code>çƒ­éƒ¨ç½²</code>(è¯é¢˜å¼€å¾—æœ‰ç‚¹å¤§å“ˆã€‚Y_Y æœ¬æ–‡ä¸è®²è¿™ä¸ª)</p><p>æ“ä½œå­—èŠ‚ç ä¸€å®šæ˜¯ä¸€ä¸ªé€ƒä¸å¼€çš„è¯é¢˜ï¼Œæ¯•ç«Ÿ Class å°±æ˜¯æ‰€è°“çš„è¢«åŠ è½½åˆ°å†…å­˜çš„å­—èŠ‚ç å˜›ã€‚</p><p>å¦‚ä½•æ“ä½œå­—èŠ‚ç ? ASM, CGlib, Java Proxy, Javassist ? ä¸è¿‡è¿™äº›éƒ½è¦ç­‰åˆ°éœ€è¦è¢«æ“ä½œçš„ç±»è¢«åŠ è½½äº†æ‰è¡Œå•Šï¼Œä¼¼ä¹æœ‰ç‚¹æ™šâ€¦</p><p>Java æä¾›äº†ä¸€ä¸ªå¯è¡Œçš„æœºåˆ¶ï¼Œç”¨æ¥åœ¨ ClassLoader åŠ è½½å­—èŠ‚ç ä¹‹å‰å®Œæˆå¯¹æ“ä½œå­—èŠ‚ç çš„ç›®çš„</p><h2 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h2><p><code>java.lang.instrument.Instrumentation</code> ç±»ä¸ºæä¾›ç›´æ¥æ“ä½œ Java å­—èŠ‚ç çš„åˆä¸€ä¸ªé€”å¾„(è™½ç„¶ Java Doc çš„è¯´æ˜æ˜¯ç”¨æ¥æ£€æµ‹ Java ä»£ç çš„)</p><p>ç›¸ä¿¡æˆ‘è¿™ä¸ªè¯´æ˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚æ¯•ç«Ÿå®Œæˆå¯¹ä»£ç æ£€æµ‹çš„é€”å¾„æ˜¯ç›´æ¥ä¿®æ”¹å­—èŠ‚ç ã€‚</p><p>ä¸‹åˆ—æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è¾¾åˆ°ç›®çš„</p><ol><li>å½“ JVM ä»¥æŒ‡ç¤ºä¸€ä¸ªä»£ç†ç±»çš„æ–¹å¼å¯åŠ¨æ—¶ï¼Œå°†ä¼ é€’ç»™ä»£ç†ç±»çš„ premain æ–¹æ³•ä¸€ä¸ª Instrumentation å®ä¾‹ã€‚</li><li>å½“ JVM æä¾›æŸç§æœºåˆ¶åœ¨ JVM å¯åŠ¨ä¹‹åæŸä¸€æ—¶åˆ»å¯åŠ¨ä»£ç†æ—¶ï¼Œå°†ä¼ é€’ç»™ä»£ç†ä»£ç çš„ agentmain æ–¹æ³•ä¸€ä¸ª Instrumentation å®ä¾‹ã€‚</li></ol><p>è¯ä¸å¤šè¯´ï¼Œä¸‹é¢å°†å…¨éƒ¨ä»¥å®ä¾‹æ¥å±•ç°å¯¹è¿™ç§ JVM æ£€æµ‹æœºåˆ¶(è™½ç„¶ä¾‹å­å·²ç»è„±ç¦»äº†<em>æ£€æµ‹</em>çš„ç›®çš„)çš„ä½¿ç”¨</p><a id="more"></a><h2 id="å¯¹å„æ–¹æ³•è¿›è¡Œæ‰§è¡Œæ—¶é—´ç»Ÿè®¡"><a href="#å¯¹å„æ–¹æ³•è¿›è¡Œæ‰§è¡Œæ—¶é—´ç»Ÿè®¡" class="headerlink" title="å¯¹å„æ–¹æ³•è¿›è¡Œæ‰§è¡Œæ—¶é—´ç»Ÿè®¡"></a>å¯¹å„æ–¹æ³•è¿›è¡Œæ‰§è¡Œæ—¶é—´ç»Ÿè®¡</h2><h3 id="éš-JVM-ä¸€èµ·å¯åŠ¨"><a href="#éš-JVM-ä¸€èµ·å¯åŠ¨" class="headerlink" title="éš JVM ä¸€èµ·å¯åŠ¨"></a>éš JVM ä¸€èµ·å¯åŠ¨</h3><p>åŸºæœ¬å®ä¾‹: å°†å¯¹ç‰¹å®šåŒ… <code>me.fangfeng.client</code> ä¸‹çš„æ¯ä¸ªæ–¹æ³•æ‰§è¡Œè®¡æ—¶</p><p>é¦–å…ˆäº†è§£ä¸€ä¸‹ client åŒ…çš„å†…å®¹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.fangfeng.client;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Main.java</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œä¸¤ä¸ªæ–¹æ³•ï¼Œrand() &amp; sleep() </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/8/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Rand rand = <span class="keyword">new</span> Rand();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"&gt;&gt;&gt; start Rand.run() &lt;&lt;&lt;"</span>);</span><br><span class="line">            rand.run();</span><br><span class="line">            System.out.println(<span class="string">"&gt;&gt;&gt; end Rand.run() &lt;&lt;&lt;"</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"&gt;&gt;&gt; start Main.sleep() &lt;&lt;&lt;"</span>);</span><br><span class="line">            Main.sleep();</span><br><span class="line">            System.out.println(<span class="string">"&gt;&gt;&gt; end MAin.sleep() &lt;&lt;&lt;"</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.fangfeng.client;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Rand.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/8/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">double</span> rand = Math.random();</span><br><span class="line">            <span class="keyword">if</span> (rand &gt; <span class="number">0.995</span>) &#123;</span><br><span class="line">                System.out.println(String.format(<span class="string">"get random, values %f"</span>, rand));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæ¥æ„é€ ä¸€ä¸ªä»£ç†ç±»ï¼Œä»¥åŠæœ€é‡è¦çš„ <code>premain</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.fangfeng.javaagent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Agent - ä»£ç†</span></span><br><span class="line"><span class="comment"> * åŸºäº JVM TI (JVM Tool Interface) å®ç°çš„ Java ClassFile çš„å¢å¼º</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/8/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Agent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// premain å°† JVM åˆå§‹åŒ–åï¼Œmain(String... ) æ‰§è¡Œå‰è°ƒç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String args, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// new ä¸€ä¸ªè½¬æ¢å™¨å®ä¾‹</span></span><br><span class="line">        ClassTimer transformer = <span class="keyword">new</span> ClassTimer();</span><br><span class="line">        instrumentation.addTransformer(transformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹‹åçš„ agentmain(...) å°†åœ¨è¿™é‡Œæä¾›ï¼Œæš‚æ—¶éšå»ï¼Œé¿å…å¯¹å¯¹è¯»è€…äº§ç”Ÿå¹²æ‰°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.fangfeng.javaagent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/8/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassTimer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ¶‰åŠåˆ°äº† ASM çš„å†…å®¹ï¼Œä¸»è¦ç›®çš„æ˜¯å‘æ¯ä¸ªæ–¹æ³•å—çš„å¼€å§‹åŠæ–¹æ³•å—çš„ç»“æŸéƒ¨åˆ†æ’å…¥ä¸è®¡æ—¶å™¨æœ‰å…³çš„ä»£ç </span></span><br><span class="line">        <span class="comment">// å¦‚æœæƒ³äº†è§£ ASM çš„å†…å®¹ï¼Œè¯·å‚é˜… https://dormouse-none.github.io/2018-06-25-ASM-Core/  æä¾›äº†ä¸€äº›åŸºç¡€æ€§çš„å†…å®¹ï¼Œæ›´å¤šçš„è¯·è‡ªè¡Œå­¦ä¹ </span></span><br><span class="line">        <span class="comment">// ä¸äº†è§£å…·ä½“å†…å®¹å°†ä¸å½±å“å¯¹ä¸»ä½“å†…å®¹çš„ç†è§£</span></span><br><span class="line">        ClassReader cr = <span class="keyword">new</span> ClassReader(classfileBuffer);</span><br><span class="line">        ClassWriter cw = <span class="keyword">new</span> ClassWriter(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line">        MyClassWriter mcw = <span class="keyword">new</span> MyClassWriter(Opcodes.ASM6, cw);</span><br><span class="line">        cr.accept(mcw, ClassReader.EXPAND_FRAMES);</span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ƒä»£ç ç•¥ï¼Œè¯¦è§é™„ä»¶ã€‚</p><p>Java è¿™ç§å¯¹æ“ä½œå­—èŠ‚ç çš„æ”¯æŒæœ‰ä¸ªå‘çˆ¹çš„åœ°æ–¹ï¼Œå°±æ˜¯ä¸å¾—ä¸æ‰“åŒ…æˆ Jar æ¥ä½¿ç”¨ã€‚</p><p>å…·ä½“æ¥çœ‹ä¸€ä¸‹</p><p><code>me.fangfeng.javaagent</code> åŒ…ä¸­åŒ…æ‹¬ </p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fublsbbdw0j309o07g74u.jpg" alt=""></p><p>å°†è¢«æ‰“åŒ…æˆ <code>agent.jar</code> æ¥ä½¿ç”¨</p><p>é¦–å…ˆï¼Œæ¥çœ‹ä¸€ä¸‹éœ€è¦æ‰“åŒ…åœ¨ <code>agent.jar</code> çš„ <strong>MANIFEST.MF</strong> çš„å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Class-Path: /Users/fangfeng/.m2/repository/org/ow2/asm/asm/6.1.1/asm-6.1.1.jar</span><br><span class="line">Premain-Class: me.fangfeng.javaagent.Agent</span><br><span class="line">Can-Retransform-Classes: true</span><br></pre></td></tr></table></figure><p>å†æ¥ä¸ª SHELL è„šæœ¬ï¼Œç”¨æ¥ç»™æ‰“åŒ…è¿™ä¸ª Jar</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ me.fangfeng.javaagent åŒ…ä¸‹çš„ç±»</span></span><br><span class="line">javac -cp .:/Users/fangfeng/.m2/repository/org/ow2/asm/asm/6.1.1/asm-6.1.1.jar me/fangfeng/javaagent/Agent.java me/fangfeng/javaagent/ClassTimer.java me/fangfeng/javaagent/MyClassWriter.java me/fangfeng/javaagent/MyMethodWriter.java me/fangfeng/javaagent/StaticTimer.java</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“åŒ… me.fangfeng.javaagent çš„ .class -&gt; agent.jar</span></span><br><span class="line">jar cvfm agent.jar MANIFEST-agent.MF me/fangfeng/javaagent/Agent.class me/fangfeng/javaagent/ClassTimer.class me/fangfeng/javaagent/MyClassWriter.class me/fangfeng/javaagent/MyMethodWriter.class me/fangfeng/javaagent/StaticTimer.class</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ me.fangfeng.client åŒ…ä¸‹çš„ç±»</span></span><br><span class="line">javac me/fangfeng/client/Main.java me/fangfeng/client/Rand.java</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ me.fangfeng.client.Main ä½œä¸ºä¸»ç±»å¯åŠ¨</span></span><br><span class="line">java -javaagent:agent.jar me.fangfeng.client.Main</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹å†…å®¹:</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fubmp354ejj30tq0rmtdp.jpg" alt=""></p><p>è€Œç›´æ¥ç”¨ <code>java me.fangfeng.client.Main</code> çš„æ‰§è¡Œç»“æœæ˜¯:</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fubmqmj4uhj30j00f0dho.jpg" alt=""></p><p>ä»ç†è®ºä¸Šæ¥è®²ï¼Œ<code>-javaagent:agent.jar</code> é…åˆ <code>agent.jar</code> ä¸­çš„ MANIFEST.MF æ–‡ä»¶ï¼Œ<br>ä½¿å¾— JVM åœ¨åˆå§‹åŒ–ä¹‹åè§¦å‘äº†è¢«å£°æ˜ä¸º <code>Pre-Main</code> çš„ me.fangfeng.javaagent.Agent ç±»çš„ premain(â€¦) æ–¹æ³•ã€‚</p><p>å¹¶ä¸º ClassLoader åœ¨åŠ è½½ç±»çš„æµç¨‹ä¸Šå¢åŠ äº†ä¸€å±‚<strong>æ‹¦æˆªå™¨</strong> (è¿™é‡Œæ˜¯ ClassTimer.java ç±»ï¼Œå®ƒå®ç°äº† <code>ClassFileTransformer</code> æ¥å£</p><p>å¦å¤–ï¼Œ<code>Can-Retransform-Classes: true</code> çš„é…ç½®ä½¿å¾— ClassTimer è¢«å…è®¸å¯¹å­—èŠ‚ç è¿›è¡Œé‡æ–°è½¬æ¢ã€‚(è€Œæ“ä½œå­—èŠ‚ç æ˜¯é€šè¿‡ ASM æ¥å®ç°çš„)</p><h3 id="åœ¨è¿è¡Œä¸­è¿›è¡Œå¢å¼º"><a href="#åœ¨è¿è¡Œä¸­è¿›è¡Œå¢å¼º" class="headerlink" title="åœ¨è¿è¡Œä¸­è¿›è¡Œå¢å¼º"></a>åœ¨è¿è¡Œä¸­è¿›è¡Œå¢å¼º</h3><p>éšç€ç¨‹åºå¯åŠ¨æ—¶ç›´æ¥ä½¿ç”¨äº† <code>-javaagent</code> é€‰é¡¹ã€‚</p><p>é‚£ä¹ˆæ˜¯å¦å­˜åœ¨åœ¨ç¨‹åºè¿è¡Œä¸­è¿›è¡Œé¢å¤–ä»£ç†æ“ä½œçš„æ”¯æŒå‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ã€‚è¿™é‡Œè¦å€ŸåŠ© Java æä¾›çš„å¦ä¸€ä¸ªç±» com.sun.tools.attach.VirtualMachine ã€‚</p><p>å¯åŠ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥è¿æ¥åˆ° æ­£åœ¨è¿è¡Œä¸­çš„è¿›ç¨‹ï¼Œå¹¶ä»¤å…¶åŠ è½½ java agentã€‚</p><p>åŸºæœ¬çš„ç±»ä¸ä¸Šä¸€èŠ‚çš„æè¿°ç›¸åŒï¼Œä¸»è¦æ˜¯åŒ… <code>me.fangfeng.javaagent.*</code> å’Œ <code>me.fangfeng.client.*</code></p><p>æ–°å¢ä¸€ä¸ªç±» <code>me.fangfeng.javaagent.Main</code> ç”¨æ¥å¯åŠ¨å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶è¦æ±‚è¿è¡Œä¸­çš„ java è¿›ç¨‹åŠ è½½ agent.jar æ¥è¿›è¡Œå¢å¼ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.fangfeng.javaagent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AgentInitializationException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AgentLoadException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AttachNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fangfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/8/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException </span>&#123;</span><br><span class="line">        VirtualMachine vm = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡ VirtualMachine è¿æ¥åˆ° è¿è¡Œä¸­çš„è¿›ç¨‹ (å¯ä»¥é€šè¿‡ jps æ‰¾åˆ°è¿›ç¨‹å·)</span></span><br><span class="line">            vm = VirtualMachine.attach(&lt;PID&gt;);</span><br><span class="line">            vm.loadAgent(&lt;agent.jar çš„è·¯å¾„&gt;);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (vm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                vm.detach();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Agent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String args, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        ClassTimer transformer = <span class="keyword">new</span> ClassTimer();</span><br><span class="line">        instrumentation.addTransformer(transformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç°åœ¨åœ¨ Agent.java ä¸Šè¡¥ä¸Š agentmain(...) çš„å…·ä½“å®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String args, Instrumentation instrumentation)</span> <span class="keyword">throws</span> UnmodifiableClassException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SUCCESS AGENTMAIN"</span>);</span><br><span class="line">        ClassTimer transformer = <span class="keyword">new</span> ClassTimer();</span><br><span class="line">        <span class="comment">// add Transformer</span></span><br><span class="line">        instrumentation.addTransformer(transformer, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// å¯¹ Rand.class è¿›è¡Œé‡æ–°è½¬æ¢</span></span><br><span class="line">        instrumentation.retransformClasses(Rand.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ƒå†…å®¹åŸºæœ¬ç›¸åŒ</p><p>é¦–å…ˆéœ€è¦å…ˆæ‰“åŒ… agent.jar ã€‚å½“ç„¶ï¼Œå¦‚æœæ˜¯é¡ºç€æœ¬æ–‡çš„é¡ºåºè¿›è¡Œæœ¬æœºå®éªŒï¼Œåˆ™ agent.jar å·²ç»å­˜åœ¨</p><p>å…ˆå¯åŠ¨è¿›ç¨‹ <code>java me.fangfeng.client.Main</code></p><p>é€šè¿‡ <code>jps</code> è·å– Main è¿›ç¨‹çš„ <strong>PID</strong></p><p>åœ¨ <code>java me.fangfeng.javaagent.Main</code> ä¸­æ›¿æ¢ä¸Šè¿›ç¨‹å·ï¼Œå¹¶æ‰§è¡Œ</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fuboclcelsj30tu152dlw.jpg" alt=""></p><p>ä»æ‰§è¡Œç»“æœå¯ä»¥çœ‹åˆ°ï¼ŒåŸè¿›ç¨‹é¦–å…ˆæ­£å¸¸æ‰§è¡Œä»£ç ï¼Œç­‰åˆ°è¢« load Agent ä¹‹åï¼Œå­—èŠ‚ç å·²ç»æœ‰äº†æ–°çš„å˜åŒ–ï¼Œä»è€Œå¯¼è‡´è¾“å‡ºç»“æœåŠ¨æ€çš„äº§ç”Ÿäº†å˜åŒ–ã€‚</p><p><em>å½“ç„¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡Œä¸­çš„è¿›ç¨‹è¢«è¦æ±‚ load Agent ä¹‹åï¼Œè¿è¡Œä¸­çš„ Class å°†è¢«æ”¹å†™ï¼Œå¹¶å§‹ç»ˆå¦‚æ­¤ï¼ŒçŸ¥é“è¿›ç¨‹ç»ˆæ­¢ã€‚å†ä¸‹ä¸€æ¬¡é‡æ–°å¯åŠ¨</em></p><h2 id="BTrace"><a href="#BTrace" class="headerlink" title="BTrace"></a>BTrace</h2><p>ä»¥ä¸Šæè¿°çš„å†…å®¹ä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯ BTrace å®ç°çš„åŸºç¡€ã€‚æ¯•ç«Ÿï¼ŒJVMTI (JVM Tool Interface) åŸæœ¬çš„ç›®çš„å°±æ˜¯èµ‹äºˆä½¿ç”¨è€…ä¸€ä¸ªåœ¨è¿è¡Œä¸­<br>æŸ¥è¯¢ç³»ç»Ÿå„é¡¹æ•°æ®çš„æƒåˆ©</p><p>å½“ç„¶ï¼Œå®ç°ä¸Šï¼Œä¸Šè¿°ä»£ç ç›´æ¥å°†å„ç§å¢å¼º(è®¡æ—¶)ç¡¬ç¼–ç åˆ°è¯¥è¿›ç¨‹ä¸­ï¼ŒåŒæ—¶ç»Ÿä¸€ä½¿ç”¨äº†è¯¥è¿›ç¨‹çš„è¾“å…¥è¾“å‡ºã€‚</p><p>ä½†æ˜¯ï¼ŒBTrace é€šè¿‡ Socket å°†è¿™äº›åˆ†ç¦»ï¼Œæ£€æµ‹ä»£ç é€šè¿‡ Socket å‘å›æ–°çš„è¿›ç¨‹æ¥ç»´æŒè¾“å…¥è¾“å‡ºã€‚</p><p>åœ¨æ­¤ï¼Œä¸å†ç»†è¯´ã€‚</p><h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><p>[1]. ç¤ºä¾‹ä»£ç : <a href="https://github.com/DorMOUSE-None/Repo/raw/master/instru.zip" target="_blank" rel="noopener">instru.zip</a><br>[2]. <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/Instrumentation.html" target="_blank" rel="noopener">java.lang.instrument.Instrumentation</a><br>[3]. <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html" target="_blank" rel="noopener">Package java.lang.instrument</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Start&quot;&gt;&lt;a href=&quot;#Start&quot; class=&quot;headerlink&quot; title=&quot;Start&quot;&gt;&lt;/a&gt;Start&lt;/h2&gt;&lt;p&gt;ä»ç°æœ‰çš„å‰ç½®çŸ¥è¯†æ¥è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¤è¯†åˆ°ä¸¤ä¸ªäº‹å®:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Java Class é€šè¿‡ ClassLoader è¿›è¡ŒåŠ è½½ã€‚&lt;br&gt;é€šè¿‡&lt;code&gt;å…¨é™å®šå&lt;/code&gt;è¿›è¡ŒåŒºåˆ†ã€‚å½“éœ€è¦åŠ è½½æ–°çš„ç±»æ—¶ï¼ŒClassLoader é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™ä¸ªç±»ã€‚&lt;br&gt;æ¢å¥è¯è¯´: Class ä¸€ç»åŠ è½½ï¼Œå°±ä¸ä¼šå°è¯•é‡å¤åŠ è½½ (è‡³å°‘æŒ‰ç»å¤§å¤šæ•°äººçš„è®¤çŸ¥æ¥è¯´ï¼Œç¡®å®æ˜¯çš„)&lt;/li&gt;
&lt;li&gt;æœ‰æ²¡æœ‰å¯èƒ½è®©è¢«åŠ è½½çš„ Class ä¸ç‰©ç†å­˜å‚¨ä¸Šçš„ .class å†…å®¹ä¸åŒã€‚&lt;br&gt;å½“ç„¶ä¹Ÿæ˜¯å®Œå…¨å¯ä»¥åšåˆ°çš„ã€‚ä¸ç®¡æ€ä¹ˆè¯´ï¼ŒCGlib å’Œ Java Proxy ä¹Ÿæ˜¯ä¸€ä¸ªè€³ç†Ÿèƒ½è¯¦çš„æ¦‚å¿µå§&lt;br&gt;(è™½ç„¶å¯èƒ½ä¸äº†è§£ç»†èŠ‚ã€‚åœ¨æ­¤ï¼Œæ¬¢è¿å­¦ä¹ å‰ç½®æŠ€èƒ½ &lt;a href=&quot;https://dormouse-none.github.io/2018-07-10-CGlib-Enhancer/&quot;&gt;CGlib Enhancer ä¸»æµç¨‹æºç è§£æ&lt;/a&gt; å’Œ &lt;a href=&quot;https://dormouse-none.github.io/2018-07-20-Java-Proxy/&quot;&gt;Java Proxy æºç è§£æ&lt;/a&gt;ã€‚ä¸è¿‡ä¸å½±å“æœ¬æ–‡åç»­å†…å®¹)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦ä¸€ä¸ªæ–¹é¢ï¼Œä¹Ÿè®¸ç»å¤§å¤šæ•°äººéƒ½å¬è¯´è¿‡æ‰€è°“çš„&lt;code&gt;çƒ­éƒ¨ç½²&lt;/code&gt;ã€‚ä½†æ˜¯ç©¶ç«Ÿæ€ä¹ˆæ‰èƒ½åšåˆ° &lt;code&gt;çƒ­éƒ¨ç½²&lt;/code&gt;(è¯é¢˜å¼€å¾—æœ‰ç‚¹å¤§å“ˆã€‚Y_Y æœ¬æ–‡ä¸è®²è¿™ä¸ª)&lt;/p&gt;
&lt;p&gt;æ“ä½œå­—èŠ‚ç ä¸€å®šæ˜¯ä¸€ä¸ªé€ƒä¸å¼€çš„è¯é¢˜ï¼Œæ¯•ç«Ÿ Class å°±æ˜¯æ‰€è°“çš„è¢«åŠ è½½åˆ°å†…å­˜çš„å­—èŠ‚ç å˜›ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä½•æ“ä½œå­—èŠ‚ç ? ASM, CGlib, Java Proxy, Javassist ? ä¸è¿‡è¿™äº›éƒ½è¦ç­‰åˆ°éœ€è¦è¢«æ“ä½œçš„ç±»è¢«åŠ è½½äº†æ‰è¡Œå•Šï¼Œä¼¼ä¹æœ‰ç‚¹æ™šâ€¦&lt;/p&gt;
&lt;p&gt;Java æä¾›äº†ä¸€ä¸ªå¯è¡Œçš„æœºåˆ¶ï¼Œç”¨æ¥åœ¨ ClassLoader åŠ è½½å­—èŠ‚ç ä¹‹å‰å®Œæˆå¯¹æ“ä½œå­—èŠ‚ç çš„ç›®çš„&lt;/p&gt;
&lt;h2 id=&quot;Instrumentation&quot;&gt;&lt;a href=&quot;#Instrumentation&quot; class=&quot;headerlink&quot; title=&quot;Instrumentation&quot;&gt;&lt;/a&gt;Instrumentation&lt;/h2&gt;&lt;p&gt;&lt;code&gt;java.lang.instrument.Instrumentation&lt;/code&gt; ç±»ä¸ºæä¾›ç›´æ¥æ“ä½œ Java å­—èŠ‚ç çš„åˆä¸€ä¸ªé€”å¾„(è™½ç„¶ Java Doc çš„è¯´æ˜æ˜¯ç”¨æ¥æ£€æµ‹ Java ä»£ç çš„)&lt;/p&gt;
&lt;p&gt;ç›¸ä¿¡æˆ‘è¿™ä¸ªè¯´æ˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚æ¯•ç«Ÿå®Œæˆå¯¹ä»£ç æ£€æµ‹çš„é€”å¾„æ˜¯ç›´æ¥ä¿®æ”¹å­—èŠ‚ç ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹åˆ—æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è¾¾åˆ°ç›®çš„&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å½“ JVM ä»¥æŒ‡ç¤ºä¸€ä¸ªä»£ç†ç±»çš„æ–¹å¼å¯åŠ¨æ—¶ï¼Œå°†ä¼ é€’ç»™ä»£ç†ç±»çš„ premain æ–¹æ³•ä¸€ä¸ª Instrumentation å®ä¾‹ã€‚&lt;/li&gt;
&lt;li&gt;å½“ JVM æä¾›æŸç§æœºåˆ¶åœ¨ JVM å¯åŠ¨ä¹‹åæŸä¸€æ—¶åˆ»å¯åŠ¨ä»£ç†æ—¶ï¼Œå°†ä¼ é€’ç»™ä»£ç†ä»£ç çš„ agentmain æ–¹æ³•ä¸€ä¸ª Instrumentation å®ä¾‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¯ä¸å¤šè¯´ï¼Œä¸‹é¢å°†å…¨éƒ¨ä»¥å®ä¾‹æ¥å±•ç°å¯¹è¿™ç§ JVM æ£€æµ‹æœºåˆ¶(è™½ç„¶ä¾‹å­å·²ç»è„±ç¦»äº†&lt;em&gt;æ£€æµ‹&lt;/em&gt;çš„ç›®çš„)çš„ä½¿ç”¨&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="https://DorMOUSE-None.github.io/tags/Java/"/>
    
      <category term="ASM" scheme="https://DorMOUSE-None.github.io/tags/ASM/"/>
    
      <category term="BTrace" scheme="https://DorMOUSE-None.github.io/tags/BTrace/"/>
    
  </entry>
  
  <entry>
    <title>JVM æŒ‡ä»¤ç®€æ</title>
    <link href="https://DorMOUSE-None.github.io/2018-07-24-JVM-Instruction/"/>
    <id>https://DorMOUSE-None.github.io/2018-07-24-JVM-Instruction/</id>
    <published>2018-07-23T16:00:00.000Z</published>
    <updated>2018-07-24T01:08:24.556Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¹‹å‰æè¿°è¿‡åŒ…æ‹¬ ASM, CGlib, Java Proxy çš„åŸºæœ¬å†…å®¹ä¹‹åï¼Œæœ¬æ–‡å°†å°±æ›´ä¸ºåŸºç¡€çš„ JVM æŒ‡ä»¤é›†è¿›è¡Œç®€å•è€Œæœ‰æ•ˆçš„ä»‹ç»ã€‚</p><p>å½“ç„¶ï¼Œåœ¨å¼€å§‹æ­£æ–‡å‰ï¼Œè¯»è€…éœ€è¦äº†è§£åˆ°ï¼ŒJVM æŒ‡ä»¤é›†è¿™ç§ç±»ä¼¼äºæ±‡ç¼–çš„è§„èŒƒæ€§å†…å®¹ï¼ŒåŒ…å«ä¸€ç™¾å¤šä¸ªæŒ‡ä»¤ï¼Œè‹¥è¦æ±‚ä¸€ä¸€ä»‹ç»ã€‚<br>é‚£ä¹ˆï¼Œç›´æ¥é˜…è¯» <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> ç»å¯¹æ˜¯æ¯”æœ¬æ–‡çš„å†…å®¹æ›´ä¸ºè¯¦å®ä¸”å‡†ç¡®ã€‚</p><p>è¿™ç¯‡æ–‡æ¡£çš„ç›®çš„ï¼Œåªæ˜¯ä¸ºäº†ä½¿è¯»è€…å»ºç«‹èµ·å…³äº JVM æŒ‡ä»¤é›†åŸºæœ¬çš„å¸¸è¯†æ€§è§‚å¿µã€‚</p><a id="more"></a><h2 id="æœ¯è¯­çº¦å®š"><a href="#æœ¯è¯­çº¦å®š" class="headerlink" title="æœ¯è¯­çº¦å®š"></a>æœ¯è¯­çº¦å®š</h2><p>é¦–å…ˆï¼Œéœ€è¦å°± <code>æœ¯è¯­</code> è¿›è¡Œä¸€äº›åŸºç¡€æ€§çš„çº¦å®š:</p><h3 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h3><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1ftidi0xpmij30oa07kaaq.jpg" alt="å˜é‡"></p><ul><li><code>å˜é‡</code>: åœ¨ç±»ä¸­ï¼ŒåŒºåˆ†äº <code>æ–¹æ³•</code> çš„å£°æ˜<ul><li><code>æˆå‘˜å˜é‡</code>: ä½œç”¨åŸŸä¸ºæ•´ä¸ªç±»ï¼Œåœ¨æ–¹æ³•ä½“ä¸è¯­å¥å—ä¹‹å¤–å£°æ˜çš„å†…å®¹ã€‚åœ¨ <code>å­—èŠ‚ç </code> ä¸­é€šå¸¸è¢«ç§°ä¸º <code>å­—æ®µ(Field)</code><ul><li><code>ç±»æˆå‘˜å˜é‡ / é™æ€æˆå‘˜å˜é‡</code>: è¢« <code>static</code> ä¿®é¥°çš„ <code>æˆå‘˜å˜é‡</code>ã€‚ä¸€ä¸ªç±»åªæœ‰ä¸€ä»½ï¼Œåœ¨ç±»è¢«åŠ è½½çš„æ—¶å€™å³åˆå§‹åŒ–ã€‚</li><li><code>å®ä¾‹æˆå‘˜å˜é‡</code>: é <code>static</code> ä¿®é¥°çš„ <code>æˆå‘˜å˜é‡</code>ã€‚éšç€ç±»è¢«å®ä¾‹åŒ–è€Œè¿›è¡Œåˆå§‹åŒ–ï¼Œæ¯ä¸ªå®ä¾‹å¯¹è±¡éƒ½æœ‰ä¸€ä»½ç‰¹æœ‰çš„ <code>å®ä¾‹å˜é‡</code>ã€‚</li></ul></li><li><code>å±€éƒ¨å˜é‡</code>: ä½œç”¨åŸŸä¸ºæ–¹æ³•ä½“æˆ–è€…è¯­å¥å—ã€‚</li></ul></li></ul><h3 id="JVM-æŒ‡ä»¤"><a href="#JVM-æŒ‡ä»¤" class="headerlink" title="JVM æŒ‡ä»¤"></a>JVM æŒ‡ä»¤</h3><p>é€šå¸¸ï¼Œæˆ‘ä»¬å€ŸåŠ©äº <code>javap</code> å‘½ä»¤æ¥å¯¹ .class æ–‡ä»¶çš„å­—èŠ‚ç å†…å®¹è¿›è¡ŒæŸ¥é˜…ã€‚</p><p>ç±»ä¼¼äºæ±‡ç¼–ä»£ç ï¼Œ<code>javap</code> æ‰“å°çš„JVM æŒ‡ä»¤å°†ä»¥ä¸‹åˆ—æ ¼å¼è¿›è¡Œå±•ç¤º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;index&gt; &lt;opcode&gt; [&lt;operand1&gt; [&lt;operand2&gt; ...]] [&lt;comment&gt;]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ </p><ul><li><code>&lt;index&gt;</code> æŒ‡åœ¨ <code>code[]</code> å±æ€§ä¸­è¿™æ¡æŒ‡ä»¤çš„åç§»é‡(ä» 0 å¼€å§‹è®¡æ•°)ã€‚</li><li><code>&lt;opcode&gt;</code> æŒ‡ <code>æ“ä½œç </code></li><li><code>&lt;operandX&gt;</code> æŒ‡ <code>æ“ä½œæ•°</code>ï¼Œæ¯ä¸ª <code>&lt;opcode&gt;</code> éƒ½éœ€è¦ç¡®å®šæ•°é‡çš„æ“ä½œæ•°(è§„èŒƒä¸­å·²ç»ç¡®å®š)ã€‚</li><li><code>&lt;comment&gt;</code> æŒ‡æ³¨é‡Š</li></ul><h2 id="æŒ‡ä»¤é›†æ¦‚è§ˆ"><a href="#æŒ‡ä»¤é›†æ¦‚è§ˆ" class="headerlink" title="æŒ‡ä»¤é›†æ¦‚è§ˆ"></a>æŒ‡ä»¤é›†æ¦‚è§ˆ</h2><p>é¦–å…ˆï¼ŒJava ä»£ç ç»ç¼–è¯‘åçš„æ‰€æœ‰æŒ‡ä»¤éƒ½åŸºäº <code>æ–¹æ³•(Method)</code> è¢«å®šä¹‰åœ¨ <code>Code</code> å±æ€§ä¸­ã€‚</p><p>åœ¨ <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7.3" target="_blank" rel="noopener">ClassFile</a> çš„ <code>Code</code> å±æ€§ï¼Œç»“æ„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    <span class="comment">// å…¶ä¸­ u1, u2, u4 åˆ†åˆ«è¡¨ç¤ºè¿™ä¸ªå˜é‡æ‰€å çš„å­—èŠ‚é•¿åº¦</span></span><br><span class="line">    u2 attribute_name_index;                    <span class="comment">// å±æ€§ååœ¨å¸¸é‡æ± ä¸­çš„ index (æ‰§è¡Œå¸¸é‡æ± ä¸­ Code çš„ä½ç½®)</span></span><br><span class="line">    u4 attribute_length;                        <span class="comment">// å±æ€§é•¿åº¦ï¼Œä¸åŒ…æ‹¬å¼€å§‹çš„å…­ä¸ªå­—èŠ‚</span></span><br><span class="line">    u2 max_stack;                               <span class="comment">// è¿è¡Œæ—¶æ“ä½œæ•°æ ˆçš„æœ€å¤§æ·±åº¦</span></span><br><span class="line">    u2 max_locals;                              <span class="comment">// è¿è¡Œæ—¶æ‰€éœ€çš„å±€éƒ¨å˜é‡è¡¨çš„å¤§å°</span></span><br><span class="line">    u4 code_length;                             <span class="comment">// code æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    u1 code[code_length];                       <span class="comment">// code æ•°ç»„ï¼Œç¼–è¯‘åæ–¹æ³•ä½“çš„å†…å®¹éƒ½é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤å­˜å‚¨åœ¨è¿™é‡Œ</span></span><br><span class="line">    u2 exception_table_length;                  <span class="comment">// å¼‚å¸¸è¡¨çš„é•¿åº¦</span></span><br><span class="line">    &#123;   u2 start_pc;</span><br><span class="line">        u2 end_pc;</span><br><span class="line">        u2 handler_pc;</span><br><span class="line">        u2 catch_type;</span><br><span class="line">    &#125; exception_table[exception_table_length]; <span class="comment">// å¼‚å¸¸è¡¨ï¼ŒJava ä»£ç ä¸­æ‰€æœ‰çš„ catch, finally çš„æ•è·éƒ½å°†ç”±æ­¤è¡¨è¿›è¡Œå®ç°</span></span><br><span class="line">    u2 attributes_count;                       <span class="comment">// å±æ€§è®¡æ•°</span></span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Java è™šæ‹Ÿæœºçš„æŒ‡ä»¤æ˜¯ç”±ä¸€ä¸ªå­—èŠ‚é•¿åº¦çš„ <code>æ“ä½œç </code> é…åˆä¸Šå…¶åçš„ 0 ä¸ªæˆ–å¤šä¸ª <code>æ“ä½œæ•°</code> æ‰€æ„æˆçš„ã€‚</p><p>å…¶ä¸­ï¼Œ<code>æ“ä½œæ•°</code> çš„æ•°é‡å–å†³äº <code>æ“ä½œç </code>ï¼Œä¸åŒçš„ <code>æ“ä½œç </code> éœ€è¦ä¸åŒæ•°é‡çš„ <code>æ“ä½œæ•°</code>ã€‚</p><p>æŒ‰ç…§ç±»å‹åˆ’åˆ†ï¼Œ<code>æ“ä½œæ•°</code> ä¸»è¦åŒ…æ‹¬ä¸‹åˆ—å‡ ç±»:</p><ul><li>åŠ è½½ä¸å­˜å‚¨æŒ‡ä»¤ï¼Œä¾‹å¦‚ iload, istore ç­‰</li><li>è¿ç®—æŒ‡ä»¤ï¼Œä¾‹å¦‚ iadd, isub, imul ç­‰</li><li>ç±»å‹è½¬æ¢æŒ‡ä»¤ï¼Œä¾‹å¦‚ i2b, i2s ç­‰</li><li>å¯¹è±¡åˆ›å»ºä¸æ“ä½œæŒ‡ä»¤ï¼Œä¾‹å¦‚ new, newarray ç­‰</li><li>æ“ä½œæ•°æ ˆç®¡ç†æŒ‡ä»¤ï¼Œä¾‹å¦‚ dup, pop ç­‰</li><li>æ§åˆ¶è½¬ç§»æŒ‡ä»¤ï¼Œä¾‹å¦‚ if_icmpeq ç­‰</li><li>æ–¹æ³•è°ƒç”¨ä¸è¿”å›æŒ‡ä»¤ï¼Œä¾‹å¦‚ invokevirtual, invokestatic ç­‰</li><li>æŠ›å‡ºå¼‚å¸¸æŒ‡ä»¤ï¼Œä¾‹å¦‚ athrow ç­‰</li><li>åŒæ­¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ monitorenter ç­‰</li></ul><p><strong>ä¸¾å‡ ä¸ªç®€å•çš„ä¾‹å­:</strong></p><p><code>iadd</code> æŒ‡ä»¤ï¼Œè¡¨ç¤ºå¯¹ä¸¤ä¸ª int æ•°çš„ç›¸åŠ æŒ‡ä»¤ã€‚å°†ä»æ“ä½œæ•°æ ˆé¡¶ä¾æ¬¡å–å‡ºä¸¤ä¸ªæ•°ï¼Œå¹¶ç›¸åŠ ï¼Œå†é‡æ–°å‹å…¥æ“ä½œæ•°æ ˆä¸­ã€‚</p><p><code>bipush 100</code> ï¼Œå…¶ä¸­ <code>bipush</code> æ˜¯æŒ‡ä»¤ï¼Œåéšä¸€ä¸ªæ“ä½œæ•°ï¼Œè¡¨ç¤ºæŠŠ <code>æ“ä½œæ•° 100 è¿™ä¸ª byte ç±»å‹çš„æ•°</code> å‹å…¥æ“ä½œæ•°æ ˆé¡¶</p><h2 id="è¿è¡Œæ—¶æ•°æ®åŒº"><a href="#è¿è¡Œæ—¶æ•°æ®åŒº" class="headerlink" title="è¿è¡Œæ—¶æ•°æ®åŒº"></a>è¿è¡Œæ—¶æ•°æ®åŒº</h2><p>JVM å®šä¹‰äº†è‹¥å¹²ç§è¿è¡ŒæœŸé—´ä¼šä½¿ç”¨åˆ°çš„è¿è¡Œæ—¶æ•°æ®åŒºï¼Œè§ä¸‹å›¾:</p><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ft5osi6it1j31kw0ql78e.jpg" alt="JVM è¿è¡Œæ—¶æ•°æ®åŒº"></p><p>è‡³äºæ¯ä¸€ä¸ªçš„å…·ä½“æ„ä¹‰ï¼Œåœ¨æ­¤ä¸åšè¯¦ç»†å±•å¼€ï¼Œå¯ç”¨å‚è€ƒ:</p><ul><li>ç”±å‘¨å¿—æ˜ç­‰ç¿»è¯‘çš„ ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒ(Java SE 7ç‰ˆ) ã€‹ 2.5èŠ‚å†…å®¹ <a href="http://icyfenix.iteye.com/blog/1256329" target="_blank" rel="noopener">é“¾æ¥</a></li><li><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5" target="_blank" rel="noopener">JVMS 2.5. Run-Time Data Areas</a></li></ul><h2 id="Getter-Setter-çš„æŒ‡ä»¤ä»£ç "><a href="#Getter-Setter-çš„æŒ‡ä»¤ä»£ç " class="headerlink" title="Getter, Setter çš„æŒ‡ä»¤ä»£ç "></a>Getter, Setter çš„æŒ‡ä»¤ä»£ç </h2><p>é¦–å…ˆï¼Œæœ‰å¿…è¦æåŠï¼Œæƒ³è¦å¾—åˆ° .class å¯è§†ä¸”å‹å¥½çš„å±•ç¤ºç»“æœï¼Œå¯ä»¥ä½¿ç”¨ JDK è‡ªå¸¦çš„ <code>javap</code> å‘½ä»¤ã€‚</p><p>æœ¬èŠ‚è¦å±•ç¤ºçš„å†…å®¹æ˜¯å¸¸è§çš„ POJO çš„ get, set æ–¹æ³•çš„æŒ‡ä»¤ä»£ç ã€‚ä½¿ç”¨çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç»è¿‡ <code>javac</code> ç¼–è¯‘ï¼Œ<code>javap</code> è§£æä¹‹åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä¸‹åˆ—å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Classfile /Users/fangfeng/WorkPkg/lab/src/main/java/me/fangfeng/asm/Test.class</span><br><span class="line">  Last modified Jul 23, 2018; size 357 bytes</span><br><span class="line">  MD5 checksum bb1940cc6534d789359295b8dc80233b</span><br><span class="line">  Compiled from &quot;Test.java&quot;</span><br><span class="line">public class me.fangfeng.asm.Test</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #4.#17         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = Fieldref           #3.#18         // me/fangfeng/asm/Test.number:I</span><br><span class="line">   #3 = Class              #19            // me/fangfeng/asm/Test</span><br><span class="line">   #4 = Class              #20            // java/lang/Object</span><br><span class="line">   #5 = Utf8               number</span><br><span class="line">   #6 = Utf8               I</span><br><span class="line">   #7 = Utf8               &lt;init&gt;</span><br><span class="line">   #8 = Utf8               ()V</span><br><span class="line">   #9 = Utf8               Code</span><br><span class="line">  #10 = Utf8               LineNumberTable</span><br><span class="line">  #11 = Utf8               getNumber</span><br><span class="line">  #12 = Utf8               ()I</span><br><span class="line">  #13 = Utf8               setNumber</span><br><span class="line">  #14 = Utf8               (I)V</span><br><span class="line">  #15 = Utf8               SourceFile</span><br><span class="line">  #16 = Utf8               Test.java</span><br><span class="line">  #17 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #18 = NameAndType        #5:#6          // number:I</span><br><span class="line">  #19 = Utf8               me/fangfeng/asm/Test</span><br><span class="line">  #20 = Utf8               java/lang/Object</span><br><span class="line">&#123;</span><br><span class="line">  public me.fangfeng.asm.Test();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 3: 0</span><br><span class="line"></span><br><span class="line">  public int getNumber();</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: getfield      #2                  // Field number:I</span><br><span class="line">         4: ireturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 8: 0</span><br><span class="line"></span><br><span class="line">  public void setNumber(int);</span><br><span class="line">    descriptor: (I)V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=2, args_size=2</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: iload_1</span><br><span class="line">         2: putfield      #2                  // Field number:I</span><br><span class="line">         5: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 12: 0</span><br><span class="line">        line 13: 5</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;Test.java&quot;</span><br></pre></td></tr></table></figure><p>æ‰“å°å‡ºæ¥çš„å†…å®¹åŒ…æ‹¬æœ‰ ç±»çš„å…¨é™å®šåï¼Œè®¿é—®æ§åˆ¶æƒé™ï¼Œçˆ¶ç±»ï¼Œæ¥å£ï¼Œå¸¸é‡æ± ä»¥åŠå„ä¸ªæ–¹æ³•ã€‚</p><p>ä»¥ <code>getNumber</code> ä¸ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public int getNumber();</span><br><span class="line">  descriptor: ()I</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=1, locals=1, args_size=1</span><br><span class="line">       0: aload_0</span><br><span class="line">       1: getfield      #2                  // Field number:I</span><br><span class="line">       4: ireturn</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 8: 0</span><br></pre></td></tr></table></figure><ul><li>descriptor: è¡¨ç¤ºæ–¹æ³•æè¿°ç¬¦ï¼Œå…¶ä¸­ <code>()</code> å†…å®¹è¡¨ç¤ºå…¥å‚ï¼Œ<code>I</code> è¡¨ç¤ºè¿”å›å€¼çš„ç±»å‹</li><li>flags     : è¡¨ç¤ºæ–¹æ³•çš„è®¿é—®æƒé™ï¼Œå½“å‰é™å®šä¸º <code>public</code></li><li>Code      : å­˜å‚¨æœ‰å½“å‰æ–¹æ³•ä½“æŒ‡ä»¤ç çš„ä¸€ç§æ–¹æ³•å†…éƒ¨å±æ€§ã€‚<ul><li>stack : è¡¨ç¤ºå½“å‰æ–¹æ³•(æ„å³åœ¨è¿è¡Œæ—¶æ‰€å¤„çš„æ ˆå¸§ï¼Œæ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½å°†åœ¨ <code>è™šæ‹Ÿæœºæ ˆ</code> ä¸­æ„å»ºä¸€ä¸ªæ–°çš„ <code>æ ˆå¸§</code>) ä½¿ç”¨çš„ <code>æ“ä½œæ•°æ ˆçš„æœ€å¤§æ·±åº¦</code></li><li>locals: è¡¨ç¤ºå½“å‰æ–¹æ³•ä½¿ç”¨çš„ <code>å±€éƒ¨å˜é‡è¡¨</code> çš„å¤§å°</li><li>args_size : è¡¨ç¤ºå˜é‡ä¸ªæ•°</li><li>LineNumberTable : ä¸ Debug æœ‰å…³ï¼ŒæŒ‡å½“å‰çš„çš„æŒ‡ä»¤é›†åœ¨æºæ–‡ä»¶ä¸­çš„ç¬¬å‡ è¡Œå¼€å§‹</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0: aload_0              // ä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½ 0 å·å…ƒç´ åˆ°æ“ä½œæ•°æ ˆä¸­</span><br><span class="line">1: getfield #2          // è·å–å¸¸é‡æ± ä¸­ 2 å·å…ƒç´ (å³ Field number:I) çš„å€¼ï¼Œå¹¶åŠ è½½åˆ°æ“ä½œæ•°æ ˆä¸­</span><br><span class="line">4: ireturn              // æŠ›å‡ºå½“å‰æ“ä½œæ•°æ ˆé¡¶å…ƒç´ ä½œä¸ºè¿”å›å€¼</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤å‰çš„ 0, 1, 4 æŒ‡å½“å‰æŒ‡ä»¤ä½œä¸º <code>Code</code> å±æ€§çš„å†…å®¹çš„åç§»é‡ã€‚</p><p>æ¢ä¸€å¥è¯è¯´ï¼Œ<code>aload_0</code> æ˜¯ Code å±æ€§ code[] çš„ç¬¬ 0 ä¸ªå­—èŠ‚çš„å†…å®¹<br><code>getfield #2</code> çš„æ˜¯ä» code[] çš„ç¬¬ 1 ä¸ªå­—èŠ‚å¼€å§‹çš„ã€‚<br><code>ireturn</code> æ˜¯ä» code[] çš„ç¬¬ 4 ä¸ªå­—èŠ‚å¼€å§‹ã€‚</p><p>è‡³äºä¸ºä»€ä¹ˆæ¯æ¡æŒ‡ä»¤çš„å¼€å§‹ä½ç½®ä¸åŒï¼Œè¿™å–å†³äºæ¯æ¡æŒ‡ä»¤çš„é•¿åº¦ã€‚<code>aload_0</code> æŒ‡ä»¤æœ¬èº«ä¸º 1 å­—èŠ‚çš„é•¿åº¦ï¼Œä¸”ä¸è¦æ±‚é™„å¸¦æ“ä½œæ•°ã€‚<br><code>getfield</code> æŒ‡ä»¤è‡ªé•¿ 1 ä¸ªå­—èŠ‚ï¼Œä½†éœ€è¦ä¸€ä¸ªé•¿åº¦ä¸º 2 å­—èŠ‚çš„å¸¸é‡æ± ç´¢å¼•ã€‚å› æ­¤ <code>ireturn</code> å°†ä»ç¬¬ 4 å­—èŠ‚å¼€å§‹</p><hr><p>åŒæ—¶ï¼Œå¯èƒ½æœ‰äººä¼šæœ‰æ‰€ç–‘é—®ï¼Œ<code>aload_0</code> åŠ è½½çš„ 0 å·å…ƒç´ æ˜¯ä»€ä¹ˆï¼Ÿå®ƒè²Œä¼¼æ²¡æœ‰è¢«ç”¨åˆ°ï¼Ÿ</p><p>é¦–å…ˆï¼Œåœ¨æ¯ä¸ªæ–¹æ³•è¢«è§¦å‘ï¼Œåœ¨æ„å»ºæ–°çš„æ ˆå¸§æ—¶ï¼Œ<code>this</code> å°†è‡ªåŠ¨ä½œä¸º 0 å·å…ƒç´ è¢«å­˜å…¥æ–°æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ä½œä¸º 0 å·å…ƒç´ ã€‚<br>åŒæ—¶ï¼Œå¦‚æœæ–¹æ³•æœ‰å…¥å‚ï¼Œåˆ™å…¥å‚æŒ‰å…¥å‚å£°æ˜é¡ºåºä¾æ¬¡ä½œä¸º 1, 2, 3, â€¦ å…ƒç´ å­˜å…¥ã€‚<br>(å½“ç„¶ï¼Œè¿™é‡Œå­˜åœ¨ç‰¹æ®Šæƒ…å†µï¼Œè¯¸å¦‚ long, double è¿™æ ·é•¿ä¸º 8 å­—èŠ‚çš„å…ƒç´ ï¼Œå°†å ç”¨ 2 ä¸ªå±€éƒ¨å˜é‡è¡¨çš„æ•°ç»„ä¸‹æ ‡ï¼Œè€Œå…¶ä»–å…ƒç´ é¡ºå»¶)ã€‚</p><p>è‡³äºçœ‹ä¼¼ 0 å·å…ƒç´  <code>this</code> å¹¶æ²¡æœ‰è¢«ç”¨åˆ°ã€‚äº‹å®ä¸Šï¼Œå®ƒæ˜¯ä½œä¸º <code>getfield</code> çš„ä¸€ä¸ªé™å®šè¢«ä½¿ç”¨çš„ã€‚<br>è¯•æƒ³ï¼Œ<code>getfield</code> è™½ç„¶é€šè¿‡ <code>#2</code> èƒ½å¤ŸçŸ¥é“éœ€è¦è·å–åˆ°çš„å˜é‡åä¸º <code>number</code> ç±»å‹ä¸º <code>I(å³ int)</code> çš„å…ƒç´ ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå…ƒç´ ç©¶ç«Ÿå±äºå“ªä¸ªå®ä¾‹ï¼Ÿ<br>è€Œæ“ä½œæ•°æ ˆé¡¶çš„ <code>this</code> æ°æ°æ˜¯æŒ‡æ˜ï¼Œéœ€è¦ä½¿ç”¨å½“å‰æ–¹æ³•æ‰€åœ¨çš„ç±»çš„ number å˜é‡ã€‚</p><hr><p>ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>setNumber</code> æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0: aload_0              // ä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½ 0 å·å…ƒç´ åˆ°æ“ä½œæ•°æ ˆä¸­ (ç”¨äºç¡®å®šå­—æ®µæ‰€å±çš„ç±»)</span><br><span class="line">1: iload_1              // ä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½ 1 å·å…ƒç´ åˆ°æ“ä½œæ•°æ ˆä¸­ (ç”¨äºç¡®å®šå°†è¦ç»™å­—æ®µèµ‹çš„å€¼)</span><br><span class="line">2: putfield      #2     // è·å–å¸¸é‡æ± ä¸­ 2 å·å…ƒç´ (å³ Field number:I) çš„åœ°å€ï¼Œå¹¶èµ‹å€¼</span><br><span class="line">5: return               // æ— è¿”å›å€¼çš„ return æŒ‡ä»¤æ¥ç»“æŸå½“å‰æ ˆå¸§çš„æ‰§è¡Œ</span><br></pre></td></tr></table></figure><h2 id="ç»™å˜é‡èµ‹åˆå§‹å€¼"><a href="#ç»™å˜é‡èµ‹åˆå§‹å€¼" class="headerlink" title="ç»™å˜é‡èµ‹åˆå§‹å€¼"></a>ç»™å˜é‡èµ‹åˆå§‹å€¼</h2><p>ç»å¸¸ä¼šè§åˆ°åœ¨æ–¹æ³•ä½“å†…éƒ¨æœ‰ç±»ä¼¼è¿™æ ·çš„å£°æ˜ <code>int score = 100</code> ï¼Œé‚£ä¹ˆè¿™æ ·çš„å†…å®¹ç¿»è¯‘æˆæŒ‡ä»¤ä¼šæ˜¯å¦‚ä½•ï¼Ÿ</p><p>å¯¹äºè¾ƒå°çš„å€¼ï¼Œä¾‹å¦‚ 100ï¼Œå°†é€šè¿‡ <code>bipush 100</code>, <code>istore_1(å‡è®¾ç”¨å±€éƒ¨å˜é‡è¡¨ 1 å·å…ƒç´ å­˜å‚¨ score å˜é‡</code> ç±»ä¼¼çš„å½¢å¼è¿›è¡Œèµ‹å€¼ã€‚<br>ç±»ä¼¼çš„ï¼Œè¿˜æ˜¯ <code>sipush</code> ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯ bipush å¯ä»¥æ”¯æŒ 1 å­—èŠ‚å¤§å°çš„æ•´æ•°ï¼Œsipush æ”¯æŒ 2 å­—èŠ‚å¤§å°çš„æ•´æ•°ã€‚</p><p>ä½†æ˜¯ï¼Œint æœ€å¤§å¯æ˜¯å¯ä»¥åˆ°è¾¾ 4 å­—èŠ‚ï¼Œæ›´ç”šè€…ï¼Œlong å°†è¾¾åˆ° 8 å­—èŠ‚ã€‚</p><p>è¿™æ—¶å€™ï¼Œå°†è¦å€ŸåŠ©çš„å°±æ˜¯ <code>ldc #&lt;index&gt;</code> ç”¨æ¥è¯»å–å¸¸é‡æ± ç¼–å·å°äº 128 çš„å¸¸é‡(ä¾‹å¦‚æ•´æ•°å¸¸é‡ï¼Œæµ®ç‚¹å¸¸é‡ç­‰ç­‰)<br>é‚£ä¹ˆï¼Œè¶…å‡º 128 ç¼–å·çš„ï¼Ÿä½¿ç”¨ <code>ldc_w #&lt;index&gt;</code> è¯»å– 2 å­—èŠ‚å†…å®¹ä½œä¸ºç¼–å·ï¼Œæœ€å¤§ 65535ã€‚å½“ç„¶ï¼Œæ›´å¤§çš„å†…å®¹ï¼Œå¸¸é‡æ± éƒ½ä¸èƒ½æ”¯æŒäº†å“ˆã€‚</p><p>åŒæ—¶ï¼ŒåŒºåˆ«äºå°† byte, short, int, float ç»Ÿä¸€ä½œä¸º 4 å­—èŠ‚ç»“æœè¯»å–ï¼Œå¯¹äº long, double è¿™æ ·çš„å…«å­—èŠ‚å…ƒç´ ï¼Œä½¿ç”¨ <code>ldc2_w</code></p><h2 id="æ§åˆ¶ç»“æ„"><a href="#æ§åˆ¶ç»“æ„" class="headerlink" title="æ§åˆ¶ç»“æ„"></a>æ§åˆ¶ç»“æ„</h2><p>ä½œä¸ºä¸€é—¨å›¾çµå®Œå¤‡çš„è¯­è¨€ï¼Œè‡³å°‘ï¼Œæ§åˆ¶ç»“æ„æ˜¯å¿…ä¸å¯å°‘çš„å…ƒç´ ã€‚</p><p>é‚£ä¹ˆï¼Œç±»ä¼¼ <code>for(int i=0;i&lt;10;i++)</code> çš„ Java ä»£ç ç¼–è¯‘æˆæŒ‡ä»¤åˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0: iconst_0                     // èµ‹å€¼æŒ‡ä»¤ï¼Œå¾€æ“ä½œæ•°æ ˆé¡¶æ·»åŠ æ•´æ•°å€¼ 0</span><br><span class="line">1: istore_1                     // å°†æ“ä½œæ•°æ ˆé¡¶çš„å…ƒç´ å­˜å…¥å±€éƒ¨å˜é‡è¡¨ 1 å·ä½ç½®</span><br><span class="line">2: iload_1                      // ä»å±€éƒ¨å˜é‡è¡¨ 1 å·ä½ç½®åŠ è½½å…ƒç´ åˆ°æ“ä½œæ•°æ ˆ</span><br><span class="line">3: bipush        10             // å¾€æ“ä½œæ•°æ ˆé¡¶å‹å…¥ byte å‹å€¼ 10</span><br><span class="line">5: if_icmpge     21             // å°†æ“ä½œæ•°æ ˆé¡¶çš„ä¸¤ä¸ªå…ƒç´ è¿›è¡Œæ¯”è¾ƒ, å¦‚æœ æ¬¡é¡¶éƒ¨å…ƒç´  &gt;= é¡¶éƒ¨å…ƒç´ ï¼Œåˆ™é‡å®šå‘åˆ°åç§»é‡ä¸º 21 çš„æŒ‡ä»¤</span><br><span class="line">//  for (...) &#123;&#125; è¯­å¥å—çš„å†…å®¹</span><br><span class="line">15: iinc          1, 1          // å°†å±€éƒ¨å˜é‡è¡¨çš„ 1 å·ä½ç½®å…ƒç´  +1</span><br><span class="line">18: goto          2             // è·³è½¬åˆ°åç§»é‡ä¸º 2 çš„æŒ‡ä»¤</span><br><span class="line">21: return                      // è°ƒç”¨æ— è¿”å›å€¼çš„ return</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„ï¼Œ<code>if(...)</code> è¯­å¥çš„æ¯”è¾ƒè¾ƒä¹‹ <code>for(;;)</code> å°±æ›´ä¸ºç®€å•ã€‚ç±»æ¯”åç§»é‡ä¸º 5 çš„æŒ‡ä»¤å³å¯ã€‚</p><h2 id="è°ƒç”¨æ–¹æ³•"><a href="#è°ƒç”¨æ–¹æ³•" class="headerlink" title="è°ƒç”¨æ–¹æ³•"></a>è°ƒç”¨æ–¹æ³•</h2><p>JVM æŒ‡ä»¤é›†ä¸­æ€»è®¡æœ‰ 4 ç§è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤ï¼ŒåŒ…æ‹¬æœ‰: </p><ul><li><code>invokevirtual</code>, å¯¹æ™®é€šå®ä¾‹æ–¹æ³•çš„è°ƒç”¨ï¼Œå°†æ ¹æ®å¯¹è±¡ç±»å‹è¿›è¡Œåˆ†å‘è°ƒç”¨</li><li><code>invokestatic</code>, å¯¹é™æ€æ–¹æ³•çš„è°ƒç”¨</li><li><code>invokespecial</code>, ç”¨äºè°ƒç”¨ç±»çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œä¹Ÿç”¨äºè°ƒç”¨çˆ¶ç±»æ–¹æ³•å’Œç§æœ‰æ–¹æ³•</li><li><code>invokeinterface</code>, ç”¨äºè°ƒç”¨æ¥å£æ–¹æ³•</li></ul><p>ä»¥æ‰§è¡Œ <code>System.out.println()</code> ä¸ºä¾‹<br>å‡è®¾å¸¸é‡æ± å†…å®¹å­˜åœ¨ç›®æ ‡å…ƒç´ (å…·ä½“ä»¥ç›¸åº”æ³¨é‡Šä¸ºå‡†)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">invokevirtual #4                  // Method java/io/PrintStream.println:()V</span><br></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>æ›´å¤šå†…å®¹ï¼ŒåŒ…æ‹¬: å¦‚ä½•å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚ä½•æŠ›å‡ºåŠå¤„ç†å¼‚å¸¸ï¼Œä»£ç åŒæ­¥å£°æ˜ç­‰ï¼Œæš‚ä¸”ä¸è¡¨ã€‚</p><p>æœ‰æ—¶é—´å†åšè¡¥å……</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¹‹å‰æè¿°è¿‡åŒ…æ‹¬ ASM, CGlib, Java Proxy çš„åŸºæœ¬å†…å®¹ä¹‹åï¼Œæœ¬æ–‡å°†å°±æ›´ä¸ºåŸºç¡€çš„ JVM æŒ‡ä»¤é›†è¿›è¡Œç®€å•è€Œæœ‰æ•ˆçš„ä»‹ç»ã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œåœ¨å¼€å§‹æ­£æ–‡å‰ï¼Œè¯»è€…éœ€è¦äº†è§£åˆ°ï¼ŒJVM æŒ‡ä»¤é›†è¿™ç§ç±»ä¼¼äºæ±‡ç¼–çš„è§„èŒƒæ€§å†…å®¹ï¼ŒåŒ…å«ä¸€ç™¾å¤šä¸ªæŒ‡ä»¤ï¼Œè‹¥è¦æ±‚ä¸€ä¸€ä»‹ç»ã€‚&lt;br&gt;é‚£ä¹ˆï¼Œç›´æ¥é˜…è¯» &lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se8/html/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt; ç»å¯¹æ˜¯æ¯”æœ¬æ–‡çš„å†…å®¹æ›´ä¸ºè¯¦å®ä¸”å‡†ç¡®ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡æ–‡æ¡£çš„ç›®çš„ï¼Œåªæ˜¯ä¸ºäº†ä½¿è¯»è€…å»ºç«‹èµ·å…³äº JVM æŒ‡ä»¤é›†åŸºæœ¬çš„å¸¸è¯†æ€§è§‚å¿µã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="JVM" scheme="https://DorMOUSE-None.github.io/tags/JVM/"/>
    
      <category term="Instruction" scheme="https://DorMOUSE-None.github.io/tags/Instruction/"/>
    
  </entry>
  
  <entry>
    <title>Java Proxy æºç è§£æ</title>
    <link href="https://DorMOUSE-None.github.io/2018-07-20-Java-Proxy/"/>
    <id>https://DorMOUSE-None.github.io/2018-07-20-Java-Proxy/</id>
    <published>2018-07-19T16:00:00.000Z</published>
    <updated>2018-07-21T22:38:18.419Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Java æ•´ä¸ªç”Ÿæ€é‡Œé¢, é€šç”¨çš„æœ‰ä¸¤ç±»åŠ¨æ€ä»£ç†çš„åº”ç”¨: Java Proxy ä¸ CGlib ä»£ç†ã€‚</p><p>ä»å®½æ³›çš„åŒºåˆ«æ¥è¯´ï¼ŒJava Proxy åªèƒ½å¯¹æ¥å£è¿›è¡Œå¢å¼ºï¼Œè€Œ CGlib åŒæ—¶é€‚ç”¨äºç±»å’Œæ¥å£çš„å¢å¼ºã€‚<br>è€Œä¸”ï¼Œä¸šå†…æ™®éçš„è®¤çŸ¥æ˜¯ï¼ŒCGlib åŠ¨æ€ä»£ç†è¾ƒä¹‹äº Java Proxy åœ¨ç”Ÿæˆå­—èŠ‚ç çš„é€Ÿåº¦ä¸Šä¹Ÿæ›´ä¸ºé«˜æ•ˆã€‚</p><a id="more"></a><h2 id="ä»å®ä¾‹å¼€å§‹â€¦"><a href="#ä»å®ä¾‹å¼€å§‹â€¦" class="headerlink" title="ä»å®ä¾‹å¼€å§‹â€¦"></a>ä»å®ä¾‹å¼€å§‹â€¦</h2><p>ä¸‹é¢ï¼Œé¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ Java Proxy çš„ä½¿ç”¨ç¼–ç :</p><p>ICodeFactory æ¥å£, ä½œä¸ºå°†è¢« Java åŠ¨æ€ä»£ç†å¢å¼ºçš„åŸºæœ¬æ¥å£<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICodeFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Code <span class="title">getCode</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCode</span><span class="params">(Code code)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>CodeFactory ç±», ä½œä¸º ICodeFactory æ¥å£çš„å®ç°ç±»ã€‚è¢«è§†ä¸ºæ˜¯çœŸæ­£è¢«åŠ¨æ€ä»£ç†å¢å¼ºçš„å†…å®¹ï¼Œ:) å› ä¸ºæ¥å£æ–¹æ³•å¹¶ä¸å­˜åœ¨æ–¹æ³•ä½“(å½“ç„¶ï¼ŒJava 8 åŠä»¥ä¸Šçš„ default è¯·å®¹æˆ‘å¿½è§†)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeFactory</span> <span class="keyword">implements</span> <span class="title">ICodeFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Code code;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Code <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Code();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(Code code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¾…åŠ©ç±» Code çš„å†…å®¹(ç®€å•å†™ï¼Œè¯·å¿½ç•¥ä¸ç¬¦åˆå®é™…ç¼–ç¨‹è§„èŒƒçš„ä¸€äº›å†…å®¹):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Code</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> codeA;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String codeB;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ„å»ºå¢å¼ºçš„ä»£ç é€»è¾‘:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main(String[]) æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…éƒ¨åŒ¿åç±»ï¼Œç”¨äºåŠ¨æ€ä»£ç†ç”Ÿæˆç±»çš„æ„é€ æ–¹æ³•åŠå…¶å®ƒå†…å®¹ï¼Œåé¢è®²ã€‚</span></span><br><span class="line">    InvocationHandler handler = <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line"></span><br><span class="line">        Object obj = <span class="keyword">new</span> CodeFactory();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (method.getName() == <span class="string">"getCode"</span>) &#123;</span><br><span class="line">                Code code = (Code) method.invoke(obj, args);</span><br><span class="line">                code.codeA = code.codeA + <span class="number">100</span>;</span><br><span class="line">                code.codeB = <span class="string">"Proxied: "</span> + code.codeB;</span><br><span class="line">                <span class="keyword">return</span> code;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(obj, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„å»ºç”Ÿæˆç±»å®ä¾‹</span></span><br><span class="line">    Class&lt;?&gt; clazz = Proxy.getProxyClass(ICodeFactory.class.getClassLoader(), ICodeFactory.class);</span><br><span class="line">    <span class="comment">// è·å–ç”Ÿæˆç±»å¯¹è±¡</span></span><br><span class="line">    ICodeFactory factory = (ICodeFactory) clazz.getConstructor(<span class="keyword">new</span> Class[] &#123; InvocationHandler.class &#125;).newInstance(<span class="keyword">new</span> Object[] &#123; handler &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ getCode() æ–¹æ³•</span></span><br><span class="line">    Code code = factory.getCode();</span><br><span class="line">    <span class="comment">// æ‰“å°å‚æ•°</span></span><br><span class="line">    System.out.println(code.codeA);</span><br><span class="line">    System.out.println(code.codeB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»é»˜è®¤é¢„æœŸæ¥è®²ï¼Œæˆ‘ä»¬æ˜¯å¯¹æ¥å£è¿›è¡Œå¢å¼ºã€‚æ¥å£æ–¹æ³•ä¸å­˜åœ¨æ–¹æ³•ä½“ï¼Œä¹Ÿè®¸å°†åœ¨ <code>factory.getCode()</code> æ—¶æ‰§è¡Œå¤±è´¥ï¼Ÿ<br>æˆ–è€…ç»“åˆå·²æœ‰çš„è®¤çŸ¥ï¼ŒæˆåŠŸè°ƒç”¨ <code>CodeFactory.getCode()</code> æ–¹æ³•ï¼Œå¹¶è·å¾— <code>new Code()</code> ã€‚</p><p>é‚£ä¹ˆï¼Œ<code>code.codeA</code> <code>code.codeB</code> çš„å…·ä½“å€¼å°†æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æ‰§è¡Œç»“æœå°†æ˜¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">100</span><br><span class="line">Proxied: null</span><br></pre></td></tr></table></figure><h2 id="äº†è§£-Proxy-çš„å†…å®¹é€»è¾‘"><a href="#äº†è§£-Proxy-çš„å†…å®¹é€»è¾‘" class="headerlink" title="äº†è§£ Proxy çš„å†…å®¹é€»è¾‘"></a>äº†è§£ Proxy çš„å†…å®¹é€»è¾‘</h2><p>ä» <code>Proxy.getProxyClass(ClassLoader, Class&lt;?&gt;...)</code> å…¥æ‰‹ï¼Œä¸‹é¢å°†å±•å¼€å¯¹ <code>Proxy</code> å…·ä½“æ‰§è¡Œé€»è¾‘çš„æ¢ç©¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces) <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">    <span class="comment">// å¯¹ interfaces æ•°ç»„çš„æµ…æ‹·è´</span></span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</span><br><span class="line">    <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœé…ç½®äº†å®‰å…¨ç®¡ç†å™¨ï¼Œé‚£ä¹ˆéœ€è¦ç¡®è®¤ Proxy æœ‰åˆ›å»ºæ–°çš„ä»£ç†ç±»çš„è®¸å¯</span></span><br><span class="line">        checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ </span></span><br><span class="line">    <span class="keyword">return</span> getProxyClass0(loader, intfs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123;</span><br><span class="line">    <span class="comment">// ç¡®è®¤éœ€è¦è¿›è¡Œå¢å¼ºçš„æ¥å£æ•°é‡å°‘äºç­‰äº 65535ï¼Œè¯¦ç»†åŸå› è¯·å»äº†è§£ ClassFile è§„èŒƒ(è§„èŒƒä¸­çš„æ¥å£ä¸Šé™)</span></span><br><span class="line">    <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦ç”±æŒ‡å®š ClassLoader åŠ è½½, å®ç°ç»™å®š interfaces çš„ä»£ç†ç±»å·²ç»å­˜åœ¨, </span></span><br><span class="line">    <span class="comment">// å°†ç›´æ¥è¿”å›å·²ç»ç¼“å­˜è¿‡çš„æ‹·è´</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ï¼Œé€šè¿‡ ProxyClassFactory åˆ›å»ºæ–°çš„ä»£ç†ç±»</span></span><br><span class="line">    <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨éœ€è¦é¢å¤–æ¥è€ƒå¯Ÿä¸€ä¸‹ proxyClassCache çš„å…·ä½“ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</span><br><span class="line">        proxyClassCache = <span class="keyword">new</span> WeakCache&lt;&gt;(<span class="keyword">new</span> KeyFactory(), <span class="keyword">new</span> ProxyClassFactory());</span><br></pre></td></tr></table></figure><p><code>WeakCache</code>, ä»åç§°æ¥å°†ï¼Œæ˜¯ä¸€ä¸ªç¼“å­˜ï¼ŒåŒæ—¶åº”è¯¥ä½¿ç”¨äº† WeakReference æŠ€æœ¯</p><p>è¿›å…¥ <code>WeakCache.get(...)</code> æ–¹æ³•ä½“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key, P parameter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// parameter ä¼ å…¥çš„æ˜¯æ¥å£æ•°ç»„ï¼Œè¦æ±‚ä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    Objects.requireNonNull(parameter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤è¿‡æœŸå…ƒç´ </span></span><br><span class="line">    expungeStaleEntries();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„å»ºä¸€ä¸ª WeakReference å¯¹è±¡(key è¡¨ç¤º ClassLoader)</span></span><br><span class="line">    Object cacheKey = CacheKey.valueOf(key, refQueue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lazily install the 2nd level valuesMap for the particular cacheKey</span></span><br><span class="line">    ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap = map.get(cacheKey);</span><br><span class="line">    <span class="keyword">if</span> (valuesMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap</span><br><span class="line">                = map.putIfAbsent(cacheKey,</span><br><span class="line">                valuesMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;());</span><br><span class="line">        <span class="keyword">if</span> (oldValuesMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            valuesMap = oldValuesMap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ¬¡çº§ Key</span></span><br><span class="line">    <span class="comment">// åŒæ—¶æ£€ç´¢æ˜¯å¦å­˜åœ¨è¿‡å»æœ‰åŒä¸€ä¸ª ClassLoader åŠ è½½çš„è¡¨ç¤º Supplier&lt;V&gt;</span></span><br><span class="line">    Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));</span><br><span class="line">    Supplier&lt;V&gt; supplier = valuesMap.get(subKey);</span><br><span class="line">    Factory factory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (supplier != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// supplier might be a Factory or a CacheValue&lt;V&gt; instance</span></span><br><span class="line">            <span class="comment">// æœ€ç»ˆ supplier å°†éç©ºï¼ŒåŒæ—¶è°ƒç”¨ .get() æ–¹æ³•è·å– Class ç±»</span></span><br><span class="line">            V value = supplier.get();</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// else no supplier in cache</span></span><br><span class="line">        <span class="comment">// or a supplier that returned null (could be a cleared CacheValue</span></span><br><span class="line">        <span class="comment">// or a Factory that wasn't successful in installing the CacheValue)</span></span><br><span class="line">        <span class="comment">// æœªæ‰¾åˆ°è¿‡å»åŠ è½½çš„è®°å½•</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‡’åŠ è½½ä¸€ä¸ª Factory </span></span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            factory = <span class="keyword">new</span> Factory(key, parameter, subKey, valuesMap);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (supplier == <span class="keyword">null</span>) &#123;</span><br><span class="line">            supplier = valuesMap.putIfAbsent(subKey, factory);</span><br><span class="line">            <span class="keyword">if</span> (supplier == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// successfully installed Factory</span></span><br><span class="line">                supplier = factory;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// else retry with winning supplier</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (valuesMap.replace(subKey, supplier, factory)) &#123;</span><br><span class="line">                <span class="comment">// successfully replaced</span></span><br><span class="line">                <span class="comment">// cleared CacheEntry / unsuccessful Factory</span></span><br><span class="line">                <span class="comment">// with our Factory</span></span><br><span class="line">                supplier = factory;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// retry with current supplier</span></span><br><span class="line">                supplier = valuesMap.get(subKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="comment">// serialize access</span></span><br><span class="line">    <span class="comment">// re-check</span></span><br><span class="line">    Supplier&lt;V&gt; supplier = valuesMap.get(subKey);</span><br><span class="line">    <span class="keyword">if</span> (supplier != <span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// something changed while we were waiting:</span></span><br><span class="line">        <span class="comment">// might be that we were replaced by a CacheValue</span></span><br><span class="line">        <span class="comment">// or were removed because of failure -&gt;</span></span><br><span class="line">        <span class="comment">// return null to signal WeakCache.get() to retry</span></span><br><span class="line">        <span class="comment">// the loop</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else still us (supplier == this)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create new value</span></span><br><span class="line">    V value = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è§¦å‘ valueFactory.apply() çœŸæ­£çš„æ„å»º</span></span><br><span class="line">        value = Objects.requireNonNull(valueFactory.apply(key, parameter));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123; <span class="comment">// remove us on failure</span></span><br><span class="line">            valuesMap.remove(subKey, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// the only path to reach here is with non-null value</span></span><br><span class="line">    <span class="keyword">assert</span> value != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wrap value with CacheValue (WeakReference)</span></span><br><span class="line">    CacheValue&lt;V&gt; cacheValue = <span class="keyword">new</span> CacheValue&lt;&gt;(value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// put into reverseMap</span></span><br><span class="line">    reverseMap.put(cacheValue, Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// try replacing us with CacheValue (this should always succeed)</span></span><br><span class="line">    <span class="keyword">if</span> (!valuesMap.replace(subKey, <span class="keyword">this</span>, cacheValue)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Should not reach here"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// successfully replaced us with new CacheValue -&gt; return the value</span></span><br><span class="line">    <span class="comment">// wrapped by it</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤æ®µä»£ç çš„å†…å®¹ï¼Œéƒ½æ˜¯åœ¨åå¤ç¡®è®¤å°†è¦æ„å»ºçš„ç”Ÿæˆç±»æ˜¯å¦åœ¨è¿‡å»æ›¾ç»åˆ›å»ºè¿‡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›è¿‡å»æ„å»ºçš„ç±»å®ä¾‹;<br>å¦åˆ™æ‰ä¼šå°è¯•åˆ›å»ºï¼Œå¹¶æœ€ç»ˆå°†è¿™ä¸ªæ„å»ºçš„ç±»ä¹Ÿè¿›è¡Œç¼“å­˜ã€‚</p><p>ä¸‹é¢è¿™æ®µä»£ç æ¥è‡ªäº <code>Proxy</code> çš„å†…éƒ¨ç±» <code>ProxyClassFactory</code><br>è¿™éƒ¨åˆ†ï¼Œä¹Ÿç»ˆäºå¼€å§‹äº†å¯¹ä»£ç†ç±»å­—èŠ‚ç çš„ç»Ÿç­¹æ€§æ„é€ çš„å†…å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="keyword">new</span> IdentityHashMap&lt;&gt;(interfaces.length);</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æ ¡éªŒå½“å‰æ¥å£æ˜¯ç”±åŒä¸€ä¸ª ClassLoader (å°†è¦ç”¨æ¥åŠ è½½æ–°çš„ä»£ç†ç±»)åŠ è½½çš„</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Class&lt;?&gt; interfaceClass = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            interfaceClass = Class.forName(intf.getName(), <span class="keyword">false</span>, loader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (interfaceClass != intf) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    intf + <span class="string">" is not visible from class loader"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æ ¡éªŒå½“å‰ Class å¯¹è±¡ç¡®å®æ˜¯ä¸€ä¸ªæ¥å£</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    interfaceClass.getName() + <span class="string">" is not an interface"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æ ¡éªŒå½“å‰æ¥å£æ²¡æœ‰è¢«è¦æ±‚é‡å¤è¿›è¡Œä»£ç†å¢å¼º</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (interfaceSet.put(interfaceClass, Boolean.TRUE) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"repeated interface: "</span> + interfaceClass.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String proxyPkg = <span class="keyword">null</span>;     <span class="comment">// ç”Ÿæˆçš„ä»£ç†ç±»æ‰€å±çš„ package</span></span><br><span class="line">    <span class="keyword">int</span> accessFlags = Modifier.PUBLIC | Modifier.FINAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * å¦‚æœä»£ç†çš„æ¥å£æ˜¯é PUBLIC ï¼Œé‚£ä¹ˆç”Ÿæˆçš„ä»£ç†ç±»çš„æ¥å£å°†ä¸è¿™ä¸ªé PUBLIC æ¥å£</span></span><br><span class="line"><span class="comment">     * åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ã€‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœä»£ç†çš„æ¥å£æœ‰å¤šä¸ªé PUBLIC ï¼Œä¸”åˆ†åˆ«ä½äºä¸åŒçš„åŒ…ä¸‹ï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">        <span class="keyword">int</span> flags = intf.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (!Modifier.isPublic(flags)) &#123;</span><br><span class="line">            accessFlags = Modifier.FINAL;</span><br><span class="line">            String name = intf.getName();</span><br><span class="line">            <span class="keyword">int</span> n = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">            String pkg = ((n == -<span class="number">1</span>) ? <span class="string">""</span> : name.substring(<span class="number">0</span>, n + <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                proxyPkg = pkg;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pkg.equals(proxyPkg)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">"non-public interfaces from different packages"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä»£ç†çš„æ¥å£å…¨æ˜¯ PUBLIC çš„ï¼Œé‚£ä¹ˆä½¿ç”¨é»˜è®¤çš„åŒ… com.sun.proxy</span></span><br><span class="line">    <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// if no non-public proxy interfaces, use com.sun.proxy package</span></span><br><span class="line">        proxyPkg = ReflectUtil.PROXY_PACKAGE + <span class="string">"."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ä¸ºå°†è¦ç”Ÿæˆçš„ä»£ç†ç±»é€‰æ‹©ä¸€ä¸ªå…¨é™å®šå</span></span><br><span class="line"><span class="comment">     * è§„åˆ™æ˜¯ åŒ…å + "$Proxy" + &lt;å”¯ä¸€é€’å¢çš„id, ä»0å¼€å§‹ç¼–å·&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> num = nextUniqueNumber.getAndIncrement();</span><br><span class="line">    String proxyName = proxyPkg + proxyClassNamePrefix + num;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆä¸€ä¸ªç‰¹æ®Šçš„ä»£ç†ç±»çš„å­—èŠ‚ç </span></span><br><span class="line"><span class="comment">     * byte[] proxyClassFile å°±ç­‰åŒäº .class æ–‡ä»¶çš„å…¨éƒ¨äºŒè¿›åˆ¶å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment">     * ä¸ .class æ–‡ä»¶çš„åŒºåˆ«å°±åœ¨äºä¸€ä¸ªå†™åœ¨äº†å¤–å­˜ä¸Šï¼Œå¦ä¸€ä¸ªå®Œå…¨åœ¨å†…å­˜ä¸­åˆ›å»º</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(</span><br><span class="line">            proxyName, interfaces, accessFlags);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">          * è°ƒç”¨ ClassLoader çš„ defineClass0(...) æ–¹æ³•åŠ è½½å­—èŠ‚ç å†…å®¹ï¼Œæ„é€  Class å¯¹è±¡</span></span><br><span class="line"><span class="comment">          * æœ¬æ¥ defineClass0(...) æ–¹æ³•æ˜¯å®šä¹‰åœ¨ ClassLoader ä¸­ï¼Œä½†è¿™é‡Œé¢å¤–å£°æ˜äº†ä¸€ä¸ªæœ¬åœ°æ–¹æ³• defineClass0(...)</span></span><br><span class="line"><span class="comment">          * æƒ³æ¥å®ç°ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œæœ€ç»ˆçš„ç›®çš„ä¹Ÿæ˜¯åŠ è½½ Class </span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">        <span class="keyword">return</span> defineClass0(loader, proxyName,</span><br><span class="line">                proxyClassFile, <span class="number">0</span>, proxyClassFile.length);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * A ClassFormatError here means that (barring bugs in the</span></span><br><span class="line"><span class="comment">         * proxy class generation code) there was some other</span></span><br><span class="line"><span class="comment">         * invalid aspect of the arguments supplied to the proxy</span></span><br><span class="line"><span class="comment">         * class creation (such as virtual machine limitations</span></span><br><span class="line"><span class="comment">         * exceeded).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å®ŒæˆåŸºç¡€æ€§çš„æ ¡éªŒï¼Œå¹¶æ„é€ äº†ç”Ÿæˆç±»çš„ç±»åç­‰å†…å®¹åï¼Œ<br><code>ProxyGenerator.generateProxyClass</code> å°†å¼€å§‹æ„é€  <a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-4.html" target="_blank" rel="noopener">ClassFile</a> çš„å…·ä½“å†…å®¹ã€‚</p><p>å…³äºè¿™éƒ¨åˆ†ç”Ÿæˆå­—èŠ‚ç çš„å†…å®¹ï¼Œè¯·åœ¨äº†è§£äº† ClassFile çš„åŸºç¡€æ€§å†…å®¹ä¹‹åï¼Œåœ¨è‡ªè¡Œå­¦ä¹ ï¼Œå†…å®¹å…¨éƒ¨åœ¨ ProxyGenerator ç±»ä¸­ã€‚</p><p>è¿™éƒ¨åˆ†çš„è§„åˆ™æ˜¯(åœ¨æ„å»ºæ–°çš„ä»£ç†ç”Ÿæˆç±»æ—¶):</p><ul><li>é¢å¤–æ·»åŠ ä¸‰ä¸ª Object çš„æ–¹æ³• (<code>hashCode</code>, <code>equals</code>, <code>toString</code>)</li><li>é€ä¸€è¯»å–æ‰€æœ‰éœ€è¦å¢å¼ºçš„æ¥å£çš„æ–¹æ³•ï¼Œå¹¶å¯¹é‡å¤æ–¹æ³•è¿›è¡Œåˆ¤æ–­; å¦‚æœæ–¹æ³•åç›¸åŒï¼Œå…¥å‚æ•°é‡ä¸ç±»å‹ç›¸åŒï¼Œä½†è¿”å›å‚æ•°ä¸åŒï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</li><li>åœ¨éå†æ‰€æœ‰æ¥å£çš„æ–¹æ³•çš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿå°†ä¸ºæ–°çš„ç”Ÿæˆç±»æ„é€ æ–°çš„å­—æ®µ(å†…å®¹å°±æ˜¯é€šè¿‡åå°„è·å–è¯¥æ–¹æ³•)</li><li>æœ€åå°†æ–°çš„ç”Ÿæˆç±»å°†è¦åŒ…å«çš„æ‰€æœ‰å­—æ®µä¸æ–¹æ³•è¿›è¡Œæ„é€ ï¼ŒåŒæ—¶ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± å†…å®¹</li><li>è¾“å‡ºè¿™äº›å†…å®¹çš„äºŒè¿›åˆ¶è¡¨ç¤º byte[];</li></ul><h2 id="å¦‚ä½•å¯¹æ–¹æ³•å¢å¼º"><a href="#å¦‚ä½•å¯¹æ–¹æ³•å¢å¼º" class="headerlink" title="å¦‚ä½•å¯¹æ–¹æ³•å¢å¼º"></a>å¦‚ä½•å¯¹æ–¹æ³•å¢å¼º</h2><p>æƒ³å¿…ä¸Šäº†ä¸Šä¸€èŠ‚ï¼Œè™½ç„¶å¯¹ Java åŠ¨æ€ä»£ç†çš„è°ƒç”¨é“¾æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚</p><p>ä½†æ˜¯ï¼Œç©¶ç«Ÿ Proxy æ˜¯å¦‚ä½•å®Œæˆå¯¹å®ç°ç±»æ–¹æ³•çš„å¢å¼ºå‘¢ï¼Ÿ</p><p>ä¹Ÿè®¸æˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸€ä¸‹ç”Ÿæˆç±» .class æ–‡ä»¶çš„ä¸€äº›å†…å®¹æ¥å¯¹è¿™ä¸ªå‘½é¢˜å½¢æˆåŸºç¡€æ€§çš„å½±å“ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Code <span class="title">getCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (Code)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m4, (Object[])<span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var2;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆç±»çš„ <code>getCode()</code> æ–¹æ³•å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå®è´¨æ€§çš„å†…å®¹, åªæ˜¯ <code>super.h.invoke(...)</code> ã€‚</p><p><code>h</code> å®ä¾‹å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ<code>InvocationHandler</code> çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</p><p>äº‹å®ä¸Šï¼ŒJava Proxy ç”Ÿæˆç±»çš„æ¯ä¸ªæ–¹æ³•ç»“æ„å‡ ä¹éƒ½æ˜¯ç±»ä¼¼çš„ã€‚æ–¹æ³•ä½“çš„å†…å®¹å°±æ˜¯é€šè¿‡å®ä¾‹æŒæœ‰çš„ <code>h</code> å˜é‡åˆ†å‘å®é™…çš„æ“ä½œæŒ‡ä»¤</p><p>è‡³äº h çš„å…·ä½“å†…å®¹ã€‚:) æœ‰ç¼–ç¨‹è€…è‡ªå®šä¹‰ï¼Œå¹¶åœ¨ Proxy ç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶è¢« ClassLoader åŠ è½½åï¼Œåœ¨å‡†å¤‡å®ä¾‹åŒ–çš„æ—¶å€™ä½œä¸ºæ„é€ å‚æ•°è¿›è¡Œä¼ å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ICodeFactory factory = (ICodeFactory) clazz.getConstructor(<span class="keyword">new</span> Class[] &#123; InvocationHandler.class &#125;).newInstance(<span class="keyword">new</span> Object[] &#123; handler &#125;);</span><br></pre></td></tr></table></figure><p>è‡³äºå…·ä½“å°†åšå“ªäº›å¢å¼ºï¼Œè°ƒç”¨ä¾‹å¦‚ä¸Šä¾‹çš„ <code>ICodeFactory</code> çš„é‚£ä¸ªå®ç°ç±»çš„æ–¹æ³•ï¼Œå…¨éƒ¨æœ‰ä½¿ç”¨è€…è‡ªå®šä¹‰ã€‚</p><h2 id="ç”Ÿæˆç±»çš„åç¼–è¯‘ç»“æœ"><a href="#ç”Ÿæˆç±»çš„åç¼–è¯‘ç»“æœ" class="headerlink" title="ç”Ÿæˆç±»çš„åç¼–è¯‘ç»“æœ"></a>ç”Ÿæˆç±»çš„åç¼–è¯‘ç»“æœ</h2><p>ä»ç„¶ä»¥æœ¬æ–‡å¼€å§‹çš„ ICodeFactory çš„å¢å¼ºä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ç©¶ç«Ÿé€šè¿‡ Java Proxy åŠ¨æ€ä»£ç†ç”Ÿæˆçš„å­—èŠ‚ç çš„åç¼–è¯‘ç»“æœç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ<br>å¹¶ä»¥æ­¤æ¥å¯¹è¿™ç§åŠ¨æ€ä»£ç†æœºåˆ¶å½¢æˆæ›´ä¸ºç›´è§‚çš„å°è±¡</p><p>åœ¨ Java æºä»£ç ä¸­ï¼Œè™½ç„¶é»˜è®¤ä¸ä¼šè¾“å‡ºç”Ÿæˆç±»çš„äºŒè¿›åˆ¶å†…å®¹ï¼Œä½†æ˜¯ï¼Œä»ç„¶é¢„ç•™äº†æ‰“å° .class æ–‡ä»¶çš„å¯é€‰é¡¹ã€‚</p><p>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹ <code>ProxyGenerator.saveGeneratedFiles</code> å­—æ®µçš„å†…å®¹ï¼Œè¿™å°±å†³å®šæ˜¯åœ¨æ„é€ ä»£ç†ç±»åæ˜¯å¦å­˜å‚¨åˆ°å¤–å­˜ä¸­ã€‚</p><p>æƒ³è¦çœ‹åˆ°ä»£ç†ç±»çš„å­—èŠ‚ç ï¼Œç›´æ¥é€šè¿‡åœ¨ Java æ‰§è¡Œç¨‹åºä¸­æ·»åŠ ä¸€è¡Œä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</span><br></pre></td></tr></table></figure><p>æˆ–è€…åœ¨å¯åŠ¨ç¨‹åºçš„ <code>java</code> å‘½ä»¤ä¸‹æ·»åŠ å‚æ•°</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dsun.misc.ProxyGenerator.saveGeneratedFiles=<span class="literal">true</span>`</span><br></pre></td></tr></table></figure><p>è‡³äºç”Ÿæˆç±»å°†æ‰“å°åœ¨å“ªï¼Œé¦–å…ˆå¿…ç„¶æ˜¯åœ¨é¡¹ç›®æ‰€å±çš„ç›®å½•ä¸‹ã€‚æœ‰ä¸Šä¸€èŠ‚ä¸­æ„é€ ç”Ÿæˆç±»å…¨é™å®šåçš„å†…å®¹ï¼Œæ ¹æ®åŒ…åçš„è§„åˆ™å»å¯»æ‰¾å³å¯ã€‚(å…·ä½“ä¸å†è¯¦è¿°)</p><p>ç›´æ¥é€šè¿‡ IDEA, Eclipse æˆ–è€…å…¶å®ƒå·¥å…·ï¼Œå¯¹ç”Ÿæˆç±» .class æ–‡ä»¶è¿›è¡Œåç¼–è¯‘å¯ä»¥æŸ¥çœ‹åˆ°æ•´ä¸ªç”Ÿæˆç±»çš„å†…å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"><span class="keyword">import</span> me.fangfeng.jdk.proxy.Code;</span><br><span class="line"><span class="keyword">import</span> me.fangfeng.jdk.proxy.ICodeFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">ICodeFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m4;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Code <span class="title">getCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Code)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m4, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(Code var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, Class.forName(<span class="string">"java.lang.Object"</span>));</span><br><span class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>);</span><br><span class="line">            m4 = Class.forName(<span class="string">"me.fangfeng.jdk.proxy.ICodeFactory"</span>).getMethod(<span class="string">"getCode"</span>);</span><br><span class="line">            m3 = Class.forName(<span class="string">"me.fangfeng.jdk.proxy.ICodeFactory"</span>).getMethod(<span class="string">"setCode"</span>, Class.forName(<span class="string">"me.fangfeng.jdk.proxy.Code"</span>));</span><br><span class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Java æ•´ä¸ªç”Ÿæ€é‡Œé¢, é€šç”¨çš„æœ‰ä¸¤ç±»åŠ¨æ€ä»£ç†çš„åº”ç”¨: Java Proxy ä¸ CGlib ä»£ç†ã€‚&lt;/p&gt;
&lt;p&gt;ä»å®½æ³›çš„åŒºåˆ«æ¥è¯´ï¼ŒJava Proxy åªèƒ½å¯¹æ¥å£è¿›è¡Œå¢å¼ºï¼Œè€Œ CGlib åŒæ—¶é€‚ç”¨äºç±»å’Œæ¥å£çš„å¢å¼ºã€‚&lt;br&gt;è€Œä¸”ï¼Œä¸šå†…æ™®éçš„è®¤çŸ¥æ˜¯ï¼ŒCGlib åŠ¨æ€ä»£ç†è¾ƒä¹‹äº Java Proxy åœ¨ç”Ÿæˆå­—èŠ‚ç çš„é€Ÿåº¦ä¸Šä¹Ÿæ›´ä¸ºé«˜æ•ˆã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="https://DorMOUSE-None.github.io/tags/Java/"/>
    
      <category term="Proxy" scheme="https://DorMOUSE-None.github.io/tags/Proxy/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•æ–¹ä¾¿åœ°è·å– CGlib ç”Ÿæˆç±»</title>
    <link href="https://DorMOUSE-None.github.io/2018-07-13-How-to-easily-get-CGlib-generated-code/"/>
    <id>https://DorMOUSE-None.github.io/2018-07-13-How-to-easily-get-CGlib-generated-code/</id>
    <published>2018-07-12T16:00:00.000Z</published>
    <updated>2018-07-13T12:55:17.325Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é…ç½®å‚æ•°"><a href="#é…ç½®å‚æ•°" class="headerlink" title="é…ç½®å‚æ•°"></a>é…ç½®å‚æ•°</h2><p><strong>å‘½ä»¤è¡Œä½¿ç”¨</strong></p><p>åœ¨ java å¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ å‚æ•°é…ç½®é¡¹ <code>-Dcglib.debugLocation=&lt;Custom Path&gt;</code></p><p><strong>ç¼–ç å®ç°</strong></p><p>åœ¨æ‰§è¡Œ CGlib è·å–æ–°ç”Ÿæˆç±»ä¹‹å‰ï¼Œè°ƒç”¨ <code>System.setProperty(&quot;cglib.debugLocation&quot;, &lt;Custom Path&gt;)</code></p><a id="more"></a><h2 id="å¦‚ä½•æ¸¸åˆƒæœ‰ä½™åœ°-Debug-æºæ‚-CGlib-ç”Ÿæˆç±»çš„è°ƒç”¨é“¾"><a href="#å¦‚ä½•æ¸¸åˆƒæœ‰ä½™åœ°-Debug-æºæ‚-CGlib-ç”Ÿæˆç±»çš„è°ƒç”¨é“¾" class="headerlink" title="å¦‚ä½•æ¸¸åˆƒæœ‰ä½™åœ° Debug æºæ‚ CGlib ç”Ÿæˆç±»çš„è°ƒç”¨é“¾"></a>å¦‚ä½•æ¸¸åˆƒæœ‰ä½™åœ° Debug æºæ‚ CGlib ç”Ÿæˆç±»çš„è°ƒç”¨é“¾</h2><p>ç»å¸¸ä¼šé‡åˆ°ï¼Œé¡¹ç›®ä¸­ä¸ç»æ„é—´å°±é‡åˆ°äº† CGlib ä»£ç†ï¼Œç„¶åå¯¹è°ƒç”¨é“¾çš„ Debug å°±å¼€å§‹å‡ºç°æ–­å±‚ã€‚ç»§è€Œï¼Œå¯¹å¯¹è±¡æˆ–å®ä¾‹å˜é‡çš„è·Ÿè¸ªå°±æ˜¾å¾—ä¸€å¤´é›¾æ°´ã€‚</p><p>ç‰¹åˆ«æ˜¯åœ¨ä¸äº†è§£ç”Ÿæˆç±»åˆ°åº•æ˜¯å¢å¼ºäº†é‚£äº›å†…å®¹çš„æ—¶å€™ï¼Œç”šè‡³å¯èƒ½è¿è°ƒç”¨é“¾éƒ½è·Ÿè¸ªä¸ä¸‹å»äº† T_T ã€‚</p><p>é€šè¿‡ <strong>é…ç½®å‚æ•°</strong> ä¸€èŠ‚çš„å†…å®¹ï¼Œä½ å°±å¯ä»¥åœ¨ä½ ç†æƒ³çš„ç›®å½• <code>&lt;Custom Path&gt;</code> ä¸‹çœ‹åˆ°<strong>æ‰€è°“é»‘ç›’</strong>ä¸­ç”Ÿæˆç±»çš„å®Œæˆå†…å®¹äº†ã€‚</p><p>ä¸‹é¢çš„å†…å®¹ï¼Œå°†ç®€å•åœ°ä»‹ç»å¦‚ä½•é…åˆ CGlib ç”Ÿæˆç±»çš„å†…å®¹å®ç°: ä¿è¯ Debug çš„æ¯ä¸€æ­¥éª¤å¯è§; ä¿è¯ Debug çš„è¿‡ç¨‹ä¸ä¼šå‡ºç°<em>é»‘ç›’</em>ã€‚</p><h3 id="ç¡®å®š-lt-Custom-Path-gt-ä¸‹å“ªä¸ªæ–‡ä»¶æ˜¯åŸæœ‰-Java-ç±»çš„ç”Ÿæˆç±»"><a href="#ç¡®å®š-lt-Custom-Path-gt-ä¸‹å“ªä¸ªæ–‡ä»¶æ˜¯åŸæœ‰-Java-ç±»çš„ç”Ÿæˆç±»" class="headerlink" title="ç¡®å®š &lt;Custom Path&gt; ä¸‹å“ªä¸ªæ–‡ä»¶æ˜¯åŸæœ‰ Java ç±»çš„ç”Ÿæˆç±»"></a>ç¡®å®š <code>&lt;Custom Path&gt;</code> ä¸‹å“ªä¸ªæ–‡ä»¶æ˜¯åŸæœ‰ Java ç±»çš„ç”Ÿæˆç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getClassName</span><span class="params">(String prefix, String source, Object key, Predicate names)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (prefix == <span class="keyword">null</span>) &#123;</span><br><span class="line">        prefix = <span class="string">"net.sf.cglib.empty.Object"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prefix.startsWith(<span class="string">"java"</span>)) &#123;</span><br><span class="line">        prefix = <span class="string">"$"</span> + prefix;</span><br><span class="line">    &#125;</span><br><span class="line">    String base =</span><br><span class="line">        prefix + <span class="string">"$$"</span> +</span><br><span class="line">        source.substring(source.lastIndexOf(<span class="string">'.'</span>) + <span class="number">1</span>) +</span><br><span class="line">        getTag() + <span class="string">"$$"</span> +</span><br><span class="line">        Integer.toHexString(STRESS_HASH_CODE ? <span class="number">0</span> : key.hashCode());</span><br><span class="line">    String attempt = base;</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span> (names.evaluate(attempt))</span><br><span class="line">        attempt = base + <span class="string">"_"</span> + index++;</span><br><span class="line">    <span class="keyword">return</span> attempt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CGlib é»˜è®¤çš„ç±»åç”Ÿæˆç­–ç•¥ä¸‹ï¼Œç”Ÿæˆç±»çš„å…¨é™å®šåå°†ç»“åˆåŸæ–‡ä»¶çš„å…¨é™å®šåå†³å®šã€‚</p><p>é€šå¸¸å‘½åå¦‚ä¸‹: <code>&lt;åŸ Java ç±»å…¨é™å®šå&gt;$$&lt;ç±»ä¼¼ EnhancerByCGlib&gt;$$&lt;ç”Ÿæˆç±»æ ¸å¿ƒå†…å®¹çš„ hash å€¼&gt;_&lt;index[å¯èƒ½å­˜åœ¨]&gt;</code></p><p>ä¾‹å¦‚: åŸæœ‰ Java ç±»å…¨é™å®šåä¸º me.fangfeng.Test ï¼Œåˆ™ç”Ÿæˆç±»åå¯èƒ½ä¸º <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code></p><p>å½“ç„¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šå­˜åœ¨ä¸€ä¸ªç±»åå½¢å¦‚ <code>me.fangfeng.Test$$FastClassBySpring$$...</code> çš„ç±»ï¼Œè¿™æ˜¯ä½œä¸ºç”Ÿæˆç±» <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code> çš„è¾…åŠ©ç±»æ¥ä½¿ç”¨ã€‚</p><h3 id="ç®€å•äº†è§£ç”Ÿæˆç±»ä¸‹çš„è°ƒç”¨å…³ç³»"><a href="#ç®€å•äº†è§£ç”Ÿæˆç±»ä¸‹çš„è°ƒç”¨å…³ç³»" class="headerlink" title="ç®€å•äº†è§£ç”Ÿæˆç±»ä¸‹çš„è°ƒç”¨å…³ç³»"></a>ç®€å•äº†è§£ç”Ÿæˆç±»ä¸‹çš„è°ƒç”¨å…³ç³»</h3><p>Java ä»£ç è§¦å‘è¢«å¢å¼ºçš„ç±»ï¼Œå°†é¦–å…ˆè°ƒç”¨ç”Ÿæˆç±»ã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯æ²¡åŠæ³•è¿›è¡Œ Debug çš„ï¼Œå› ä¸ºè¿™ä¸ªç”Ÿæˆç±»çš„å­—èŠ‚ç ç¼ºå°‘ SourceFile å±æ€§ï¼ŒåŒæ—¶ç¼ºå°‘ LineNumberTable å±æ€§ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™å¹¶ä¸å½±å“å¯¹è°ƒç”¨é“¾çš„è·Ÿè¸ªã€‚</p><p>CGlib çš„å¢å¼ºï¼Œæ‰€æœ‰çš„å¢å¼ºé€»è¾‘éƒ½æ˜¯ä»¥ Callback å®ç°ç±»çš„å½¢å¼æ¥æä¾›çš„ã€‚åŒæ—¶åœ¨ CGlib ç”Ÿæˆç±»ä¸­ä¹Ÿæœ‰ Callback çš„å®ä¾‹å˜é‡æ¥æŒæœ‰è¿™äº›æ³¨å…¥çš„ Callback ã€‚</p><p><strong>åŸæœ‰ Java ç±»</strong></p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8e7kr7qvj30sc0j0wh4.jpg" alt="LogonService.java"></p><p><strong>å¯¹åº”çš„ç”Ÿæˆç±»</strong></p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8e9ww4hqj31hg0oojzv.jpg" alt=""></p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eanb6c9j31j00lgn1e.jpg" alt=""></p><p><strong>è·Ÿè¸ª LogonService.addLogon(String var1) æ¼”ç¤º</strong></p><p>å½“å‰ LogonService çš„ç”Ÿæˆç±»å…¨é™å®šåä¸ºme.fangfeng.transactionBugs.LogonService$$EnhancerBySpringCGLIB$$bfc1dc3.class; ä»¥ä¸‹ç®€ç§°ä¸º LogonSerivce$$bfc1dc3 </p><ol><li><p>é¦–å…ˆï¼Œé…ç½® <code>cglib.debugLocation</code> å‚æ•°ï¼Œå€¼ = é¡¹ç›®ç”Ÿæˆçš„ .class è·¯å¾„</p></li><li><p>æ— æ–­ç‚¹ç›´æ¥è¿è¡Œä¸€æ¬¡éœ€è¦å¤„ç†çš„é€»è¾‘</p></li><li><p>æ‰¾åˆ° LogonSerive$$bfc1dc3.class, éšæ„æ‰“ä¸Šä¸€ä¸ªçœ‹ä¼¼æœ‰æ•ˆçš„æ–­ç‚¹</p></li><li><p>åœ¨å„å¤„æ‰“ä¸Šå¿…è¦çš„æ–­ç‚¹ï¼Œå¼€å§‹è¿›è¡ŒçœŸæ­£çš„è°ƒè¯•å·¥ä½œ</p></li><li><p>ä»£ç æ‰§è¡Œåˆ° LogonService$$bfc1dc3.class, è™½ç„¶æ²¡æœ‰çœŸæ­£è¿›å…¥æ–­ç‚¹ä½ç½®, ä½†æ˜¯å¯ä»¥çœ‹åˆ°è¿™ä¸ª LogonService$$bfc1dc3 å®ä¾‹çš„å®ä¾‹å˜é‡ä¿¡æ¯</p></li></ol><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8eq1be61j319w0bwtde.jpg" alt=""></p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8egtg1naj31ji0fmgp2.jpg" alt=""></p><p>æ¯”ç…§ç”Ÿæˆç±»ä»£ç ä¸­ addLogon(String var1) æ–¹æ³•ä½“çš„å†…å®¹ä»¥åŠå±•ç¤ºçš„å®ä¾‹å˜é‡ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°ç”Ÿæˆç±»è°ƒç”¨çš„ Callback å®ä¾‹æ˜¯ <code>CGLIB$CALLBACK_0</code><br>ç±»å‹æ˜¯ CglibAopProxy çš„é™æ€å†…éƒ¨ç§æœ‰ç±» DynamicAdvisedInterceptor ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eu91oscj31gq0ayju5.jpg" alt=""></p><p>åœ¨ intercept(â€¦) ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼Œè·³è¿‡ç”Ÿæˆç±» addLogon(String var1) æ–¹æ³•çš„ä¸‹ä¸€ä¸ªè°ƒç”¨æ–¹æ³•å°±æ˜¯ intercept(â€¦) </p><p><strong>è€Œä¸”äº‹å®ä¸Šï¼ŒCGlib ç”Ÿæˆç±»çš„å†…å®¹åŸºæœ¬ä¹Ÿå°±æ˜¯å¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œçš„ä¸€ç§è½¬å‘</strong></p><ol start="6"><li>ç»§ç»­ Debug ï¼Œå¯¹äºç”Ÿæˆç±»çš„å†…å®¹ï¼Œäººè‚‰äº†è§£å¹¶å®šä½åˆ°è§¦å‘çš„ Callback å®ä¾‹æˆ–è€… super.Xxx() æ–¹æ³•ã€‚</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é…ç½®å‚æ•°&quot;&gt;&lt;a href=&quot;#é…ç½®å‚æ•°&quot; class=&quot;headerlink&quot; title=&quot;é…ç½®å‚æ•°&quot;&gt;&lt;/a&gt;é…ç½®å‚æ•°&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;å‘½ä»¤è¡Œä½¿ç”¨&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ java å¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ å‚æ•°é…ç½®é¡¹ &lt;code&gt;-Dcglib.debugLocation=&amp;lt;Custom Path&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç¼–ç å®ç°&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ‰§è¡Œ CGlib è·å–æ–°ç”Ÿæˆç±»ä¹‹å‰ï¼Œè°ƒç”¨ &lt;code&gt;System.setProperty(&amp;quot;cglib.debugLocation&amp;quot;, &amp;lt;Custom Path&amp;gt;)&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="CGlib" scheme="https://DorMOUSE-None.github.io/tags/CGlib/"/>
    
      <category term="tools" scheme="https://DorMOUSE-None.github.io/tags/tools/"/>
    
  </entry>
  
</feed>
